<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="description" content="Learn best practice to build an API using Ruby on Rails 6">
<meta name="keywords" content="Rails, API, Ruby, Software">
<meta name="author" content="Alexandre Rousseau">
<meta name="copyright" content="CC-BY-SA 4.0, MIT">
<title>API on Rails 6</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>API on Rails 6</h1>
<div class="details">
<span id="author" class="author">Alexandre Rousseau</span><br>
<span id="email" class="email"><a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a></span><br>
<span id="revnumber">version 6.9,</span>
<span id="revdate">2020-12-20</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#chapter00-before">Before</a>
<ul class="sectlevel1">
<li><a href="#_foreword">Foreword</a></li>
<li><a href="#_about_the_author">About the author</a></li>
<li><a href="#_copyright_and_license">Copyright and license</a></li>
<li><a href="#_thanks">Thanks</a></li>
</ul>
</li>
<li><a href="#chapter01-introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#_conventions_on_this_book">Conventions on this book</a></li>
<li><a href="#_development_environments">Development environments</a>
<ul class="sectlevel2">
<li><a href="#_text_editors_and_terminal">Text editors and Terminal</a></li>
<li><a href="#_browsers">Browsers</a></li>
<li><a href="#_package_manager">Package manager</a></li>
<li><a href="#_git">Git</a></li>
<li><a href="#_ruby">Ruby</a></li>
</ul>
</li>
<li><a href="#_initializing_the_project">Initializing the project</a></li>
<li><a href="#_versioning">Versioning</a></li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter02-api">The API</a>
<ul class="sectlevel1">
<li><a href="#_planning_the_application">Planning the application</a></li>
<li><a href="#_setting_the_api">Setting the API</a>
<ul class="sectlevel2">
<li><a href="#_routes_constraints_and_namespaces">Routes, Constraints and Namespaces</a></li>
</ul>
</li>
<li><a href="#_api_versioning">Api versioning</a></li>
<li><a href="#_conclusion_2">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter03-presenting-users">Presenting users</a>
<ul class="sectlevel1">
<li><a href="#_user_model">User model</a>
<ul class="sectlevel2">
<li><a href="#_generation_of_the_user_model">Generation of the <code>User</code> model</a></li>
<li><a href="#_password_hash">Password hash</a></li>
</ul>
</li>
<li><a href="#_build_users">Build users</a>
<ul class="sectlevel2">
<li><a href="#_test_our_resource_with_curl">Test our resource with cURL</a></li>
<li><a href="#_create_users">Create users</a></li>
<li><a href="#_update_users">Update users</a></li>
<li><a href="#_delete_the_user">Delete the user</a></li>
</ul>
</li>
<li><a href="#_conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter04-authentication">Authenticating user</a>
<ul class="sectlevel1">
<li><a href="#_stateless_session">Stateless session</a>
<ul class="sectlevel2">
<li><a href="#_jwt_presentation">JWT presentation</a></li>
<li><a href="#_setting_up_the_authentication_token">Setting up the authentication token</a></li>
<li><a href="#_tokens_controller">Token&#8217;s controller</a></li>
</ul>
</li>
<li><a href="#_logged_user">Logged user</a></li>
<li><a href="#_authentication_with_the_token">Authentication with the token</a>
<ul class="sectlevel2">
<li><a href="#_authorize_actions">Authorize actions</a></li>
</ul>
</li>
<li><a href="#_conclusion_4">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter05-user-products">User&#8217;s products</a>
<ul class="sectlevel1">
<li><a href="#_the_product_model">The product model</a>
<ul class="sectlevel2">
<li><a href="#_the_foundations_of_the_product">The foundations of the product</a></li>
<li><a href="#_product_validations">Product validations</a></li>
</ul>
</li>
<li><a href="#_products_endpoints">Products endpoints</a>
<ul class="sectlevel2">
<li><a href="#_show_action_for_products">Show action for products</a></li>
<li><a href="#_products_list">Products list</a></li>
<li><a href="#_creating_products">Creating products</a></li>
<li><a href="#_updating_products">Updating products</a></li>
<li><a href="#_destroying_products">Destroying products</a></li>
</ul>
</li>
<li><a href="#_feed_the_database">Feed the database</a></li>
<li><a href="#_conclusion_5">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter06-improve-json">Building JSON</a>
<ul class="sectlevel1">
<li><a href="#_presentation_of_jsonapi">Presentation of JSON:API</a></li>
<li><a href="#_serialize_user">Serialize user</a></li>
<li><a href="#_serialize_products">Serialize products</a>
<ul class="sectlevel2">
<li><a href="#_serialize_associations">Serialize associations</a></li>
</ul>
</li>
<li><a href="#_theory_of_the_injection_of_relationships">Theory of the injection of relationships</a>
<ul class="sectlevel2">
<li><a href="#_integrate_into_a_meta_attribute">Integrate into a meta attribute</a></li>
<li><a href="#_incorporate_the_object_into_the_attribute">Incorporate the object into the attribute</a></li>
<li><a href="#_incorporate_the_relationships_into_include">Incorporate the relationships into `include</a></li>
</ul>
</li>
<li><a href="#_application_of_the_injection_of_relationships">Application of the injection of relationships</a>
<ul class="sectlevel2">
<li><a href="#_retrieve_users_products">Retrieve user&#8217;s products</a></li>
</ul>
</li>
<li><a href="#_search_for_products">Search for products</a>
<ul class="sectlevel2">
<li><a href="#_the_keyword_by">The keyword by</a></li>
<li><a href="#_by_price">By price</a></li>
<li><a href="#_sort_by_creation_date">Sort by creation date</a></li>
</ul>
</li>
<li><a href="#_conclusion_6">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter07-placing-orders">Placing Orders</a>
<ul class="sectlevel1">
<li><a href="#_modeling_order">Modeling order</a>
<ul class="sectlevel2">
<li><a href="#_orders_and_products">Orders and Products</a></li>
</ul>
</li>
<li><a href="#_expose_the_user_model">Expose the user model</a>
<ul class="sectlevel2">
<li><a href="#_render_a_single_order">Render a single order</a></li>
<li><a href="#_placing_an_order">Placing an order</a></li>
</ul>
</li>
<li><a href="#_send_order_confirmation_email">Send order confirmation email</a></li>
<li><a href="#_conclusion_7">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter08-improve_orders">Improving orders</a>
<ul class="sectlevel1">
<li><a href="#_decrementing_product_quantity">Decrementing product quantity</a>
<ul class="sectlevel2">
<li><a href="#_extending_the_placement_model">Extending the Placement model</a></li>
</ul>
</li>
<li><a href="#_validate_quantity_of_products">Validate quantity of products</a></li>
<li><a href="#_updating_the_total">Updating the total</a></li>
<li><a href="#_conclusion_8">Conclusion</a></li>
<li><a href="#_pagination">Pagination</a>
<ul class="sectlevel2">
<li><a href="#_products">Products</a></li>
<li><a href="#_orders_list">Orders list</a></li>
<li><a href="#_refactoring_pagination">Refactoring pagination</a></li>
</ul>
</li>
<li><a href="#_api_caching">API Caching</a></li>
<li><a href="#_n1_queries">N+1 Queries</a>
<ul class="sectlevel2">
<li><a href="#_prevention_of_n_1_requests">Prevention of N + 1 requests</a></li>
</ul>
</li>
<li><a href="#_activation_of_cors">Activation of CORS</a></li>
<li><a href="#_conclusion_9">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="chapter00-before" class="sect0">Before</h1>
<div class="sect1">
<h2 id="_foreword">Foreword</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"API on Rails 6" is based on <a href="http://apionrails.icalialabs.com/book/">"APIs on Rails: Building REST APIs with Rails"</a>. It was initially published in 2014 by <a href="https://twitter.com/kurenn">Abraham Kuri</a> under the licenses <a href="http://opensource.org/licenses/MIT">MIT</a> and <a href="http://people.freebsd.org/~phk/">Beerware</a>.</p>
</div>
<div class="paragraph">
<p>The first version was not maintained and was initially planned for Ruby on Rails version 4, which does not <a href="https://guides.rubyonrails.org/maintenance_policy.html#security-issues">receive more than security updates</a>. I wanted to update this excellent book, adapting it to new versions of Ruby on Rails. Therefore, this book is available for Ruby on Rails versions 5.2 and 6.0 (the one you are currently reading).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This book is also available in the Molière language (It means french).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_the_author">About the author</h2>
<div class="sectionbody">
<div class="paragraph">
<p>My name is <a href="http://rousseau-alexandre.fr">Alexandre Rousseau</a>, and I am a Rails developer with more than 4 years of experience (at the time of writing). I am currently a partner in a company (<a href="https://isignif.fr">iSignif</a>) to build and maintain a SAAS product using Rails. I also contribute to the Ruby community by producing and maintaining some gems that you can consult on <a href="https://rubygems.org/profiles/madeindjs">my Rubygems.org profile</a>. Most of my projects are on GitHub, then don&#8217;t hesitate to <a href="http://github.com/madeindjs/">follow me</a>.</p>
</div>
<div class="paragraph">
<p>This book&#8217;s source code is available in <a href="https://asciidoctor.org/">Asciidoctor</a> format on <a href="https://github.com/madeindjs/api_on_rails">GitHub</a>. Feel free to <a href="https://github.com/madeindjs/api_on_rails/fork">fork</a> the project if you want to improve it or fix mistakes I didn&#8217;t notice.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_copyright_and_license">Copyright and license</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This book is provided on <a href="http://opensource.org/licenses/MIT">MIT license</a>. All the book&#8217;s source code is available on <a href="https://fr.wikipedia.org/wiki/Markdown">Markdown</a> format on <a href="https://github.com/madeindjs/api_on_rails">GitHub</a></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">MIT license</div>
<div class="paragraph">
<p>Copyright 2019 Alexandre Rousseau</p>
</div>
<div class="paragraph">
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
</div>
<div class="paragraph">
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
</div>
<div class="paragraph">
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>"API on Rails 6" by <a href="https://github.com/madeindjs/api_on_rails">Alexandre Rousseau</a> is shared according to <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution - Attribution-ShareAlike 4.0 International</a>. Built upon this book <a href="http://apionrails.icalialabs.com/book/" class="bare">http://apionrails.icalialabs.com/book/</a>.</p>
</div>
<div class="paragraph">
<p>This book&#8217;s cover picture uses a beautiful photo shot by <a href="https://unsplash.com/@siloine?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Yoann Siloine</a> who published it on <a href="https://unsplash.com">Unsplash</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thanks">Thanks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A big "thank you" to all Github contributors who keep this book alive. In alphabetical order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/airdry">airdry</a></p>
</li>
<li>
<p><a href="https://github.com/Landris18">Landris18</a></p>
</li>
<li>
<p><a href="https://github.com/lex111">lex111</a></p>
</li>
<li>
<p><a href="https://github.com/cuilei5205189">cuilei5205189</a></p>
</li>
<li>
<p><a href="https://github.com/franklinjosmell">franklinjosmell</a></p>
</li>
<li>
<p><a href="https://github.com/notapatch">notapatch</a></p>
</li>
<li>
<p><a href="https://github.com/promisepreston">promisepreston</a></p>
</li>
<li>
<p><a href="https://github.com/tacataca">tacataca</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter01-introduction" class="sect0">Introduction</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Welcome to API on Rails 6, a tutorial on steroids to learn the best way to build your next API with Rails. The purpose of this book is to provide a comprehensive methodology to develop a RESTful API following best practices.</p>
</div>
<div class="paragraph">
<p>As soon as you finish this book, you will be able to create your own API and integrate it with any client, such as a web browser or mobile application. The generated code is built with Ruby on Rails 6.0, which is the current version.</p>
</div>
<div class="paragraph">
<p>The purpose of this book is not only to teach you how to build an API with Rails but rather to teach you how to build an <strong>evolutive</strong> and <strong>maintainable</strong> API with Rails. That is, improve your current knowledge with Rails. On this journey, you will learn to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use Git for version control</p>
</li>
<li>
<p>Building JSON responses</p>
</li>
<li>
<p>Test your end-points with unit and functional tests</p>
</li>
<li>
<p>Set up authentication with JSON Web Tokens (JWT)</p>
</li>
<li>
<p>Use JSON:API specification</p>
</li>
<li>
<p>Optimize and cache the API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I strongly recommend you follow all the steps in this book. Try not to skip chapters because I will give you some tips and tricks to improve your skills throughout the book. You can consider yourself the main character of a video game that gains a level in each chapter.</p>
</div>
<div class="paragraph">
<p>In the first chapter, I will explain how to configure your environment (if you don&#8217;t already have it). Then we will create an application called <code>market_place_api</code>. I will ensure that I teach you the best practices I have learned during my experience. This means that we&#8217;ll start using <strong>Git</strong> just after initializing the project.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll build the application following a simple working method that I use daily in the next chapters. We will develop the entire application using Test Driven Development (TDD). I will also explain the interest of using an API for your next project and choosing a suitable response format such as JSON or XML. Further on, we will get our hands on the code and complete the application&#8217;s basics by building all the necessary roads. We will also secure access to the API by building authentication by exchanging HTTP headers. Finally, in the last chapter, we will add some optimization techniques to improve the server&#8217;s structure and response times.</p>
</div>
<div class="paragraph">
<p>The final application will scratch the surface of being a market place where users will be able to place orders, upload products, and more. There are plenty of options out there to set up an online store, such as <a href="http://shopify.com">Shopify</a>, <a href="http://spreecommerce.com/">Spree</a>, or <a href="http://magento.com">Magento</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conventions_on_this_book">Conventions on this book</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The conventions in this book are based on the ones from <a href="http://www.railstutorial.org/book/beginning#sec-conventions">Ruby on Rails Tutorial</a>. In this section, I&#8217;ll mention some that may not be so clear.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll be using many examples using command-line instructions. I won&#8217;t deal with windows <code>cmd</code> (sorry guys), so all the examples use Unix-style command line prompt, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"A command-line command"</span>
A command-line <span class="nb">command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll be using some guidelines related to the language. What I mean by this is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Avoid</strong> means you are not supposed to do it</p>
</li>
<li>
<p><strong>Prefer</strong> indicates that from the 2 options, the first it&#8217;s a better fit</p>
</li>
<li>
<p><strong>Use</strong> means you are good to use the resource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If for any reason you encounter some errors when running a command, rather than trying to explain every possible outcome, I recommend you to `google it', which I don&#8217;t consider a bad practice or whatsoever. But if you feel like you want to grab a beer or have some trouble with the tutorial, you can always <a href="mailto:contact@rousseau-alexandre.fr">email me</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development_environments">Development environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the most painful parts for almost every developer is setting everything up, but as long as you get it done, the next steps should be a piece of cake and well rewarded. So I will guide you to keep you motivated.</p>
</div>
<div class="sect2">
<h3 id="_text_editors_and_terminal">Text editors and Terminal</h3>
<div class="paragraph">
<p>There are many cases in which development environments may differ from computer to computer. That is not the case with text editors or IDE&#8217;s. I think for Rails development an IDE is way too much, but some other might find that the best way to go, so if that it&#8217;s your case I recommend you go with <a href="http://www.aptana.com/products/radrails">RadRails</a> or <a href="http://www.jetbrains.com/ruby/index.html">RubyMine</a>, both are well supported and come with many integrations out of the box.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Text editor</strong>: I personally use <a href="http://www.vim.org/">vim</a> as my default editor with <a href="https://github.com/carlhuda/janus">janus</a>, which will add and handle many of the plugins you are probably going to use. In case you are not a <em>vim</em> fan like me, there are a lot of other solutions such as <a href="http://www.sublimetext.com/">Sublime Text</a> which is a cross-platform easy to learn and customize (this is probably your best option), it is highly inspired by <a href="http://macromates.com/">TextMate</a> (only available for Mac OS). A third option uses a more recent text editor from the guys at <a href="http://gitub.com">GitHub</a> called <a href="https://atom.io/">Atom</a>. It&#8217;s a promising text editor made with JavaScript. It is easy to extend and customize to meet your needs. Give it a try. Any of the editors I present will do the job, so I&#8217;ll let you decide which one fits your eye.</p>
</li>
<li>
<p><strong>Terminal</strong>: If you decided to go with <a href="http://icalialabs.github.io/kaishi/">kaishi</a> for setting the environment, you would notice that it sets the default shell to <code>zsh</code>, which I highly recommend. For the terminal, I&#8217;m not a fan of the <em>Terminal</em> app that comes out of the box if you are on Mac OS, so check out <a href="http://www.iterm2.com/#/section/home">iTerm2</a>, which is a terminal replacement for Mac OS. If you are on Linux, you probably have a nice terminal already, but the default should work fine.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_browsers">Browsers</h3>
<div class="paragraph">
<p>When it comes to browsers, I would say <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> immediately, but some other developers may say <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or even <a href="https://www.apple.com/safari/">Safari</a>. Any of those will help you build the application you want. They come with a nice inspector not just for the DOM but also for network analysis and many other features you might know already.</p>
</div>
</div>
<div class="sect2">
<h3 id="_package_manager">Package manager</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Mac OS</strong>: There are many options to manage how you install packages on your Mac, such as <a href="https://www.macports.org/">Mac Ports</a> or <a href="http://brew.sh/">Homebrew</a>, both are good options, but I would choose the last one, I&#8217;ve encountered fewer troubles when I install software, and I manage it. To install <code>brew</code>, just run the command below:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Linux</strong>: You are all set! It really does not matter if you are using <code>apt</code>, <code>pacman</code>, <code>yum</code> as long you feel comfortable with it, and you know how to install packages so you can keep moving forward.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_git">Git</h3>
<div class="paragraph">
<p>We will be using Git a lot, and you should use it too, not just for the purpose of this tutorial but for every single project.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on Mac OS: <code>$ brew install git</code></p>
</li>
<li>
<p>on Linux: <code>$ sudo apt-get install git</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ruby">Ruby</h3>
<div class="paragraph">
<p>There are many ways in which you can install and manage ruby, and by now, you should probably have some version installed if you are on Mac OS. To see which version you have, just type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ruby <span class="nt">-v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails 6.0 requires the installation of version 2.5 or higher.</p>
</div>
<div class="paragraph">
<p>I recommend using <a href="http://rvm.io/">Ruby Version Manager (RVM)</a> or <a href="http://rbenv.org/">rbenv</a> to install it. We will use RVM in this tutorial, but it doesn&#8217;t matter which of these two options you use.</p>
</div>
<div class="paragraph">
<p>The principle of these tools is allowing you to install several versions of Ruby on the same machine, in an environment that is airtight to a possible version installed on your operating system, and to be able to switch from one to the other easily.</p>
</div>
<div class="paragraph">
<p>To install RVM, go to <a href="https://rvm.io/" class="bare">https://rvm.io/</a> and install the GPG footnote key:[The GPG key allows you to verify the identity of the author of the sources you download.]. Once that&#8217;s done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gpg <span class="nt">--keyserver</span> hkp://keys.gnupg.net <span class="nt">--recv-keys</span> 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
<span class="nv">$ </span><span class="se">\c</span>url <span class="nt">-sSL</span> https://get.rvm.io | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, it is time to install ruby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rvm <span class="nb">install </span>2.6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to install the rest of the dependencies we will be using.</p>
</div>
<div class="sect3">
<h4 id="_gems_rails_missing_libraries">Gems, Rails &amp; Missing libraries</h4>
<div class="paragraph">
<p>First, we update the gems on the whole system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gem update <span class="nt">--system</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In some cases, if you are on a Mac OS, you will need to install some extra libraries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>brew <span class="nb">install </span>libtool libxslt libksba openssl</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then install the necessary gems and ignore documentation for each gem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gem <span class="nb">install </span>bundler
<span class="nv">$ </span>gem <span class="nb">install </span>rails <span class="nt">-v</span> 6.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check for everything to be running nice and smooth:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nt">-v</span>
Rails 6.0.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_database">Database</h4>
<div class="paragraph">
<p>I highly recommend you install <a href="http://www.postgresql.org/">Postgresql</a> to manage your databases. But here, we&#8217;ll be using <a href="http://www.sqlite.org/">SQlite</a> for simplicity. If you are using Mac OS, you should be ready to go. In case you are on Linux, don&#8217;t worry. We have you covered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>libxslt-dev libxml2-dev libsqlite3-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>libxslt-devel libxml2-devel libsqlite3-devel</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initializing_the_project">Initializing the project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Initializing a Rails application may be pretty straightforward for you. If that is not the case, here is a super quick tutorial.</p>
</div>
<div class="paragraph">
<p>There is the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir</span> ~/workspace
<span class="nv">$ </span><span class="nb">cd</span> ~/workspace
<span class="nv">$ </span>rails new market_place_api <span class="nt">--api</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>--api</code> option appeared in version 5 of Rails. It allows you to limit the libraries and <em>Middleware</em> included in the application. This also avoids generating HTML views when using Rails generators.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you may guess, the commands above will generate the bare bones of your Rails application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_versioning">Versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Remember that Git helps you track and maintain your code history. Keep in mind that the source code of the application is published on GitHub. You can follow the project on <a href="https://github.com/madeindjs/market_place_api_6">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>Ruby on Rails initialized the Git directory for you when you used the <code>rails new</code> command. This means that you do not need to execute the <code>git init</code> command.</p>
</div>
<div class="paragraph">
<p>However, it is necessary to configure the information of the author of <em>commits</em>. If you have not already done so, go to the directory and run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git config <span class="nt">--global</span> user.name <span class="s2">"Type in your name"</span>
<span class="nv">$ </span>git config <span class="nt">--global</span> user.email <span class="s2">"Type in your email"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails also provide a <code>.gitignore</code> file to ignore some files that we don&#8217;t want to track. The default <code>.gitignore</code> file should look like the one shown below:</p>
</div>
<div class="listingblock">
<div class="title">.gitignore</div>
<div class="content">
<pre># Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

# Ignore uploaded files in development.
/storage/*
!/storage/.keep
.byebug_history

# Ignore master key for decrypting credentials and more.
/config/master.key</pre>
</div>
</div>
<div class="paragraph">
<p>After modifying the <code>.gitignore</code> file, we just need to add the files and commit the changes, the necessary commands are shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Initial commit"</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
I have found that committing a message starting with a present tense verb, describing what the commit does and not what it did, helps when you are exploring the history of the project. I find it is more natural to read and understand. I&#8217;ll follow this practice until the end of the tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lastly and as an optional step, we setup the GitHub (I&#8217;m not going through that here) project and push our code to the remote server: We first add the remote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git remote add origin git@github.com:madeindjs/market_place_api_6.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we push the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git push <span class="nt">-u</span> origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we move forward with the tutorial, I&#8217;ll be using the practices I follow daily. This includes working with <code>branches</code>, <code>rebasing</code>, <code>squash</code> and some more. For now, you don&#8217;t have to worry if some of these don&#8217;t sound familiar to you. I walk you through them in time.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s been a long way through this chapter. If you reach here, let me congratulate you and be sure that things will get better from this point. So let&#8217;s get our hands dirty and start typing some code!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter02-api" class="sect0">The API</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In this section, I&#8217;ll outline the application. By now, you should have read the previous chapter. If you did not read it, I recommend you to do it.</p>
</div>
<div class="paragraph">
<p>You can clone the project until this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter02</code></pre>
</div>
</div>
<div class="paragraph">
<p>To summarize, we simply generated our Rails application and made our first commit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_planning_the_application">Planning the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we want to go simple with the application, it consists of five models. Don&#8217;t worry if you don&#8217;t fully understand what is going on. We will review and build each of these resources as we move on with the tutorial.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="img/data_model.png" alt="Schema of links betweens models"></span></p>
</div>
<div class="paragraph">
<p>In brief, the <code>user</code> will be able to place many <code>orders</code>, upload multiple <code>products</code> which can have many <code>images</code> or <code>comments</code> from other users on the app.</p>
</div>
<div class="paragraph">
<p>We will not build views for displaying or interacting with the API, so not to make this a huge tutorial, I&#8217;ll let that to you. There are plenty of options out there like javascript frameworks (<a href="https://angularjs.org/">Angular</a>, <a href="https://vuejs.org/">Vue.js</a>, <a href="https://reactjs.org/">React.js</a>).</p>
</div>
<div class="paragraph">
<p>By this point, you must be asking yourself:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>all right, but I need to explore or visualize the API we will be building?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>That&#8217;s fair. Probably if you google something related to API exploring, an application called <a href="https://www.getpostman.com/">Postman</a> will pop. It is great software, but we won&#8217;t be using that anyway because we&#8217;ll use <strong>cURL</strong>, allowing anybody to reproduce requests on any computer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_the_api">Setting the API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An API is defined by <a href="http://en.wikipedia.org/wiki/Application_programming_interface">wikipedia</a> as <em>an application programming interface (API) specifies how some software components should interact with each other.</em> In other words, the way systems interact with each other through a common interface, in our case, a web service built with JSON. There are other kinds of communication protocols like SOAP, but we are not covering that here.</p>
</div>
<div class="paragraph">
<p>As the Internet media type standard, JSON is widely accepted, readable, extensible, and easy to implement. Many of the current frameworks consume JSON APIs by default (<a href="https://angularjs.org/">Angular</a> or <a href="https://vuejs.org/">Vue.js</a>, for example). There are also great libraries for Objective-C too like <a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> or <a href="http://restkit.org/">RESTKit</a>. There are probably good solutions for Android, but I might not be the right person to recommend something because of my lack of experience in that development platform.</p>
</div>
<div class="paragraph">
<p>All right. So we are building our API with JSON. There are many ways to achieve this. The first thing that comes to mind would be just to start adding routes defining the endpoints. This may be bad because they may not have a <a href="http://www.w3.org/2005/Incubator/wcl/matching.html">URI pattern</a> clear enough to know which resource is being exposed. The protocol or structure I&#8217;m talking about is <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> which stands for Representational State Transfer and by Wikipedia definition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="soap">aService.getUser("1")</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in REST you may call a URL with a specific HTTP request, in this case with a GET request: <a href="http://domain.com/resources_name/uri_pattern" class="bare">http://domain.com/resources_name/uri_pattern</a></p>
</div>
<div class="paragraph">
<p>RESTful APIs must follow at least three simple guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A base <a href="http://en.wikipedia.org/wiki/Uniform_resource_identifier">URI</a>, such as <code><a href="http://example.com/resources/" class="bare">http://example.com/resources/</a></code>.</p>
</li>
<li>
<p>An Internet media type to represent the data is commonly JSON and is commonly set through header exchange.</p>
</li>
<li>
<p>Follows the standard <a href="http://en.wikipedia.org/wiki/HTTP_method#Request_methods">HTTP Methods</a> such as GET, POST, PUT, DELETE.</p>
<div class="ulist">
<ul>
<li>
<p><strong>GET</strong>: Reads the resource or resources defined by the URI pattern</p>
</li>
<li>
<p><strong>POST</strong>: Creates a new entry into the resources collection</p>
</li>
<li>
<p><strong>PUT</strong>: Updates a collection or member of the resources</p>
</li>
<li>
<p><strong>DELETE</strong>: Destroys a collection or member of the resources</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This might not be clear enough or may look like a lot of information to digest, but hopefully, it&#8217;ll get a lot easier to understand as we move on with the tutorial.</p>
</div>
<div class="sect2">
<h3 id="_routes_constraints_and_namespaces">Routes, Constraints and Namespaces</h3>
<div class="paragraph">
<p>Before start typing any code, we prepare the code with git. We&#8217;ll be using a branch per chapter, upload it to GitHub and then merge it on <code>master</code> branch. So let&#8217;s get started. Open the terminal, <code>cd</code> to the <code>market_place_api</code> directory and type in the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter02
Switched to a new branch <span class="s1">'chapter02'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will only be working on the <code>config/routes.rb</code>, as we are just going to set the constraints and the default response <code>format</code> for each request.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First of all, erase all commented code that comes within the file. We are not gonna need it. Then commit it, just as a warm-up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add config/routes.rb
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Removes comments from the routes file"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are going to isolate the API controllers under a namespace. With Rails, this is fairly simple: you just have to create a folder under the <code>app/controllers</code> named <code>API</code>. The name is important because that&#8217;s the namespace we&#8217;ll use for managing the controllers for the API endpoints.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we add that namespace into our <em>routes.rb</em> file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># API definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span> <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By defining a namespace under the <code>routes.rb</code> file. Rails will automatically map that namespace to a directory matching the name under the <em>controllers</em> folder, in our case the <code>api/`</code> directory.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Rails media types supported</div>
<div class="paragraph">
<p>Rails can handle up to 35 different media types, you can list them by accessing the SET class under de Mime module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails c
2.6.3 :001 <span class="o">&gt;</span> Mime::SET.collect<span class="o">(</span>&amp;:to_s<span class="o">)</span>
 <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"text/html"</span>, <span class="s2">"text/plain"</span>, <span class="s2">"text/javascript"</span>, <span class="s2">"text/css"</span>, <span class="s2">"text/calendar"</span>, <span class="s2">"text/csv"</span>, <span class="s2">"text/vcard"</span>, <span class="s2">"text/vtt"</span>, <span class="s2">"image/png"</span>, <span class="s2">"image/jpeg"</span>, <span class="s2">"image/gif"</span>, <span class="s2">"image/bmp"</span>, <span class="s2">"image/tiff"</span>, <span class="s2">"image/svg+xml"</span>, <span class="s2">"video/mpeg"</span>, <span class="s2">"audio/mpeg"</span>, <span class="s2">"audio/ogg"</span>, <span class="s2">"audio/aac"</span>, <span class="s2">"video/webm"</span>, <span class="s2">"video/mp4"</span>, <span class="s2">"font/otf"</span>, <span class="s2">"font/ttf"</span>, <span class="s2">"font/woff"</span>, <span class="s2">"font/woff2"</span>, <span class="s2">"application/xml"</span>, <span class="s2">"application/rss+xml"</span>, <span class="s2">"application/atom+xml"</span>, <span class="s2">"application/x-yaml"</span>, <span class="s2">"multipart/form-data"</span>, <span class="s2">"application/x-www-form-urlencoded"</span>, <span class="s2">"application/json"</span>, <span class="s2">"application/pdf"</span>, <span class="s2">"application/zip"</span>, <span class="s2">"application/gzip"</span><span class="o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is important because we are going to be working with JSON, one of the built-in <a href="http://en.wikipedia.org/wiki/Internet_media_type">MIME types</a> accepted by Rails, so we just need to specify this format as the default one:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># API definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Up to this point, we have not made anything crazy. What we want to generate is a <em>base_uri</em> which includes the API version. But let&#8217;s commit changes before going to the next section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add config/routes.rb
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Set the routes constraints for the API"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_versioning">Api versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point, we should have a nice route mapping using a namespace. Your <code>routes.rb</code> file should look like this:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># API definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to set up some other constraints for versioning purposes. You should care about versioning your application from the beginning since this will give a better structure to your API. When changes need to be made, you can give developers who are consuming your API the opportunity to adapt to the new features while the old ones are being deprecated. There is an excellent <a href="http://railscasts.com/episodes/350-rest-api-versioning">railscast</a> explaining this.</p>
</div>
<div class="paragraph">
<p>To set the version for the API, we first need to add another directory under the <code>API</code> we created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way we can namespace our api into different versions very easily, now we just need to add the necessary code to the <code>routes.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># We are going to list our resources here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By this point, the API is now scoped via the URL. For example, with the current configuration, an endpoint for retrieving a product would be like <a href="http://localhost:3000/v1/products/1" class="bare">http://localhost:3000/v1/products/1</a>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Common API patterns</div>
<div class="paragraph">
<p>You can find many approaches to set up the <em>base_uri</em> when building an API following different patterns, assuming we are versioning our API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api.example.com/</code>: In my opinion, this is the way to go, gives you a better interface and isolation, and in the long term can help you to <a href="http://www.makeuseof.com/tag/optimize-your-dns-for-faster-internet/">quickly scalate</a></p>
</li>
<li>
<p><code>example.com/api/</code>: This pattern is very common, and it is actually a good way to go when you don&#8217;t want to namespace your API under a subdomain</p>
</li>
<li>
<p><code>example.com/api/v1</code>: it seems like a good idea by setting the version of the API through the URL seems like a more descriptive pattern, but this way you enforce the version to be included on URL on each request, so if you ever decide to change this pattern, this becomes a problem of maintenance in the long-term</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some practices in API building that recommend not to version the API via the URL. That&#8217;s true. The developer should not be aware of the version he&#8217;s using. For simplicity, I have chosen to set aside this convention, which we will be able to apply in a second phase.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>It is time to <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Set the versioning namespaces for API"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are at the end of our chapter. Therefore, it is time to apply all our modifications to the master branch by making a <em>merge</em>. To do this, we place ourselves on the <code>master</code> branch and we <em>merge</em> <code>chapter02</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter02</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_2">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I know it&#8217;s been a long way, but you made it, don&#8217;t give up this is just our small scaffolding for something big, so keep it up. In the meantime, and if you feel curious, some gems handle this kind of configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Sutto/rocket_pants">RocketPants</a></p>
</li>
<li>
<p><a href="https://github.com/bploetz/versionist">Versionist</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I&#8217;m not covering those in this book since we are trying to learn how to implement this kind of functionality, but it is good to know. By the way, the code up to this point is <a href="https://github.com/madeindjs/market_place_api_6/releases/tag/checkpoint_chapter03">here</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter03-presenting-users" class="sect0">Presenting users</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the last chapter, we manage to set up the bare bones for our application endpoints configuration.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will handle user authentication through authentication tokens and setting permissions to limit access for, let&#8217;s say, signed-in users. In the coming chapters, we will relate <code>products</code> to users and give them the ability to place orders.</p>
</div>
<div class="paragraph">
<p>You can clone the project until this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter03</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can already imagine, there are a lot of authentication solutions for Rails, <a href="https://github.com/binarylogic/authlogic">AuthLogic</a>, <a href="https://github.com/thoughtbot/clearance">Clearance</a>, and <a href="https://github.com/plataformatec/devise">Devise</a>.</p>
</div>
<div class="paragraph">
<p>These solutions are turnkey libraries, i.e., they allow you to manage many things like authentication, password forgetfulness, validation, etc&#8230;&#8203; Nevertheless, we will use <a href="https://github.com/codahale/bcrypt-ruby">bcrypt</a> gem to hash the user&#8217;s password.</p>
</div>
<div class="paragraph">
<p>This chapter will be complete. It may be a long one, but I will try to cover as many topics as possible. Feel free to have a coffee, and let&#8217;s go. At the end of this chapter, you will have built all the user logic and validation and error management.</p>
</div>
<div class="paragraph">
<p>It is a good time to create a new branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter03</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Just make sure you are on the <code>master</code> branch before checking out.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_model">User model</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_generation_of_the_user_model">Generation of the <code>User</code> model</h3>
<div class="paragraph">
<p>We will start by generating our <code>User</code> model. This model will be really simple and will contain only two fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>email</code> which will be unique and will allow it to connect to the application</p>
</li>
<li>
<p><code>password_digest</code> which will contain the <strong>hashed</strong> version of the password (we will discuss this later in this chapter)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We generate our <code>User</code> model using the <em>generate model</em> command provided by Ruby on Rails. It is very easy to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model User email:string password_digest:string
invoke  active_record
      create    db/migrate/20190603195146_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      <span class="nb">test</span>/models/user_test.rb
      create      <span class="nb">test</span>/fixtures/users.yml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <em>model</em> is the element containing the data and the logic related to the data: validation, reading, and recording.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This command generates a lot of files! Don&#8217;t worry, we&#8217;ll review them one by one.</p>
</div>
<div class="paragraph">
<p>The migration file contained in the <code>db/migrate</code> folder contains the <strong>migration</strong> that describes the changes that will be made to the database. This file should look like this:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:password_digest</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The inserted date at the beginning of the migration file name should be different for you since it corresponds to the migration creation date.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will make a small change to the migration to add some database validations. With Rails, it is common practice to make these verifications directly in the Ruby model. It is good practice to do so also in the database schema.</p>
</div>
<div class="paragraph">
<p>We will, therefore add two additional constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>email is mandatory: we use the property <code>null: false</code>.</p>
</li>
<li>
<p>email must be unique: we add an index for the email column with property <code>unique: true</code>.</p>
</li>
<li>
<p>password is mandatory: we use the property <code>null: false</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The migration thus becomes:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can run changes once the migration is complete with the following command:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span>
<span class="o">==</span> <span class="mi">20190603195146</span> <span class="no">CreateUsers</span><span class="p">:</span> <span class="n">migrating</span> <span class="o">======================================</span>
<span class="o">--</span> <span class="n">create_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span>
   <span class="o">-&gt;</span> <span class="mf">0.0027</span><span class="n">s</span>
<span class="o">==</span> <span class="mi">20190603195146</span> <span class="no">CreateUsers</span><span class="p">:</span> <span class="n">migrated</span> <span class="p">(</span><span class="mf">0.0028</span><span class="n">s</span><span class="p">)</span> <span class="o">=============================</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This command will convert our migration into a SQL query that will update the SQlite3 database in the <em>db</em> folder.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_model">Model</h4>
<div class="paragraph">
<p>So we defined our database schema. The next step is to update our model to define <strong>validation rules</strong>. These rules are defined in the template located in the <code>app/models</code> folder.</p>
</div>
<div class="paragraph">
<p>Ruby on Rails provides a complete validation mechanism found at <a href="https://guides.rubyonrails.org/active_record_validations.html">their official documentation</a>. In our case, we want to validate only three things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the email must have a valid format</p>
</li>
<li>
<p>the email must be unique</p>
</li>
<li>
<p>the password must be filled in</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These three rules are defined by the following code:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">with: </span><span class="sr">/@/</span>
  <span class="n">validates</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. Rails use a straightforward syntax, and the code is very readable.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Email validation</div>
<div class="paragraph">
<p>You may notice that the email validation uses a simplistic validation by only checking for the presence of a <code>@</code>.</p>
</div>
<div class="paragraph">
<p>That&#8217;s normal.</p>
</div>
<div class="paragraph">
<p>There are infinite exceptions to the email address so well <a href="https://davidcel.is/posts/stop-validating-email-addresses-with-regex/">that even <code>Look at all these spaces!@example.com</code> is a valid address</a>. Therefore, it is better to favor a simple approach and confirm the email by a validation email.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_unit_tests">Unit tests</h4>
<div class="paragraph">
<p>We end with the unit tests. We use here the Minitest test framework, which is provided by default with Rails.</p>
</div>
<div class="paragraph">
<p>Minitest is based on <em>Fixtures</em>, which allows you to fill your database with <strong>predefined</strong> data. <em>Fixtures</em> are defined in YAML files in the <code>tests/fixtures</code> folder. There is one file per template.</p>
</div>
<div class="paragraph">
<p>We must, therefore start by updating our <code>tests/fixtures</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>fixtures</em> are not designed to create all the data your tests need. They just allow you to define the basic data your application needs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So we will start by creating a <em>fixture</em> defining a user:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/users.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">one@one.org</span>
  <span class="na">password_digest</span><span class="pi">:</span> <span class="s">hashed_password</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can now create three tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1. Check that a user with valid data is valid:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with a valid email should be valid'</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'test@test.org'</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>2. Check that a user with an invalid email address is not valid:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with invalid email should be invalid'</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'test'</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>3. Check that a new user with a duplicate email is not valid. So we use the same email as the <em>fixture</em> we just created.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with taken email should be invalid'</span> <span class="k">do</span>
  <span class="n">other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="n">other_user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. We can verify that our implementation is correct just by simply running unit tests we have just created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
...
3 runs, 3 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>I think it&#8217;s time to do a little <em>commit</em> to validate our progress:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Create user model"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_password_hash">Password hash</h3>
<div class="paragraph">
<p>We have previously implemented the storage of user data. We still have a problem to solve: <strong>the storage of passwords is in clear text</strong>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>If you store user passwords clearly, then an attacker who steals a copy of your database has a giant list of emails and passwords. Some of your users will only have one password&#8201;&#8212;&#8201;for their email account, for their banking account, for your application. A simple hack could escalate into massive identity theft. - <a href="https://github.com/codahale/bcrypt-ruby#why-you-should-use-bcrypt">source - Why you should use bcrypt</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>So we will use the bcrypt gem to <strong>hash</strong> the password.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Hash is the process of transforming a character string into <em>Hash</em>. This <em>Hash</em> does not allow you to find the original character string. However, we can easily use it to determine if a given character string matches the <em>hash</em> we have stored.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We must first add the Bcrypt gem to the <em>Gemfile</em>. We can use the <code>bundle add</code> command. This one will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>add the gem to the Gemfile by retrieving the current version</p>
</li>
<li>
<p>launch the command <code>bundle install</code> which will install the gem and update the file <em>Gemfile.lock</em> which "locks" the current version of the gem</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Therefore, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add bcrypt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the command is executed, the following line is added at the end of the <em>Gemfile</em>:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">gem</span> <span class="s2">"bcrypt"</span><span class="p">,</span> <span class="s2">"~&gt; 3.1"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Version 3.1 of bcrypt is the current version at the time of writing. It may therefore vary for your case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Active Record offers us a method <a href="https://github.com/rails/rails/blob/6-0-stable/activemodel/lib/active_model/secure_password.rb#L61"><code>ActiveModel::SecurePassword::has_secure_password</code></a> that will interface with Bcrypt and hack the password for us very easily.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_secure_password</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>has_secure_password</code> adds the following validations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The password must be present when creating.</p>
</li>
<li>
<p>The password length must be less than or equal to 72 bytes.</p>
</li>
<li>
<p>The confirmation of the password using the attribute <code>password_confirmation</code> (if sent)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This method will also add a <code>User#password</code> attribute that will be automatically hashed and saved in the <code>User#password_digest</code> attribute.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try this right now in the Rails console. Open a console with <code>rails console</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'toto@toto.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span>
 <span class="o">=&gt;</span><span class="c1">#&lt;User id: 1, email: "toto@toto.org", password_digest: [FILTERED], created_at: "2019-06-04 10:51:44", updated_at: "2019-06-04 10:51:44"&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that when you call the <code>User#create!</code> method, the <code>password</code> attribute is hashed and stored in <code>password_digest</code>. We can also send a <code>password_confirmation</code> attribute that ActiveRecord will compare to <code>password</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'tata@tata.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span><span class="p">,</span> <span class="ss">password_confirmation: </span><span class="s1">'azerty'</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span> <span class="p">(</span><span class="no">Validation</span> <span class="ss">failed: </span><span class="no">Password</span> <span class="n">confirmation</span> <span class="n">doesn</span> <span class="n">t</span> <span class="n">match</span> <span class="no">Password</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything is working as planned! Let&#8217;s now make a <em>committe</em> to keep the history concise:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Setup Bcrypt"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_users">Build users</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s time to make our first entry point. We will begin by building the <code>show</code> action, which will respond with a single user in the JSON data format. The steps are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>generate the <code>users_controller</code>.</p>
</li>
<li>
<p>add the corresponding tests</p>
</li>
<li>
<p>build the real code.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s first focus on generating the controller and functional tests.</p>
</div>
<div class="paragraph">
<p>To respect the viewing of our API, we will cut our application using <strong>modules</strong>. The syntax is, therefore, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::users</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will create <code>users_controller_test.rb</code> file. Before going further, there are two things we want to test for an API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The JSON structure returned by the server</p>
</li>
<li>
<p>The HTTP response code returned by the server</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Common HTTP codes</div>
<div class="paragraph">
<p>The first digit of the status code specifies one of the five response classes. The bare minimum for an HTTP client is that it uses one of these five classes. Here is a list of commonly used HTTP codes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>200</code>: Standard response for successful HTTP requests. This is usually on <code>GET</code> requests</p>
</li>
<li>
<p><code>201</code>: The demand was met and resulted in the creation of a new resource. After the <code>POST</code> requests</p>
</li>
<li>
<p><code>204</code>: The server has successfully processed the request but does not return any content. This is usually a successful DELETE request.</p>
</li>
<li>
<p><code>400</code>: The request cannot be executed due to bad syntax. It can happen for any type of request.</p>
</li>
<li>
<p>401: Similar to 403, but specifically for use when authentication is required and has failed or has not yet been provided. It can happen for any type of request.</p>
</li>
<li>
<p><code>404</code>: The requested resource could not be found but may be available again in the future. Usually concerns <code>GET</code> requests</p>
</li>
<li>
<p>500: A generic error message, given when an unexpected condition has been encountered, and no other specific message is appropriate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a complete list of HTTP response codes, see <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">Wikipedia article</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We will therefore implement the functional test that verifies access to the <code>Users#show</code> method,</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
    <span class="c1"># Test to ensure response contains the correct email</span>
    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then simply add the action to our controller. It is extremely simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span>  <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># GET /users/1</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the tests with <code>rails test</code> you get the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>

...E

Error:
UsersControllerTest#test_should_show_user:
DRb::DRbRemoteError: undefined method <span class="sb">`</span>api_v1_user_url<span class="sb">`</span> <span class="k">for</span> <span class="c">#&lt;UsersControllerTest:0x000055ce32f00bd0&gt; (NoMethodError)</span>
    <span class="nb">test</span>/controllers/users_controller_test.rb:9:in <span class="sb">`</span>block <span class="k">in</span> &lt;class:UsersControllerTest&gt;<span class="sb">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This type of error is very common when you generate your resources manually! Indeed, we have totally forgotten <strong>the route</strong>. So let&#8217;s add them:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests should now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rails test
....
4 runs, 5 assertions, 0 failures, 0 errors, 0 skips</pre>
</div>
</div>
<div class="paragraph">
<p>As usual, after adding one of the features we are satisfied with, we make a <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds show action to the users controller"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_test_our_resource_with_curl">Test our resource with cURL</h3>
<div class="paragraph">
<p>So we finally have a resource to test. We have several solutions to test it. The first one that comes to mind is cURL, which is integrated into almost all Linux distributions. So let&#8217;s try it:</p>
</div>
<div class="paragraph">
<p>First, initialize the rails server on a new terminal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then switch back to your other terminal and run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/api/v1/users/1
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"email"</span>:<span class="s2">"toto@toto.org"</span>, ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We find the user we created with the Rails console in the previous section. You now have a user registration API entry.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_users">Create users</h3>
<div class="paragraph">
<p>Now that we have a better understanding of building entry points, it is time to extend our API. One of the most important features is to let users create a profile on our application. As usual, we will write tests before implementing our code to extend our test suite.</p>
</div>
<div class="paragraph">
<p>Ensure that your Git directory is clean and that you do not have a file in <em>staging</em>. If so <em>commit</em> them so that we can start over.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start by writing our test by adding an entry to create a user on the file <code>users_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should create user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_users_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'test@test.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should not create user with taken email"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_users_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a lot of code. Don&#8217;t worry I&#8217;ll explain everything:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the first test, we check the user&#8217;s creation by sending a valid POST request. Then, we checked that an additional user exists in the database and that the HTTP code of the response is <code>created</code> (status code 201)</p>
</li>
<li>
<p>In the second test, we check that the user is not created using an email already used. Then, we check that the HTTP code of the response is <code>unprocessable_entity</code> (status code 422)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At that point, the tests must fail (as we expected):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
...E</code></pre>
</div>
</div>
<div class="paragraph">
<p>So it&#8217;s time to implement the code for our tests to be successful:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="c1"># POST /users</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># Only allow a trusted parameter "white list" through.</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that each time we add an entry in our API we must also add this action in our <code>routes.rb</code> file.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the implementation is quite simple. We have also added the private method <code>user_params</code> to protect mass attribute assignments. Now our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
......
6 runs, 9 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yeah! Let&#8217;s <em>commit</em> changes and continue to build our application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the user create endpoint"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_users">Update users</h3>
<div class="paragraph">
<p>The user update scheme is very similar to the one at creation. If you are an experienced Rails developer, you may already know the differences between these two actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The update action responds to a PUT/PATCH request.</p>
</li>
<li>
<p>Only a connected user should be able to update his information. This means that we will have to force a user to authenticate. We will discuss this in Chapter 5.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As usual, we start by writing our tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should not update user when invalid params are sent"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'bad_email'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the tests to succeed, we must build the update action on the file <code>users_controller.rb</code> and add the route to the file <code>routes.rb</code>. As you can see, we have too much-duplicated code. We will redesign our tests in chapter 4. first, we add the action the file <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we implement the update action on the user controller and run our tests:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update]</span>

  <span class="c1"># GET /users/1</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="c1"># PATCH/PUT /users/1</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">status: :ok</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">set_user</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All our tests should now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
........
8 runs, 11 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>We do a <em>commit</em> Since everything works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds update action the users controller"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_delete_the_user">Delete the user</h3>
<div class="paragraph">
<p>So far, we have built many actions on the user controller with their tests, but it is not finished. We just need one more, which is the action of destruction. So let&#8217;s create the test:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"should destroy user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the test is straightforward. We only respond with a status of <strong>204</strong>, which means <code>No Content</code>. We could also return a status code of <strong>200</strong>, but I find it more natural to answer <code>No Content</code> in this case because we delete a resource, and a successful response may be enough.</p>
</div>
<div class="paragraph">
<p>The implementation of the destruction action is also quite simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="c1"># ...</span>

  <span class="c1"># DELETE /users/1</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to add the action <code>destroy</code> in the file <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests should pass if everything is correct:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
.........
9 runs, 13 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that after making some changes to our code, it is good practice to <em>commit</em> them to keep a well-cut history.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds destroy action to the users controller"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we get to the end of our chapter, it is time to apply all our modifications to the master branch by doing a <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter03</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_3">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh, there you are! Well done! I know it was probably a long time, but don&#8217;t give up! Make sure you understand each piece of code, things will improve. In the next chapter, we will redesign our tests to make the code more readable and maintainable. Then stay with me!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter04-authentication" class="sect0">Authenticating user</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>It&#8217;s been a long time since you started. I hope you enjoy this trip as much as I do.</p>
</div>
<div class="paragraph">
<p>In the previous chapter, we set up user resource entries. If you have skipped this chapter or have not understood everything, I strongly recommend looking at it. It covers the first bases of the tests and is an introduction to JSON answers.</p>
</div>
<div class="paragraph">
<p>You can clone the project up to this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter04</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this chapter, things will get very interesting because we will set up our authentication mechanism. In my opinion, it&#8217;s one of the most interesting chapters. We will introduce many new terms, and you will end with a simple but powerful authentication system. Don&#8217;t feel panic. We will get to that.</p>
</div>
<div class="paragraph">
<p>First things first (and as usual when starting a new chapter), we will create a new branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter04</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stateless_session">Stateless session</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we go any further, something must be clear: <strong>an API does not handle sessions</strong>. If you don&#8217;t have experience building this kind of application, it might sound a little crazy but stay with me. An API should be stateless, which means by definition <em>is one that provides a response after your request and then requires no further attention.</em>. This means no previous or future state is required for the system to work.</p>
</div>
<div class="paragraph">
<p>The flow for authenticating the user through an API is effortless:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The client request for <code>sessions</code> resource with the corresponding credentials (usually email and password)</p>
</li>
<li>
<p>The server returns the <code>user</code> resource along with its corresponding authentication token.</p>
</li>
<li>
<p>For every page that requires authentication, the client has to send that <code>authentication token</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Of course, this is not the only 3-step to follow, and even on step 2, you might think, well, do I really need to respond with the entire user or just the <code>authentication token</code>? It really depends on you, but I like to return the entire user. This way, I can map it right away on my client and save another possible request from being placed.</p>
</div>
<div class="paragraph">
<p>This section and the next will focus on building a Sessions controller and its corresponding actions. We&#8217;ll then complete the request flow by adding the necessary authorization access.</p>
</div>
<div class="sect2">
<h3 id="_jwt_presentation">JWT presentation</h3>
<div class="paragraph">
<p>When it comes to authentication tokens, there is a standard: the JSON Web Token (JWT).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>JWT is an open standard defined in RFC 75191. It allows the secure exchange of tokens between several parties. - <a href="https://wikipedia.org/wiki/JSON_Web_Token_Web_Token">Wikipedia</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Overall a JWT token is composed of three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <strong>header</strong> structured in JSON contains, for example, the validity date of the token.</p>
</li>
<li>
<p>a <strong>payload</strong> structured in JSON can contain <strong>any data</strong>. In our case, it will contain the identifier of the "connected" user.
A <strong>signature</strong> allows us to verify that our application has encrypted the token and is therefore valid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These three parts are each encoded in base64 and then concatenated using points (<code>.</code>). This gives us something like that:</p>
</div>
<div class="listingblock">
<div class="title">A valid JWT token</div>
<div class="content">
<pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</pre>
</div>
</div>
<div class="paragraph">
<p>Once decoded, this token gives us the following information:</p>
</div>
<div class="listingblock">
<div class="title">The JWT token header</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w"> </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="p">,</span><span class="w"> </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The payload of the JWT token</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w"> </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234567890"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w"> </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For more information about JWT tokens I invite you to visit <a href="https://jwt.io">jwt.io</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This has many advantages, such as sending information in token&#8217;s payload. For example, we may choose to integrate user&#8217;s information into the <em>payload</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_the_authentication_token">Setting up the authentication token</h3>
<div class="paragraph">
<p>The JWT standard has many implementations in various languages and libraries. Of course, there is a Ruby gem on this subject: <a href="https://github.com/jwt/ruby-jwt">ruby-jwt</a>.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start by installing it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add jwt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once completed the following line is added to your <em>Gemfile</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">gem</span> <span class="s2">"jwt"</span><span class="p">,</span> <span class="s2">"~&gt; 2.2"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The library is very simple. There are two methods: <code>JWT.encode</code> and <code>JWT.decode</code>. Let&#8217;s open a terminal with <code>console rails</code> and run some tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="n">token</span> <span class="o">=</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">encode</span><span class="p">({</span><span class="ss">message: </span><span class="s1">'Hello World'</span><span class="p">},</span> <span class="s1">'my_secret_key'</span><span class="p">)</span>
<span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s1">'my_secret_key'</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="p">[{</span><span class="s2">"message"</span><span class="o">=&gt;</span><span class="s2">"Hello World"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"alg"</span><span class="o">=&gt;</span><span class="s2">"HS256"</span><span class="p">}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the first line, we encoded a <em>payload</em> with the secret key <code>my_secret_key</code>. So we get a token we can simply decode. The second line decodes the token, and we see that we find our <em>payload</em> well.</p>
</div>
<div class="paragraph">
<p>We will now include all this logic in a <code>JsonWebToken</code> class in a new file located in <code>lib/</code>. This will allow us to avoid duplicating the code.  This class will just encode and decode the JWT tokens. So here is the implementation.</p>
</div>
<div class="listingblock">
<div class="title">lib/json_web_token.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">JsonWebToken</span>
  <span class="no">SECRET_KEY</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">secret_key_base</span><span class="p">.</span><span class="nf">to_s</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">from_now</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">[</span><span class="ss">:exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">.</span><span class="nf">to_i</span>
    <span class="no">JWT</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="no">SECRET_KEY</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="no">SECRET_KEY</span><span class="p">).</span><span class="nf">first</span>
    <span class="no">HashWithIndifferentAccess</span><span class="p">.</span><span class="nf">new</span> <span class="n">decoded</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I know that&#8217;s a lot of code, but we&#8217;re going to review it together.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the method <code>JsonWebToken.encode</code> takes care of encoding the <em>payload</em> by adding an expiration date of 24 hours by default. We also use the same encryption key as the one configured with Rails</p>
</li>
<li>
<p>the method <code>JsonWebToken.decode</code> decodes the JWT token and gets the <em>payload</em>. Then we use the <a href="https://api.rubyonrails.org/classes/ActiveSupport/HashWithIndifferentAccess.html"><code>HashWithIndifferentAccess</code></a> class provided by Rails, which allows us to retrieve a value of a <code>Hash</code> with a <code>Symbol</code> or <code>String</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There you go. To load the file into our application, you must specify the <code>lib</code> folder in the list of Ruby on Rails _autoload_s. To do this, add the following configuration to the <code>application.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">config/application.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">module</span> <span class="nn">MarketPlaceApi</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ...</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'lib'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. Now it&#8217;s time to make a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Setup JWT gem"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tokens_controller">Token&#8217;s controller</h3>
<div class="paragraph">
<p>We have, therefore, set up the system for generating a JWT token. It&#8217;s now time to create a route that will generate this token. The actions we will implement will be managed as <em>RESTful</em> services: the connection will be managed by a POST request to the <code>create</code> action.</p>
</div>
<div class="paragraph">
<p>We will start by creating the controller of and method <code>create</code> in the <em>namespace</em> <code>/API/v1</code>. With Rails, one order is sufficient:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::tokens create</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will modify the route a little to respect the <em>REST</em> conventions:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will build functional tests before going any further. The desired behavior is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>I receive a token if I send a valid email/password pair</p>
</li>
<li>
<p>otherwise, the server responds with a <code>forbidden</code> response</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The tests therefore materialize as follows:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/tokens_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">Api::V1::TokensControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get JWT token'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">api_v1_tokens_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'g00d_pa$$'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get JWT token'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">api_v1_tokens_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'b@d_pa$$'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:unauthorized</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be wondering: "but how can you know the user&#8217;s password?". Simply use the <code>BCrypt::Password.create</code> method in the <em>fixtures</em> of users:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/users.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">one@one.org</span>
  <span class="na">password_digest</span><span class="pi">:</span> <span class="s">&lt;%= BCrypt::Password.create('g00d_pa$$') %&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this precise moment, if you run the tests, you get two errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

........E

Error:
Api::V1::TokensControllerTest#test_should_get_JWT_token:
JSON::ParserError: 767: unexpected token at <span class="s1">''</span>


Failure:
Expected response to be a &lt;401: unauthorized&gt;, but was a &lt;204: No Content&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s normal. It&#8217;s now time to implement the logic to create the JWT token. It is effortless.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/tokens_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::TokensController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="ss">:password</span><span class="p">])</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span>
        <span class="ss">token: </span><span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">),</span>
        <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
      <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="ss">:unauthorized</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># Only allow a trusted parameter "white list" through.</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a lot of code, but it&#8217;s straightforward:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We always filter parameters with the method <code>user_params</code>.</p>
</li>
<li>
<p>We retrieve the user with the method <code>User.find_by_email</code> (which is a "magic" method of <em>Active Record</em> since the field <code>email</code> is present in the database), and we retrieve the user.</p>
</li>
<li>
<p>We use the method <code>User#authenticate</code> (which exists thanks to the gem <code>bcrypt</code>) with the password as a parameter. Bcrypt will <em>hash</em> password and check if it matches the attribute <code>password_digest</code>. The function returns <code>true</code> if everything went well, <code>false</code> if not.</p>
</li>
<li>
<p>If the password corresponds to the <em>hash</em>, a JSON containing the <em>token</em> generated with the class <code>JsonWebToken</code> is returned. Otherwise, an empty response is returned with an <code>unauthorized</code> header.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Are you still here? Don&#8217;t worry, it&#8217;s over! Now your tests must pass.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

...........

Finished <span class="k">in </span>0.226196s, 48.6304 runs/s, 70.7351 assertions/s.
11 runs, 16 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Very good! It&#8217;s time to make a commit that will contain all our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Setup tokens controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_logged_user">Logged user</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We implemented the following logic: API returns the authentication token to the client if credentials are correct.</p>
</div>
<div class="paragraph">
<p>We will now implement the following logic: we&#8217;ll find the corresponding user of the authentication token given into the HTTP header. We&#8217;ll need to do so each time this client requests an entry point that requires permission.</p>
</div>
<div class="paragraph">
<p>We will use the HTTP header <code>Authorization</code>, which is often used for this purpose. We may also use a GET parameter named <code>apiKey</code> but I prefer to use an HTTP header because it gives context to the request without polluting the URL with additional parameters.</p>
</div>
<div class="paragraph">
<p>We will therefore create a <code>current_user</code> method to meet our needs. It will find the user thanks his authentication token, which is sent on each request.</p>
</div>
<div class="paragraph">
<p>When it comes to authentication, I like adding all the associated methods in a separate file. Then simply include the file in the <code>ApplicationController</code>. In this way, it&#8217;s straightforward to test in isolation. Let&#8217;s create the file in the <code>controllers/concerns</code> directory with a <code>current_user</code> method that we will implement right after:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="c1"># TODO</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, let&#8217;s create a <code>concerns</code> directory under <code>tests/controllers/</code> and an <code>authenticable_test.rb</code> file for our authentication tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir test</span>/controllers/concerns
<span class="nv">$ </span><span class="nb">touch test</span>/controllers/concerns/authenticable_test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>As usual, we start by writing our tests. In this case, our <code>current_user</code> method will search for a user by the authentication token in the HTTP header <code>Authorization</code>. The test is quite basic:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">AuthenticableTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@authentication</span> <span class="o">=</span> <span class="no">MockController</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get user from Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get user from empty Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be wondering, "Where does the <code>MockController</code> come from?". It is a <em>Mock</em>, i.e., a class that imitates another&#8217;s behavior to test a behavior.</p>
</div>
<div class="paragraph">
<p>We can define the <code>MockController</code> class just above our test:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">MockController</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
  <span class="nb">attr_accessor</span> <span class="ss">:request</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="n">mock_request</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:headers</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">request</span> <span class="o">=</span> <span class="n">mock_request</span><span class="p">.</span><span class="nf">new</span><span class="p">({})</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MockController</code> class simply includes our <code>Authenticable</code> module that we will test. It contains a <code>request</code> attribute that contains a simple <a href="https://ruby-doc.org/core-2.6.3/Struct.html"><code>Struct</code></a> that mimics the behavior of a Rails request by containing a <code>headers</code> attribute of the type <code>Hash</code>.</p>
</div>
<div class="paragraph">
<p>Then we can implement our two tests right after</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">AuthenticableTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@authentication</span> <span class="o">=</span> <span class="no">MockController</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get user from Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get user from empty Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our tests must fail. So let&#8217;s implement the code so that it can be passed:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">return</span> <span class="vi">@current_user</span> <span class="k">if</span> <span class="vi">@current_user</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span>
    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="nf">nil?</span>

    <span class="n">decoded</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="vi">@current_user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go! We get the token from the header <code>Authorization</code> and we look for the corresponding user. Nothing very witchcraft.</p>
</div>
<div class="paragraph">
<p>Now our tests must pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.............
13 runs, 18 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>All we have to do is include the <code>Authenticable</code> module in the <code>ApplicationController</code> class:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/application_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="c1"># ...</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now it is time to <em>commit</em> our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds authenticable module for managing authentication methods"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication_with_the_token">Authentication with the token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authorization plays an important role in constructing applications because it helps us define what the user is allowed to do.</p>
</div>
<div class="paragraph">
<p>We have a route to update the user, but there is a problem: anyone can update any user. This section will implement a method that will require the user to be logged in to prevent unauthorized access.</p>
</div>
<div class="sect2">
<h3 id="_authorize_actions">Authorize actions</h3>
<div class="paragraph">
<p>It is now time to update our <code>users_controller.rb</code> file to refuse access to certain actions. We will also implement the <code>current_user</code> method on the <code>update</code> and <code>destroy</code> action to ensure that the user who is logged in will only be able to update his data and only delete (and only) his account.</p>
</div>
<div class="paragraph">
<p>Therefore, we will split our test <em>should update user</em> and <em>should destroy user</em> into two tests.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by updating the <em>should update user</em> test.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
      <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">},</span>
      <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span>
      <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see how we have to add a header <em>Authorization</em> for the user&#8217;s modification action. We want to receive a <em>forbidden</em> response if we don&#8217;t.</p>
</div>
<div class="paragraph">
<p>We can imagine about the same thing for the test <em>should forbid destroy user</em>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should destroy user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid destroy user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Theses tests should fail for the moment as you might expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test test</span>/controllers/api/v1/users_controller_test.rb
..F

Failure:
Expected response to be a &lt;2XX: success&gt;, but was a &lt;403: Forbidden&gt;

..F

Failure:
<span class="s2">"User.count"</span> didn t change by <span class="nt">-1</span><span class="nb">.</span>
Expected: 0
  Actual: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The solution is quite simple. We will add a <code>before_action</code>, which will call the <code>check_owner</code> method for the <code>update</code> and <code>destroy</code> actions. This way, we will check that the user corresponding to the JWT token is the same as the user who needs to be updated.</p>
</div>
<div class="paragraph">
<p>Here is the implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update destroy]</span>
  <span class="c1"># ...</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">check_owner</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go! The implementation is straightforward. It is, therefore, time to <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Restrict actions for unauthorized users"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter04</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_4">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Yeah! You made it! You are halfway done! Keep up the good work. This chapter was a long and hard one, but it is a great step toward setting a solid mechanism for handling user authentication. We even scratch the surface for simple authorization rules.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will be focusing on customizing the JSON output for the user with <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a> gem and adding a <code>product</code> model to the equation by giving the user the ability to create a product and publish it for sale.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter05-user-products" class="sect0">User&#8217;s products</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapter, we implemented the authentication mechanism we will use throughout the application.</p>
</div>
<div class="paragraph">
<p>We have a straightforward implementation of the <code>User</code> model, but the moment of truth has come. We will customize the JSON output and add a second resource: the user&#8217;s products. These are the elements that the user will sell in the application and will be directly linked.</p>
</div>
<div class="paragraph">
<p>If you are familiar with Rails, you may already know what I am talking about. But for those who don&#8217;t know, we will associate the <code>User</code> model with the <code>Product</code> model using the <code>has_many</code> and <code>belongs_to</code> methods of <em>Active Record</em>.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build the <code>Product</code> model from scratch</p>
</li>
<li>
<p>associate it with the user</p>
</li>
<li>
<p>create the necessary entries so any customer can access the information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can clone the project up to this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter05</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start and as usual, when starting new features, we need to create a brand new branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_product_model">The product model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will first create a <code>Product</code> model. Then we&#8217;ll add some validations and finally associate it with the <code>User</code> model. Like the <code>User</code> model, the <code>Product</code> will be fully tested and automatically deleted if the user is deleted.</p>
</div>
<div class="sect2">
<h3 id="_the_foundations_of_the_product">The foundations of the product</h3>
<div class="paragraph">
<p>The <code>Product</code> template will need several fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>price</code> attribute for the product price</p>
</li>
<li>
<p>a <code>published</code> Boolean to know if the product is ready to be sold or not</p>
</li>
<li>
<p>a <code>title</code> to define a sexy product title</p>
</li>
<li>
<p>a <code>user_id</code> to associate this particular product to a user</p>
<div class="literalblock">
<div class="content">
<pre>As you may guess we generate it with the command `rails generate`:</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model Product title:string price:decimal published:boolean user:belongs_to
Running via Spring preloader <span class="k">in </span>process 1476
      invoke  active_record
      create    db/migrate/20190608205942_create_products.rb
      create    app/models/product.rb
      invoke    test_unit
      create      <span class="nb">test</span>/models/product_test.rb
      create      <span class="nb">test</span>/fixtures/products.yml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We used the <code>belongs_to</code> type for the attribute <code>user</code>. This is a shortcut that will create an <code>user_id</code> column of type <code>int</code> and add a foreign key to the <code>users.id</code> field. <code>user_id</code> will also be defined as an <code>index</code>. This is a good practice for association keys because it optimizes database queries. It is not mandatory, but I highly recommend it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Migration file should look like bellow:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190608205942_create_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:price</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">boolean</span> <span class="ss">:published</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We now just have to initiate migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>A test must fail at this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
....E

Error:
Api::V1::UsersControllerTest#test_should_destroy_user:
ActiveRecord::InvalidForeignKey: SQLite3::ConstraintException: FOREIGN KEY constraint failed

rails <span class="nb">test test</span>/controllers/api/v1/users_controller_test.rb:43</code></pre>
</div>
</div>
<div class="paragraph">
<p>You certainly said:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>What?! But I didn&#8217;t touch the users!.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>What I have seen in the code of other developers, when they work with associations, is that they forget about destroying dependencies between models. What I mean by that is if a user is deleted, so should the user&#8217;s products.</p>
</div>
<div class="paragraph">
<p>We need a user with one of the products to test this interaction between the models. Then we will delete this user in the hope that the products will disappear with him. Rails have already generated this for us. Take a look at the <em>fixture</em> of the products:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">MyString</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">9.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">one</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see this <em>fixture</em> does not use the attribute <code>user_id</code> but <code>user</code>. This means that the <code>one</code> product will have an <code>user_id</code> attribute corresponding to the <code>one</code> user ID.</p>
</div>
<div class="paragraph">
<p>Therefore, it is necessary to specify a cascading deletion to delete the <code>one</code> product when the <code>one</code> user is deleted. Let&#8217;s start with the unit test:</p>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'destroy user should destroy linked product'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">destroy</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You just have to modify the <code>User</code> model and specify the <code>has_many</code> relationship with the <code>depend: :destroy</code> option. We will see later what this method does in more detail.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p>And that&#8217;s it. Now make a <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Generate product model"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_product_validations">Product validations</h3>
<div class="paragraph">
<p>Validations are an important part when building any kind of application. This will prevent any junk data from being saved onto the database. In the product, we have to make sure that the price is a <code>number</code> and that it is not negative.</p>
</div>
<div class="paragraph">
<p>Also, an important thing about validation is to validate that every product has a user. In this case, we need to validate the presence of the <code>user_id</code>. You can see what I’m talking about in the next code snippet.</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"should have a positive price"</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">assert_not</span> <span class="n">product</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to add the implementation to make the tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">},</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests are now green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
................</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have a bunch of good quality code. Let’s commit it and keep moving:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds some validations to products"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_products_endpoints">Products endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is now time to start building the products endpoints. For now, we will just build five REST actions. In the next chapter, we will customize the JSON output by implementing the <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>.</p>
</div>
<div class="paragraph">
<p>First we need to create the <code>products_controller</code>, and we can easily achieve this with the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::products
      create  app/controllers/api/v1/products_controller.rb
      invoke  test_unit
      create    <span class="nb">test</span>/controllers/api/v1/products_controller_test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command will generate a lot of files that will allow us to start working quickly. What I mean by that is that it will generate the controller and test files already <em>scoped</em> to version 1 of the API.</p>
</div>
<div class="paragraph">
<p>As a warmup, we will start nice and easy by building the <code>show</code> action for the product.</p>
</div>
<div class="sect2">
<h3 id="_show_action_for_products">Show action for products</h3>
<div class="paragraph">
<p>As usual, we begin by adding some product <code>show</code> controller specs. The strategy here is straightforward: we just need to create a single product and make sure the server&#8217;s response is what we expect.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show product"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we add the code to make the test pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait! Don’t run the tests yet. Remember we need to add the resource to the <code>routes.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we make sure the tests are nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.................</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may notice already, the specs and implementation are straightforward. They behave the same as users.</p>
</div>
</div>
<div class="sect2">
<h3 id="_products_list">Products list</h3>
<div class="paragraph">
<p>Now it is time to output a list of products (which could be displayed as the marketplace product catalog). This endpoint should be accessible without credentials. That means we don’t require the user to be logged in to access the data. As usual, we will start writing some tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show products"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_products_url</span><span class="p">(),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show product"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s move into the implementation, which for now is going to be a simple <code>index</code> method:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
  <span class="c1">#...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to add the corresponding route:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ....</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are done for now with the public product endpoints. In the next sections, we will focus on building the actions requiring a user to be logged in to access them. Said that we are committing these changes and continue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Finishes modeling the product model along with user associations"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_products">Creating products</h3>
<div class="paragraph">
<p>Creating products is a little more complex because we will need an additional configuration. The strategy we will follow is to assign the created product to the user who owns the JWT token provided in the HTTP header <code>Authorization</code>.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start by the <code>products_controller_test.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should create product'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_products_url</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="ss">price: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">price</span><span class="p">,</span> <span class="ss">published: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">published</span> <span class="p">}</span> <span class="p">},</span>
           <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
           <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid create product'</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_products_url</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="ss">price: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">price</span><span class="p">,</span> <span class="ss">published: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">published</span> <span class="p">}</span> <span class="p">},</span>
           <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wow! We added a lot of code. If you remember the previous section, tests are pretty similar to those for about user creation. Except for some minor changes.</p>
</div>
<div class="paragraph">
<p>In this way, we can see the user and create a product associated with them. But wait! There&#8217;s something better.</p>
</div>
<div class="paragraph">
<p>If we adopt this approach, we can increase the scope of our authorization mechanism. We built the logic to get a logged user from the header <code>Authorization</code> and assigned him a method <code>current_user</code>. It is therefore quite easy to set up by simply adding the authorization header to the request and retrieving the user from it. So let&#8217;s do it:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">product_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we protect the <code>create</code> action with the <code>check_login</code> method. We also build the product by associating the current user. I added this very simple method to the <em>concern</em> <code>authenticable.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="c1"># ...</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">check_login</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="nb">self</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One last thing before you do your tests: the necessary route:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index create]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now tests should all pass:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rake test
....................</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_products">Updating products</h3>
<div class="paragraph">
<p>Hopefully, by now, you understand the logic to build the upcoming actions. This section will focus on the <code>update</code> action, which will work similarly to the <code>create</code> one. We just need to fetch the product from the database and update it.</p>
</div>
<div class="paragraph">
<p>We first adding the action to the routes so we don’t forget later:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index create update]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start dropping some tests, I just want to clarify that similarly to the <code>create</code> action we will scope the product to the <code>current_user</code>. In this case, we want to ensure the product we are updating is owned by the current user. So we will fetch that product from the <code>user.products</code> association provided by Rails.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add some specs:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should update product'</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span> <span class="p">}</span> <span class="p">},</span>
          <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid update product'</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span> <span class="p">}</span> <span class="p">},</span>
          <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I have added a <em>fixture</em> corresponding to a second user to verify that the second user cannot modify the first user&#8217;s product.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tests may look complex but take a second peek. They are almost the same we built for users.</p>
</div>
<div class="paragraph">
<p>Now let’s implement the code to make our tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_product</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update]</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update]</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@product</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">check_owner</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">set_product</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementation is quite simple. We will simply retrieve the product from the connected user and simply update it. We have also added this action to the <code>before_action</code> to prevent any unauthorized user from updating a product.</p>
</div>
<div class="paragraph">
<p>Now tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_destroying_products">Destroying products</h3>
<div class="paragraph">
<p>Our last stop for the product endpoints will be the <code>destroy</code> action. You might now imagine how this would look like. The strategy in here will be pretty similar to the <code>create</code> and <code>update</code> actions: we&#8217;ll get the logged user with JWT token and then fetch the product from the <code>user.products</code> association and finally destroy it, returning a <code>204</code> code.</p>
</div>
<div class="paragraph">
<p>Let’s start again by adding the route name to the routes file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
      <span class="n">resources</span> <span class="ss">:products</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After this, we have to add some tests as shown on this code snippet:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"should destroy product"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid destroy product"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we simply add the necessary code to make tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_product</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update destroy]</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@product</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the four lines implementation does the job. We can run tests to make sure everything is good and then we will commit the changes as we added a bunch of new code. Also, make sure you hook this action to the <code>before_action</code> callback as with the <code>update</code> action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the products create, update and destroy actions"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_feed_the_database">Feed the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>let&#8217;s fill the database with fake data before continuing with more code. We will use <em>seeds</em> to do so.</p>
</div>
<div class="paragraph">
<p>With the file <code>db/seeds.rb</code>, Rails gives us a way to easily and quickly provide default values for a new installation. It is a simple Ruby file that gives full access to all classes and methods of the application. So you don&#8217;t need to enter everything manually with the Rails console but you can simply use the file <code>db/seeds.rb</code> with the command <code>rake db:seed</code>.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start by creating a user:</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'toto@toto.fr'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'toto123'</span>
<span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now you can create the user by simply executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: toto@toto.fr</code></pre>
</div>
</div>
<div class="paragraph">
<p>It works. I don&#8217;t know about you, but I like to have dummy data that correctly fills my test database. Only I don&#8217;t always have the inspiration to give meaning to my <em>seed</em>, so I use the gem <a href="https://github.com/stympy/faker"><code>faker</code></a>. Let&#8217;s set it up there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add faker</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can use it to create five users at once with different emails.</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'locadex1234'</span>
  <span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s see what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: barbar@greenholt.io
Created a new user: westonpaucek@ortizbotsford.net
Created a new user: ricardo@schneider.com
Created a new user: scott@moenerdman.biz
Created a new user: chelsie@wiza.net</code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. But we can go further by creating products associated with these users:</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">delete_all</span>
<span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>

<span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'locadex1234'</span>
  <span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>

  <span class="mi">2</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
      <span class="ss">title: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Commerce</span><span class="p">.</span><span class="nf">product_name</span><span class="p">,</span>
      <span class="ss">price: </span><span class="nb">rand</span><span class="p">(</span><span class="mf">1.0</span><span class="o">..</span><span class="mf">100.0</span><span class="p">),</span>
      <span class="ss">published: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span>
    <span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Created a brand new product: </span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. The result is amazing. In one order, we can create three users and six products:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: tova@beatty.org
Created a brand new product: Lightweight Steel Hat
Created a brand new product: Ergonomic Aluminum Lamp
Created a new user: tommyrunolfon@tremblay.biz
Created a brand new product: Durable Plastic Car
Created a brand new product: Ergonomic Leather Shirt
Created a new user: jordon@torp.io
Created a brand new product: Incredible Paper Hat
Created a brand new product: Sleek Concrete Pants</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s <em>commit</em> changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Create a seed to populate database"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we get to the end of our chapter, it&#8217;s time to apply all our modifications to the master branch by making a <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_5">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I hope you have enjoyed this chapter. It&#8217;s a long one but the code we put together is an excellent base for the core app.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will focus on customizing user and product models' output using the gem <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>. It will allow us to easily filter the attributes to display and manage associations such as embedded objects.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter06-improve-json" class="sect0">Building JSON</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapter, we added products to the application and built all the necessary routes. We have also associated a product with a user and restricted some of the actions of <code>products_controller</code>.</p>
</div>
<div class="paragraph">
<p>Now you should be satisfied with all this work. But we still have a lot of work to do. Currently, we have a JSON output that is not perfect. JSON output looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tag Case"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"98.7761933800815"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, we want an output that does not contain the fields <code>user_id</code>, <code>created_at</code>, and <code>updated_at</code>.</p>
</div>
<div class="paragraph">
<p>An important (and difficult) part when creating your API is to decide the output format. Fortunately, some organizations have already faced this kind of problem and have established some conventions you will discover in this chapter.</p>
</div>
<div class="paragraph">
<p>You can clone the project up to this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter06</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start a new branch for this chapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter06</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_presentation_of_jsonapi">Presentation of <a href="https://jsonapi.org/">JSON:API</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>An important and difficult part of creating your API is deciding the output format. Fortunately, some conventions already exist. Certainly, the most used of them is <a href="https://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="https://jsonapi.org/format/#document-structure">JSON:API documentation</a> gives us some rules to follow regarding the JSON document formatting.</p>
</div>
<div class="paragraph">
<p>Thus, our document <strong>must</strong> contain these keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: which must contain the data we send back</p>
</li>
<li>
<p><code>errors</code> which must contain an array of errors that have occurred</p>
</li>
<li>
<p><code>meta</code> which contains a <a href="https://jsonapi.org/format/#document-meta">meta object</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The content of the <code>data</code> key is also quite strict:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it must have a <code>type</code> key corresponding to kind of the JSON model (an article, a user, etc&#8230;&#8203;)</p>
</li>
<li>
<p>properties of the objects must be placed in an <code>attributes</code> key</p>
</li>
<li>
<p>links of the objects must be placed in a <code>relationships</code> key</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this chapter we will customize the JSON output using <a href="https://github.com/jsonapi-serializer/jsonapi-serializer">jsonapi-serializer</a> gem (fork of Netflix&#8217;s <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a> gem) . Luckily for us, it already implements all <a href="https://jsonapi.org/">JSON:API</a> specifications.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s install the gem <code>jsonapi-serializer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add jsonapi-serializer</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should be ready to continue with this tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serialize_user">Serialize user</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JSON:API Serializer uses <strong>serializers</strong>. Serializers represent Ruby classes responsible for converting a model into an <a href="https://ruby-doc.org/core-2.6.3/Hash.html"><code>Hash</code></a> or a JSON.</p>
</div>
<div class="paragraph">
<p>So we need to add a <code>user_serializer.rb</code> file. We can do it manually, but the gem provides a command-line interface to do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer User email
      create  app/serializers/user_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>This has created a file called <code>user_serializer.rb</code> under the <code>app/serializers</code> directory. The new file should look like the following file:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="kp">include</span> <span class="no">JSONAPI</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:email</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This <em>serializer</em> will allow us to convert our <code>User</code> object to JSON, which implements all JSON:API specifications. Because we specified <code>email</code> as  <code>attributes</code> we retrieve it in <code>data</code> array.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try all this in the Rails with <code>rails console</code> console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span> <span class="p">).</span><span class="nf">serializable_hash</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:data</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:id</span><span class="o">=&gt;</span><span class="s2">"25"</span><span class="p">,</span> <span class="ss">:type</span><span class="o">=&gt;</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:attributes</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:email</span><span class="o">=&gt;</span><span class="s2">"tova@beatty.org"</span><span class="p">}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. As you can see, this is easy. Now we can use our new <em>serializer</em> in our <em>controller</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="c1"># ...</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quite easy, isn&#8217;t it? However, we should have a test that fails. Try it for yourself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test

</span>Failure:
Expected: <span class="s2">"one@one.org"</span>
  Actual: nil</code></pre>
</div>
</div>
<div class="paragraph">
<p>For some reason, the answer is not quite what we expect. This is because the gem modifies the response we had previously defined. So to pass these tests, you just have to modify it:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">][</span><span class="s1">'email'</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you do so test now should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit to these changes and keep moving forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-am</span> <span class="s2">"Adds user serializer for customizing the json output"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serialize_products">Serialize products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we understand how the serialization gem works, it&#8217;s time to customize the product output. The first step is the same as what we did in the previous section. We need a product serializer. So let&#8217;s do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer Product title price published
      create  app/serializers/product_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s add attributes to serialize the product:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="kp">include</span> <span class="no">JSONAPI</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. It&#8217;s no more complicated than that. Let&#8217;s change our controller a little bit.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">product</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;re updating our functional test:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show product'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">][</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check that tests pass but they should. Let&#8217;s <em>commit</em> these small changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds product serializer for custom json output"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_serialize_associations">Serialize associations</h3>
<div class="paragraph">
<p>We have worked with serializers, and you may notice that it is straightforward. In some cases difficult decision is naming your routes or structuring the JSON output. When working with associations between models on an API there are many approaches you can take.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t have to worry about this problem in our case: JSON:API specifications did it for us!</p>
</div>
<div class="paragraph">
<p>To summarize, we have a <code>has_many</code> type association between users and products.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a good idea to integrate users into the JSON outputs of products. This will make the output more cumbersome, but it will prevent the API client from executing other requests to retrieve user information related to the products. This method can save you a huge bottleneck.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_theory_of_the_injection_of_relationships">Theory of the injection of relationships</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imagine a scenario where you go to the API to get the products, but you have to display some of the user information in this case.</p>
</div>
<div class="paragraph">
<p>One possible solution would be adding the attribute <code>user_id</code> to the <code>product_serializer</code> to get the corresponding user later. This may sound like a good idea, but if you are concerned about performance or your database transactions are not fast enough, you should reconsider this approach. You must understand that for each product you retrieve, you will have to retrieve its corresponding user.</p>
</div>
<div class="paragraph">
<p>Faced with this problem, there are several alternatives.</p>
</div>
<div class="sect2">
<h3 id="_integrate_into_a_meta_attribute">Integrate into a meta attribute</h3>
<div class="paragraph">
<p>The first solution (a good one, in my opinion) is to integrate identifiers of linked users to products in a meta attribute. So we obtain a JSON like below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"user_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">

  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So that the client can retrieve these users from these <code>user_ids</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_incorporate_the_object_into_the_attribute">Incorporate the object into the attribute</h3>
<div class="paragraph">
<p>Another solution is to incorporate the <code>user</code> object into the <code>product</code> object. This may make the first request a little slower, but in this way, the client does not need to make another additional request. An example of the expected results is presented below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem with this approach is we have to duplicate the `User' objects for each product that belongs to the same user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_incorporate_the_relationships_into_include">Incorporate the relationships into `include</h3>
<div class="paragraph">
<p>The third solution (chosen by the JSON:API) is a mixture of the first two.</p>
</div>
<div class="paragraph">
<p>We will include all the relationships in an <code>include</code> key that will contain all the previously mentioned objects' relationships. Each object will also include a relationship key that defines the relationship, and that must be found in the included key.</p>
</div>
<div class="paragraph">
<p>A JSON is worth a thousand words:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Do you see the difference? This solution drastically reduces the size of the JSON and therefore, the bandwidth used.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_of_the_injection_of_relationships">Application of the injection of relationships</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So we will incorporate the user object into the product. Let&#8217;s start by adding some tests.</p>
</div>
<div class="paragraph">
<p>We will simply modify the <code>Products#show</code> test to verify that we are recovering:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show product'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:included</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now checking three things on the JSON that has been returned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>it contains the title of the product</p>
</li>
<li>
<p>it contains the user ID of the user linked to the product</p>
</li>
<li>
<p>the user data is included in the <code>include</code> key</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You may have noticed that I have chosen to use the method <a href="https://ruby-doc.org/core-2.6.3/Hash.html#method-i-dig"><code>Hash#dig</code></a>. It is a Ruby method allowing you to retrieve elements in a nested <em>Hash</em> by avoiding errors if an element is not present.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To pass this test we will start by including the relationship in the <em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="kp">include</span> <span class="no">JSONAPI</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This addition will add a <code>relationship</code> key containing the user&#8217;s identifier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Durable Marble Lamp"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11.55"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
              </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows us to correct our first two assertions. We now want to include attributes of the user who owns the product. To do this, we simply need to pass an option <code>:include</code> to the <em>serializer</em> instantiated in the <em>controller</em>. Then let&#8217;s do it:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. Now, this is what the JSON should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"staceeschultz@hahn.info"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s make a <em>commit</em> to celebrate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add user relationship to product serializer"</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="_retrieve_users_products">Retrieve user&#8217;s products</h3>
<div class="paragraph">
<p>Do you understand the principle? We have included user information in the JSON of the products. We can do the same by including product information related to a user for the <code>/api/v1/users/1</code> page.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the test:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:included</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="kp">include</span> <span class="no">JSONAPI</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:email</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And to finish controller:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:products</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go. We obtain a JSON like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"staceeschultz@hahn.info"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Durable Marble Lamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11.5537474980286"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It was straightforward. Let&#8217;s make a <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add products relationship to user#show"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_search_for_products">Search for products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This last section will continue to strengthen the <code>Products#index</code> action by setting up a straightforward search mechanism allowing any customer to filter the results. This section is optional as it will have no impact on the application modules. But if you want to practice more with the TDD I recommend that you complete this last step.</p>
</div>
<div class="paragraph">
<p>I use <a href="https://github.com/activerecord-hackery/ransack">Ransack</a> or <a href="https://github.com/casecommons/pg_search">pg_search</a> to build advanced search forms extremely quickly. But since the goal is learning and searching, we are going to do very simple. I think we can build a search engine from scratch. We simply have to consider the criteria by which we will filter the attributes. Hang on to your seats it&#8217;s going to be a tough trip.</p>
</div>
<div class="paragraph">
<p>We will, therefore, filter the products according to the following criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By title</p>
</li>
<li>
<p>By price</p>
</li>
<li>
<p>Sort by creation date</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It may seem short and easy, but believe me, it will give you a headache if you don&#8217;t plan it.</p>
</div>
<div class="sect2">
<h3 id="_the_keyword_by">The keyword by</h3>
<div class="paragraph">
<p>We will create a <em>scope</em> to find records that match a particular character pattern. Let&#8217;s call it <code>filter_by_title</code>.</p>
</div>
<div class="paragraph">
<p>We will start by adding some <em>fixtures</em> with different products to test:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">TV Plosmo Philopps</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">9999.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">one</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Azos Zeenbok</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">499.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">two</span>

<span class="na">another_tv</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Cheap TV</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">99.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">two</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can build some tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should filter products by name"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'tv'</span><span class="p">).</span><span class="nf">count</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should filter products by name and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'tv'</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following tests ensure that the method <code>Product.filter_by_title</code> will correctly search for products according to their title. We use the term <code>tv</code> in lowercase to ensure that our search will not be case sensitive.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:filter_by_title</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">keyword</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'lower(title) LIKE ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">keyword</span><span class="p">.</span><span class="nf">downcase</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>scoping</em> allows you to specify commonly-used queries that can be referenced as method calls on models. With these <em>scopes</em> you can also link with Active Record methods like <code>where</code>, <code>joins</code>, and <code>includes</code> because a <em>scope</em> always returns an object <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a>. I invite you to take a look at <a href="https://guides.rubyonrails.org/active_record_querying.html#scopes_record_querying.html#scopes">Rails documentation</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implementation is sufficient for our tests to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_by_price">By price</h3>
<div class="paragraph">
<p>To filter by price, things can get a little more delicate. We will break the logic of filtering by price in two different methods: one that will look for products larger than the price received and the other that will look for those below that price. This way, we will keep some flexibility, and we can easily test the <em>scope</em>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by building the tests of the <em>scope</em> <code>above_or_equal_to_price</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should filter products by price and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementation is very, very simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:above_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &gt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is sufficient to convert our tests to green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
...........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now imagine the behavior of the opposite method. Here are the tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should filter products by price lower and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And implementation.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:below_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &lt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For our sake, let&#8217;s do the tests and check that everything is beautiful and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
............................</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we haven&#8217;t had many problems. Let&#8217;s just add another <em>scope</em> to sort the records by date of the last update. If the owner of the products decides to update some data, he will surely want to sort his products by creation date.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sort_by_creation_date">Sort by creation date</h3>
<div class="paragraph">
<p>This <em>scope</em> is very easy. Let&#8217;s add some tests first:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should sort product by most recent'</span> <span class="k">do</span>
    <span class="c1"># we will touch some products to update them</span>
    <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">touch</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">recent</span><span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span>
    <span class="n">order</span><span class="p">(</span><span class="ss">:updated_at</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.............................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search scopes on the product model"</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_search_engine">Search engine</h4>
<div class="paragraph">
<p>Now that we have the basis for the search engine we will use in the application, it is time to implement a simple but powerful search method. It will manage all the logic to retrieve the product records.</p>
</div>
<div class="paragraph">
<p>The method will link all the <code>scope</code> that we have previously built and return the result. Let&#8217;s start by adding some tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'search should not find "videogame" and "100" as min price'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'videogame'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">100</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">).</span><span class="nf">empty?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'search should find cheap TV'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'tv'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">max_price: </span><span class="mi">150</span> <span class="p">}</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get all products when no parameters'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span><span class="p">,</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">({})</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'search should filter by product ids'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have added a lot of code, but I assure you that the implementation is straightforward. You can go further and add some additional tests but, in my case, I didn&#8217;t find it necessary.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">].</span><span class="nf">present?</span> <span class="p">?</span> <span class="no">Product</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">])</span> <span class="p">:</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>

    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">])</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">recent</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:recent</span><span class="p">]</span>

    <span class="n">products</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to note that we return the products as an object <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a> so that we can chain other methods if necessary or page them as we will see in the last chapters. Simply update the <code>Product#index</code> action to retrieve the products from the search method:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can run the entire test suite to ensure that the application is in good health so far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.................................
33 runs, 49 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit all these changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search class method to filter products"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we get to the end of our chapter, it is time to apply all our modifications to the master branch by making a <code>merge</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter06</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_6">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Until now, it was easy thanks to the gem <a href="https://github.com/jsonapi-serializer/jsonapi-serializer">jsonapi-serializer</a>. In the coming chapters, we will start building the <code>Order</code> model to involve users in the products.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter07-placing-orders" class="sect0">Placing Orders</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapter, we handle associations between products and users and serialize them to scale fast and easy. Now it is time to start placing orders, which is going to be a more complex situation. We will handle associations between these three models. We have to be smart enough to handle the JSON output we are delivering.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will make several things, which I list below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an <code>Order</code> model with its corresponding specs</p>
</li>
<li>
<p>Handle JSON output association between the order user and product models</p>
</li>
<li>
<p>Send a confirmation email with the order summary</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So now everything is clear, we can get our hands dirty. You can clone the project up to this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter07</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s create a branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modeling_order">Modeling order</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you remember the associations model, <code>Order</code> model is associated with users and products simultaneously. Actually, It is straightforward to achieve this in Rails. The tricky part is when it comes to serializing this object. I&#8217;ll talk more about this in the next section.</p>
</div>
<div class="paragraph">
<p>Let’s start by creating the older model with a special form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model order user:belongs_to total:decimal</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above will generate the order model, but I’m taking advantage of the <code>references</code> method to create the corresponding foreign key for the order to belong to a user. It also adds the <code>belongs_to</code> directive into the order model. Let’s migrate the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to write some tests into the <code>order_test.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s1">'Should have a positive total'</span> <span class="k">do</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">assert_not</span> <span class="n">order</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is fairly simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to add the <code>orders</code> relationship to our users by specifying cascading deletion:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..................................</code></pre>
</div>
</div>
<div class="paragraph">
<p>And <em>commit</em> all this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Generate orders"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_orders_and_products">Orders and Products</h3>
<div class="paragraph">
<p>We need to set up the association between the <code>order</code> and the <code>product</code>, built with a <strong>has-many-to-many</strong> association. As many products will be placed on many orders, and the orders will have multiple products. So, in this case, we need a middle model that will join these two other objects and map the appropriate association.</p>
</div>
<div class="paragraph">
<p>Let’s generate this model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model placement order:belongs_to product:belongs_to</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s run the migration on the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementation is like so:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have been following the tutorial so far, the implementation is already there because of the <code>references</code> type we pass on the model command generator. We should add <code>inverse_of</code> option to the <code>placement</code> model for each <code>belongs_to</code> call. This gives a little boost when referencing the parent object.</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span>
  <span class="n">belongs_to</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">inverse_of: :placements</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s run the <em>models</em> spec and make sure everything is green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..................................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that everything is nice and green, let’s commit the changes and continue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Associates products and orders with a placements model"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_expose_the_user_model">Expose the user model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is now time to prepare the order controller to expose the right orders. If you remember the previous chapters where <a href="https://github.com/Netflix/fast_jsonapi_jsonapi">fast_jsonapi</a> was used, you should remember that it was straightforward.</p>
</div>
<div class="paragraph">
<p>Let us first define what actions we will take:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An indexing action to retrieve current user orders</p>
</li>
<li>
<p>A show action to retrieve a particular order from the current user</p>
</li>
<li>
<p>A creation action to actually place the order</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the action <code>index</code>. First, we have to create the order controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Up to this point and before start typing some code, we have to ask ourselves:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Should I leave my order endpoints nested into the <code>UsersController</code> or should I isolate them?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The answer is straightforward: it depends on the amount of information you want to expose to the developer.</p>
</div>
<div class="paragraph">
<p>In our case, we will not do this because we will retrieve the user orders from the <code>/orders</code> route. Let&#8217;s start with some tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid orders for unlogged'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span>
      <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
      <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">].</span><span class="nf">count</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the test suite now, both tests should fail as you may expect. This is because they have not even set the correct routes nor actions. So let’s start by adding the routes:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">]</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time for the orders serializer implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer Order</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s add relationships:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span>
  <span class="kp">include</span> <span class="no">JSONAPI</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is now time to implement the controller:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index]</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now all of our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
....................................
36 runs, 53 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>We like our commits very atomic, so let’s commit these changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds the index action for order"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_render_a_single_order">Render a single order</h3>
<div class="paragraph">
<p>As you can already imagine, this route is straightforward. We only have to set up a few configurations (routes, controller action), and this section will be over. We will also include products related to this order in the output JSON.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by adding some tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show order'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_order_url</span><span class="p">(</span><span class="vi">@order</span><span class="p">),</span>
        <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
        <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">include_product_attr</span> <span class="o">=</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'included'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">]</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">include_product_attr</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the second part of the test verifies the product is included in the JSON.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add the implementation to run our tests. On the <code>routes.rb</code> file, add the <code>show</code> action to the order routes:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And implementation should look like this:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show]</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">order</span>
      <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:products</span><span class="p">]</span> <span class="p">}</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="mi">404</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our tests should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.....................................
37 runs, 55 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s commit the changes and move onto the create order action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the show action for order"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_placing_an_order">Placing an order</h3>
<div class="paragraph">
<p>It is now time to allow the user to place some orders. This will add complexity to the application but don&#8217;t worry, we&#8217;ll do it one step at a time.</p>
</div>
<div class="paragraph">
<p>Before launching this feature, let&#8217;s take the time to think about the implications of creating an order in the application. I&#8217;m not talking about setting up a transaction service like <a href="https://stripe.com/">Stripe</a> or <a href="https://www.braintreepayments.com/">Braintree</a> but things like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>management of out-of-stock products</p>
</li>
<li>
<p>decrease in product inventory</p>
</li>
<li>
<p>add some validation for order placement to ensure that there are enough products at the time the order is placed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It seems like there&#8217;s still a lot to do but believe me: you&#8217;re closer than you think, and it&#8217;s not as hard as it looks. For now, let&#8217;s keep it simple and assume that we still have enough products to place any number of orders. We&#8217;re just concerned about the server&#8217;s response at the moment.</p>
</div>
<div class="paragraph">
<p>If you remember order model we need three things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a total for the order</p>
</li>
<li>
<p>user who places the order</p>
</li>
<li>
<p>products for the order</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Based on this information we can start adding some tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="vi">@order_params</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">order: </span><span class="p">{</span>
      <span class="ss">product_ids: </span><span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">],</span>
      <span class="ss">total: </span><span class="mi">50</span>
    <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should forbid create order for unlogged'</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should create order with two products'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span>
        <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
        <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we are creating a <code>order_params</code> variable with the order data. Can you see the problem here? If not I’ll explain it later. Let’s just add the necessary code to make this test pass.</p>
</div>
<div class="paragraph">
<p>First, we need to add the action to the resources on the routes file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show create]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the implementation which is easy:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show create]</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:total</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now our tests should all be green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.......................................
39 runs, 59 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, so we have everything nice and green. Now we should move on to the next chapter, right? Let me stop you right there. We have some serious errors on the app, and they are not related to the code itself but on the business part.</p>
</div>
<div class="paragraph">
<p>Not because the tests are green, it means the app is filling the business part of the app. I wanted to bring this up because in many cases, that&#8217;s super easy just receiving params and building objects from those params thinking that we are always receiving the correct data. In this particular case, we cannot rely on that, and the easiest way to see this is that we are letting the client set the order total, yeah crazy!</p>
</div>
<div class="paragraph">
<p>We have to add some validations or a callback to calculate the order total and set it through the model. This way we don’t longer receive that total attribute and have complete control over this attribute. So let’s do that.</p>
</div>
<div class="paragraph">
<p>We first need to add some specs for the order model:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@product1</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@product2</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'Should set total'</span> <span class="k">do</span>
    <span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span> <span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">products</span> <span class="o">&lt;&lt;</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">products</span> <span class="o">&lt;&lt;</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">save</span>

    <span class="n">assert_equal</span> <span class="p">(</span><span class="vi">@product1</span><span class="p">.</span><span class="nf">price</span> <span class="o">+</span> <span class="vi">@product2</span><span class="p">.</span><span class="nf">price</span><span class="p">),</span> <span class="n">order</span><span class="p">.</span><span class="nf">total</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now add the implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now hook the <code>set_total!</code> method to a <code>before_validation</code> callback to ensure it has the correct total before it is validated.</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_validation</span> <span class="ss">:set_total!</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are making sure the total is always present and bigger or equal to zero. This means we can remove those validations and remove the specs. I’ll wait. Our tests should be passing by now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

...........F

Failure:
OrderTest#test_Should_have_a_positive_total <span class="o">[</span>/home/arousseau/github/madeindjs/market_place_api/test/models/order_test.rb:14]:
Expected <span class="nb">true </span>to be nil or <span class="nb">false


</span>rails <span class="nb">test test</span>/models/order_test.rb:11

............................

Finished <span class="k">in </span>0.542600s, 73.7191 runs/s, 110.5786 assertions/s.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Oops! We get a <em>failure</em> on our previous test <em>Should have a positive total</em>. This is logical since the order total is calculated dynamically. So we can simply remove this test that has become obsolete.</p>
</div>
<div class="paragraph">
<p>Our tests must continue to pass. Let&#8217;s commit our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the create method for the orders controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_send_order_confirmation_email">Send order confirmation email</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last section for this chapter will be to sent a confirmation email for the user who just placed it. If you want to skip this and jump into the next chapter, go ahead. This section is more like a warmup.</p>
</div>
<div class="paragraph">
<p>You may be familiar with email manipulation with Rails so I’ll try to make this fast and simple. We first create the <code>order_mailer</code> with an email named <code>send_confirmation</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate mailer order_mailer send_confirmation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can add some tests for the order mails we just created:</p>
</div>
<div class="listingblock">
<div class="title">test/mailers/order_mailer_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be set to be delivered to the user from the order passed in"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Order Confirmation"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s1">'no-reply@marketplace.com'</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_match</span> <span class="s2">"Order: #</span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
    <span class="n">assert_match</span> <span class="s2">"You ordered </span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2"> products"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I simply copied/pasted tests from the documentation and adapted them to our needs. We must now ensure that these tests pass.</p>
</div>
<div class="paragraph">
<p>First, we add the method <code>OrderMailer#send_confirmation</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/mailers/order_mailer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s1">'no-reply@marketplace.com'</span>
  <span class="k">def</span> <span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span>
    <span class="n">mail</span> <span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s1">'Order Confirmation'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After adding this code we must add corresponding views. It is a good practice to include a text version in addition to the HTML version.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;%# app/views/order_mailer/send_confirmation.text.erb %&gt;</span>
Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span>
You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:
<span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;!-- app/views/order_mailer/send_confirmation.html.erb --&gt;</span>
<span class="nt">&lt;h1&gt;</span>Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 66 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now, just call the method <code>OrderMailer#send_confirmation</code> in the creation action on the order controller:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make sure we didn&#8217;t break anything, let&#8217;s run all the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 66 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit to everything we&#8217;ve just done to complete this section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds order confirmation mailer"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we get to the end of our chapter, it is time to apply all our modifications to the master branch by making a `merge':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_7">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>That&#8217;s it! You did it! You can applaud yourself. I know it&#8217;s been a long time but believe me, it&#8217;s almost over.</p>
</div>
<div class="paragraph">
<p>In the next chapters, we will continue working on the order template to add validations when placing an order. Some scenarios are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What happens when products are not available?</p>
</li>
<li>
<p>Decrease the quantity of the product in progress when placing an order</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next chapter will be short, but it is essential for the health of the application. So don&#8217;t skip it.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter08-improve_orders" class="sect0">Improving orders</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapter, we extended our API to place orders and send a confirmation email to the user (just to improve the user experience). This chapter will take care of some validations on the order model, just to make sure it is placeable, just like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decrement the current product quantity when an order is placed</p>
</li>
<li>
<p>What happens when products are not available?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We’ll probably need to update the JSON output for the orders a little, but let’s not spoil things up.</p>
</div>
<div class="paragraph">
<p>So now that we have everything clear, we can get our hands dirty. You can clone the project up to this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="n">tags</span><span class="o">/</span><span class="n">checkpoint_chapter08</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s create a branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">chapter08</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_decrementing_product_quantity">Decrementing product quantity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On this first stop, we will update the product quantity to make sure every order will deliver the actual product. Currently, the <code>product</code> model doesn’t have a <code>quantity</code> attribute. So let’s do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_products quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait, don’t run migrations now. We&#8217;ll be making a small modification to it. As a good practice, I like adding default values for the database just making sure I don’t mess things up with <code>null</code> values. This is a perfect case!</p>
</div>
<div class="paragraph">
<p>Your migration file should look like this:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190621105101_add_quantity_to_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can migrate the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s not forget to update the <em>fixtures</em> by adding the <strong>quantity</strong> field (I chose the value <code>5</code> totally randomly).</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">one</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">another_tv</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="s">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is now time to reduce the product&#8217;s quantity once the <code>Order</code> has been passed. The first thing probably coming to mind is to do it in the <code>Order</code> model. This is a common mistake.</p>
</div>
<div class="paragraph">
<p>When you work with <em>Many-to-Many</em> associations, we completely forget the join model, which is <code>Placement</code>. The <code>Placement</code> is a better place to manage this because we have access to the order and the product. This way, we can easily reduce the stock of the product.</p>
</div>
<div class="paragraph">
<p>Before we start implementing the code, we need to change how we manage the creation of the order because we now have to accept a quantity for each product. If you remember, we are waiting for a table of product identifiers. I will try to keep things simple and send a Hash table with the keys <code>product_id</code> and <code>quantity</code>.</p>
</div>
<div class="paragraph">
<p>A quick example would be something like that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">product_ids_and_quantities</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="ss">product_id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">4</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">product_id: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">5</span> <span class="p">}</span>
<span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is going to be tricky so stay with me. Let’s first build some unit tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'builds 2 placements for the order'</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span> <span class="p">[</span>
      <span class="p">{</span> <span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span> <span class="p">},</span>
      <span class="p">{</span> <span class="ss">product_id: </span><span class="vi">@product2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span> <span class="p">},</span>
    <span class="p">]</span>

    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Placement.count'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@order</span><span class="p">.</span><span class="nf">save</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then into the implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>

  <span class="c1"># @param product_ids_and_quantities [Array&lt;Hash&gt;] something like this `[{product_id: 1, quantity: 2}]`</span>
  <span class="c1"># @yield [Placement] placements build</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="n">placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:product_id</span><span class="p">])</span>
      <span class="k">yield</span> <span class="n">placement</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And if we run our tests, they should be all nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 60 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>build_placements_with_product_ids_and_quantities</code> will build the placement objects, and once we trigger the <code>save</code> method for the order everything will be inserted into the database. One last step before committing this is to update the <code>orders_controller_test</code> along with its implementation.</p>
</div>
<div class="paragraph">
<p>First we update the <code>orders_controller_test</code> file:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@order_params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">order: </span><span class="p">{</span>
        <span class="ss">product_ids_and_quantities: </span><span class="p">[</span>
          <span class="p">{</span> <span class="ss">product_id: </span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span> <span class="p">},</span>
          <span class="p">{</span> <span class="ss">product_id: </span><span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span> <span class="p">},</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should create order with two products and placements'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Placement.count'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span>
          <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span>
          <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">as: :json</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to update the <code>orders_controller</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">user: </span><span class="n">current_user</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">order_params</span><span class="p">[</span><span class="ss">:product_ids_and_quantities</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">product_ids_and_quantities: </span><span class="p">[</span><span class="ss">:product_id</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that I also modified the <code>OrdersController#order_params</code> method.</p>
</div>
<div class="paragraph">
<p>Finally, we need to update the factory product file to assign a high quantity value to have at least a few products in stock.</p>
</div>
<div class="paragraph">
<p>Let’s commit this changes and keep moving:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Allows the order to be placed along with product quantity"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Did you notice we are not saving the quantity for each product anywhere? There is no way to keep track of that. This can be easily fixed by just adding a quantity attribute to the <code>Placement</code> model. So this way for each product we save its corresponding quantity. Let’s start by creating the migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_placements quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the product quantity attribute migration we should add a default value equal to 0. Remember this is optional but I do like this approach. Migration file should look like:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190621114614_add_quantity_to_placements.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToPlacements</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run migrations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add the attribute <code>quantity</code> in the <em>fixtures</em>:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/placements.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">one</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="s">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we just need to update the <code>build_placements_with_product_ids_and_quantities</code> to add the <code>quantity</code> for the placements:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>

  <span class="c1"># @param product_ids_and_quantities [Array&lt;Hash&gt;] something like this `[{product_id: 1, quantity: 2}]`</span>
  <span class="c1"># @yield [Placement] placements build</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="n">placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span>
        <span class="ss">product_id: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:product_id</span><span class="p">],</span>
        <span class="ss">quantity: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:quantity</span><span class="p">],</span>
      <span class="p">)</span>
      <span class="k">yield</span> <span class="n">placement</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 61 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds quantity to placements"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_extending_the_placement_model">Extending the Placement model</h3>
<div class="paragraph">
<p>It is time to update the product quantity once the order is saved, or more accurate once the placement is created. To achieve this, we will add a method and then hook it up to an <code>after_create</code> callback.</p>
</div>
<div class="listingblock">
<div class="title">test/models/placement_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">PlacementTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'decreases the product quantity by the placement quantity'</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="vi">@placement</span><span class="p">.</span><span class="nf">product</span>

    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'product.quantity'</span><span class="p">,</span> <span class="o">-</span><span class="vi">@placement</span><span class="p">.</span><span class="nf">quantity</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@placement</span><span class="p">.</span><span class="nf">decrement_product_quantity!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementation is fairly easy as shown bellow:</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">after_create</span> <span class="ss">:decrement_product_quantity!</span>

  <span class="k">def</span> <span class="nf">decrement_product_quantity!</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">decrement!</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s <em>commit</em> our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Decreases the product quantity by the placement quantity"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validate_quantity_of_products">Validate quantity of products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since the beginning of the chapter, we have added the attribute <code>quantity</code> to the product model. It is now time to validate the quantity of product is sufficient for the order to be placed. To make things more interesting, we will do this using a custom validator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can consult <a href="https://guides.rubyonrails.org/active_record_validations.html#performing-custom-validations">documentation</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First, we need to add a <code>validators</code> directory under the <code>app</code> directory (Rails will pick it up for so we do not need to load it).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/validators
<span class="nv">$ </span><span class="nb">touch </span>app/validators/enough_products_validator.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we drop any code line, we need to add a spec to the <code>Order</code> model to check if the order can be placed.</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"an order should not claim too much product than available"</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">&lt;&lt;</span> <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="vi">@product1</span><span class="p">.</span><span class="nf">quantity</span><span class="p">))</span>

    <span class="n">assert_not</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see on the spec, we first make sure that <code>placement_2</code> is trying to request more products than are available, so in this case, the <code>order</code> is not supposed to be valid.</p>
</div>
<div class="paragraph">
<p>The test by now should be failing, let’s turn it into green by adding the code for the validator:</p>
</div>
<div class="listingblock">
<div class="title">app/validators/enough_products_validator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">EnoughProductsValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="n">record</span><span class="p">.</span><span class="nf">placements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span>
      <span class="n">product</span> <span class="o">=</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span>
      <span class="k">if</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">&gt;</span> <span class="n">product</span><span class="p">.</span><span class="nf">quantity</span>
        <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"Is out of stock, just </span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">quantity</span><span class="si">}</span><span class="s2"> left"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I manage to add a message for each of the products out of stock, but you can handle it differently. Now we just need to add the validator to the <code>Order</code> model like so:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>
  <span class="c1"># ...</span>
  <span class="n">validates_with</span> <span class="no">EnoughProductsValidator</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s commit changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds validator for order with not enough products on stock"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_the_total">Updating the total</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Did you realize that the <code>total</code> is being miscalculated? Currently, it is just adding the price for the products on order regardless of the quantity requested. Let me add the code to clarify the problem:</p>
</div>
<div class="paragraph">
<p>Currently, in the <code>order</code> model we have this method to calculate the amount to pay:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of calculating the <code>total</code> by just adding the product prices, we need to multiply it by the quantity. So let’s update the spec first:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"Should set total"</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">=</span> <span class="p">[</span>
      <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span><span class="p">),</span>
      <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">set_total!</span>
    <span class="n">expected_total</span> <span class="o">=</span> <span class="p">(</span><span class="vi">@product1</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="vi">@product2</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">assert_equal</span> <span class="n">expected_total</span><span class="p">,</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the implementation is fairly easy:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">placements</span>
                     <span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span> <span class="p">}</span>
                     <span class="p">.</span><span class="nf">sum</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the specs should be green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 63 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s commit the changes and wrap up.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Updates the total calculation for order"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we get to the end of our chapter, it is time to apply all our modifications to the master branch by making a <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter08</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_8">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh, you&#8217;re here! Allow me to congratulate you! That&#8217;s a long way from the first chapter. But you&#8217;re one step closer. In fact, the next chapter will be the last. So try to make the most of it.</p>
</div>
<div class="paragraph">
<p>The last chapter will focus on optimizing the API using paging, caching, and background tasks. So buckle up, it&#8217;s going to be a hectic ride.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p>Welcome to the last chapter of the book. It has been a long way, but you are only a step away from the end. In the previous chapter, we completed the modeling of the order model. We could say that the project is now finished, but I want to cover some important details about optimization. The topics I will discuss here will be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pagination</p>
</li>
<li>
<p>caching</p>
</li>
<li>
<p>optimization of SQL queries</p>
</li>
<li>
<p>the activation of CORS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I will try to go as far as I can by trying to cover some common scenarios. I hope these scenarios will be useful for some of your projects.</p>
</div>
<div class="paragraph">
<p>If you start reading at this point, you&#8217;ll probably want the code to work, you can clone it like that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter09</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now create a branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pagination">Pagination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A very common strategy to optimize an array of records from the database is to load just a few by paginating them and if you are familiar with this technique, you know that in Rails that&#8217;s really easy to achieve it whether if you are using <a href="https://github.com/mislav/will_paginate">will_paginate</a> or <a href="https://github.com/amatsuda/kaminari">kaminari</a>.</p>
</div>
<div class="paragraph">
<p>Only tricky part in here is how we are supposed to handle the JSON output now to give enough information to the client on how the array is paginated. If you recall the first chapter I shared some resources on the practices I would be following in here. One of them was <a href="http://jsonapi.org/" class="bare">http://jsonapi.org/</a>, which is a must-bookmark page.</p>
</div>
<div class="paragraph">
<p>If we read the format section, we will reach a sub-section called <a href="http://jsonapi.org/format/#document-structure-top-level">Top Level</a> and in very few words they mention something about pagination:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>"meta": meta-information about a resource, such as pagination.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>It is not very descriptive, but we have a hint on what to look next about the pagination implementation, but don&#8217;t worry, that is exactly what we are going to do here.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the <code>products</code> list.</p>
</div>
<div class="sect2">
<h3 id="_products">Products</h3>
<div class="paragraph">
<p>We will start nice and easy by paginating the products list as we don&#8217;t have any kind of access restriction, which leads to easier testing.</p>
</div>
<div class="paragraph">
<p>First, we need to add the <a href="https://github.com/amatsuda/kaminari">kaminari</a> gem to our <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add kaminari</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can go to the <code>index</code> action on the <code>products_controller</code> and add the pagination methods as pointed on the documentation:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">])</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only thing that changed is the query on the database to limit the result by 25 per page, which is the default. But we have not added any extra information to the JSON output.</p>
</div>
<div class="paragraph">
<p>We need to provide the pagination information on the <code>meta</code> tag in the following form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"first"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"last"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=30"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"prev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have the final structure for the <code>meta</code> tag we just need to output it on the JSON response. Let&#8217;s first add some specs:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show products'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_products_url</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test we have just added should fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................F

Failure:
Api::V1::ProductsControllerTest#test_should_show_products <span class="o">[</span><span class="nb">test</span>/controllers/api/v1/products_controller_test.rb:13]:
Expected nil to not be nil.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add the pagination information. We will make a part of it in a separate <em>concerns</em> in order to better decouple our code:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/paginable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># app/controllers/concerns/paginable.rb</span>
<span class="k">module</span> <span class="nn">Paginable</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">current_page</span>
    <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]</span> <span class="o">||</span> <span class="mi">1</span><span class="p">).</span><span class="nf">to_i</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">per_page</span>
    <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">]</span> <span class="o">||</span> <span class="mi">20</span><span class="p">).</span><span class="nf">to_i</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can use it in the controller.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, if we check the specifications, they should all pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 65 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have made a superb optimization for the product list route. It is up to the customer to retrieve the <code>page</code> with the right <code>per_page</code> parameter for registrations.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s make these changes and continue with the list of commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds pagination for the products index action to optimize response"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_orders_list">Orders list</h3>
<div class="paragraph">
<p>Now it&#8217;s time to do exactly the same for the <code>orders</code> list endpoint, which should be really easy to implement. But first, let&#8217;s add some specs to the <code>orders_controller_test.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">].</span><span class="nf">count</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may already know, our tests are no longer passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................................F

Failure:
Api::V1::OrdersControllerTest#test_should_show_orders <span class="o">[</span><span class="nb">test</span>/controllers/api/v1/orders_controller_test.rb:28]:
Expected nil to not be nil.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s turn the red into green:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
                          <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                          <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@orders</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all the tests should be nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 67 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s place and commit, because a refactor is coming:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds pagination for orders index action"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring_pagination">Refactoring pagination</h3>
<div class="paragraph">
<p>If you have followed this tutorial or are an experienced Rails developer, you probably like to keep things DRY. You may have noticed that the code we just wrote is duplicated. I think it&#8217;s good to clean up the code a little once the functionality is implemented.</p>
</div>
<div class="paragraph">
<p>We will first clean up these tests that we duplicated in the file <code>orders_controller_test.rb</code> and <code>products_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To refactor it, we will move these assertions into the <code>test_helper.rb</code> file in a method we will use:</p>
</div>
<div class="listingblock">
<div class="title">test/test_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">assert_json_response_is_paginated</span> <span class="n">json_response</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This method can now be used to replace the four assertions in the <code>orders_controller_test.rb</code> and <code>products_controller_test.rb</code> files:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_json_response_is_paginated</span> <span class="n">json_response</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show products'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_json_response_is_paginated</span> <span class="n">json_response</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And both specs should be passing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 71 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have done this simple factorization for testing, we can move on to implementing pagination for controllers and clean things up. If you remember the indexing action for both product and order controllers, they both have the same pagination format. Let&#8217;s move this logic into a method called <code>get_links_serializer_options</code> under the file <code>paginable.rb</code>, so we can access it on any controller that would need paging.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/paginable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Paginable</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">get_links_serializer_options</span> <span class="n">links_paths</span><span class="p">,</span> <span class="n">collection</span>
    <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can substitute the pagination hash on both controllers for the method. Like so:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
                          <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                          <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_orders_path'</span><span class="p">,</span> <span class="vi">@orders</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@orders</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the specs for each file, they should be all nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 71 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would be a good time to <em>commit</em> the changes and move on to the next section on caching.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Factorize pagination"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_caching">API Caching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is currently an implementation to do caching with the gem <code>jsonapi-serializer</code> which is really easy to handle. Although in older versions of the gem, this implementation can change, it does the job.</p>
</div>
<div class="paragraph">
<p>If we request the product list, we will notice that the response time takes about 174 milliseconds using cURL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/api/v1/products
Total: 0,137088</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>-w</code> option allows us to retrieve the time of the request, <code>-o' redirects the response to a file, and `-s</code> hides the cURL display
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By adding only one line to the <code>ProductSerializer</code> class, we will see a significant improvement in response time!</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">store: </span><span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">,</span> <span class="ss">namespace: </span><span class="s1">'jsonapi-serializer'</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">store: </span><span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">,</span> <span class="ss">namespace: </span><span class="s1">'jsonapi-serializer'</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">store: </span><span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">,</span> <span class="ss">namespace: </span><span class="s1">'jsonapi-serializer'</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">1</span><span class="p">.</span><span class="nf">hour</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s all! Let&#8217;s check for improvement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/api/v1/products
Total: 0,054786
<span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/api/v1/products
Total: 0,032341</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we went from 174 ms to 21 ms. The improvement is, therefore, enormous! Let&#8217;s commit our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">am</span> <span class="s2">"Adds caching for the serializers"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_n1_queries">N+1 Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>N+1* requests are a wound that can have a huge impact on the performance of an application. This phenomenon often occurs when using an <strong>ORM</strong> because it generates <strong>automatically</strong> SQL queries for us. This handy tool is double-edged because it can generate a <strong>large number</strong> of SQL queries.</p>
</div>
<div class="paragraph">
<p>Something to know about SQL queries is that it&#8217;s better to limit the number. In other words, a large request is often more efficient than a hundred small ones.</p>
</div>
<div class="paragraph">
<p>Here is an example where we want to recover all users who have already created a product. Open the Rails console with <code>rails console</code> and execute the following Ruby code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="n">product</span><span class="p">.</span><span class="nf">user</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The interactive console of Rails shows us the SQL queries that are generated. See for yourself:</p>
</div>
<div class="paragraph">
<p>We see here that a large number of requests are generated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Product.all</code> = 1 request to recover the products</p>
</li>
<li>
<p><code>product.user</code> = 1 request <code>SELECT "users".* FROM "users" WHERE "users". "id" =? LIMIT 1 [[[["id", 1]]]</code> per product recovered</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hence the name "N+1 request" since a request is made via a child link.</p>
</div>
<div class="paragraph">
<p>We can fix this simply by using <code>includes</code>. <code>Includes</code> will <strong>pre-load</strong> the child objects in a single request. It is very easy to use. If we repeat the previous example. Here is the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="n">product</span><span class="p">.</span><span class="nf">user</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The interactive console of Rails shows us the SQL queries that are generated. See for yourself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">Product</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"products"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"products"</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span> <span class="p">[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">29</span><span class="p">],</span> <span class="p">[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">30</span><span class="p">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails make a second request that will retrieve <strong>all</strong> users at once.</p>
</div>
<div class="sect2">
<h3 id="_prevention_of_n_1_requests">Prevention of N + 1 requests</h3>
<div class="paragraph">
<p>Imagine we want adding owners of the products for the path <code>/products</code>. We have already seen that with the <code>fast_jsonapi</code> library it is straightforward to do this:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="c1"># ...</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:user</span><span class="p">]</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s make a request with cURL. I remind you we must obtain an authentication token before accessing the page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">--data</span> <span class="s2">"user[email]=ockymarvin@jacobi.co"</span> <span class="nt">--data</span> <span class="s2">"user[password]=locadex1234"</span>  http://localhost:3000/api/v1/tokens</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
"<a href="mailto:ockymarvin@jacobi.co">ockymarvin@jacobi.co</a>" corresponds to a user created in my application with the <em>seed</em>. In your case, it will probably be different from mine since we used the Faker library.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the help of the token obtained, we can now make a request to access the products</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">--header</span> <span class="s2">"Authorization=ey..."</span> http://localhost:3000/api/v1/products</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will most likely see several requests in the Rails console running the webserver.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">Started</span> <span class="k">GET</span> <span class="nv">"/api/v1/products"</span> <span class="k">for</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="k">at</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">13</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">19</span> <span class="o">+</span><span class="mi">0200</span>
<span class="n">Processing</span> <span class="k">by</span> <span class="n">Api</span><span class="p">::</span><span class="n">V1</span><span class="p">::</span><span class="n">ProductsController</span><span class="o">#</span><span class="k">index</span> <span class="k">as</span> <span class="n">JSON</span>
   <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="nv">"products"</span>
  <span class="err">↳</span> <span class="n">app</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">concerns</span><span class="o">/</span><span class="n">paginable</span><span class="p">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="k">in</span> <span class="nv">`get_links_serializer_options'
  Product Load (0.2ms)  SELECT "products".* FROM "products" LIMIT ? OFFSET ?  [["LIMIT", 20], ["OFFSET", 0]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `</span><span class="k">index</span><span class="s1">'
  User Load (0.1ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `index'</span>
   <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"products"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">FROM</span> <span class="nv">"products"</span> <span class="k">WHERE</span> <span class="nv">"products"</span><span class="p">.</span><span class="nv">"user_id"</span> <span class="o">=</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"user_id"</span><span class="p">,</span> <span class="mi">36</span><span class="p">]]</span>
  <span class="err">↳</span> <span class="n">app</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">products_controller</span><span class="p">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="k">in</span> <span class="nv">`index'
  CACHE User Load (0.0ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `</span><span class="k">index</span><span class="s1">'
  CACHE User Load (0.0ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `index'</span>
  <span class="k">CACHE</span> <span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">36</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is, therefore, unfortunately <strong>very easy</strong> to create an N+1 query. Fortunately, a gem allows us to <strong>alert</strong> when this kind of situation occurs: <a href="https://github.com/flyerhzm/bullet">Bullet</a>. Bullet will notify us (by email, <a href="http://growl.info/">growl notification</a>, <a href="https://slack.com">Slack</a>, console, etc&#8230;&#8203;) when it finds an N+1 request.</p>
</div>
<div class="paragraph">
<p>To install it, we add the <em>gem</em> to the <em>GemFile</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add bullet <span class="nt">--group</span> development</code></pre>
</div>
</div>
<div class="paragraph">
<p>And it is enough to update the configuration of our application for the development environment. In our case, we will only activate the <code>rails_logger</code> mode, which will be displayed:</p>
</div>
<div class="listingblock">
<div class="title">config/environments/development.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="k">do</span>
    <span class="no">Bullet</span><span class="p">.</span><span class="nf">enable</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="no">Bullet</span><span class="p">.</span><span class="nf">rails_logger</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the webserver and restart the last request with cURL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">--header</span> <span class="s2">"Authorization=ey..."</span> http://localhost:3000/api/v1/products</code></pre>
</div>
</div>
<div class="paragraph">
<p>And look at the Rails console. Bullet tells us that it has just detected an N+1 request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>GET /api/v1/products
USE eager loading detected
  Product =&gt; [:user]
  Add to your finder: :includes =&gt; [:user]</pre>
</div>
</div>
<div class="paragraph">
<p>He even tells us how to correct it:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">&gt; Add to your search engine</dt>
<dd>
<p>includes &#8658; [: user]</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>So we correct our error in the controller:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:user</span><span class="p">]</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">.</span><span class="nf">to_json</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go! It is now time to do our <em>commit</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add bullet to avoid N+1 query"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_activation_of_cors">Activation of CORS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this last section, I will discuss one last problem that you will probably encounter if you have to work with your API.</p>
</div>
<div class="paragraph">
<p>When you first request an external site (via an AJAX request for example), you will encounter an error of this kind:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Failed to load <a href="https://example.com/" class="bare">https://example.com/</a> No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin "https://anfo.pl" is therefore not allowed access. If an opaque response serves your needs, set the request&#8217;s mode to "no-cors" to fetch the resource with CORS disabled.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>"But what does <em>Access-Control-Allow-Origin</em> mean?". The behavior you observe is the effect of the CORS implementation of browsers. Before the CORS standardization, there was no way to call an API terminal under another domain for security reasons. This has been (and still is to some extent) blocked by the same origin policy.</p>
</div>
<div class="paragraph">
<p>CORS is a mechanism that aims to allow requests made on your behalf, and at the same time block some requests made by dishonest scripts and is triggered when you make an HTTP request to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a different field</p>
</li>
<li>
<p>a different sub-domain</p>
</li>
<li>
<p>a different port</p>
</li>
<li>
<p>a different protocol</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We must manually enable this feature so that any client can make requests on our API.</p>
</div>
<div class="paragraph">
<p>Rails allow us to do this very easily. Take a look at the <code>cors.rb</code> file located in the <code>initializers</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">config/initializers/cors.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>

<span class="c1"># Rails.application.config.middleware.insert_before 0, Rack::Cors do</span>
<span class="c1">#   allow do</span>
<span class="c1">#     origins 'example.com'</span>
<span class="c1">#</span>
<span class="c1">#     resource '*',</span>
<span class="c1">#       headers: :any,</span>
<span class="c1">#       methods: [:get, :post, :put, :patch, :delete, :options, :head]</span>
<span class="c1">#   end</span>
<span class="c1"># end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You see. It is enough to uncomment the code and modify it slightly to limit access to some actions or some HTTP verbs. In our case, this configuration is very convenient for us at the moment.</p>
</div>
<div class="listingblock">
<div class="title">config/initializers/cors.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cors</span> <span class="k">do</span>
  <span class="n">allow</span> <span class="k">do</span>
    <span class="n">origins</span> <span class="s1">'example.com'</span>
    <span class="n">resource</span> <span class="s1">'*'</span><span class="p">,</span>
      <span class="ss">headers: :any</span><span class="p">,</span>
      <span class="ss">methods: </span><span class="p">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:put</span><span class="p">,</span> <span class="ss">:patch</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:options</span><span class="p">,</span> <span class="ss">:head</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We must also install the gem <code>rack-cors</code>, which is commented in the <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add rack-cors</code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go! It is now time to make our last commit and merge our changes on the master branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Activate CORS"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_9">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you get to that point, it means you&#8217;re done with the book. Good work! You have just become a great API Rails developer, that&#8217;s for sure.</p>
</div>
<div class="paragraph">
<p>So together we have built a solid and complete API. This one has all the qualities to dethrone <a href="https://www.amazon.com/">Amazon</a>, rest assured. Thank you for going through this great adventure with me, I hope you enjoyed the trip as much as I did.</p>
</div>
<div class="paragraph">
<p>I would like to remind you that this book&#8217;s source code is available in the format <a href="https://asciidoctor.org">Asciidoctor</a> on <a href="https://github.com/asciidoctor/asciidoctor">GitHub</a>. So do not hesitate to <a href="https://github.com/madeindjs/api_on_rails/fork">fork</a> the project if you want to improve it or correct a mistake that I missed.</p>
</div>
<div class="paragraph">
<p>If you like this book, don&#8217;t hesitate to let me know by email <a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a>. I am open to any criticism, good or bad, over a good beer :).</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 6.9<br>
Last updated 2021-01-17 13:56:45 +0100
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>