<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="description" content="Learn best practice to build an API using Node.js and Typescript">
<meta name="keywords" content="Node.js, API, Javascript, Typescript, Software">
<meta name="author" content="Alexandre Rousseau">
<meta name="copyright" content="CC-BY-SA 4.0">
<title>REST-API.ts</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="book">
<div id="header">
<h1>REST-API.ts</h1>
<div class="details">
<span id="author" class="author">Alexandre Rousseau</span><br>
<span id="email" class="email"><a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a></span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2021-01-17</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#chapter00-before">Foreword</a>
<ul class="sectlevel1">
<li><a href="#_about_the_original_author">About the original author</a></li>
<li><a href="#_copyrights_and_license">Copyrights and license</a></li>
<li><a href="#_thank_you">Thank you</a></li>
</ul>
</li>
<li><a href="#chapter01-introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#_conventions_on_this_book">Conventions on this book</a></li>
<li><a href="#_development_environments">Development environments</a>
<ul class="sectlevel2">
<li><a href="#_text_editors_and_terminal">Text Editors and Terminal</a></li>
<li><a href="#_web_browser">Web browser</a></li>
<li><a href="#_package_manager">Package Manager</a></li>
<li><a href="#_git">Git</a></li>
<li><a href="#_node_js">Node.js</a></li>
</ul>
</li>
<li><a href="#_initializing_the_project">Initializing the project</a>
<ul class="sectlevel2">
<li><a href="#_version_control">Version control</a></li>
<li><a href="#_npm_initialization">NPM Initialization</a></li>
<li><a href="#_setting_up_typescript">Setting up Typescript</a></li>
</ul>
</li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter02-api">The API</a>
<ul class="sectlevel1">
<li><a href="#_planning_the_application">Planning the application</a></li>
<li><a href="#_set_up_the_api">Set up the API</a></li>
<li><a href="#_initialization_of_the_application">Initialization of the application</a>
<ul class="sectlevel2">
<li><a href="#_dependency_injection">Dependency injection</a></li>
<li><a href="#_creating_a_controller">Creating a controller</a></li>
</ul>
</li>
<li><a href="#_conclusion_2">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter03-presenting-users">Presenting users</a>
<ul class="sectlevel1">
<li><a href="#_setting_up_typeorm">Setting up TypeORM</a></li>
<li><a href="#_creating_the_user_controller">Creating the user controller</a>
<ul class="sectlevel2">
<li><a href="#_list_users">List users</a></li>
<li><a href="#_create">Create</a></li>
<li><a href="#_show">Show</a></li>
<li><a href="#_update">Update</a></li>
<li><a href="#_delete">Delete</a></li>
</ul>
</li>
<li><a href="#_validation_of_our_users">Validation of our users</a></li>
<li><a href="#_factoring">Factoring</a></li>
<li><a href="#_password_hash">Password Hash</a>
<ul class="sectlevel2">
<li><a href="#_theory">Theory</a></li>
<li><a href="#_the_implementation">The implementation</a></li>
<li><a href="#_setting_up_a_unit_test">Setting up a unit test</a></li>
</ul>
</li>
<li><a href="#_add_functional_tests">Add functional tests</a></li>
<li><a href="#_conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter04-authentication">User authentication</a>
<ul class="sectlevel1">
<li><a href="#_stateless_sessions">Stateless Sessions</a></li>
<li><a href="#_introducing_json_web_token">Introducing JSON Web Token</a></li>
<li><a href="#_setting_up_the_authentication_token">Setting up the authentication token</a></li>
<li><a href="#_the_token_controller">The token controller</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_functional_test">Setting up the functional test</a></li>
<li><a href="#_implementation">Implementation</a></li>
</ul>
</li>
<li><a href="#_user_logged_in">User logged in</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_functional_test_2">Setting up the functional test</a></li>
<li><a href="#_creating_middleware">Creating middleware</a></li>
<li><a href="#_using_the_middleware">Using the middleware</a></li>
</ul>
</li>
<li><a href="#_conclusion_4">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter05-user-products">User&#8217;s products</a>
<ul class="sectlevel1">
<li><a href="#_the_product_model">The product model</a>
<ul class="sectlevel2">
<li><a href="#_product_basics">Product basics</a></li>
<li><a href="#_product_validations">Product Validations</a></li>
</ul>
</li>
<li><a href="#_entry_point_for_our_products">Entry point for our products</a>
<ul class="sectlevel2">
<li><a href="#_product_show_action">Product Show Action</a></li>
<li><a href="#_list_of_products">List of products</a></li>
<li><a href="#_product_creation">Product creation</a></li>
<li><a href="#_product_update">Product update</a></li>
<li><a href="#_deleting_products">Deleting products</a></li>
</ul>
</li>
<li><a href="#_testing_with_curl">Testing with cURL</a></li>
<li><a href="#_conclusion_5">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter06-improve-json">Building JSON</a>
<ul class="sectlevel1">
<li><a href="#_presentation_of_jsonapi">Presentation of JSON:API</a></li>
<li><a href="#_serialize_user">Serialize user</a></li>
<li><a href="#_serialize_products">Serialize products</a>
<ul class="sectlevel2">
<li><a href="#_serialize_associations">Serialize associations</a></li>
</ul>
</li>
<li><a href="#_relationship_injection_theory">Relationship Injection Theory</a>
<ul class="sectlevel2">
<li><a href="#_embedding_in_a_meta_attribute">Embedding in a meta attribute</a></li>
<li><a href="#_incorporate_the_object_into_the_attribute">Incorporate the object into the attribute</a></li>
<li><a href="#_incorporate_relationships_into_include">Incorporate relationships into <code>include</code></a></li>
</ul>
</li>
<li><a href="#_application_of_the_relations_injection">Application of the relations injection</a>
<ul class="sectlevel2">
<li><a href="#_retrieve_the_user_of_a_product">Retrieve the user of a product</a></li>
</ul>
</li>
<li><a href="#_search_for_products">Search for products</a>
<ul class="sectlevel2">
<li><a href="#_published_products">Published products</a></li>
<li><a href="#_by_title">By title</a></li>
<li><a href="#_by_price">By price</a></li>
<li><a href="#_integration_into_the_controller">Integration into the controller</a></li>
</ul>
</li>
<li><a href="#_conclusion_6">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter07-placing-orders">Placing Orders</a>
<ul class="sectlevel1">
<li><a href="#_order_modeling">Order modeling</a>
<ul class="sectlevel2">
<li><a href="#_orders_and_products">Orders and products</a></li>
</ul>
</li>
<li><a href="#_expose_the_user_model">Expose the user model</a>
<ul class="sectlevel2">
<li><a href="#_display_a_single_order">Display a single order</a></li>
<li><a href="#_placement_and_orders">Placement and orders</a></li>
</ul>
</li>
<li><a href="#_send_a_confirmation_email">Send a confirmation email</a></li>
<li><a href="#_conclusion_7">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter08-improve_orders">Improving orders</a>
<ul class="sectlevel1">
<li><a href="#_decrease_the_quantity_of_product">Decrease the quantity of product</a>
<ul class="sectlevel2">
<li><a href="#_adding_the_product_total_attribute">Adding the <code>product.total</code> attribute</a></li>
<li><a href="#_setting_up_the_functional_test_3">Setting up the functional test</a></li>
<li><a href="#_the_subscriber">The subscriber</a></li>
<li><a href="#_update_of_the_total_stroke_of_the_order">Update of the total stroke of the order</a></li>
</ul>
</li>
<li><a href="#_conclusion_8">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter09-optimization">Optimizations</a>
<ul class="sectlevel1">
<li><a href="#_pagination">Pagination</a>
<ul class="sectlevel2">
<li><a href="#_the_products">The products</a></li>
<li><a href="#_list_of_orders">List of orders</a></li>
</ul>
</li>
<li><a href="#_caching">Caching</a></li>
<li><a href="#_activation_of_cors">Activation of CORS</a></li>
<li><a href="#_conclusion_9">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="chapter00-before" class="sect0">Foreword</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>"REST-API.ts" is an adaptation of my previous book <a href="https://leanpub.com/apionrails6">API on Rails</a> in which I built an API with the Ruby on Rails framework. This book is one of my nice Open-Source experience since the book is very active and has <a href="https://github.com/madeindjs/api_on_rails/graphs/contributors">has several contributors</a> (which I thank again here). I also had much positive feedback. So I decided to retry the experience with different technologies than Ruby on Rails, which I appreciate a lot.</p>
</div>
<div class="paragraph">
<p>So I hope this book will be alive and evolving following the best practices of the moment. I also want it to be an entry point for beginners, as other resources were for me when I started developing.</p>
</div>
<div class="paragraph">
<p>So this book is naturally Open-Source and freely available <a href="https://github.com/madeindjs/rest-api.ts">on Github</a>. You will find the PDF, EPUB versions, and also the sources in <a href="https://asciidoctor.org">Asciidoctor</a> format. A paid version is available on <a href="https://leanpub.com/rest-api-ts">leanpub</a> if you want to contribute to the project. Of course, this is not the only way to do it. You can also propose improvements by <a href="https://github.com/madeindjs/rest-api.ts/fork">forking</a> the project, talk about this book around you or thank me by mail <a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_the_original_author">About the original author</h2>
<div class="sectionbody">
<div class="paragraph">
<p>My name is <a href="https://rsseau.fr">Alexandre Rousseau</a>, and I am a passionate developer. I like to share my experience through <a href="https://rsseau.fr/blog/">my blog</a> and some books like <a href="https://leanpub.com/apionrails6">API on Rails</a> or even this one.</p>
</div>
<div class="paragraph">
<p>I am currently a partner at <a href="https://isignif.fr/">iSignif</a>, where I build and maintain a SAAS-like product using <a href="https://rubyonrails.org">Ruby on Rails</a>. I also contribute to the Ruby community by producing and now some gems that you can see on <a href="https://rubygems.org/profiles/madeindjs">my Rubygem profile</a>. Most of my projects are on GitHub, so don&#8217;t hesitate to visit <a href="https://github.com/madeindjs">follow me</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_copyrights_and_license">Copyrights and license</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"REST-API.ts" from <a href="https://rsseau.fr">Alexandre Rousseau</a> is made available under the terms of the license <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution - Share Alike 4.0 International</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thank_you">Thank you</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many thanks to <a href="https://github.com/madeindjs/rest-api.ts/graphs/contributors">all API on Rails contributors</a>, to all those who supported the project at <a href="https://leanpub.com/rest-api-ts">buying a paid version of this book</a> and to <a href="https://github.com/madeindjs/rest-api.ts/graphs/contributors">all API on Rails contributors</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter01-introduction" class="sect0">Introduction</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Welcome to API-REST.ts, a steroid tutorial to learn the best way to build your next application with Typescript. The purpose of this book is to provide you with a complete methodology to develop a RESTful API following best practices.</p>
</div>
<div class="paragraph">
<p>When you are finished with this book, you will create your own API and integrate it with any client, such as a web browser or mobile application. The generated code is built with Typescript 4, which is the current version.</p>
</div>
<div class="paragraph">
<p>This book intends not only to teach you how to build an API but rather to teach you how to build a scalable and maintainable API with Typescript. In this journey, you will learn how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using Git for version control</p>
</li>
<li>
<p>Building JSON responses</p>
</li>
<li>
<p>use test-driven development</p>
</li>
<li>
<p>Test your entry points with functional tests</p>
</li>
<li>
<p>Set up authentication with JSON Web Tokens (JWT)</p>
</li>
<li>
<p>Use JSON:API specifications</p>
</li>
<li>
<p>Optimize your application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I strongly recommend that you follow all the steps in this book. Try not to skip any chapters, as I will give you tips and tricks to improve yourself throughout the book. You can think of yourself as the main character in a video game that gets a higher level with each chapter.</p>
</div>
<div class="paragraph">
<p>In this first chapter, I will explain how to configure your environment (if you haven&#8217;t already done so). We will then create an application called <code>market_place</code>. I will make sure to teach you the best practices I have learned from my experience. This means that after initializing the project, we will start using Git.</p>
</div>
<div class="paragraph">
<p>In next chapters, we will build the application using test-driven development (TDD) workflow. I will also explain the interest in using an API for your next project and choosing a suitable response format such as JSON or XML. Later on, we will get our hands on the code and complete the application&#8217;s basics by building all the necessary endpoints. We will also secure access to the API by building authentication through HTTP header exchange. Finally, in the last chapter, we will add some optimization techniques to improve the server&#8217;s structure and response times.</p>
</div>
<div class="paragraph">
<p>The final application will be a marketplace application that will allow sellers to set up their own online store. Users will be able to place orders, download products, and more. There are many options to create an online store, such as <a href="http://shopify.com/">Shopify</a>, <a href="http://spreecommerce.com/">Spree</a>, or <a href="http://magento.com/">Magento</a>.</p>
</div>
<div class="paragraph">
<p>Throughout this journey (it depends on your expertise), you will improve and better understand how modern frameworks work. I have also taken some of the practices from my experience as a developer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conventions_on_this_book">Conventions on this book</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The conventions in this book are based on those in <a href="https://www.railstutorial.org/book">Ruby on Rails Tutorial</a>. In this section, I will mention a few that you may not be familiar with.</p>
</div>
<div class="paragraph">
<p>I will use many examples using command line. I&#8217;m not going to deal with Windows <code>cmd</code> (sorry, guys). I&#8217;m going to base all the examples using the Unix-style command line prompt. Here is an example:</p>
</div>
<div class="listingblock">
<div class="title">An example of a UNIX command</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"A command-line command"</span>
A command-line <span class="nb">command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I will try to shorten the code pieces as much as possible, keeping only interesting lines depending on the context. I&#8217;ll hide irrelevant lines with the comment symbol <code>// &#8230;&#8203;</code> or <code>/* &#8230;&#8203; */</code>. At the beginning of each piece of code, I will also specify the path and the name of the file concerned. Here is an example.</p>
</div>
<div class="listingblock">
<div class="title">An example of a Typescript block code</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// user.ts</span>
<span class="c1">// ...</span>
<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">doInterestingStuff</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="nx">doInterestingStuff</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, I will use some terms like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>"Avoid"</em> means you&#8217;re not supposed to.</p>
</li>
<li>
<p><em>"Prefer"</em> indicates that the first is the most appropriate of the two options.</p>
</li>
<li>
<p><em>"Use"</em> means that you can use the resource.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you encounter any error while executing a command, I recommend using your search engine to find your solution. Unfortunately, I cannot cover all possible errors. If you encounter any problems with this tutorial, you can always <a href="mailto:contact@rousseau-alexandre.fr">send me an email</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development_environments">Development environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For almost all developers, one of the most painful parts is setting up a comfortable development environment. If you do it right, the next steps should be a breeze. I will guide you through this step to make it easier and more motivating.</p>
</div>
<div class="sect2">
<h3 id="_text_editors_and_terminal">Text Editors and Terminal</h3>
<div class="paragraph">
<p>There are two categories of code editors :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <strong>text editors</strong> like <a href="https://atom.io/">Atom</a>, <a href="https://www.sublimetext.com/">Sublime Text</a>, <a href="https://www.vim.org/">VIM</a> and many others.</p>
</li>
<li>
<p>the complete <strong>development environments</strong> like <a href="https://www.eclipse.org/">Eclipse</a>, <a href="https://netbeans.org/">Netbeans</a>, <a href="https://www.jetbrains.com/fr-fr/webstorm/">Webstorm</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Development environments are more complete and offer more features but are often much heavier.</p>
</div>
<div class="paragraph">
<p>There is no bad choice, and it&#8217;s really a matter of taste.</p>
</div>
<div class="paragraph">
<p>I use <a href="https://code.visualstudio.com/">Visual Studio Code</a> from Microsoft, which is at the crossroads between a text editor and a development environment. Its auto-completion is really very powerful when using <a href="https://www.typescriptlang.org/">Typescript</a>. If you don&#8217;t know what to use, you can&#8217;t go wrong by using this editor.</p>
</div>
</div>
<div class="sect2">
<h3 id="_web_browser">Web browser</h3>
<div class="paragraph">
<p>As for the browser, I will advise directly <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a>. But other developers use <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or even <a href="https://www.apple.com/safari/">Safari</a>. Any of them will help you build the application you want. They all offer a good inspector for the DOM, a network analyzer, and many other features you may already be familiar with.</p>
</div>
<div class="paragraph">
<p>However, I advise you to use at least two web browsers. There are some differences in the interpretation of Javascript or CSS. By using two browsers, you make sure that your developments work correctly for most of your users.</p>
</div>
<div class="paragraph">
<p>Personally, I use Firefox in everyday life, and I check the proper functioning of my features on <a href="https://www.chromium.org/">Chromium</a>, a derivative of Google Chrome.</p>
</div>
</div>
<div class="sect2">
<h3 id="_package_manager">Package Manager</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Mac OS</strong>: There are many options to manage how you install packages on your Mac, such as <a href="https://www.macports.org/">Mac Ports</a> or <a href="http://brew.sh/">Homebrew</a>. Both are good options, but I would choose the latter. I&#8217;ve had fewer problems installing software with Homebrew. To install <code>brew</code>, just run the command below:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Install Homebrew</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Linux</strong>: You&#8217;re already ready! It doesn&#8217;t matter if you use <code>apt</code>, <code>pacman</code>, <code>yum</code> as long as you feel comfortable and know how to install packages.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_git">Git</h3>
<div class="paragraph">
<p>We will use Git a lot, and you should use it too (not only for this tutorial but for all your projects). It&#8217;s straightforward to install it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>under Mac OS: <code>$ brew install git</code>.</p>
</li>
<li>
<p>under Linux: <code>$ sudo apt-get install git</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_node_js">Node.js</h3>
<div class="paragraph">
<p>There are many ways to install and manage Node.js. You may even already have a version installed on your system. To find out, just type:</p>
</div>
<div class="listingblock">
<div class="title">Get node.js version</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>node <span class="nt">-v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you haven&#8217;t installed it, you can do it with your package manager. However, I recommend that you use <a href="https://github.com/nvm-sh/nvm">Node Version Manager (NVM)</a>. The principle of this tool is to allow you to install several versions of Node.js on the same machine, in an environment sealed to a possible version installed on your operating system, and to be able to switch from one to the other easily.</p>
</div>
<div class="paragraph">
<p>To install it, go to <a href="https://github.com/nvm-sh/nvm#installing-and-updating">follow the official documentation</a>. You have to launch the following script :</p>
</div>
<div class="listingblock">
<div class="title">Install NVM</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-o-</span> https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.0/install.sh | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>The URL of the script may vary depending on the current version.</p>
</div>
<div class="paragraph">
<p>Once the installation is complete, you can install the latest version of Node.js with the following command:</p>
</div>
<div class="listingblock">
<div class="title">Install node.js using NVM</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>nvm <span class="nb">install </span>node</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_database">Database</h4>
<div class="paragraph">
<p>I strongly recommend that you install <a href="http://www.postgresql.org/">PostgreSQL</a> to manage your databases. But here, for simplicity, we will use <a href="http://www.sqlite.org/">SQLite</a>. If you are using Mac OS you don&#8217;t have any additional libraries to install. If you are using Linux, don&#8217;t worry, I&#8217;ll guide you:</p>
</div>
<div class="listingblock">
<div class="title">Install SQlite dependencies for Debian based Linux distribution</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>libxslt-dev libxml2-dev libsqlite3-dev</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initializing_the_project">Initializing the project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In my opinion, this is one of the most interesting parts because you will discover a way of doing things that is certainly different from yours.</p>
</div>
<div class="paragraph">
<p>There is a ton of complete frameworks like <a href="https://nestjs.com/">Nest.js</a>, which is really great. But here, we&#8217;re going to start from scratch using some prevalent libraries to master our application.</p>
</div>
<div class="paragraph">
<p>This method will also allow you to adapt and build the architecture that suits you best. Keep in mind that the architecture I&#8217;m going to present to you is the one I like. It is totally personal, and I don&#8217;t pretend that it is the best. Always keep a critical mind.</p>
</div>
<div class="paragraph">
<p>Are you ready? Here we go!</p>
</div>
<div class="paragraph">
<p>Go to the folder of your choice and create a new folder:</p>
</div>
<div class="listingblock">
<div class="title">Create folder for new project</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>node_market_place
<span class="nv">$ </span><span class="nb">cd </span>node_market_place</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_version_control">Version control</h3>
<div class="paragraph">
<p>Remember that Git helps you track and maintain your code history. Version all your projects. Even if it&#8217;s a small project.</p>
</div>
<div class="paragraph">
<p>Initializing Git in your project is as simple as the following command:</p>
</div>
<div class="listingblock">
<div class="title">Initialize Git</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git init</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, you need to configure the committer&#8217;s information. If it is not already done, go to the directory and run the following commands:</p>
</div>
<div class="listingblock">
<div class="title">Set basic Git configuration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git config user.name <span class="s2">"John Doe"</span>
<span class="nv">$ </span>git config user.email <span class="s2">"john@doe.io"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Let&#8217;s move on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_npm_initialization">NPM Initialization</h3>
<div class="paragraph">
<p>NPM is the official package manager of Node.js. Since version 0.6.3 of Node.js, NPM is part of the environment and is automatically installed by default.</p>
</div>
<div class="paragraph">
<p>Initializing your project with Node.js means that you will be able to install any library published on <a href="https://www.npmjs.com/">npmjs.com</a>.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s initialize NPM in our :</p>
</div>
<div class="listingblock">
<div class="title">Initialize NPM</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm init</code></pre>
</div>
</div>
<div class="paragraph">
<p>Several questions will be asked, and in the end, you will see a new <code>package.json</code> file. This file details the information about your project and its dependencies.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_typescript">Setting up Typescript</h3>
<div class="paragraph">
<p>Now that we have initialize Node.js project, we are ready to implement Typescript.</p>
</div>
<div class="paragraph">
<p>Typescript will bring us strong typing and will perform checks before <em>transpiling</em> Typescript code to Javascript :</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We talk about a <strong>compiler</strong> for compiling a program into an executable and a <strong>transpilation</strong> for converting a program from one language to another language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Therefore, we install Typescript as a development dependency because it will only be used to transpile our code. It will be Node.js, which will execute the Javascript later :</p>
</div>
<div class="listingblock">
<div class="title">Install Typescript for project</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add typescript @types/node <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have added two libraries :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>typescript</code>, which will give us the tools for <strong>transpilation</strong>.</p>
</li>
<li>
<p><code>@types/node</code> which will add the definition of the types of Node.js</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So let&#8217;s add our first Typescript file :</p>
</div>
<div class="listingblock">
<div class="title">Our first typescript code</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="kd">function</span> <span class="nx">say</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`I said: </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">say</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello</span><span class="dl">"</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code is really basic and will just be used to check that the transpilation works.</p>
</div>
<div class="paragraph">
<p>To use Typescript transpilation, we need to define a configuration file <code>tsconfig.json</code>. Here is a basic one:</p>
</div>
<div class="listingblock">
<div class="title">Basic Typescript configuration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"compilerOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rootDir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"outDir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dist"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"module"</span><span class="p">:</span><span class="w"> </span><span class="s2">"commonjs"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"types"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"node"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"es6"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"esModuleInterop"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"lib"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"es6"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"moduleResolution"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"experimentalDecorators"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"emitDecoratorMetadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s much code but the two directives to remember here are: <code>rootDir</code> and <code>outDir</code>. They will specify where the Typescript files are (<code>rootDir</code>) and where the Javascript files resulting from the transpilation are (<code>outDir</code>).</p>
</div>
<div class="paragraph">
<p>In our case, I put all the Typescript files in the <code>src</code> folder and the result of the transpilation in <code>dist</code>.</p>
</div>
<div class="paragraph">
<p>From here, you can test that everything works by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>./node_modules/.bin/tsc</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see a <code>dist/main.js</code> file of the following form.</p>
</div>
<div class="listingblock">
<div class="title">Transpilation of our first Typescript code</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="javascript"><span class="c1">// dist/main.js</span>
<span class="kd">function</span> <span class="nx">say</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`I said: </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">say</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello</span><span class="dl">"</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the transposed version of our Typescript file.</p>
</div>
<div class="paragraph">
<p>Now that we&#8217;ve seen that everything works, we can automate this a bit by adding the commands directly into the <code>package.json</code> file:</p>
</div>
<div class="listingblock">
<div class="title">Create NPM <code>start</code> script</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc &amp;&amp; node dist/main.js"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So now you can execute the script with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm run start</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that everything is working, it&#8217;s time to version our changes. Don&#8217;t add all the created files. It&#8217;s important only to version some folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>node_modules</code> folder contains the libraries retrieved using NPM, and it will be changed when updating these libraries.</p>
</li>
<li>
<p>the <code>dist</code> folder because it results from the transpilation of our code</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To ignore them, create a <code>.gitignore</code> file with the following content :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>node_modules
dist</pre>
</div>
</div>
<div class="paragraph">
<p>We can now add all our files with Git and commit :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Setup Typescript for backend"</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_hot_reload_with_nodemon">Setting up Hot Reload with Nodemon</h4>
<div class="paragraph">
<p>It&#8217;s nice to have a Hot Reload feature in the development phase. This means that our program will transpilate itself again and run every time our code changes.</p>
</div>
<div class="paragraph">
<p>The <code>Nodemon</code> library will provide us with this feature. Let&#8217;s add it :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add nodemon <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you have to define a <code>nodemon.json</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"watch"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"src"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"ext"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ignore"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"src/**/*.spec.ts"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"exec"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npm run start"</span><span class="err">.</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A few explanations are necessary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>watch</code> specifies the directory in which Nodemon will watch for file changes</p>
</li>
<li>
<p><code>ignore</code> allows to avoid Hot Reload for certain types of files (here are the tests we will see later)</p>
</li>
<li>
<p><code>exec</code>, the command to be executed at each change</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s check that everything works by running Nodemon by hand:</p>
</div>
<div class="listingblock">
<div class="title">Start nodemon</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>./node_modules/.bin/nodemon
<span class="o">[</span>nodemon] 2.0.6
<span class="o">[</span>nodemon] to restart at any <span class="nb">time</span>, enter <span class="sb">`</span>rs<span class="sb">`</span>
<span class="o">[</span>nodemon] watching path<span class="o">(</span>s<span class="o">)</span>: src/<span class="k">**</span>/<span class="k">*</span>
<span class="o">[</span>nodemon] watching extensions: ts
<span class="o">[</span>nodemon] starting <span class="sb">`</span>npm run start<span class="sb">`</span>
I said: Hello
<span class="o">[</span>nodemon] clean <span class="nb">exit</span> - waiting <span class="k">for </span>changes before restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our code has been transpilated and executed, and we can see that Nodemon is still running and waiting for a change. So let&#8217;s change our <code>main.ts</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">[</span>nodemon] restarting due to changes...
<span class="o">[</span>nodemon] starting <span class="sb">`</span>npm run start<span class="sb">`</span>
Nodemon said: Hello
<span class="o">[</span>nodemon] clean <span class="nb">exit</span> - waiting <span class="k">for </span>changes before restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that everything works, we can modify the <code>package.json</code> file and add the command <code>nodemon</code>:</p>
</div>
<div class="listingblock">
<div class="title">Create <code>start:watch</code> NPM script</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc &amp;&amp; node dist/main.js"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start:watch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nodemon"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Setup Nodemon"</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_the_web_server">Setting up the web server</h4>
<div class="paragraph">
<p>So far, we have set up an environment that will allow us to avoid syntax and typing errors automatically with Typescript. It&#8217;s time to make a real feature: the web server.</p>
</div>
<div class="paragraph">
<p>There are several libraries to make a web server with Node.js. In my case, I recommend <a href="https://expressjs.com/fr/">Express.js</a> simply because it&#8217;s the one with a bigger community, and it offers basic features. It also gives you the freedom to organize your code the way you want and offers a ton of plugins to add features on top of it.</p>
</div>
<div class="paragraph">
<p>Adding it is very easy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add express <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will also add the Typescript typings that will help your code editor a little bit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add @types/express <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can instantiate our server in the file <code>main.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Create Express HTTP server</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="k">import</span> <span class="nx">express</span><span class="p">,</span> <span class="p">{</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello World!</span><span class="dl">"</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`listen on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can start the server with Nodemon (if it is not already done) with <code>npm run start:watch</code>, and you will get the following result :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>nodemon] restarting due to changes...
[nodemon] starting `npm run start`.
Server listen on http://localhost:3000/</pre>
</div>
</div>
<div class="paragraph">
<p>So you can open your browser at <a href="http://localhost:3000" class="bare">http://localhost:3000</a> and see that everything works. Here is the result here using <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000
Hello World!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that everything is working, let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add express.js server"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It has been quite a long chapter. If you have arrived here, allow me to congratulate you. Things will get better from this point on. Let&#8217;s start getting our hands on the code!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter02-api" class="sect0">The API</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In this chapter, I will give you an overview of the application. You should have read the previous chapter. If you haven&#8217;t, I recommend you do so.</p>
</div>
<div class="paragraph">
<p>To summarize, we simply generated our Node.js application, setup Typescript, and performed our first commit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_planning_the_application">Planning the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our application will be quite simple. It will consist of five models. Don&#8217;t worry if you don&#8217;t understand what&#8217;s going on. We will review and develop each of these resources as we move forward with the tutorial.</p>
</div>
<div class="listingblock">
<div class="title">Diagram of Market Place API models</div>
<div class="content">
<pre>+---------+     +---------+
| User    +----&gt;+Product  |
+---------+     +---------+
     |               |
     v               v
+---------+     +---------+
|Order    +----&gt;+Placement|
+---------+     +---------+</pre>
</div>
</div>
<div class="paragraph">
<p>In short, we have the <code>User</code> who will be able to create <code>Product</code>. He also make an <code>Order</code> who link multiples <code>Product`s into a `Placement</code>.</p>
</div>
<div class="paragraph">
<p>We are not going to build an interface for interaction with the API to not overload the tutorial. If you want to build views, there are many options, such as JavaScript frameworks (<a href="https://angularjs.org/">Angular</a>, <a href="https://vuejs.org/">Vue.JS</a>, <a href="https://reactjs.org/">React</a>) or mobile libraries (<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>).</p>
</div>
<div class="paragraph">
<p>At this stage, you should ask yourself this question:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Okay, but I need to explore and visualize the API I&#8217;m going to build, right?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>That&#8217;s right. If you <em>google</em> something related to exploring an API, you&#8217;ll find many results. For example, you can use <a href="https://www.getpostman.com/">Postman</a>, which has become a must-have. But we&#8217;re not going to use it. In our case, we will use <strong>cURL</strong>, which is a command line tool available almost everywhere. This will allow us to have reproductible commands whatever your development environment.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_up_the_api">Set up the API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An API is defined by <a href="https://fr.wikipedia.org/wiki/Interface_de_programmation">wikipedia</a> as <em>an Application Programming Interface (API) standardized set of components that serves as a front end through which one software provides services to other software</em>. In other words, it is a way in which systems interact with each other via an interface (in our case, a web service built with JSON). There are other communication protocols, such as SOAP, but we are not talking about them here.</p>
</div>
<div class="paragraph">
<p>JSON has become a must as a file format for the Internet because of its readability, scalability, and ease of implementation. Many JavaScript frameworks use it as a default protocol, such as <a href="https://angularjs.org/">Angular</a> or <a href="http://emberjs.com/">EmberJS</a>. Other large Objective-C libraries use it like <a href="https://github.com/AFNetworking/AFNetworking" class="bare">https://github.com/AFNetworking/AFNetworking</a> [AFNetworking] or <a href="http://restkit.org/">RESTKit</a>. There are probably good solutions for Android, but I can&#8217;t recommend anything due to my lack of experience on this development platform.</p>
</div>
<div class="paragraph">
<p>So we will use the JSON format to build our API. The first idea that might come to your mind would be to start creating bulk routes. The problem is that they wouldn&#8217;t be standardized. A user wouldn&#8217;t be able to guess what resource is returned by an endpoint.</p>
</div>
<div class="paragraph">
<p>That&#8217;s why a standard exists: <strong>REST</strong> <em>(Representational State Transfer)</em>. REST imposes a standard for routes that create, read, update, or delete information on a server using simple HTTP calls. It is an alternative to more complex mechanisms such as SOAP, CORBA, and RPC. A REST call is simply an HTTP GET request to the server.</p>
</div>
<div class="paragraph">
<p>And with REST, you can call a URL with a specific HTTP request. In this case, with a GET request:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>http://domain.com/resources_name/uri_pattern</pre>
</div>
</div>
<div class="paragraph">
<p>The <em>RESTful</em> APIs must follow at least three rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A basic URI like <a href="http://example.com/resources/" class="bare">http://example.com/resources/</a></p>
</li>
<li>
<p>A mime type to represent data is commonly JSON and is commonly defined by the exchange of headers.</p>
</li>
<li>
<p>Follow standard <a href="https://fr.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> methods such as GET, POST, PUT, DELETE.</p>
</li>
<li>
<p><strong>GET</strong>: Reads the resource(s) defined by the URI model.</p>
</li>
<li>
<p><strong>POST</strong>: Creates a new entry in the resource collection</p>
</li>
<li>
<p><strong>PUT</strong>: Update a collection or resource member</p>
</li>
<li>
<p><strong>DELETE</strong>: Destroys a collection or a member of the resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This may sound complicated, but it will become much easier to understand as we go through the tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initialization_of_the_application">Initialization of the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we know what conventions we&#8217;re going to follow, we can start building our application&#8217;s architecture. Therefore, we will continue to set up Typescript and certain libraries, which will help us respect best practices in terms of software development.</p>
</div>
<div class="sect2">
<h3 id="_dependency_injection">Dependency injection</h3>
<div class="paragraph">
<p>In this section, we will set up the <strong>dependency injection</strong> system. If you have never heard of it, this is probably the most abstract part of this chapter.</p>
</div>
<div class="paragraph">
<p>Here I will try to summarize what dependency injection is and what it is used for. Let&#8217;s imagine a <code>User</code> class that needs a <code>Database</code> class to be saved. We would try to initialize the database connection in the user&#8217;s constructor:</p>
</div>
<div class="listingblock">
<div class="title">An example of bad design</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">time</span><span class="p">}</span><span class="s2"> -- </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do some stuff here</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">Database</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">databaseString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">databaseString</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="dl">'</span><span class="s1">john@doe.io</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./user.sqlite</span><span class="dl">'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This causes several problems:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>User</code> class depends on the <code>Database</code> class. If you change the implementation of the <code>Database</code> class, you will have to change the <code>User</code> class.</p>
</li>
<li>
<p>the code is much less testable because to test a user, I need to know how <code>User</code> class works.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To accentuate the problem, let&#8217;s add a <code>Logger</code> class that allows you to log events in the app. Let&#8217;s say we need to log the database connection. The code becomes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">time</span><span class="p">}</span><span class="s2"> -- </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">();</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Connected to </span><span class="p">${</span><span class="nx">connectionString</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">Database</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">databaseString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">databaseString</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="dl">'</span><span class="s1">john@doe.io</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./user.sqlite</span><span class="dl">'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that the situation is getting worse because all classes are becoming dependent on each other. To correct this, we are going to inject the <code>Database</code> class directly into the <code>User</code> constructor:</p>
</div>
<div class="listingblock">
<div class="title">The <code>Database</code> class is now injected in the constructor.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">,</span> <span class="nx">connectionString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Connected to </span><span class="p">${</span><span class="nx">connectionString</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">Database</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="dl">"</span><span class="s2">db.sqlite</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">database</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code becomes stronger because the <code>User</code>, <code>Database</code>, and <code>Logger</code> classes are decoupled.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>OK, but it becomes harder to instantiate a <code>User</code>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Yes, it does. That&#8217;s why we use a <code>Container</code> that will record the classes that can be injected and offer us to create instances easily:</p>
</div>
<div class="listingblock">
<div class="title">An example of a container used to instantiate classes</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>

<span class="kd">class</span> <span class="nx">Container</span> <span class="p">{</span>
  <span class="nx">getLogger</span><span class="p">():</span> <span class="nx">Logger</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">getDatabase</span><span class="p">():</span> <span class="nx">Database</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getLogger</span><span class="p">(),</span> <span class="dl">"</span><span class="s2">db.sqlite</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">getUser</span><span class="p">():</span> <span class="nx">User</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">getUser</span><span class="p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is longer, but everything gets cut out. Rest assured, we are not going to implement all this by hand. Excellent libraries exist. The one I chose is <a href="https://github.com/inversify/InversifyJS">Inversify</a>.</p>
</div>
<div class="paragraph">
<p>In this section, we are going to concretely implement a complete dependency injection system.</p>
</div>
<div class="paragraph">
<p>We will set up a Logger that can be injected into all classes of our application. It will allow us to handle HTTP requests, for example, but also many other events.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s install <code>inversify</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>inversify <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s create a simple event logging class:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We could use a library like <a href="https://github.com/winstonjs/winston">Winston</a> or <a href="https://www.npmjs.com/package/morgan">Morgan</a>, but for the example, I will create a fairly basic class:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Create a basic logger</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/logger.service.ts</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">log</span><span class="p">(</span><span class="nx">level</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DEBUG</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">INFO</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">ERROR</span><span class="dl">'</span><span class="p">,</span> <span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">time</span><span class="p">}</span><span class="s2"> - </span><span class="p">${</span><span class="nx">level</span><span class="p">}</span><span class="s2"> - </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it injectable, you need to add a <code>@injectable</code> decorator to it. This decorator will simply <a href="https://github.com/inversify/InversifyJS/blob/master/src/annotation/injectable.ts#L12">add metadata</a> to our class so that it can be injected into our future dependencies.</p>
</div>
<div class="listingblock">
<div class="title">Make <code>Logger</code> injectable</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Now we just have to create the container that will register this service. <a href="https://github.com/inversify/InversifyJS#installation">The documentation</a> recommends creating a <code>TYPES</code> object that will simply store the identifiers of our services. We will create a <code>core</code> folder that will contain all the code that is transversal to our entire application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="na">Logger</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">'</span><span class="s1">Logger</span><span class="dl">'</span><span class="p">)};</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol"><code>Symbol</code></a> is a primitive type that allows you to have a unique reference.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can use this symbol to save our logger in a new <code>container.core.ts</code> file. Just instantiate a <code>Container</code> and add our service with the <code>bind()</code> method. We then export this instance for use in the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Logger</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/logger.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./types.core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">Logger</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_controller">Creating a controller</h3>
<div class="paragraph">
<p>Let&#8217;s leave aside this class that we will use later in our first controller. Controllers are part of the <em>design patern</em> <strong>MVC: Model, View, Controller</strong>. Their purpose is to intercept the request and call the dedicated services. There is an official Inversify library to integrate dependency injection directly into our controllers: <a href="https://github.com/inversify/inversify-express-utils"><code>inverisfy-express-utils</code></a>.</p>
</div>
<div class="paragraph">
<p>We start by installing the library. We&#8217;ll also add <code>body-parser</code>, which will allow us to process the HTTP request parameters (we&#8217;ll talk about this later).</p>
</div>
<div class="paragraph">
<p>To install it, it&#8217;s straightforward. Just follow the <a href="https://github.com/inversify/inversify-express-utils">official documentation</a>. So we start by installing some libraries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>inversify-express-utils reflect-metadata body-parse <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>reflet-metadata</code> allows Inversify to add metadata on our class. This import must be located at the very beginning of the first file.</p>
</li>
<li>
<p><code>body-parse</code> will give us the possibility to extract parameters from HTTP requests (we&#8217;ll talk about it later).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before writing our first controller, it is necessary to make some modifications to the creation of our HTTP server. Let&#8217;s create a new file <code>core/server.core.ts</code>, which will simply define our HTTP server with <code>inversify-express-utils</code>:</p>
</div>
<div class="listingblock">
<div class="title">The definition of our HTTP server with <code>inversify-express-utils</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/server.ts</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">bodyParser</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">InversifyExpressServer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./container.core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InversifyExpressServer</span><span class="p">(</span><span class="nx">container</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">setConfig</span><span class="p">(</span><span class="nx">app</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="na">extended</span><span class="p">:</span> <span class="kc">true</span><span class="p">}));</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we are now using an instance of <code>InversifyExpressServer</code>. The <code>setConfig</code> method allows you to add <em>middleware</em> (we&#8217;ll return to this later). Let&#8217;s move on to the <code>main.ts</code> file, which we&#8217;ll modify a bit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">reflect-metadata</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">server</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./core/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./core/types.core</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="nx">server</span>
  <span class="p">.</span><span class="nx">build</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Listen on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Now we can tackle our first controller.</p>
</div>
<div class="paragraph">
<p>The controller is a class like any other. It simply goes to the <code>@controller</code> decorator. This decorator will also declare this controller as <code>@injectable</code> but also offer us special features.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go straight to the implementation to make it more meaningful:</p>
</div>
<div class="listingblock">
<div class="title">Creating the first controller with a single route</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">httpGet</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HomeController</span> <span class="p">{</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">''</span><span class="p">)</span>
  <span class="k">public</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello world</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the implementation is obvious, thanks to the decorators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>@controller("/")</code> tells us that all the routes of this controller will be prefixed with <code>/</code>.</p>
</li>
<li>
<p>The second decorator <code>@httpGet("/")</code> defines that this method will be accessible on the URL <code>/</code> via the HTTP POST verb.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now let&#8217;s try to inject the <code>Logger</code> to display a message when this route is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Logger</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/logger.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HomeController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">)</span> <span class="p">{}</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">''</span><span class="p">)</span>
  <span class="k">public</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">INFO</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Get Home.index</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello world</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go!</p>
</div>
<div class="paragraph">
<p>The <code>@inject</code> decorator takes care of everything. Just specify the symbol. It&#8217;s magic.</p>
</div>
<div class="paragraph">
<p>The last step is to manually import this controller into the container. It&#8217;s really very easy to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">../controllers/home.controller</span><span class="dl">'</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now start the server with <code>npm run start</code> or wait for the transpilation to be done automatically if you have not stopped the previous server.</p>
</div>
<div class="paragraph">
<p>If everything works as before, you can commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add inversify"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_2">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It took a bit long, I know, but you did it! Don&#8217;t give up. It&#8217;s just our little foundation for something big, so keep going.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter03-presenting-users" class="sect0">Presenting users</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapter, we managed to set up the basics for the configuration of our application. This chapter will perfect this base and add the <em>Model</em> layer, which will store the data and add the first tests.</p>
</div>
<div class="paragraph">
<p>In the next chapters, we will deal with user authentication using authentication tokens and defining permissions to limit access to connected users. We will then link products to users and give them the ability to place orders.</p>
</div>
<div class="paragraph">
<p>As you can already imagine, there are many authentication solutions for Node.js, such as <a href="http://www.passportjs.org/">Passport.js</a>, <a href="https://github.com/ianstormtaylor/permit">Permit</a>, and <a href="https://github.com/simov/grant">Currency</a>. These solutions are turnkey libraries, meaning that they allow you to manage many things like authentication, password forgetting functionality, validation, etc.</p>
</div>
<div class="paragraph">
<p>We won&#8217;t use them to better understand the authentication mechanism. This will allow you to discover nothing magic behind password encryption and the creation of authentication tokens.</p>
</div>
<div class="paragraph">
<p>This chapter will be complete. It may be long, but I will try to cover as many topics as possible. Feel free to grab a coffee, and let&#8217;s go. By the end of this chapter, you will have built all the user logic, validation, and error handling.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_typeorm">Setting up TypeORM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here we will put the <em>Model</em> layer of the <em>design patern</em> MVC. This is the layer related to the database.</p>
</div>
<div class="paragraph">
<p>To access the database, we will use an ORM (Object Relational Mapper). The purpose of an ORM is to interact with the database and save you from writing SQL queries by hand. It also allows us to add an abstraction layer to the database type and not worry about the differences between PostgreSQL and SQLite, for example.</p>
</div>
<div class="paragraph">
<p>There are several ORMs for Nodejs: <a href="https://sequelize.org/">Sequelize</a>, <a href="https://mongoosejs.com/">Mongoose</a> and <a href="https://typeorm.io/">TypeORM</a>. I chose the last one because it is the one that integrates best with Typescript. It also offers a <a href="https://typeorm.io/#/active-record-data-mapper">Active Record AND Data Mapper</a> approach that I like very much.</p>
</div>
<div class="paragraph">
<p>To install it is straightforward. We are going to install the TypeORM library but also two additional libraries :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sqlite3</code> which will allow us to dialogue with our Sqlite database.</p>
</li>
<li>
<p><a href="https://www.npmjs.com/package/dotenv"><code>dotenv</code></a> will allow us to start defining <strong>environment variables</strong> such as the connection to our database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here we go:</p>
</div>
<div class="listingblock">
<div class="title">Adding libraries to install TypeORM</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add typeorm sqlite3 dotenv <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will now generate our configuration file. By default, <code>dotenv</code> will look for a file named <code>.env</code>. Let&#8217;s create it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">touch</span> .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s start by defining <a href="https://github.com/typeorm/typeorm/blob/master/docs/using-ormconfig.md#using-environment-variables">TypeORM environment variables</a> for a basic connection to an SQLite database:</p>
</div>
<div class="listingblock">
<div class="title">The basic configuration of TypeORM for a connection to SQLite</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="env">TYPEORM_CONNECTION=sqlite
TYPEORM_DATABASE=db/development.sqlite
TYPEORM_LOGGING=true
TYPEORM_SYNCHRONIZE=true
TYPEORM_ENTITIES=src/entities/*.entity.ts,dist/entities/*.entity.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we define that we will use SQLite and that the database will be stored in the <code>db/</code> folder. <code>TYPEORM_SYNCHRONIZE</code> allows us to avoid not worrying about migrations and so let TypeORM do the modifications on our database schema if necessary. We then specify where our entities are located with <code>TYPEORM_ENTITIES</code>.</p>
</div>
<div class="paragraph">
<p>All we have to do is configure <code>dotenv</code> to load this file. To do this, I use Node.js flag <code>--require</code>, which allows us to pre-load a library. You just have to modify the <code>package.json</code>:</p>
</div>
<div class="listingblock">
<div class="title">The basic TypeORM configuration for a connection to SQLite</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc &amp;&amp; node dist/main.js -r dotenv/config"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start:watch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nodemon"</span><span class="p">,</span><span class="w">
    </span><span class="c1">// ...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will now create a <code>DatabaseService</code> that will take care of connecting TypeORM to our database. As we have implemented dependency injection, this service will also be injectable. Here is the complete implementation. Don&#8217;t panic. I&#8217;ll detail the logic next.</p>
</div>
<div class="listingblock">
<div class="title">Implementation of <code>DatabaseService</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/database.service.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">DatabaseService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">static</span> <span class="nx">connection</span><span class="p">:</span> <span class="nx">Connection</span><span class="p">;</span>

  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">getConnection</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Connection</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span> <span class="k">instanceof</span> <span class="nx">Connection</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">createConnection</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">INFO</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`Connection established`</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">ERROR</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Cannot establish database connection</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">getRepository</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">repository</span><span class="p">:</span> <span class="nx">ObjectType</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">getCustomRepository</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">repository</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This class has two methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getConnection</code> : this method will initialize a new connection to the database. This one will call the <code>createConnection</code> method, which will look for <a href="https://typeorm.io/#/using-ormconfig">an ormconfig file</a> (in our case, the environment variables loaded by <code>dotenv</code>) and establish a connection. Once the connection is made, it is stored in a static property, which will be returned the next time directly.</p>
</li>
<li>
<p><code>getRepository</code>: this method will allow us to manipulate our models via the repository. We will talk about it in details later</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is good practice to hide the logic of the library from our own class. This will allow us to depend on the library and to be able to migrate more easily if one day, we want to change.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that our service is created, we need to add it to our container:</p>
</div>
<div class="listingblock">
<div class="title">Add the <code>Symbol</code> linked to the <code>DatabaseService</code> service.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">DatabaseService</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">'</span><span class="s1">DatabaseService</span><span class="dl">'</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Registration of the <code>DatabaseService</code> service in the Inversify container.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">DatabaseService</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go.</p>
</div>
<div class="paragraph">
<p>We can now create our first <code>User</code> model. Using the <em>patern Data Mapper</em>, we will have to create two classes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <strong>entity</strong> : it will define fields attributes to be saved in the database. In our case, I will simply create two attributes: <code>email</code> and <code>password</code> (the password will be encrypted later).</p>
</li>
<li>
<p>the <strong>repository</strong>: it will add some logic to save our entities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To simplify the example, I will put these two classes in the same file, but you can separate them very well :</p>
</div>
<div class="listingblock">
<div class="title">Creation of user entity and user repository</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span><span class="na">unique</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">User</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UserRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. The result is really very simple, thanks to the <code>@columns</code> decorators offered by TypeORM. They can also define the type of information stored (text, date, etc&#8230;&#8203;). The implementation of this model is sufficient for the moment.</p>
</div>
<div class="paragraph">
<p>Our work is not very visible but hold on because you will see the result in the next section.</p>
</div>
<div class="paragraph">
<p>We can commit the changes made so far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Setup TypeORM"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_user_controller">Creating the user controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now it&#8217;s time to get to the concrete part and create the controller to manage the users. This controller will respect the REST standards and propose classic CRUD actions. I.e. <em><strong>C</strong>reate</em>, <em><strong>R</strong>ead</em>, <em><strong>U</strong>pdate</em> and <em><strong>D</strong>elete</em>.</p>
</div>
<div class="sect2">
<h3 id="_list_users">List users</h3>
<div class="paragraph">
<p>We will start with the <code>index</code> method, which is the simplest.</p>
</div>
<div class="paragraph">
<p>As we saw earlier, controllers can inject our services. So we will inject the <code>DatabaseService</code> to be able to retrieve the <code>UserRepository</code>. Then we will just have to call the <code>userRepository.find</code> method to get the list of all users (which is empty for the moment).</p>
</div>
<div class="paragraph">
<p>Here is the implementation of our controller:</p>
</div>
<div class="listingblock">
<div class="title">Implementation of user controller index</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">httpGet</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">)</span> <span class="p">{}</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And of course, don&#8217;t forget to add the import of this new controller in the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../controllers/users.controller</span><span class="dl">"</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Run the command <code>npm run start:watch</code> to start the server if you have stopped it and let&#8217;s test the functionality with <code>cURL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/users</code></pre>
</div>
</div>
<div class="paragraph">
<p>Command&#8217;s output indicates an empty result: this is normal because there is no user yet. On the other hand, the server terminal tells us that a lot has happened:</p>
</div>
<div class="listingblock">
<div class="title">Output of TypeORM database initialization</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">query</span><span class="p">:</span> <span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"sqlite_master"</span> <span class="k">WHERE</span> <span class="nv">"type"</span> <span class="o">=</span> <span class="s1">'table'</span> <span class="k">AND</span> <span class="nv">"name"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'user'</span><span class="p">)</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"sqlite_master"</span> <span class="k">WHERE</span> <span class="nv">"type"</span> <span class="o">=</span> <span class="s1">'index'</span> <span class="k">AND</span> <span class="nv">"tbl_name"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'user'</span><span class="p">)</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"sqlite_master"</span> <span class="k">WHERE</span> <span class="nv">"type"</span> <span class="o">=</span> <span class="s1">'table'</span> <span class="k">AND</span> <span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'typeorm_metadata'</span><span class="p">.</span>
<span class="n">query</span><span class="p">:</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"user"</span> <span class="p">(</span><span class="nv">"id"</span> <span class="nb">integer</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"email"</span> <span class="nb">varchar</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"password"</span> <span class="nb">varchar</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">)</span>
<span class="n">query</span><span class="p">:</span> <span class="k">COMMIT</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">15</span><span class="n">T22</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">25</span><span class="p">.</span><span class="mi">476</span><span class="n">Z</span> <span class="o">-</span> <span class="n">INFO</span> <span class="o">-</span> <span class="k">Connection</span> <span class="n">established</span> <span class="o">-</span> <span class="err">{}</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">"User"</span><span class="p">.</span> <span class="nv">"id"</span> <span class="k">AS</span> <span class="nv">"User_id"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span> <span class="nv">"email"</span> <span class="k">AS</span> <span class="nv">"User_email"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span> <span class="nv">"password"</span> <span class="k">AS</span> <span class="nv">"User_password"</span> <span class="k">FROM</span> <span class="nv">"user"</span> <span class="nv">"user"</span> <span class="nv">"User"</span> <span class="nv">"User"</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These are TypeORM logs. These tell us that:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>TypeORM tried to see if there was a table named <code>user</code>.</p>
</li>
<li>
<p>TypeORM created this table since it didn&#8217;t exist</p>
</li>
<li>
<p>the connection to the database has been established</p>
</li>
<li>
<p>The SQL query to retrieve all users has been executed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This tells us that everything is working perfectly! But I feel a bit disappointed because we don&#8217;t have a user yet. Let&#8217;s move on!</p>
</div>
</div>
<div class="sect2">
<h3 id="_create">Create</h3>
<div class="paragraph">
<p>Now that our entire structure has been put in place, the rest will go much faster. Let&#8217;s go straight to the implementation, and I&#8217;ll explain the code next:</p>
</div>
<div class="listingblock">
<div class="title">Adding the <code>create</code> method to the <code>UserRepository</code> class.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">httpGet</span><span class="p">,</span> <span class="nx">httpPost</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="kr">interface</span> <span class="nx">CreateUserBody</span> <span class="p">{</span>
  <span class="nl">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nx">CreateUserBody</span><span class="p">,</span> <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a bit of code but don&#8217;t panic. <code>CreateUserBody</code> is an interface that defines the HTTP parameters that can be received. We take these parameters and send them directly to the repository.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s test that it all works:</p>
</div>
<div class="listingblock">
<div class="title">Creating a user with <code>cURL</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect. You can see that everything is working properly!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s move on to retrieve the information of this user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_show">Show</h3>
<div class="paragraph">
<p>The <code>show</code> method will take care of retrieving a user&#8217;s information. This method will take the user&#8217;s ID. We will then use the <code>repository</code> to retrieve the user.</p>
</div>
<div class="paragraph">
<p>Here is the implementation :</p>
</div>
<div class="listingblock">
<div class="title">Adding the <code>create</code> method to the <code>UserRepository</code> class.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(@</span><span class="nd">requestParam</span><span class="p">(</span><span class="dl">'</span><span class="s1">userId</span><span class="dl">'</span><span class="p">)</span> <span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is really very simple. Just return an object, and <code>inversify-express-utils</code> will take care of converting the JavaScript object to JSON.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try it to see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/users/1
<span class="o">{</span><span class="s2">"id"</span>:1, <span class="s2">"email"</span>: <span class="s2">"test@test.fr"</span>, <span class="s2">"password"</span>: <span class="s2">"test"</span><span class="o">}</span>.</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Everything is working properly. Now let&#8217;s try to update this user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_update">Update</h3>
<div class="paragraph">
<p>The <code>update</code> method will take care of recovering, modifying, and registering the user. As for the previous method, TypeORM makes our task much easier:</p>
</div>
<div class="listingblock">
<div class="title">Implementation of user update</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">UpdateUserBody</span> <span class="p">{</span>
  <span class="nl">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nx">UpdateUserBody</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">requestParam</span><span class="p">(</span><span class="dl">'</span><span class="s1">userId</span><span class="dl">'</span><span class="p">)</span> <span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">??</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span> <span class="o">??</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. As before, let&#8217;s see if it works:</p>
</div>
<div class="listingblock">
<div class="title">Updating an user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> PUT <span class="nt">-d</span> <span class="s2">"email=foo@bar.com"</span>  http://localhost:3000/users/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect! You can even see, our user has been updated and it is sent back to us in JSON format. You can even see the SQL query that TypeORM performed in the terminal logs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="nv">"User_id"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"email"</span> <span class="k">AS</span> <span class="nv">"User_email"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"password"</span> <span class="k">AS</span> <span class="nv">"User_password"</span> <span class="k">FROM</span> <span class="nv">"user"</span> <span class="nv">"User"</span> <span class="k">WHERE</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: [1]</span>
<span class="n">query</span><span class="p">:</span> <span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
<span class="n">query</span><span class="p">:</span> <span class="k">UPDATE</span> <span class="nv">"user"</span> <span class="k">SET</span> <span class="nv">"email"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">WHERE</span> <span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: ["foo@bar.com",1]</span>
<span class="n">query</span><span class="p">:</span> <span class="k">COMMIT</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_delete">Delete</h3>
<div class="paragraph">
<p>The <code>delete</code> method is the easiest. Just retrieve the user and call the <code>repository.delete</code> method. Let&#8217;s do it:</p>
</div>
<div class="listingblock">
<div class="title">Implementation of user delete</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpDelete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">destroy</span><span class="p">(@</span><span class="nd">requestParam</span><span class="p">(</span><span class="dl">'</span><span class="s1">userId</span><span class="dl">'</span><span class="p">)</span> <span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>delete</code> method is the easiest. Just retrieve the user and call the <code>repository.delete</code> method. Let&#8217;s do it:</p>
</div>
<div class="listingblock">
<div class="title">Delete an user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> DELETE  http://localhost:3000/users/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here again, we can verify that the user has been deleted by looking at the TypeORM logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="nv">"User_id"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"email"</span> <span class="k">AS</span> <span class="nv">"User_email"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"password"</span> <span class="k">AS</span> <span class="nv">"User_password"</span> <span class="k">FROM</span> <span class="nv">"user"</span> <span class="nv">"User"</span> <span class="k">WHERE</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: ["1"]</span>
<span class="n">query</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"user"</span> <span class="k">WHERE</span> <span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span> <span class="nv">"email"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span> <span class="nv">"password"</span> <span class="o">=</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: [1,"foo@bar.com","test"]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Now that we are at the end of our controller, we can commit all these changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Implement CRUD actions on user"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_of_our_users">Validation of our users</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Everything seems to work, but there is still one problem: we do not validate the data we insert in the database. Thus, it is possible to create a user with a fake email:</p>
</div>
<div class="listingblock">
<div class="title">Try to creating an invalid user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"whatever"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, we will use a ready-made library: <code>class-validator</code>. This library will offer us <a href="https://github.com/typestack/class-validator/#table-of-contents">a ton of decorators</a> to check our <code>User</code> instance very easily.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s install it with NPM :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">install </span>class-validator <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then just add the <code>@IsEmail</code> and <code>@IsDefined</code> decorators like this :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/entities/user.entity.ts
<span class="gi">+ import {IsDefined, IsEmail, validateOrReject} from 'class-validator';
</span><span class="gd">- import {/* ... */} from 'typeorm';
</span><span class="gi">+ import {BeforeInsert, BeforeUpdate, /* ... */} from 'typeorm';
</span>
@Entity()
<span class="p">export class User {
</span>  // ...
<span class="gi">+  @IsDefined()
+  @IsEmail()
</span>  @Column()
  email: string;

+  @IsDefined()
  @Column()
  password: string;

+  @BeforeInsert()
<span class="gi">+  @BeforeUpdate()
+  async validate() {
+    await validateOrReject(this);
+  }
</span><span class="err">}</span>
// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>It didn&#8217;t take a lot of code to add. The most interesting part is the <code>validate</code> method. It has two decorators <code>BeforeInsert</code> and <code>BeforeUpdate</code>, which will automatically call the <code>validate</code> method when using the <code>save</code> method of a repository. This is very convenient, and there is nothing to do. Now let&#8217;s try to create the same user with the wrong email:</p>
</div>
<div class="listingblock">
<div class="title">Try to creating an invalid user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"whatever"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users
...
&lt;pre&gt;An instance of User has failed the validation:&lt;br&gt; - property email has failed the following constraints: isDefined, isEmail &lt;br&gt;&lt;/pre&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that it is much better. However we would like to send an error formatted in JSON with the error code corresponding to the REST standard. So let&#8217;s modify the controller :</p>
</div>
<div class="listingblock">
<div class="title">Add user validation in the <code>UserController</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">User</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">User</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try now:</p>
</div>
<div class="listingblock">
<div class="title">Try to creating an invalid user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span>  http://localhost:3000/users
<span class="o">{</span><span class="s2">"errors"</span>:[<span class="o">{</span><span class="s2">"target"</span>:<span class="o">{</span><span class="s2">"password"</span>:<span class="s2">"test"</span><span class="o">}</span>,<span class="s2">"property"</span>:<span class="s2">"email"</span>,<span class="s2">"children"</span>:[],<span class="s2">"constraints"</span>:<span class="o">{</span><span class="s2">"isDefined"</span>:<span class="s2">"email should not be null or undefined"</span>,<span class="s2">"isEmail"</span>:<span class="s2">"email must be an email"</span><span class="o">}}]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result is really complete and will allow an API user to quickly interpret the error.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s commit these changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Validate user"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_factoring">Factoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have a code that works, it&#8217;s time to make a pass to <strong>make it all</strong>.</p>
</div>
<div class="paragraph">
<p>During setup, you may have noticed that the <code>show</code>, <code>update</code>, and <code>destroy</code> methods have a common logic: they all get the whole user.</p>
</div>
<div class="paragraph">
<p>To factorize this code, there would be two solutions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>move the code snippet to a private method and call it</p>
</li>
<li>
<p>create a <strong>Middleware</strong> that will be executed before the controller</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I chose the second option because it reduces the code and the controller&#8217;s responsibility. Moreover, with <code>inversify-express-utils</code> it&#8217;s effortless. Let me show you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">NextFunction</span><span class="p">,</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">BaseMiddleware</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchUserMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">userId</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">userId</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">User not found</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some explanations about this code :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>inversify-express-utils</code> gives us access to an abstract class <code>BaseMiddleware</code>. We also need to add the <code>@injectable</code> decorator to use it later in our controller.</p>
</li>
<li>
<p>a middleware is a simple <code>handle</code> method that takes :</p>
<div class="ulist">
<ul>
<li>
<p><code>req</code>: the request sent by the user</p>
</li>
<li>
<p><code>res</code>: the HTTP response to return.</p>
</li>
<li>
<p><code>next</code>: a callback to call once our processing is complete.</p>
</li>
</ul>
</div>
</li>
<li>
<p>the <code>handle</code> method takes care of retrieving the user and adding it to the <code>req</code> object for later use.</p>
</li>
<li>
<p>if the user does not exist, we use <code>res</code> to return a 404 response directly without even going through the user</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Since we have defined a new injectable, we need to add it to our container:</p>
</div>
<div class="listingblock">
<div class="title">Add <code>FetchUserMiddleware</code> type for inversify</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="c1">// Middlewares</span>
  <span class="na">FetchUserMiddleware</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">FetchUserMiddleware</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Register <code>FetchUserMiddleware</code> to container</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">FetchUserMiddleware</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../middlewares/fetchUser.middleware</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="c1">// middlewares</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchUserMiddleware</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FetchUserMiddleware</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can use this middleware in our controller by adding <code>TYPE.FetchUserMiddleware</code> to the decorator. So here is the modification:</p>
</div>
<div class="listingblock">
<div class="title">Using <code>FetchUserMiddleware</code> into user controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">httpDelete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">destroy</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Not bad, right? Let&#8217;s start the modifications before going further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Factorize user controller with middleware"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_password_hash">Password Hash</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_theory">Theory</h3>
<div class="paragraph">
<p>We will use the basic library of Node.js: <a href="https://nodejs.org/api/crypto.html">Crypto</a>. Here is an example of a method for hashing the password:</p>
</div>
<div class="listingblock">
<div class="title">Hash a password with <code>crypto</code> library</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">));</span>
<span class="c1">// =&gt; 51e649c92c8edfbbd8e1c17032...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there it is! To know if the password matches, just check if the hash matches the previous one:</p>
</div>
<div class="listingblock">
<div class="title">Compare an hashed password</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">hash</span> <span class="o">===</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; 51e649c92c8edfbbd8e1c17032...</span>

<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; true</span>
<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">wrong password</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Impeccable. However, there is a small problem with this type of method.</p>
</div>
<div class="paragraph">
<p>If your passwords leak, it will be quite easy to retrieve the corresponding password by building a <strong>hash library</strong>. Concretely, the malicious person would use the current passwords, hash them one by one with the same algorithm, and compare them to ours. To correct this, a hash salt must be used.</p>
</div>
<div class="paragraph">
<p>The hash salt consists of adding a defined text to each password. Here is the modification:</p>
</div>
<div class="listingblock">
<div class="title">Hash a password with a salt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">my private salt</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">salt</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">password</span><span class="p">}</span><span class="s2">_</span><span class="p">${</span><span class="nx">salt</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">hash</span> <span class="o">===</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span><span class="c1">// =&gt; 3fdd2b9c934cd34c3150a72fb4c98...</span>

<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; true</span>
<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">wrong password</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go! The result is the same, but our application is more secure. If someone were to access our database, he would have to have the <strong>hash salt</strong> to retrieve the corresponding passwords.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_implementation">The implementation</h3>
<div class="paragraph">
<p>Now that we have seen the theory let&#8217;s put it into practice. We will use the same methods in a <code>password.utils.ts</code> file. Here we go:</p>
</div>
<div class="listingblock">
<div class="title">Create utilities methods for password hashing</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/password.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">my private salt</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">salt</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">password</span><span class="p">}</span><span class="s2">_</span><span class="p">${</span><span class="nx">salt</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">hash</span> <span class="o">===</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will now use the <code>hashPassword</code> method in the <code>User</code> entity. With TypeORM it&#8217;s very easy using hooks as we did with validation.</p>
</div>
<div class="listingblock">
<div class="title">Hash user&#8217;s password</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">hashPassword</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/password.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">IsDefined</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">hashedPassword</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="kd">set</span> <span class="nx">password</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hashedPassword</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A few explanations are necessary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We have created an attribute <code>hashedPassword</code>, which contains the password of the hashed user. This value will be saved in the database because we added the <code>@column</code> decorator. We&#8217;ll need it later to know if the user&#8217;s password matches the one he had defined.</p>
</li>
<li>
<p>the <code>password</code> attribute becomes a <strong>setter</strong>. It&#8217;s like a virtual attribute that will be called during the assignment. So by doing <code>user.password = 'toto'</code>, this method will be called. This is perfect because we don&#8217;t want to store the password anymore in case our database leaks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now let&#8217;s try to create a user via the API:</p>
</div>
<div class="listingblock">
<div class="title">Creating an user with <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users
<span class="o">{</span><span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"password"</span>:<span class="s2">"test"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"8574a23599216d7752ef4a2f62d02b9efb24524a33d840f10ce6ceacda69777b"</span>,<span class="s2">"id"</span>:1<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything seems to work perfectly because we can see that the user has a hashed password. If we change the password, the hash changes correctly :</p>
</div>
<div class="listingblock">
<div class="title">Update user&#8217;s password with <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> PUT   <span class="nt">-d</span> <span class="s2">"password=helloWorld"</span>  http://localhost:3000/users/4
<span class="o">{</span><span class="s2">"id"</span>:4,<span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"bdbe865951e5cd026bb82a299e3e1effb1e95ce8c8afe6814cecf8fa1e895d1f"</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything works perfectly well. Let&#8217;s do a commit before going any further.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Hash user password"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_a_unit_test">Setting up a unit test</h3>
<div class="paragraph">
<p>We have a code that works, and that&#8217;s cool. If we can make sure it works like that every time we evolve, it&#8217;s even better. So this is where the <strong>unitary tests</strong> come in.</p>
</div>
<div class="paragraph">
<p>Unit testing&#8217;s role is to make sure that our method always works the way we decided it would. So here we&#8217;re going to set up a simplistic test to make sure that everything works well.</p>
</div>
<div class="paragraph">
<p>There are several libraries of tests in JavaScript. I chose <code>Mocha</code> because it&#8217;s one of the most popular libraries and straightforward to set up. We also install <code>ts-mocha</code>, which will transpose the TypeScript on the fly:</p>
</div>
<div class="listingblock">
<div class="title">Install mocha library</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>mocha ts-mocha @types/mocha <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also need to modify our <code>tsconfig.json</code> to add Mocha&#8217;s declarations and tell Typescript not to compile these files:</p>
</div>
<div class="listingblock">
<div class="title">Add mocha setting to Typescript configuration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">{</span>
  "compilerOptions": {
    // ..
    "types": [
      "node",
<span class="gi">+      "mocha"
</span>    ],
    // ...
  },
<span class="gi">+   "exclude": ["./**/*.spec.ts"]
</span><span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we are ready to create our first test:</p>
</div>
<div class="listingblock">
<div class="title">Create first unit test about hashing password</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.spec.ts</span>
<span class="k">import</span> <span class="nx">assert</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">assert</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">hashPassword</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/password.utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">User</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should hash password</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">hashedPassword</span><span class="p">,</span> <span class="nx">expected</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As I told you, it&#8217;s a really simple test. Now let&#8217;s add the command that will allow us to run this test in the <code>package.json</code> file:</p>
</div>
<div class="listingblock">
<div class="title">Add NPM script to run tests</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">{</span>
  // ...
  "scripts": {
    "start": "tsc &amp;&amp; node dist/main.js",
    "start:watch": "nodemon",
<span class="gi">+     "test": "DOTENV_CONFIG_PATH=.test.env ts-mocha -r reflect-metadata -r dotenv/config src/**/*.spec.ts",
</span>    "build": "tsc"
  },
  // ...
<span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some explanations on this command:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-r reflect-metadata</code> loads the <code>reflect-metadata</code> library and prevents us from importing it manually.</p>
</li>
<li>
<p><code>-r dotenv/config</code> loads the <code>dotenv</code> library to get the TypeORM environment variables.</p>
</li>
<li>
<p><code>DOTENV_CONFIG_PATH</code> will load a particular <code>.env</code> file that we will create right afterward.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When we test our application, we don&#8217;t want to pollute our database with data we create during testing. So it&#8217;s a good practice to create a dedicated database. In our case, we will use a SQLite <strong>in memory</strong> database. That is to say that it is not stored on the hard disk but directly in the random access memory. Here is the file <code>.test.env</code>:</p>
</div>
<div class="listingblock">
<div class="title">TypeORM environnement variable for testing</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="env">TYPEORM_CONNECTION=sqlite
TYPEORM_DATABASE=:memory:
TYPEORM_LOGGING=true
TYPEORM_SYNCHRONIZE=true
TYPEORM_ENTITIES=src/entities/*.entity.ts</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>TYPEORM_ENTITIES</code> directive also points to Typescript files because <code>ts-mocha</code> transpiles and executes these files directly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s it. Now we can run this test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test

  </span>User
     should <span class="nb">hash </span>password


  1 passing <span class="o">(</span>5ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we can also add another unit test on the <code>isPasswordMatch</code> password comparison method:</p>
</div>
<div class="listingblock">
<div class="title">Add unit test about <code>isPasswordMatch</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/password.utils.spec.ts</span>
<span class="k">import</span> <span class="nx">assert</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">assert</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">hashPassword</span><span class="p">,</span> <span class="nx">isPasswordMatch</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./password.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">isPasswordMatch</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">good</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should match</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">good</span><span class="dl">"</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not match</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">bad</span><span class="dl">"</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, this kind of test may seem simplistic to you but they are very fast and provide additional security. Let&#8217;s run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  User
     should <span class="nb">hash </span>password

  isPasswordMatch
     should match
     should not match


  3 passing <span class="o">(</span>6ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you&#8217;re warmed up, let&#8217;s commit and move on to the next one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add unit test about password hash"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_functional_tests">Add functional tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have set up unit tests, it is time to set up the <strong>functional tests</strong>. This type of test will test functionalities rather than methods.</p>
</div>
<div class="paragraph">
<p>A good practice I learned while developing with the Ruby on Rails <em>framework</em> is to test the behavior of controllers. This is very easy because you just call an <em>endpoint</em> with parameters and check the result. For example, if I send a <code>GET</code> type request on the <code>/users</code> route, I should expect to receive a list of users. The library <a href="https://www.npmjs.com/package/supertest">supertest</a> allows us to do this without even starting the server.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s install this library:</p>
</div>
<div class="listingblock">
<div class="title">Install supertest library</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>supertest @types/supertest <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s create our agent that will be used in all our tests:</p>
</div>
<div class="listingblock">
<div class="title">Create supertest agent</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/tests/supertest.utils.ts</span>
<span class="k">import</span> <span class="nx">supertest</span><span class="p">,</span> <span class="p">{</span> <span class="nx">SuperTest</span><span class="p">,</span> <span class="nx">Test</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">server</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">agent</span><span class="p">:</span> <span class="nx">SuperTest</span><span class="o">&lt;</span><span class="nx">Test</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">supertest</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now let&#8217;s start creating our first test for the <code>index</code> method for example:</p>
</div>
<div class="listingblock">
<div class="title">Create functional test about <code>GET /users</code> endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">agent</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/supertest.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should respond 200</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test is really very simple, and the <code>supertest</code> syntax makes the test very readable. This test means "send an HTTP request of type <code>Get</code> and expect a response of type `200`". Let&#8217;s try to run the tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  UsersController
    index
       should respond 200
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TypeORM SQL queries may be hosted by you because we left the <code>TYPEORM_LOGGING=true</code> directive. You can pass it to <code>false</code> to stop seeing them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now here is the same test for <code>create</code>. This one is different because it sends HTTP parameters.</p>
</div>
<div class="listingblock">
<div class="title">Create functional test about <code>POST /users/</code> endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="c1">// ..</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should create user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">@test.io`</span><span class="p">;</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span> <span class="p">}).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create user with missing email</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">@test.io`</span><span class="p">;</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">email</span> <span class="p">}).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>new Date().getTime()</code> returns a <code>Number</code> of the number of milliseconds since 01/01/1970. I use it to get a unique number. We&#8217;ll see later how to improve this.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we test two things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>if we send the right information, we should have a return of type <code>200</code>.</p>
</li>
<li>
<p>if you don&#8217;t specify a password, you must have a return of type <code>400</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This test is straightforward, and you can add others like "should not create user with invalid email" for example. These tests are easy to set up and <strong>validate a global behavior</strong>.</p>
</div>
<div class="paragraph">
<p>You can now commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>git add <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add functional tests"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_3">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh, you&#8217;re here! Well done! I know this was probably the longest chapter but don&#8217;t give up!</p>
</div>
<div class="paragraph">
<p>If you&#8217;re not used to using tests, we&#8217;ll see in the chapter how to use them to predefine the behavior we want before we even code the features. So we will set up tests for the <code>show</code>, <code>update</code>, and <code>destroy</code> methods that will need authentication. In other words, we will start doing test-driven development Test Driven Development. This is definitely the most important part of the book!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter04-authentication" class="sect0">User authentication</h1>
<div class="openblock partintro">
<div class="content">
In this chapter, things will become more interesting. We are going to set up our authentication mechanism. In my opinion, this will be one of the most interesting chapters because we will introduce a lot of new concepts. In the end, you will have a simple but powerful authentication system. Don&#8217;t panic. We&#8217;ll get there.
</div>
</div>
<div class="sect1">
<h2 id="_stateless_sessions">Stateless Sessions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before going any further, something must be clear: an API does not manage sessions. This may sound a bit crazy if you don&#8217;t have any experience creating this kind of application. An API should be stateless. By definition, this means that an API that provides an answer after your request requires no further attention. This means that no previous or future state is required for the system to work.</p>
</div>
<div class="paragraph">
<p>The process of user authentication via an API is straightforward:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The client requests a session resource with the corresponding credentials (usually an e-mail and a password).</p>
</li>
<li>
<p>The server returns the user resource with its corresponding authentication token.</p>
</li>
<li>
<p>For each page that requires authentication, the client must send this authentication token.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This section and the next will focus on building a session controller with its corresponding actions. We will then complete the request flow by adding the necessary authorization access.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introducing_json_web_token">Introducing JSON Web Token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When it comes to authentication tokens, a standard exists for the JSON Web Token (JWT).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>JWT is an open standard defined in RFC 75191. It allows the secure exchange of tokens between multiple parties. - <a href="https://fr.wikipedia.org/wiki/JSON_Web_Token" class="bare">https://fr.wikipedia.org/wiki/JSON_Web_Token</a> [Wikipedia]</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Overall, a JWT token is composed of three parts :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a header structured in JSON will contain, for example, the validity date of the token.</p>
</li>
<li>
<p>a payload structured in JSON, which can contain any data. In our case, it will contain the identifier of the "connected" user.</p>
</li>
<li>
<p>a signature that will allow us to verify that the token has been encrypted by our application and therefore that it is valid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These three parts are each encoded in base64 and then concatenated using dots <code>.</code>. This gives us something like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</pre>
</div>
</div>
<div class="paragraph">
<p>Once decoded, this token gives us the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the head</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w"> </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="p">,</span><span class="w"> </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>the payload</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w"> </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234567890"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w"> </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about JWT tokens, I invite you to visit <a href="https://jwt.io/">jwt.io</a>.</p>
</div>
<div class="paragraph">
<p>This has many advantages, such as sending information to the API consumer directly in the token. You can, for example, choose to integrate the user information in the payload.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_the_authentication_token">Setting up the authentication token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The JWT standard has many implementations in various languages. Of course, there is a Nodejs library on this subject: <a href="https://github.com/auth0/node-jsonwebtoken">node-jsonwebtoken</a>.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start by installing it:</p>
</div>
<div class="listingblock">
<div class="title">Install JWT library</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>jsonwebtoken
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">--save-dev</span> @types/jsonwebtoken</code></pre>
</div>
</div>
<div class="paragraph">
<p>The library is very easy to use with the <code>jwt.sign</code> and <code>jwt.verify</code> methods. Here is an example:</p>
</div>
<div class="listingblock">
<div class="title">Exemple of how to use JWT library with Node.js</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">sign</span><span class="p">,</span> <span class="nx">verify</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">JWT_PRIVATE_KEY</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">123456789</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">};</span>
<span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">JWT_PRIVATE_KEY</span><span class="p">,</span> <span class="p">{</span> <span class="na">expiresIn</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1 day</span><span class="dl">"</span> <span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">JWT_PRIVATE_KEY</span><span class="p">)));</span>
<span class="c1">// =&gt; { userId: 1, iat: 1605730716, exp: 1605817116 }</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the first line, we encoded a <code>payload</code> with the secret key <code>JWT_PRIVATE_KEY</code>. So we get a token that we can simply decode. The second line decodes the token, and we can see that we get our <code>payload</code> back.</p>
</div>
<div class="paragraph">
<p>Now we&#8217;re going to put all this logic into a <code>JsonWebTokenService</code> class. This will allow us to avoid duplicating the code. This class will just encode and decode the JWT tokens. Here is the implementation :</p>
</div>
<div class="listingblock">
<div class="title">Create <code>JsonWebTokenService</code> to encode / decode JWT token</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/jsonWebToken.service.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">sign</span><span class="p">,</span> <span class="nx">verify</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">JsonWebTokenService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">JWT_PRIVATE_KEY</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">123456789</span><span class="dl">"</span><span class="p">;</span>

  <span class="nx">encode</span><span class="p">(</span><span class="nx">payload</span><span class="p">:</span> <span class="nb">Object</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">JWT_PRIVATE_KEY</span><span class="p">,</span> <span class="p">{</span> <span class="na">expiresIn</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1 day</span><span class="dl">"</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Object</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">JWT_PRIVATE_KEY</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is straightforward. One method encodes a payload. The other decodes it. As this service is injectable, we have to save it in the container.</p>
</div>
<div class="listingblock">
<div class="title">Add the <code>Symbol</code> for the <code>JsonWebTokenService</code> service.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">JsonWebTokenService</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">JsonWebTokenService</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Register <code>JsonWebTokenService</code> service to the container.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">JsonWebTokenService</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. We can even add a little quick test that will encode and decode a payload and check that we find the content:</p>
</div>
<div class="listingblock">
<div class="title">Create unit test about JWT encoding / decoding</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/jsonWebToken.service.spec.ts</span>
<span class="k">import</span> <span class="nx">assert</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">assert</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">JsonWebTokenService</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should encode and decode payload</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This test is a bit longer than the others because we have to <strong>retrieve an instance</strong> of <code>JsonWebTokenService</code> via the <code>container</code>. We use the <code>before</code> method that will be executed before our test battery.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if all our tests pass :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  JsonWebTokenService
     should encode and decode payload
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s perfect. Let&#8217;s get started and move on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Create JsonWebTokenService"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_token_controller">The token controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So we set up the JWT token generation system. It is now time to create a route that will generate this token. The actions we will implement will be handled as <em>RESTful</em> services: the connection will be handled by a <code>POST</code> request to the <code>create</code> action.</p>
</div>
<div class="paragraph">
<p>Before moving on to the implementation, we will try to write a complete test.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_the_functional_test">Setting up the functional test</h3>
<div class="paragraph">
<p>Here we will test the <em>endpoint</em> that we will create next. This <em>endpoint</em> will take the user&#8217;s email and password as parameters. So we can test three things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the user has sent the right information, so we return a token</p>
</li>
<li>
<p>the password is wrong, so we return the error <code>400 - Bad request</code>.</p>
</li>
<li>
<p>the user does not exist, so we return the error <code>400 - Bad request</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We return a code <code>400</code> without further explanation. Indeed, we do not want to tell the user that this email is not present in the database. This is a good practice that would make a brute force attack little more complicated.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Obviously, the test will start by creating a user. This is what we will do in the <code>before</code> method.</p>
</div>
<div class="listingblock">
<div class="title">Creation of a part of the functional test of <code>TokensController</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">TokensController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">@test.io`</span><span class="p">;</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">p@ssw0rd</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
we store the <code>user</code> variable outside the <code>before</code> method so that we can use it later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we just have to write our tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">agent</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/supertest.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">TokensController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should get token</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">p@ssw0rd</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not get token user with bad password</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bad password</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create token with nonexisting email</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bad password</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. As we work in test-driven development, at this point our tests don&#8217;t pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  1<span class="o">)</span> TokensController
       create
         should get token:
     Error: expected 200 <span class="s2">"OK"</span>, got 404 <span class="s2">"Not Found"</span>
...
  2<span class="o">)</span> TokensController
       create
         should not get token user with bad password:
     Error: expected 400 <span class="s2">"Bad Request"</span>, got 404 <span class="s2">"Not Found"</span>
...
  3<span class="o">)</span> TokensController
       create
         should not create token with nonexisting email:
     Error: expected 400 <span class="s2">"Bad Request"</span>, got 404 <span class="s2">"Not Found"</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our goal in the next section will be to pass these tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementation">Implementation</h3>
<div class="paragraph">
<p>So we will create the <code>TokenController</code>. Let&#8217;s start by creating the controller with the necessary dependencies:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>DatabaseService</code> to retrieve the user that corresponds to the email</p>
</li>
<li>
<p><code>JsonWebTokenService</code> to create a JWT token</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Creation of the TokensController with the necessary dependencies.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">TokensController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we add this container controller so that it can be loaded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../controllers/tokens.controller</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all we have to do is focus on the <code>create</code> method of our controller.</p>
</div>
<div class="listingblock">
<div class="title">Implement <code>POST /tokens</code> endpoint to get a JWT token</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">httpPost</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">isPasswordMatch</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/password.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">TokensController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="p">{</span> <span class="nl">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="nl">password</span><span class="p">:</span> <span class="kr">string</span> <span class="p">},</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">hashedPassword</span><span class="p">,</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span>
        <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">token</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wow! This code looks complicated, but it&#8217;s actually straightforward:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we create a <code>create</code> method in the controller that will create a token for the requested user.</p>
</li>
<li>
<p>this method uses the <code>userRepository</code> to retrieve the user from the given email. If we can&#8217;t find the user, we return a <code>400 - Bad request</code> error.</p>
</li>
<li>
<p>we use the <code>isPasswordMatch</code> method to check if the password matches the hash we have stored. If it does, we create and return a token with the <code>jsonWebTokenService.encode</code> method.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Still there? Let&#8217;s try to run the tests to see if our code works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  TokensController
    create
       should get token <span class="o">(</span>41ms<span class="o">)</span>
       should not get token user with bad password
       should not create token with nonexisting email</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try the logic in the terminal. Let&#8217;s create a user (if not already done) :</p>
</div>
<div class="listingblock">
<div class="title">Create a brand new user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users
<span class="o">{</span><span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"8574a23599216d7752ef4a2f62d02b9efb24524a33d840f10ce6ceacda69777b"</span>,<span class="s2">"id"</span>:1<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then let&#8217;s ask for the token for this one:</p>
</div>
<div class="listingblock">
<div class="title">Request JWT token for an user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/tokens
<span class="o">{</span><span class="s2">"token"</span>: <span class="s2">"eyJhbGciOiJIUzI1NiI..."</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oura! Let&#8217;s try with a wrong password :</p>
</div>
<div class="listingblock">
<div class="title">Request JWT token for an user using <code>cURL</code> using a bad password</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=azerty"</span> http://localhost:3000/tokens
Bad Request</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s perfect!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s count and move on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Create token controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_logged_in">User logged in</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We set up the following logic: the API returns an authentication token if the authentication parameters passed are correct.</p>
</div>
<div class="paragraph">
<p>We will now implement the following logic: Each time this client requests a protected page, we will have to retrieve the user from this authentication token that the user will have passed in the HTTP header.</p>
</div>
<div class="paragraph">
<p>In our case, we will use the HTTP header <code>Authorization</code>, which is often used for this. I find this the best way because it gives context to the request without polluting the URL with extra parameters.</p>
</div>
<div class="paragraph">
<p>This action will be central to our application and will be used everywhere. So it&#8217;s quite logical to create a dedicated <em>middleware</em>. As we have it earlier. But before moving on to the code, we will define the behavior we want.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_the_functional_test_2">Setting up the functional test</h3>
<div class="paragraph">
<p>The operation we wish to set up is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>there is no need for a token to create a user because this is the registration step.</p>
</li>
<li>
<p>an authentication token is required to view or modify a user</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now that we have defined that, we can create our functional test.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll take the <code>users.controller.spec.ts</code> test, and we&#8217;ll implement the tests for <code>show</code>, <code>update</code>, and <code>destroy</code>.</p>
</div>
<div class="paragraph">
<p>These three tests require that we already have a basic user. We will create a <code>utils</code> method that will generate a random user:</p>
</div>
<div class="listingblock">
<div class="title">Create a method to build a new user with random data for testing purposes</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">randomBytes</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">randomBytes</span><span class="p">(</span><span class="nx">size</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">?:</span> <span class="nx">User</span><span class="p">):</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
  <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">user</span><span class="p">?.</span><span class="nx">email</span> <span class="o">??</span> <span class="s2">`</span><span class="p">${</span><span class="nx">randomString</span><span class="p">()}</span><span class="s2">@random.io`</span><span class="p">;</span>
  <span class="nx">newUser</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">newUser</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is straightforward and will rely on the <code>randomBytes</code> of <a href="https://nodejs.org/docs/latest-v14.x/api/crypto.html"><code>crypto</code> library</a> to generate a totally random email address.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
there are libraries like <a href="https://github.com/marak/Faker.js/">Faker.js</a> that allow you to do this, but here I prefer to do without them to simplify the example.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can go back to our test and create a user in the <code>before</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Create user in <code>before</code> hook in functional test</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all we have to do is try to access this user via <code>GET /users/1</code> with and without a JWT token:</p>
</div>
<div class="listingblock">
<div class="title">Functional tests of the method <code>UsersController.show</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>
  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not show user other user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the tests are really very simple. We simply check the HTTP status code of the response.</p>
</div>
<div class="paragraph">
<p>The principle is exactly the same for the <code>update</code> and <code>destroy</code> methods:</p>
</div>
<div class="listingblock">
<div class="title">Functional tests of the method <code>UsersController.show</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">update</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ... create user on `before`</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not update other user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should update my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">destroy</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ... create user on `before`</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not destroy other user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should delete my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. If you run the tests at this point you&#8217;re going to get a bunch of errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
// ...
UsersController
    index
       should respond 200
    show
      1<span class="o">)</span> should not show user other user
      2<span class="o">)</span> should show my profile
    create
       should create user
       should not create user with missing email
    update
      3<span class="o">)</span> should not update other user
      4<span class="o">)</span> should update my profile
    destroy
      5<span class="o">)</span> should not destroy other user
      6<span class="o">)</span> should delete my profile
// ...
  10 passing <span class="o">(</span>226ms<span class="o">)</span>
  6 failing</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is quite normal because we haven&#8217;t implemented the suite yet. Now let&#8217;s move on to implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_middleware">Creating middleware</h3>
<div class="paragraph">
<p>So we are going to create a <em>Middleware</em> <code>FetchLoggerUserMiddleware</code> to meet our needs. That is to say, find the user thanks his authentication token, which is sent on each request.</p>
</div>
<div class="paragraph">
<p>The principle is pretty much the same as the previous <em>middleware</em> we created earlier, so I&#8217;ll go straight to the implementation. In the same way as the <code>TokenController</code>, we inject it with</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>jsonWebTokenService</code> to decode the JWT token</p>
</li>
<li>
<p>the <code>databaseService</code> to retrieve the user associated with the token</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Create a brand new middleware to fetch logged user</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchLoggedUser.middleware.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">BaseMiddleware</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchLoggedUserMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now here is the implementation of the <code>handler</code> method</p>
</div>
<div class="listingblock">
<div class="title">Create logic for <code>FetchLoggedUserMiddleware</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchLoggedUser.middleware.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">NextFunction</span><span class="p">,</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchLoggedUserMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">?.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">bearer</span><span class="dl">"</span><span class="p">,</span> <span class="dl">""</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">You must provide an `Authorization` header</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid token</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Again the code seems long, but it is actually straightforward:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we extract the JWT token in the <em>header</em> <code>Authorization</code>. If it is not defined, we return an error <code>403 - Forbidden</code> with a short explanation</p>
</li>
<li>
<p>we decode the JWT token and retrieve the associated user. If an error occurs (the token can&#8217;t be decoded or the user doesn&#8217;t exist), we return a <code>403</code> error as well.</p>
</li>
<li>
<p>we inject the user in the request so that it can be used in the controller</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Of course, we don&#8217;t forget to add this <em>middleware</em> to our container :</p>
</div>
<div class="listingblock">
<div class="title">Add the <code>FetchLoggedUserMiddleware</code> symbol.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">FetchLoggedUserMiddleware</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">FetchLoggedUserMiddleware</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Added <code>FetchLoggedUserMiddleware</code> middleware in the container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../middlewares/fetchLoggedUser.middleware</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is our <em>middleware</em> ready to be used.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_middleware">Using the middleware</h3>
<div class="paragraph">
<p>And now we just have to use the <em>middleware</em> in the <code>UsersController</code> . Here is an example for the <code>show</code> method:</p>
</div>
<div class="listingblock">
<div class="title">Use <code>FetchLoggedUserMiddleware</code> into user controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/controllers/home.controller.ts
<span class="err">//</span> ...
<span class="err">@controller('/users')</span>
export class UsersController {
  // ...
<span class="gd">-   @httpGet('/:userId', TYPES.FetchUserMiddleware)
</span><span class="gi">+   @httpGet('/:userId', TYPES.FetchLoggedUserMiddleware)
</span>  public async show(/* ... */) {
<span class="gi">+    if (Number(userId) !== req.user.id) {
+      return res.sendStatus(403);
+    }
</span>    return req.user;
  }
  // ...
<span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the changes are minimal because part of the logic is <strong>deported into the <em>middleware</em></strong>. You can also see that I put a straightforward check to prevent a user from viewing another user&#8217;s information.</p>
</div>
<div class="paragraph">
<p>The middleware allowed us to keep the logic in our controller very simple.</p>
</div>
<div class="paragraph">
<p>The principle is exactly the same for the <code>update</code> and <code>destroy</code> method.</p>
</div>
<div class="listingblock">
<div class="title">Adding <code>FetchLoggedUserMiddleware</code> updare</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/controllers/home.controller.ts
<span class="err">//</span> ...
<span class="err">@controller('/users')</span>
export class UsersController {
  // ...
<span class="gd">-  @httpPut('/:userId', TYPES.FetchUserMiddleware)
</span><span class="gi">+  @httpPut('/:userId', TYPES.FetchLoggedUserMiddleware)
</span>  public async update(/* ... */)&gt; {
<span class="gi">+    if (Number(userId) !== req.user.id) {
+      return res.sendStatus(403);
+    }
</span>    // ...
    return repository.save(req.user);
  }

-  @httpDelete('/:userId', TYPES.FetchUserMiddleware)
<span class="gi">+  @httpDelete('/:userId', TYPES.FetchLoggedUserMiddleware)
</span>  public async destroy(/* ... */) {
<span class="gi">+    if (Number(userId) !== req.user.id) {
+      return res.sendStatus(403);
+    }
</span>    const repository = await this.databaseService.getRepository(UserRepository);
    await repository.delete(req.user);
  }
<span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If all goes well. Our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test

  </span>TokensController
    create
       should get token <span class="o">(</span>41ms<span class="o">)</span>
       should not get token user with bad password
       should not create token with nonexisting email

  UsersController
    index
       should respond 200
    show
       should not show user other user
       should show my profile
    create
       should create user
       should not create user with missing email
    update
       should not update other user
       should update my profile
    destroy
       should not destroy other user
       should delete my profile

  User
     should <span class="nb">hash </span>password

  JsonWebTokenService
     should encode and decode payload

  isPasswordMatch
     should match
     should not match


  16 passing <span class="o">(</span>201ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s beautiful all this green, isn&#8217;t it?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try to do the same thing with <code>cURL</code>:</p>
</div>
<div class="listingblock">
<div class="title">Obtains JWT token and use it with <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/tokens
<span class="o">{</span><span class="s2">"token"</span>: <span class="s2">"eyJhbGciOiJIUzI1NiI..."</span><span class="o">}</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Authorization: eyJhbGciOiJIUzI1NiI..."</span> http://localhost:3000/users/1
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"8574a23599216d7752ef4a2f62..."</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect! And what happens if we try to access this road without an authorization?</p>
</div>
<div class="listingblock">
<div class="title">Try to access on protected endpoint without JWT token using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/users/1
You must provide an <span class="sb">`</span>Authorization<span class="sb">`</span> header</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. We were denied access as planned. It&#8217;s time to commit all our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add JWT middleware"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_4">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You did it! You&#8217;re halfway there! This chapter has been long and difficult, but it&#8217;s a big step forward in setting up a solid mechanism to handle user authentication. We&#8217;re even starting to scratch the surface for simple authorization rules.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will focus on customizing JSON output for the user and adding a product entity by giving the user the ability to create a product and publish it for sale.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter05-user-products" class="sect0">User&#8217;s products</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapter, we implemented the authentication mechanism that we will use throughout the application.</p>
</div>
<div class="paragraph">
<p>At the moment, we have a straightforward implementation of the <code>User</code> model, but the moment of truth has come. We are going to customize the JSON output and add a second resource: the user&#8217;s products. These are the elements that the user will sell in the application.</p>
</div>
<div class="paragraph">
<p>If you are familiar with an ORM, you may already know what I&#8217;m talking about. But for those who don&#8217;t, we will combine the <code>User</code> model with the <code>Product</code> model using the <code>@ManyToOne</code> and <code>@OneToMany</code> TypeORM decorators.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will build the <code>Product</code> model from scratch, associate it with the user, and create the necessary entries so that any client can access the information.</p>
</div>
<div class="paragraph">
<p>Before we start, and as usual, when we start new features, we create a new branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_product_model">The product model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will first create a <code>Product</code> model, then we will add some validations to it, and finally, we will associate it with the <code>User</code> model. Like the <code>User</code> entity, the <code>Product</code> will be fully tested and automatically deleted if the user is deleted.</p>
</div>
<div class="sect2">
<h3 id="_product_basics">Product basics</h3>
<div class="paragraph">
<p>The <code>Product</code> entity will need several fields: a <code>price</code> attribute for the price of the product, a <code>published</code> boolean to know if the product is ready to be sold or not, a <code>title</code> to define a sexy product title, and last but not least a <code>userId</code> to associate that particular product to a user:</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go directly to the implementation.</p>
</div>
<div class="listingblock">
<div class="title">Creation of the entity <code>Product</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">validateOrReject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">typeorm</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./user.entity</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">boolean</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">published</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Index</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">,</span> <span class="p">{</span> <span class="na">onDelete</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CASCADE</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">CreateDateColumn</span><span class="p">()</span>
  <span class="nx">createdAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">UpdateDateColumn</span><span class="p">()</span>
  <span class="nx">updatedAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">BeforeUpdate</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">validate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">validateOrReject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, this is very readable. The only new thing here is the appearance of the <code>ManyToOne</code> relationship. This is a decorator that will create a <code>userId</code> column of type <code>int</code>. It takes three parameters:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a function that returns the class corresponding to the association</p>
</li>
<li>
<p>a function that defines how the connection in the other direction is specified</p>
</li>
<li>
<p>an object containing various parameters</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I also added a <code>@Index</code> decorator to make this column indexed. This is a good practice for association keys because it optimizes database queries. It is not mandatory, but I highly recommend it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before we move on, we also need to define the <code>OneToMany</code> association in the <code>User</code> entity.</p>
</div>
<div class="listingblock">
<div class="title">Add products relation to user model</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Product</span><span class="p">,</span> <span class="p">(</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
  <span class="nx">products</span><span class="p">:</span> <span class="nx">Product</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Our association is done, and if you start the server with the TypeORM query logs, you should see the SQL query that creates the table:</p>
</div>
<div class="listingblock">
<div class="title">server logs in the terminal</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
<span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"product"</span> <span class="p">(</span><span class="nv">"id"</span> <span class="nb">integer</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"title"</span> <span class="nb">text</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"price"</span> <span class="nb">float</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"published"</span> <span class="nb">boolean</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"createdAt"</span> <span class="nb">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="p">(</span><span class="nb">datetime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">)),</span> <span class="nv">"updatedAt"</span> <span class="nb">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="p">(</span><span class="nb">datetime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">)),</span> <span class="s1">'userId'</span> <span class="nb">integer</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">CREATE</span> <span class="k">INDEX</span> <span class="nv">"IDX_329b8ae12068b23da547d3b479"</span> <span class="k">ON</span> <span class="nv">"product"</span> <span class="p">(</span><span class="s1">'userId'</span><span class="p">)</span>
<span class="n">query</span><span class="p">:</span> <span class="k">COMMIT</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Let&#8217;s make a <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Generate product model"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_product_validations">Product Validations</h3>
<div class="paragraph">
<p>As we have seen with the user, validations are an important part of building any application. This allows us to prevent unwanted data from being recorded in the database. For the product, we need to make sure, for example, that a price is a number and that it is not negative.</p>
</div>
<div class="paragraph">
<p>For this part, we don&#8217;t need to set up tests because everything is already available and tested by the library <a href="https://github.com/typestack/class-validator/"><code>class-validator</code></a>. We just need to add the corresponding decorators. Here is the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IsDefined</span><span class="p">,</span> <span class="nx">IsPositive</span><span class="p">,</span> <span class="nx">validateOrReject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">IsDefined</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span> <span class="na">nullable</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
  <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsPositive</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">IsDefined</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span><span class="p">,</span> <span class="na">nullable</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
  <span class="nx">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">boolean</span><span class="dl">"</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
  <span class="nx">published</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Index</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">,</span> <span class="p">{</span> <span class="na">onDelete</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CASCADE</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Decorators document the code, and there is not much to add here. I added the <code>nullable: false</code> property, which will modify the database schema and add a <code>NOT NULL</code> constraint.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s make these changes and keep moving forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds some validations to products"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_entry_point_for_our_products">Entry point for our products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now is the time to start building product entry points. For now, we will just build five REST actions.</p>
</div>
<div class="paragraph">
<p>First, we need to create the <code>ProductsController</code>. As a warm-up, we&#8217;ll start by building the <code>show</code> action for the product.</p>
</div>
<div class="sect2">
<h3 id="_product_show_action">Product Show Action</h3>
<div class="sect3">
<h4 id="_tests">Tests</h4>
<div class="paragraph">
<p>As usual, we start by adding some tests from the product controller. The purpose here is straightforward. Just display a single product and make sure that the server response is what we expect.</p>
</div>
<div class="paragraph">
<p>But to do this, we will first create a product and a user in the <code>before</code> method. So we&#8217;re going to refine our utility to create entities by adding <code>generateProduct</code>:</p>
</div>
<div class="listingblock">
<div class="title">Creating the <code>generateProduct</code> method</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">randomBytes</span><span class="p">(</span><span class="nx">size</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateProduct</span><span class="p">(</span><span class="nx">product</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newProduct</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">price</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">price</span> <span class="o">??</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">published</span> <span class="o">??</span> <span class="nx">randomBoolean</span><span class="p">();</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">title</span> <span class="o">??</span> <span class="nx">randomString</span><span class="p">();</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">user</span> <span class="o">??</span> <span class="nx">generateUser</span><span class="p">();</span>

  <span class="k">return</span> <span class="nx">newProduct</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will now use this method in the <code>before</code> of the new test below:</p>
</div>
<div class="listingblock">
<div class="title">Create a product in <code>products.controller.spec</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can use this product and to test if it can be showed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_2">Implementation</h4>
<div class="paragraph">
<p>Now that our test is in place, it&#8217;s time to take the test.</p>
</div>
<div class="paragraph">
<p>Just like we did with the users, we will create a middleware <code>FetchProductMiddleware</code>. It will just fetch the product according to the <code>productId</code> parameter and inject it into the request:</p>
</div>
<div class="listingblock">
<div class="title">Creating <code>FetchProductMiddleware</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchUser.middleware.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchProductMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">productId</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">productId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">productId</span><span class="p">),</span> <span class="p">{</span> <span class="na">relations</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">]</span> <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">product not found</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The small novelty here is the appearance of the <code>relation</code> parameter of the <code>findOne</code> method. This parameter also allows the user to retrieve the product and fill in the <code>product.user</code> property, which will be useful a little further on.</p>
</div>
<div class="paragraph">
<p>Now we can switch to the controller:</p>
</div>
<div class="listingblock">
<div class="title">Add <code>FetchProductMiddleware</code> to product controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{}</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">})</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait! Don&#8217;t run the tests yet. Don&#8217;t forget that we need to add the route to the container:</p>
</div>
<div class="listingblock">
<div class="title">Add <code>FetchProductMiddleware</code> type for dependency injection</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">FetchProductMiddleware</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">FetchProductMiddleware</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Register product controller and <code>FetchProductMiddleware</code> to container</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../controllers/products.controller</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FetchProductMiddleware</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we make sure the tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    show
       should show product
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect! We can now move on to the next one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add logic to show product"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_list_of_products">List of products</h3>
<div class="paragraph">
<p>It is now time to create an entry for a product list that could display the product catalog of a market, for example. For this access point, we do not require the user to be logged in. As usual, we will start writing some tests:</p>
</div>
<div class="listingblock">
<div class="title">Create functional test for product list endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span> <span class="nx">index</span> <span class="p">),</span> <span class="p">(</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should respond 200</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s move on to implementation, which for now is going to be a small process:</p>
</div>
<div class="listingblock">
<div class="title">Create product list endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following chapters, we will improve this entry point and give the possibility to receive parameters to filter them. Let&#8217;s go through these changes and keep moving forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add. <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add logic to list product"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_product_creation">Product creation</h3>
<div class="paragraph">
<p>Creating products is a bit more tricky because we&#8217;ll need an additional configuration. We will follow the strategy to assign the created product to the user who owns the supplied JWT token from the HTTP header <code>Authorization</code>.</p>
</div>
<div class="sect3">
<h4 id="_tests_2">Tests</h4>
<div class="paragraph">
<p>So our first stop will be the <code>products.controller.spec.ts</code> file. We will first create a specific user in the <code>before</code> and retrieve his JWT token:</p>
</div>
<div class="listingblock">
<div class="title">Creating and user and a valid JWT token in functional test</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The small novelty here is the appearance of the <code>relation</code> parameter of the <code>findOne</code> method.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the case where we create a product with a user</p>
</li>
<li>
<p>the case where a product cannot be created because it is incomplete</p>
</li>
<li>
<p>in case we do not provide a JWT token, and we cannot create the product</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here we go:</p>
</div>
<div class="listingblock">
<div class="title">Complete functional test suite of product creation</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should create product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create product without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create user with missing title</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wow! we added a lot of code. If you remember, the tests are actually the same as the user&#8217;s creation except for a few minor changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_3">Implementation</h4>
<div class="paragraph">
<p>So it&#8217;s time to take the test. The implementation is again very similar to the previous one in the user controller. With the difference that here we will retrieve the user associated with the JWT token and assign it to the product we are creating:</p>
</div>
<div class="listingblock">
<div class="title">Implementation of product creation</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">published</span><span class="p">;</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">price</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">price</span><span class="p">;</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. If you do the tests now, they should all pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    index
       should respond 200
    show
       should show product
    create
       should create product
       should not create product without auth
       should not create user with missing title
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_product_update">Product update</h3>
<div class="paragraph">
<p>I hope that now you understand the logic for building future actions. This section will focus on the update action that will work in a similar way to the creation action. We just need to get the product from the database and update it.</p>
</div>
<div class="paragraph">
<p>Before we start coding some tests, I just want to clarify that we will delimit the product to the current user in the same way as for the <code>create</code> action. We want to make sure that the product we are updating belongs to the user. So we&#8217;re going to look for that product in the <code>product.user</code> association.</p>
</div>
<div class="sect3">
<h4 id="_tests_3">Tests</h4>
<div class="paragraph">
<p>First of all, we add some tests. Here we will test three things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the case where the user actually owns the product</p>
</li>
<li>
<p>the case where the user does not own the product and therefore receives a <code>403 - Forbidden</code> response</p>
</li>
<li>
<p>the case without authentication</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To set up these tests, we will create a <code>product</code>, a <code>user</code> who owns the product, and a <code>stranger</code> user who will be a user not associated with the product:</p>
</div>
<div class="listingblock">
<div class="title">Create needed variable for functional tests about product controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">stranger</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">strangerJwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">stranger</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">strangerJwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">stranger</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This may sound abstract, but look at the implementation of the tests that will use these variables:</p>
</div>
<div class="listingblock">
<div class="title">Implementation of functional tests about update product endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">update</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should update product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not update product of other users</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">strangerJwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not update product without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The tests may seem complex, but at a glance they are almost identical to those of the users.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_4">Implementation</h4>
<div class="paragraph">
<p>Now let&#8217;s implement the code to pass our tests successfully:</p>
</div>
<div class="listingblock">
<div class="title">Implementation of product update endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span> <span class="nl">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">published</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">price</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">,</span> <span class="nx">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the implementation is quite simple. The Middleware will automatically retrieve the product and the user linked to the JWT token. All we have to do now is to verify that the user owns the product. This is what we do with the <code>canEditProduct</code> method. Then we update the product and save it after checking that it is valid of course.</p>
</div>
<div class="paragraph">
<p>If we run the tests, they should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    index
       should respond 200
    show
       should show product
    create
       should create product
       should not create product without auth
       should not create user with missing title
    update
       should update product
       should not update product of other <span class="nb">users</span>
       should not update product without auth
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_products">Deleting products</h3>
<div class="paragraph">
<p>Our last stop for the product road will be the <code>destroy</code> action. Now you can imagine what that would look like. The strategy here will be quite similar to the <code>create</code> and <code>update</code> action. This means that we will retrieve the logged-in user, then verify that the user has the product, and finally remove it by returning a 204 code.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by adding some tests:</p>
</div>
<div class="listingblock">
<div class="title">Functional tests about product delete endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">destroy</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should destroy product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not destroy product without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not destroy of other users</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">strangerJwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s just add the code needed to run the tests:</p>
</div>
<div class="listingblock">
<div class="title">Implementation to delete product endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpDelete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">destroy</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span> <span class="nl">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span>
      <span class="nx">ProductRepository</span>
    <span class="p">);</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the implementation does the job in three lines of code. We can run the tests to make sure everything is good.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
...
    destroy
       should destroy product
       should not destroy product without auth
       should not destroy of other <span class="nb">users</span>
...
  27 passing <span class="o">(</span>344ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, we commit changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the products create, update and destroy action"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_with_curl">Testing with cURL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our tests tell us that everything is fine, but it&#8217;s always good to make sure. So we&#8217;re going to create a user, then we&#8217;re going to create a product, update it and then delete it. Here we go.</p>
</div>
<div class="paragraph">
<p>Start your server with <code>npm start</code> if you haven&#8217;t already done so, and let&#8217;s start by creating a user:</p>
</div>
<div class="listingblock">
<div class="title">Creating an user using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.io"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test@test.io"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hashedPassword"</span><span class="p">:</span><span class="w"> </span><span class="s2">"8574a...69777b"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-11-25T20:37:20.000Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-11-25T20:37:20.000Z"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now let&#8217;s get a valid JWT token:</p>
</div>
<div class="listingblock">
<div class="title">Get a JWT token using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.io"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/tokens</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJ..."</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Write down this token and save it in a Bash variable:</p>
</div>
<div class="listingblock">
<div class="title">Initialize Bash variable with JWT token</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">JWT</span><span class="o">=</span><span class="s2">"eyJhbGciOiJ..."</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s use this token to create a product:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="nv">$JWT</span><span class="s2">"</span> <span class="nt">-d</span> <span class="s2">"title=my first product"</span> <span class="nt">-d</span> <span class="s2">"price=1"</span> http://localhost:3000/products</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my first product"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="c1">...</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can update it easily with the request <code>PUT</code>:</p>
</div>
<div class="listingblock">
<div class="title">Create a product using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> PUT <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="nv">$BASH</span><span class="s2">"</span> <span class="nt">-d</span> <span class="s2">"title=my first product undated"</span> <span class="nt">-d</span> <span class="s2">"price=66"</span> http://localhost:3000/products/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally remove this product:</p>
</div>
<div class="listingblock">
<div class="title">Delete a product using <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> DELETE <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="nv">$JWT</span><span class="s2">"</span> http://localhost:3000/products/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s perfect.</p>
</div>
<div class="paragraph">
<p>So it&#8217;s time to close this chapter and move on.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_5">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I hope you enjoyed this chapter. It&#8217;s a long job, but the code we&#8217;ve created is an excellent foundation for the main application.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will focus on customizing user and product entities output using the <a href="https://github.com/SeyZ/jsonapi-serializer">jsonapi-serializer</a> library. It will allow us to easily filter the attributes to be displayed and manage associations such as embedded objects.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter06-improve-json" class="sect0">Building JSON</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapter, we added the products to the application and built all the necessary roads. We also associated a product with a user and restricted some of the actions of <code>ProductsController</code>.</p>
</div>
<div class="paragraph">
<p>Now you should be satisfied with all this work. But we still have a lot of work ahead of us. Right now, we have a JSON output that is not perfect. The JSON output looks like this one:</p>
</div>
<div class="listingblock">
<div class="title">Current JSON output</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tag Case"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mf">98.77</span><span class="p">,</span><span class="w">
    </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"userId"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="w">
  </span><span class="p">},</span><span class="w">
</span><span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We want an output that does not contain the <code>userId</code>, <code>createdAt</code>, and <code>updatedAt</code> fields.</p>
</div>
<div class="paragraph">
<p>Moreover, an important and difficult part of creating your API is to decide on the output format. Fortunately, some organizations have already faced this kind of problem and have established certain conventions you will discover in this chapter.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start a new branch for this chapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter06</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_presentation_of_jsonapi">Presentation of <a href="https://jsonapi.org/">JSON:API</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As I said earlier, an important and difficult part of creating your API is to decide the output format. Fortunately, some conventions already exist.</p>
</div>
<div class="paragraph">
<p>One of them, certainly the most used, is <a href="https://jsonapi.org/">JSON:API</a>. The <a href="https://jsonapi.org/format/#document-structure">JSON:API documentation</a> gives us some rules to follow regarding the JSON document formatting.</p>
</div>
<div class="paragraph">
<p>Thus, our document <strong>must</strong> contain these keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code> which must contain the data we return</p>
</li>
<li>
<p><code>errors</code> which should contain a table of errors that have occurred.</p>
</li>
<li>
<p><code>meta</code> which contains a <a href="https://jsonapi.org/format/#document-meta">meta object</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The content of the <code>data</code> key is also quite strict:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it must have a <code>type</code> key that describes the JSON model&#8217;s type (if it&#8217;s an article, a user, etc.).</p>
</li>
<li>
<p>the object properties must be placed in an <code>attribute</code> key, and the <em>undescore</em> (<code>_</code>) is replaced by dashes (<code>-</code>).</p>
</li>
<li>
<p>the links of the objects must be placed in a <code>relationships</code> key</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this chapter we will customize the JSON output using the library <a href="https://github.com/SeyZ/jsonapi-serializer">jsonapi-serializer</a> which complies with all the standards <a href="https://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s install this dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>jsonapi-serializer
<span class="nv">$ </span>npm <span class="nb">install</span> @types/jsonapi-serializer <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You should be ready to continue with this tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serialize_user">Serialize user</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>jsonapi-serializer</code> uses <strong>serializers</strong>. Serializers represent methods that will be responsible for converting one object into another object that complies with the JSON:API standard.</p>
</div>
<div class="paragraph">
<p>We first need to add a <code>serializers.utils.ts</code> file that will contain all the serializers. And in the meantime, I start directly with the implementation of <code>userSerializer</code>:</p>
</div>
<div class="listingblock">
<div class="title">Serializer of <code>User</code> entity</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Serializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonapi-serializer</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">userSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">dataLinks</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">self</span><span class="p">:</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This <em>serializer</em> will allow us to convert our <code>User</code> object to JSON, which correctly implements the JSON:API standard. We have specified the <code>email</code> attribute to present in the <code>data</code> table. By listing the fields that we want to appear in, this library fixes the problem with our API&#8217;s <code>hashedPassword</code> attribute.</p>
</div>
<div class="paragraph">
<p>Now we just have to use this instance in our controller:</p>
</div>
<div class="listingblock">
<div class="title">Using <code>userSerializer</code> into user controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">userSerializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/serializers.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">userSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">userSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, it doesn&#8217;t change much! We simply import our serializer and use its <code>serialize</code> method.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try all this with <code>cURL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>curl http://localhost:3000/users</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test@test.io"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s make these changes and keep moving forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds user serializer for customizing the json output"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serialize_products">Serialize products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we understand how the serialization gem works, it&#8217;s time to customize the output. The first step is the same as for the user, we need a product serializer, so let&#8217;s do it:</p>
</div>
<div class="listingblock">
<div class="title">Implementation of <code>productSerializer</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">productsSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">price</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">published</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">],</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. It&#8217;s as simple as that. Let&#8217;s modify our controller a little bit.</p>
</div>
<div class="listingblock">
<div class="title">Using <code>productSerializer</code> into product controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">productsSerializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/serializers.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">})</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run the tests to check but they should still be good. Let&#8217;s make these small changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds product serializer for custom json output"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_serialize_associations">Serialize associations</h3>
<div class="paragraph">
<p>We have worked with serializers and you may notice that it is very simple. In some cases, the difficult decision is how to name your routes or how to structure the JSON output so that your solution is future-proof. When working with associations between models on an API, there are many approaches you can take.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t have to worry about this in our case, the JSON:API standard did it for us!</p>
</div>
<div class="paragraph">
<p>To summarize, we have a `has_many' type association between the user and the product model.</p>
</div>
<div class="listingblock">
<div class="title">Add products relationships to user entity</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Product</span><span class="p">,</span> <span class="p">(</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
  <span class="nx">products</span><span class="p">:</span> <span class="nx">Product</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Add user relationships to product entity</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">,</span> <span class="p">{</span> <span class="na">onDelete</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CASCADE</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a good idea to integrate users into the JSON outputs of the products. This will make the output heavier, but it will save the API client from executing further requests to retrieve user information related to the products. This method can really save you a huge bottleneck.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relationship_injection_theory">Relationship Injection Theory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imagine a scenario where you will search for products in the API, but in this case, you need to display some of the user information.</p>
</div>
<div class="paragraph">
<p>A possible solution would be to add the <code>userId</code> attribute to the <code>productSerializer</code> to retrieve the corresponding user later. This may sound like a good idea, but if you are concerned about performance or if your database transactions are not fast enough, you should reconsider this approach. You should understand that for each product you recover, you will need to recover its corresponding user.</p>
</div>
<div class="paragraph">
<p>Faced with this problem, there are several possible alternatives.</p>
</div>
<div class="sect2">
<h3 id="_embedding_in_a_meta_attribute">Embedding in a meta attribute</h3>
<div class="paragraph">
<p>A good solution, in my opinion is to integrate the user IDs linked to the products in a meta attribute, so we would have a JSON output as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"userIds"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="c">/* ... */</span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This may require additional configuration on the user&#8217;s terminal to retrieve its users from these <code>userIds</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_incorporate_the_object_into_the_attribute">Incorporate the object into the attribute</h3>
<div class="paragraph">
<p>Another solution is to incorporate the <code>user</code> object into the <code>product</code> object. This can make the first request a little slower, but this way, the client doesn&#8217;t need to make another request. An example of the expected results is shown below:</p>
</div>
<div class="listingblock">
<div class="title">Incorporate user relation into product attributes</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem with this approach is that we have to duplicate <code>User</code> objects for all products that belong to the same user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="c1">// ...</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="c1">// ...</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="c1">// ...</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="c1">// ...</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_incorporate_relationships_into_include">Incorporate relationships into <code>include</code></h3>
<div class="paragraph">
<p>The third solution, chosen by the JSON:API standard, is a mixture of the first two.</p>
</div>
<div class="paragraph">
<p>We will include all relations in an <code>include</code> key, which will contain all relations of the previously mentioned objects. Each object will also include a <code>relationships</code> key defining the relationship, which must be found in the <code>include</code> key.</p>
</div>
<div class="paragraph">
<p>One JSON is worth a thousand words:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="c">/* ... */</span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="c">/* ... */</span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You see the difference? This solution drastically reduces the size of the JSON and, therefore, the bandwidth used.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_of_the_relations_injection">Application of the relations injection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will, therefore, incorporate the user object into the product. Let&#8217;s start by adding some tests.</p>
</div>
<div class="paragraph">
<p>We will simply modify the <code>UsersController.show</code> test to verify that we recover:</p>
</div>
<div class="listingblock">
<div class="title">Add functional test to test <code>include</code> presence in JSON response</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">products</span> <span class="o">=</span> <span class="p">[</span><span class="nx">product</span><span class="p">];</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>

  <span class="c1">// ...</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">included</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">title</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now checking two things on the JSON that is returned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It contains the title of the product</p>
</li>
<li>
<p>user data is included in the <code>include</code> key</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You may also notice that I have created and linked a product to the user saved in the <code>beforeEach</code> method.</p>
</div>
<div class="paragraph">
<p>To pass this test, we will start by including the relationship in the serializer:</p>
</div>
<div class="listingblock">
<div class="title">Add relationship to user serializer</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">userSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">products</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">price</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">published</span><span class="dl">"</span><span class="p">],</span>
    <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span> <span class="k">as</span> <span class="kr">any</span><span class="p">);</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
at the time of this writing, I have not found any other way to get around the TypeScript typing error other than <code>as any</code>. Maybe the library will be updated soon.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This will add a <code>relationship</code> key containing the user&#8217;s ID and add an <code>include</code> key containing the relationship. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="js"><span class="p">{</span>
  <span class="nl">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">16</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ddf1bbe99c3a7ee8@random.io</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">products</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">products</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">15</span><span class="dl">'</span> <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">included</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">products</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">15</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">adc643eaa6bc1748</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">72.45882186217555</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is very simple: just add a line to the product serializer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test

  </span>ProductsController
...
    show
       should show product
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s make a commit to celebrate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add user relationship to product"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_retrieve_the_user_of_a_product">Retrieve the user of a product</h3>
<div class="paragraph">
<p>Have you understood the principle? We have included user information in the JSON of the products.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the test:</p>
</div>
<div class="listingblock">
<div class="title">Add functional test to test <code>include</code> presence in JSON response</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show product</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">included</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then build serializer:</p>
</div>
<div class="listingblock">
<div class="title">Add relationship to serializer</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">productsSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">price</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">published</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">},</span>
<span class="p">}</span> <span class="k">as</span> <span class="kr">any</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally update controller:</p>
</div>
<div class="listingblock">
<div class="title">Using serializer in product controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. We get a JSON of this shape:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="js"><span class="p">{</span>
  <span class="nl">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">products</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">d358a5c96b94a562</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">price</span><span class="p">:</span> <span class="mf">56.85800753546402</span><span class="p">,</span>
      <span class="na">published</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">3</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">included</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">3</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">email</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ddaf230c3d15a057@random.io</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It was really easy. Let&#8217;s make a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add user relationship to ProductsController.show"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_search_for_products">Search for products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This last section will continue to strengthen the <code>Products#index</code> action by implementing a straightforward search mechanism to allow any client to filter the results. This section is optional as it will have no impact on the modules of the application. But if you want to practice more with the TDD, I recommend that you complete this last step.</p>
</div>
<div class="paragraph">
<p>There are libraries to build advanced search forms extremely quickly. But here, since the goal is to learn and the search we&#8217;re going to do is straightforward, I think we can build a search engine from scratch. We just need to consider the criteria by which we&#8217;re going to filter the attributes. Hang on to your seats. It&#8217;s going to be a difficult journey.</p>
</div>
<div class="paragraph">
<p>So we&#8217;ll filter the products according to the following criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By title</p>
</li>
<li>
<p>By price</p>
</li>
<li>
<p>Sort by creation date</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It may seem short and easy, but trust me, it will give you a headache if you don&#8217;t plan it.</p>
</div>
<div class="paragraph">
<p>So we&#8217;re going to add a <code>search' method to the `ProductRepository</code> that will take the filters I just listed above as parameters:</p>
</div>
<div class="listingblock">
<div class="title">Add <code>ProductRepository.search</code> method</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span>
  <span class="c1">// need to be implemented</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// need to be implemented</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Can you see how we&#8217;re going to do it? Let&#8217;s start with the first filter.</p>
</div>
<div class="sect2">
<h3 id="_published_products">Published products</h3>
<div class="paragraph">
<p>As from the beginning of this book, we will start by writing the test that will test our new method. Here is the basic structure of our test which should look familiar to you:</p>
</div>
<div class="listingblock">
<div class="title">Add unit tests skeleton about <code>ProductRepository.search</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">ProductRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// will be implemented</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This test will require several existing database products that we will create by hand. Here is the structure of our test:</p>
</div>
<div class="listingblock">
<div class="title">Add some fixtures for unit tests</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">ProductRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">generateProduct</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/faker.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">tvPlosmo</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">computer</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">tvCheap</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">unpublishedProduct</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">tvPlosmo</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TV Plosmo Philopp</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">9999.99</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">}));</span>
      <span class="nx">computer</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Azos Zeenbok</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">499.99</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">}));</span>
      <span class="nx">tvCheap</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Cheap TV</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">99.99</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">}));</span>
      <span class="nx">unpublishedProduct</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="p">}));</span>
    <span class="p">});</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we have inserted in base 4 different products. In our first test we will call our method <code>ProductReposiroty.search</code> without parameters and we will check that no unpublished products are returned to us. Here is the test:</p>
</div>
<div class="listingblock">
<div class="title">Implementing unit tests about <code>ProductRepository.search</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not include unpublished products</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">({}).</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">every</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">published</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s start by defining our method for taking this test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span> <span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">()</span>
                      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">"</span><span class="s2">published = TRUE</span><span class="dl">"</span><span class="p">)</span>
                      <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="dl">"</span><span class="s2">updatedAt</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DESC</span><span class="dl">"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. The test should pass. Let&#8217;s go to our first filter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_by_title">By title</h3>
<div class="paragraph">
<p>Now that the structure of our testing and implementation is in place, everything will go faster. Here&#8217;s the test for the filter, which is very similar to the previous one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should filter products by title</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">({</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">tv</span><span class="dl">"</span> <span class="p">}).</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvPlosmo</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">computer</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following tests ensure that the method will correctly search for products based on their titles. We use the term <code>tv</code> in lower case to ensure that our search will not be case sensitive.</p>
</div>
<div class="paragraph">
<p>The implementation is straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span>
  <span class="nl">title</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">"</span><span class="s2">lower(title) LIKE :title</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="s2">`%</span><span class="p">${</span><span class="nx">filters</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="s2">%`</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is sufficient for our tests to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
....
  ProductRepository
    search
       should not include unpublished products
       should filter products by title
....</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_by_price">By price</h3>
<div class="paragraph">
<p>To filter by price, things can get a little trickier. We will separate the logic of filtering by price into two different methods: one that will look for products that are larger than the price received and the other that will look for those below that price. This way, we will keep some flexibility, and we can easily test the scope.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by building the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should filter products by priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span>
        <span class="p">.</span><span class="nx">search</span><span class="p">({</span><span class="na">priceMax</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvCheap</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvPlosmo</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should filter products by priceMin</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span>
        <span class="p">.</span><span class="nx">search</span><span class="p">({</span><span class="na">priceMin</span><span class="p">:</span> <span class="mi">500</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvPlosmo</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvCheap</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span>
  <span class="nl">title</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">priceMin</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">priceMax</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">priceMin</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">"</span><span class="s2">price &gt;= :priceMin</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">priceMin</span><span class="p">:</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">priceMin</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">priceMax</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">"</span><span class="s2">price &lt;= :priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">priceMax</span><span class="p">:</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">priceMax</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is sufficient for our tests to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductRepository
    search
       should not include unpublished products
       should filter products by title
       should filter products by priceMax
       should filter products by priceMin
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Great. The last step is to integrate it with our controller.</p>
</div>
</div>
<div class="sect2">
<h3 id="_integration_into_the_controller">Integration into the controller</h3>
<div class="paragraph">
<p>As usual, we will start with the tests. This will help us define the implementation of our endpoint.</p>
</div>
<div class="paragraph">
<p>As with the previous tests, we will create two specific products to search for using the different filters we have just implemented. The test will, therefore, look very familiar to you.</p>
</div>
<div class="paragraph">
<p>We will define a new <code>describe</code> that will group our two tests together. Let&#8217;s start with the <code>beforeEach</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="na">computer</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
      <span class="kd">let</span> <span class="na">tvCheap</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

      <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">computer</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
          <span class="nx">generateProduct</span><span class="p">({</span>
            <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Azos Zeenbok</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">price</span><span class="p">:</span> <span class="mf">499.99</span><span class="p">,</span>
            <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="p">})</span>
        <span class="p">);</span>
        <span class="nx">tvCheap</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
          <span class="nx">generateProduct</span><span class="p">({</span>
            <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Cheap TV</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">price</span><span class="p">:</span> <span class="mf">99.99</span><span class="p">,</span>
            <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="p">})</span>
        <span class="p">);</span>
      <span class="p">});</span>
    <span class="c1">// ...</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s move on to the tests themselves:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ...</span>
      <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should find cheap TV</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">();</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">tv</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">priceMin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">50</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">150</span><span class="dl">"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">agent</span>
          <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products?</span><span class="p">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nb">String</span><span class="p">(</span><span class="nx">tvCheap</span><span class="p">.</span><span class="nx">id</span><span class="p">))));</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should find computer</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">();</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">azos</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">500</span><span class="dl">"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">agent</span>
          <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products?</span><span class="p">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nb">String</span><span class="p">(</span><span class="nx">computer</span><span class="p">.</span><span class="nx">id</span><span class="p">)),</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">body</span>
            <span class="p">);</span>
          <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
we build the parameters with the <a href="https://developer.mozilla.org/fr/docs/Web/API/URLSearchParams"><code>URLSearchParams</code></a> class. Then just use the <code>toString</code> method, which will build the <code>GET</code> parameters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When we receive the answer, we check that the product we are looking for is present. Quite simply.</p>
</div>
<div class="paragraph">
<p>The implementation of the controller is straightforward. Just use our new method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">).</span><span class="nx">getMany</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can run the entire test suite to make sure the application is healthy so far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">npm <span class="nb">test
  </span>ProductsController
    index
       should respond 200 <span class="o">(</span>47ms<span class="o">)</span>
      search
         should find cheap TV
         should find computer
...
  33 passing <span class="o">(</span>786ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Great! Let&#8217;s make these changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search class method to filter products"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we come to the end of our chapter, it&#8217;s time to apply all our changes to the master branch by doing a merge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter06</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_6">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Until now, and thanks to the library <a href="https://github.com/SeyZ/jsonapi-serializer/">jsonapi-serializer</a>, it was easy. In the coming chapters, we will start building the <code>Order</code> model that will associate users with the products.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter07-placing-orders" class="sect0">Placing Orders</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the previous chapters, we have dealt with associations between products and users. We have also seen how to serialize them well by optimizing them to be able to <em>scale</em>, (i.e., easily adapt to high demand on our application). Now it&#8217;s time to start placing orders. This will be a more complex situation because we are going to manage the associations between the three models. We need to be smart enough to handle the JSON output we provide.</p>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;re going to do several things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an order entity with the corresponding specifications</p>
</li>
<li>
<p>Manage the JSON output association between the order user and product models</p>
</li>
<li>
<p>Send a confirmation email with the order summary</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now that everything is clear, we can start working. Let&#8217;s create a new branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_order_modeling">Order modeling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you remember the models associations entities, <code>Order</code> entity is associated with the <code>User</code> and <code>Product</code> entities. It&#8217;s actually straightforward to manage this with Rails. The tricky part is when serializing these objects. I&#8217;ll talk about it in more detail later.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by creating the model of the order. It will have two <code>ManyToOne</code> relationships: <code>User</code> and <code>Product</code>. It will also have a <code>total</code> column for the order&#8217;s total cost and then the classic <code>createdAt</code> and <code>updatedAt</code> columns. Here is the full implementation.</p>
</div>
<div class="listingblock">
<div class="title">First implementation of <code>Order</code> entity</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/order.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IsDefined</span><span class="p">,</span> <span class="nx">IsPositive</span><span class="p">,</span> <span class="nx">validateOrReject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Order</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">orders</span><span class="p">)</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsNumber</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ValidateIf</span><span class="p">((</span><span class="nx">total</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">total</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span><span class="p">,</span> <span class="na">unsigned</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="nx">total</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">CreateDateColumn</span><span class="p">()</span>
  <span class="nx">createdAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">UpdateDateColumn</span><span class="p">()</span>
  <span class="nx">updatedAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">BeforeUpdate</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">validate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">validateOrReject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Order</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrderRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Order</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the implementation brings nothing new compared to what we have already seen.</p>
</div>
<div class="paragraph">
<p>I took the opportunity to add the <code>ValidateIf</code> constraint on the <code>total</code> field, which is a `number unsigned'. This means that it cannot be negative.</p>
</div>
<div class="paragraph">
<p>But before we forget, we must also define the relationship on the <code>User</code> side:</p>
</div>
<div class="listingblock">
<div class="title">Add order relationship to user</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./order.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Order</span><span class="p">,</span> <span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
  <span class="nx">orders</span><span class="p">:</span> <span class="nx">Order</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect! We are ready to move on. Let&#8217;s make a commit before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Generate orders"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_orders_and_products">Orders and products</h3>
<div class="paragraph">
<p>We have to establish the link between orders and products. This is done with a <em>many-to-many</em> association because many products will be placed on several orders, and orders will have several products. In this case, we, therefore, need an additional entity that will join these two other objects and map the appropriate association. Here is the implementation:</p>
</div>
<div class="listingblock">
<div class="title">The new entity who join <code>order</code> and <code>product</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/placement.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Placement</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Product</span><span class="p">,</span> <span class="p">(</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">product</span><span class="p">.</span><span class="nx">placements</span><span class="p">)</span>
  <span class="nx">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Order</span><span class="p">,</span> <span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span><span class="p">)</span>
  <span class="nx">order</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">BeforeUpdate</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">validate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">validateOrReject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Placement</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Addition of the <code>Placements</code> relationship to the <code>Product</code> model.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Placement</span><span class="p">,</span> <span class="p">(</span><span class="nx">placement</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">product</span><span class="p">)</span>
  <span class="nx">placements</span><span class="p">:</span> <span class="nx">Placement</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Addition of the <code>Placements</code> relationship to the <code>Order</code> model.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/order.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Order</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Placement</span><span class="p">,</span> <span class="p">(</span><span class="nx">placement</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">order</span><span class="p">)</span>
  <span class="nx">placements</span><span class="p">:</span> <span class="nx">Placement</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Good! Let&#8217;s commit changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Associates products and orders with a placements model"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_expose_the_user_model">Expose the user model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now it&#8217;s time to prepare the order controller to expose the right orders. If you remember the previous chapters where we used <a href="https://github.com/SeyZ/jsonapi-serializer/">jsonapi-serializer</a> you have to remember that it was straightforward.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first define what actions we are going to implement:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An indexing action to retrieve current user orders</p>
</li>
<li>
<p>A show action to retrieve a particular order from the current user</p>
</li>
<li>
<p>Creative action to actually place the order</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the <code>index</code> action. First, we need to create the order controller. But before we start typing code, we need to ask ourselves:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Should I leave my order routes nested in the <code>UsersController</code>, or should I isolate them?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The answer is straightforward: it depends on how much information you want to expose to the developer.</p>
</div>
<div class="paragraph">
<p>In our case, we&#8217;re not going to do that because we will retrieve the user orders on the <code>/orders</code> route. Let&#8217;s start with some tests:</p>
</div>
<div class="listingblock">
<div class="title">Functional tests of the method <code>OrdersController.index</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrdersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">orderRepository</span><span class="p">:</span> <span class="nx">OrderRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">stranger</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">strangerJwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">order</span><span class="p">:</span> <span class="nx">Order</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="nx">orderRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>

    <span class="nx">stranger</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">strangerJwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">stranger</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">orderRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should forbid orders without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">));</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should get orders of user</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(({</span> <span class="nx">body</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">some</span><span class="p">(({</span> <span class="nx">id</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">id</span> <span class="o">===</span> <span class="nb">String</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">)))));</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation <code>generateOrder</code> test utility</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="nx">min</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">max</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span> <span class="kr">number</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">)</span> <span class="o">+</span> <span class="nx">min</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateOrder</span><span class="p">(</span><span class="nx">order</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Order</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">Order</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newOrder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Order</span><span class="p">();</span>
  <span class="nx">newOrder</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">order</span><span class="p">?.</span><span class="nx">user</span> <span class="o">??</span> <span class="nx">generateUser</span><span class="p">();</span>
  <span class="nx">newOrder</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// TODO</span>

  <span class="k">return</span> <span class="nx">newOrder</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation of this test should remind you of <code>product.controller.spec.ts</code>. We try to access the new <code>endpoint</code> with a user with an <code>Order</code> and check that this order appears in the JSON return.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You may have noticed the syntax <code>({body}) =&gt; &#8230;&#8203;</code>. This is the functionality of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax">spread syntax</a>. It simply allows you to retrieve a property contained in an object directly from a variable of the same name. Thus <code>const data = {a: 1}; const a = data.a;</code> can be simplified to <code>const { a } = {a: 1}</code>. This syntax can be confusing at first so I preferred to use it rather than from this chapter on.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we run the test suite now, as you might expect, both tests will fail. This is normal because we haven&#8217;t even defined the controller or even the order-specific serializer. So let&#8217;s do it.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start with the serializer:</p>
</div>
<div class="listingblock">
<div class="title">Create serialize for order</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">ordersSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">total</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">createdAt</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">updatedAt</span><span class="dl">"</span><span class="p">],</span>
<span class="p">}</span> <span class="k">as</span> <span class="kr">any</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can use it in our brand new controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">ordersSerializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/serializers.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">})</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">orders</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">user</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">ordersSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">orders</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the first decorator <code>@controller</code>, we globally inject the middleware <code>FetchLoggedUserMiddleware</code>. This means that we will have to give a JWT token to access all this controller&#8217;s actions. This allows us to retrieve the user in the <code>index</code> method and use it directly in the <code>find</code> method. We use the serializer to format the data and return it.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s not forget to load our controller since it is a brand new controller:</p>
</div>
<div class="listingblock">
<div class="title">Import order controller into container</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../controllers/orders.controller</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
    index
       should forbid orders without auth <span class="o">(</span>44ms<span class="o">)</span>
       should get orders of user
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We like our commits very small. So let&#8217;s commit now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds the index action for order"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_display_a_single_order">Display a single order</h3>
<div class="paragraph">
<p>As you can already imagine, this route is straightforward. We just have to set up some configurations (routes, controller action) and a new <em>middleware</em> that will take care of retrieving the order, and that will be all for this section. Later we will include the products related to this order in the output JSON.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by adding some tests:</p>
</div>
<div class="listingblock">
<div class="title">Functional test about get order information endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrdersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should forbid show order for other users</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/orders/</span><span class="p">${</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">strangerJwt</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show order</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/orders/</span><span class="p">${</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(({</span> <span class="nx">body</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">)));</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s move on to implementation. We will start by creating a middleware that will search for the order according to the parameter. The code is really very similar to <code>FetchProductMiddleware</code> so I&#8217;ll skip over it a bit faster:</p>
</div>
<div class="listingblock">
<div class="title">Creating the <code>FetchOrderMiddleware</code>.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchUser.middleware.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchOrderMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">order</span><span class="p">:</span> <span class="nx">Order</span> <span class="p">},</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">orderId</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">orderId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">orderId</span><span class="p">),</span> <span class="p">{</span>
      <span class="na">relations</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">],</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">order</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">order not found</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Addition of <code>Symbol</code> for injection into the container.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">FetchOrderMiddleware</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">FetchOrderMiddleware</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Adding <code>FetchOrderMiddleware</code> into container.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchOrderMiddleware</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FetchOrderMiddleware</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All our tests now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test
  </span>OrderController
    index
       should forbid orders without auth <span class="o">(</span>44ms<span class="o">)</span>
       should get orders of user
    show
       should forbid show order <span class="k">for </span>other <span class="nb">users</span>
       should show orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit changes and move on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the show action for order"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_placement_and_orders">Placement and orders</h3>
<div class="paragraph">
<p>Now it is time to give the user the possibility to place some orders. This will add complexity to the application but don&#8217;t worry. We&#8217;ll take it one step at a time.</p>
</div>
<div class="paragraph">
<p>Before launching this feature, let&#8217;s take some time to think about the implications of creating a order in the application. I&#8217;m not talking about setting up a transaction service like <a href="https://stripe.com/">Stripe</a> or <a href="https://www.braintreepayments.com/">Braintree</a> but things like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the management of out-of-stock products</p>
</li>
<li>
<p>Decrease in product inventory</p>
</li>
<li>
<p>add some validation for order placement to ensure that there are enough products at the time the order is placed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It looks like there&#8217;s still a lot to do but trust me: you&#8217;re closer than you think, and it&#8217;s not as hard as it looks. For now, let&#8217;s keep things simple and assume we still have enough products to place any number of orders. We&#8217;re just concerned about the response from the server at the moment.</p>
</div>
<div class="paragraph">
<p>If you remember the order entity, we need three things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a total for the order</p>
</li>
<li>
<p>the user placing the order</p>
</li>
<li>
<p>order&#8217;s products.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Given this information, we can start adding some tests:</p>
</div>
<div class="listingblock">
<div class="title">Add functional tests to order creation endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrderController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">create</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">product1</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">product2</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">product1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>
      <span class="nx">product2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should create order</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="na">productIds</span><span class="p">:</span> <span class="p">[</span><span class="nx">product1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">product2</span><span class="p">.</span><span class="nx">id</span><span class="p">]})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">));</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not create product without auth</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="na">productIds</span><span class="p">:</span> <span class="p">[</span><span class="nx">product1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">product2</span><span class="p">.</span><span class="nx">id</span><span class="p">]})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">));</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not create order with missing title</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">).</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="na">productIds</span><span class="p">:</span> <span class="p">[]}).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">));</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, we will create tests that cover all possible cases. Respectively:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when everything goes well</p>
</li>
<li>
<p>when the user has not sent the necessary parameters</p>
</li>
<li>
<p>when the user has not specified his JWT token</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you can see in the first case, the user sends a table of the products he wants to add to his order. So we go to the controller:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>retrieve the list of associated products via the IDs</p>
</li>
<li>
<p>calculate the total sum of these products</p>
</li>
<li>
<p>Create the <code>Order</code>.</p>
</li>
<li>
<p>create <code>Placements</code> associated with this order</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It sounds complicated, but look at the implementation:</p>
</div>
<div class="listingblock">
<div class="title">Handle multiples products in order creation</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="p">{</span><span class="nl">productIds</span><span class="p">:</span> <span class="kr">number</span><span class="p">[]},</span> <span class="p">{</span><span class="nx">user</span><span class="p">}:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">},</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">orderRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">placementRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">PlacementRepository</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">productIds</span><span class="p">?.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="na">errors</span><span class="p">:</span> <span class="p">{</span><span class="na">productIds</span><span class="p">:</span> <span class="dl">'</span><span class="s1">should be an array of products ids</span><span class="dl">'</span><span class="p">}});</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">findByIds</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">productIds</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">products</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">orderRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">user</span><span class="p">,</span> <span class="nx">total</span><span class="p">});</span>

    <span class="kd">const</span> <span class="nx">placements</span> <span class="o">=</span> <span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">}));</span>
    <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">placementRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">placements</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now our tests should all pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
...
    create
       should create order
       should not create product without auth
       should not create order with missing title</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit our changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the create method for the orders controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_send_a_confirmation_email">Send a confirmation email</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last section of this chapter will send a confirmation email to the user who has just created an order. If you want, you can skip this step and go to the next chapter! This section is more of a bonus.</p>
</div>
<div class="paragraph">
<p>So we will use the library <a href="https://nodemailer.com/">nodemailer</a>. So let&#8217;s install the library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>nodemailer
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">--save-dev</span> @types/nodemailer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s create a new service that will interface between the library and our code. As I said before, it&#8217;s always a good idea to do this because it will allow us to <strong>Mock</strong> this feature during our tests. Don&#8217;t worry, we&#8217;ll talk about it later.</p>
</div>
<div class="listingblock">
<div class="title">Implementation of a service interfacing to nodemailer.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/mailer.service.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">createTestAccount</span><span class="p">,</span> <span class="nx">createTransport</span><span class="p">,</span> <span class="nx">SendMailOptions</span><span class="p">,</span> <span class="nx">Transporter</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">nodemailer</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Logger</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./logger.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MailerService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">static</span> <span class="nx">transporter</span><span class="p">:</span> <span class="nx">Transporter</span><span class="p">;</span>

  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">SendMailOptions</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">initializeTransporter</span><span class="p">();</span>
    <span class="k">await</span> <span class="nx">MailerService</span><span class="p">.</span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">async</span> <span class="nx">initializeTransporter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">MailerService</span><span class="p">.</span><span class="nx">transporter</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="p">{</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pass</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">createTestAccount</span><span class="p">();</span>

    <span class="nx">MailerService</span><span class="p">.</span><span class="nx">transporter</span> <span class="o">=</span> <span class="nx">createTransport</span><span class="p">({</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">"</span><span class="s2">smtp.ethereal.email</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="mi">587</span><span class="p">,</span>
      <span class="na">secure</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">auth</span><span class="p">:</span> <span class="p">{</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pass</span> <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, our service does not do much. We just initialize here a <code>transporter</code> that allows you to connect to an SMTP account. You can use the mail account of your choice and move the values to the <code>.env</code> file, but I chose to use the <code>createTestAccount</code> method, which allows you to create a test account on the fly.</p>
</div>
<div class="paragraph">
<p>And since we just created a service, we need to add it to the container:</p>
</div>
<div class="listingblock">
<div class="title">Add mailer service to inversify types</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">MailerService</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">MailerService</span><span class="dl">"</span><span class="p">),</span>
  <span class="c1">// ...</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bind mailer service to inversify container</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">MailerService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">MailerService</span><span class="p">);</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. I think it&#8217;s a good idea to add the product&#8217;s mail in the <code>MailerService</code>. On the other hand, we have to be careful that this service doesn&#8217;t become too big as we extend our application and don&#8217;t hesitate to cut it again if necessary. In our case, this is not a problem. So here is the method:</p>
</div>
<div class="listingblock">
<div class="title">Implement method to send an email about brand new order</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/mailer.service.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MailerService</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">sendNewOrderEmail</span><span class="p">(</span><span class="nx">order</span><span class="p">:</span> <span class="nx">Order</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productText</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`- </span><span class="p">${</span><span class="nx">p</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">`Details of products:\n</span><span class="p">${</span><span class="nx">productText</span><span class="p">}</span><span class="s2">\nTOTAL:</span><span class="p">${</span><span class="nx">order</span><span class="p">.</span><span class="nx">total</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">({</span>
      <span class="na">to</span><span class="p">:</span> <span class="nx">order</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="nx">text</span><span class="p">,</span>
      <span class="na">subject</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Thanks for order</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now call this method directly to our controller:</p>
</div>
<div class="listingblock">
<div class="title">Call <code>MailerService.sendNewOrderEmail</code> into order controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">mailerService</span><span class="p">.</span><span class="nx">sendNewOrderEmail</span><span class="p">(</span><span class="nx">order</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there it is!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If our application grows, it would be more interesting to use a library specialized in job management such as <a href="https://github.com/graphile/worker">graphile-worker</a> to postpone the email sending. This would also allow us to prioritize the tasks and restart later the tasks that didn&#8217;t work. In our case, I didn&#8217;t set it up to keep this tutorial simpler.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s run the tests to be sure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
...
    create
      1<span class="o">)</span> should create order
       should not create product without auth
       should not create order with missing title
...

  1<span class="o">)</span> OrderController
       create
         should create order:
     Error: Timeout of 2000ms exceeded.</code></pre>
</div>
</div>
<div class="paragraph">
<p>We find that our test no longer works because it exceeds the time allotted for a test. We could increase the time allocated to this test with the <code>setTimeout</code> method, but it is not optimal. But don&#8217;t worry, we have a straightforward solution offered by the dependency injection we have implemented since the beginning: <strong>a Mock</strong>.</p>
</div>
<div class="paragraph">
<p>So the idea is to create a class that implements the features of the <code>MailerService</code> but behaves the way we want it to specifically in the given context. That is, we want the emails not to be sent during tests. It sounds complicated, but it&#8217;s actually effortless:</p>
</div>
<div class="listingblock">
<div class="title">Create a new service that extends mailer service but does nothing</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/tests/fakeMailer.service.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">SendMailOptions</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">nodemailer</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">MailerService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/mailer.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FakeMailerService</span> <span class="kd">extends</span> <span class="nx">MailerService</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">SendMailOptions</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{}</span>
  <span class="k">protected</span> <span class="k">async</span> <span class="nx">initializeTransporter</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And just <code>rebind</code> the service at the beginning of our test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrderController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">MailerService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FakeMailerService</span><span class="p">);</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
    <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There you go, our tests should pass again.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s commit everything we just did to finish this section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds order confirmation mailer"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we come to the end of our chapter, it&#8217;s time to apply all our changes to the master branch by doing a merge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_7">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>That&#8217;s it! You did it! You can applaud each other. I know it&#8217;s been a long time, but it&#8217;s almost over, believes me.</p>
</div>
<div class="paragraph">
<p>In the chapters to come, we will continue to work on the order entity to add validations when placing an order. Some scenarios are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What happens when the products are not available?</p>
</li>
<li>
<p>Decrease the quantity of the current product when placing an order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next chapter will be short, but it is essential for the health of the application. So don&#8217;t skip it.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter08-improve_orders" class="sect0">Improving orders</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Previously we improved our API to place orders and send a confirmation email to the user (just to improve the user experience). This chapter will take care of some validations on the order entity to make sure it is valid. That is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decrease the quantity of the current product when creating an order</p>
</li>
<li>
<p>manage the case where the product is not available</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will also need to update the JSON output for orders a little bit. But let&#8217;s not divulge the rest.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a new branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter08</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_decrease_the_quantity_of_product">Decrease the quantity of product</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this part, we will update the product quantity to ensure that each order will deliver the actual product.</p>
</div>
<div class="sect2">
<h3 id="_adding_the_product_total_attribute">Adding the <code>product.total</code> attribute</h3>
<div class="paragraph">
<p>We will first add a <code>total</code> field on the product, representing the available stock of the product.</p>
</div>
<div class="listingblock">
<div class="title">Add <code>total</code> column to products</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">integer</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  <span class="nx">quantity</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This field must also be available when creating the product. So we need to update our controller:</p>
</div>
<div class="listingblock">
<div class="title">Handle <code>quantity</code> attribute in products creation endpoint</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/products</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">quantity</span><span class="p">);</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also need to update the <code>generateProduct</code> method, which must handle this new attribute:</p>
</div>
<div class="listingblock">
<div class="title">Handle <code>quantity</code> attribute in tests utilities</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateProduct</span><span class="p">(</span><span class="nx">product</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">quantity</span> <span class="o">??</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have to check that the total can never be less than zero. This will secure our application and prevent an order from being placed if there is no stock on the product.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s start by adding a test that will describe the desired behavior:</p>
</div>
<div class="listingblock">
<div class="title">Implement a tests to ensure a negative quantity is not valid</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">ProductRepository</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">validate</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should have a positive quantity</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">({</span><span class="na">quantity</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">});</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="dl">'</span><span class="s1">Should not validate product</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">error</span><span class="p">.</span><span class="nx">property</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">quantity</span><span class="dl">'</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Passing the test is very easy thanks to the <code>class-validator</code> decorators. Just add the decorators <code>@IsInt</code> and <code>@Min</code> like this:</p>
</div>
<div class="listingblock">
<div class="title">Add product quantity validation</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">IsInt</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">integer</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  <span class="nx">quantity</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see it&#8217;s really very simple and the code is very readable. And that&#8217;s it. Let&#8217;s start the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add quantity to products"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_the_functional_test_3">Setting up the functional test</h3>
<div class="paragraph">
<p>Before we start going further, we need to change the way we handle order creation because we now have to consider a quantity for each product. If you remember, until now, we have been waiting for a table of product identifiers. I&#8217;ll try to keep things simple, and we will now accept an object table containing the attributes <code>id</code> and <code>quantity</code>. A quick example would be something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">const</span> <span class="nx">productOrderParams</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">5</span> <span class="p">}</span>
<span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s start by modifying our functional test about the order controller:</p>
</div>
<div class="listingblock">
<div class="title">Update functional test about order creation with new params</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrderController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">productsParams</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">product1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>
      <span class="kd">const</span> <span class="nx">product2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>

      <span class="nx">productsParams</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">product1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">product2</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
      <span class="p">];</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should create order</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="na">products</span><span class="p">:</span> <span class="nx">productsParams</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">));</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we have simply updated the parameters we pass to the query.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s recap what we need to change in the controller. We need to find the product associated with the <code>id</code> in the table that creates the <code>placements</code>. Let&#8217;s see the implementation of the controller:</p>
</div>
<div class="listingblock">
<div class="title">Implementation to handle multiple products in orders controller</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="p">{</span><span class="nl">products</span><span class="p">:</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span> <span class="nl">quantity</span><span class="p">:</span> <span class="kr">number</span><span class="p">}[]},</span>
    <span class="c1">// ...</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span><span class="nx">manager</span><span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">products</span><span class="p">?.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">errors</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">products</span><span class="p">:</span> <span class="dl">'</span><span class="s1">should be an array of `{id, quantity}`</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user</span><span class="p">,</span>
      <span class="na">total</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">placements</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span> <span class="k">as</span> <span class="nx">Order</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="p">{</span><span class="nx">id</span><span class="p">,</span> <span class="nx">quantity</span><span class="p">}</span> <span class="k">of</span> <span class="nx">body</span><span class="p">.</span><span class="nx">products</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">placement</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Placement</span><span class="p">();</span>
      <span class="nx">placement</span><span class="p">.</span><span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="p">});</span>
      <span class="nx">placement</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="nx">order</span><span class="p">;</span>
      <span class="nx">placement</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">=</span> <span class="nx">quantity</span><span class="p">;</span>

      <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="nx">placement</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wow. The code is getting a bit longer and deserves some explanations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>we create the order with a total equal to zero (We will see in the next section how to make this total update automatically).</p>
</li>
<li>
<p>we check the user&#8217;s data by checking that <code>req.body.products</code> contains values</p>
</li>
<li>
<p>we make a loop on <code>req.body.products</code> in which we retrieve the product, create an <code>Investment</code>, and add it to the <code>order.investments</code> table</p>
</li>
<li>
<p>the rest remains unchanged</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_subscriber">The subscriber</h3>
<div class="paragraph">
<p>It is now time to update the product quantity once an order is placed.</p>
</div>
<div class="paragraph">
<p>We would be tempted to do this quickly in the <code>OrderController.create</code> action, but that would be a bad idea because we would have to duplicate this logic on the <code>OrderController.update</code> and <code>OrderController.destroy</code> actions, which must also update the product quantity. It also goes against the good practice to minimize the responsibility of the controllers.</p>
</div>
<div class="paragraph">
<p>That&#8217;s why I think a <a href="https://github.com/typeorm/typeorm/blob/master/docs/listeners-and-subscribers.md"><strong>Subscribers from TypeORM</strong></a> is a much better place for the simple reason that we are sure that our subscriber will be called no matter what happens without us having to worry about it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It would be possible to use the <strong>entity listeners</strong> as <code>@afterInsert</code> on the <code>UserRepository.validate</code> method, but I really recommend using the <em>subscriber</em> when we want to manipulate multiple entity types. This allows us to better split our code and not make one class depend on another.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The behavior we will implement is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when a placement is created</p>
</li>
<li>
<p>we remove <code>placement.quantity</code> from the attribute <code>product.quantity</code>.</p>
</li>
<li>
<p>we recalculate the total cost of the order</p>
</li>
<li>
<p>when an investment is created</p>
</li>
<li>
<p>we add <code>placement.quantity</code> to the attribute <code>product.quantity</code>.</p>
</li>
<li>
<p>we recalculate the total cost of the order</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The subscriber will materialize into a class that extends <code>EntitySubscriberInterface</code>. If we take a closer look at this interface, we see that we have access to a bunch of methods:</p>
</div>
<div class="listingblock">
<div class="title">Some methods of the <code>EntitySubscriberInterface</code> interface</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// node_modules/typeorm/subscriber/EntitySubscriberInterface.d.ts</span>
<span class="k">export</span> <span class="kr">interface</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Entity</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">beforeInsert</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">afterInsert</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">beforeUpdate</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">UpdateEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">afterUpdate</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">UpdateEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">beforeRemove</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">afterRemove</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we can create a brand new class who implements <code>EntitySubscriberInterface</code>:</p>
</div>
<div class="listingblock">
<div class="title">Create <code>PlacementSubscriber</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/order.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Placement</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/placement.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">EventSubscriber</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementSubscriber</span>
  <span class="k">implements</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="nx">listenTo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Placement</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">afterInsert</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
  <span class="k">async</span> <span class="nx">beforeRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
  <span class="k">async</span> <span class="nx">afterRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also notice that I have implemented the <code>listenTo</code> method, which will specify this subscriber&#8217;s listening field. But before moving on, we need to tell TypeORM where our migration is via the following configuration variable that you need to add to your <code>.env</code> and <code>.test.env</code> file.</p>
</div>
<div class="listingblock">
<div class="title">Adding the configuration of subscribers</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="env">TYPEORM_SUBSCRIBERS=src/subscribers/*.subscriber.ts</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now ready to move on to the implementation of the methods!</p>
</div>
<div class="paragraph">
<p>As usual, we will create a test dedicated to this new class. This test will simply create a product with a sufficient quantity and then create a <code>Placement</code> and check that the total has been updated. We then do the opposite by deleting the product and checking that the original quantity is found.</p>
</div>
<div class="listingblock">
<div class="title">Create test to ensure <code>product.entity</code> is updated</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">PlacementSubscriber</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">manager</span><span class="p">:</span> <span class="nx">EntityManager</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="kd">const</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
    <span class="nx">manager</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">manager</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should update product.quantity after insert</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span><span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">}));</span>
    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">());</span>

    <span class="kd">const</span> <span class="nx">placement</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
      <span class="nx">generatePlacement</span><span class="p">({</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">2</span><span class="p">}),</span>
    <span class="p">);</span>

    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span><span class="p">,</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">quantity</span><span class="p">);</span>

    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">placement</span><span class="p">);</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation of the subscriber is really very simple. We will use the <code>beforeInsert</code> and <code>beforeRemove</code> methods to increment or decrement the product total and then save the product.</p>
</div>
<div class="listingblock">
<div class="title">Complete subscriber to update <code>product.quantity</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">EventSubscriber</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementSubscriber</span>
  <span class="k">implements</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">async</span> <span class="nx">afterInsert</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productId</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">productId</span><span class="p">});</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">-=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">quantity</span><span class="p">;</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">beforeRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productId</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">productId</span><span class="p">});</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">+=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">quantity</span><span class="p">;</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We retrieve the product via the <code>manager</code> instead of simply retrieving via the <code>entity.product</code> relationship to ensure that we have the latest version stored in the database.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And there you go. It was easy, wasn&#8217;t it? Let&#8217;s run the tests to be sure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  PlacementSubscriber
     should update product.quantity after insert <span class="o">(</span>40ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Perfect, let&#8217;s move on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_update_of_the_total_stroke_of_the_order">Update of the total stroke of the order</h3>
<div class="paragraph">
<p>If you understood the previous section correctly, you could guess that the order stroke update will be quite similar.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by writing the tests. So we will create a <code>Product</code>, then an <code>Order</code> and then a <code>Placement</code> to check that the order total has updated. We will then remove this <code>Placement</code> and check that the</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">PlacementSubscriber</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should update order.total after insert</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
      <span class="nx">generateProduct</span><span class="p">({</span><span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">price</span><span class="p">:</span> <span class="mi">5</span><span class="p">}),</span>
    <span class="p">);</span>
    <span class="kd">let</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">());</span>

    <span class="kd">const</span> <span class="nx">placement</span> <span class="o">=</span> <span class="nx">generatePlacement</span><span class="p">({</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">2</span><span class="p">});</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">placement</span><span class="p">);</span>

    <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">total</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">);</span>

    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">placement</span><span class="p">);</span>
    <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">total</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. This test really looks like the previous one. So let&#8217;s move quickly to the implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">EventSubscriber</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementSubscriber</span>
  <span class="k">implements</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">async</span> <span class="nx">afterInsert</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateOrderTotal</span><span class="p">(</span><span class="nx">manager</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">order</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="k">async</span> <span class="nx">afterRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateOrderTotal</span><span class="p">(</span><span class="nx">manager</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">order</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">async</span> <span class="nx">updateOrderTotal</span><span class="p">(</span><span class="na">manager</span><span class="p">:</span> <span class="nx">EntityManager</span><span class="p">,</span> <span class="na">order</span><span class="p">:</span> <span class="nx">Order</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">placements</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">where</span><span class="p">:</span> <span class="p">{</span><span class="nx">order</span><span class="p">},</span>
      <span class="na">relations</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">product</span><span class="dl">'</span><span class="p">],</span>
    <span class="p">});</span>

    <span class="nx">order</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">placements</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">placement</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">*</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">order</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a closer look at the <code>updateOrderTotal</code> method:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we get all the <code>placements</code> of the order passed in parameter with the associated products</p>
</li>
<li>
<p>we add up the total investment</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The query builder of TypeORM</div>
<div class="paragraph">
<p>It is possible to rewrite the previous code with the <em>Query Builder</em> of TypeORM. The <em>Query Builder</em> gives you more control over the generated SQL query. The code can be more complex and more powerful because we don&#8217;t need to load several objects in memory.</p>
</div>
<div class="paragraph">
<p>This is the case here, so I wanted to make a little sidebar. Here is the equivalent with the Query Builder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span>
  <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="dl">'</span><span class="s1">pl</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">'</span><span class="s1">SUM(pl.quantity) * p.price</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">total</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">pl.order</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">pl.product</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">p</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">o.id = :orderId</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">orderId</span><span class="p">:</span> <span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="dl">'</span><span class="s1">o.id</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">getRawOne</span><span class="p">();</span>
<span class="nx">order</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">result</span><span class="p">?.</span><span class="nx">total</span> <span class="o">??</span> <span class="mi">0</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query will directly total by multiplying the quantity by the price of the related product. Thus, we obtain the result directly in the form of a `number'. This avoids loading several Javascript objects and saves memory.</p>
</div>
<div class="paragraph">
<p>This code will generate the following SQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">SELECT</span> <span class="k">SUM</span><span class="p">(</span><span class="nv">"pl"</span><span class="p">.</span> <span class="nv">"quantity"</span><span class="p">)</span> <span class="o">*</span> <span class="nv">"p"</span><span class="p">.</span> <span class="nv">"price"</span> <span class="k">AS</span> <span class="nv">"total"</span>
<span class="k">FROM</span> <span class="nv">"placement"</span> <span class="nv">"pl"</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"order"</span> <span class="nv">"o"</span> <span class="k">ON</span> <span class="nv">"o"</span><span class="p">.</span> <span class="nv">"id"</span><span class="o">=</span><span class="nv">"pl"</span><span class="p">.</span> <span class="nv">"orderId"</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"product"</span> <span class="nv">"p"</span> <span class="k">ON</span> <span class="nv">"p"</span><span class="p">.</span> <span class="nv">"id"</span><span class="o">=</span><span class="nv">"pl"</span><span class="p">.</span> <span class="nv">"productId"</span>
<span class="k">WHERE</span> <span class="nv">"o"</span><span class="p">.</span> <span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="nv">"o"</span><span class="p">.</span> <span class="nv">"id"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore, I strongly advise you to improve your database managers' knowledge as they can be great allies.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see if the tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
...
    create
       should create order <span class="o">(</span>74ms<span class="o">)</span>
       should not create product without auth
       should not create order with missing products
...
  PlacementSubscriber
     should update product.quantity after insert <span class="o">(</span>42ms<span class="o">)</span>
     should update order.total after insert <span class="o">(</span>44ms<span class="o">)</span>
...
  42 passing <span class="o">(</span>1s<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s go through our changes and recap what we&#8217;ve just done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Updates the total calculation for order"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as we come to the end of our chapter, it&#8217;s time to apply all our changes to the master branch by doing a merge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter08</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_8">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh, you are here! Allow me to congratulate you! It&#8217;s a long way from the first chapter. But you are one step closer. In fact, the next chapter will be the last one. So try to make the best of it.</p>
</div>
<div class="paragraph">
<p>The last chapter will discuss how to optimize the API using paging, caching, and background tasks. So buckle up. It&#8217;s going to be an eventful journey.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter09-optimization" class="sect0">Optimizations</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Welcome to the last chapter of the book. It&#8217;s been a long road, but you&#8217;re only one step away from the end. In the previous chapter, we finished modeling the order model. We could say that the project is now complete, but I want to cover a few important details about optimization. The topics I will cover here will be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pagination</p>
</li>
<li>
<p>Caching</p>
</li>
<li>
<p>SQL query optimization</p>
</li>
<li>
<p>the activation of CORS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I will try to go as far as I can by trying to cover some common scenarios. I hope these scenarios will be useful for some of your projects.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a new branch for this chapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pagination">Pagination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A prevalent strategy for optimizing record retrieval from a database is to load only a limited amount of records by paging them. We will do it very easily.</p>
</div>
<div class="paragraph">
<p>The only tricky part here is how to manage JSON output to give the customer enough information about how the table is paginated. In the previous section, I shared some resources on the practices I&#8217;m going to follow here. One of them was <a href="http://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>The JSON:API standard imposes a strict but clear format. This allows us not to worry about how it should be implemented. A subsection called <a href="https://jsonapi.org/format/#document-top-level">Top Level</a> of the official JSON:API documentation mentions something about pagination:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>"meta": meta-information about a resource, such as pagination.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This is not very descriptive, but we have a hint on what to look for next about paging implementation. Don&#8217;t worry, that&#8217;s exactly what we&#8217;re going to do here.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the list of products.</p>
</div>
<div class="sect2">
<h3 id="_the_products">The products</h3>
<div class="paragraph">
<p>We need to provide the paging information on the <code>meta</code> tag as the following JSON document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="c1">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"first"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"last"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=30"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"prev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we see what we should return, all we have to do is change our code a little. But before going any further, let&#8217;s add a few tests first:</p>
</div>
<div class="listingblock">
<div class="title">Add functional tests about products pagination</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">ProductsController</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should paginate results</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span><span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">}));</span>
      <span class="p">}</span>

      <span class="k">await</span> <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/products</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">links</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So we are testing two things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we create 25 products, so we have to find only 20 of them in the API response because the results must be limited to one page.</p>
</li>
<li>
<p>we need to find the <code>links</code> attributes we saw previously</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So our goal is to get these tests done. We are not going to define the controller&#8217;s behavior because we know in advance that we want the same behavior for all controllers. So we&#8217;re going to create a generic method that will take as a parameter:</p>
</div>
<div class="paragraph">
<p>The HTTP request will allow us to easily find the <code>page</code> parameter and build the <code>links</code> according to the current URL of the request.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the SQL query, which will be useful to know how many results there are in the database and also apply the <code>OFFSET</code> and <code>LIMIT</code> filters to get only part of the results</p>
</li>
<li>
<p>the serializer to serialize the data according to the JSON:API schema</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s go!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/paginate.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Request</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Serializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonapi-serializer</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">SelectQueryBuilder</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">PER_PAGE</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">paginate</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="nx">queryBuilder</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">serializer</span><span class="p">:</span> <span class="nx">Serializer</span><span class="p">,</span>
  <span class="p">{</span><span class="nx">query</span><span class="p">,</span> <span class="nx">baseUrl</span><span class="p">}:</span> <span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">page</span> <span class="o">??</span> <span class="mi">1</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">).</span><span class="nx">getCount</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">totalPage</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">count</span> <span class="o">/</span> <span class="nx">PER_PAGE</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">prevPage</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">nextPage</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">===</span> <span class="nx">totalPage</span> <span class="p">?</span> <span class="nx">page</span> <span class="p">:</span> <span class="nx">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">?</span> <span class="p">(</span><span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">PER_PAGE</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span>
    <span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">PER_PAGE</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">getUrlForPage</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">=&gt;</span>
    <span class="s2">`</span><span class="p">${</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">?</span><span class="p">${</span><span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">({...</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">})}</span><span class="s2">`</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">serializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">first</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="na">last</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="nx">totalPage</span><span class="p">),</span>
    <span class="na">prev</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="nx">prevPage</span><span class="p">),</span>
    <span class="na">next</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="nx">nextPage</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is a bit long, but we will review it together:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>queryBuilder.getCount()</code> allows us to execute the query passed as a parameter but only to know the number of results.</p>
</li>
<li>
<p>We use this value to calculate the number of pages and deduct the previous and next page number.</p>
</li>
<li>
<p>we execute the SQL query of the <code>queryBuilder</code> adding an <code>offset</code> and a <code>limit</code>.</p>
</li>
<li>
<p>we generate the URLs that we add to the previously serialized result</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Are you still there? The implementation in the controller is much easier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">paginate</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/paginate.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/products</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">paginate</span><span class="p">(</span><span class="nx">repository</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">),</span> <span class="nx">productsSerializer</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Let&#8217;s run the tests to be sure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nt">---</span>
<span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    index
       should paginate results <span class="o">(</span>94ms<span class="o">)</span>
...
<span class="nt">---</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we&#8217;ve done a great optimization for the product list route, it&#8217;s up to the customer to browse the pages.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go through these changes and continue with the order list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds pagination for products index action to optimize response"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_list_of_orders">List of orders</h3>
<div class="paragraph">
<p>Now it&#8217;s time to do exactly the same for the order list route. This should be very easy to implement. But first, let&#8217;s add some tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">OrderController</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should paginate results</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">orderRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">({</span><span class="nx">user</span><span class="p">}));</span>
      <span class="p">}</span>

      <span class="k">await</span> <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">links</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And, as you may already suspect, our tests no longer pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  1 failing

  1<span class="o">)</span> OrderController
       index
         should paginate results:

      AssertionError <span class="o">[</span>ERR_ASSERTION]: Expected values to be strictly equal:

21 <span class="o">!==</span> 20

      + expected - actual

      <span class="nt">-21</span>
      +20</code></pre>
</div>
</div>
<div class="paragraph">
<p>Passing this test is again quite easy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">})</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span><span class="nx">manager</span><span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">paginate</span><span class="p">(</span>
      <span class="nx">manager</span>
        <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">o.user = :user</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}),</span>
      <span class="nx">ordersSerializer</span><span class="p">,</span>
      <span class="nx">req</span><span class="p">,</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only difference from the implementation of the product controller is that here we needed to transform <code>repository.find</code> into <code>queryBuilder</code>.</p>
</div>
<div class="paragraph">
<p>The tests should now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  46 passing <span class="o">(</span>781ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s do a commit before moving forward</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds pagination for orders index action"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_caching">Caching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can easily set up simple caching for some of our requests. The implementation will be effortless thanks to TypeORM. TypeORM will create a new table that will store the executed query, and the result is returned. At the next execution, TypeORM will return the same result as the previous one. This saves precious resources to our database manager (here Sqlite) during some expensive SQL queries. Here the result will not be obvious because the executed SQL queries remain simple, but we will implement it anyway.</p>
</div>
<div class="paragraph">
<p>Before seeing a little bit of the cache&#8217;s behavior, we will create a script that will insert dummy data in our database. This will be very easy because we just need to use the methods we created during our tests. Here&#8217;s a little script that we&#8217;re going to create in a new <code>scripts</code> folder:</p>
</div>
<div class="listingblock">
<div class="title">Create a script to insert lot&#8217;s of data in development database</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/scripts/loadFakeData.script.ts</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">reflect-metadata</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">createOrder</span><span class="p">(</span><span class="nx">manager</span><span class="p">:</span> <span class="nx">EntityManager</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">generateUser</span><span class="p">());</span>
  <span class="kd">const</span> <span class="nx">owner</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">generateUser</span><span class="p">());</span>
  <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">generateOrder</span><span class="p">({</span><span class="nx">user</span><span class="p">}));</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">generateProduct</span><span class="p">({</span><span class="na">user</span><span class="p">:</span> <span class="nx">owner</span><span class="p">}));</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="p">{</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">2</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">manager</span><span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">container</span>
    <span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">Logger</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">DEBUG</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`Inserting </span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2"> / 100`</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">createOrder</span><span class="p">(</span><span class="nx">manager</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">main</span> <span class="o">===</span> <span class="kr">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">main</span><span class="p">().</span><span class="nx">then</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. Some explanations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>createOrder</code> will, as its name suggests, create order and also create a product and five <code>places</code>.</p>
</li>
<li>
<p>The <code>main</code> will create a loop around <code>createOrder</code> to call it several times.</p>
</li>
<li>
<p><code>require.main === module</code> may seem abstract, but it is actually straightforward: it means that the function will be executed only if we explicitly execute the file. In other words, it ensures that the method will not be executed if the file is accidentally imported.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now we can run the script with the following order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm run build <span class="o">&amp;&amp;</span> node dist/scripts/loadfakedata.script.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can verify that everything went well by sending a small SQL query directly to the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>sqlite3 db/development.sqlite <span class="s2">"SELECT COUNT(*) FROM product"</span>
500</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s try to activate the cache. It&#8217;s really very easy. First we need to add the following environment variable so that TypeORM creates a table dedicated to the startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="env"># .env
# ...
TYPEORM_CACHE=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do not forget to deactivate this parameter during tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="env"># .test.env
# ...
TYPEORM_CACHE=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will add two lines to our <code>paginate</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/paginate.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">paginate</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">).</span><span class="nx">getCount</span><span class="p">();</span>
  <span class="c1">// ...</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span>
    <span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">PER_PAGE</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
  <span class="c1">// ...</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. The <code>cache</code> method takes care of everything. Let&#8217;s try it to see. Start the <code>npm start</code> server and send an HTTP request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> <span class="s2">"http://localhost:3000/products?title=42"</span>
Total: 0.019708</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>-w</code> option allows us to retrieve the time of the request, <code>-w</code> redirects the response to a file and `--hides the cURL display.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The response time takes about 20 milliseconds using cURL. But let&#8217;s take a look at the server console that displays the SQL queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"query-result-cache"</span> <span class="nv">"cache"</span> <span class="k">WHERE</span> <span class="nv">"cache"</span><span class="p">.</span><span class="nv">"query"</span> <span class="o">=</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: ...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="nv">"cnt"</span> <span class="k">FROM</span> <span class="nv">"product"</span> <span class="nv">"Product"</span> <span class="k">WHERE</span> <span class="n">published</span> <span class="o">=</span> <span class="k">TRUE</span> <span class="k">AND</span> <span class="k">lower</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: ...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"query-result-cache"</span><span class="p">(</span><span class="nv">"identifier"</span><span class="p">,</span> <span class="nv">"query"</span><span class="p">,</span> <span class="nv">"time"</span><span class="p">,</span> <span class="nv">"duration"</span><span class="p">,</span> <span class="nv">"result"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: ...</span>
<span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some explanations for these requests:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a query is made on the <code>query-result-cache</code> table to see if a cache is present</p>
</li>
<li>
<p>the request is made because the cache did not exist</p>
</li>
<li>
<p>the result is inserted in the <code>query-result-cache</code> table.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s try to execute the cURL order again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> <span class="s2">"http://localhost:3000/products?title=42"</span>
Total: 0.007368</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the response time is now halved. Of course, this figure is to be taken with tweezers but let&#8217;s see in the console what has just happened:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"query-result-cache"</span> <span class="nv">"cache"</span> <span class="k">WHERE</span> <span class="nv">"cache"</span> <span class="nv">"query"</span> <span class="o">=</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there you go. The cache has been used and &#8230;&#8203; nothing more! Now it&#8217;s up to you to judge which queries can be cached and for how long as needed.</p>
</div>
<div class="paragraph">
<p>So the improvement is huge! Let&#8217;s commit our changes one last time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds caching for the serializers"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_activation_of_cors">Activation of CORS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this last section, I will tell you about one last problem you will surely encounter if you have to work with your API.</p>
</div>
<div class="paragraph">
<p>The first time you request an external site (via an AJAX request, for example), you will encounter such an error:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Failed to load <a href="https://example.com/" class="bare">https://example.com/</a>: No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'https://anfo.pl' is therefore not allowed access. If an opaque response serves your needs, set the request&#8217;s mode to 'no-cors' to fetch the resource with CORS disabled.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>"But what does <em>Access-Control-Allow-Origin</em> mean? The behavior you are observing is the effect of the CORS implementation of the browsers. Before the CORS standardization, there was no way to call an API terminal under another domain for security reasons. This was (and still is, to some extent) blocked by the policy of the same origin.</p>
</div>
<div class="paragraph">
<p>CORS is a mechanism to allow requests made on your behalf and at the same time to block certain requests made by rogue scripts and is triggered when you make an HTTP request to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a different domain</p>
</li>
<li>
<p>a different sub-domain</p>
</li>
<li>
<p>a different port</p>
</li>
<li>
<p>a different protocol</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We need to manually enable this feature so that any client can make requests to our API. A simple library already exists, so we will install it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">--save</span> horns</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we just need to modify our server a little bit:</p>
</div>
<div class="listingblock">
<div class="title">Setup CORS on Express.js</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">reflect-metadata</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">cors</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="nx">server</span>
  <span class="p">.</span><span class="nx">setConfig</span><span class="p">(</span><span class="nx">app</span> <span class="o">=&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">()))</span>
  <span class="p">.</span><span class="nx">build</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Listen on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there it is! Now it&#8217;s time to make our last commit and merge our changes on the master branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Activate CORS"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_9">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you get to this point, it means you are done with the book. Good job! You&#8217;ve just become a great Node.js developer, that&#8217;s for sure. So we have built together with a solid and complete API. This one has all the qualities to dethrone <a href="https://www.amazon.com/">Amazon</a>, rest assured.</p>
</div>
<div class="paragraph">
<p>Thank you for going through this great adventure with me. Keep in mind that you have just seen one of many ways to build an API with Node.js. I hope that this one will have allowed you to discover new notions and especially that you took as much pleasure in coding as I did.</p>
</div>
<div class="paragraph">
<p>I would like to remind you that this book&#8217;s source code is available in <a href="https://asciidoctor.org">Asciidoctor</a> format on <a href="https://github.com/madeindjs/rest-api.ts">GitHub</a>. So don&#8217;t hesitate to <a href="https://github.com/madeindjs/rest-api.ts/fork">fork</a> the project if you want to improve it or correct a mistake I might have missed.</p>
</div>
<div class="paragraph">
<p>If you liked this book, don&#8217;t hesitate to let me know by mail <a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a>. I&#8217;m open to any criticism, good or bad, over a good beer :) .</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2021-01-17 20:01:52 +0100
</div>
</div>

<script type="application/ld+json">
  {
    "@context": "https://schema.org/",
    "@type": "HowTo",
    "name": "REST-API.ts",
    "description": "Learn best practices to build an API using API on Rails. The intention of this book its not only to teach you how to build an API. The purpose is also to teach you how to build scalable and maintainable API which means improve your current Node.js knowledge",
    "image": "https://rsseau.fr/img/books/rest-api-ts.svg",
    "totalTime": "PT60M",
    "estimatedCost": {
      "@type": "MonetaryAmount",
      "currency": "EUR",
      "value": "0"
    },
    "step": [
      {
        "@type": "HowToStep",
        "text": "I will explain how to configure your environment (if you havent already done so). We will then create an application called market_place. I will make sure to teach you the best practices I have learned from my experience. This means that after initializing the project, we will start using Git.",
        "name": "Introduction",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter01-introduction"
      },
      {
        "@type": "HowToStep",
        "text": "We set up an application architecture and dependency injection that we help us later to test our application.",
        "name": "The API",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter02-api"
      },
      {
        "@type": "HowToStep",
        "text": "We'll set up TypeORM and build our first model: user.",
        "name": "Presenting users",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter03-presenting-users"
      },
      {
        "@type": "HowToStep",
        "text": "We are going to set up our authentication mechanism. We'll set up the JWT token and ensure it is valid during authentification.",
        "name": "User authentication",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter04-authentication"
      },
      {
        "@type": "HowToStep",
        "text": "We are going to customize the JSON output and add a second resource: the users products. These are the elements that the user will sell in the application.",
        "name": "Users products",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter05-user-products"
      },
      {
        "@type": "HowToStep",
        "text": "We'll update JSON output to get a JSON:API compliant response.",
        "name": "Building JSON",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter06-improve-json"
      },
      {
        "@type": "HowToStep",
        "text": "We'll build the order entity that allow user to purchase products.",
        "name": "Placing Orders",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter07-placing-orders"
      },
      {
        "@type": "HowToStep",
        "text": "We will take care of some validations on the order entity to make sure it is valid. That is Decrease the quantity of the current product when creating an order and manage the case where the product is not available.",
        "name": "Improving orders",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter08-improve_orders"
      },
      {
        "@type": "HowToStep",
        "text": "We'll setup pagination, caching, SQL query optimization and the activation of CORS.",
        "name": "Optimizations",
        "url": "https://rsseau.fr/books/rest-api-ts_en.html#chapter09-optimization"
      }
    ]
  }
</script>

</body>
</html>