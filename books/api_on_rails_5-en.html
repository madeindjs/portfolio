<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="description" content="Learn best practice to build an API using Ruby on Rails 5">
<meta name="keywords" content="Rails, API, Ruby, Software">
<meta name="author" content="Alexandre Rousseau">
<meta name="copyright" content="CC-BY-SA 4.0, MIT">
<title>API on Rails 5</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>API on Rails 5</h1>
<div class="details">
<span id="author" class="author">Alexandre Rousseau</span><br>
<span id="email" class="email"><a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a></span><br>
<span id="revnumber">version 6.12,</span>
<span id="revdate">2020-12-20</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#chapter00-before">Before</a>
<ul class="sectlevel1">
<li><a href="#_foreword">Foreword</a></li>
<li><a href="#_about_the_author">About the author</a></li>
<li><a href="#_copyright_and_license">Copyright and license</a></li>
<li><a href="#_thanks">Thanks</a></li>
</ul>
</li>
<li><a href="#chapter01-introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#_conventions_on_this_book">Conventions on this book</a></li>
<li><a href="#_development_environments">Development environments</a>
<ul class="sectlevel2">
<li><a href="#_text_editors_and_terminal">Text editors and Terminal</a></li>
<li><a href="#_browsers">Browsers</a></li>
<li><a href="#_package_manager">Package manager</a></li>
<li><a href="#_git">Git</a></li>
<li><a href="#_ruby">Ruby</a></li>
</ul>
</li>
<li><a href="#_initializing_the_project">Initializing the project</a>
<ul class="sectlevel2">
<li><a href="#_installing_pow_or_prax">Installing Pow or Prax</a></li>
</ul>
</li>
<li><a href="#_gemfile_and_bundler">Gemfile and Bundler</a></li>
<li><a href="#_versioning">Versioning</a></li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter02-api">The API</a>
<ul class="sectlevel1">
<li><a href="#_planning_the_application">Planning the application</a></li>
<li><a href="#_setting_the_api">Setting the API</a>
<ul class="sectlevel2">
<li><a href="#_routes_constraints_and_namespaces">Routes, Constraints and Namespaces</a></li>
</ul>
</li>
<li><a href="#_api_versioning">Api versioning</a>
<ul class="sectlevel2">
<li><a href="#_improving_the_versioning">Improving the versioning</a></li>
</ul>
</li>
<li><a href="#_conclusion_2">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter03-presenting-users">Presenting the users</a>
<ul class="sectlevel1">
<li><a href="#_user_model">User model</a></li>
<li><a href="#_first_user_tests">First user tests</a></li>
<li><a href="#_improving_validation_tests">Improving validation tests</a>
<ul class="sectlevel2">
<li><a href="#_testing_endpoints_with_curl">Testing endpoints with CURL</a></li>
<li><a href="#_creating_users">Creating users</a></li>
<li><a href="#_update_users">Update users</a></li>
<li><a href="#_destroying_users">Destroying users</a></li>
</ul>
</li>
<li><a href="#_conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter04-refactoring-tests">Refactoring tests</a>
<ul class="sectlevel1">
<li><a href="#_refactoring_the_json_response">Refactoring the JSON response</a></li>
<li><a href="#_refactoring_the_format_param">Refactoring the format param</a></li>
<li><a href="#_refactor_before_actions">Refactor before actions</a></li>
<li><a href="#_conclusion_4">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter05-authentication">Authenticating users</a>
<ul class="sectlevel1">
<li><a href="#_stateless_session">Stateless session</a></li>
<li><a href="#_authentication_token">Authentication token</a></li>
<li><a href="#_sessions_controller">Sessions controller</a>
<ul class="sectlevel2">
<li><a href="#_sign_in_success">Sign in success</a></li>
<li><a href="#_sign_out">Sign out</a></li>
</ul>
</li>
<li><a href="#_current_user">Current User</a></li>
<li><a href="#_authenticate_with_token">Authenticate with token</a></li>
<li><a href="#_authorize_actions">Authorize actions</a></li>
<li><a href="#_conclusion_5">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter06-user-products">User products</a>
<ul class="sectlevel1">
<li><a href="#_product_model">Product model</a>
<ul class="sectlevel2">
<li><a href="#_product_bare_bones">Product bare bones</a></li>
<li><a href="#_product_validations">Product validations</a></li>
<li><a href="#_productuser_association">Product/User association</a></li>
<li><a href="#_dependency_destroy">Dependency destroy</a></li>
</ul>
</li>
<li><a href="#_products_endpoints">Products endpoints</a>
<ul class="sectlevel2">
<li><a href="#_show_action_for_products">Show action for products</a></li>
<li><a href="#_products_list">Products list</a></li>
<li><a href="#_creating_products">Creating products</a></li>
<li><a href="#_updating_products">Updating products</a></li>
<li><a href="#_destroying_products">Destroying products</a></li>
</ul>
</li>
<li><a href="#_feed_the_database">Feed the database</a></li>
<li><a href="#_conclusion_6">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter07-improve-json">JSON with Active Model Serializers</a>
<ul class="sectlevel1">
<li><a href="#_setting_up_the_gem">Setting up the gem</a></li>
<li><a href="#_serialise_the_user_model">Serialise the user model</a></li>
<li><a href="#_serialize_the_product_model">Serialize the product model</a></li>
<li><a href="#_serializing_associations">Serializing associations</a>
<ul class="sectlevel2">
<li><a href="#_embedding_products_on_users">Embedding products on users</a></li>
</ul>
</li>
<li><a href="#_searching_products">Searching products</a>
<ul class="sectlevel2">
<li><a href="#_by_keyword">By keyword</a></li>
<li><a href="#_by_price">By price</a></li>
<li><a href="#_sort_by_creation">Sort by creation</a></li>
<li><a href="#_search_engine">Search engine</a></li>
</ul>
</li>
<li><a href="#_conclusion_7">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter08-placing-orders">Placing Orders</a>
<ul class="sectlevel1">
<li><a href="#_modeling_order">Modeling order</a>
<ul class="sectlevel2">
<li><a href="#_orders_and_products">Orders and Products</a></li>
</ul>
</li>
<li><a href="#_user_orders">User orders</a></li>
<li><a href="#_exposing_the_order_model">Exposing the order model</a>
<ul class="sectlevel2">
<li><a href="#_render_a_single_order">Render a single order</a></li>
<li><a href="#_placing_and_order">Placing and order</a></li>
</ul>
</li>
<li><a href="#_customizing_the_order_json_output">Customizing the Order JSON output</a></li>
<li><a href="#_send_order_confirmation_email">Send order confirmation email</a></li>
<li><a href="#_conclusion_8">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter09-improve_orders">Improving orders</a>
<ul class="sectlevel1">
<li><a href="#_decrementing_the_product_quantity">Decrementing the product quantity</a>
<ul class="sectlevel2">
<li><a href="#_extending_the_placement_model">Extending the Placement model</a></li>
</ul>
</li>
<li><a href="#_validate_quantity_of_products">Validate quantity of products</a></li>
<li><a href="#_updating_the_total">Updating the total</a></li>
<li><a href="#_conclusion_9">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter10-optimization">Optimizations</a>
<ul class="sectlevel1">
<li><a href="#_setup_more_jsonapi_specifications">Setup more JSON:API specifications</a>
<ul class="sectlevel2">
<li><a href="#_users">Users</a></li>
<li><a href="#_users_sessions">User&#8217;s sessions</a></li>
<li><a href="#_orders">Orders</a></li>
<li><a href="#_implementation">Implementation</a></li>
</ul>
</li>
<li><a href="#_pagination">Pagination</a>
<ul class="sectlevel2">
<li><a href="#_products">Products</a></li>
<li><a href="#_orders_list">Orders list</a></li>
<li><a href="#_refactoring_pagination">Refactoring pagination</a></li>
</ul>
</li>
<li><a href="#_api_caching">API Caching</a></li>
<li><a href="#_conclusion_10">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="chapter00-before" class="sect0">Before</h1>
<div class="sect1">
<h2 id="_foreword">Foreword</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"API on Rails 5" is based on <a href="http://apionrails.icalialabs.com/book/">"APIs on Rails: Building REST APIs with Rails"</a>. It was initially published in 2014 by <a href="https://twitter.com/kurenn">Abraham Kuri</a> under the licenses <a href="http://opensource.org/licenses/MIT">MIT</a> and <a href="http://people.freebsd.org/~phk/">Beerware</a>.</p>
</div>
<div class="paragraph">
<p>Since the original work was not maintained, I wanted to update this excellent work and contribute to the Francophone community by translating it myself. This update is also available in the Molière language <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_the_author">About the author</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://twitter.com/kurenn">Abraham Kuri</a> is a Rails developer with 5 years of experience (probably more now). His experience includes working as a freelancer in software product development and more recently in collaboration within the open source community. A graduate in computer science from ITESM, he founded two companies in Mexico (<a href="http://icalialabs.com/">Icalia Labs</a> and <a href="http://codeandomexico.org/">Codeando Mexico</a>).</p>
</div>
<div class="paragraph">
<p>On my side, my name is <a href="http://rousseau-alexandre.fr">Alexandre Rousseau</a> and I am a Rails developer with more than 4 years of experience (at the time of writing). I am currently a partner in a company (<a href="https://isignif.fr">iSignif</a>) where I build and maintain a SAAS product using Rails. I also contribute to the Ruby community by producing and maintain some gems that you can consult onhttps://rubygems.org/profiles/madeindjs[my Rubygems.org profile]. Most of my projects are on GitHub so don&#8217;t <a href="http://github.com/madeindjs/">hesitate to follow me</a>.</p>
</div>
<div class="paragraph">
<p>All the source code of this book is available in <a href="https://asciidoctor.org/">Asciidoctor</a> format on <a href="https://github.com/madeindjs/api_on_rails">GitHub</a>. So don&#8217;t hesitate to <a href="https://github.com/madeindjs/api_on_rails/fork">forke</a> the project if you want to improve it or fix a mistake that I didn&#8217;t notice.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_copyright_and_license">Copyright and license</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This book is provided on <a href="http://opensource.org/licenses/MIT">MIT license</a>. All the book&#8217;s source code is available on <a href="https://fr.wikipedia.org/wiki/Markdown">Markdown</a> format on <a href="https://github.com/madeindjs/api_on_rails">GitHub</a></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">MIT license</div>
<div class="paragraph">
<p>Copyright 2019 Alexandre Rousseau</p>
</div>
<div class="paragraph">
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
</div>
<div class="paragraph">
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
</div>
<div class="paragraph">
<p>THE SOFTWARE IS PROVIDED ``AS IS'', WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>"API on Rails 5" by <a href="https://github.com/madeindjs/api_on_rails">Alexandre Rousseau</a> is shared according to <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution - Attribution-ShareAlike 4.0 International</a>. Built upon this book <a href="http://apionrails.icalialabs.com/book/" class="bare">http://apionrails.icalialabs.com/book/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thanks">Thanks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A big "thank you" to all Github contributors who make this book alive. In alphabetical order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/airdry">airdry</a></p>
</li>
<li>
<p><a href="https://github.com/Landris18">Landris18</a></p>
</li>
<li>
<p><a href="https://github.com/lex111">lex111</a></p>
</li>
<li>
<p><a href="https://github.com/cuilei5205189">cuilei5205189</a></p>
</li>
<li>
<p><a href="https://github.com/franklinjosmell">franklinjosmell</a></p>
</li>
<li>
<p><a href="https://github.com/notapatch">notapatch</a></p>
</li>
<li>
<p><a href="https://github.com/promisepreston">promisepreston</a></p>
</li>
<li>
<p><a href="https://github.com/tacataca">tacataca</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter01-introduction" class="sect0">Introduction</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Welcome to <a href="https://github.com/madeindjs/api_on_rails">APIs on Rails</a> a tutorial on steroids on how to build your next API with Rails. The goal of this book is to provide an answer on how to develop a RESTful API following the best practices out there, along with my own experience. By the time you are done with <em>API&#8217;s on Rails</em> you should be able to build your own <code>API</code> and integrate it with any clients such as a web browser or your next mobile app. The code generated is built on top of Rails 4 which is the current version, for more information about this check out <a href="http://rubyonrails.org/" class="bare">http://rubyonrails.org/</a>. The most up-to-date version of the <em>API&#8217;s on Rails</em> can be found on <a href="https://github.com/madeindjs/api_on_rails">APIs on Rails</a>; don&#8217;t forget to update your offline version if that is the case.</p>
</div>
<div class="paragraph">
<p>The intention with this book it&#8217;s not only to teach you how to build an API with Rails. The purpose is also to teach you how to build scalable and maintainable API with Rails which means improve your current Rails knowledge. In this journey we are going to take, you will learn to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build JSON responses</p>
</li>
<li>
<p>Use Git for version controlling</p>
</li>
<li>
<p>Testing your endpoints</p>
</li>
<li>
<p>Optimize and cache the API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I highly recommend you go step by step on this book, try not to skip chapters, as I mention tips and interesting facts for improving your skills on each on them. You can think yourself as the main character of a video game and with each chapter you&#8217;ll get a higher level.</p>
</div>
<div class="paragraph">
<p>In this first chapter I will walk you through on how to setup your environment in case you don&#8217;t have it already. We&#8217;ll then create the application called <code>market_place_api</code>. I&#8217;ll emphasize all my effort into teaching you all the best practices I&#8217;ve learned along the years, so this means right after initializing the project we will start tracking it with Git.</p>
</div>
<div class="paragraph">
<p>In the next chapters we will be building the application to demonstrate a simple workflow I use on my daily basis. We&#8217;ll develop the whole application using <strong>test driven development</strong> (TDD), getting started by explaining why you want to build an API&#8217;s for your next project and deciding whether to use JSON or XML as the response format. We&#8217;ll get our hands dirty then and complete the foundation for the application by building all the necessary endpoints, securing the API access and handling authentication through headers exchange. Finally on the last chapter we&#8217;ll add some optimization techniques for improving the server responses.</p>
</div>
<div class="paragraph">
<p>The final application will scratch the surface of being a market place where users will be able to place orders, upload products and more. There are plenty of options out there to set up an online store, such as <a href="http://shopify.com">Shopify</a>, <a href="http://spreecommerce.com/">Spree</a> or <a href="http://magento.com">Magento</a>.</p>
</div>
<div class="paragraph">
<p>By the end or during the process (it really depends on your expertise), you will get better and be able to better understand some of the bests Rails resources out there. I also took some of the practices from these guys and brought them to you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://railscasts.com/">Railscasts</a></p>
</li>
<li>
<p><a href="http://codeschool.com/">CodeSchool</a></p>
</li>
<li>
<p><a href="http://jsonapi.org/format/">JSON API</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conventions_on_this_book">Conventions on this book</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The conventions on this book are based on the ones from <a href="http://www.railstutorial.org/book/beginning#sec-conventions">Ruby on Rails Tutorial</a>. In this section I&#8217;ll mention some that may not be so clear.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll be using many examples using command-line commands. I won&#8217;t deal with windows <code>cmd</code> (sorry guys), so I&#8217;ll based all the examples using Unix-style command line prompt, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"A command-line command"</span>
A command-line <span class="nb">command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll be using some guidelines related to the language, what I mean by this is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Avoid</strong> means you are not supposed to do it</p>
</li>
<li>
<p><strong>Prefer</strong> indicates that from the 2 options, the first it&#8217;s a better fit</p>
</li>
<li>
<p><strong>Use</strong> means you are good to use the resource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If for any reason you encounter some errors when running a command, rather than trying to explain every possible outcome, I&#8217;ll will recommend you to `google it', which I don&#8217;t consider a bad practice or whatsoever. But if you feel like want to grab a beer or have troubles with the tutorial you can always <a href="mailto:contact@rousseau-alexandre.fr">email me</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development_environments">Development environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the most painful parts for almost every developer is setting everything up, but as long as you get it done, the next steps should be a piece of cake and well rewarded. So I will guide you to keep you motivated.</p>
</div>
<div class="sect2">
<h3 id="_text_editors_and_terminal">Text editors and Terminal</h3>
<div class="paragraph">
<p>There are many cases in which development environments may differ from computer to computer. That is not the case with text editors or IDE&#8217;s. I think for Rails development an IDE is way to much, but some other might find that the best way to go, so if that it&#8217;s your case I recommend you go with <a href="http://www.aptana.com/products/radrails">RadRails</a> or <a href="http://www.jetbrains.com/ruby/index.html">RubyMine</a>, both are well supported and comes with many integrations out of the box.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Text editor</strong>: I personally use <a href="http://www.vim.org/">vim</a> as my default editor with <a href="https://github.com/carlhuda/janus">janus</a> which will add and handle many of the plugins you are probably going to use. In case you are not a <em>vim</em> fan like me, there are a lot of other solutions such as <a href="http://www.sublimetext.com/">Sublime Text</a> which is a cross-platform easy to learn and customize (this is probably your best option), it is highly inspired by <a href="http://macromates.com/">TextMate</a> (only available for Mac OS). A third option is to use a more recent text editor from the guys at <a href="http://gitub.com">GitHub</a> called <a href="https://atom.io/">Atom</a>, it&#8217;s a promising text editor made with JavaScript, it is easy to extend and customize to meet your needs, give it a try. Any of the editors I present will do the job, so I&#8217;ll let you decide which one fits your eye.</p>
</li>
<li>
<p><strong>Terminal</strong>: If you decided to go with <a href="http://icalialabs.github.io/kaishi/">kaishi</a> for setting the environment you will notice that it sets the default shell to <code>zsh</code>, which I highly recommend. For the terminal, I&#8217;m not a fan of the <em>Terminal</em> app that comes out of the box if you are on Mac OS, so check out <a href="http://www.iterm2.com/#/section/home">iTerm2</a>, which is a terminal replacement for Mac OS. If you are on Linux you probable have a nice terminal already, but the default should work just fine.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_browsers">Browsers</h3>
<div class="paragraph">
<p>When it comes to browsers I would say <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> immediately, but some other developers may say <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or even <a href="https://www.apple.com/safari/">Safari</a>. Any of those will help you build the application you want, they come with nice inspector not just for the DOM but for network analysis and many other features you might know already.</p>
</div>
</div>
<div class="sect2">
<h3 id="_package_manager">Package manager</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Mac OS</strong>: There are many options to manage how you install packages on your Mac, such as <a href="https://www.macports.org/">Mac Ports</a> or <a href="http://brew.sh/">Homebrew</a>, both are good options but I would choose the last one, I&#8217;ve encountered less troubles when installing software and managing it. To install <code>brew</code> just run the command below:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Linux</strong>: You are all set!, it really does not matter if you are using <code>apt</code>, <code>pacman</code>, <code>yum</code> as long you feel comfortable with it and know how to install packages so you can keep moving forward.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_git">Git</h3>
<div class="paragraph">
<p>We will be using Git a lot, and you should use it too not just for the purpose of this tutorial but for every single project.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on Mac OS: <code>$ brew install git</code></p>
</li>
<li>
<p>on Linux: <code>$ sudo apt-get install git</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ruby">Ruby</h3>
<div class="paragraph">
<p>There are many ways in which you can install and manage ruby, and by now you should probably have some version installed if you are on Mac OS, to see which version you have, just type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ruby <span class="nt">-v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails 5 requires you to install version 2.2.2 or higher. I recommend you to start using <a href="http://rvm.io/">Ruby Version Manager (RVM)</a> or <a href="http://rbenv.org/">rbenv</a>, any of these will allow you to install multiple versions of <code>ruby</code>. We will use RVM in this tutorial any of these two options you choose is fine.</p>
</div>
<div class="paragraph">
<p>To install RVM go on <a href="https://rvm.io/" class="bare">https://rvm.io/</a> and get GPG key<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>. Then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gpg <span class="nt">--keyserver</span> hkp://keys.gnupg.net <span class="nt">--recv-keys</span> 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
<span class="nv">$ </span><span class="se">\c</span>url <span class="nt">-sSL</span> https://get.rvm.io | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next it is time to install ruby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rvm <span class="nb">install </span>2.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything went smooth, it is time to install the rest of the dependencies we will be using.</p>
</div>
<div class="sect3">
<h4 id="_gems_rails_missing_libraries">Gems, Rails &amp; Missing libraries</h4>
<div class="paragraph">
<p>First we update the gems on the whole system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gem update <span class="nt">--system</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On some cases if you are on a Mac OS, you will need to install some extra libraries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>brew <span class="nb">install </span>libtool libxslt libksba openssl</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then install the necessary gems and ignore documentation for each gem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">printf</span> <span class="s1">'gem: --no-document'</span> <span class="o">&gt;&gt;</span> ~/.gemrc
<span class="nv">$ </span>gem <span class="nb">install </span>bundler
<span class="nv">$ </span>gem <span class="nb">install </span>foreman
<span class="nv">$ </span>gem <span class="nb">install </span>rails <span class="nt">-v</span> 5.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check for everything to be running nice and smooth:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nt">-v</span> 5.2
5.2.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_database">Database</h4>
<div class="paragraph">
<p>I highly recommend you install <a href="http://www.postgresql.org/">Postgresql</a> to manage your databases, but for simplicity we&#8217;ll be using <a href="http://www.sqlite.org/">SQlite</a>. If you are using Mac OS you should be ready to go, in case you are on Linux, don&#8217;t worry we have you covered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>libxslt-dev libxml2-dev libsqlite3-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>libxslt-devel libxml2-devel libsqlite3-devel</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initializing_the_project">Initializing the project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Initializing a Rails application must be pretty straightforward for you, if that is not the case, here is a super quick tutorial.</p>
</div>
<div class="paragraph">
<p>Be aware that we&#8217;ll be using <a href="http://rspec.info/">Rspec</a> as the testing suite. So we will use the <code>--skip-test</code> option. Also we will use <code>--api</code> option.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This option came with Rails 5 and it allow to limit gems and Middleware. It will also avoid to generate HTML views when using Rails generators.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir</span> ~/workspace
<span class="nv">$ </span><span class="nb">cd</span> ~/workspace
<span class="nv">$ </span>rails new market_place_api <span class="nt">--skip-test</span> <span class="nt">--api</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may guess, the commands above will generate the bare bones of your Rails application. The next step is to add some <code>gems</code> we&#8217;ll be using to build the api.</p>
</div>
<div class="sect2">
<h3 id="_installing_pow_or_prax">Installing Pow or Prax</h3>
<div class="paragraph">
<p>You may ask yourself</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Why in the hell would I want to install this type of package?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>and the answer is simple, we will be working with <a href="http://en.wikipedia.org/wiki/Subdomain">subdomains</a>, and in this case using services like <a href="http://pow.cx/">Pow</a> or <a href="https://github.com/ysbaddaden/prax">Prax</a> help us achieve that very easily</p>
</div>
<div class="sect3">
<h4 id="_installing_pow">Installing Pow</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Pow only works on Mac OS, but don&#8217;t worry there is an alternative which mimics the functionality on Linux.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To install it just type in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl get.pow.cx | sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it you are all set. You just have to symlink the application in order to set up the Rack app. First you go the <code>~/.pow</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> ~/.pow</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you create the <a href="http://en.wikipedia.org/wiki/Symbolic_link">symlink</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">ln</span> <span class="nt">-s</span> ~/workspace/market_place_api</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to change the user directory to the one matches yours. You can now access the application through <a href="http://market_place_api.dev/" class="bare">http://market_place_api.dev/</a>. Your application should be up a running by now.</p>
</div>
</div>
<div class="sect3">
<h4 id="_installing_prax">Installing Prax</h4>
<div class="paragraph">
<p>For linux users only, <a href="https://github.com/ysbaddaden/prax.cr">Prax</a> distribute some Debian/Ubuntu precompiled packages. You only have to download <code>.deb</code> and instal with <code>dpkg</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nv">$ </span>wget https://github.com/ysbaddaden/prax.cr/releases/download/v0.8.0/prax_0.8.0-1_amd64.deb
<span class="nv">$ </span><span class="nb">sudo </span>dpkg <span class="nt">-i</span> prax_0.8.0-1_amd64.deb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we just need to link the apps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> ~/workspace/market_place_api
<span class="nv">$ </span>prax <span class="nb">link</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to start the Prax server automatically, add this line to the <code>.profile</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>prax start</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When using prax, you have to specify the port for the URL, in this case <a href="http://market_place_api.dev:3000" class="bare">http://market_place_api.dev:3000</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should see the application up and running, see image bellow:</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gemfile_and_bundler">Gemfile and Bundler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the Rails application is created, the next step is adding a simple but very powerful gem to serialize the resources we are going to expose on the api. The gem is called <code>active_model_serializers</code> which is an excellent choice to go when building this type of application. It is well maintained and the <a href="https://github.com/rails-api/active_model_serializers">documentation</a> is amazing.</p>
</div>
<div class="paragraph">
<p>So your <code>Gemfile</code> should look like this after adding the <code>active _model_serializers</code> gem:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">git_source</span><span class="p">(</span><span class="ss">:github</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">repo</span><span class="o">|</span> <span class="s2">"https://github.com/</span><span class="si">#{</span><span class="n">repo</span><span class="si">}</span><span class="s2">.git"</span> <span class="p">}</span>

<span class="n">ruby</span> <span class="s1">'2.5.3'</span>

<span class="c1"># Bundle edge Rails instead: gem 'rails', github: 'rails/rails'</span>
<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.2.0'</span>
<span class="c1"># Use sqlite3 as the database for Active Record</span>
<span class="n">gem</span> <span class="s1">'sqlite3'</span>
<span class="c1"># Use Puma as the app server</span>
<span class="n">gem</span> <span class="s1">'puma'</span><span class="p">,</span> <span class="s1">'~&gt; 3.11'</span>
<span class="c1"># Use SCSS for stylesheets</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.0'</span>
<span class="c1"># Use Uglifier as compressor for JavaScript assets</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'&gt;= 1.3.0'</span>

<span class="c1"># Api gems</span>
<span class="n">gem</span> <span class="s1">'active_model_serializers'</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I remove the <code>jbuilder</code> and <code>turbolinks</code> gems because we are not really going to use them anyway.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is a good practice also to include the ruby version used on the whole project, this prevents dependencies to break if the code is shared among different developers, whether if is a private or public project.</p>
</div>
<div class="paragraph">
<p>It is also important that you update the <code>Gemfile</code> to group the different gems into the correct environment</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sqlite3'</span>
<span class="k">end</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This as you may recall will prevent <code>sqlite</code> from being installed or required when you deploy your application to a server provider like <a href="http://heroku.com/">Heroku</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Due to the structure of the application we are not going to deploy the app to any server, but we will be using <a href="http://pow.cx/">Pow</a> by <a href="https://basecamp.com/">Basecamp</a>. If you are using Linux there is a similar solution called <a href="https://github.com/ysbaddaden/prax">Prax</a> by ysbaddaden
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pow is a zero-config Rack server for Mac OS X. Have it serving your apps locally in under a minute. - Basecamp</p>
</div>
<div class="paragraph">
<p>Once you have this configuration set up, it is time to run the <code>bundle install</code> command to integrate the corresponding dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the command finish its execution, it is time to start tracking the project with Git.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_versioning">Versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Remember that Git helps you track and maintain history of your code. Keep in mind source code of the application is published on GitHub. You can follow the repository at <a href="https://github.com/madeindjs/api_on_rails">GitHub</a>. I&#8217;ll assume you have Git already configured and ready to use to start tracking the project. If that is not your case, follow these first-time setup steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git config <span class="nt">--global</span> user.name <span class="s2">"Type in your name"</span>
<span class="nv">$ </span>git config <span class="nt">--global</span> user.email <span class="s2">"Type in your email"</span>
<span class="nv">$ </span>git config <span class="nt">--global</span> core.editor <span class="s2">"vim"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Replace the last command editor(<code>"mvim -f"</code>) with the one you installed <code>"subl -w"</code> for SublimeText ,<code>"mate -w"</code> for TextMate, or <code>"gvim -f"</code> for gVim.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So it is now time to <strong>init</strong> the project with git. Remember to navigate to the root directory of the <code>market_place_api</code> application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git init
Initialized empty Git repository <span class="k">in</span> ~/workspace/market_place_api/.git/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to ignore some files that we don&#8217;t want to track, so your <code>.gitignore</code> file should look like the one shown below:</p>
</div>
<div class="listingblock">
<div class="title">.gitignore</div>
<div class="content">
<pre># Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

# Ignore uploaded files in development
/storage/*

/node_modules
/yarn-error.log

/public/assets
.byebug_history

# Ignore master key for decrypting credentials and more.
/config/master.key</pre>
</div>
</div>
<div class="paragraph">
<p>After modifying the <code>.gitignore</code> file we just need to add the files and commit the changes, the commands necessary are shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Initial commit"</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
I have encounter that committing with a message starting with a present tense verb, describes what the commit does and not what it did, this way when you are exploring the history of the project it is more natural to read and understand(or at least for me). I&#8217;ll follow this practice until the end of the tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lastly and as an optional step we setup the GitHub (I&#8217;m not going through that in here) project and push our code to the remote server: We first add the remote:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git remote add origin git@github.com:madeindjs/market_place_api.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git push <span class="nt">-u</span> origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we move forward with the tutorial, I&#8217;ll be using the practices I follow on my daily basis, this includes working with <code>branches</code>, <code>rebasing</code>, <code>squash</code> and some more. For now you don&#8217;t have to worry if some of these don&#8217;t sound familiar to you, I walk you through them in time.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s been a long way through this chapter, if you reach here let me congratulate you and be sure that from this point things will get better. So let&#8217;s get our hands dirty and start typing some code!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter02-api" class="sect0">The API</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In this section I&#8217;ll outline the application. By now you should have the bare bones of the application. If you did not read it I recommend you to do it.</p>
</div>
<div class="paragraph">
<p>You can clone the project until this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone https://github.com/madeindjs/market_place_api
<span class="nv">$ </span><span class="nb">cd </span>market_place_api
<span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter1 b98a9a7a328017640482af95beebc1d6e612e0ac</code></pre>
</div>
</div>
<div class="paragraph">
<p>And as a quick recap, we really just update the <code>Gemfile</code> to add the <code>active_model_serializers</code> gem.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_planning_the_application">Planning the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we want to go simple with the application, it consists on five models. Don&#8217;t worry if you don&#8217;t fully understand what is going on, we will review and build each of these resources as we move on with the tutorial.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="img/data_model.png" alt="Schema of links betweens models"></span></p>
</div>
<div class="paragraph">
<p>In short terms we have the <code>user</code> who will be able to place many <code>orders</code>, upload multiple <code>products</code> which can have many <code>images</code> or <code>comments</code> from another users on the app.</p>
</div>
<div class="paragraph">
<p>We are not going to build views for displaying or interacting with the API, so not to make this a huge tutorial, I&#8217;ll let that to you. There are plenty of options out there, from javascript frameworks(<a href="https://angularjs.org/">Angular</a>, <a href="http://emberjs.com/">EmberJS</a>, <a href="http://backbonejs.org/">Backbone</a>) to mobile consumption(<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>).</p>
</div>
<div class="paragraph">
<p>By this point you must be asking yourself, all right but I need to explore or visualize the api we are going to be building, and that&#8217;s fair. Probably if you google something related to api exploring, an application called <a href="https://www.getpostman.com/">Postman</a> will pop. It is a great software but we won&#8217;t be using that anyway because we&#8217;ll use cURL who allow anybody to reproduce request on any computer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_the_api">Setting the API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An API is defined by <a href="http://en.wikipedia.org/wiki/Application_programming_interface">wikipedia</a> as <em>an application programming interface (API) specifies how some software components should interact with each other.</em> In other words the way systems interact with each other through a common interface, in our case a web service built with JSON. There are other kinds of communication protocols like SOAP, but we are not covering that in here.</p>
</div>
<div class="paragraph">
<p>JSON as the Internet media type is highly accepted because of readability, extensibility and easy to implement in fact many of the current frameworks consume JSON api&#8217;s by default, in JavaScript there is <a href="https://angularjs.org/">Angular</a> or <a href="http://emberjs.com/">EmberJS</a>, but there are great libraries for objective-c too like <a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> or <a href="http://restkit.org/">RESTKit</a>. There are probably good solutions for Android, but because of my lack of experience on that development platform I might not be the right person to recommend you something.</p>
</div>
<div class="paragraph">
<p>All right, so we are building our API with JSON, but there are many ways to achieve this, the first thing that could come to your mind would be just to start dropping some routes defining the <a href="http://en.wikipedia.org/wiki/Web_Services_Description_Language#Objects_in_WSDL_1.1_.2F_WSDL_2.0">end points</a> but they may not have a <a href="http://www.w3.org/2005/Incubator/wcl/matching.html">URI pattern</a> clear enough to know which resource is being exposed. The protocol or structure I&#8217;m talking about is <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> which stands for Representational State Transfer and by wikipedia definition</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>is a way to create, read, update or delete information on a server using simple HTTP calls. It is an alternative to more complex mechanisms like SOAP, CORBA and RPC. A REST call is simply a GET HTTP request to the server.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="soap">aService.getUser("1")</code></pre>
</div>
</div>
<div class="paragraph">
<p>And in REST you may call a URL with an e specific HTTP request, in this case with a GET request: <sub>~</sub> <a href="http://domain.com/resources_name/uri_pattern" class="bare">http://domain.com/resources_name/uri_pattern</a> <sub>~</sub></p>
</div>
<div class="paragraph">
<p>RESTful APIs must follow at least three simple guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A base <a href="http://en.wikipedia.org/wiki/Uniform_resource_identifier">URI</a>, such as <code><a href="http://example.com/resources/" class="bare">http://example.com/resources/</a></code>.</p>
</li>
<li>
<p>An Internet media type to represent the data, it is commonly JSON and is commonly set through headers exchange.</p>
</li>
<li>
<p>Follow the standard <a href="http://en.wikipedia.org/wiki/HTTP_method#Request_methods">HTTP Methods</a> such as GET, POST, PUT, DELETE.</p>
<div class="ulist">
<ul>
<li>
<p><strong>GET</strong>: Reads the resource or resources defined by the URI pattern</p>
</li>
<li>
<p><strong>POST</strong>: Creates a new entry into the resources collection</p>
</li>
<li>
<p><strong>PUT</strong>: Updates a collection or member of the resources</p>
</li>
<li>
<p><strong>DELETE</strong>: Destroys a collection or member of the resources</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This might not be clear enough or may look like a lot of information to digest but as we move on with the tutorial, hopefully it&#8217;ll get a lot easier to understand.</p>
</div>
<div class="sect2">
<h3 id="_routes_constraints_and_namespaces">Routes, Constraints and Namespaces</h3>
<div class="paragraph">
<p>Before start typing any code, we prepare the code with git, the workflow we&#8217;ll be using a branch per chapter, upload it to GitHub and then merge it with master, so let&#8217;s get started open the terminal, <code>cd</code> to the <code>market_place_api</code> directory and type in the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> setting-api
Switched to a new branch <span class="s1">'setting-api'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are only going to be working on the <code>config/routes.rb</code>, as we are just going to set the <code>constraints</code>, the <code>base_uri</code> and the default response <code>format</code> for each request.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First of all erase all commented code that comes within the file, we are not gonna need it. Then commit it, just as a warm up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add config/routes.rb
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Removes comments from the routes file"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are going to isolate the api controllers under a namespace, in Rails this is fairly simple, just create a folder under the <code>app/controllers</code> named <code>api</code>, the name is important as it is the namespace we&#8217;ll use for managing the controllers for the api endpoints.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then add that namespace into our <code>routes.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span> <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By defining a namespace under the <code>routes.rb</code> file. Rails will automatically map that namespace to a directory matching the name under the <code>controllers</code> folder, in our case the <code>api/</code> directory.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Rails media types supported</div>
<div class="paragraph">
<p>Rails can handle up to 35 different media types, you can list them by accessing the SET class under de Mime module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails c
Loading development environment <span class="o">(</span>Rails 5.2.1<span class="o">)</span>
irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; Mime::SET.collect<span class="o">(</span>&amp;:to_s<span class="o">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"text/html"</span>, <span class="s2">"text/plain"</span>, <span class="s2">"text/javascript"</span>, <span class="s2">"text/css"</span>, <span class="s2">"text/calendar"</span>, <span class="s2">"text/csv"</span>, <span class="s2">"text/vcard"</span>, <span class="s2">"text/vtt"</span>, <span class="s2">"image/png"</span>, <span class="s2">"image/jpeg"</span>, <span class="s2">"image/gif"</span>, <span class="s2">"image/bmp"</span>, <span class="s2">"image/tiff"</span>, <span class="s2">"image/svg+xml"</span>, <span class="s2">"video/mpeg"</span>, <span class="s2">"audio/mpeg"</span>, <span class="s2">"audio/ogg"</span>, <span class="s2">"audio/aac"</span>, <span class="s2">"video/webm"</span>, <span class="s2">"video/mp4"</span>, <span class="s2">"font/otf"</span>, <span class="s2">"font/ttf"</span>, <span class="s2">"font/woff"</span>, <span class="s2">"font/woff2"</span>, <span class="s2">"application/xml"</span>, <span class="s2">"application/rss+xml"</span>, <span class="s2">"application/atom+xml"</span>, <span class="s2">"application/x-yaml"</span>, <span class="s2">"multipart/form-data"</span>, <span class="s2">"application/x-www-form-urlencoded"</span>, <span class="s2">"application/json"</span>, <span class="s2">"application/pdf"</span>, <span class="s2">"application/zip"</span>, <span class="s2">"application/gzip"</span>, <span class="s2">"application/vnd.web-console.v2"</span><span class="o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is important because we are going to be working with JSON, one of the built-in <a href="http://en.wikipedia.org/wiki/Internet_media_type">MIME types</a> accepted by Rails, so we just need to specify this format as the default one:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Up to this point we have not made anything crazy. What we want to to generate a <em>base_uri</em> under a subdomain. In our case something like <code>api.market_place_api.dev</code>. Setting the api under a subdomain is a good practice because it allows to scale the application to a DNS level. So how do we achieve that?</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the changes? We didn&#8217;t just add an <a href="https://ruby-doc.org/core-2.4.0/Hash.html"><code>Hash</code></a> constraints to specify the subdomain. We also add the <code>path</code> option, and set it on root path (<code>/</code>). This is telling Rails to set the starting path for each request to be root in relation to the subdomain, achieving what we are looking for.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Common API patterns</div>
<div class="paragraph">
<p>You can find many approaches to set up the <em>base_uri</em> when building an api following different patterns, assuming we are versioning our api:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api.example.com/</code>: I my opinion this is the way to go, gives you a better interface and isolation, and in the long term can help you to <a href="http://www.makeuseof.com/tag/optimize-your-dns-for-faster-internet/">quickly scalate</a></p>
</li>
<li>
<p><code>example.com/api/</code>: This pattern is very common, and it is actually a good way to go when you don&#8217;t want to namespace your api under a subdomain</p>
</li>
<li>
<p><code>example.com/api/v1</code>: his seems like a good idea, by setting the version of the api through the URL seems like a more descriptive pattern, but this way you enforce the version to be included on URL on each request, so if you ever decide to change this pattern, this becomes a problem of maintenance in the long-term</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Don&#8217;t worry about versioning right now, I&#8217;ll walk through it later.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Time to commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add config/routes.rb
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Set the routes constraints for the api"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All right take a deep breath, drink some water, and let&#8217;s get going.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_versioning">Api versioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point we should have a nice routes mapping using a subdomain for name spacing the requests, your <code>routes.rb</code> file should look like this:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to set up some other constraints for versioning purposes. You should care about versioning your application from the beginning since this will give a better structure to your api, and when changes need to be done, you can give developers who are consuming your api the opportunity to adapt for the new features while the old ones are being deprecated. There is an excellent <a href="http://railscasts.com/episodes/350-rest-api-versioning">railscast</a> explaining this.</p>
</div>
<div class="paragraph">
<p>In order to set the version for the api, we first need to add another directory under the <code>api</code> we created</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way we can scope our api into different versions very easily, now we just need to add the necessary code to the <code>routes.rb</code> file</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span> <span class="k">do</span>
      <span class="c1"># We are going to list our resources here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By this point the API is now scoped via de URL. For example with the current configuration an end point for retrieving a product would be like: <a href="http://api.marketplace.dev/v1/products/1" class="bare">http://api.marketplace.dev/v1/products/1</a>.</p>
</div>
<div class="sect2">
<h3 id="_improving_the_versioning">Improving the versioning</h3>
<div class="paragraph">
<p>So far we have the API versioned scoped via the URL, but something doesn&#8217;t feel quite right, isn&#8217;t it?. What I mean by this is that from my point of view the developer should not be aware of the version using it, as by default they should be using the last version of your endpoints, but how do we accomplish this?.</p>
</div>
<div class="paragraph">
<p>Well first of all, we need to improve the API version access through <a href="http://en.wikipedia.org/wiki/List_of_HTTP_header_fields">HTTP Headers</a>. This has two benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Removes the version from the URL</p>
</li>
<li>
<p>The API description is handle through request headers</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Most commons HTTP headers fields</div>
<div class="paragraph">
<p>HTTP header fields are components of the message header of requests and responses in the Hypertext Transfer Protocol (HTTP). They define an operating parameters of an HTTP transaction. A common list of used headers is presented below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Accept</strong>: Content-Types that are acceptable for the response. Example: <code>Accept: text/plain</code></p>
</li>
<li>
<p><strong>Authorization</strong>: Authentication credentials for HTTP authentication. Example: <code>Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</code></p>
</li>
<li>
<p><strong>Content-Type</strong>: The MIME type of the body of the request (used with POST and PUT requests). Example: <code>Content-Type: application/x-www-form-urlencoded</code></p>
</li>
<li>
<p><strong>Origin</strong>: Initiates a request for cross-origin resource sharing (asks server for an <code>Access-Control-Allow-Origin' response header). Example: `Origin: <a href="http://www.example-social-network.com" class="bare">http://www.example-social-network.com</a></code></p>
</li>
<li>
<p><strong>User-Agent</strong>: The user agent string of the user agent. Example: <code>User-Agent: Mozilla/5.0</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is important that you feel comfortable with this ones and understand them.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In Rails is very easy to add this type versioning through an <em>Accept</em> header. We will create a class under the <code>lib</code> directory of your rails app, and remember we are doing <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a> so first things first.</p>
</div>
<div class="paragraph">
<p>First we need to add our testing suite, which in our case is going to be <a href="http://rspec.info/">Rspe</a>:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.8'</span>
  <span class="n">gem</span> <span class="s1">'factory_bot_rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.9'</span>
  <span class="n">gem</span> <span class="s1">'ffaker'</span><span class="p">,</span> <span class="s1">'~&gt; 2.10'</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we run the bundle command to install the gems</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we install the <code>rspec</code> and add some configuration to prevent views and helpers tests from being generated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate rspec:install</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">config/application.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">module</span> <span class="nn">MarketPlaceApi</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># Initialize configuration defaults for originally generated Rails version.</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">5.2</span>

    <span class="n">config</span><span class="p">.</span><span class="nf">generators</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span>
      <span class="n">g</span><span class="p">.</span><span class="nf">test_framework</span> <span class="ss">:rspec</span><span class="p">,</span> <span class="ss">fixture: </span><span class="kp">true</span>
      <span class="n">g</span><span class="p">.</span><span class="nf">fixture_replacement</span> <span class="ss">:factory_bot</span><span class="p">,</span> <span class="ss">dir: </span><span class="s1">'spec/factories'</span>
      <span class="n">g</span><span class="p">.</span><span class="nf">view_specs</span> <span class="kp">false</span>
      <span class="n">g</span><span class="p">.</span><span class="nf">helper_specs</span> <span class="kp">false</span>
      <span class="n">g</span><span class="p">.</span><span class="nf">stylesheets</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="n">g</span><span class="p">.</span><span class="nf">javascripts</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="n">g</span><span class="p">.</span><span class="nf">helper</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="k">end</span>

    <span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">+=</span> <span class="sx">%W(</span><span class="se">\#</span><span class="sx">{config.root}/lib)</span>

    <span class="c1"># Don't generate system test files.</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">generators</span><span class="p">.</span><span class="nf">system_tests</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything went well it is now time to add a <code>spec</code> directory under <code>lib</code> and add the <code>api_constraints_spec.rb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>lib/spec
<span class="nv">$ </span><span class="nb">touch </span>lib/spec/api_constraints_spec.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then add a bunch of specs describing our class:</p>
</div>
<div class="listingblock">
<div class="title">lib/spec/api_constraints_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require</span> <span class="s1">'./lib/api_constraints'</span>

<span class="n">describe</span> <span class="no">ApiConstraints</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:api_constraints_v1</span><span class="p">)</span> <span class="p">{</span> <span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:api_constraints_v2</span><span class="p">)</span> <span class="p">{</span> <span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s1">'matches?'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"returns true when the version matches the 'Accept' header"</span> <span class="k">do</span>
      <span class="n">request</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">host: </span><span class="s1">'api.marketplace.dev'</span><span class="p">,</span>
                       <span class="ss">headers: </span><span class="p">{</span> <span class="s1">'Accept'</span> <span class="o">=&gt;</span> <span class="s1">'application/vnd.marketplace.v1'</span> <span class="p">})</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">api_constraints_v1</span><span class="p">.</span><span class="nf">matches?</span><span class="p">(</span><span class="n">request</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be_truthy</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"returns the default version when 'default' option is specified"</span> <span class="k">do</span>
      <span class="n">request</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">host: </span><span class="s1">'api.marketplace.dev'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">api_constraints_v2</span><span class="p">.</span><span class="nf">matches?</span><span class="p">(</span><span class="n">request</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be_truthy</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let me walk you through the code. We are initializing the class with an <a href="https://ruby-doc.org/core-2.4.0/Hash.html"><code>Hash</code></a> option. <a href="https://ruby-doc.org/core-2.4.0/Hash.html"><code>Hash</code></a> option will contain the version of the API and a default value for handling the default version. We provide a <code>matches?</code> method which the router will trigger for the constraint to see if the default version is required or the <code>Accept</code> header matches the given string.</p>
</div>
<div class="paragraph">
<p>The implementation looks likes this</p>
</div>
<div class="listingblock">
<div class="title">lib/api_constraints.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ApiConstraints</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="vi">@version</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:version</span><span class="p">]</span>
    <span class="vi">@default</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">matches?</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="vi">@default</span> <span class="o">||</span> <span class="n">req</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">].</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"application/vnd.marketplace.v</span><span class="si">#{</span><span class="vi">@version</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you imagine we need to add the class to our <code>routes.rb</code> file and set it as a constraint scope option.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span><span class="p">,</span> <span class="ss">constraints: </span><span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1"># We are going to list our resources here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration above now handles versioning through headers, and for now the version 1 is the default one, so every request will be redirected to that version, no matter if the header with the version is present or not.</p>
</div>
<div class="paragraph">
<p>Before we say goodbye, let&#8217;s run our first tests and make sure everything is nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec lib/spec/api_constraints_spec.rb
..

Finished <span class="k">in </span>0.00294 seconds <span class="o">(</span>files took 0.06292 seconds to load<span class="o">)</span>
2 examples, 0 failures</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_2">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s been a long way, I know, but you made it, don&#8217;t give up this is just our small scaffolding for something big, so keep it up. In the meantime and I you feel curious there are some gems that handle this kind of configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Sutto/rocket_pants">RocketPants</a></p>
</li>
<li>
<p><a href="https://github.com/bploetz/versionist">Versionist</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I&#8217;m not covering those in here, since we are trying to learn how to actually implement this kind of functionality, but it is good to know though. By the way the code up to this point is <a href="https://github.com/madeindjs/market_place_api/commit/124873774b578af3df21136df5ee80f4d50da3bd">here</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter03-presenting-users" class="sect0">Presenting the users</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In the last chapter we manage to set up the bare bones for our application endpoints configuration. We even added versioning through headers. In a next chapter we will handle users authentication through authentication tokens as well as setting permissions to limit access for let&#8217;s say signed in users. In coming chapters we will relate <code>products</code> to users and give them the ability to place orders.</p>
</div>
<div class="paragraph">
<p>You can clone the project until this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone https://github.com/madeindjs/market_place_api/tree/chapitre_2</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can already imagine there are a lot of authentication solutions for Rails, <a href="https://github.com/binarylogic/authlogic">AuthLogic</a>, <a href="https://github.com/thoughtbot/clearance">Clearance</a> and <a href="https://github.com/plataformatec/devise">Devise</a>. We will be using the last one, which offers a great way to integrate not just basic authentication, but many other modules for further use.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Devise</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Devise comes with up to 10 modules for handling authentication</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Database Authenticable</p>
</li>
<li>
<p>Omniauthable</p>
</li>
<li>
<p>Confirmable</p>
</li>
<li>
<p>Recoverable</p>
</li>
<li>
<p>Registerable</p>
</li>
<li>
<p>Rememberable</p>
</li>
<li>
<p>Trackable</p>
</li>
<li>
<p>Timeoutable</p>
</li>
<li>
<p>Validatable</p>
</li>
<li>
<p>Lockable</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you have not work with devise before, I recommend you visit the <a href="https://github.com/plataformatec/devise">reposity page</a> and read the documentation, there are a lot of good examples out there too.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>This is going to be a full-packed chapter. It may be long but I&#8217;m trying to cover as many topics along with best practices on the way, so feel free to grab a cup of coffee and let&#8217;s get going. By the end of the chapter you will have full user endpoints, along with validations and error server responses.</p>
</div>
<div class="paragraph">
<p>We want to track this chapter, so it would be a good time to create a new branch for this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just make sure you are on the <code>master</code> branch before checking out.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_model">User model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We need to first add the <code>devise</code> gem into the <code>Gemfile</code></p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">git_source</span><span class="p">(</span><span class="ss">:github</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">repo</span><span class="o">|</span> <span class="s2">"https://github.com/</span><span class="si">#{</span><span class="n">repo</span><span class="si">}</span><span class="s2">.git"</span> <span class="p">}</span>

<span class="n">ruby</span> <span class="s1">'2.5.3'</span>

<span class="c1"># Bundle edge Rails instead: gem 'rails', github: 'rails/rails'</span>
<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.2.0'</span>
<span class="c1"># Use sqlite3 as the database for Active Record</span>
<span class="n">gem</span> <span class="s1">'sqlite3'</span>
<span class="c1"># Use Puma as the app server</span>
<span class="n">gem</span> <span class="s1">'puma'</span><span class="p">,</span> <span class="s1">'~&gt; 3.11'</span>
<span class="c1"># Use SCSS for stylesheets</span>
<span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 5.0'</span>
<span class="c1"># Use Uglifier as compressor for JavaScript assets</span>
<span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'&gt;= 1.3.0'</span>

<span class="c1"># Api gems</span>
<span class="n">gem</span> <span class="s1">'active_model_serializers'</span>

<span class="c1"># Reduces boot times through caching; required in config/boot.rb</span>
<span class="n">gem</span> <span class="s1">'bootsnap'</span><span class="p">,</span> <span class="s1">'&gt;= 1.1.0'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># Call 'byebug' anywhere in the code to stop execution and get a debugger console</span>
  <span class="n">gem</span> <span class="s1">'byebug'</span><span class="p">,</span> <span class="ss">platforms: </span><span class="sx">%i[mri mingw x64_mingw]</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="c1"># Access an interactive console on exception pages or by calling 'console' anywhere in the code.</span>
  <span class="n">gem</span> <span class="s1">'listen'</span><span class="p">,</span> <span class="s1">'&gt;= 3.0.5'</span><span class="p">,</span> <span class="s1">'&lt; 3.2'</span>
  <span class="n">gem</span> <span class="s1">'web-console'</span><span class="p">,</span> <span class="s1">'&gt;= 3.3.0'</span>
  <span class="c1"># Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring</span>
  <span class="n">gem</span> <span class="s1">'spring'</span>
  <span class="n">gem</span> <span class="s1">'spring-watcher-listen'</span><span class="p">,</span> <span class="s1">'~&gt; 2.0.0'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'factory_bot_rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.9'</span>
  <span class="n">gem</span> <span class="s1">'ffaker'</span><span class="p">,</span> <span class="s1">'~&gt; 2.10'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.8'</span>
<span class="k">end</span>

<span class="c1"># Windows does not include zoneinfo files, so bundle the tzinfo-data gem</span>
<span class="n">gem</span> <span class="s1">'tzinfo-data'</span><span class="p">,</span> <span class="ss">platforms: </span><span class="sx">%i[mingw mswin x64_mingw jruby]</span>

<span class="n">gem</span> <span class="s1">'devise'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run the <code>bundle install</code> command to install it. Once the bundle command finishes, we need to run the devise install generator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails g devise:install
  create  config/initializers/devise.rb
  create  config/locales/devise.en.yml
  ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>By now and if everything went well we will be able to generate the <code>user</code> model through the <code>devise</code> generator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails g devise User
    invoke  active_record
    create    db/migrate/20181113070805_devise_create_users.rb
    create    app/models/user.rb
    invoke    rspec
    create      spec/models/user_spec.rb
    invoke      factory_bot
    create        spec/factories/users.rb
    insert    app/models/user.rb
    route  devise_for :users</code></pre>
</div>
</div>
<div class="paragraph">
<p>From now every time we create a model, the generator will also create a factory file for that model. This will help us to easily create test users and facilitate our tests writing.</p>
</div>
<div class="listingblock">
<div class="title">spec/factories/users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>

  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we migrate the database and prepare the test database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate
<span class="o">==</span> 20181113070805 DeviseCreateUsers: migrating <span class="o">================================</span>
<span class="nt">--</span> create_table<span class="o">(</span>:users<span class="o">)</span>
   -&gt; 0.0008s
<span class="nt">--</span> add_index<span class="o">(</span>:users, :email, <span class="o">{</span>:unique<span class="o">=&gt;</span><span class="nb">true</span><span class="o">})</span>
   -&gt; 0.0005s
<span class="nt">--</span> add_index<span class="o">(</span>:users, :reset_password_token, <span class="o">{</span>:unique<span class="o">=&gt;</span><span class="nb">true</span><span class="o">})</span>
   -&gt; 0.0007s
<span class="o">==</span> 20181113070805 DeviseCreateUsers: migrated <span class="o">(</span>0.0023s<span class="o">)</span> <span class="o">=======================</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:test:prepare</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit this, just to keep our history points very atomic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds devise user model"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_user_tests">First user tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will add some specs to make sure the <code>user</code> model responds to the <code>email</code>, <code>password</code> and <code>password_confirmation</code> attributes provided by devise, let&#8217;s add them. Also for convenience we will modify the <code>users</code> factory file to add the corresponding attributes.</p>
</div>
<div class="listingblock">
<div class="title">spec/factories/users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">email</span> <span class="p">{</span> <span class="no">FFaker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span>
    <span class="n">password</span> <span class="p">{</span> <span class="s1">'12345678'</span> <span class="p">}</span>
    <span class="n">password_confirmation</span> <span class="p">{</span> <span class="s1">'12345678'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we&#8217;d added the attributes it is time to test our <code>User</code> model.</p>
</div>
<div class="listingblock">
<div class="title">spec/models/user_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because we previously prepare the test database, with <code>rake db:test:prepare</code>, we just simply run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
....

Finished <span class="k">in </span>0.03231 seconds <span class="o">(</span>files took 0.81624 seconds to load<span class="o">)</span>
4 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>That was easy, we should probably commit this changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s1">'Adds user firsts specs'</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_improving_validation_tests">Improving validation tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is showtime people, we are building our first endpoint. We are just going to start building the <code>show</code> action for the user which is going to expose a <code>user</code> record in plain old JSON. We first need to generate the <code>users_controller</code>, add the corresponding tests and then build the actual code.</p>
</div>
<div class="paragraph">
<p>First we generate the <code>users</code> controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller <span class="nb">users</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will create a <code>users_controller_spec.rb</code>. Before we get into that, there are 2 basic steps we should be expecting when testing <code>api</code> endpoints.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The JSON structure to be returned from the server</p>
</li>
<li>
<p>The status code we are expecting to receive from the server</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Most common http codes</div>
<div class="paragraph">
<p>The first digit of the status code specifies one of five classes of response; the bare minimum for an HTTP client is that it recognize these five classes. A common list of used http codes is presented below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>200</code>: Standard response for successful HTTP requests (It is commonly on GET requests)</p>
</li>
<li>
<p><code>201</code>: The request has been fulfilled and resulted in a new resource being created (After POST requests)</p>
</li>
<li>
<p><code>204</code>: The server successfully processed the request, but is not returning any content (It is usually a successful DELETE request)</p>
</li>
<li>
<p><code>400</code>: The request cannot be fulfilled due to bad syntax.</p>
</li>
<li>
<p><code>401</code>: Similar to 403 Forbidden, but specifically for use when authentication is required and has failed or has not yet been provided</p>
</li>
<li>
<p><code>404</code>: The requested resource could not be found but may be available again in the future (Usually GET requests)</p>
</li>
<li>
<p><code>500</code>: A generic error message, given when an unexpected condition was encountered and no more specific message is suitable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a full list of HTTP method check out the article on <a href="http://en.wikipedia.org/wiki/List_of_HTTP_status_codes">Wikipedia</a> talking about it</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To keep our code nicely organized, we will create some directories under the controller specs directory in order to be consistent with our current setup. There is also another set up out there which uses instead of the <code>controllers</code> directory a <code>request</code> or <code>integration</code> directory, I this case I like to be consistent with the <code>app/controllers</code> directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> spec/controllers/api/v1
<span class="nv">$ </span><span class="nb">mv </span>spec/controllers/users_controller_spec.rb spec/controllers/api/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creating the corresponding directories we need to change the file <code>describe</code> name from <code>UsersController</code> to <code>Api::V1::UsersController</code>, the updated file should look like:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>

<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now with tests added your file should look like:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"application/vnd.marketplace.v1"</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">"GET #show"</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">format: :json</span><span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"returns the information about a reporter on a hash"</span> <span class="k">do</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_success</span> <span class="p">}</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So far, the tests look good, we just need to add the implementation. It is extremely simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span>  <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may activate <code>Devise::Test::ControllerHelpers</code> module in <code>spec/rails_helper.rb</code> file to load helpers. To do so you only have to add this line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1">#  ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#  ...</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">ControllerHelpers</span><span class="p">,</span> <span class="ss">type: :controller</span>
  <span class="c1">#  ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the tests now with <code>rspec spec/controllers</code> you will see an error message similar to this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rspec spec/controllers
FF

Failures:

  1) Api::V1::UsersController GET #show returns the information about a reporter on a hash
    Failure/Error: get :show, params: { id: @user.id, format: :json}

    ActionController::UrlGenerationError:
    No route matches {:action=&gt;"show", :controller=&gt;"api/v1/users", :format=&gt;:json, :id=&gt;1}
      ...

  2) Api::V1::UsersController GET #show
    Failure/Error: get :show, params: { id: @user.id, format: :json}


    ActionController::UrlGenerationError:
    No route matches {:action=&gt;"show", :controller=&gt;"api/v1/users", :format=&gt;:json, :id=&gt;1}
      ...

Finished in 0.01632 seconds (files took 0.47675 seconds to load)
  2 examples, 2 failures</pre>
</div>
</div>
<div class="paragraph">
<p>This kind of error if very common when generating endpoints manually, we totally forgot the <code>routes</code>. So let&#8217;s add them:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">devise_for</span> <span class="ss">:users</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span><span class="p">,</span> <span class="ss">constraints: </span><span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests should now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers
..

Finished <span class="k">in </span>0.02652 seconds <span class="o">(</span>files took 0.47291 seconds to load<span class="o">)</span>
2 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>As usual and after adding some bunch of code we are satisfied with, we commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds show action the users controller"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_testing_endpoints_with_curl">Testing endpoints with CURL</h3>
<div class="paragraph">
<p>So we finally have an endpoint to test. There are plenty of options to start playing with. The first that come to my mind is using <a href="http://curl.haxx.se/">cURL</a> because is built-in on almost any Linux distribution and of course on your Mac OSX. So let&#8217;s try it out:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Remember our base URI is <code>api.market_place_api.dev</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s1">'Accept: application/vnd.marketplace.v1'</span> http://api.market_place_api.dev/users/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will throw us an error. Well you might expect that already because we don&#8217;t have a user with <code>id</code> equals to 1. Let&#8217;s create it first through the terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails console
Loading development environment <span class="o">(</span>Rails 5.2.1<span class="o">)</span>
2.5.3 :001 <span class="o">&gt;</span>  User.create email: <span class="s2">"example@marketplace.com"</span>, password: <span class="s2">"12345678"</span>, password_confirmation: <span class="s2">"12345678"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After creating the user successfully our endpoint should work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s1">'Accept: application/vnd.marketplace.v1'</span> <span class="se">\</span>
http://api.market_place_api.dev/users/1
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"email"</span>:<span class="s2">"example@marketplace.com"</span>, ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>So there you go. You now have a user record API endpoint. If you are having problems with the response and double checked everything is well assembled. Well then you might need to visit the <code>application_controller.rb</code> file and update it a little bit like so</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/application_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="c1"># Prevent CSRF attacks by raising an exception.</span>
  <span class="c1"># For APIs, you may want to use :null_session instead.</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with: :null_session</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As suggested even by Rails we should be using <code>null_session</code> to prevent CSFR attacks from being raised, so <strong>I highly recommend you do it as this will not allow POST or PUT requests to work</strong>. After updating the <code>application_controller.rb</code> file it is probably a good point to place a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Updates application controller to prevent CSRF exception from being raised"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_users">Creating users</h3>
<div class="paragraph">
<p>Now that we have a better understanding on how to build endpoints and how they work, it&#8217;s time to add more abilities to the API. One of the most important is letting the users actually create a profile on our application. As usual we will write tests before implementing our code extending our testing suite.</p>
</div>
<div class="paragraph">
<p>Creating records in Rails as you may know is really easy, the trick when building an api is which is the best fit for the HTTP codes to send on the response, as well as the actual <code>json response</code>. If you don&#8217;t totally get this it will probably be more easy on the code:</p>
</div>
<div class="paragraph">
<p><strong>Make sure your repository is clean and that you don&#8217;t have any commits left, if so place them so we can start fresh.</strong></p>
</div>
<div class="paragraph">
<p>Let&#8217;s proceed with our test-driven development by adding a <code>create</code> endpoint on the <code>users_controller_spec.rb</code> file</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user_attributes</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">attributes_for</span> <span class="ss">:user</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="vi">@user_attributes</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json representation for the user record just created'</span> <span class="k">do</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user_attributes</span><span class="p">[</span><span class="ss">:email</span><span class="p">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="c1"># notice I'm not including the email</span>
        <span class="vi">@invalid_user_attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">password: </span><span class="s1">'12345678'</span><span class="p">,</span>
                                     <span class="ss">password_confirmation: </span><span class="s1">'12345678'</span> <span class="p">}</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="vi">@invalid_user_attributes</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders an errors json'</span> <span class="k">do</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:errors</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json errors on why the user could not be created'</span> <span class="k">do</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s2">"can't be blank"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">422</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a lot of code up there but don&#8217;t worry I&#8217;ll walk you through it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We need to validate to states on which the record can be, valid or invalid. In this case we are using the <code>context</code> clause to achieve this scenarios.</p>
</li>
<li>
<p>In case everything goes smooth, we should return a <code>201</code> HTTP code which means a record just got <code>created</code>, as well as the JSON representation of that object.</p>
</li>
<li>
<p>In case of any errors, we have to return a <code>422</code> HTTP code which stands for <code>Unprocessable Entity</code> meaning the server could save the record. We also return a JSON representation of why the resource could not be saved.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we run our tests now, they should fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/users_controller_spec.rb
.FFFFFF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Time to implement some code and make our tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span> <span class="n">user_params</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">user</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">user</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">user</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that each time we add an endpoint we have to add that action into our <code>routes.rb</code> file</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:create</span><span class="p">]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the implementation is fairly simple. We also added the <code>user_params</code> private method to sanitize the attribute to be assigned through mass-assignment. Now if we run our tests, they all should be nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/users_controller_spec.rb
.......

Finished <span class="k">in </span>0.05967 seconds <span class="o">(</span>files took 0.4673 seconds to load<span class="o">)</span>
7 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes and continue building our application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds the user create endpoint"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_users">Update users</h3>
<div class="paragraph">
<p>The pattern for <strong>updating</strong> users is very similar as <strong>creating</strong> new ones. If you are an experienced Rails developer you may already know the differences between these two actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>update</code> action responds to a PUT/PATCH request.</p>
</li>
<li>
<p>Only the <code>current_user</code> should be able to update their information, meaning we have to enforce a user to be authenticated. We will cover that on next chapters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As usual we start by writing our tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s2">"PUT/PATCH #update"</span> <span class="k">do</span>

   <span class="n">context</span> <span class="s2">"when is successfully updated"</span> <span class="k">do</span>
     <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
       <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
       <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span>
         <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
         <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s2">"newmail@example.com"</span> <span class="p">}</span> <span class="p">},</span>
         <span class="ss">format: :json</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="s2">"renders the json representation for the updated user"</span> <span class="k">do</span>
       <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
       <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s2">"newmail@example.com"</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="p">{</span>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
   <span class="k">end</span>

   <span class="n">context</span> <span class="s2">"when is not created"</span> <span class="k">do</span>
     <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
       <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
       <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span>
         <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
         <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s2">"bademail.com"</span> <span class="p">}</span> <span class="p">},</span>
         <span class="ss">format: :json</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="s2">"renders an errors json"</span> <span class="k">do</span>
       <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
       <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:errors</span><span class="p">)</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="s2">"renders the json errors on why the user could not be created"</span> <span class="k">do</span>
       <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
       <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s2">"is invalid"</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="p">{</span>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">422</span><span class="p">)</span> <span class="p">}</span>
   <span class="k">end</span>
 <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Getting the tests to pass requires us to build the <code>update</code> action on the <code>users_controller.rb</code> file as well as adding it to the <code>routes.rb</code>. As you can see we have to much code duplicated, we&#8217;ll refactor our tests in next chapter.</p>
</div>
<div class="paragraph">
<p>First we add the action the <code>routes.rb</code> file</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we implement the <code>update</code> action on the users controller and make our tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">user</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">user</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">user</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run our tests, we should now have all of our tests passing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/users_controller_spec.rb
............

Finished <span class="k">in </span>0.08826 seconds <span class="o">(</span>files took 0.47286 seconds to load<span class="o">)</span>
12 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>We commit the changes as we added a bunch of working code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds update action the users controller"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_destroying_users">Destroying users</h3>
<div class="paragraph">
<p>So far we have built a bunch of actions on the users controller along with their tests but we have not ended yet. We are just missing one more which is the destroy action. So let&#8217;s do that:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/vnd.marketplace.v1'</span> <span class="p">}</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s2">"DELETE #destroy"</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="p">},</span> <span class="ss">format: :json</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the spec is very simple. We only respond with a status of <code>204</code> which stands for <code>No Content</code>. This means that the server successfully processed the request but is not returning any content. We could also return a <code>200</code> status code but I find more natural to respond with <code>No Content</code> in this case as we are deleting a resource and a success response may be enough.</p>
</div>
<div class="paragraph">
<p>The implementation for the destroy action is fairly simple as well:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to add the <code>destroy</code> action to the user resources on the <code>routes.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run your tests now, they should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/users_controller_spec.rb
.............

Finished <span class="k">in </span>0.09255 seconds <span class="o">(</span>files took 0.4618 seconds to load<span class="o">)</span>
13 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that after making some changes to our code it is a good practice to commit. This habit will keep our history very atomic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds destroy action to the users controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_3">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh you are here!, great job! I know it probably was a long way, but don&#8217;t give up you are doing it great. Make sure you are understanding every piece of code, things will get better, in next chapter we will refactor our tests to clean our code a bit and make it easy to extend the test suite more. So stay with me guys!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter04-refactoring-tests" class="sect0">Refactoring tests</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In previous chapter we manage to put together some <code>user</code> resources endpoints. If you skip it (or simple missed it) I highly recommend you take a look at it. It covers the first test specs and an introduction to JSON responses.</p>
</div>
<div class="paragraph">
<p>You can clone the project until this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone <span class="nt">--branch</span> chapitre_3 https://github.com/madeindjs/market_place_api</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this chapter we&#8217;ll refactor our test specs by adding some helper methods. We&#8217;ll also remove the <code>format</code> param sent on every request and do it through headers. Also we hopefully build more consistent and scalable test suite.</p>
</div>
<div class="paragraph">
<p>So let' take a look to the <code>users_controller_spec.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/vnd.marketplace.v1'</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">format: :json</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the information about a reporter on a hash'</span> <span class="k">do</span>
      <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user_attributes</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">attributes_for</span> <span class="ss">:user</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="vi">@user_attributes</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json representation for the user record just created'</span> <span class="k">do</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user_attributes</span><span class="p">[</span><span class="ss">:email</span><span class="p">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="c1"># notice I'm not including the email</span>
        <span class="vi">@invalid_user_attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">password: </span><span class="s1">'12345678'</span><span class="p">,</span>
                                     <span class="ss">password_confirmation: </span><span class="s1">'12345678'</span> <span class="p">}</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="vi">@invalid_user_attributes</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders an errors json'</span> <span class="k">do</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:errors</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json errors on why the user could not be created'</span> <span class="k">do</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s2">"can't be blank"</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">422</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"PUT/PATCH #update"</span> <span class="k">do</span>

   <span class="n">context</span> <span class="s2">"when is successfully updated"</span> <span class="k">do</span>
     <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
       <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
       <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span>
         <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
         <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s2">"newmail@example.com"</span> <span class="p">}</span> <span class="p">},</span>
         <span class="ss">format: :json</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="s2">"renders the json representation for the updated user"</span> <span class="k">do</span>
       <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
       <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s2">"newmail@example.com"</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="p">{</span>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
   <span class="k">end</span>

   <span class="n">context</span> <span class="s2">"when is not created"</span> <span class="k">do</span>
     <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
       <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
       <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span>
         <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
         <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s2">"bademail.com"</span> <span class="p">}</span> <span class="p">},</span>
         <span class="ss">format: :json</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="s2">"renders an errors json"</span> <span class="k">do</span>
       <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
       <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:errors</span><span class="p">)</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="s2">"renders the json errors on why the user could not be created"</span> <span class="k">do</span>
       <span class="n">user_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
       <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s2">"is invalid"</span>
     <span class="k">end</span>

     <span class="n">it</span> <span class="p">{</span>  <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">422</span><span class="p">)</span> <span class="p">}</span>
   <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"DELETE #destroy"</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="p">},</span> <span class="ss">format: :json</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see there is a lot of duplicated code, two big refactors here are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>JSON.parse</code> method can be encapsulated on a method.</p>
</li>
<li>
<p>The <code>format</code> param is sent on every request. Although is not a bad practice but it is better if you handle the response type through headers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So let&#8217;s add a method for handling the JSON response. If you have been following the tutorial you may know that we are creating a branch for each chapter. So let&#8217;s do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter4</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refactoring_the_json_response">Refactoring the JSON response</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back to the <code>refactor</code>, we will add file under the <code>spec/support</code> directory. Currently we don&#8217;t have this directory. So let&#8217;s add it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>spec/support</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we create a <code>request_helpers.rb</code> file under the just created <code>support</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">touch </span>spec/support/request_helpers.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is time to extract the <code>JSON.parse</code> method into our own support method:</p>
</div>
<div class="listingblock">
<div class="title">spec/support/request_helpers.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Request</span>
  <span class="k">module</span> <span class="nn">JsonHelpers</span>
    <span class="k">def</span> <span class="nf">json_response</span>
      <span class="vi">@json_response</span> <span class="o">||=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We scope the method into some <code>modules</code> just to keep our code nice and organized. The next step here is to update the <code>users_controller_spec.rb</code> file to use the method. A quick example is presented below:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">it</span> <span class="s1">'returns the information about a reporter on a hash'</span> <span class="k">do</span>
  <span class="n">user_response</span> <span class="o">=</span> <span class="n">json_response</span> <span class="c1"># c'est cette ligne qui est maj</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">user_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
<span class="k">end</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is your turn to update the whole file.</p>
</div>
<div class="paragraph">
<p>After you are done updating the file and if you tried to run your tests you probably encounter a problem. For some reason it is not finding the <code>json_response</code> method which is weird because if we take a look at the <code>spec_helper.rb</code> file. We can see that is actually loading all files from the <code>support</code> directory:</p>
</div>
<div class="listingblock">
<div class="title">spec/rails_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># Load all Ruby files placed in spec/support folder</span>
<span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'spec'</span><span class="p">,</span> <span class="s1">'support'</span><span class="p">,</span> <span class="s1">'**'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">require</span> <span class="n">f</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1">#  ...</span>
  <span class="c1"># We also need to include JsonHelpers methods in Rspec tests</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Request</span><span class="o">::</span><span class="no">JsonHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
  <span class="c1">#  ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After that if we run our tests again, everything should be green again. So let&#8217;s commit this before adding more code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Refactors the json parse method"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refactoring_the_format_param">Refactoring the format param</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We want to remove the <code>format</code> param sent on every request and instead of that let&#8217;s handle the response we are expecting through headers. This is extremely easy just by adding one line to our <code>users_controller_spec.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"application/vnd.marketplace.v1, application/json"</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By adding this line, you can now remove all the <code>format</code> param we were sending on each request and forget about it for the whole application, as long as you include the <code>Accept</code> header with the JSON mime type.</p>
</div>
<div class="paragraph">
<p>Wait we are not over yet! We can add another header to our request that will help us describe the data contained we are expecting from the server to deliver. We can achieve this fairly easy by adding one more line specifying the <code>Content-Type</code> header:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"application/vnd.marketplace.v1, application/json"</span> <span class="p">}</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/json'</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And again if we run our tests we can see they are all nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/users_controller_spec.rb
.............

Finished <span class="k">in </span>1.44 seconds <span class="o">(</span>files took 0.4734 seconds to load<span class="o">)</span>
13 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>As always this is a good time to commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Factorize format for unit tests"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refactor_before_actions">Refactor before actions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;m very happy with the code we got so far but we can still improve it a little bit. The first thing that comes to my mind is to group the three custom headers being added before each request:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1">#...</span>
<span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"application/vnd.marketplace.v1, application/json"</span> <span class="p">}</span>
<span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'application/json'</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is good but not good enough because we will have to add this five lines of code for each file. If for some reason we are changing this (let&#8217;s say the response type to <code>xml</code>) well you do the math. But don&#8217;t worry I provide you a solution which will solve all these problems.</p>
</div>
<div class="paragraph">
<p>First of all we have to extend our <code>request_helpers.rb</code> file to include another module, which I named <code>HeadersHelpers</code> and which will have the necessary methods to handle these custom headers</p>
</div>
<div class="listingblock">
<div class="title">spec/support/request_helpers.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Request</span>
  <span class="c1"># ...</span>
  <span class="k">module</span> <span class="nn">HeadersHelpers</span>
    <span class="k">def</span> <span class="nf">api_header</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"application/vnd.marketplace.v</span><span class="si">#{</span><span class="n">version</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">api_response_format</span><span class="p">(</span><span class="nb">format</span> <span class="o">=</span><span class="s1">'application/json'</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Accept'</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="nb">format</span><span class="si">}</span><span class="s2">"</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">include_default_accept_headers</span>
      <span class="n">api_header</span>
      <span class="n">api_response_format</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see I broke the calls into two methods: one for setting the API header and the other one for setting the response format. Also and for convenience I wrote a method <code>include_default_accept_headers</code> for calling those two.</p>
</div>
<div class="paragraph">
<p>And now to call this method before each of our test cases we can add the <code>before</code> hook <sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> on the <em>Rspec.configure</em> block at <code>spec_helper.rb</code> file, and make sure we specify the type to <code>:controller</code>, as we don&#8217;t to run this on unit tests.</p>
</div>
<div class="listingblock">
<div class="title">spec/rails_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Request</span><span class="o">::</span><span class="no">HeadersHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">,</span> <span class="ss">type: :controller</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">include_default_accept_headers</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After adding this lines we can remove the before hooks on the <code>users_controller_spec.rb</code> file and check that our tests are still passing. You can review a full version of the <code>spec_helper.rb</code> file below:</p>
</div>
<div class="listingblock">
<div class="title">spec/rails_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="no">ENV</span><span class="p">[</span><span class="s1">'RAILS_ENV'</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="nb">require</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../config/environment'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>
<span class="c1"># Prevent database truncation if the environment is production</span>
<span class="nb">abort</span><span class="p">(</span><span class="s2">"The Rails environment is running in production mode!"</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span>
<span class="nb">require</span> <span class="s1">'rspec/rails'</span>

<span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'spec'</span><span class="p">,</span> <span class="s1">'support'</span><span class="p">,</span> <span class="s1">'**'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)].</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span> <span class="p">}</span>

<span class="k">begin</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">.</span><span class="nf">maintain_test_schema!</span>
<span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">PendingMigrationError</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">strip</span>
  <span class="nb">exit</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">fixture_path</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="o">::</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/spec/fixtures"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">use_transactional_fixtures</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">ControllerHelpers</span><span class="p">,</span> <span class="ss">type: :controller</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Request</span><span class="o">::</span><span class="no">JsonHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Request</span><span class="o">::</span><span class="no">HeadersHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">,</span> <span class="ss">type: :controller</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">include_default_accept_headers</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">infer_spec_type_from_file_location!</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">filter_rails_from_backtrace!</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Well now I do feel satisfied with the code, let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Refactors test headers for each request"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember you can review the code up to this point at the <a href="https://github.com/madeindjs/api_on_rails">GitHub repository</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_4">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nice job on finishing this chapter. Although it was a short one it was a crucial step as this will help us write better and faster tests. On next chapter we will add the authentication mechanism so we&#8217;ll be using across the application as well as limiting the access for certain actions.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter05-authentication" class="sect0">Authenticating users</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>It&#8217;s been a long way since you started. I hope you are enjoying this trip as much as me. On previous chapter we refactor our test suite and since we did not add much code. If you skipped that chapter I recommend you read it. As we are going to be using some of the methods in the chapters to come.</p>
</div>
<div class="paragraph">
<p>You can clone the project up to this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone <span class="nt">--branch</span> chapitre_4 https://github.com/madeindjs/market_place_api</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this chapter things will get very interesting because we are going to set up our authentication mechanism. In my opinion this is going to be one of the most interesting chapters. We will introduce a lot of new terms and you will end with a simple but powerful authentication system. Don&#8217;t feel panic we will get to that.</p>
</div>
<div class="paragraph">
<p>First things first (and as usual when starting a new chapter) we will create a new branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter5</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stateless_session">Stateless session</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we go any further, something must be clear: <strong>an API does not handle sessions</strong>. If you don&#8217;t have experience building these kind of applications it might sound a little crazy but stay with me. An API should be stateless which means by definition <em>is one that provides a response after your request, and then requires no further attention.</em>. Which means no previous or future state is required for the system to work.</p>
</div>
<div class="paragraph">
<p>The flow for authenticating the user through an API is very simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The client request for <code>sessions</code> resource with the corresponding credentials, usually email and password.</p>
</li>
<li>
<p>The server returns the <code>user</code> resource along with its corresponding authentication token</p>
</li>
<li>
<p>Every page that requires authentication, the client has to send that <code>authentication token</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Of course this is not the only 3-step to follow, and even on step 2 you might think, well do I really need to respond with the entire user or just the <code>authentication token</code>, I would say, it really depends on you, but I like to return the entire user, this way I can map it right away on my client and save another possible request from being placed.</p>
</div>
<div class="paragraph">
<p>In this section and the next we will be focusing on building a Sessions controller along with its corresponding actions. We&#8217;ll then complete the request flow by adding the necessary authorization access.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication_token">Authentication token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we proceed with the logic on the sessions controller, we have to first add the <code>authentication token</code> field to the <code>user</code> model and then add a method to actually set it.</p>
</div>
<div class="paragraph">
<p>First we generate the migration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_authentification_token_to_users auth_token:string</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a good practice I like to setup <code>string</code> values to an empty string. Let&#8217;s add an index with a unique truly condition. This way we warranty there are no users with the same token at a database level. So let&#8217;s do that:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20181114134521_add_authentification_token_to_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddauthentificationTokenToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:auth_token</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">default: </span><span class="s1">''</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:auth_token</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we run the migrations to add the field and prepare the test database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate
<span class="o">==</span> 20181114134521 AddauthentificationTokenToUsers: migrating <span class="o">====================</span>
<span class="nt">--</span> add_column<span class="o">(</span>:users, :auth_token, :string, <span class="o">{</span>:default<span class="o">=&gt;</span><span class="s2">""</span><span class="o">})</span>
   -&gt; 0.0004s
<span class="nt">--</span> add_index<span class="o">(</span>:users, :auth_token, <span class="o">{</span>:unique<span class="o">=&gt;</span><span class="nb">true</span><span class="o">})</span>
   -&gt; 0.0010s
<span class="o">==</span> 20181114134521 AddauthentificationTokenToUsers: migrated <span class="o">(</span>0.0016s<span class="o">)</span> <span class="o">===========</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it would be a good time to add some response and uniqueness tests to our <code>user</code> model spec:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/user_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:auth_token</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_uniqueness_of</span><span class="p">(</span><span class="ss">:auth_token</span><span class="p">)}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We then move to the <code>user.rb</code> file and add the necessary code to make our tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="sr">/app/mo</span><span class="n">dels</span><span class="o">/</span><span class="n">user</span><span class="p">.</span><span class="nf">rb</span>
<span class="o">----</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:auth_token</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
<span class="o">----</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we will work on a method that will generate a unique authentication token for each user in order to authenticate them later through the API. So let&#8217;s build the tests first.</p>
</div>
<div class="listingblock">
<div class="title">spec/models/user_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s2">"#generate_authentification_token!"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"generates a unique token"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">generate_authentification_token!</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_nil</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"generates another token when one already has been taken"</span> <span class="k">do</span>
      <span class="n">existing_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">auth_token: </span><span class="s2">"auniquetoken123"</span><span class="p">)</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">generate_authentification_token!</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">eql</span> <span class="n">existing_user</span><span class="p">.</span><span class="nf">auth_token</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before use <code>validate_uniqueness_of</code> method we have to install <code>shoulda-matchers</code> gem. To do so add this gem in <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'shoulda-matchers'</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And load it in <code>rails_helper.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">spec/rails_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>
  <span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">include</span><span class="p">(</span><span class="no">Shoulda</span><span class="o">::</span><span class="no">Matchers</span><span class="o">::</span><span class="no">ActiveModel</span><span class="p">,</span> <span class="ss">type: :model</span><span class="p">)</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">include</span><span class="p">(</span><span class="no">Shoulda</span><span class="o">::</span><span class="no">Matchers</span><span class="o">::</span><span class="no">ActiveRecord</span><span class="p">,</span> <span class="ss">type: :model</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The tests initially fail, as expected:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bundle exec rspec spec/models/user_spec.rb
.......FF

Failures:

  1) User#generate_authentification_token! generates a unique token
     Failure/Error: @user.generate_authentification_token!

     NoMethodError:
       undefined method `generate_authentification_token!' for #&lt;User:0x0000558948d23760&gt;
     # ./spec/models/user_spec.rb:23:in `block (3 levels) in &lt;top (required)&gt;'

  2) User#generate_authentification_token! generates another token when one already has been taken
     Failure/Error: @user.generate_authentification_token!

     NoMethodError:
       undefined method `generate_authentification_token!' for #&lt;User:0x0000558948d18720&gt;
     # ./spec/models/user_spec.rb:29:in `block (3 levels) in &lt;top (required)&gt;'</pre>
</div>
</div>
<div class="paragraph">
<p>We are going to hook this <code>generate_authentication_token!</code> to a <code>before_create</code> callback to warranty every user has an authentication token which does not collides with an existing one. To create the token there are many solutions, I&#8217;ll go with the <code>friendly_token</code> that devise offers already, but I could also do it with the <code>hex</code> method from the <a href="https://ruby-doc.org/stdlib-2.5.3/libdoc/securerandom/rdoc/SecureRandom.html"><code>SecureRandom</code></a> class.</p>
</div>
<div class="paragraph">
<p>The code to generate the token is fairly simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_create</span> <span class="ss">:generate_authentification_token!</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">generate_authentification_token!</span>
    <span class="k">begin</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">auth_token</span> <span class="o">=</span> <span class="no">Devise</span><span class="p">.</span><span class="nf">friendly_token</span>
    <span class="k">end</span> <span class="k">while</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="ss">auth_token: </span><span class="n">auth_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After that we just need to hook it up to the <code>before_create</code> callback:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
.........

Finished <span class="k">in </span>0.05079 seconds <span class="o">(</span>files took 0.49029 seconds to load<span class="o">)</span>
9 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>As usual, let&#8217;s commit the changes and move on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds user authentification token"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessions_controller">Sessions controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back to the sessions controller the <code>actions</code> we&#8217;ll be implementing on it are going to be handled as RESTful services: the sign in will be handled by a <em>POST</em> request to the <code>create</code> action and the sign out will be handled by a <em>DELETE</em> request to the <code>destroy</code> action.</p>
</div>
<div class="paragraph">
<p>To get started we will start by creating the sessions controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller sessions</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to move the files into the <code>api/v1</code> directory, for both on the <code>app</code> and <code>spec</code> folders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mv </span>app/controllers/sessions_controller.rb app/controllers/api/v1
<span class="nv">$ </span><span class="nb">mv </span>spec/controllers/sessions_controller_spec.rb spec/controllers/api/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>After moving the files we have to update them to meet the directory structure we currently have as shown on followed snippets:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/sessions_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/sessions_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">SessionsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_sign_in_success">Sign in success</h3>
<div class="paragraph">
<p>Our first stop will be the <code>create</code> action. But first let&#8217;s generate our tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/sessions_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">SessionsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when the credentials are correct'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span>
          <span class="ss">session: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'12345678'</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns the user record corresponding to the given credentials'</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="p">.</span><span class="nf">reload</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:auth_token</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when the credentials are incorrect'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span>
          <span class="ss">session: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'invalidpassword'</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns a json with an error'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s1">'Invalid email or password'</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">422</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The tests are pretty straightforward. We simply return the <code>user</code> in JSON format if the credentials are correct but if not we just send a JSON with an error message. Next we need to implement the code to make our tests be green. But before that we will add the end points to our <code>route.rb</code> file (both the <code>create</code> and <code>destroy</code> end point).</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">]</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/sessions_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user_password</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:session</span><span class="p">][</span><span class="ss">:password</span><span class="p">]</span>
    <span class="n">user_email</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:session</span><span class="p">][</span><span class="ss">:email</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">user_email</span><span class="p">.</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">user_email</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid_password?</span> <span class="n">user_password</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">user</span><span class="p">.</span><span class="nf">generate_authentification_token!</span>
      <span class="n">user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">user</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">user</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="s1">'Invalid email or password'</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we run our tests it is necessary to add the <code>devise</code> test helpers in the <code>spec_helper.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">spec/rails_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># ...</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Devise</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">ControllerHelpers</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we run our tests they should be all passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/sessions_controller_spec.rb
....

Finished <span class="k">in </span>0.06515 seconds <span class="o">(</span>files took 0.49218 seconds to load<span class="o">)</span>
4 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now this would be a nice moment to commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds sessions controller create action"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sign_out">Sign out</h3>
<div class="paragraph">
<p>We currently have the <code>sign in</code> end point for the API. Now it is time to build a <code>sign out</code> url. You might wonder why since we are not handling <code>sessions</code> and there is nothing to destroy. In this case we are going to update the authentication token so the last one becomes useless and cannot be used again.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is actually not necessary to include this end point, but I do like to include it to expire the authentication tokens.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As usual we start with the tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/sessions_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">SessionsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s2">"DELETE #destroy"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">sign_in</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">store: </span><span class="kp">false</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the <code>test</code> is super simple. Now we just need to implement the necessary code to make our tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/sessions_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">auth_token: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">generate_authentication_token!</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we are expecting an <code>id</code> to be sent on the request which has to correspond to the <em>user authentication token</em>. We will add the <code>current_user</code> method to handle this smoothly. For now we will just leave it like that.</p>
</div>
<div class="paragraph">
<p>Take a deep breath, we are almost there! In the meantime commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds destroy session action added"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_current_user">Current User</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have worked with <a href="https://github.com/plataformatec/devise">devise</a> before you probably are familiar with the auto-generated methods for handling the authentication filters or getting the user that is currently on session. <sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<div class="paragraph">
<p>In our case we will need to override the <code>current_user</code> method to meet our needs, and that is finding the user by the authentication token that is going to be sent on each request to the api. Let me clarify that for you.</p>
</div>
<div class="paragraph">
<p>Once the client sign ins a user with the correct credentials. The API will return the <code>authentication token</code> from that actual user. Each time that client requests for a protected page we will need to fetch the user from that <code>authentication token</code> that comes in the request and it could be as a <code>param</code> or as a <code>header</code>.</p>
</div>
<div class="paragraph">
<p>In our case we&#8217;ll be using an <code>Authorization</code> header which is commonly used for this type of purpose. I personally find it better because it gives context to the actual request without polluting the URL with extra parameters.</p>
</div>
<div class="paragraph">
<p>When it comes to authentication I like to add all the related methods into a separate file, and after that just include the file inside the <code>ApplicationController</code>. This way it is really easy to test in isolation. Let&#8217;s create the file under de <code>controllers/concerns</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">touch </span>app/controllers/concerns/authenticable.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that let&#8217;s create a <code>concerns</code> directory under <code>spec/controllers/</code> and an <code>authenticable_spec.rb</code> file for our authentication tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>spec/controllers/concerns
<span class="nv">$ </span><span class="nb">touch </span>spec/controllers/concerns/authenticable_spec.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>As usual we start by writing our tests, in this case for our <code>current_user</code> method, which will fetch a user by the authentication token ok the <code>Authorization</code> header.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/concerns/authenticable_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Authentication</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Authenticable</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:authentication</span><span class="p">)</span> <span class="p">{</span> <span class="no">Authentication</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">authentication</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"#current_user"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s2">"Authorization"</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="n">authentication</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:request</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">it</span> <span class="s2">"returns the user from the authorization header"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">authentication</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">auth_token</span><span class="p">).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are wondering: <em>"Why the hell we created an Authentication class inside the spec file??"</em>. The answer is simple: when it comes to test modules I find it easy to include them into a temporary class and stub any other methods I may require later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our tests should fail. Let&#8217;s implement the necessary code:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="c1"># Devise methods overwrites</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">auth_token: </span><span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now our tests should be green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>$ rspec spec/controllers/concerns/authenticable_spec.rb
.

Finished in 0.0149 seconds (files took 0.49496 seconds to load)
1 example, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we just need to include the <code>Authenticable</code> module into the <code>ApplicationController</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/application_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="c1"># ...</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This would be a good time to commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds authenticable module for managing authentication methods"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authenticate_with_token">Authenticate with token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authorization is a big part when building applications because in contrary to authentication that allows us to identify the user in the system, authorization help us to define what they can do.</p>
</div>
<div class="paragraph">
<p>Although we have a good end point for updating the user it has a major security hole: allowing anyone to update any user on the application. In this section we&#8217;ll be implementing a method that will require the user to be signed in preventing in this way any unauthorized access. We will return a not authorized JSON message along with its corresponding http code.</p>
</div>
<div class="paragraph">
<p>First we have to add some tests on the <code>authenticable_spec.rb</code> for the <code>authenticate_with_token</code> method:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/concerns/authenticable_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Authentication</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Authenticable</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'#authenticate_with_token'</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">authentication</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
      <span class="n">response</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:response_code</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
      <span class="n">response</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:body</span><span class="p">).</span><span class="nf">and_return</span><span class="p">({</span> <span class="s1">'errors'</span> <span class="o">=&gt;</span> <span class="s1">'Not authenticated'</span> <span class="p">}.</span><span class="nf">to_json</span><span class="p">)</span>
      <span class="n">authentication</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:response</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'render a json error message'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s1">'Not authenticated'</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we are using the <code>Authentication</code> class again and stubbing the <code>request</code> and <code>response</code> for handling the expected answer from the server. Now it is time to implement the code to make our tests pass.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">authenticate_with_token!</span>
    <span class="k">unless</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">present?</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="s1">'Not authenticated'</span> <span class="p">},</span>
             <span class="ss">status: :unauthorized</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point we have just built a very simple authorization mechanism to prevent unsigned users from accessing the API. Just update the file <code>users_controller.rb</code> with the method <code>current_user</code> and prevent access with the command <code>authenticate_with_token!</code>!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s commit these changes and keep moving forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds the authenticate with token method to handle access to actions"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authorize_actions">Authorize actions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is now time to update our <code>users_controller.rb</code> file to deny the access to some of the actions. Also we will implement the <code>current_user</code> method on the <code>update</code> and <code>destroy</code> actions to make sure that the user who is on <strong><code>session'</strong> will be capable only to `update</code> its data or self <code>destroy</code>.</p>
</div>
<div class="paragraph">
<p>We will start with the <code>update</code> action. We will no longer fetch the user by id, instead of that by the <code>auth_token</code> on the <code>Authorization</code> header provided by the current_user method.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># we just change method here</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">user</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">user</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">user</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And as you might expect, if we run our users controller specs they should fail:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rspec spec/controllers/api/v1/users_controller_spec.rb
.......FFFFF.

Failures:

  1) Api::V1::UsersController PUT/PATCH #update when is successfully updated renders the json representation for the updated user
     Failure/Error: if user.update(user_params)

     NoMethodError:
       undefined method 'update' for nil:NilClass

   ...</pre>
</div>
</div>
<div class="paragraph">
<p>The solution is fairly simple: we just need to add the <code>Authorization</code> header to the request.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'PUT/PATCH #update'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully updated'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
        <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'newmail@example.com'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
        <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'bademail.com'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the tests should be all green. But wait something does not feel quite right isn&#8217;t it? We can refactor the line we just added and put it on the <code>HeadersHelpers</code> module we build:</p>
</div>
<div class="listingblock">
<div class="title">spec/support/request_helpers.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Request</span>
  <span class="c1"># ...</span>
  <span class="k">module</span> <span class="nn">HeadersHelpers</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="nf">api_authorization_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
      <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now each time we need to have the <code>current_user</code> on our specs we simply call the <code>api_authorization_header</code> method. I&#8217;ll let you do that with the <code>users_controller_spec.rb</code> for the update spec. For the destroy action we will do the same, because we just have to make sure a user is capable to self destroy</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'PUT/PATCH #update'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully updated'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="n">api_authorization_header</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
        <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'newmail@example.com'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="n">api_authorization_header</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
        <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'bademail.com'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">format: :json</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now for the spec file and as mentioned before, we just need to add the <code>api_authorization_header</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now for the spec file and as mentioned before, we just need to add the <code>api_authorization_header</code>:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'DELETE #destroy'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We should have all of our tests passing. The last step for this section consist on adding the corresponding authorization access for these last two actions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is common to just prevent the actions on which the user is performing actions on the record itself (in this case the <code>destroy</code> and <code>update</code> action).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On the <code>users_controller.rb</code> we have to filter some these actions to prevent the access</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update destroy]</span>
  <span class="n">respond_to</span> <span class="ss">:json</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our tests should still be passing. And from now on every time we want to prevent any action from being trigger we simply add the <code>authenticate_with_token!</code> method on a <code>before_action</code> hook.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s just commit this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds authorization for the users controller"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly but not least we will finish the chapter by refactoring the <code>authenticate_with_token!</code> method. It is really a small enhancement but it will make the method more descriptive. You&#8217;ll see what I mean in a minute. But first things first let&#8217;s add some specs.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/concerns/authenticable_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Authenticable</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'#user_signed_in?'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s2">"when there is a user on 'session'"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="n">authentication</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_user_signed_in</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"when there is no user on 'session'"</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="n">authentication</span><span class="p">.</span><span class="nf">stub</span><span class="p">(</span><span class="ss">:current_user</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_user_signed_in</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we added two simple specs to know whether the user is signed in or not (As I mentioned early it is just for visual clarity). But let&#8217;s keep going and add the implementation.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">authenticate_with_token!</span>
    <span class="k">unless</span> <span class="n">user_signed_in?</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="s1">'Not authenticated'</span> <span class="p">},</span>
             <span class="ss">status: :unauthorized</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">user_signed_in?</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">present?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, now the <code>authenticate_with_token!</code> it&#8217;s easier to read not just for you but for other developers joining the project. This approach has also another side benefit. In any case you want to change or extend how to validate if the user is signed in you can just do it on the <code>user_signed_in?</code> method.</p>
</div>
<div class="paragraph">
<p>Now our tests should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/concerns/authenticable_spec.rb
.....

Finished <span class="k">in </span>0.07415 seconds <span class="o">(</span>files took 0.702 seconds to load<span class="o">)</span>
5 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds user_signed_in? method to know whether the user is logged in or not"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_5">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Yeah! you made it! you are half way done! Keep up the good work. This chapter was a long and hard one but it is a great step forward on setting a solid mechanism for handling user authentication. We even scratch the surface for simple authorization rules.</p>
</div>
<div class="paragraph">
<p>In the next chapter we will be focusing on customizing the JSON output for the user with <code>active_model_serializers</code> gem and adding a <code>product</code> model to the equation by giving the user the ability to create a product and publish it for sale.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter06-user-products" class="sect0">User products</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>On previous chapter we implemented the authentication mechanism who we&#8217;ll be using all along the app. Right now we have a very simple implementation of the <code>user</code> model but the moment of truth has come where. We will customize the JSON output but also add a second resource: <em>user products</em>. These are the items that the user will be selling in the app, and by consequence will be directly associated. If you are familiar with Rails you may already know what I&#8217;m talking about. For those who doesn&#8217;t known what I&#8217;m talking about we will associated the <code>User</code> to the <code>Product</code> model using the <code>has_many</code> and <code>belongs_to</code> active record methods.</p>
</div>
<div class="paragraph">
<p>In this chapter we will build the <code>Product</code> model from the ground up associate it with the user and create the necessary end points for any client to access the information.</p>
</div>
<div class="paragraph">
<p>You can clone the project up to this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone <span class="nt">--branch</span> chapter6 https://github.com/madeindjs/market_place_api</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start and as usual when starting new features, we need to branch it out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter6</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_product_model">Product model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We first start by creating Product model then we add some validations to it and finally we will associate it with the <code>user</code> model. As the user model the product will be fully tested and will also have an <em>automatic destruction</em> if the user in this case is destroyed.</p>
</div>
<div class="sect2">
<h3 id="_product_bare_bones">Product bare bones</h3>
<div class="paragraph">
<p>The product model will need several fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>price</code> attribute to hold the product price</p>
</li>
<li>
<p>a <code>published</code> boolean to know whether the product is ready to sell or not</p>
</li>
<li>
<p>a <code>title</code> to define a sexy product title</p>
</li>
<li>
<p>a <code>user_id</code> to associate this particular product to a user</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you may already know we generate it with the <code>rails generate</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model Product title:string price:decimal published:boolean user_id:integer:index
    invoke  active_record
    create    db/migrate/20181218064350_create_products.rb
    create    app/models/product.rb
    invoke    rspec
    create      spec/models/product_spec.rb
    invoke      factory_bot
    create        spec/factories/products.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may notice we also added an <code>index</code> option to the <code>user_id</code> attribute. This is a good practice when using association keys as it optimizes the query to a database level. It is not compulsory that you do that but I highly recommend it.</p>
</div>
<div class="paragraph">
<p>The migration file should look like this:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20181218064350_create_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:price</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">boolean</span> <span class="ss">:published</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:user_id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Take note that we set some default values for all of the attributes except the <code>user_id</code>. This way we keep a high consistency level on our database as we don&#8217;t deal with many NULL values.</p>
</div>
<div class="paragraph">
<p>Next we will add some basic tests to the Product model. We will just make sure the object responds to the fields we added, as shown next:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:product</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:product</span> <span class="p">}</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">product</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:price</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:published</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to migrate the database so we get out tests green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure the tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/product_spec.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although our tests are passing we need to do some ground work for the product factory (as for now is all hardcoded). As you recall we have been using <code>Faker</code> to fake the values for our tests models. Now it is time to do the same with the <code>product</code> model.</p>
</div>
<div class="listingblock">
<div class="title">spec/factories/products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:product</span> <span class="k">do</span>
    <span class="n">title</span> <span class="p">{</span> <span class="no">FFaker</span><span class="o">::</span><span class="no">Product</span><span class="p">.</span><span class="nf">product_name</span> <span class="p">}</span>
    <span class="n">price</span> <span class="p">{</span> <span class="nb">rand</span> <span class="o">*</span> <span class="mi">100</span> <span class="p">}</span>
    <span class="n">published</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span>
    <span class="n">user_id</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now each product we create will look a bit more like a real product. We still need to work on the <code>user_id</code> as is hardcoded but we will get to that later.</p>
</div>
</div>
<div class="sect2">
<h3 id="_product_validations">Product validations</h3>
<div class="paragraph">
<p>As we saw with the user, validations are an important part when building any kind of application. This will prevent any junk data from being saved onto the database. In the product we have to make sure for example the price is a <code>number</code> and that is not negative.</p>
</div>
<div class="paragraph">
<p>Also an important thing about validation when working with associations, is in this case to validate that every product has a user, so in this case we need to validate the presence of the <code>user_id</code>. You can see what I&#8217;m talking about in next code snippet.</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_presence_of</span> <span class="ss">:title</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_presence_of</span> <span class="ss">:price</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_numericality_of</span><span class="p">(</span><span class="ss">:price</span><span class="p">).</span><span class="nf">is_greater_than_or_equal_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_presence_of</span> <span class="ss">:user_id</span> <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to add the implementation to make the tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">},</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tests are now green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/product_spec.rb
........

Finished <span class="k">in </span>0.04173 seconds <span class="o">(</span>files took 0.74322 seconds to load<span class="o">)</span>
8 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have a bunch of good quality code. Let&#8217;s commit it and keep moving:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds product model bare bones along with some validations"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_productuser_association">Product/User association</h3>
<div class="paragraph">
<p>In this section we will be building the association between the product and the user model, we already have the necessary fields, so we just need to update a couple of files and we will be ready to go. First we need to modify the products factory to relate it to the user. So how do we do that?:</p>
</div>
<div class="listingblock">
<div class="title">spec/factories/products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:product</span> <span class="k">do</span>
    <span class="n">title</span> <span class="p">{</span> <span class="no">FFaker</span><span class="o">::</span><span class="no">Product</span><span class="p">.</span><span class="nf">product_name</span> <span class="p">}</span>
    <span class="n">price</span> <span class="p">{</span> <span class="nb">rand</span> <span class="o">*</span> <span class="mi">100</span> <span class="p">}</span>
    <span class="n">published</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we just rename the <code>user_id</code> attribute to <code>user</code> and we did not specify a value. FactoryBot is smart enough to create a <code>user</code> object for every product and associate them automatically. Now we need to add some tests for the association.</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">belong_to</span> <span class="ss">:user</span> <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the test we added is very simple (thanks to the power of <a href="https://github.com/thoughtbot/shoulda-matchers">shoulda-matchers</a>). We continue with the implementation now:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="c1">#...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to run the test we added just to make sure everything is all right:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/product_spec.rb
.........

Finished <span class="k">in </span>0.08815 seconds <span class="o">(</span>files took 0.75134 seconds to load<span class="o">)</span>
9 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Currently we only have one part of the association, but as you may be wondering already we have to add a <code>has_many</code> association to the user model.</p>
</div>
<div class="paragraph">
<p>First we add the test on the <code>user_spec.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/user_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:products</span><span class="p">)</span> <span class="p">}</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation on the <code>user</code> model is extremely easy:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we run the user specs. They should be all nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/user_spec.rb
..........

Finished <span class="k">in </span>0.08411 seconds <span class="o">(</span>files took 0.74624 seconds to load<span class="o">)</span>
10 examples, 0 failures</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dependency_destroy">Dependency destroy</h3>
<div class="paragraph">
<p>Something I&#8217;ve seen in other developers code when working with associations, is that they forget about dependency destruction between models. What I mean by this is that if a user is destroyed, the user&#8217;s products in this case should be destroyed as well.</p>
</div>
<div class="paragraph">
<p>So to test this interaction between models, we need a user with a bunch of products, then we destroy that user expecting the products disappear along with it. A simple implementation would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">products</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">products</span>
<span class="n">user</span><span class="p">.</span><span class="nf">destroy</span>
<span class="n">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
  <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="nf">id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">raise_error</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We first save the products into a variable for later access then we destroy the user and loop through the products variable expecting each of the products to raise an exception. Putting everything together should look like the code bellow:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/user_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'#products association'</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'destroys the associated products on self destruct'</span> <span class="k">do</span>
      <span class="n">products</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">products</span>
      <span class="vi">@user</span><span class="p">.</span><span class="nf">destroy</span>
      <span class="n">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">raise_error</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The necessary code to make tests pass is just an option on the <code>has_many</code> association method:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With that code added all of our tests should be passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/
...........................................

Finished <span class="k">in </span>0.44188 seconds <span class="o">(</span>files took 0.8351 seconds to load<span class="o">)</span>
43 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit this and move on to the next sections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Finishes modeling the product model along with user associations"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_products_endpoints">Products endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is now time to start building the products endpoints. For now we will just build 5 REST actions and some of them will be nested inside the <code>users</code> resource. In the next Chapter we will customize the JSON output by implementing the <code>active_model_serializers</code> gem.</p>
</div>
<div class="paragraph">
<p>First we need to create the <code>products_controller</code>, and we can easily achieve this with the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api/v1/products</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above will generate a bunch of files ready to start working, what I mean by this is that it will generate the controller and specs files already scoped to the version 1 of the API.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a warmup we will start nice and easy by building the <code>show</code> action for the product.</p>
</div>
<div class="sect2">
<h3 id="_show_action_for_products">Show action for products</h3>
<div class="paragraph">
<p>As usual we begin by adding some product <code>show</code> controller specs. The strategy here is very simple: we just need to create a single product and make sure the response from server is what we expect.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@product</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the information about a reporter on a hash'</span> <span class="k">do</span>
      <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We then add the code to make the test pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait! Don&#8217;t run the tests yet. Remember we need to add the resource to the <code>routes.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span><span class="p">,</span> <span class="ss">constraints: </span><span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we make sure the tests are nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/products_controller_spec.rb
..

Finished <span class="k">in </span>0.05474 seconds <span class="o">(</span>files took 0.75052 seconds to load<span class="o">)</span>
2 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may notice already the specs and implementation are very simple. Actually they behave the same as the users.</p>
</div>
</div>
<div class="sect2">
<h3 id="_products_list">Products list</h3>
<div class="paragraph">
<p>Now it is time to output a list of products, which could be displayed as the market place product catalog. This endpoint is also accessible without credentials, that means we don&#8217;t require the user to be logged-in to access the data. As usual we will start writing some specs.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="mi">4</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span> <span class="p">}</span>
      <span class="n">get</span> <span class="ss">:index</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns 4 records from the database'</span> <span class="k">do</span>
      <span class="n">products_response</span> <span class="o">=</span> <span class="n">json_response</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">products_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">items</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Warning, the <code>have</code> we use on previous test was no longer available since Rspec 3.0. We must install one more gem:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">gem</span> <span class="s1">'rspec-collection_matchers'</span><span class="p">,</span> <span class="s1">'~&gt; 1.1'</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s move into the implementation, which for now is going to be a sad <code>all</code> class method.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
  <span class="c1">#...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And remember, you have to add the corresponding route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are done for now with the public product endpoints. In the sections to come we will focus on building the actions that require a user to be logged in to access them. Said that we are committing this changes and continue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Finishes modeling the product model along with user associations"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_products">Creating products</h3>
<div class="paragraph">
<p>Creating products is a bit tricky because we&#8217;ll need some extra configuration to give a better structure to this endpoint. The strategy we will follow is to nest the products <code>create</code> action into the users which will deliver us a more descriptive endpoint, in this case <code>/users/:user_id/products</code>.</p>
</div>
<div class="paragraph">
<p>So our first stop will be the <code>products_controller_spec.rb</code> file.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="vi">@product_attributes</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">attributes_for</span> <span class="ss">:product</span>
        <span class="n">api_authorization_header</span> <span class="n">user</span><span class="p">.</span><span class="nf">auth_token</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">product: </span><span class="vi">@product_attributes</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json representation for the product record just created'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product_attributes</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not created'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="vi">@invalid_product_attributes</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">title: </span><span class="s1">'Smart TV'</span><span class="p">,</span> <span class="ss">price: </span><span class="s1">'Twelve dollars'</span> <span class="p">}</span>
        <span class="n">api_authorization_header</span> <span class="n">user</span><span class="p">.</span><span class="nf">auth_token</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">product: </span><span class="vi">@invalid_product_attributes</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders an errors json'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:errors</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json errors on why the user could not be created'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">][</span><span class="ss">:price</span><span class="p">]).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s1">'is not a number'</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">422</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wow! We added a bunch of code but if you recall from previous section the spec actually looks the same as the user create action (but with minor changes). Remember we have this endpoint nested so we need to make sure we send the <code>user_id</code> param on each request as you can see on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">product: </span><span class="vi">@product_attributes</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This way we can fetch the user and create the product for that specific user. But wait there is more. If we take this approach we will have to increment the scope of our authorization mechanism because we have to fetch the user from the <code>user_id</code> param. Well in this case and if you remember we built the logic to get the user from the <code>authorization</code> header and assigned it a <code>current_user</code> method. This is rapidly fixable by just adding the <code>authorization</code> header into the request, and fetch that user from it. So let&#8217;s do that.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">product</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">product_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we are protecting the create action with the <code>authenticate_with_token!</code> method, and on the <code>create</code> action we are building the product in relation to the <code>current_user</code>.</p>
</div>
<div class="paragraph">
<p>By this point you may be asking yourself <em>"Well is it really necessary to nest the action? By the end of the day we don&#8217;t really use the <code>user_id</code> from the URI pattern"</em>. In my opinion you are totally right. My only argument here is that with this approach the endpoint is way more descriptive from the outside as we are telling the developers that in order to create a product we need a user.</p>
</div>
<div class="paragraph">
<p>So it is really up to you how you want to organize your resources and expose them to the world, my way is not the only one and it does not mean is the correct one either. In fact I encourage you to play around with different approaches and choose the one that fills your eye.</p>
</div>
<div class="paragraph">
<p>One last thing before you run your tests, just the necessary route:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span><span class="p">,</span> <span class="ss">constraints: </span><span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span> <span class="k">do</span>
        <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you run the tests now, they should be all green:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rspec spec/controllers/api/v1/products_controller_spec.rb
.........

Finished in 0.21831 seconds (files took 0.75823 seconds to load)
9 examples, 0 failures</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_products">Updating products</h3>
<div class="paragraph">
<p>Hopefully by now you understand the logic to build the upcoming actions, in this section we will focus on the <code>update</code> action, which will work similarly to the <code>create</code> one, we just need to fetch the product from the database and the update it.</p>
</div>
<div class="paragraph">
<p>We are first add the action to the routes, so we don&#8217;t forget later:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span><span class="p">,</span> <span class="ss">constraints: </span><span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span> <span class="k">do</span>
        <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create update]</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start dropping some tests I just want to clarify that similarly to the <code>create</code> action we will scope the product to the <code>current_user</code>. In this case we want to make sure the product we are updating is owned by the current user. So we will fetch that product from the <code>user.products</code> association provided by Rails.</p>
</div>
<div class="paragraph">
<p>First we add some specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'PUT/PATCH #update'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="vi">@product</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span>
      <span class="n">api_authorization_header</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is successfully updated'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="s1">'An expensive TV'</span> <span class="p">}</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json representation for the updated user'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s1">'An expensive TV'</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not updated'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">patch</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">price: </span><span class="s1">'two hundred'</span> <span class="p">}</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders an errors json'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:errors</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'renders the json errors on why the user could not be created'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">][</span><span class="ss">:price</span><span class="p">]).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s1">'is not a number'</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">422</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The tests may look complex but take a second peek. They are almost the same we built for users. The only difference here is the nested routes as we saw on previous section, which in this case we need to send the <code>user_id</code> as a parameter.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s implement the code to make our tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create update]</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">200</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">product</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the implementation is pretty straightforward. We simply fetch the product from the <code>current_user</code> and simply update it. We also added this action to the <code>before_action</code> hook to prevent any unauthorized user to update a product.</p>
</div>
<div class="paragraph">
<p>Now if we run the tests, they should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/products_controller_spec.rb
..............

Finished <span class="k">in </span>0.24404 seconds <span class="o">(</span>files took 0.75973 seconds to load<span class="o">)</span>
14 examples, 0 failures</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_destroying_products">Destroying products</h3>
<div class="paragraph">
<p>Our last stop for the products endpoints will be the <code>destroy</code> action. You might now imagine how this would look like. The strategy in here will be pretty similar to the create and update action (which means we are going to nest the route into the <code>users</code> resources) then fetch the product from the <code>user.products</code> association and finally destroy it, returning a <code>204</code> code.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start again by adding the route name to the routes file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span><span class="p">,</span> <span class="ss">constraints: </span><span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span> <span class="k">do</span>
        <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create update destroy]</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After this, we have to add some tests as shown on this code snippet:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'DELETE #destroy'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="vi">@product</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span>
      <span class="n">api_authorization_header</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">204</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we simply add the necessary code to make the tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create update destroy]</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the three-line implementation does the job. We can run the tests to make sure everything is good and after that we will commit the changes as we added a bunch of new code. Also make sure you hook this action to the <code>before_action</code> callback as with the <code>update</code> action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/products_controller_spec.rb
...............

Finished <span class="k">in </span>0.25959 seconds <span class="o">(</span>files took 0.80248 seconds to load<span class="o">)</span>
15 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds the products create, update and destroy action nested on the user resources"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_feed_the_database">Feed the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we continue with more code let&#8217;s populate the database with some fake data. Thankfully we have some factories that should do the work for us. So let&#8217;s do use them.</p>
</div>
<div class="paragraph">
<p>First we run the rails console command from the Terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails console</code></pre>
</div>
</div>
<div class="paragraph">
<p>We then create a bunch of product objects with the <code>FactoryBot</code> gem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mf">5.2</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
<span class="mf">2.5</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oops, you probably have some errors showing up:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Traceback (most recent call last):
        3: from (irb):1
        2: from (irb):1:in `times'
        1: from (irb):1:in `block in irb_binding'
NameError (uninitialized constant FactoryBot)</pre>
</div>
</div>
<div class="paragraph">
<p>This is because we are running the console on <code>development</code> environment but that does not make sense with our <code>Gemfile</code>, which currently looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'factory_bot_rails'</span>
  <span class="n">gem</span> <span class="s1">'ffaker'</span><span class="p">,</span> <span class="s1">'~&gt; 2.10'</span>
  <span class="n">gem</span> <span class="s1">'rspec-collection_matchers'</span><span class="p">,</span> <span class="s1">'~&gt; 1.1'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.8'</span>
  <span class="n">gem</span> <span class="s1">'shoulda-matchers'</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You see where the problem is? If you pay attention you will notice that the <code>factory_bot_rails</code> gem is only available for the test environment but no for the development one (which is what we need). This can be fix really fast:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'factory_bot_rails'</span>
  <span class="n">gem</span> <span class="s1">'ffaker'</span><span class="p">,</span> <span class="s1">'~&gt; 2.10'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the we moved the <code>ffaker</code> gem to the shared group as we use it inside the factories we describe earlier. Now just run the <code>bundle</code> command to update the libraries. Then build the products you want like so:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rails console
Loading development environment (Rails 5.2.1)
2.5.3 :001 &gt; 20.times { FactoryBot.create :product }</pre>
</div>
</div>
<div class="paragraph">
<p>From now on you will be able to create any object from factories such as users, products, orders, etc. So let&#8217;s commit this tiny change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Updates test environment factory gems to work on development"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_6">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On the next chapter we will focus on customizing the output from the <code>user</code> and <code>product</code> models using the active model serializers gem. It will help us to easily filter attributes to display (or handle associations as embedded objects for example).</p>
</div>
<div class="paragraph">
<p>I hope you have enjoyed this chapter. It is a long one but the code we put together is an excellent base for the core app.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter07-improve-json" class="sect0">JSON with Active Model Serializers</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In previous chapter we added a <code>products</code> resource to the application and built all the necessary endpoints up to this point. We also associated the product model with the user and protected some of the <code>products_controller</code> actions on the way. By now you should feel really happy with all the work but we still have to do some heavy lifting. Currently we have something which look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tag Case"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"98.7761933800815"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It doesn&#8217;t look nice, as the JSON output should render just an array of products, with the <code>products</code> as the root key. Something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tag Case"</span><span class="p">,</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is further explained in the <a href="http://jsonapi.org/format/#document-structure-resource-collection-representations">JSON API</a> website.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A collection of any number of resources SHOULD be represented as an array of resource objects or IDs, or as a single "collection object"</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>I highly recommend you go and bookmark this reference. It is amazing and will cover some points I might not.</p>
</div>
<div class="paragraph">
<p>In this chapter we will customize the JSON output using the <code>active_model_serializers</code> gem, for more information you can review the <a href="https://github.com/rails-api/active_model_serializers">repository</a> on GitHub. I&#8217;ll cover some points in here from installation to implementation but I do recommend you check the gem docs on your free time.</p>
</div>
<div class="paragraph">
<p>You can clone the project up to this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone https://github.com/madeindjs/market_place_api.git <span class="nt">-b</span> chapter6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s branch out this chapter with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter7</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_the_gem">Setting up the gem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have been following the tutorial all along. you should already have the gem installed. But in case you just landed here I&#8217;ll walk you through the setup.</p>
</div>
<div class="paragraph">
<p>Add the following line to your <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">gem</span> <span class="s1">'active_model_serializers'</span><span class="p">,</span> <span class="s1">'~&gt; 0.10.8'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code>bundle install</code> command to install the gem and that is it. You should be all set to continue with the tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serialise_the_user_model">Serialise the user model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we need to add a <code>user_serializer</code> file. We can do it manually but the gem already provides a command line interface to do so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer user
  create  app/serializers/user_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>This created a file called <code>user_serializer</code> under the <code>app/serializers</code> directory, which should look like this:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:id</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By now we should have some failing tests. Go ahead and try it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/users_controller_spec.rb
F.F....F.....</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In this case, Rails will look for a serializer named PostSerializer, and if it exists, use it to serialize the <code>Post</code>. This also works with <code>respond_with</code>, which uses <code>to_json</code> under the hood. Also note that any options passed to render <code>:json</code> will be passed to your serializer and available as <code>@options inside</code>. This means that no matter if we are using the <code>render json</code> method or <code>respond_with</code>, from now on Rails will look for the corresponding serializer first.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now back to the specs. You can see that for some reason the response it&#8217;s not quite what we are expecting, and that is because the gem encapsulates the model into a javascript object with the model name as the root (in this case <code>user</code>).</p>
</div>
<div class="paragraph">
<p>So in order to make the tests pass we just need to add the attributes to serialize into the <code>user_serializer.rb</code> and update the <code>users_controller_spec.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">:updated_at</span><span class="p">,</span> <span class="ss">:auth_token</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you run the tests now, they should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/users_controller_spec.rb
.............

Finished <span class="k">in </span>0.16712 seconds <span class="o">(</span>files took 0.80637 seconds to load<span class="o">)</span>
13 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds user serializer for customizing the json output"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also test the serializer objects as shown on the <a href="https://github.com/rails-api/active_model_serializers#rspec">documentation</a> but I&#8217;ll let that to you to decide whether or not to test.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serialize_the_product_model">Serialize the product model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we kind of understand how the serializers gem works it is time to customize the products output. The first step and as with the user we need a product serializer. So let&#8217;s do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer product
    create  app/serializers/product_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s add the attributes to serialize for the product just as we did it with the user back in previous section:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. This is no more complicated as this. You can run all test suite but it will be green. Let&#8217;s commit the changes and move on onto next section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-a</span> <span class="s2">"Adds product serializer for custom json output"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serializing_associations">Serializing associations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have been working with serializers and you may notice that it is quite simple. In some cases the hard decision is how to name your endpoints, or how to structure the JSON output, so your solution is kept through time.</p>
</div>
<div class="paragraph">
<p>When working with and API and associations between models there are many approaches you can take. Here I will explain what I found works for me and I let you judge. In this section we will extend our API to handle the product-user association. I&#8217;ll also explain some of the common mistakes or holes in which you can fall into.</p>
</div>
<div class="paragraph">
<p>Just to recap, we have a <a href="http://guides.rubyonrails.org/association_basics.html#the-has-many-association">has_many</a> type association between the user and product model. Check theses code snippets.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is important because sometimes to save some requests from being placed it is a good idea to embed objects into other objects. This will make the output a bit heavier but when fetching many records this can save you from a huge bottleneck. Let me explain with a use case for the actual application as shown next.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Use case of nested objects associations</div>
<div class="paragraph">
<p>Imagine a scenario where you are fetching the products from the API. In this scenario you need to display some of the user info.</p>
</div>
<div class="paragraph">
<p>One possible solution to this would be to add the <code>user_id</code> attribute to the <code>product_serializer</code> so we can fetch the corresponding user later. This might sound like a good idea but if you care about performance (or your database transactions are not fast enough) you should reconsider this approach. You have to realize that for every product you fetch you&#8217;ll have to request its corresponding user.</p>
</div>
<div class="paragraph">
<p>When facing this problem I&#8217;ve come with two possible alternatives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One good solution (in my opinion) is to embed the user ids related to the products into a meta attribute. So we have a JSON output like:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"user_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This might need some further configuration on the user&#8217;s endpoint, so the client can fetch those users from those <code>user_ids</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Another solution (the one which I&#8217;ll be using here) is to embed the user object into de product object. This can make the first request a bit slower but this way the client does not need to make another extra request. An example of the expected output is presented below:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"products"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
         </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Digital Portable System"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.0277354166289"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
         </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
          </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So we&#8217;ll be embedding the user object into the product. Let&#8217;s start by adding some tests. We will just modify the <code>show</code> and <code>index</code> endpoints spec.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'has the user as a embedded object'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'returns the user object into each product'</span> <span class="k">do</span>
      <span class="n">json_response</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_response</span><span class="o">|</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:user</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is really easy. We just need to add one line to the product serializer:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
  <span class="n">has_one</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we run our tests, they should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec
............................................................

Finished <span class="k">in </span>0.57068 seconds <span class="o">(</span>files took 0.67788 seconds to load<span class="o">)</span>
60 examples, 0 failures</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_embedding_products_on_users">Embedding products on users</h3>
<div class="paragraph">
<p>By now you may be asking yourself if you should embed the products into the user the same as the the section above. Although it may sound fair, this can take to severe optimization problems, as you could be loading huge amounts of information and it is really easy to fall into the <a href="http://en.wikipedia.org/wiki/Circular_reference">Circular Reference problem</a> <sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>But don&#8217;t worry not all is lost. We can easily solve this problem, and this is by embedding just the <code>ids</code> from the products into the user, giving your API a better performance and avoid loading extra data. So in this section we will extend our products <code>index</code> endpoint to deal with a <code>product_ids</code> parameter and format the JSON output accordingly.</p>
</div>
<div class="paragraph">
<p>First we make sure the <code>product_ids</code> it is part of the user serialized object:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'has the product ids as an embedded object'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is very simple, as described by the <code>active_model_serializers</code> gem <a href="https://github.com/rails-api/active_model_serializers#embedding-associations">documentation</a>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attribute</span> <span class="ss">:product_ids</span> <span class="k">do</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We should have our tests passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/users_controller_spec.rb
..............

Finished <span class="k">in </span>0.16791 seconds <span class="o">(</span>files took 0.65902 seconds to load<span class="o">)</span>
14 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to extend the <code>index</code> action from the <code>products_controller</code> so it can handle the product_ids parameter and display the scoped records. Let&#8217;s start by adding some specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="mi">4</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span> <span class="p">}</span>
      <span class="n">get</span> <span class="ss">:index</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not receiving any product_ids parameter'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns 4 records from the database'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">items</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns the user object into each product'</span> <span class="k">do</span>
        <span class="n">json_response</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_response</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:user</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when product_ids parameter is sent'</span> <span class="k">do</span>
      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
        <span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span> <span class="p">}</span>
        <span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">product_ids: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">product_ids</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns just the products that belong to the user'</span> <span class="k">do</span>
        <span class="n">json_response</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_response</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see from previous code we just wrapped the index action into two separate contexts: one which will receive the <code>product_ids</code>, and the old one we had which does not. Let&#8217;s add the necessary code to make the tests pass:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create update destroy]</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">].</span><span class="nf">present?</span> <span class="p">?</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">])</span> <span class="p">:</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="n">products</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the implementation is super simple. We simply just fetch the products from the <code>product_ids</code> params in case they are present, otherwise we just fetch all of them. Let&#8217;s make sure the tests are passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/products_controller_spec.rb
..................

Finished <span class="k">in </span>0.35027 seconds <span class="o">(</span>files took 0.65369 seconds to load<span class="o">)</span>
18 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Embeds the products_ids into the user serialiser and fetches the correct products from the index action endpoint"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_searching_products">Searching products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this last section we will keep up the heavy lifting on the <code>index</code> action for the products controller by implementing a super simple search mechanism to let any client filter the results. This section is optional as it&#8217;s not going to have impact on any of the modules in the app. If you want to practice more with TDD and keep the brain warm I recommend you complete this last step.</p>
</div>
<div class="paragraph">
<p>I&#8217;ve been using <a href="https://github.com/activerecord-hackery/ransack">Ransack</a> to build advance search forms extremely fast, but as this is an education tool (or at least I consider it), and the search we&#8217;ll be performing is really simple, I think we can build a simple search engine, we just need to consider the criteria by which we are going to filter the attributes. Hold tight to your seats this is going to be a rough ride.</p>
</div>
<div class="paragraph">
<p>We will filter the products by the following criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By a title pattern</p>
</li>
<li>
<p>By price</p>
</li>
<li>
<p>Sort by creation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This may sound short and easy but believe me it will give you a headache if you don&#8217;t plan it.</p>
</div>
<div class="sect2">
<h3 id="_by_keyword">By keyword</h3>
<div class="paragraph">
<p>We will create a scope to find the records which match a particular pattern of characters, let&#8217;s called it <code>filter_by_title</code>, let&#8217;s add some specs first:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'.filter_by_title'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@product1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'A plasma TV'</span>
      <span class="vi">@product2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'Fastest Laptop'</span>
      <span class="vi">@product3</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'CD player'</span>
      <span class="vi">@product4</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'LCD TV'</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"when a 'TV' title pattern is sent"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">'returns the 2 products matching'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'TV'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">items</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns the products matching'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'TV'</span><span class="p">).</span><span class="nf">sort</span><span class="p">).</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="vi">@product1</span><span class="p">,</span> <span class="vi">@product4</span><span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The caveat in here is to make sure no matter the case of the title sent we have to sanitize it to any case in order to make the appropriate comparison in this case we&#8217;ll use the lower case approach. Let&#8217;s implement the necessary code:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:filter_by_title</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">keyword</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'lower(title) LIKE ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">keyword</span><span class="p">.</span><span class="nf">downcase</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation above should be enough to make the tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/product_spec.rb
...........

Finished <span class="k">in </span>0.17178 seconds <span class="o">(</span>files took 3.59 seconds to load<span class="o">)</span>
11 examples, 0 failures</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_by_price">By price</h3>
<div class="paragraph">
<p>In order to filter by price things can get a little bit tricky but actually it is very easy. We will break the logic to filter by price into two different methods: one which will fetch the products greater than the price received and the other one to look for the ones under that price. By doing this we keep everything really flexible and we can easily test the scopes.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by building the <code>above_or_equal_to_price</code> scope specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'.above_or_equal_to_price'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@product1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span>
      <span class="vi">@product2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">50</span>
      <span class="vi">@product3</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">150</span>
      <span class="vi">@product4</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">99</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the products which are above or equal to the price'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">sort</span><span class="p">).</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="vi">@product1</span><span class="p">,</span> <span class="vi">@product3</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is extremely simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:above_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &gt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That should be sufficient. Let&#8217;s just verify everything is ok:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/product_spec.rb
............

Finished <span class="k">in </span>0.1566 seconds <span class="o">(</span>files took 0.64782 seconds to load<span class="o">)</span>
12 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now imagine how the opposite method will behave. Let&#8217;s add the specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'.below_or_equal_to_price'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@product1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span>
      <span class="vi">@product2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">50</span>
      <span class="vi">@product3</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">150</span>
      <span class="vi">@product4</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">99</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the products which are above or equal to the price'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="mi">99</span><span class="p">).</span><span class="nf">sort</span><span class="p">).</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="vi">@product2</span><span class="p">,</span> <span class="vi">@product4</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now the implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:below_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &lt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For our sake let&#8217;s run the tests and verify everything is nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/product_spec.rb
.............

Finished <span class="k">in </span>0.18008 seconds <span class="o">(</span>files took 0.6544 seconds to load<span class="o">)</span>
13 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we have not gotten in a lot of trouble. Let&#8217;s just add another scope to sort the records by date of last update. This is because in case the proprietary of the product decides to update some of the data, the client always fetches the most updated records.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sort_by_creation">Sort by creation</h3>
<div class="paragraph">
<p>This scope is super easy, let&#8217;s add some specs first:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'.recent'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@product1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span>
      <span class="vi">@product2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">50</span>
      <span class="vi">@product3</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">150</span>
      <span class="vi">@product4</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">99</span>

      <span class="c1"># we will touch some products to update them</span>
      <span class="vi">@product2</span><span class="p">.</span><span class="nf">touch</span>
      <span class="vi">@product3</span><span class="p">.</span><span class="nf">touch</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the most updated records'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">recent</span><span class="p">).</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="vi">@product3</span><span class="p">,</span> <span class="vi">@product2</span><span class="p">,</span> <span class="vi">@product4</span><span class="p">,</span> <span class="vi">@product1</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now the code:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span>
    <span class="n">order</span><span class="p">(</span><span class="ss">:updated_at</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All of our tests should be green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/product_spec.rb
.............

Finished <span class="k">in </span>0.18008 seconds <span class="o">(</span>files took 0.6544 seconds to load<span class="o">)</span>
13 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it would be a good time to commit the changes as we are done adding scopes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search scopes on the product model"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_search_engine">Search engine</h3>
<div class="paragraph">
<p>Now that we have the ground base for the search engine we&#8217;ll be using in the app it is time to implement a simple but powerful search method, which will handle all the logic for fetching product records.</p>
</div>
<div class="paragraph">
<p>The method will consist on chaining all of the scopes we previously built and return the expected search. Let&#8217;s start by adding some tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'.search'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@product1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'Plasma tv'</span>
      <span class="vi">@product2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'Videogame console'</span>
      <span class="vi">@product3</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">150</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'MP3'</span>
      <span class="vi">@product4</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">99</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'Laptop'</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"when title 'videogame' and '100' a min price are set"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">'returns an empty array'</span> <span class="k">do</span>
        <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'videogame'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">100</span> <span class="p">}</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)).</span><span class="nf">to</span> <span class="n">be_empty</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"when title 'tv', '150' as max price, and '50' as min price are set"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">'returns the product1'</span> <span class="k">do</span>
        <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'tv'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">max_price: </span><span class="mi">150</span> <span class="p">}</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)).</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="vi">@product1</span><span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when an empty hash is sent'</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">'returns all the products'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">({})).</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="vi">@product1</span><span class="p">,</span> <span class="vi">@product2</span><span class="p">,</span> <span class="vi">@product3</span><span class="p">,</span> <span class="vi">@product4</span><span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when product_ids is present'</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">'returns the product from the ids'</span> <span class="k">do</span>
        <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="vi">@product2</span><span class="p">.</span><span class="nf">id</span><span class="p">]</span> <span class="p">}</span>
        <span class="n">expect</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)).</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="vi">@product1</span><span class="p">,</span> <span class="vi">@product2</span><span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We added a bunch of code but the implementation is very easy (you&#8217;ll see). You can go further and add some more specs. In my case I did not find it necessary.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">].</span><span class="nf">present?</span> <span class="p">?</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">])</span> <span class="p">:</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>

    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">])</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">recent</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:recent</span><span class="p">])</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:recent</span><span class="p">].</span><span class="nf">present?</span>

    <span class="n">products</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to notice that we return the products as an <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html:"><code>ActiveRelation</code></a> object so we can further chain more methods in case we need so (or paginate them which we will see on the last chapters). We just need to update the products controller index action to fetch the products from the <code>search</code> method:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create update destroy]</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can run the whole test suite to make sure the app is healthy up to this point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec
.......................................................................

Finished <span class="k">in </span>1.49 seconds <span class="o">(</span>files took 6.53 seconds to load<span class="o">)</span>
71 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit theses changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search class method to filter products"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_7">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On chapters to come, we will start building the <code>Order</code> model, associate it with users and products, which so far and thanks to the <a href="https://github.com/rails-api/active_model_serializers">active_model_serializers</a> gem, it&#8217;s been easy.</p>
</div>
<div class="paragraph">
<p>This was a long chapter, you can sit back, rest and look how far we got. I hope you are enjoying what you got until now, it will get better. We still have a lot of topics to cover one of them is optimization and caching.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter08-placing-orders" class="sect0">Placing Orders</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Back in previous chapter we handle associations between the product and user models, and how to serialize them in order to scale fast and easy. Now it is time to start placing orders which is going to be a more complex situation. We will handle associations between three models and we have to be smart enough to handle the JSON output we are delivering.</p>
</div>
<div class="paragraph">
<p>In this chapter we will make several things which I list below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an <code>Order</code> model with its corresponding specs</p>
</li>
<li>
<p>Handle JSON output association between the order user and product models</p>
</li>
<li>
<p>Send a confirmation email with the order summary</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So now that we have everything clear, we can get our hands dirty. You can clone the project up to this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone <span class="nt">--branch</span> chapter7 https://github.com/madeindjs/market_place_api</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter8</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modeling_order">Modeling order</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you remember associations model, the <code>Order</code> model is associated with users and products at the same time. It is actually really simply to achieve this in Rails. The tricky part is whens comes to serializing this objects. I talk about more about this in a next section.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by creating the order model, with a special form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model order user:references total:decimal</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above will generate the order model, but I&#8217;m taking advantage of the <code>references</code> method to create the corresponding foreign key for the order to belong to a user, it also adds the <code>belongs_to</code> directive into the order model. Let&#8217;s migrate the database and jump into the <code>order_spec.rb</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to drop some tests into the <code>order_spec.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/order_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Order</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:order</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:order</span> <span class="p">}</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">order</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:total</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_presence_of</span> <span class="ss">:user_id</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_presence_of</span> <span class="ss">:total</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">validate_numericality_of</span><span class="p">(</span><span class="ss">:total</span><span class="p">).</span><span class="nf">is_greater_than_or_equal_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">belong_to</span> <span class="ss">:user</span> <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is fairly simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the tests now they should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/order_spec.rb
......

Finished <span class="k">in </span>0.16229 seconds <span class="o">(</span>files took 4.08 seconds to load<span class="o">)</span>
6 examples, 0 failures</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_orders_and_products">Orders and Products</h3>
<div class="paragraph">
<p>We need to setup the association between the <code>order</code> and the <code>product</code> and this is build with a <code>has-many-to-many</code> association. As many products will be placed on many orders and the orders will have multiple products. So in this case we need a model in the middle which will join these two other objects and map the appropriate association.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s generate this model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model placement order:references product:references</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s migrate the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add the order association specs first:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/order_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Order</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:placements</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:products</span><span class="p">).</span><span class="nf">through</span><span class="p">(</span><span class="ss">:placements</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is like so:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:placements</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to jump into the <code>product-placement</code> association:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/product_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Product</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:placements</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:orders</span><span class="p">).</span><span class="nf">through</span><span class="p">(</span><span class="ss">:placements</span><span class="p">)</span> <span class="p">}</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add the code to make it pass:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:placements</span>
  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And lastly but not least, the <code>placement</code> specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/placement_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Placement</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:placement</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:placement</span> <span class="p">}</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">placement</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span> <span class="ss">:order_id</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span> <span class="ss">:product_id</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">belong_to</span> <span class="ss">:order</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">belong_to</span> <span class="ss">:product</span> <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have been following the tutorial so far the implementation is already there because of the <code>references</code> type we pass on the model command generator. We should add the inverse option to the <code>placement</code> model for each <code>belongs_to</code> call. This gives a little boost when referencing the parent object.</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">inverse_of: :placements</span>
  <span class="n">belongs_to</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">inverse_of: :placements</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s run the <code>models</code> spec and make sure everything is green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models
...........................................

Finished <span class="k">in </span>0.53127 seconds <span class="o">(</span>files took 0.73125 seconds to load<span class="o">)</span>
43 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that everything is nice and green let&#8217;s commit the changes and continue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Associates products and orders with a placements model"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_orders">User orders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are just missing one little but very important part, which is to relate the user to the orders. But we did no complete the implementation. So let&#8217;s do that. First open the <code>user_model_spec.rb</code> file to add the corresponding tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/user_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:orders</span><span class="p">)</span> <span class="p">}</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then just add the implementation, which is super simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run the tests for both files, and they should be all nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/<span class="o">{</span>order,user<span class="o">}</span>_spec.rb
....................

Finished <span class="k">in </span>0.14279 seconds <span class="o">(</span>files took 0.72848 seconds to load<span class="o">)</span>
20 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit this small changes and move next:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s1">'Adds user order has many relation'</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exposing_the_order_model">Exposing the order model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is now time to prepare the orders controller to expose the correct order object, and if you recall past chapters, with <a href="https://github.com/rails-api/active_model_serializers">ActiveModelSerializers</a> this is really easy.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>But wait, what are we suppose to expose?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You may be wondering. And you are right. Let&#8217;s first define which actions are we going to build up:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An index action to retrieve the current user orders</p>
</li>
<li>
<p>A show action to retrieve a particular order from the current user</p>
</li>
<li>
<p>A create action to actually place the order</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the <code>index</code> action, so first we have to create the orders controller.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails g controller api/v1/orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Up to this point and before start typing some code we have to ask ourselves:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Should I leave my order endpoints nested into the <code>UsersController</code>, or should I isolate them?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The answer is really simple. I would say it depends on how much information in this case in particular you want to expose to the developer, not from a JSON output point of view, but from the URI format.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll nest the routes, because I like to give this type of information to the developers, as I think it gives more context to the request itself. Let&#8217;s start by dropping some tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="mi">4</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">user: </span><span class="n">current_user</span> <span class="p">}</span>
      <span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns 4 order records from the user'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">items</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we run the test suite now, as you may expect, both tests will fail, because have not even set the correct routes, nor the action. So let&#8217;s start by adding the routes:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">},</span> <span class="ss">constraints: </span><span class="p">{</span> <span class="ss">subdomain: </span><span class="s1">'api'</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">module: :v1</span><span class="p">,</span> <span class="ss">constraints: </span><span class="no">ApiConstraints</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span> <span class="k">do</span>
        <span class="c1"># ...</span>
        <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">]</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time for the orders controller implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now all of our tests should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/orders_controller_spec.rb
..

Finished <span class="k">in </span>0.07943 seconds <span class="o">(</span>files took 0.7232 seconds to load<span class="o">)</span>
2 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>We like our commits very atomic, so let&#8217;s commit this changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds the show action for order"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_render_a_single_order">Render a single order</h3>
<div class="paragraph">
<p>As you may imagine already, this endpoint is super easy, we just have to set up some configuration(routes, controller action) and that would be it for this section.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by adding some specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="vi">@order</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">user: </span><span class="n">current_user</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the user order record matching the id'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add the implementation to make our tests pass. On the <code>routes.rb</code> file add the show action to the orders resources:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span><span class="p">]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the the implementation should look like this:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our tests should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/orders_controller_spec.rb
....

Finished <span class="k">in </span>0.12767 seconds <span class="o">(</span>files took 0.73322 seconds to load<span class="o">)</span>
4 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes and move onto the create order action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds the show action for order"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_placing_and_order">Placing and order</h3>
<div class="paragraph">
<p>It is now time to let the user place some orders, this will add some complexity to the whole application. But don&#8217;t worry we will go one step at a time to keep things simple.</p>
</div>
<div class="paragraph">
<p>Before start this feature, let&#8217;s sit back and think about the implications of creating an order in the app. I&#8217;m not talking about implementing a transactions service like <a href="https://stripe.com/">Stripe</a> or <a href="https://www.braintreepayments.com/">Braintree</a>, but things like handling out of stock products, decrementing the product inventory, add some validation for the order placement to make sure there is enough products by the time the order is place. Did you already detected that?, it may look like we are way down on the hill, but believe, you are closer than you think, and is not as hard as it sounds.</p>
</div>
<div class="paragraph">
<p>For now let&#8217;s keep things simple an assume we always have enough products to place any number of orders, we just care about the server response for now.</p>
</div>
<div class="paragraph">
<p>If you recall the <code>order</code> model on <a href="http://apionrails.icalialabs.com/book/chapter_eight#sec-modeling_order">Section 8.1</a> we need basically 3 things, a total for the order, the user who is placing the order and the products for the order. Given that information we can start adding some specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>

      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">order_params</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">total: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="n">product_1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">product_2</span><span class="p">.</span><span class="nf">id</span><span class="p">]</span> <span class="p">}</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">order: </span><span class="n">order_params</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the just user order record'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we are creating a <code>order_params</code> variable with the order data. Can you see the problem here? If not, I&#8217;ll explain it later. Let&#8217;s just add the necessary code to make this test pass.</p>
</div>
<div class="paragraph">
<p>First we need to add the action to the resources on the routes file:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show create]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the implementation which is easy:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">order</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:total</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now our tests should all be green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/orders_controller_spec.rb
......

Finished <span class="k">in </span>0.16817 seconds <span class="o">(</span>files took 0.64624 seconds to load<span class="o">)</span>
6 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, so we have everything nice and green. We now should move on to the next chapter right? Let me stop you right there. We have some serious errors on the app, and they are not related to the code itself but on the business part.</p>
</div>
<div class="paragraph">
<p>Not because the tests are green, it means the app is filling the business part of the app. I wanted to bring this up because in many cases is super easy to just receive params and build objects from those params thinking that we are always receiving the correct data. In this particular case we cannot rely on that, and the easiest way to see this, is that we are letting the client to set the order total, yeah crazy!</p>
</div>
<div class="paragraph">
<p>We have to add some validations or a callback to calculate the order total an set it through the model. This way we don&#8217;t longer receive that total attribute and have complete control on this attribute. So let&#8217;s do that.</p>
</div>
<div class="paragraph">
<p>We first need to add some specs for the order model:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/order_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Order</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'#set_total!'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">85</span>

      <span class="vi">@order</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="n">product_1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">product_2</span><span class="p">.</span><span class="nf">id</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the total amount to pay for the products'</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">set_total!</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span> <span class="p">}.</span><span class="nf">from</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="mi">185</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now add the implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just before you run your tests, we need to update the <code>order</code> factory, just to make it more useful:</p>
</div>
<div class="listingblock">
<div class="title">spec/factories/orders.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:order</span> <span class="k">do</span>
    <span class="n">user</span> <span class="p">{</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">total</span> <span class="p">{</span> <span class="mf">0.0</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now hook the <code>set_total!</code> method to a <code>before_validation</code> callback to make sure it has the correct total before is validated.</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_validation</span> <span class="ss">:set_total!</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, we are making sure the total is always present and bigger or equal to zero, meaning we can remove those validations and remove the specs. I&#8217;ll wait. Our tests should be passing by now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/order_spec.rb
.........

Finished <span class="k">in </span>0.06807 seconds <span class="o">(</span>files took 0.66165 seconds to load<span class="o">)</span>
9 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is now the moment to visit the <code>orders_controller_spec.rb</code> file and refactor some code. Currently we have something like:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>

      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">order_params</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">total: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="n">product_1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">product_2</span><span class="p">.</span><span class="nf">id</span><span class="p">]</span> <span class="p">}</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">order: </span><span class="n">order_params</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the just user order record'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the tests now, they will pass, but first, let&#8217;s remove the <code>total</code> and <code>user_id</code> from the permitted params and avoid the mass-assignment. The <code>order_params</code> method should look like this:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>

      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="c1"># changes heres</span>
      <span class="n">order_params</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="n">product_1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">product_2</span><span class="p">.</span><span class="nf">id</span><span class="p">]</span> <span class="p">}</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">order: </span><span class="n">order_params</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the just user order record'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the tests now, they will pass, but first, let&#8217;s remove the <code>total</code> and <code>user_id</code> from the permitted params and avoid the mass-assignment. The <code>order_params</code> method should look like this:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">product_ids: </span><span class="p">[])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Your tests should still passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the create method for the orders controller"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the create method for the orders controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customizing_the_order_json_output">Customizing the Order JSON output</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we built the necessary endpoints for the orders, we can customize the information we want to render on the JSON output for each order.</p>
</div>
<div class="paragraph">
<p>If you remember previous chapter we also use Active Model Serializers gem now. Let&#8217;s generate a brand new serializer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer order</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s open <code>order_serializer.rb</code> who should looks like:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:id</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will add the products association and the total attribute to the order output, and to make sure everything is running smooth, we will some specs. In order to avoid duplication on tests, I&#8217;ll just add one spec for the <code>show</code> and make sure the extra data is being rendered, this is because I&#8217;m using the same serializer every time an order object is being parsed to JSON, so in this case I would say it is just fine:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="vi">@order</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">user: </span><span class="n">current_user</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="vi">@product</span><span class="p">.</span><span class="nf">id</span><span class="p">]</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the user order record matching the id'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'includes the total for the order'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:total</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span><span class="p">.</span><span class="nf">to_s</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'includes the products on the order'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:products</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">item</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By now we should have failing tests. But they are easy to fix on the order serializer</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:total</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now all of our tests should be green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/orders_controller_spec.rb
........

Finished <span class="k">in </span>0.22865 seconds <span class="o">(</span>files took 0.70506 seconds to load<span class="o">)</span>
8 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you recall previous chapter we embedded the user into the product to retrieve some information. But in this case we always know the user because is actually the <code>current_user</code> so there is no point on adding it. It is not efficient. So let&#8217;s fix that by adding a new serializer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails g serializer order_product</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to keep the products information consistent with the one we currently have. So we can just inherit behavior from it like so:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderProductSerializer</span> <span class="o">&lt;</span> <span class="no">OrderSerializer</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will keep rendered data on sync, and now to remove the embedded user we simply add the following method on the gem documentation. For more information visit <a href="https://github.com/rails-api/active_model_serializers/tree/0-8-stable#associations">ActiveModelSerializer</a>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderProductSerializer</span> <span class="o">&lt;</span> <span class="no">ProductSerializer</span>
  <span class="k">def</span> <span class="nf">include_user?</span>
    <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After making this change we need to tell the <code>order_serializer</code> to use the serializer we just created by just passing an option to the <code>has_many</code> association on the <code>order_serializer</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderProductSerializer</span> <span class="o">&lt;</span> <span class="no">ProductSerializer</span>
  <span class="k">def</span> <span class="nf">include_user?</span>
    <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And our tests should still passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/orders_controller_spec.rb
........

Finished <span class="k">in </span>0.24024 seconds <span class="o">(</span>files took 0.70072 seconds to load<span class="o">)</span>
8 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit this and move onto the next section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds a custom order product serializer to remove the user association"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_send_order_confirmation_email">Send order confirmation email</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last section for this chapter will be to sent a confirmation email for the user who just placed it. If you want to skip this and jump into the next chapter go ahead. This section is more like a warmup.</p>
</div>
<div class="paragraph">
<p>You may be familiar with email manipulation with Rails so I&#8217;ll try to make this fast and simple. We first create the <code>order_mailer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate mailer order_mailer</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it easy to test the email, we will use a gem called <a href="https://github.com/bmabey/email-spec">email_spec</a>, it includes a bunch of useful matchers for mailers, which makes it easy and fun.</p>
</div>
<div class="paragraph">
<p>So first let&#8217;s add the gem to the <code>Gemfile</code></p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rspec-collection_matchers'</span><span class="p">,</span> <span class="s1">'~&gt; 1.1'</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.8'</span>
  <span class="n">gem</span> <span class="s2">"email_spec"</span>
  <span class="n">gem</span> <span class="s1">'shoulda-matchers'</span>
<span class="k">end</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run the <code>bundle install</code> command to install all the dependencies. I&#8217;ll follow the documentation steps to setup the gem, you can do so on <a href="https://github.com/bmabey/email-spec#rspec">documentation</a>. When you are done, your <code>spec_helper.rb</code> file should look like:</p>
</div>
<div class="listingblock">
<div class="title">spec/rails_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../config/environment'</span><span class="p">,</span> <span class="n">__dir__</span><span class="p">)</span>
<span class="no">ENV</span><span class="p">[</span><span class="s1">'RAILS_ENV'</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="c1"># Prevent database truncation if the environment is production</span>
<span class="nb">abort</span><span class="p">(</span><span class="s1">'The Rails environment is running in production mode!'</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span>

<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require</span> <span class="s1">'email_spec'</span>
<span class="nb">require</span> <span class="s1">'email_spec/rspec'</span>
<span class="nb">require</span> <span class="s1">'rspec/rails'</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can add some tests for the order mailer we created earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">OrderMailer</span><span class="p">,</span> <span class="ss">type: :mailer</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">url_helpers</span>

  <span class="n">describe</span> <span class="s1">'.send_confirmation'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="vi">@order</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">user: </span><span class="vi">@user</span>
      <span class="vi">@order_mailer</span> <span class="o">=</span> <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'should be set to be delivered to the user from the order passed in'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@order_mailer</span><span class="p">).</span><span class="nf">to</span> <span class="n">deliver_to</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'should be set to be send from no-reply@marketplace.com'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@order_mailer</span><span class="p">).</span><span class="nf">to</span> <span class="n">deliver_from</span><span class="p">(</span><span class="s1">'no-reply@marketplace.com'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should contain the user's message in the mail body"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@order_mailer</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_body_text</span><span class="p">(</span><span class="sr">/Order: #</span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="sr">/</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'should have the correct subject'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@order_mailer</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_subject</span><span class="p">(</span><span class="sr">/Order Confirmation/</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'should have the products count'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@order_mailer</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_body_text</span><span class="p">(</span><span class="sr">/You ordered </span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="sr"> products:/</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I simply copied and pasted the one from the documentation and adapt it to our needs. We now have to make sure this tests pass. First we add the action on the order mailer:</p>
</div>
<div class="listingblock">
<div class="title">app/mailers/order_mailer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s1">'no-reply@marketplace.com'</span>
  <span class="k">def</span> <span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span>
    <span class="n">mail</span> <span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s1">'Order Confirmation'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After adding this code, we now have to add the corresponding views. It is a good practice to include a text version along with the html one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;%# app/views/order_mailer/send_confirmation.txt.erb %&gt;</span>
Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span>
You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:
<span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;!-- app/views/order_mailer/send_confirmation.html.erb --&gt;</span>
<span class="nt">&lt;h1&gt;</span>Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we run the mailer specs, they should be all green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/mailers/order_mailer_spec.rb
.....

Finished <span class="k">in </span>0.24919 seconds <span class="o">(</span>files took 0.75369 seconds to load<span class="o">)</span>
5 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>We just need to call the <code>send_confirmation</code> method into the create action on the orders controller:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">order</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make sure we did not break anything on the orders we can just run the specs from the orders controller:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec
..................................................................................................

Finished <span class="k">in </span>1.82 seconds <span class="o">(</span>files took 0.78532 seconds to load<span class="o">)</span>
98 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s finish this section by committing this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds order confirmation mailer"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_8">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hey you made it! Give yourself an applause. I know it&#8217;s been a long way now, but you are almost done, believe me!.</p>
</div>
<div class="paragraph">
<p>On chapters to come we will keep working on the <code>Order</code> model to add some validations when placing an order, some scenarios are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>What happens when the products are not available?</p>
</li>
<li>
<p>Decrement the current product quantity when an order is placed</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next chapter will be short but is really important for the sanity of the app, so don&#8217;t skip it.</p>
</div>
<div class="paragraph">
<p>After <a href="http://apionrails.icalialabs.com/book/chapter_nine#cha-chapter_nine">chapter 9</a>, we will focus on optimization, pagination and some other cool stuff that will definitely help you build a better app.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter09-improve_orders" class="sect0">Improving orders</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Back in previous chapter we extended our API to place orders and send a confirmation email to the user (just to improve the user experience). This chapter will take care of some validations on the order model, just to make sure it is placeable, just like:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Decrement the current product quantity when an order is placed</p>
</li>
<li>
<p>What happens when the products are not available?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We&#8217;ll probably need to update a little bit the JSON output for the orders but let&#8217;s not spoil things up.</p>
</div>
<div class="paragraph">
<p>So now that we have everything clear, we can get our hands dirty. You can clone the project up to this point with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="nb">clone</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">madeindjs</span><span class="o">/</span><span class="n">market_place_api</span><span class="p">.</span><span class="nf">git</span> <span class="o">-</span><span class="n">b</span> <span class="n">chapter8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">chapter9</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_decrementing_the_product_quantity">Decrementing the product quantity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On this first stop we will work on update the product quantity to make sure every order will deliver the actual product. Currently the <code>product</code> model doesn&#8217;t have a <code>quantity</code> attribute, so let&#8217;s do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_products quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait, don&#8217;t run the migrations just yet, we are making a small modification to it. As a good practice I like to add default values for the database just to make sure I don&#8217;t mess things up with <code>null</code> values. This is a perfect case!</p>
</div>
<div class="paragraph">
<p>Your migration file should look like this:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20181227092237_add_quantity_to_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can migrate database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it is time to decrement the quantity for the <code>product</code> once an <code>order</code> is placed. Probably the first thing that comes to your mind is to take this to the <code>Order</code> model and this is a common mistake when working with <em>Many-to-Many</em> associations, we totally forget about the joining model which in this case is <code>Placement</code>.</p>
</div>
<div class="paragraph">
<p>The <code>Placement</code> is a better place to handle this as we have access to the order and the product, so we can easily in this case decrement the product stock.</p>
</div>
<div class="paragraph">
<p>Before we start implementing the code for the decrement, we have to change the way we handle the <code>order</code> creation as we now have to accept a quantity for each product. Remember we expecting we are expecting an array of product ids. I&#8217;m going to try to keep things simple and I will send an array of arrays where the first position of each inner array will be the product id and the second the quantity.</p>
</div>
<div class="paragraph">
<p>A quick example on this would be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">product_ids_and_quantities</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is going to be tricky so stay with me. Let&#8217;s first build some unit tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/order_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Order</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'#build_placements_with_product_ids_and_quantities'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">5</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">85</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">10</span>

      <span class="vi">@product_ids_and_quantities</span> <span class="o">=</span> <span class="p">[[</span><span class="n">product_1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">product_2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'builds 2 placements for the order'</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="n">order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="vi">@product_ids_and_quantities</span><span class="p">)</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="n">order</span><span class="p">.</span><span class="nf">placements</span><span class="p">.</span><span class="nf">size</span> <span class="p">}.</span><span class="nf">from</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then into the implementation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>

  <span class="c1"># @param product_ids_and_quantities [Array] something like this</span>
  <span class="c1">#        `[[product_1.id, 2], [product_2.id, 3]]`. Where first item is</span>
  <span class="c1">#        `product_id` and the second is the quantity</span>
  <span class="c1"># @yield [Placement] placement build</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="nb">id</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">product_id_and_quantity</span> <span class="c1"># [1,5]</span>
      <span class="n">placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">product_id: </span><span class="nb">id</span><span class="p">)</span>
      <span class="k">yield</span> <span class="n">placement</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And if we run our tests, they should be all nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/order_spec.rb
........

Finished <span class="k">in </span>0.33759 seconds <span class="o">(</span>files took 3.54 seconds to load<span class="o">)</span>
8 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>build_placements_with_product_ids_and_quantities</code> will build the placement objects and once we trigger the <code>save</code> method for the order everything will be inserted into the database. One last step before committing this is to update the <code>orders_controller_spec</code> along with its implementation.</p>
</div>
<div class="paragraph">
<p>First we update the <code>orders_controller_spec</code> file:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>

      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span>
      <span class="n">order_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">product_ids_and_quantities: </span><span class="p">[[</span><span class="n">product_1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">product_2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
      <span class="p">}</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">order: </span><span class="n">order_params</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'embeds the two product objects related to the order'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:products</span><span class="p">].</span><span class="nf">size</span><span class="p">).</span><span class="nf">to</span> <span class="n">eql</span> <span class="mi">2</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to update the <code>orders_controller</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">user: </span><span class="n">current_user</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:order</span><span class="p">][</span><span class="ss">:product_ids_and_quantities</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">order</span><span class="p">.</span><span class="nf">reload</span> <span class="c1"># need to reload associations</span>
      <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span><span class="p">,</span> <span class="ss">location: </span><span class="p">[</span><span class="ss">:api</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">order</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
we removed the <code>order_params</code> method as we are handling the creation for the placements.*_
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And last but not least, we need to update the <code>products</code> factory file, to assign a high <code>quantity</code> value, to at least have some products to play around in stock.</p>
</div>
<div class="listingblock">
<div class="title">spec/factories/products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:product</span> <span class="k">do</span>
    <span class="n">title</span> <span class="p">{</span> <span class="no">FFaker</span><span class="o">::</span><span class="no">Product</span><span class="p">.</span><span class="nf">product_name</span> <span class="p">}</span>
    <span class="n">price</span> <span class="p">{</span> <span class="nb">rand</span> <span class="o">*</span> <span class="mi">100</span> <span class="p">}</span>
    <span class="n">published</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span>
    <span class="n">user</span>
    <span class="n">quantity</span> <span class="p">{</span> <span class="mi">5</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit this changes and keep moving:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Allows the order to be placed along with product quantity"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Did you notice we are not saving the quantity for each product anywhere? There is no way to keep track of that. This can be fix really easy, by just adding a quantity attribute to the <code>Placement</code> model, so this way for each product we save its corresponding quantity. Let&#8217;s start by creating the migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_placements quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the product quantity attribute migration we should add a default value equal to 0, remember this is optional but I do like this approach. The migration file should look like:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20181227104830_add_quantity_to_placements.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToPlacements</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run the migrations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s document the <code>quantity</code> attribute through a unit test like so:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/placement_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Placement</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span> <span class="ss">:quantity</span> <span class="p">}</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we just need to update the <code>build_placements_with_product_ids_and_quantities</code> to add the <code>quantity</code> for the placements:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="n">product_id</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">=</span> <span class="n">product_id_and_quantity</span> <span class="c1"># [1,5]</span>
      <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">product_id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="n">quantity</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our <code>order_spec.rb</code> should be still green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/order_spec.rb
........

Finished <span class="k">in </span>0.09898 seconds <span class="o">(</span>files took 0.74936 seconds to load<span class="o">)</span>
8 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds quantity to placements"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_extending_the_placement_model">Extending the Placement model</h3>
<div class="paragraph">
<p>It is time to update the product quantity once the order is saved, or more accurate once the placement is created. In order to achieve this we are going to add a method and then hook it up to an <code>after_create</code> callback.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first update our <code>placement</code> factory to make more sense:</p>
</div>
<div class="listingblock">
<div class="title">spec/factories/placements.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:placement</span> <span class="k">do</span>
    <span class="n">order</span>
    <span class="n">product</span>
    <span class="n">quantity</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we can simply add some specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/placement_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Placement</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span> <span class="ss">:quantity</span> <span class="p">}</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'#decrement_product_quantity!'</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">'decreases the product quantity by the placement quantity'</span> <span class="k">do</span>
      <span class="n">product</span> <span class="o">=</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="n">placement</span><span class="p">.</span><span class="nf">decrement_product_quantity!</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="n">product</span><span class="p">.</span><span class="nf">quantity</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="o">-</span><span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is fairly easy as shown bellow:</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">after_create</span> <span class="ss">:decrement_product_quantity!</span>

  <span class="k">def</span> <span class="nf">decrement_product_quantity!</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">decrement!</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validate_quantity_of_products">Validate quantity of products</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you remember from the beginning of the chapter we added the <code>quantity</code> attribute to the <code>Product</code> model. Now it is time to validate that there are enough products for the order to be placed.</p>
</div>
<div class="paragraph">
<p>In order to make things more interesting and spice things up we will do it through a custom validator, just to keep things cleaner and show you another cool technique to achieve custom validations.</p>
</div>
<div class="paragraph">
<p>For <strong>custom validators</strong> you can head to the <a href="http://guides.rubyonrails.org/active_record_validations.html#performing-custom-validations">documentation</a>. Let&#8217;s get our hands dirty.</p>
</div>
<div class="paragraph">
<p>First we need to add a <code>validators</code> directory under the <code>app</code> directory (Rails will pick it up for so we do not need to load it).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/validators
<span class="nv">$ </span><span class="nb">touch </span>app/validators/enough_products_validator.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we drop any line of code, we need to make sure to add a spec to the <code>Order</code> model to check if the order can be placed.</p>
</div>
<div class="listingblock">
<div class="title">spec/models/order_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Order</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s2">"#valid?"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">5</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">85</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">10</span>

      <span class="n">placement_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:placement</span><span class="p">,</span> <span class="ss">product: </span><span class="n">product_1</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span>
      <span class="n">placement_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:placement</span><span class="p">,</span> <span class="ss">product: </span><span class="n">product_2</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">15</span>

      <span class="vi">@order</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:order</span>
      <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">&lt;&lt;</span> <span class="n">placement_1</span>
      <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">&lt;&lt;</span> <span class="n">placement_2</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"becomes invalid due to insufficient products"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@order</span><span class="p">).</span><span class="nf">to_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see on the spec, we first make sure that <code>placement_2</code> is trying to request more products than are available, so in this case the <code>order</code> is not supposed to be valid.</p>
</div>
<div class="paragraph">
<p>The test by now should be failing, let&#8217;s turn it into green by adding the code for the validator:</p>
</div>
<div class="listingblock">
<div class="title">app/validators/enough_products_validator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">EnoughProductsValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="n">record</span><span class="p">.</span><span class="nf">placements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span>
      <span class="n">product</span> <span class="o">=</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span>
      <span class="k">if</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">&gt;</span> <span class="n">product</span><span class="p">.</span><span class="nf">quantity</span>
        <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"Is out of stock, just </span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">quantity</span><span class="si">}</span><span class="s2"> left"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I manage to add a message for each of the products that are out of stock, but you can handle it differently if you want. Now we just need to add the validator to the <code>Order</code> model like so:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">validates_with</span> <span class="no">EnoughProductsValidator</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now if you run your tests, everything should be nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/order_spec.rb
.........

Finished <span class="k">in </span>0.19136 seconds <span class="o">(</span>files took 0.74912 seconds to load<span class="o">)</span>
9 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds validator for order with not enough products on stock"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_the_total">Updating the total</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Did you realize that the <code>total</code> is being calculated incorrectly, because currently it is just adding the price for the products on the order regardless of the quantity requested. Let me add the code to clarify the problem:</p>
</div>
<div class="paragraph">
<p>Currently in the <code>order</code> model we have this method to calculate the amount to pay:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now instead of calculating the <code>total</code> by just adding the product prices, we need to multiply it by the quantity, so let&#8217;s update the spec first:</p>
</div>
<div class="listingblock">
<div class="title">spec/models/order_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Order</span><span class="p">,</span> <span class="ss">type: :model</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'#set_total!'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">100</span>
      <span class="n">product_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">85</span>

      <span class="n">placement_1</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:placement</span><span class="p">,</span> <span class="ss">product: </span><span class="n">product_1</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span>
      <span class="n">placement_2</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:placement</span><span class="p">,</span> <span class="ss">product: </span><span class="n">product_2</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">15</span>

      <span class="vi">@order</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">build</span> <span class="ss">:order</span>
      <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">&lt;&lt;</span> <span class="n">placement_1</span>
      <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">&lt;&lt;</span> <span class="n">placement_2</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the total amount to pay for the products'</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">set_total!</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span><span class="p">.</span><span class="nf">to_f</span> <span class="p">}.</span><span class="nf">from</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="mi">1575</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the implementation is fairly easy:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">placements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">+=</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span><span class="p">.</span><span class="nf">to_f</span> <span class="o">*</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the specs should be green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/models/order_spec.rb
.........

Finished <span class="k">in </span>0.20537 seconds <span class="o">(</span>files took 0.74555 seconds to load<span class="o">)</span>
9 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit the changes and wrap up.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Updates the total calculation for order"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_9">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh you are here! Let me congratulate you. It&#8217;s been a long way since first chapter but you are one step closer. Actually the next chapter would be the last one, so try to take the most out of it.</p>
</div>
<div class="paragraph">
<p>The last chapter would be on how to optimize the API by using <code>pagination</code> and <code>caching</code>. So buckle up, it is going to be a bumpy ride.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter10-optimization" class="sect0">Optimizations</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Welcome to the last chapter of the book. It&#8217;s been a long way and you are only one step away from the end. Back in previous chapter we finish modeling the <code>Order</code> model and we could say that the project is done by now, but I want to cover some important details about optimization. The topics I&#8217;m going to cover in here will be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setup more <a href="https://jsonapi.org/">JSON:API</a> specifications</p>
</li>
<li>
<p>Pagination</p>
</li>
<li>
<p>Caching</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I will try to go as deep as I can trying to cover some common scenarios on this, and hopefully by the end of the chapter you&#8217;ll have enough knowledge to apply into some other scenarios.</p>
</div>
<div class="paragraph">
<p>If you start reading at this point, you&#8217;ll probably want the code to work on, you can clone it like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git clone https://github.com/madeindjs/market_place_api.git <span class="nt">-b</span> chapter9</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s now create a branch to start working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter10</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_more_jsonapi_specifications">Setup more <a href="https://jsonapi.org/">JSON:API</a> specifications</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As I have been telling you since the beginning of this book, an important and difficult part of creating your API is deciding the output format. Fortunately, some organizations have already faced this type of problem and have established certain conventions.</p>
</div>
<div class="paragraph">
<p>One of the most applied conventions is most certainly <a href="https://jsonapi.org/">JSON:API</a>. This convention will allow us to approach pagination more serenely in the next section.</p>
</div>
<div class="paragraph">
<p>So <a href="https://jsonapi.org/format/#document-structure">documentation JSON:API</a> gives us some rules to follow concerning JSON presentation.</p>
</div>
<div class="paragraph">
<p>So our <strong>document</strong> must follow theses rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: which must contains the data we send back</p>
</li>
<li>
<p><code>errors</code> which must contains a table of errors that have occurred</p>
</li>
<li>
<p><code>meta</code> which contains <a href="https://jsonapi.org/format/#document-meta">object meta</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>data</code> and <code>errors</code> keys must not be present at the same time and this makes sense since if an error occurs we should not be able to make data correct.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The content of the <code>data</code> key is also quite strict:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it must have a <code>type</code> key that describes the type of the JSON model (if it is an article, a user, etc.)</p>
</li>
<li>
<p>the properties of the objects must be placed in an <code>attributes</code> key and the underscore (<code>_</code>) are replaced by dashes (<code>-</code>)</p>
</li>
<li>
<p>the links of the objects must be placed in a <code>relationships</code> key</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This may cause us a lot of change since we have not implemented any of its rules. Don&#8217;t worry, we have set up unit tests to ensure that there will be no regression. Let&#8217;s start with doc updating them</p>
</div>
<div class="sect2">
<h3 id="_users">Users</h3>
<div class="paragraph">
<p>So let&#8217;s start with users controller. Take a look at <code>show</code> action:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'returns the information about a reporter on a hash'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'has the product ids as an embedded object'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We just need to update emplacement of data. So the complete update file look like this:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">UsersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'returns the information about a reporter on a hash'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'has the product ids as an embedded object'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:'product-ids'</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully created'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'renders the json representation for the user record just created'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user_attributes</span><span class="p">[</span><span class="ss">:email</span><span class="p">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'PUT/PATCH #update'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully updated'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'renders the json representation for the updated user'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s1">'newmail@example.com'</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it. It display a lot of code but there are few changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_users_sessions">User&#8217;s sessions</h3>
<div class="paragraph">
<p>Only one test should be updated for user&#8217;s sessions: the one who get <code>auth_token</code>.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/sessions_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">SessionsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">context</span> <span class="s1">'when the credentials are correct'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'returns the user record corresponding to the given credentials'</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="p">.</span><span class="nf">reload</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:'auth-token'</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Remember that JSON:API specifications use dashes (<code>-</code>) instead of underscore (<code>_</code>)
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_orders">Orders</h3>
<div class="paragraph">
<p>There are one specificity for orders controller: we also get linked user. So to do so we need to use the <code>:relationships</code>. Apart from that, the principle remains the same:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'returns the information about a reporter on a hash'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'has the user as a embedded object'</span> <span class="k">do</span>
      <span class="nb">puts</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">inspect</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:relationships</span><span class="p">][</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">context</span> <span class="s1">'when is not receiving any product_ids parameter'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'returns 4 records from the database'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">items</span>
      <span class="k">end</span>
      <span class="n">it</span> <span class="s1">'returns the user object into each product'</span> <span class="k">do</span>
        <span class="n">json_response</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_response</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:relationships</span><span class="p">][</span><span class="ss">:user</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when product_ids parameter is sent'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'returns just the products that belong to the user'</span> <span class="k">do</span>
        <span class="n">json_response</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_response</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:relationships</span><span class="p">][</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully created'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'renders the json representation for the product record just created'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product_attributes</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'PUT/PATCH #update'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">context</span> <span class="s1">'when is successfully updated'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'renders the json representation for the updated user'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s1">'An expensive TV'</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_product">Product</h4>
<div class="paragraph">
<p>Again, that&#8217;s a lot of code, but in reality there&#8217;s very little change.</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="c1"># ...</span>

    <span class="n">it</span> <span class="s1">'returns the information about a reporter on a hash'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'has the user as a embedded object'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:relationships</span><span class="p">][</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">context</span> <span class="s1">'when is not receiving any product_ids parameter'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'returns 4 records from the database'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">items</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns the user object into each product'</span> <span class="k">do</span>
        <span class="n">json_response</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_response</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:relationships</span><span class="p">][</span><span class="ss">:user</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when product_ids parameter is sent'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'returns just the products that belong to the user'</span> <span class="k">do</span>
        <span class="n">json_response</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_response</span><span class="o">|</span>
          <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:relationships</span><span class="p">][</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'POST #create'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'when is successfully created'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'renders the json representation for the product record just created'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product_attributes</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when is not created'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'renders the json errors on why the user could not be created'</span> <span class="k">do</span>
        <span class="n">product_response</span> <span class="o">=</span> <span class="n">json_response</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">product_response</span><span class="p">[</span><span class="ss">:errors</span><span class="p">][</span><span class="ss">:price</span><span class="p">]).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s1">'is not a number'</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'PUT/PATCH #update'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">context</span> <span class="s1">'when is successfully updated'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'renders the json representation for the updated user'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">][</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:title</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="s1">'An expensive TV'</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementation">Implementation</h3>
<div class="paragraph">
<p>From the beginning, in order to serialize our models, we used <em>Active Model Serializer</em>. Fortunately for us this library offers several <strong>adapters</strong>. The adapters are in a way JSON models to be applied to all our serializers. It&#8217;s perfect.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/rails-api/active_model_serializers/blob/v0.10.6/docs/general/adapters.md">documentation of <em>Active Model Serializer</em></a> shows us a list of existing adapters. And if you see where I&#8217;m going with this there&#8217;s one ready for the JSON:API model! To set it up, simply activate the adapt it by creating the following file:</p>
</div>
<div class="listingblock">
<div class="title">config/initializers/activemodel_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">ActiveModelSerializers</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">adapter</span> <span class="o">=</span> <span class="ss">:json_api</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We must also indicate the type of the serializer object. <em>Active Model Serializer</em> offers an all fate method for this: <code>type</code>. Implementation is therefore very easy:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">type</span> <span class="ss">:order</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">type</span> <span class="ss">:product</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">type</span> <span class="ss">:user</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s all! Now let&#8217;s run <strong>all</strong> our tests to see if they pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec
...........F.F.F.......................................................................................

Failures:

  1<span class="o">)</span> Api::V1::ProductsController GET <span class="c">#show has the user as a embedded object</span>
     Failure/Error: expect<span class="o">(</span>json_response[:data][:relationships][:user][:attributes][:email]<span class="o">)</span>.to eql @product.user.email
     ...

  2<span class="o">)</span> Api::V1::ProductsController GET <span class="c">#index when is not receiving any product_ids parameter returns the user object into each product</span>
     Failure/Error: expect<span class="o">(</span>product_response[:data][:relationships][:user]<span class="o">)</span>.to be_present
     ...

  3<span class="o">)</span> Api::V1::ProductsController GET <span class="c">#index when product_ids parameter is sent returns just the products that belong to the user</span>
     Failure/Error: expect<span class="o">(</span>product_response[:data][:relationships][:user][:attributes][:email]<span class="o">)</span>.to eql @user.email
     ...

Finished <span class="k">in </span>1.35 seconds <span class="o">(</span>files took 1.1 seconds to load<span class="o">)</span>
103 examples, 3 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Argh…. All our tests pass but we see that the user associated with the product is not integrated in the answer. This is actually quite normal. The JSON:API <a href="https://jsonapi.org/format/#fetching-includes">documentation</a> recommends using an <code>include</code> key rather than nesting models together.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s update our test:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #show'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'has the user as a embedded object'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:included</span><span class="p">].</span><span class="nf">first</span><span class="p">[</span><span class="ss">:attributes</span><span class="p">][</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">context</span> <span class="s1">'when is not receiving any product_ids parameter'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'returns the user object into each product'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:included</span><span class="p">]).</span><span class="nf">to</span> <span class="n">be_present</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when product_ids parameter is sent'</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">it</span> <span class="s1">'returns just the products that belong to the user'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:included</span><span class="p">].</span><span class="nf">first</span><span class="p">[</span><span class="ss">:id</span><span class="p">].</span><span class="nf">to_i</span><span class="p">).</span><span class="nf">to</span> <span class="n">eql</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here too implementation is very easy. We just need to add the <code>include</code> option directly into the controller&#8217;s action.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1">#...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]),</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1">#...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s run all the tests again to make sure that our final implementation is correct:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec
.......................................................................................................

Finished <span class="k">in </span>2.12 seconds <span class="o">(</span>files took 1.4 seconds to load<span class="o">)</span>
103 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s the job. Since we are happy with our work, let&#8217;s do a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Respect JSON:API response format"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pagination">Pagination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A very common strategy to optimize an array of records from the database, is to load just a few by paginating them and if you are familiar with this technique you know that in Rails is really easy to achieve it whether if you are using <a href="https://github.com/mislav/will_paginate">will_paginate</a> or <a href="https://github.com/amatsuda/kaminari">kaminari</a>.</p>
</div>
<div class="paragraph">
<p>Then only tricky part in here is how are we suppose to handle the JSON output now, to give enough information to the client on how the array is paginated. If you recall first chapter I shared some resources on the practices I was going to be following in here. One of them was <a href="http://jsonapi.org/" class="bare">http://jsonapi.org/</a> which is a must-bookmark page.</p>
</div>
<div class="paragraph">
<p>If we read the format section we will reach a sub section called <a href="http://jsonapi.org/format/#document-structure-top-level">Top Level</a> and in very few words they mention something about pagination:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>"meta": meta-information about a resource, such as pagination.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>It is not very descriptive but at least we have a hint on what to look next about the pagination implementation, but don&#8217;t worry that is exactly what we are going to do in here.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the <code>products</code> list.</p>
</div>
<div class="sect2">
<h3 id="_products">Products</h3>
<div class="paragraph">
<p>We are going to start nice and easy by paginating the products list as we don&#8217;t have any kind of access restriction which leads to easier testing.</p>
</div>
<div class="paragraph">
<p>First we need to add the <a href="https://github.com/amatsuda/kaminari">kaminari</a> gem to our <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add kaminari</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can go to the <code>index</code> action on the <code>products_controller</code> and add the pagination methods as pointed on the documentation:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]).</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">]).</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So far the only thing that changed is the query on the database to just limit the result by 25 per page which is the default. But we have not added any extra information to the JSON output.</p>
</div>
<div class="paragraph">
<p>We need to provide the pagination information on the <code>meta</code> tag in the following form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"pagination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"per_page"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
        </span><span class="nl">"total_page"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w">
        </span><span class="nl">"total_objects"</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have the final structure for the <code>meta</code> tag we just need to output it on the JSON response. Let&#8217;s first add some specs:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="mi">4</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:product</span> <span class="p">}</span>
      <span class="n">get</span> <span class="ss">:index</span>
    <span class="k">end</span>
    <span class="c1"># ...</span>
    <span class="n">it</span> <span class="s1">'Have a meta pagination tag'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:meta</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:pagination</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'per-page'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-pages'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-objects'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test we have just added should fail or, if we run the tests, two tests fail. It means we broke something else:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/products_controller_spec.rb
...F....F...........

Failures:

  1<span class="o">)</span> Api::V1::ProductsController GET <span class="c">#index Have a meta pagination tag</span>
     ...

  2<span class="o">)</span> Api::V1::ProductsController GET <span class="c">#index when product_ids parameter is sent returns just the products that belong to the user</span>
     Failure/Error: total_pages: products.total_pages,

     NoMethodError:
       undefined method <span class="s1">'total_pages'</span> <span class="k">for</span> <span class="c">#&lt;Array:0x0000556f1ef85c68&gt;</span>
     <span class="c"># ./app/controllers/api/v1/products_controller.rb:12:in 'index'</span>
     ...

Finished <span class="k">in </span>0.40801 seconds <span class="o">(</span>files took 0.62979 seconds to load<span class="o">)</span>
20 examples, 2 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>The error is actually on the <code>Product.search</code> method. In fact Kaminari is waiting for a registration relationship instead of a table. It&#8217;s very easy to repair:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">].</span><span class="nf">present?</span> <span class="p">?</span> <span class="no">Product</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">])</span> <span class="p">:</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Have you noticed the change? Let me explain it to you. We simply replaced the <code>Product.find</code> method with <code>Product.where</code> using the <code>product_ids</code> parameters. The difference is that the <code>where</code> method returns an <code>ActiveRecord::Relation</code> and that&#8217;s exactly what we need.</p>
</div>
<div class="paragraph">
<p>Now, if we restart the tests, the test we broke should now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/products_controller_spec.rb
...F................

Failures:

  1<span class="o">)</span> Api::V1::ProductsController GET <span class="c">#index Have a meta pagination tag</span>
     ...

Finished <span class="k">in </span>0.41533 seconds <span class="o">(</span>files took 0.5997 seconds to load<span class="o">)</span>
20 examples, 1 failure</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we fixed that, let&#8217;s add the pagination information, we need to do it on the <code>products_controller.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create update destroy]</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">).</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]).</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">])</span>
    <span class="n">render</span><span class="p">(</span>
      <span class="ss">json: </span><span class="n">products</span><span class="p">,</span>
      <span class="ss">include: </span><span class="p">[</span><span class="ss">:user</span><span class="p">],</span>
      <span class="ss">meta: </span><span class="p">{</span>
        <span class="ss">pagination: </span><span class="p">{</span>
          <span class="ss">per_page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">],</span>
          <span class="ss">total_pages: </span><span class="n">products</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">,</span>
          <span class="ss">total_objects: </span><span class="n">products</span><span class="p">.</span><span class="nf">total_count</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we run the specs, they should be all passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec/controllers/api/v1/products_controller_spec.rb
....................

Finished <span class="k">in </span>0.66813 seconds <span class="o">(</span>files took 2.72 seconds to load<span class="o">)</span>
20 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have make a really amazing optimization for the products list endpoint. Now it is the client job to fetch the correct <code>page</code> with the correct <code>per_page</code> param for the records.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s commit this changes and proceed with the orders list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds pagination for the products index action to optimize response"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_orders_list">Orders list</h3>
<div class="paragraph">
<p>Now it&#8217;s time to do exactly the same for the <code>orders</code> list endpoint which should be really easy to implement. But first, let&#8217;s add some specs to the <code>orders_controller_spec.rb</code> file:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">current_user</span> <span class="o">=</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:user</span>
      <span class="n">api_authorization_header</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">auth_token</span>
      <span class="mi">4</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">FactoryBot</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:order</span><span class="p">,</span> <span class="ss">user: </span><span class="n">current_user</span> <span class="p">}</span>
      <span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns 4 order records from the user'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">items</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'Have a meta pagination tag'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:meta</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:pagination</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'per-page'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-pages'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-objects'</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">response_code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may already know, our tests are no longer passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/orders_controller_spec.rb
.F........

Failures:

  1<span class="o">)</span> Api::V1::OrdersController GET <span class="c">#index Have a meta pagination tag</span>
     Failure/Error: expect<span class="o">(</span>json_response<span class="o">)</span>.to have_key<span class="o">(</span>:meta<span class="o">)</span>
       expected <span class="c">#has_key?(:meta) to return true, got false</span>
     <span class="c"># ./spec/controllers/api/v1/orders_controller_spec.rb:18:in `block (3 levels) in &lt;top (required)&gt;'</span>

Finished <span class="k">in </span>0.66262 seconds <span class="o">(</span>files took 2.74 seconds to load<span class="o">)</span>
10 examples, 1 failure</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s turn the red into green:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:authenticate_with_token!</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]).</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">])</span>
    <span class="n">render</span><span class="p">(</span>
      <span class="ss">json: </span><span class="n">orders</span><span class="p">,</span>
      <span class="ss">meta: </span><span class="p">{</span>
        <span class="ss">pagination: </span><span class="p">{</span>
          <span class="ss">per_page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">],</span>
          <span class="ss">total_pages: </span><span class="n">orders</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">,</span>
          <span class="ss">total_objects: </span><span class="n">orders</span><span class="p">.</span><span class="nf">total_count</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all the tests should be nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/orders_controller_spec.rb
..........

Finished <span class="k">in </span>0.35201 seconds <span class="o">(</span>files took 0.9404 seconds to load<span class="o">)</span>
10 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s place and commit, because a refactor is coming:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds pagination for orders index action"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring_pagination">Refactoring pagination</h3>
<div class="paragraph">
<p>If you have followed this tutorial or if you are an experienced Rails developer, you probably like to keep things DRY. You may have noticed that the code we just wrote is duplicated. I think it&#8217;s a good habit to clean up the code a little once the functionality is implemented.</p>
</div>
<div class="paragraph">
<p>We will first clean up these tests that we duplicated in the file <code>orders_controller_spec.rb</code> and <code>products_controller_spec.rb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">it</span> <span class="s1">'Have a meta pagination tag'</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:meta</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:pagination</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'per-page'</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-pages'</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-objects'</span><span class="p">)</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add a <code>shared_examples</code> folder under the <code>spec/support/</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>spec/support/shared_examples</code></pre>
</div>
</div>
<div class="paragraph">
<p>And on the <code>pagination.rb</code> file you can just add the following lines:</p>
</div>
<div class="listingblock">
<div class="title">spec/support/shared_examples/pagination.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">shared_examples</span> <span class="s1">'paginated list'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'Have a meta pagination tag'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:meta</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:pagination</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'per-page'</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-pages'</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">[</span><span class="ss">:meta</span><span class="p">][</span><span class="ss">:pagination</span><span class="p">]).</span><span class="nf">to</span> <span class="n">have_key</span><span class="p">(</span><span class="ss">:'total-objects'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This shared example can now be use as a substitute for the five tests on the <code>orders_controller_spec.rb</code> and <code>products_controller_spec.rb</code> files like so:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">OrdersController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it_behaves_like</span> <span class="s1">'paginated list'</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/products_controller_spec.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Api</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ProductsController</span><span class="p">,</span> <span class="ss">type: :controller</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">describe</span> <span class="s1">'GET #index'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">it_behaves_like</span> <span class="s1">'paginated list'</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And both specs should be passing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/
.................................................

Finished <span class="k">in </span>0.96778 seconds <span class="o">(</span>files took 1.59 seconds to load<span class="o">)</span>
49 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we made this simple refactor we can jump into the pagination implementation for the controllers and clean things up. If you recall the index action for both the products and orders controller they both have the same pagination format. So let&#8217;s move this logic into a method called <code>pagination</code> under the <code>application_controller.rb</code> file. This way we can access it on any controller which needs pagination in the future.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/application_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>

  <span class="c1"># @return [Hash]</span>
  <span class="k">def</span> <span class="nf">pagination</span><span class="p">(</span><span class="n">paginated_array</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="ss">pagination: </span><span class="p">{</span>
        <span class="ss">per_page: </span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">],</span>
        <span class="ss">total_pages: </span><span class="n">paginated_array</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">,</span>
        <span class="ss">total_objects: </span><span class="n">paginated_array</span><span class="p">.</span><span class="nf">total_count</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can substitute the pagination hash on both controllers for the method, like so:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]).</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">])</span>
    <span class="n">render</span><span class="p">(</span>
      <span class="ss">json: </span><span class="n">orders</span><span class="p">,</span>
      <span class="ss">meta: </span><span class="n">pagination</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">).</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]).</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">])</span>
    <span class="n">render</span><span class="p">(</span>
      <span class="ss">json: </span><span class="n">products</span><span class="p">,</span>
      <span class="ss">include: </span><span class="p">[</span><span class="ss">:user</span><span class="p">],</span>
      <span class="ss">meta: </span><span class="n">pagination</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the specs for each file they should be all nice and green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rspec spec/controllers/api/v1/
.................................................

Finished <span class="k">in </span>0.92996 seconds <span class="o">(</span>files took 0.95615 seconds to load<span class="o">)</span>
49 examples, 0 failures</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would be a good time to <em>commit</em> the changes and move on to the next section on caching.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add .</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_caching">API Caching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is currently an implementation to do caching with the gem <code>active_model_serializers</code> which is really easy to handle. Although in older versions of the gem, this implementation can change, it does the job.</p>
</div>
<div class="paragraph">
<p>If we make a request to the product list, we will notice that the response time takes about 174 milliseconds using cURL</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://api.marketplace.dev/products
Total: 0,174111</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>-w</code> option allows us to retrieve the time of the request, <code>-o</code> redirects the response to a file and <code>-s</code> hides the cURL display
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By adding only one line to the <code>ProductSerializer</code> class, we will see a significant improvement in response time!</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache</span> <span class="ss">key: </span><span class="s1">'product'</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">3</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache</span> <span class="ss">key: </span><span class="s1">'order'</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">3</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache</span> <span class="ss">key: </span><span class="s1">'user'</span><span class="p">,</span> <span class="ss">expires_in: </span><span class="mi">3</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s all! Let&#8217;s check for improvement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://api.marketplace.dev/products
Total: 0,021599
<span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://api.marketplace.dev/products
Total: 0,021979</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we went from 174 ms to 21 ms. The improvement is therefore enormous! Let&#8217;s commit our change a last time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">am</span> <span class="s2">"Adds caching for the serializers"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_10">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you get to that point, it means you&#8217;re done with the book. Good work! You have just become a great API Rails developer, that&#8217;s for sure.</p>
</div>
<div class="paragraph">
<p>Thank you for bringing this great adventure with me, I hope you enjoyed the trip as much as I did. We should have a beer sometime.</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. It means french.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The GPG allow you to verify author identity of the software you download.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. An hook allow you to run a specific method when a method is called
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. See <a href="https://github.com/plataformatec/devise#getting-started">documentation</a> on this for more details).
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. in short loops the program until it runs out of memory and throws you and error or never respond you at all
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 6.12<br>
Last updated 2021-01-17 13:56:45 +0100
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>