<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="description" content="Aprende las mejores prácticas para construir una API usando Ruby on Rails 6">
<meta name="keywords" content="Rails, API, Ruby, Software">
<meta name="author" content="Alexandre Rousseau, Oscar Téllez">
<meta name="copyright" content="CC-BY-SA 4.0, MIT">
<title>API on Rails 6</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>API on Rails 6</h1>
<div class="details">
<span id="author" class="author">Alexandre Rousseau, Oscar Téllez</span><br>
<span id="email" class="email"><a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a></span><br>
<span id="revnumber">version 6.9,</span>
<span id="revdate">2020-09-01</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#chapter00-before">Antes</a>
<ul class="sectlevel1">
<li><a href="#_prefacio">Prefacio</a></li>
<li><a href="#_acerca_del_autor">Acerca del autor</a></li>
<li><a href="#_derechos_de_autor_y_licencia">Derechos de autor y licencia</a></li>
<li><a href="#_agradecimientos">Agradecimientos</a></li>
</ul>
</li>
<li><a href="#chapter01-introduction">Introducción</a>
<ul class="sectlevel1">
<li><a href="#_convenciones_en_este_libro">Convenciones en este libro</a></li>
<li><a href="#_entornos_de_desarrollo">Entornos de desarrollo</a>
<ul class="sectlevel2">
<li><a href="#_editores_de_texto_y_terminal">Editores de texto y terminal</a></li>
<li><a href="#_navegadores">Navegadores</a></li>
<li><a href="#_manejador_de_paquetes">Manejador de paquetes</a></li>
<li><a href="#_git">Git</a></li>
<li><a href="#_ruby">Ruby</a></li>
</ul>
</li>
<li><a href="#_inicializando_el_proyecto">Inicializando el proyecto</a></li>
<li><a href="#_versionado">Versionado</a></li>
<li><a href="#_conclusión">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter02-api">La API</a>
<ul class="sectlevel1">
<li><a href="#_planificando_la_aplicación">Planificando la aplicación</a></li>
<li><a href="#_configurar_la_api">Configurar la API</a>
<ul class="sectlevel2">
<li><a href="#_restricciones_de_rutas_y_espacios_de_nombres">Restricciones de Rutas y Espacios de Nombres</a></li>
</ul>
</li>
<li><a href="#_versionado_api">Versionado Api</a></li>
<li><a href="#_conclusión_2">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter03-presenting-users">Presentando a los usuarios</a>
<ul class="sectlevel1">
<li><a href="#_modelo_usuario">Modelo usuario</a>
<ul class="sectlevel2">
<li><a href="#_generación_del_modelo_user">Generación del modelo <code>User</code></a></li>
<li><a href="#_hash_de_la_contraseña">Hash de la contraseña</a></li>
</ul>
</li>
<li><a href="#_creando_usuarios">Creando usuarios</a>
<ul class="sectlevel2">
<li><a href="#_prueba_tu_recurso_con_curl">Prueba tu recurso con cURL</a></li>
<li><a href="#_crear_usuarios">Crear usuarios</a></li>
<li><a href="#_actualizar_usuarios">Actualizar usuarios</a></li>
<li><a href="#_eliminar_al_usuario">Eliminar al usuario</a></li>
</ul>
</li>
<li><a href="#_conclusión_3">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter05-authentication">Autenticando al usuario</a>
<ul class="sectlevel1">
<li><a href="#_sesion_sin_estado">Sesion sin estado</a>
<ul class="sectlevel2">
<li><a href="#_presentación_de_jwt">Presentación de JWT</a></li>
<li><a href="#_configurando_el_token_de_autenticación">Configurando el token de autenticación</a></li>
<li><a href="#_controlador_de_token">Controlador de Token</a></li>
</ul>
</li>
<li><a href="#_usuario_logueado">Usuario logueado</a></li>
<li><a href="#_autenticación_con_el_token">Autenticación con el token</a>
<ul class="sectlevel2">
<li><a href="#_acciones_de_autorización">Acciones de autorización</a></li>
</ul>
</li>
<li><a href="#_conclusión_4">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter05-user-products">Productos de usuario</a>
<ul class="sectlevel1">
<li><a href="#_el_modelo_producto">El modelo producto</a>
<ul class="sectlevel2">
<li><a href="#_los_fundamentos_del_producto">Los fundamentos del producto</a></li>
<li><a href="#_validaciones_del_producto">Validaciones del producto</a></li>
</ul>
</li>
<li><a href="#_endpoints_de_productos">Endpoints de productos</a>
<ul class="sectlevel2">
<li><a href="#_acción_show_para_productos">Acción show para productos</a></li>
<li><a href="#_listado_de_productos">Listado de productos</a></li>
<li><a href="#_creando_productos">Creando productos</a></li>
<li><a href="#_actualizando_los_productos">Actualizando los productos</a></li>
<li><a href="#_destruyendo_productos">Destruyendo productos</a></li>
</ul>
</li>
<li><a href="#_llenado_de_la_base_de_datos">Llenado de la base de datos</a></li>
<li><a href="#_conclusión_5">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter06-improve-json">Construyendo la repuesta JSON</a>
<ul class="sectlevel1">
<li><a href="#_presentación_de_jsonapi">Presentación de JSON:API</a></li>
<li><a href="#_serializar_el_usuario">Serializar el usuario</a></li>
<li><a href="#_serializado_de_productos">Serializado de productos</a>
<ul class="sectlevel2">
<li><a href="#_serializar_asociaciones">Serializar asociaciones</a></li>
</ul>
</li>
<li><a href="#_teoría_de_la_inyección_de_relaciones">Teoría de la inyección de relaciones</a>
<ul class="sectlevel2">
<li><a href="#_integrar_en_un_meta_atributo">Integrar en un meta atributo</a></li>
<li><a href="#_incorporando_el_objeto_en_el_atributo">Incorporando el objeto en el atributo</a></li>
<li><a href="#_incorporar_las_relaciones_incluidas_en_include">Incorporar las relaciones incluidas en `include</a></li>
</ul>
</li>
<li><a href="#_aplicación_de_la_inyección_de_relaciones">Aplicación de la inyección de relaciones</a>
<ul class="sectlevel2">
<li><a href="#_recuperar_productos_del_usuario">Recuperar productos del usuario</a></li>
</ul>
</li>
<li><a href="#_buscando_productos">Buscando productos</a>
<ul class="sectlevel2">
<li><a href="#_por_palabra_clave">Por palabra clave</a></li>
<li><a href="#_por_precio">Por precio</a></li>
<li><a href="#_ordenas_por_fecha_de_creación">Ordenas por fecha de creación</a></li>
</ul>
</li>
<li><a href="#_conclusión_6">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter07-placing-orders">Colocando órdenes</a>
<ul class="sectlevel1">
<li><a href="#_modelando_la_orden">Modelando la orden</a>
<ul class="sectlevel2">
<li><a href="#_ordenes_y_productos">Ordenes y productos</a></li>
</ul>
</li>
<li><a href="#_exponer_el_modelo_usuario">Exponer el modelo usuario</a>
<ul class="sectlevel2">
<li><a href="#_renderizar_una_sola_orden">Renderizar una sola orden</a></li>
<li><a href="#_colocando_y_ordenando">Colocando y ordenando</a></li>
</ul>
</li>
<li><a href="#_enviar_email_de_confirmación_de_la_orden">Enviar email de confirmación de la orden</a></li>
<li><a href="#_conclusión_7">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter08-improve_orders">Mejorando las ordenes</a>
<ul class="sectlevel1">
<li><a href="#_decrementando_la_cantidad_del_producto">Decrementando la cantidad del producto</a>
<ul class="sectlevel2">
<li><a href="#_entendiendo_el_modelo_placement">Entendiendo el modelo Placement</a></li>
</ul>
</li>
<li><a href="#_validar_la_cantidad_de_productos">Validar la cantidad de productos</a></li>
<li><a href="#_actualizando_el_total">Actualizando el total</a></li>
<li><a href="#_conclusión_8">Conclusión</a></li>
</ul>
</li>
<li><a href="#chapter09-optimization">Optimizaciones</a>
<ul class="sectlevel1">
<li><a href="#_paginación">Paginación</a>
<ul class="sectlevel2">
<li><a href="#_productos">Productos</a></li>
<li><a href="#_lista_de_ordenes">Lista de ordenes</a></li>
<li><a href="#_refactorizando_la_paginación">Refactorizando la paginación</a></li>
</ul>
</li>
<li><a href="#_almacenamiento_en_cache_del_api">Almacenamiento en cache del API</a></li>
<li><a href="#_consultas_n1">Consultas N+1</a>
<ul class="sectlevel2">
<li><a href="#_prevencion_de_peticiones_n_1">Prevencion de peticiones N + 1</a></li>
</ul>
</li>
<li><a href="#_activación_de_cors">Activación de CORS</a></li>
<li><a href="#_conclusión_9">Conclusión</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="chapter00-before" class="sect0">Antes</h1>
<div class="sect1">
<h2 id="_prefacio">Prefacio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"API on Rails 6" está basado en <a href="http://apionrails.icalialabs.com/book/">"APIs on Rails: Building REST APIs with Rails"</a>. Fue publicado inicialmente en 2014 por <a href="https://twitter.com/kurenn">Abraham Kuri</a> bajo la licencia <a href="http://opensource.org/licenses/MIT">MIT</a> y <a href="http://people.freebsd.org/~phk/">Beerware</a>.</p>
</div>
<div class="paragraph">
<p>La primera versión no es mantenida y fue planeada para Ruby on Rails 4 la cual no <a href="https://guides.rubyonrails.org/maintenance_policy.html#security-issues">recibe más actualizaciones de seguridad</a>. He buscado actualizar este excelente libro, adaptándolo a nuevas versiones de Ruby on Rails. Este libro está por lo tanto disponible para Ruby on Rails en sus versiones 5.2 y 6.0 (el cual te encuentras leyendo).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Este libro también está disponible en el lenguaje Molière (Esto significa francés).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_acerca_del_autor">Acerca del autor</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mi nombre es <a href="http://rousseau-alexandre.fr">Alexandre Rousseau</a> y soy un desarrollador en Rails con más de 4 años de experiencia (al momento de escribirlo). Actualmente soy socio en una compañía (<a href="https://isignif.fr">iSignif</a>) donde construyo y mantengo un producto SAAS usando Rails. También contribuyo a la comunidad Ruby produciendo y manteniendo algunas gemas que puedes consular en <a href="https://rubygems.org/profiles/madeindjs">my Rubygems.org profile</a>. La mayoría de mis proyectos están en GitHub así que no dudes en <a href="http://github.com/madeindjs/">seguirme</a>.</p>
</div>
<div class="paragraph">
<p>Todo el código fuente de este libro está en formato <a href="https://asciidoctor.org/">Asciidoctor</a> disponible en <a href="https://github.com/madeindjs/api_on_rails">GitHub</a>. Por lo tanto, siéntete libre de hacer un <a href="https://github.com/madeindjs/api_on_rails/fork">fork</a> al proyecto si quieres mejorarlo o corregir errores que no noté.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_derechos_de_autor_y_licencia">Derechos de autor y licencia</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Este libro está bajo la <a href="http://opensource.org/licenses/MIT">licencia MIT</a>. Todo el código fuente del libro está en el formato <a href="https://fr.wikipedia.org/wiki/Markdown">Markdown</a> disponible en <a href="https://github.com/madeindjs/api_on_rails">GitHub</a></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Licencia MIT</div>
<div class="paragraph">
<p>Copyright 2019 Alexandre Rousseau</p>
</div>
<div class="paragraph">
<p>Por la presente se concede permiso, libre de cargos, a cualquier persona que obtenga una copia de este software y de los archivos de documentación asociados (el "Software"), a utilizar el Software sin restricción, incluyendo sin limitación los derechos a usar, copiar, modificar, fusionar, publicar, distribuir, sublicenciar, y/o vender copias del Software, y a permitir a las personas a las que se les proporcione el Software a hacer lo mismo, sujeto a las siguientes condiciones:</p>
</div>
<div class="paragraph">
<p>El aviso de copyright anterior y este aviso de permiso se incluirán en todas las copias o partes sustanciales del Software.
EL SOFTWARE SE PROPORCIONA "COMO ESTÁ", SIN GARANTÍA DE NINGÚN TIPO, EXPRESA O IMPLÍCITA, INCLUYENDO, PERO NO LIMITADO A GARANTÍAS DE COMERCIALIZACIÓN, IDONEIDAD PARA UN PROPÓSITO PARTICULAR E INCUMPLIMIENTO. EN NINGÚN CASO LOS AUTORES O PROPIETARIOS DE LOS DERECHOS DE AUTOR SERÁN RESPONSABLES DE NINGUNA RECLAMACIÓN, DAÑOS U OTRAS RESPONSABILIDADES, YA SEA EN UNA ACCIÓN DE CONTRATO, AGRAVIO O CUALQUIER OTRO MOTIVO, DERIVADAS DE, FUERA DE O EN CONEXIÓN CON EL SOFTWARE O SU USO U OTRO TIPO DE ACCIONES EN EL SOFTWARE.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>"API on Rails 6" por <a href="https://github.com/madeindjs/api_on_rails">Alexandre Rousseau</a> es compartido de acuerdo a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution - Attribution-ShareAlike 4.0 International</a>. Construido sobre este libro <a href="http://apionrails.icalialabs.com/book/" class="bare">http://apionrails.icalialabs.com/book/</a>.</p>
</div>
<div class="paragraph">
<p>La portada de este libro usa una hermosa foto tomada por <a href="https://unsplash.com/@siloine?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Yoann Siloine</a> quien publicó en <a href="https://unsplash.com">Unsplash</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_agradecimientos">Agradecimientos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un gran "gracias" a todos los contribuidores de GitHub quienes mantienen este libro vivo. En orden alfabético:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/airdry">airdry</a></p>
</li>
<li>
<p><a href="https://github.com/Landris18">Landris18</a></p>
</li>
<li>
<p><a href="https://github.com/lex111">lex111</a></p>
</li>
<li>
<p><a href="https://github.com/cuilei5205189">cuilei5205189</a></p>
</li>
<li>
<p><a href="https://github.com/franklinjosmell">franklinjosmell</a></p>
</li>
<li>
<p><a href="https://github.com/notapatch">notapatch</a></p>
</li>
<li>
<p><a href="https://github.com/promisepreston">promisepreston</a></p>
</li>
<li>
<p><a href="https://github.com/tacataca">tacataca</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter01-introduction" class="sect0">Introducción</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Bienvenido a API on Rails 6, un tutorial con esteroides para enseñarte el mejor camino para construir tú siguiente API con Rails. El propósito de este libro es proveer una metodología comprensiva para desarrollar una API RESTful siguiendo las mejores prácticas.</p>
</div>
<div class="paragraph">
<p>Al finalizar este libro, tu podrás crear tu propia API e integrarla con cualquier cliente como un navegador web o aplicación móvil. El código generado esta codeado con Ruby on Rails 6.0 que es la versión actual.</p>
</div>
<div class="paragraph">
<p>El propósito de este libro no es solamente enseñarte como construir un API con Rails sino mucho mejor enseñarte como construir una API <strong>evolutiva</strong> y <strong>mantenible</strong> con Rails. Esto es, mejorar tu conocimiento actual con Rails. En esta sección, aprenderás a:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Usar Git para control de versiones</p>
</li>
<li>
<p>Construir respuestas JSON</p>
</li>
<li>
<p>Probar tus end-points con pruebas unitarias y funcionales</p>
</li>
<li>
<p>Configurar autenticación con JSON Web Tokens (JWT)</p>
</li>
<li>
<p>Usar la especificación JSON:API</p>
</li>
<li>
<p>Optimizar y hacer cache de la API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Recomiendo enérgicamente que sigas todos los pasos en este libro. Intenta no saltarte capítulos porque doy algunos tips y trucos para improvisar tus habilidades a través del libro. Puedes considerarte a ti mismo el personaje principal de un videojuego que gana un nivel en cada capítulo.</p>
</div>
<div class="paragraph">
<p>En este primer capítulo explicaré como configurar tu entorno de desarrollo (en caso que aún no lo sepas). Luego vamos a crear una aplicación llamada <code>market_place_api</code>. Me aseguraré que te enseño las mejores practicas que he aprendido durante mi experiencia. Esto significa que vamos a iniciar usando <strong>Git</strong> justo después de inicializar el proyecto.</p>
</div>
<div class="paragraph">
<p>Vamos a crear la aplicación siguiendo un método simple de trabajo que usé a diario en los siguientes capítulos. Vamos a desarrollar una aplicación completa usando Test Driven Development(TDD). También explicaré el interés de usar una API para tu siguiente proyecto y eligiendo un adecuado formato de respuesta como JSON o XML. Mas allá, vamos a tener nuestras manos sobre el código y completar lo básico de la aplicación construyendo todos los caminos necesarios. También vamos a implementar acceso seguro a la API implementando autenticación por intercambio de cabeceras HTTP. Finalmente, en el último capítulo, vamos a añadir técnicas de optimización para mejorar la estructura y tiempos de respuesta del servidor.</p>
</div>
<div class="paragraph">
<p>La aplicación final rozará la superficie de iniciar una tienda donde los usuario pueden realizar ordenes, subir productos y más. Hay muchas opciones allá afuera para echar a andar una tienda en linea, como <a href="http://shopify.com">Shopify</a>, <a href="http://spreecommerce.com/">Spree</a> o <a href="http://magento.com">Magento</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_convenciones_en_este_libro">Convenciones en este libro</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Las convenciones en este libro están basadas en este <a href="http://www.railstutorial.org/book/beginning#sec-conventions">Tutorial de Ruby on Rails</a>. En esta sección vamos a mencionar algunas que tal vez no son muy claras.</p>
</div>
<div class="paragraph">
<p>Utilizaré muchos ejemplos usando la línea de comandos. No intentare con windows <code>cmd</code> (lo siento chic@s), así que basare todos los ejemplos usando el estilo Unix, como a continuación se observa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"A command-line command"</span>
A command-line <span class="nb">command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estaré usando algunas pautas relacionadas al lenguaje, y me refiero a lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Evitar</strong> significa que no debes hacerlo</p>
</li>
<li>
<p><strong>Preferir</strong> indica que las 2 opciones, la primera es mejor</p>
</li>
<li>
<p><strong>Usar</strong> significa que eres bueno para usar el recurso</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si por alguna razón encuentras errores cuando ejecutas un comando, en lugar de tratar de explicar cada resultado posible, te recomiendo 'googlearlo', lo cual no lo considero una mala práctica. Pero si te gusta tomar una cerveza o tienes problemas con el tutorial siempre puedes <a href="mailto:contact@rousseau-alexandre.fr">escribirme</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_entornos_de_desarrollo">Entornos de desarrollo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una de las partes más dolorosas para casi todo desarrollador es configurar el entorno de desarrollo, pero mientras lo hagas, los siguientes pasos pueden ser una pieza del pastel y una buena recompensa. Así que voy a guiarte para que te sientas motivado.</p>
</div>
<div class="sect2">
<h3 id="_editores_de_texto_y_terminal">Editores de texto y terminal</h3>
<div class="paragraph">
<p>Hay muchos casos en que los entornos de desarrollo pueden diferir de computadora a computadora. Este no es el caso con los editores de texto o IDE&#8217;s. Pienso que para el desarrollo en Rails un IDE es demasiado, pero alguien podría encontrarlo como la mejor forma de hacerlo, así que si es tú caso te recomiendo que lo hagas con <a href="http://www.aptana.com/products/radrails">RadRails</a> o <a href="http://www.jetbrains.com/ruby/index.html">RubyMine</a>, ambos están bien soportados y vienen con muchas integraciones 'out of the box'.</p>
</div>
<div class="paragraph">
<p><strong>Editor de texto</strong>: En lo personal uso <a href="http://www.vim.org/">vim</a> como mi editor por defecto con <a href="https://github.com/carlhuda/janus">janus</a> el cual puede añadir y manejar muchos de los plugins que probablemente vas a utilizar. En caso que no sea un fan de <em>vim</em> como yo, hay muchas otras soluciones como <a href="http://www.sublimetext.com/">Sublime Text</a> que es multi plataforma, fácil de aprender y personalizable (este es probablemente tú mejor opción), esta altamente inspirado por <a href="http://macromates.com/">TextMate</a> (solo disponible para Mac OS). Una tercera opción es usando un muy reciente editor de texto de los chicos de <a href="http://gitub.com">GitHub</a> llamado <a href="https://atom.io/">Atom</a>, es un prometedor editor de texto echo con JavaScript, es fácil de extender y personalizar para satisfacer tus necesidades, dale una oportunidad. Cualquiera de los editores que te presento harán del trabajo, así que te dejo elegir cual se ajusta a tu ojo.</p>
</div>
<div class="paragraph">
<p><strong>Terminal</strong>: Si decides seguir con <a href="http://icalialabs.github.io/kaishi/">kaishi</a> para configurar el entorno, notarás que pone pro defecto el shell con <code>zsh</code>, lo cual recomiendo bastante. Para la terminal, no soy fan de aplicaciones de <em>Terminal</em> que traen mejoras si estas en Mac OS, así que mira <a href="http://www.iterm2.com/#/section/home">iTerm2</a>, Que es un remplazo de la terminal para Mac OS. Si estas en Linux probablemente ya tienes una linda terminal, pero la que viene por defecto puede funcionar bien.</p>
</div>
</div>
<div class="sect2">
<h3 id="_navegadores">Navegadores</h3>
<div class="paragraph">
<p>Cuando se trata de navegadores diría <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> inmediatamente, pero algunos otros desarrolladores pueden decir <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> o incluso <a href="https://www.apple.com/safari/">Safari</a>. Cualquiera de ellos ayudara a construir la aplicación que buscas, ellos vienen con un buen inspector no justamente para el DOM pero para el análisis de red y muchas otras características que ya conoces.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manejador_de_paquetes">Manejador de paquetes</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Mac OS</strong>: Hay muchas opciones para gestionar o instalar tus paquetes en tu Mac, como el <a href="https://www.macports.org/">Mac Ports</a> ó <a href="http://brew.sh/">Homebrew</a>, ambos son buenas opciones pero yo elegiría la última, he encontrado menos problemas cuando instalo software y lo administro. Para instalar <code>brew</code>  solo ejecuta en la consola lo siguiente:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Linux</strong>: Estas listo!, realmente no es mucho problema si tu estas usando <code>apt</code>, <code>pacman</code>, <code>yum</code> siempre que te sientas cómodo con ello sepas como instalar paquetes para poder seguir avanzando.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_git">Git</h3>
<div class="paragraph">
<p>Usaremos Git bastante, y puedes usarlo no solo para el propósito de este tutorial sino para cada proyecto independiente.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>en Mac OS: <code>$ brew install git</code></p>
</li>
<li>
<p>en Linux: <code>$ sudo apt-get install git</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ruby">Ruby</h3>
<div class="paragraph">
<p>Son muchos los caminos en que puedes instalar y gestionar ruby, y ahora tú puedes tener probablemente alguna versión instalada si estas en Mac OS, para ver la versión que tienes, solo ejecuta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ruby <span class="nt">-v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails 6.0 requiere la instalación de la versión 2.5 o mayor.</p>
</div>
<div class="paragraph">
<p>Yo recomiendo usar <a href="http://rvm.io/">Ruby Version Manager (RVM)</a> ó <a href="http://rbenv.org/">rbenv</a> para instalarlo. Vamos a usar RVM en este tutorial, pero no hay problema con cuál de las 2 utilices.</p>
</div>
<div class="paragraph">
<p>El principio de esta herramienta es permitirte instalar varias versiones de Ruby en el mismo equipo, en un entorno hermético con una posible versión instalada en tu sistema operativo y luego tener la habilidad de cambiar de una a otra versión fácilmente.</p>
</div>
<div class="paragraph">
<p>Para instalar RVM, ve a <a href="https://rvm.io/" class="bare">https://rvm.io/</a> e instala la huella de la llave GPG: [La huella de la llave GPG te permite verificar la identidad del autor o del origen de la descarga.]. Para realizarlo ejecutamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gpg <span class="nt">--keyserver</span> hkp://keys.gnupg.net <span class="nt">--recv-keys</span> 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
<span class="nv">$ </span><span class="se">\c</span>url <span class="nt">-sSL</span> https://get.rvm.io | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora instalaremos ruby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rvm <span class="nb">install </span>2.6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora es momento de instalar el resto de dependencias que vamos a usar.</p>
</div>
<div class="sect3">
<h4 id="_gemas_rails_y_librerías_faltantes">Gemas, Rails y Librerías faltantes</h4>
<div class="paragraph">
<p>Primero actualizamos las gemas en el sistema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gem update <span class="nt">--system</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En algunos casos si estas en Mac OS, necesitarás instalar algunas librerías extras:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>brew <span class="nb">install </span>libtool libxslt libksba openssl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Luego instalamos las gemas necesarias e ignoramos la documentación para cada una:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gem <span class="nb">install </span>bundler
<span class="nv">$ </span>gem <span class="nb">install </span>rails <span class="nt">-v</span> 6.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Revisamos que todo funciona correctamente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nt">-v</span>
Rails 6.0.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_base_de_datos">Base de datos</h4>
<div class="paragraph">
<p>Recomiendo mucho que instales <a href="http://www.postgresql.org/">Postgresql</a> para gestionar tus bases de datos. Pero aquí usaremos <a href="http://www.sqlite.org/">SQlite</a> por simplicidad. Si estas usando Mac OS estas listo para continuar, en caso que uses Linux, no te preocupes solo nos faltan unos pasos más:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>libxslt-dev libxml2-dev libsqlite3-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>ó</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>libxslt-devel libxml2-devel libsqlite3-devel</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inicializando_el_proyecto">Inicializando el proyecto</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Inicializar una aplicación Rails puede ser muy sencillo para ti. Si no es el caso aquí tienes un tutorial super rápido.</p>
</div>
<div class="paragraph">
<p>Estos son los comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir</span> ~/workspace
<span class="nv">$ </span><span class="nb">cd</span> ~/workspace
<span class="nv">$ </span>rails new market_place_api <span class="nt">--api</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
La opción <code>--api</code> apareció en la versión 5 de Rails. Ésta te permite limitar las librerías y <em>Middleware</em> incluido en la aplicación. Esto también evita generar vistas HTML cuando se usan los generadores de Rails.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Como puedes adivinar, los anteriores comandos generaran los huesos desnudos de tu aplicación Rails.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_versionado">Versionado</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Recuerda que Git te ayuda a dar seguimiento y mantener el historial de tu código. Ten en mente que el codigo fuente de la aplicación es publicado en GitHub. Puedes seguir el proyecto en <a href="https://github.com/madeindjs/market_place_api_6">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>Ruby on Rails inicializa el directorio Git por tí cuando usas el comando <code>rails new</code>. Esto significa que no necesitas ejecutar el comando <code>git init</code>.</p>
</div>
<div class="paragraph">
<p>Sin embargo es necesario configurar la información del autor de los <em>commits</em>. Si aún no lo has echo, ve al directorio de proyecto y corre los siguientes comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git config <span class="nt">--global</span> user.name <span class="s2">"Aquí pon tu nombre"</span>
<span class="nv">$ </span>git config <span class="nt">--global</span> user.email <span class="s2">"Aquí pon tu email"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails también provee un archivo <code>.gitignore</code> para ignorar algunos archivos a los que no queramos dar seguimiento. El archivo <code>.gitignore</code> por defecto puede lucir como se ve a continuación:</p>
</div>
<div class="listingblock">
<div class="title">.gitignore</div>
<div class="content">
<pre># Ignore bundler config.
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3
/db/*.sqlite3-journal

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

# Ignore uploaded files in development.
/storage/*
!/storage/.keep
.byebug_history

# Ignore master key for decrypting credentials and more.
/config/master.key</pre>
</div>
</div>
<div class="paragraph">
<p>Después de modificar el archivo <code>.gitignore</code> únicamente necesitamos añadir los archivos y hacer <em>commit</em> de los cambios, para ello usamos los siguientes comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Commit Inicial"</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
He encontrado que el mensaje del commit debería iniciar con un verbo en tiempo presente, describiendo lo que el commit hace y no lo que hizo, ayuda cuando estás explorando el historial del proyecto. Encontré esto más natural para leer y entender. Seguiremos esta práctica hasta el final del tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por ultimo y como un paso opcional configuramos el proyecto en GitHub y hacemos <em>push</em> de nuestro código al servidor remoto: Pero primero añadimos el <em>remoto</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git remote add origin git@github.com:madeindjs/market_place_api_6.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces hacemos <em>push</em>(empujamos) el código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git push <span class="nt">-u</span> origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>A medida que avanzamos con el tútorial, usaré las practicas que uso a diario, esto incluye trabajar con <code>branches</code>(ramas), <code>rebasing</code>, <code>squash</code> y algo mas. Por ahora no debes preocuparte si algunos términos no te suenan familiares, te guiaré en ello con el tiempo.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ha sido un largo camino a través de este capítulo, si has llegado hasta aquí déjame felicitarte y asegurarte que a partir de este punto las cosas mejorarán. Asi que vamos a ensuciarnos las manos y comenzar a escribir algo de código!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter02-api" class="sect0">La API</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>En esta sección resumiré la aplicación. Hasta aquí ya debiste leer el capítulo anterior. Si no lo has leído te recomiendo que lo hagas.</p>
</div>
<div class="paragraph">
<p>Puedes clonar el proyecto hasta este punto con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter02</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resumiendo, simplemente generamos nuestra aplicación Rails e hicimos el primer commit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_planificando_la_aplicación">Planificando la aplicación</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Como queremos que la aplicación sea sencilla, esta consistirá de 5 modelos. No te preocupes si no entiendes completamente que estamos haciendo. Vamos a revisar y a construir cada uno de los recursos a medida que avancemos con el tutorial.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="img/data_model.png" alt="Esquema conexiones entre los modelos"></span></p>
</div>
<div class="paragraph">
<p>Resumiendo, el <code>user</code>(usuario) podrá realizar muchas <code>orders</code>(ordenes/pedidos), subir múltiples <code>products</code>(productos) los cuales pueden tener muchas <code>images</code>(imágenes) ó <code>comments</code>(comentarios) de otros usuarios de la aplicación.</p>
</div>
<div class="paragraph">
<p>No construiremos vistas para mostrar o interactuar con la API, así que no hagas de esto un gran tutorial. Para ello hay muchas opciones allá afuera como los frameworks de javascript (<a href="https://angularjs.org/">Angular</a>, <a href="https://vuejs.org/">Vue.js</a>, <a href="https://reactjs.org/">React.js</a>).</p>
</div>
<div class="paragraph">
<p>Hasta este punto deberías preguntarte:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>¿Esta bien, pero, yo necesito explorar o visualizar cómo va la construcción del API?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Y eso es justo. Probablemente si googleas algo relacionado con explorar un api, aparecerá una aplicación llamada <a href="https://www.getpostman.com/">Postman</a>. Este es un gran software pero no lo utilizaremos porque usaremos <strong>cURL</strong> que permite a cualquiera reproducir peticiones en cualquier computadora.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configurar_la_api">Configurar la API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una API es definida por <a href="http://en.wikipedia.org/wiki/Application_programming_interface">wikipedia</a> como _La interfaz de programación de aplicaciones (API), es un conjunto de subrutinas, funciones y procedimientos que ofrece cierta biblioteca para ser utilizado por otro software como una capa de abstracción. _ En otras palabras la forma en que el sistema interactúa entre sí mediante una interfaz común, en nuestro caso un servicio web construido con JSON. Hay otros protocolos de comunicación como SOAP, pero no lo cubriremos aquí.</p>
</div>
<div class="paragraph">
<p>JSON, como tipo estándar en Internet, es ampliamente aceptado, legible, extensible y fácil de implementar.
Muchos de los frameworks actuales consumen APIs JSON por defecto (<a href="https://angularjs.org/">Angular</a> ó <a href="https://vuejs.org/">Vue.js</a> por ejemplo). También hay grandes bibliotecas para Objetive-C como <a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> ó <a href="http://restkit.org/">RESTKit</a>. Probablemente hay buenas soluciones para Android, pero por mi falta de experiencia en esa plataforma, podría no ser la persona adecuada para recomendarte alguna.</p>
</div>
<div class="paragraph">
<p>Muy bien. Así que vamos a construir nuestra API con JSON. Hay muchos caminos para logarlo. Lo primero que me viene a la mente es justamente iniciar añadiendo rutas definiendo los <em>end points</em>. Pero puede ser mala idea porque no hay un <a href="http://www.w3.org/2005/Incubator/wcl/matching.html">patrón URI</a> suficientemente claro para saber que recurso está expuesto. El protocolo o estructura del que estoy hablando es <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> que significa Transferencia de Estado Representacional(Representational state transfer) según la definición de Wikipedia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="soap">aService.getUser("1")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y en REST puedes llamar una URL con una petición HTTP específica, en este caso con una petición GET: <a href="http://domain.com/resources_name/uri_pattern" class="bare">http://domain.com/resources_name/uri_pattern</a></p>
</div>
<div class="paragraph">
<p>La APIs RESTful debe seguir al menos tres simples pautas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una base <a href="http://en.wikipedia.org/wiki/Uniform_resource_identifier">URI</a>, como es <code><a href="http://example.com/resources/" class="bare">http://example.com/resources/</a></code>.</p>
</li>
<li>
<p>Un tipo multimedia de Internet para representar los datos, es comúnmente JSON y es comúnmente definido mediante el intercambio de cabeceras.</p>
</li>
<li>
<p>Sigue el estándar <a href="http://en.wikipedia.org/wiki/HTTP_method#Request_methods">Metodos HTTP</a> como son GET, POST, PUT, DELETE.</p>
<div class="ulist">
<ul>
<li>
<p><strong>GET</strong>: Lee el recurso o recursos definidos por el patrón URI</p>
</li>
<li>
<p><strong>POST</strong>: Crea una nueva entrada en la colección de recursos</p>
</li>
<li>
<p><strong>PUT</strong>: Actualiza una colección o un miembro de los recursos</p>
</li>
<li>
<p><strong>DELETE</strong>: Destruye una colección o miembro de los recursos</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esto podría no ser suficientemente claro o podría parecer mucha información para digerir, pero como vamos avanzando en el tutorial, con suerte conseguirás entender con mayor facilidad.</p>
</div>
<div class="sect2">
<h3 id="_restricciones_de_rutas_y_espacios_de_nombres">Restricciones de Rutas y Espacios de Nombres</h3>
<div class="paragraph">
<p>Antes de comenzar a escribir código, preparamos el código con git. Vamos a estar usando una rama por capítulo, la subiremos a GitHub y entonces la fusionaremos con la rama master. Así que vamos a a iniciar abriendo la terminal, <code>cd</code> hacia el directorio <code>market_place_api</code> y tecleamos lo siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter02
Switched to a new branch <span class="s1">'chapter02'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Únicamente vamos a estar trabajando en <code>config/routes.rb</code>, ya que solo vamos a establecer las restricciones y el <code>formato</code> de respuesta predeterminado para cada respuesta.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Primero que todo borra todo el código comentado que viene en el archivo, no lo vamos a necesitar. Entonces haz un commit, solo como un calentamiento:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add config/routes.rb
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Removes comments from the routes file"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a aislar los controladores del API bajo un espacio de nombres. Con Rails esto es bastante simple: solo tienes que crear un folder en <code>app/controllers</code> llamado <code>api</code>. El nombre es importante porque es el espacio de nombres que usaremos para gestionar los controladores para los endpoints del api.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces agregamos el nombre de espacio dentro de nuestro archivo <em>routes.rb</em>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span> <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por definición un espacio de nombres en el archivo <code>routes.rb</code>. Rails automáticamente mapeara que espacio de nombres corresponde al folder de los <em>controlladores</em>, en nuestro caso el directorio <code>api/`</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Archivos multimedia soportados por Rails</div>
<div class="paragraph">
<p>Rails soporta 35 tipos diferentes de archivos multimedia, puedes listarlos accediendo a la clase SET del módulo Mime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails c
2.6.3 :001 <span class="o">&gt;</span> Mime::SET.collect<span class="o">(</span>&amp;:to_s<span class="o">)</span>
 <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"text/html"</span>, <span class="s2">"text/plain"</span>, <span class="s2">"text/javascript"</span>, <span class="s2">"text/css"</span>, <span class="s2">"text/calendar"</span>, <span class="s2">"text/csv"</span>, <span class="s2">"text/vcard"</span>, <span class="s2">"text/vtt"</span>, <span class="s2">"image/png"</span>, <span class="s2">"image/jpeg"</span>, <span class="s2">"image/gif"</span>, <span class="s2">"image/bmp"</span>, <span class="s2">"image/tiff"</span>, <span class="s2">"image/svg+xml"</span>, <span class="s2">"video/mpeg"</span>, <span class="s2">"audio/mpeg"</span>, <span class="s2">"audio/ogg"</span>, <span class="s2">"audio/aac"</span>, <span class="s2">"video/webm"</span>, <span class="s2">"video/mp4"</span>, <span class="s2">"font/otf"</span>, <span class="s2">"font/ttf"</span>, <span class="s2">"font/woff"</span>, <span class="s2">"font/woff2"</span>, <span class="s2">"application/xml"</span>, <span class="s2">"application/rss+xml"</span>, <span class="s2">"application/atom+xml"</span>, <span class="s2">"application/x-yaml"</span>, <span class="s2">"multipart/form-data"</span>, <span class="s2">"application/x-www-form-urlencoded"</span>, <span class="s2">"application/json"</span>, <span class="s2">"application/pdf"</span>, <span class="s2">"application/zip"</span>, <span class="s2">"application/gzip"</span><span class="o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Esto es importante porque vamos a trabajar con JSON, uno de los <a href="http://en.wikipedia.org/wiki/Internet_media_type">tipos MIME</a> aceptados por Rails, solo necesitamos especificar que este es el formato por defecto:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta este punto no hemos hecho nada loco. Ahora lo que queremos es una <em>base_uri</em> que incluye la versión de la API. Pero hagamos commit antes de ir a la siguiente sección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add config/routes.rb
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Set the routes constraints for the api"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_versionado_api">Versionado Api</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta este punto deberíamos tener un buen mapeado de rutas usando espacio de nombres. Tu archivo <code>routes.rb</code> debería lucir como esto:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora es tiempo de configurar algunas otras restricciones para propósitos de versionado. Deberías preocuparte por versionar tú aplicación desde el inicio pues le dará una mejor estructura a tu api, y cuando hagas cambios, puedes dar a los desarrolladores que están consumiendo tu api la oportunidad de adaptar las nuevas características mientras las viejas quedan obsoletas. Este es un excelente <a href="http://railscasts.com/episodes/350-rest-api-versioning">railscast</a> explicando esto.</p>
</div>
<div class="paragraph">
<p>Para establecer la versión del API, primero necesitamos agregar otro directorio en el de <code>api</code> que antes creamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>De esta forma podemos definir espacio de nombres a nuestra api con diferentes versiones fácilmente, ahora solo necesitamos añadir el código necesario al archivo <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># We are going to list our resources here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta este punto, el API puede ser alcanzada a través de la URL. Por ejemplo con esta configuración un end-point para recuperar un producto podría ser algo como: <a href="http://localhost:3000/v1/products/1" class="bare">http://localhost:3000/v1/products/1</a> .</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Patrones Comunes del API</div>
<div class="paragraph">
<p>Puedes encontrar muchas formas de configurar un <em>base_uri</em> cuando construimos un api siguiendo diferentes patrones, asumiendo que estamos versionando nuestra api:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api.example.com/</code>: En mi opinión este es el camino a seguir, te da una mejor interfaz y aislamiento, y a largo plazo puede ayudarte a <a href="http://www.makeuseof.com/tag/optimize-your-dns-for-faster-internet/">escalar rápidamente</a></p>
</li>
<li>
<p><code>example.com/api/</code>: Este patrón es muy común, y es actualmente un buen camino a seguir cuando no quieres poner bajo espacio de nombres tu api en un subdominio</p>
</li>
<li>
<p><code>example.com/api/v1</code>: parece buena idea, poniendo la versión del api mediante la URL, parece como un patrón descriptivo, pero esta forma te forza a incluir la URL en cada petición, así que si en algún momento decides cambiar este patrón, se convierte en un problema de mantenimiento a largo plazo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas son algunas prácticas en la construcción de una API que recomiendan no versionar el API a través de la URL. Es verdad. El desarrollador no debería conocer la versión que está usando. En términos de simplicidad, he decidido dejar esta convención, que podremos aplicar en una segunda fase.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Es tiempo de hacer <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Set the versioning namespaces for API"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Estamos en lo último del capítulo. Por lo tanto, es tiempo de aplicar nuestras modificaciones a la rama master haciendo un <em>merge</em>. Para hacerlo, nos cambiamos a la rama <code>master</code> y hacemos <em>merge</em> de <code>chapter02</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter02</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_2">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ha sido un largo camino, lo sé, pero lo hiciste, no te rindas esto solo es un pequeño escalón para cualquier cosa grande, así que sigue. Mientras tanto y si te sientes curioso hay algunas gemas que pueden manejar este tipo de configuración:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Sutto/rocket_pants">RocketPants</a></p>
</li>
<li>
<p><a href="https://github.com/bploetz/versionist">Versionist</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>No cubriré eso en este libro, ya que estamos intentando aprender a implementar este tipo de funcionalidades, pero es bueno saberlo. Por cierto, el código hasta este punto está <a href="https://github.com/madeindjs/market_place_api_6/releases/tag/checkpoint_chapter03">aquí</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter03-presenting-users" class="sect0">Presentando a los usuarios</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>En el último capítulo configuramos el esqueleto para la configuración de los enpoints en nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>En un próximo capítulo manejaremos autenticación de usuarios mediante autenticación con tokens configurando permisos para poner límites de acceso preguntando que usuario esta autenticado. En capítulos venideros vamos a relacionar <code>products</code> (productos) a usuarios y dar la habilidad de generar órdenes.</p>
</div>
<div class="paragraph">
<p>Puedes clonar el proyecto hasta este punto con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter03</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como ya estarás imaginando hay muchas soluciones de autenticación para Rails, <a href="https://github.com/binarylogic/authlogic">AuthLogic</a>, <a href="https://github.com/thoughtbot/clearance">Clearance</a> y <a href="https://github.com/plataformatec/devise">Devise</a>.</p>
</div>
<div class="paragraph">
<p>Estas librerías son soluciones como llave en mano, por ejemplo ellas te permiten gestionar un montón de cosas como autenticación, olvido de contraseña, validación, etc.. Sin embargo, vamos a usar la gema <a href="https://github.com/codahale/bcrypt-ruby">bcrypt</a> para generar un hash para la contraseña del usuario.</p>
</div>
<div class="paragraph">
<p>Este capítulo estará completo. Puede ser largo pero intentare cubrir el mayor número de temas posibles.
Siéntete libre de tomar un café y vamos. Al final de este capítulo tendrás construida la lógica del usuario así como la validación y manejo de errores.</p>
</div>
<div class="paragraph">
<p>Es un buen momento para crear una nueva rama:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter03</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Asegúrate que estas en la rama <code>master</code> antes de hacer <em>checkout</em>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modelo_usuario">Modelo usuario</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_generación_del_modelo_user">Generación del modelo <code>User</code></h3>
<div class="paragraph">
<p>Comenzaremos por generar nuestro modelo <code>User</code>. Este modelo será realmente básico y tendrá solo dos campos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>email</code> el cual será único y permitirá conectar con la aplicación</p>
</li>
<li>
<p><code>password_digest</code> el cual contiene la versión  <strong>hasheada</strong> de la contraseña (los discutiremos mas tarde en este capítulo)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generamos nuestro modelo <code>User</code> usando el comando  <em>generate model</em> provisto por Ruby on Rails. Es muy fácil de usar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model User email:string password_digest:string
invoke  active_record
      create    db/migrate/20190603195146_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      <span class="nb">test</span>/models/user_test.rb
      create      <span class="nb">test</span>/fixtures/users.yml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
El <em>modelo</em> es el elemento que contiene la información o datos así como la lógica relacionada a esa información: validación, lectura y guardado.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>¡Este comando genera un montón de archivos! No te preocupes revisaremos uno por uno.</p>
</div>
<div class="paragraph">
<p>El archivo de migración contenido en el forder <code>db/migrate</code> contiene la  <strong>migración</strong> que describe los cambios que realizará en la base de datos. Este archivo puede lucir así:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:password_digest</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
La fecha insertada al inicio del nombre del archivo de migración debiera ser diferente para ti ya que corresponde a la fecha de creación de la migración.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Haremos un pequeño cambio a la migración a fin de añadir algunas validaciones a la base de datos. Con rails es una práctica común hacer validaciones directamente en el modelo Ruby. Es buena práctica hacer algo en el esquema de la base de datos.</p>
</div>
<div class="paragraph">
<p>Por lo tanto haremos dos restricciones adicionales:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>email es forzoso: usaremos la propiedad <code>null: false</code>.</p>
</li>
<li>
<p>email debe ser único: añadiremos un índice para la columna email con la propiedad <code>unique: true</code>.</p>
</li>
<li>
<p>password es forzoso: usamos la propiedad <code>null: false</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La migración quedaría así:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez completa la migración, podemos correr los cambios con el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span>
<span class="o">==</span> <span class="mi">20190603195146</span> <span class="no">CreateUsers</span><span class="p">:</span> <span class="n">migrating</span> <span class="o">======================================</span>
<span class="o">--</span> <span class="n">create_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span>
   <span class="o">-&gt;</span> <span class="mf">0.0027</span><span class="n">s</span>
<span class="o">==</span> <span class="mi">20190603195146</span> <span class="no">CreateUsers</span><span class="p">:</span> <span class="n">migrated</span> <span class="p">(</span><span class="mf">0.0028</span><span class="n">s</span><span class="p">)</span> <span class="o">=============================</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Este comando convertirá nuestra migración en una consulta SQL que actualizara la base de datos SQLite3 almacenada en el folder <em>db</em>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_modelo">Modelo</h4>
<div class="paragraph">
<p>Así definimos nuestro esquema de la base de datos. El siguiente paso es actualizar nuestro modelo para definir <strong>reglas de validación</strong>. Estas reglas están definidas en el modelo localizado en el folder`app/models`.</p>
</div>
<div class="paragraph">
<p>Ruby on Rails provee un mecanismo completo que puedes encontrar en <a href="https://guides.rubyonrails.org/active_record_validations.html">su documentación oficial</a>. En nuestro caso buscamos validar solo 3 cosas:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>que el email tenga un formato válido</p>
</li>
<li>
<p>que el email sea único</p>
</li>
<li>
<p>que la contraseña siempre contenga algo</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Estas tres reglas son definidas por el siguiente código:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">with: </span><span class="sr">/@/</span>
  <span class="n">validates</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí tienes. Rails una sintaxis simple y el código es muy legible.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Validación del Email</div>
<div class="paragraph">
<p>Habrás notado que la validación del email es muy simplista solo validando la presencia de una <code>@</code>.</p>
</div>
<div class="paragraph">
<p>Es normal.</p>
</div>
<div class="paragraph">
<p>Hay infinidad de excepciones en la dirección de un correo electrónico <a href="https://davidcel.is/posts/stop-validating-email-addresses-with-regex/">que incluso <code>Mira todos estos espacios!@example.com</code> es una dirección de correo valida</a>. Por lo tanto, es mejor para favorecer un enfoque sencillo y confirmar la dirección de correo enviando un email.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pruebas_unitarias">Pruebas unitarias</h4>
<div class="paragraph">
<p>Finalizamos con las pruebas unitarias. Aquí usaremos Minitest un framework de pruebas que es proporcionado por defecto con Rails.</p>
</div>
<div class="paragraph">
<p>Minitest está basado en <em>Fixtures</em> que te permiten llenar tu base de datos con datos predefinidos*. Los <em>Fixtures</em> están definidos en un archivo YAML en el directorio <code>tests/fixtures</code>. Hay un archivo por plantilla.</p>
</div>
<div class="paragraph">
<p>Debemos por lo tanto iniciar actualizando nuestros <code>tests/fixtures</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>fixtures</em> no están diseñados para crear todas los datos que tus pruebas necesitan.  Solo te permiten definir los datos básicos que tu aplicación necesita.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Así que comenzamos por crear un <em>fixture</em> definiendo un usuario:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/users.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">one@one.org</span>
  <span class="na">password_digest</span><span class="pi">:</span> <span class="s">hashed_password</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora podemos crear tres pruebas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1. Verifica que un usuario con datos correctos es válido:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with a valid email should be valid'</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'test@test.org'</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>2. Verifica que un usuario con un email erróneo no es válido:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with invalid email should be invalid'</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'test'</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>3. Verifica que un nuevo usuario con email no es válido. Así que usamos el mismo email que creamos en el <em>fixture</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with taken email should be invalid'</span> <span class="k">do</span>
  <span class="n">other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="n">other_user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí lo tienes. Podemos validar que nuestra implementación es correcta simplemente corriendo las pruebas unitarias que creamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
...
3 runs, 3 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>I think it&#8217;s time to do a little <em>commit</em> to validate our progress:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Create user model"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hash_de_la_contraseña">Hash de la contraseña</h3>
<div class="paragraph">
<p>Previamente implementamos el almacenamiento de los datos del usuario. Pero seguimos teniendo un problema por resolver:  <strong>el almacenamiento de la contraseña está en texto plano</strong>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Si almacenas la contraseña de los usuarios en texto plano, entonces un atacante que roba una copia de tu base de datos tiene una lista gigante de emails y contraseñas. Alguno de tus usuarios podría tener únicamente una contraseña&#8201;&#8212;&#8201;para su cuenta de email, para sus cuentas de banco, para su aplicación. Un simple hackeo puede escalar en un robo masivo de identidad. - <a href="https://github.com/codahale/bcrypt-ruby#why-you-should-use-bcrypt">fuente - Porque deberías usar bcrypt(en inglés)</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Así que vamos a usar la gema bcrypt para <strong>hashear</strong> la contraseña.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Hashear es el proceso de transformar un arreglo de caracteres en un <em>Hash</em>. Este <em>Hash</em> no te permite encontrar el arreglo de caracteres original. Pero como sea, podemos fácilmente usarlo para encontrar si un arreglo de caracteres dado coincide con el <em>hash</em> que almacenamos.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Primero debemos agregar la gema Bcrypt al <em>Gemfile</em>. Podemos usar el comando <code>bundle add</code>. Que hará:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>añadir la gema al Gemfile recuperando la versión más reciente</p>
</li>
<li>
<p>ejecutar el comando <code>bundle install</code> el cual instalará la gema y actualizará el archivo <em>Gemfile.lock</em> "bloqueando" la versión actual de la gema</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Por lo tanto, ejecutamos el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add bcrypt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez que el comando es ejecutado, la siguiente línea es añadida al final del <em>Gemfile</em>:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">gem</span> <span class="s2">"bcrypt"</span><span class="p">,</span> <span class="s2">"~&gt; 3.1"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
La versión 3.1 de bcrypt es la versión actual al momento de escribir. Esto podría por lo tanto variar en tú caso.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Active Record nos ofrece un método <a href="https://github.com/rails/rails/blob/6-0-stable/activemodel/lib/active_model/secure_password.rb#L61"><code>ActiveModel::SecurePassword::has_secure_password</code></a> que hará interfaz con Bcrypt y nos ayudará con la contraseña lo que lo hace más fácil.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_secure_password</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>has_secure_password</code> agrega las siguientes validaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La contraseña debe estar presente en la creación.</p>
</li>
<li>
<p>La longitud de la contraseña debe ser menor o igual a 72 bytes.</p>
</li>
<li>
<p>La confirmación de la contraseña usa el atributo <code>password_confirmation</code> (si es enviado)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En adición, este método añadirá un atributo <code>User#password</code> que será automáticamente hasheado y guardado en el atributo <code>User#password_digest</code>.</p>
</div>
<div class="paragraph">
<p>Vamos a intentarlo ahora mismo en la consola de Rails. Abre una consola con <code>rails console</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'toto@toto.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span>
 <span class="o">=&gt;</span><span class="c1">#&lt;User id: 1, email: "toto@toto.org", password_digest: [FILTERED], created_at: "2019-06-04 10:51:44", updated_at: "2019-06-04 10:51:44"&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Puedes ver que cuando llamas al método <code>User#create!</code> , el atributo <code>password</code> es hasheado y guardado en <code>password_digest</code>. Vamos a enviar también un atributo <code>password_confirmation</code> que ActiveRecord comparará con <code>password</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'tata@tata.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span><span class="p">,</span> <span class="ss">password_confirmation: </span><span class="s1">'azerty'</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span> <span class="p">(</span><span class="no">Validation</span> <span class="ss">failed: </span><span class="no">Password</span> <span class="n">confirmation</span> <span class="n">doesn</span> <span class="n">t</span> <span class="n">match</span> <span class="no">Password</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Todo está trabajando como lo planeamos! Vamos a hacer un <em>commit</em> para mantener la historia concisa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Setup Bcrypt"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creando_usuarios">Creando usuarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Es tiempo de hacer nuestro primer "entry point". Iniciaremos por construir la acción <code>show</code> que responderá con información de un usuario único en formato JSON. Los pasos son:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>generar el controlador <code>users_controller</code>.</p>
</li>
<li>
<p>añadir las pruebas correspondientes</p>
</li>
<li>
<p>construir el código real.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vamos a enfocarnos primero en generar el controlador y las pruebas funcionales.</p>
</div>
<div class="paragraph">
<p>En orden para respetar la vista de nuestra API, vamos a cortar nuestra aplicación usando <strong>modules</strong> (módulos). La sintaxis por lo tanto es la siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::users</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este comando creará el archivo <code>users_controller_test.rb</code>. Antes de ir más lejos hay dos cosas que queremos probar en nuestra API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La estructura JSON que devuelve el servidor</p>
</li>
<li>
<p>El código de la respuesta HTTP que devuelve el servidor</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Códigos HTTP más comunes</div>
<div class="paragraph">
<p>El primer dígito de el código de estado especifica una de las 5 clases de respuesta. El mínimo indispensable para un cliente HTTP es que este una de estas 5 clases. Esta es una lista de los códigos HTTP comúnmente usados:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>200</code>: Respuesta estándar para una solicitud HTTP exitosa. Usualmente en solicitudes <code>GET</code></p>
</li>
<li>
<p><code>201</code>: La petición fue recibida y resulta en la creación del nuevo recurso. Después de una solicitud <code>POST</code></p>
</li>
<li>
<p><code>204</code>: El servidor tiene una petición procesada con éxito, pero no se regresó ningún contenido. Esto es usual en una solicitud <code>DELETE</code> exitosa.</p>
</li>
<li>
<p><code>400</code>: La petición no se puede ejecutar debido a una sintaxis incorrecta. Puede suceder para cualquier tipo de solicitud.</p>
</li>
<li>
<p>401: Similar al 403, pero especialmente usada al solicitar autenticación y ha fallado o aún no se ha proporcionado. Puede suceder en cualquier tipo de solicitud.</p>
</li>
<li>
<p><code>404</code>: El recurso solicitado no fue encontrado, pero podría estar disponible en el futuro. Usualmente concierne a la petición <code>GET</code>.</p>
</li>
<li>
<p>500: Un mensaje de error genérico, dado cuando una condición inesperada ha sido encontrada y ningún otro mensaje especifico es apropiado.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para una lista completa de códigos HTTP, mira este <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">articulo de Wikipedia (en inglés)</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Por lo tanto, vamos a implementar la prueba funcional que verifica el acceso al método <code>Users#show</code>.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
    <span class="c1"># Test to ensure response contains the correct email</span>
    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces simplemente agrega la acción a tu controlador. Es extremadamente simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span>  <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># GET /users/1</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si corres la prueba con <code>rails test</code> obtienes el siguiente error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>

...E

Error:
UsersControllerTest#test_should_show_user:
DRb::DRbRemoteError: undefined method <span class="se">\`</span>api_v1_user_url<span class="s1">' for #&lt;UsersControllerTest:0x000055ce32f00bd0&gt; (NoMethodError)
    test/controllers/users_controller_test.rb:9:in `block in &lt;class:UsersControllerTest&gt;'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Este tipo de error es muy común cuando generaste tus recursos manualmente! En efecto, nos hemos olvidado por completo de <strong>la ruta</strong>. Así que vamos a añadirla:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las pruebas ahora deberían pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rails test
....
4 runs, 5 assertions, 0 failures, 0 errors, 0 skips</pre>
</div>
</div>
<div class="paragraph">
<p>Como siempre, después de añadir una característica que nos satisface, vamos a hacer un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds show action to the users controller"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_prueba_tu_recurso_con_curl">Prueba tu recurso con cURL</h3>
<div class="paragraph">
<p>Así que finalmente tenemos un recurso para probar. Tenemos muchas soluciones para probarlo. La primera que se me viene a la mente es hacer uso de cURL, el cual está integrado en la mayoría de distribuciones Linux. Así que vamos a probarlo:</p>
</div>
<div class="paragraph">
<p>Primero inicializamos el servidor de Rails en una nueva terminal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces cambia de nuevo a tu otra terminal y corre:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/api/v1/users/1
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"email"</span>:<span class="s2">"toto@toto.org"</span>, ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Encontramos el usuario que creamos con la consola de Rails en la sección previa. Ahora tienes una entrada en el API para registro de usuarios.</p>
</div>
</div>
<div class="sect2">
<h3 id="_crear_usuarios">Crear usuarios</h3>
<div class="paragraph">
<p>Ahora que tenemos mejor entendimiento de como construir "entry points" (puntos de entrada), es tiempo de extender nuestra API. Una de las características más importantes es darles a los usuarios que puedan crear un perfil en nuestra aplicación. Como siempre, vamos a escribir nuestras pruebas antes de implementar nuestro código para extender nuestro banco de pruebas.</p>
</div>
<div class="paragraph">
<p>Asegura que tu directorio de Git está limpio y que no tienes algún archivo en <em>staging</em>. Si es así hazles <em>commit</em> que vamos a empezar de nuevo.</p>
</div>
<div class="paragraph">
<p>Así que vamos a iniciar por escribir nuestra prueba añadiendo una entrada para crear un usuario en el archivo <code>users_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should create user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_users_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'test@test.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should not create user with taken email"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_users_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es un montón de código. No te preocupes explicare todo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En el primer test revisamos la creación de un usuario enviando una petición POST valida. Entonces, revisamos que un usuario adicional ahora existe en la base de datos y que el código HTTP de respuesta es <code>created</code> (código de estado 201)</p>
</li>
<li>
<p>En el segundo test revisamos que el usuario no es creado usando una dirección de correo que ya está en uso. Entonces, revisamos que el código HTTP de respuesta es <code>unprocessable_entity</code> (código de estado 422)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hasta este punto, la prueba debería de fallar (como esperábamos):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
...E</code></pre>
</div>
</div>
<div class="paragraph">
<p>Asi que es tiempo de implementar el código para que nuestra prueba sea exitosa:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="c1"># POST /users</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># Only allow a trusted parameter "white list" through.</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recuerda que cada vez que agregamos una entrada en nuestra API debemos agregar esta acción en nuestro archivo <code>routes.rb</code>.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver, la implementación es bastante simple. También hemos añadido el método privado <code>user_params</code> para proteger de la asignación masiva de atributos. Ahora nuestra prueba debería de pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
......
6 runs, 9 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yeah! Hagamos <em>commit</em> de los cambios y a continuar construyendo nuestra aplicación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the user create endpoint"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_actualizar_usuarios">Actualizar usuarios</h3>
<div class="paragraph">
<p>El esquema para actualizar usuarios es muy similar a la de creación. Si eres un desarrollador Rails experimentado, ya sabes las diferencias entre estas dos acciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La accion update (actualizar) responde a una petición PUT/PATCH.</p>
</li>
<li>
<p>Únicamente un usuario conectado debería ser capaz  de actualizar su información. Esto significa que tendremos que forzar a un usuario a autenticarse. Discutiremos esto en el capítulo 5.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como siempre, empezamos escribiendo nuestra prueba:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should not update user when invalid params are sent"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'bad_email'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para que la prueba se exitosa, debemos construir la acción update en el archivo <code>users_controller.rb</code> y agregar la ruta al archivo <code>routes.rb</code>. Como puedes ver, tenemos mucho código duplicado, vamos a rediseñar nuestra prueba en el capítulo 4. Primero añadimos la acción al archivo <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces implementamos la acción update en el controlador del usuario y corremos las pruebas:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update]</span>

  <span class="c1"># GET /users/1</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="c1"># PATCH/PUT /users/1</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">status: :ok</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">set_user</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todas nuestras pruebas deberían pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
........
8 runs, 11 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hacemos un <em>commit</em> ya que todo funciona:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds update action the users controller"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_eliminar_al_usuario">Eliminar al usuario</h3>
<div class="paragraph">
<p>Hasta aquí, hemos hecho un montón de acciones en el controlador del usuario con sus propias pruebas, pero no hemos terminado. Solo necesitamos una cosa más, que es la acción de destruir. Así que vamos a crear la prueba:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"should destroy user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver, la prueba es muy simple. Únicamente respondemos con estado <strong>204</strong> que significa <code>No Content</code> (Sin contenido). También podríamos devolver un código de estado <strong>200</strong>, pero encuentro más natural la respuesta <code>No Content</code> (Sin contenido) en este caso porque eliminamos un recurso y una respuesta exitosa podría ser bastante.</p>
</div>
<div class="paragraph">
<p>La implementación de la acción de destrucción es muy simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="c1"># ...</span>

  <span class="c1"># DELETE /users/1</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No olvides añadir la acción <code>destroy</code> en el archivo <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las pruebas deberían de pasar si todo es correcto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
.........
9 runs, 13 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recuerda que después de hacer algunos cambios en nuestro código, es buena práctica hacerles <em>commit</em> así podremos tener un historial segmentado correctamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds destroy action to the users controller"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y a medida que llegamos al final de nuestro capítulo, es tiempo de aplicar nuestra modificaciones a la rama master haciendo un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter03</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_3">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>¡Oh, ahí tienes!, ¡Bien echo! ¡Se que probablemente fue un largo tiempo, pero no te rindas! Asegúrate de entender cada pieza del código, las cosas mejorarán, en el siguiente capítulo, vamos a rediseñar nuestras pruebas para hace nuestro código más legible y mantenible. ¡Entonces quédate conmigo!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter05-authentication" class="sect0">Autenticando al usuario</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Ha sido un largo tiempo desde que iniciamos. Espero que te guste este viaje tanto como a mí.</p>
</div>
<div class="paragraph">
<p>En el capítulo anterior configuramos las entradas de recursos para los usuarios. Si te saltaste este capítulo o si no entendiste todo, te recomiendo encarecidamente que lo mires. Éste cubre las primeras bases de las pruebas y es una introducción a respuestas JSON.</p>
</div>
<div class="paragraph">
<p>Puedes clonar el proyecto hasta este punto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter04</code></pre>
</div>
</div>
<div class="paragraph">
<p>En este capítulo las cosas se pondrán muy interesantes porque vamos a configurar el mecanismo de autenticación. En mi opinión es uno de los capítulos más interesantes. Introduciremos un montón de términos nuevos y terminarás con un simple pero poderoso sistema de autenticación. No sientas pánico vamos por ello.</p>
</div>
<div class="paragraph">
<p>La primera cosa es que primero (y como es usual cuando iniciamos un nuevo capítulo) vamos a crear una nueva rama:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter04</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sesion_sin_estado">Sesion sin estado</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Antes de que hagamos algo, algo debe estar claro: <strong>una API no maneja sesiones</strong>. Si no tienes experiencia construyendo este tipo de aplicaciones puede sonar un poco loco pero quédate conmigo. Un API puede ser sin estado lo cual significa por definición <em>es una que provee una respuesta después de tú petición, y luego no requiere más atención</em>. Lo cual significa que un estado previo o un estado futuro no es requerido para que el sistema trabaje.</p>
</div>
<div class="paragraph">
<p>El flujo para autenticar al usuario mediante una API es muy simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>La petición del cliente para el recurso <code>sessions</code> con las correspondientes credenciales (usualmente email y password)</p>
</li>
<li>
<p>El server regresa el recurso <code>user</code> junto con su correspondiente token de autenticación</p>
</li>
<li>
<p>Para cada página que requiere autenticación el cliente tiene que enviar el <code>token de autenticación</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Por supuesto estos no son los únicos 3 pasos a seguir, y en el paso 2 debería pensar, bien yo realmente ¿necesito responder con la información del usuario o solo el <code>token de autenticación</code>? Yo podría decir que eso realmente depende de tí, pero a mí me gusta regresar el usuario completo, de esta forma puedo mapearlo de inmediato en mi cliente y guardar otra posible solicitud que haya sido echa.</p>
</div>
<div class="paragraph">
<p>En esta sección y la siguiente vamos a enfocarnos en construir un controlador de sesiones junto a sus acciones correspondientes. Vamos entonces a completar el flujo de solicitudes agregando los accesos de autorización necesarios.</p>
</div>
<div class="sect2">
<h3 id="_presentación_de_jwt">Presentación de JWT</h3>
<div class="paragraph">
<p>Cuando nos acercamos a los tokens de autenticación, tenemos un estándar: el JSON Web Token (JWT).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>JWT es un estándar abierto definido en RFC 75191. Este permite el intercambio seguro de tokens entre varias partes. - <a href="https://wikipedia.org/wiki/JSON_Web_Token_Web_Token">Wikipedia</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>En general un token JWT se compone de tres partes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un <strong>header</strong> estructurado en JSON contiene por ejemplo la fecha de validación del token.</p>
</li>
<li>
<p>un <strong>payload</strong> estructurado en JSON puede contener <strong>cualquier dato</strong>. En nuestro caso, contiene el indetificador del usuario "conectado".</p>
</li>
<li>
<p>un <strong>signature</strong> que nos permite verificar que el token fue encriptado por nuestra aplicación y es por lo danto válido.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas tres partes son cada una codificadas en base64 y entonces concatenadas usando puntos (<code>.</code>). Lo cual nos da algo como:</p>
</div>
<div class="listingblock">
<div class="title">Un token JWT válido</div>
<div class="content">
<pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</pre>
</div>
</div>
<div class="paragraph">
<p>Una ves decodificado, este token nos da la siguiente información:</p>
</div>
<div class="listingblock">
<div class="title">La cabecera del token JWT</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w"> </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="p">,</span><span class="w"> </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">El payload de el token JWT</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w"> </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234567890"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w"> </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Para más información sobre tokens JWT te invito a visitar <a href="https://jwt.io">jwt.io</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esto tiene muchas ventajas justo como enviar información en payload de tokens. Por ejemplo, podemos elegir integrar información del usuario en el <em>payload</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configurando_el_token_de_autenticación">Configurando el token de autenticación</h3>
<div class="paragraph">
<p>El estándar JWT tiene muchas implementaciones en varios lenguajes y librerías. Por supuesto, hay una gema de Ruby en este tema: <a href="https://github.com/jwt/ruby-jwt">ruby-jwt</a>.</p>
</div>
<div class="paragraph">
<p>Asi que vamos a comenzar instalándola:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add jwt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una vez completada la siguiente línea es añadida a tu <em>Gemfile</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">gem</span> <span class="s2">"jwt"</span><span class="p">,</span> <span class="s2">"~&gt; 2.2"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La librería es muy simple. Hay dos métodos: <code>JWT.encode</code> y <code>JWT.decode</code>. Vamos a abrir una terminal con <code>console rails</code> y a correr algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="n">token</span> <span class="o">=</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">encode</span><span class="p">({</span><span class="ss">message: </span><span class="s1">'Hello World'</span><span class="p">},</span> <span class="s1">'my_secret_key'</span><span class="p">)</span>
<span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s1">'my_secret_key'</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="p">[{</span><span class="s2">"message"</span><span class="o">=&gt;</span><span class="s2">"Hello World"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"alg"</span><span class="o">=&gt;</span><span class="s2">"HS256"</span><span class="p">}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En la primera línea codificamos un <em>payload</em> con la llave secreta <code>my_secret_key</code>. así obtenemos un token que podemos decodificar de manera simple. La segunda línea decodifica el token y vemos que podemos encontrar sin dilema nuestro <em>payload</em>.</p>
</div>
<div class="paragraph">
<p>Vamos a incluir toda la lógica en una clase <code>JsonWebToken</code> en un nuevo archivo localizado en <code>lib/</code>. Esto nos permite evitar el código duplicado. Esta clase justamente codificará y decodificará los tokens JWT. Así que aquí está la implementación.</p>
</div>
<div class="listingblock">
<div class="title">lib/json_web_token.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">JsonWebToken</span>
  <span class="no">SECRET_KEY</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">secret_key_base</span><span class="p">.</span><span class="nf">to_s</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">from_now</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">[</span><span class="ss">:exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">.</span><span class="nf">to_i</span>
    <span class="no">JWT</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="no">SECRET_KEY</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="no">SECRET_KEY</span><span class="p">).</span><span class="nf">first</span>
    <span class="no">HashWithIndifferentAccess</span><span class="p">.</span><span class="nf">new</span> <span class="n">decoded</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Yo se que es un montón de código pero lo revisaremos juntos.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>el método <code>JsonWebToken.encode</code> se encarga de codificar el <em>payload</em> añadiendo una fecha de expiración de 24 horas por defecto. Además usamos la misma llave de encriptación que viene configurada con Rails.</p>
</li>
<li>
<p>el método <code>JsonWebToken.decode</code> decodifica el token JWT y obtiene el <em>payload</em>. Entonces usamos la clase <a href="https://api.rubyonrails.org/classes/ActiveSupport/HashWithIndifferentAccess.html"><code>HashWithIndifferentAccess</code></a> proveída por Rails la cual nos permite recuperar un valor de un <code>Hash</code> con un <code>Symbol</code> ó <code>String</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ahí tienes. Para cargar el archivo en tú aplicación, necesitas especificar el directorio <code>lib</code> en la lista de _autoload  de Ruby on rails. Para hacerlo, agrega la siguiente configuración al archivo <code>application.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/application.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">module</span> <span class="nn">MarketPlaceApi</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ...</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'lib'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y eso es todo. Ahora es tiempo de hacer un commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Setup JWT gem"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controlador_de_token">Controlador de Token</h3>
<div class="paragraph">
<p>Tenemos sin embargo que configurar el sistema para generar un token JWT. Es ahora tiempo de crear una ruta que generará este token. Las acciones que implementaremos serán administradas como servicios <em>RESTful</em>: la conexión será gestionada por una petición POST a la acción <code>create</code>.</p>
</div>
<div class="paragraph">
<p>Para empezar, iniciaremos creando el controlador y el método <code>create</code> en el <em>namespace</em> <code>/api/v1</code>. Con Rails, una orden es suficiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::tokens create</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modificaremos la ruta un poco para respetar las convenciones <em>REST</em>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a construir pruebas funcionales antes de ir más lejos. El comportamiento deseado es el siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Yo recibo un token si envío un email valido junto con el password</p>
</li>
<li>
<p>de otro modo el server responde un <code>forbidden</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Las pruebas por lo tanto se materializan de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/tokens_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">Api::V1::TokensControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get JWT token'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">api_v1_tokens_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'g00d_pa$$'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get JWT token'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">api_v1_tokens_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'b@d_pa$$'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:unauthorized</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Te estarás preguntando: "¿pero como puedes saber la contraseña del usuario?". Simplemente usa el método <code>BCrypt::Password.create</code> en los <em>fixtures</em> de <code>users</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/users.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">one@one.org</span>
  <span class="na">password_digest</span><span class="pi">:</span> <span class="s">&lt;%= BCrypt::Password.create('g00d_pa$$') %&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En este preciso momento, si corres las pruebas obtendrás dos errores:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

........E

Error:
Api::V1::TokensControllerTest#test_should_get_JWT_token:
JSON::ParserError: 767: unexpected token at <span class="s1">''</span>


Failure:
Expected response to be a &lt;401: unauthorized&gt;, but was a &lt;204: No Content&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Es normal. Ahora es tiempo de implementar la lógica para crear el token JWT. Es muy sencillo.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/tokens_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::TokensController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="ss">:password</span><span class="p">])</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span>
        <span class="ss">token: </span><span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">),</span>
        <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
      <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="ss">:unauthorized</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># Only allow a trusted parameter "white list" through.</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es un montón de código pero es muy simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Siempre filtramos los parámetros con el método <code>user_params</code>.</p>
</li>
<li>
<p>Recuperamos el usuario con el método <code>User.find_by_email</code> (que es un método "mágico" de <em>Active Record</em> mientras el campo <code>email</code> esté presente en la base de datos) y recuperamos el usuario</p>
</li>
<li>
<p>Usamos el método <code>User#authenticate</code> (el cual existe gracias a la gema <code>bcrypt</code>) con la contraseña como un parámetro. Bcrypt hará un <em>hash</em> de la contraseña y verifica si coincide con el atributo <code>password_digest</code>. La función regresa <code>true</code> si todo salió bien, <code>false</code> si no.</p>
</li>
<li>
<p>Si la contraseña corresponde al <em>hash</em>, un JSON conteniendo el <em>token</em> generado con la clase <code>JsonWebToken</code> es devuelto. De otro modo, una respuesta vacía es devuelta con una cabecera <code>unauthorized</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>¿Estas hasta aquí? ¡No te preocupes, esta terminado! Ahora tus pruebas deberían pasar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

...........

Finished <span class="k">in </span>0.226196s, 48.6304 runs/s, 70.7351 assertions/s.
11 runs, 16 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Muy bien! Es tiempo de hacer un commit que contendrá todos nuestros cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Setup tokens controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usuario_logueado">Usuario logueado</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Entonces ya implementamos la siguiente lógica: la API retorna el token de autenticación a el cliente si las credenciales son correctas.</p>
</div>
<div class="paragraph">
<p>Pero ahora implementaremos la siguiente lógica: encontraremos el usuario correspondiente del token de autenticación proporcionado en la cabecera HTTP. Necesitamos hacerlo cada vez que este cliente solicite un <code>entry point</code>  que requiera permisos.</p>
</div>
<div class="paragraph">
<p>Usaremos la cabecera HTTP <code>Authorization</code> que a menudo es usada para este propósito. También podemos usar un parámetro GET llamado <code>apiKey</code> pero prefiero usar una cabecera HTTP porque da contexto a la petición sin contaminar la URL con parámetros adicionales.</p>
</div>
<div class="paragraph">
<p>Por lo tanto, crearemos un método <code>current_user</code> para satisfacer nuestras necesidades. Este encontrará el usuario gracias a su token de autenticación que es enviado en cada petición.</p>
</div>
<div class="paragraph">
<p>Cuando se trata de autenticación, me gusta añadir todos los métodos asociados en un archivo separado. Entonces simplemente incluimos el archivo <code>ApplicationController</code>. De este modo, es muy fácil para probar de forma aislada. Vamos a crear el archivo en el directorio <code>controllers/concerns</code> con un método <code>current_user</code> que implementaremos después:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="c1"># TODO</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces, vamos a crear un directorio <code>concerns</code> en <code>tests/controllers/</code> y un archivo <code>authenticable_test.rb</code> para nuestras pruebas de a autenticación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir test</span>/controllers/concerns
<span class="nv">$ </span><span class="nb">touch test</span>/controllers/concerns/authenticable_test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como es usual, iniciamos por escribir nuestra prueba. En este caso, nuestro método <code>current_user</code> buscará un usuario por el token de autenticación en la cabecera HTTP <code>Authorization</code>. La prueba es muy básica:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">AuthenticableTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@authentication</span> <span class="o">=</span> <span class="no">MockController</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get user from Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get user from empty Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Te estarás preguntando, "¿De donde viene el controlador <code>MockController</code>?", De hecho, éste es un <em>Mock</em>, por ejemplo una clase que imita el comportamiento de otra para probar un comportamiento</p>
</div>
<div class="paragraph">
<p>Podemos definir la clase <code>MockController</code> justo sobre nuestra prueba:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">MockController</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
  <span class="nb">attr_accessor</span> <span class="ss">:request</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="n">mock_request</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:headers</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">request</span> <span class="o">=</span> <span class="n">mock_request</span><span class="p">.</span><span class="nf">new</span><span class="p">({})</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La clase <code>MockController</code> simplemente incluye nuestro módulo <code>Authenticable</code> que probaremos. Este contiene un atributo <code>request</code> que contiene un simple <a href="https://ruby-doc.org/core-2.6.3/Struct.html"><code>Struct</code></a> que imita el comportamiento de una petición Rails conteniendo un atributo <code>headers</code> de tipo <code>Hash</code>.</p>
</div>
<div class="paragraph">
<p>Entonces podemos implementar nuestras dos pruebas ahora</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">AuthenticableTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@authentication</span> <span class="o">=</span> <span class="no">MockController</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get user from Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get user from empty Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nuestra prueba debería fallar. Así que vamos a implementar el código para que ésta pase:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">return</span> <span class="vi">@current_user</span> <span class="k">if</span> <span class="vi">@current_user</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span>
    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="nf">nil?</span>

    <span class="n">decoded</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="vi">@current_user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí tienes! Obtenemos el token desde la cabecera <code>Authorization</code> y buscamos el usuario correspondiente. Nada tan mágico.</p>
</div>
<div class="paragraph">
<p>Nuestra prueba debería pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.............
13 runs, 18 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Todo lo que tenemos que hacer es incluir el módulo <code>Authenticable</code> en la clase <code>ApplicationController</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/application_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="c1"># ...</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora es tiempo de hacer <em>commit</em>  a nuestros cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds authenticable module for managing authentication methods"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_autenticación_con_el_token">Autenticación con el token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La autorización juega un papel importante en la construcción de aplicaciones porque nos ayuda a definir que usuario tiene permisos para continuar.</p>
</div>
<div class="paragraph">
<p>Tenemos una ruta para actualizar el usuario, pero hay un problema: cualquiera puede actualizar cualquier usuario. En esta sección, vamos a implementar un método que requerirá al usuario estar logueado para prevenir accesos no autorizados.</p>
</div>
<div class="sect2">
<h3 id="_acciones_de_autorización">Acciones de autorización</h3>
<div class="paragraph">
<p>Es tiempo ahora de actualizar nuestro archivo <code>users_controller.rb</code> para negar el acceso a ciertas acciones. Vamos también a implementar el método <code>current_user</code> en las acciones <code>update</code> y <code>destroy</code> para asegurarnos que el usuario que esta logueado solo podrá actualizar sus datos y puede únicamente borrar (y solo) su cuenta.</p>
</div>
<div class="paragraph">
<p>Por lo tanto dividimos nuestra prueba en dos pruebas <em>should update user</em> y <em>should destroy user</em>.</p>
</div>
<div class="paragraph">
<p>Iniciamos por actualizar la prueba <em>should update user</em>.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
      <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">},</span>
      <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span>
      <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Puedes ver ahora que tenemos que añadir una cabecera <em>Authorization</em> para la acción de modificar usuarios. De lo contrario queremos recibir una respuesta <em>forbidden</em>.</p>
</div>
<div class="paragraph">
<p>Podemos pensar de forma similar para la prueba <em>should forbid destroy user</em>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should destroy user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid destroy user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Por el momento estas pruebas pueden fallar como ya lo podrías esperar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test test</span>/controllers/api/v1/users_controller_test.rb
..F

Failure:
Expected response to be a &lt;2XX: success&gt;, but was a &lt;403: Forbidden&gt;

..F

Failure:
<span class="s2">"User.count"</span> didn t change by <span class="nt">-1</span><span class="nb">.</span>
Expected: 0
  Actual: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>La solución es muy simple. Vamos a añadir un <code>before_action</code> el cual llamará al método <code>check_owner</code> para las acciones <code>update</code> y <code>destroy</code>. De esta forma comprobamos que el usuario que corresponde al token JWT es el mismo que el usuario que necesita ser actualizado.</p>
</div>
<div class="paragraph">
<p>Ésta es la implementación:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update destroy]</span>
  <span class="c1"># ...</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">check_owner</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Ahí tienes! La implementación es realmente simple. Es por lo tanto tiempo de hacer un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Restrict actions for unauthorized users"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter04</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_4">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>¡Yeah!, ¡lo hiciste! tienes medio camino terminado! Mantén este buen trabajo. Este capítulo fue largo y difícil pero es un gran paso a seguir para implementar un mecanismo sólido para manipular autenticación de usuarios. Incluso logramos tocar la superficie para implementar reglas simples de autenticación.</p>
</div>
<div class="paragraph">
<p>En el próximo capítulo nos enfocaremos en la personalización de las salidas JSON para el usuario con la gema <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a> y añadiremos un modelo <code>product</code> a la ecuación dando al usuario la habilidad para crear un producto y publicarlo para su venta.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter05-user-products" class="sect0">Productos de usuario</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>En el capítulo anterior, implementamos el mecanismo de autenticación que usaremos a través de la aplicación.</p>
</div>
<div class="paragraph">
<p>Por el momento tenemos una implementación del modelo <code>User</code> pero el momento de la verdad ha llegado. Vamos a personalizar la salida JSON añadir un segundo recurso: los productos del usuario. Estos son los elementos que el usuario va a comprar en la aplicación y por lo tanto enlazaremos directamente.</p>
</div>
<div class="paragraph">
<p>Si estas familiarizado con Rails, ya sabes de que estoy hablando. Pero para aquellos que no lo saben, vamos a asociar el modelo <code>User</code> con el modelo <code>Product</code> usando los metodos de <em>Active Record</em> <code>has_many</code> y <code>belongs_to</code></p>
</div>
<div class="paragraph">
<p>En este capítulo vamos a:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>construir el modelo <code>Product</code> desde cero</p>
</li>
<li>
<p>asociarlo con el usuario</p>
</li>
<li>
<p>crear las entradas necesarias asi cualquier cliente puede acceder a la información.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Puedes clonar el proyecto hasta este punto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter05</code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes que iniciemos y como es usual cuando iniciamos con nuevas características necesitaremos crear una nueva rama:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_el_modelo_producto">El modelo producto</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Primero crearemos un modelo <code>Product</code>. Entonces añadiremos validaciones y finalmente lo asociamos con el modelo <code>User. Como el modelo `User</code>, el modelo <code>Product</code> será completamente probado y será automáticamente eliminado si el usuario es eliminado.</p>
</div>
<div class="sect2">
<h3 id="_los_fundamentos_del_producto">Los fundamentos del producto</h3>
<div class="paragraph">
<p>La plantilla <code>Product</code> necesitara varios campos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un atributo <code>price</code> para el precio del producto</p>
</li>
<li>
<p>un booleano <code>published</code> para saber si el producto ya está vendido o no</p>
</li>
<li>
<p>un <code>title</code> para definir un título sexy al producto</p>
</li>
<li>
<p>un <code>user_id</code> para asociar este producto particular a un usuario</p>
<div class="literalblock">
<div class="content">
<pre>Como puedes adivinar lo generamos con el comando `rails generate`:</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model Product title:string price:decimal published:boolean user:belongs_to
Running via Spring preloader <span class="k">in </span>process 1476
      invoke  active_record
      create    db/migrate/20190608205942_create_products.rb
      create    app/models/product.rb
      invoke    test_unit
      create      <span class="nb">test</span>/models/product_test.rb
      create      <span class="nb">test</span>/fixtures/products.yml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Usamos el tipo <code>belongs_to</code> para el atributo <code>user</code>. Este es un atajo que creará una columna <code>user_id</code> de tipo <code>int</code> y entonces añade una llave foránea a el campo <code>users.id</code>. En adición, <code>user_id</code> también será definido como un <code>index</code> (índice). Esta es una buena práctica para la asociación de llaves porque esto optimiza las consultas de la base de datos. No es obligatorio, pero es altamente recomendado.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El archivo de migración debería lucir así:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190608205942_create_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:price</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">boolean</span> <span class="ss">:published</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora solo tenemos que iniciar la migración:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Una prueba debería de fallar hasta este punto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
....E

Error:
Api::V1::UsersControllerTest#test_should_destroy_user:
ActiveRecord::InvalidForeignKey: SQLite3::ConstraintException: FOREIGN KEY constraint failed

rails <span class="nb">test test</span>/controllers/api/v1/users_controller_test.rb:43</code></pre>
</div>
</div>
<div class="paragraph">
<p>Seguramente dirás:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>¿Que?, ¡Pero no he tocado los usuarios!</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Lo que he visto en el código de otros desarrolladores, cuando ellos trabajan con asociaciones, es que se olvidan de la destrucción de dependencias entre modelos. Lo que digo con esto es que si un usuario es eliminado, también lo deberían de ser los productos del usuario.</p>
</div>
<div class="paragraph">
<p>Necesitamos un usuario con uno de los productos para probar esta interacción entre modelos. Entones eliminaremos este usuario esperando que los productos desaparezcan con él. Rails ya tiene generado esto por nosotros. Echa un vistazo a el <em>fixture</em> de los productos:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">MyString</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">9.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">one</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Puedes ver que este <em>fixture</em> no usa el atributo <code>user_id</code> pero si <code>user</code>. Esto significa que el producto <code>one</code>  tendrá un atributo <code>user_id</code> correspondiente al ID de usuario <code>one</code>.</p>
</div>
<div class="paragraph">
<p>Es por lo tanto necesario especificar un borrado en cascada a fin de que sea eliminado el producto <code>one</code> cuando el usuario <code>one</code> es eliminado. Vamos empezar con la prueba unitaria:</p>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'destroy user should destroy linked product'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">destroy</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Justamente tienes que modificar el modelo <code>User</code> y especificar la relación <code>has_many</code> con la opción <code>depend: :destroy</code>. Veremos más tarde que hace este método con mas detalle.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p>Eso es todo. Ahor hacemos un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Generate product model"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validaciones_del_producto">Validaciones del producto</h3>
<div class="paragraph">
<p>Las validaciones son una parte importante cuando construimos cualquier tipo de aplicación. Esto evitará que cualquier dato basura sea guardado en la base de datos. En el producto tenemos que asegurarnos que por ejemplo el precio es un <code>number</code> (número) y que no es negativo.</p>
</div>
<div class="paragraph">
<p>También una cosa importante sobre la validación es validar que cada producto tiene un usuario. En este caso necesitamos validar la presencia del <code>user_id</code>. Puedes ver que estoy hablando en siguiente fragmento de código.</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"should have a positive price"</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">assert_not</span> <span class="n">product</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora necesitamos añadir la implementación para hacer que la prueba pase:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">},</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La prueba ahora está en verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tenemos un montón de código de buena calidad. Hagamos un commit y sigamos moviéndonos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds some validations to products"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_endpoints_de_productos">Endpoints de productos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ahora es tiempo de empezar a construir los endpoints de los productos. Por ahora solo construiremos las cinco acciones REST. En el siguiente capítulo vamos a personalizar la salida JSON implementando la gema <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>.</p>
</div>
<div class="paragraph">
<p>Primero necesitamos crear el controlador <code>products_controller</code>, y fácilmente podemos lograrlo con el comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::products
      create  app/controllers/api/v1/products_controller.rb
      invoke  test_unit
      create    <span class="nb">test</span>/controllers/api/v1/products_controller_test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>El comando anterior generará un montón de archivos que nos permitirán empezar a trabajar rápidamente. Lo que quiero decir con esto es ya generará el controlador y el archivo de prueba con un <em>scoped</em> (alcanse) hacia la versión 1 del API.</p>
</div>
<div class="paragraph">
<p>Como calentamiento iniciaremos bien y fácil construyendo la acción <code>show</code> para el producto.</p>
</div>
<div class="sect2">
<h3 id="_acción_show_para_productos">Acción show para productos</h3>
<div class="paragraph">
<p>Como es usual iniciaremos por añadir algunas especificaciones para la acción <code>show</code> para el producto en su controlador. La estrategia aquí es muy simple: justamente necesitamos crear un único producto y asegurar que la respuesta desde el server es la que esperamos.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show product"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces añadimos el código que hará pasar las pruebas:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Espera! Aun no corras las pruebas. Recuerda que necesitamos añadir el recuro al archivo <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora nos aseguramos que las pruebas están bien y en verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes notar ahora las especificaciones e implementación son muy sencillas. En realidad, se comportan igual que el usuario.</p>
</div>
</div>
<div class="sect2">
<h3 id="_listado_de_productos">Listado de productos</h3>
<div class="paragraph">
<p>Ahora es tiempo de devolver una lista de productos (los cuales serán mostrados como catálogo de productos de la tienda). Este endpoint debe ser accesible sin credenciales. Significa que no requerimos que el usuario este logueado para acceder a la información. Como es usual empezaremos escribiendo algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show products"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_products_url</span><span class="p">(),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show product"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a la implementación, la cual por ahora está siendo un método <code>index</code> simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
  <span class="c1">#...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No olvides añadir la ruta correspondiente:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ....</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Terminamos por ahora con el endopint al producto público. En la siguiente sección nos enfocaremos en la construcción de las acciones solicitando un usuario logueado para acceder a ellos. Dicho esto, haremos commit de estos cambios y continuamos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Finishes modeling the product model along with user associations"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creando_productos">Creando productos</h3>
<div class="paragraph">
<p>Crear productos es un poco más complejo porque necesitaremos una configuración adicional. La estrategia que seguiremos es asignar el producto creado al usuario que pertenece al token JWT proporcionado en la cabecera HTTP <code>Authorization</code>.</p>
</div>
<div class="paragraph">
<p>Así que iniciamos con el archivo <code>products_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should create product'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_products_url</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="ss">price: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">price</span><span class="p">,</span> <span class="ss">published: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">published</span> <span class="p">}</span> <span class="p">},</span>
           <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
           <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid create product'</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_products_url</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="ss">price: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">price</span><span class="p">,</span> <span class="ss">published: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">published</span> <span class="p">}</span> <span class="p">},</span>
           <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Wow! Añadimos un montón de código. Si recuerdas la sección anterior, las pruebas son muy similares que las de la creación de usuarios. Excepto por algunos cambios menores.</p>
</div>
<div class="paragraph">
<p>De esta forma, podemos ver al usuario y la creación del producto asociado con el. Pero espera! Hay algo mejor.</p>
</div>
<div class="paragraph">
<p>Si adoptamos este enfoque, podemos incrementar el alcance de nuestro mecanismo de autenticación. Realmente construimos la lógica para obtener al usuario logueado desde la cabecera <code>Authorization</code> y asignarle un método <code>current_user</code>. Es por lo tanto bastante fácil de configurar simplemente añadiendo la cabecera de autorización a la solicitud y recuperando el usuario desde ahí. Entonces hagamoslo.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">product_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver, protegemos la acción <code>create</code> con el método <code>check_login</code>. También creamos al producto por asociación con el usuario. Yo agregué este método tan sencillo al <em>concern</em> del archivo <code>authenticable.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="c1"># ...</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">check_login</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="nb">self</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Una última cosa antes de hacer tus pruebas: la ruta necesaria:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index create]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora las pruebas deberían pasar:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rake test
....................</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_actualizando_los_productos">Actualizando los productos</h3>
<div class="paragraph">
<p>Espero que por ahora entiendas la lógica para construir la acciones que vienen. En esta sección nos enfocaremos en la acción <code>update</code> que funcionará a la acción <code>create</code>. Solamente necesitamos buscar el producto desde la base de datos y actualizarlo.</p>
</div>
<div class="paragraph">
<p>Añadiremos primer la acción a las rutas así no nos olvidamos después:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index create update]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes de iniciar borrando alguna prueba quiero aclarar que similarmente a la acción <code>create</code> vamos a dar alcance en el producto al con el método <code>current_user</code>. En este caso queremos  asegurar que el producto que se está actualizando pertenece al usuario actual. Así que buscaremos los productos de la asociación <code>user.products</code> proveída por Rails.</p>
</div>
<div class="paragraph">
<p>Agreguemos algunas especificaciones:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should update product'</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span> <span class="p">}</span> <span class="p">},</span>
          <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid update product'</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span> <span class="p">}</span> <span class="p">},</span>
          <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Tengo añadido un <em>fixture</em> correspondiente a un segundo usuario justo para verificar que el segundo usuario no puede modificar productos del primer usuario.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Las pruebas parecen complejas, pero echa un segundo vistazo. Son casi lo mismo que construimos para los usuarios.</p>
</div>
<div class="paragraph">
<p>Ahora vamos a implementar el código para hacer pasar nuestras pruebas:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_product</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update]</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update]</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@product</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">check_owner</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">set_product</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La implementación es muy simple. Simplemente recuperaremos el producto desde el usuario conectad y simplemente lo actualizamos. Tenemos también agregadas esta acción a el <code>before_action</code> para prevenir cualquier usuario no autorizado desde la actualización de un producto.</p>
</div>
<div class="paragraph">
<p>Ahora las pruebas deberían pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_destruyendo_productos">Destruyendo productos</h3>
<div class="paragraph">
<p>Nuestra última parada para los endpoints de los productos será la acción <code>destroy</code> (destruir). Podrías ahora imaginar cómo se vería esto. La estrategia aquí será demasiado similar a las acciones <code>create</code> y <code>destroy</code>: obtenemos al usuario logueado con el token JWT y entonces buscamos el producto desde la asociación <code>user.products</code> y finalmente lo destruimos, regresamos un código <code>204</code>.</p>
</div>
<div class="paragraph">
<p>Vamos a iniciar de nuevo añadiendo el nombre de la ruta al archivo de rutas:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
      <span class="n">resources</span> <span class="ss">:products</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Después de esto, tenemos que añadir algunas pruebas como se muestra en este fragmento de código:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"should destroy product"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid destroy product"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora simplemente añadimos el código necesario para hacer pasar las pruebas:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_product</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update destroy]</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@product</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver las cuatro líneas implementadas hacen el trabajo. Podemos correr las pruebas para asegurar que todo está bien y entonces haremos un commit de los cambios ya que hemos añadido un montón de código. También asegúrate que llamas a esta acción en el callback <code>before_action</code> al igual que en la acción <code>update</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hagamos commit de los cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the products create, update and destroy actions"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_llenado_de_la_base_de_datos">Llenado de la base de datos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vamos a llenar la base de datos con información falsa antes de continuar escribiendo más código. Vamos a usar los <em>seeds</em> para hacerlo.</p>
</div>
<div class="paragraph">
<p>Con el archivo <code>db/seeds.rb</code>, Rails nos da una forma fácil y rápida para asignar valores por defecto en una nueva instalación. Este es un simple archivo de Ruby que nos da completo acceso a clases y métodos de la aplicación. Así que no necesitas meter todo manualmente con la consola de Rails sino que puedes simplemente usar el archivo <code>db/seeds.rb</code> con el comando <code>rake db:seed</code>.</p>
</div>
<div class="paragraph">
<p>Asi que vamos a iniciar creando un usuario:</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'toto@toto.fr'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'toto123'</span>
<span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora puedes crear un usuario simplemente ejecutando el siguiente comando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: toto@toto.fr</code></pre>
</div>
</div>
<div class="paragraph">
<p>Funciona. No sé tú, pero a mí me gusta tener datos ficticios para llenar correctamente mi base de datos de prueba. Solo que no siempre tengo la inspiración para dar sentido a mi archivo <em>seed</em> así que uso la gema <a href="https://github.com/stympy/faker"><code>faker</code></a>. Vamos a configurarla:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add faker</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora podemos usarla para crear cinco usuarios al mismo tiempo con diferentes emails.</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'locadex1234'</span>
  <span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y vamos a ver que pasa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: barbar@greenholt.io
Created a new user: westonpaucek@ortizbotsford.net
Created a new user: ricardo@schneider.com
Created a new user: scott@moenerdman.biz
Created a new user: chelsie@wiza.net</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí lo tienes. Pero podemos ir más lejos creando productos asociados con estos usuarios:</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">delete_all</span>
<span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>

<span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'locadex1234'</span>
  <span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>

  <span class="mi">2</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
      <span class="ss">title: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Commerce</span><span class="p">.</span><span class="nf">product_name</span><span class="p">,</span>
      <span class="ss">price: </span><span class="nb">rand</span><span class="p">(</span><span class="mf">1.0</span><span class="o">..</span><span class="mf">100.0</span><span class="p">),</span>
      <span class="ss">published: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span>
    <span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Created a brand new product: </span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí lo tienes. El resultado es asombroso. En una orden podemos crear tres usuarios y seis productos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: tova@beatty.org
Created a brand new product: Lightweight Steel Hat
Created a brand new product: Ergonomic Aluminum Lamp
Created a new user: tommyrunolfon@tremblay.biz
Created a brand new product: Durable Plastic Car
Created a brand new product: Ergonomic Leather Shirt
Created a new user: jordon@torp.io
Created a brand new product: Incredible Paper Hat
Created a brand new product: Sleek Concrete Pants</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hagamos un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Create a seed to populate database"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y como llegamos al final de nuestro capítulo, es tiempo de aplicar todas las modificaciones a la rama master haciendo un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter05</code></pre>
</div>
</div>
<div class="paragraph">
<p>I make two little comments. I also see two things to update:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>add es lang in rakefile: https://github.com/madeindjs/api_on_rails/blob/master/Rakefile#L4
upload the book on leanpubas YOUR book version and add a link https://github.com/madeindjs/api_on_rails#support-the-project (if you want it of course)
add a section "contributor" ith your name on readme: https://github.com/madeindjs/api_on_rails#license :)</pre>
</div>
</div>
<div class="paragraph">
<p>I make two little comments. I also see two things to update:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>add es lang in rakefile: https://github.com/madeindjs/api_on_rails/blob/master/Rakefile#L4
upload the book on leanpubas YOUR book version and add a link https://github.com/madeindjs/api_on_rails#support-the-project (if you want it of course)
add a section "contributor" ith your name on readme: https://github.com/madeindjs/api_on_rails#license :)</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_5">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Espero que hayas disfrutado este capítulo. Es el más largo pero el código que hicimos juntos es una excelente base para el núcleo de nuestra aplicación.</p>
</div>
<div class="paragraph">
<p>En el siguiente capítulo, nos enfocaremos en personalizar la salido de los modelos usuarios y productos usando la gema <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>. Esto nos permitirá filtrar fácilmente los atributos para mostrar y manipular asociaciones como objetos embebidos, por ejemplo.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter06-improve-json" class="sect0">Construyendo la repuesta JSON</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>En el capítulo anterior agregamos productos a la aplicación y creamos las rutas necesarias. Tenemos también asociado un producto con un usuario y restringidas algunas acciones del controlador <code>products_controller</code>.</p>
</div>
<div class="paragraph">
<p>Ahora puedes estar satisfecho con todo este trabajo. Pero todavía tenemos un montón de trabajo por hacer. Actualmente tenemos una salida JSON que no es perfecta. La salida JSON luce así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tag Case"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"98.7761933800815"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como sea buscamos una salida que no contenga los campos <code>user_id</code>, <code>created_at</code> y <code>updated_at</code>.</p>
</div>
<div class="paragraph">
<p>Una parte importante (y difícil) cuando estas creando tu API es decidir el formato de salida. Afortunadamente algunas organizaciones ya tienen encarado este tipo de problema y tienen establecidas algunas convenciones que descubrirás en este capítulo.</p>
</div>
<div class="paragraph">
<p>Puedes clonar el proyecoto hasta este punto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter06</code></pre>
</div>
</div>
<div class="paragraph">
<p>Iniciemos con una nueva rama para este capítulo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter06</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_presentación_de_jsonapi">Presentación de <a href="https://jsonapi.org/">JSON:API</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una parte importante y difícil de crear tu API es decidir el formato de salida. Afortunadamente algunas convenciones ya existen. Ciertamente las más usada es <a href="https://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>La <a href="https://jsonapi.org/format/#document-structure">documentación de JSON:API</a> nos da algunas reglas a seguir respecto al formateado del documento JSON.</p>
</div>
<div class="paragraph">
<p>En consecuencia, nuestro documento <strong>debería</strong> contener estas llaves:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: que contiene la información que devolvemos</p>
</li>
<li>
<p><code>errors</code> que contienen un arreglo de errores ocurridos</p>
</li>
<li>
<p><code>meta</code> que contiene un <a href="https://jsonapi.org/format/#document-meta">meta objeto</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El contenido de la llave <code>data</code> es demasiado estricto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>debe tener una llave de <code>type</code> correspondiente al tipo de modelo JSON (un article, un user, etc&#8230;&#8203;)</p>
</li>
<li>
<p>propiedades de los objetos deben ponerse en la llave <code>attributes</code></p>
</li>
<li>
<p>enlaces de objetos deben colocarse en una llave <code>relationships</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En este capítulo vamos a personalizar la salida JSON usando la gema de Netflix: <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>. Afortunadamente ya implementa todas las especificaciones <a href="https://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>Así que instalemos la gema <code>fast_jsonapi</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add fast_jsonapi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deberias estar listo para continuar este tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serializar_el_usuario">Serializar el usuario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FastJSON API usa <strong>serializers</strong>. Los serializadores representan clases Ruby que serán responsables de convertir un modelo en  un <a href="https://ruby-doc.org/core-2.6.3/Hash.html"><code>Hash</code></a> o un JSON.</p>
</div>
<div class="paragraph">
<p>Así que necesitamos añadir un archivo <code>user_serializer.rb</code>. Podemos hacerlo manualmente, pero la gema provee una interface de línea de comandos para hacerlo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer User email
      create  app/serializers/user_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto habrá creado un archivo llamado <code>user_serializer.rb</code> bajo la ruta <code>app/serializers</code>. El nuevo archivo debería lucir como el siguiente archivo:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:email</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este <em>serializer</em> nos permitirá convertir nuestro objeto <code>User</code> a JSON implementando todas las especificaciones JSON:API. Como especificamos <code>email</code> como <code>attributes</code> lo recibimos en un arreglo <code>data</code>.</p>
</div>
<div class="paragraph">
<p>Vamos a intentar todo esto en la consola de rails con <code>rails console</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span> <span class="p">).</span><span class="nf">serializable_hash</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:data</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:id</span><span class="o">=&gt;</span><span class="s2">"25"</span><span class="p">,</span> <span class="ss">:type</span><span class="o">=&gt;</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:attributes</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:email</span><span class="o">=&gt;</span><span class="s2">"tova@beatty.org"</span><span class="p">}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí tienes. Como puedes ver es realmente fácil. Ahora podemos usar nuestro nuevo <em>serializer</em> en nuestro <em>controller</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="c1"># ...</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿No es demasiado fácil? Como sea deberíamos tener una prueba que falla. Pruébalo por ti mismo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test

</span>Failure:
Expected: <span class="s2">"one@one.org"</span>
  Actual: nil</code></pre>
</div>
</div>
<div class="paragraph">
<p>Por alguna razón la respuesta no es lo que esperábamos. Esto es porque la gema modifica la respuesta que teníamos anteriormente definida. Así que para pasar esta prueba tenemos que modificarla:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">][</span><span class="s1">'email'</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lo hiciste ahora la prueba pasa:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Guardemos estos cambios y sigamos moviéndonos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-am</span> <span class="s2">"Adds user serializer for customizing the json output"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serializado_de_productos">Serializado de productos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ahora que entendemos cómo trabaja la gema de serialización es tiempo de personalizar la salida del producto. El primer paso es el mismo que hicimos en el capítulo previo. Necesitamos un serializador de producto. Así que hagámoslo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer Product title price published
      create  app/serializers/product_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora vamos a añadir atributos para serializar el producto:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí está. No es tan complicado. Cambiemos nuestro controlador un poco.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">product</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">).</span><span class="nf">serializable_hash</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Actualizamos nuestra prueba funcional:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show product'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">][</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si quieres puedes revisar si la prueba pasa, pero debería. Guardemos estos pequeños cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds product serializer for custom json output"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_serializar_asociaciones">Serializar asociaciones</h3>
<div class="paragraph">
<p>Hemos trabajado con serializadores y has notado que es muy simple. En algunos casos la decisión difícil es nombrar tus rutas o estructurar la salida JSON. Cuando se está trabajando con asociaciones entre modelos en la API hay muchos enfoques que puedes tomar.</p>
</div>
<div class="paragraph">
<p>No debemos preocuparnos de este problema en nuestro caso: Las especificaciones JSON:API lo hicieron por nosotros!</p>
</div>
<div class="paragraph">
<p>Para recapitular tenemos un tipo de asociación <code>has_many</code> entre usuarios y productos.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es una buena idea integrar usuario en las salidas JSON de productos. Esto hará la salida más incomoda pero prevendrá al cliente de la API ejecutar otras peticiones para recibir información del usuario relacionada a los productos. Este método realmente puede salvarte de un enorme cuello de botella.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_teoría_de_la_inyección_de_relaciones">Teoría de la inyección de relaciones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imagina un escenario donde pides a la API productos, pero en este caso tienes que mostrar alguna información del usuario.</p>
</div>
<div class="paragraph">
<p>Una posible solución podría ser añadir el atributo <code>user_id</code> a el <code>product_serializer</code> así podemos obtener el usuario correspondiente más tarde. Esto puede sonar como una buena idea, pero si estar preocupado sobre el rendimiento, o si las transacciones de la base de datos no son suficientemente rápidas, deberías reconsiderar éste enfoque. Deberías entender que de cada producto que recuperes, deberías recuperar su usuario correspondiente.</p>
</div>
<div class="paragraph">
<p>Enfrentando a este problema, tenemos varias alternativas.</p>
</div>
<div class="sect2">
<h3 id="_integrar_en_un_meta_atributo">Integrar en un meta atributo</h3>
<div class="paragraph">
<p>La primera solución (una buena en mi opinión) es integrar identificadores de usuarios enlazados a los productos un meta atributo. Así obtenemos un JSON como abajo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"user_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">

  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Así que el cliente puede recuperar estos usuarios desde <code>user_ids</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_incorporando_el_objeto_en_el_atributo">Incorporando el objeto en el atributo</h3>
<div class="paragraph">
<p>Otra solución es incorporar el objeto <code>user</code> en el objeto <code>product</code>. Esto debería hacer a la primera petición lenta, pero de esta forma el cliente no necesita hacer otra petición adicional. Un ejemplo del resultado esperado se presenta a continuación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El problema con este enfoque es que tenemos duplicados del objeto `User' para cada producto que pertenece al mismo usuario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_incorporar_las_relaciones_incluidas_en_include">Incorporar las relaciones incluidas en `include</h3>
<div class="paragraph">
<p>LA tercer solución (elegida por JSON:API) es una combinación de las primeras dos.</p>
</div>
<div class="paragraph">
<p>Incluiremos todas las relaciones en una llave <code>include</code> que contendrá todas las relaciones de los objetos previamente mencionados. También, cada objeto incluirá una llave de relación que define la relación y que debería encontrar en cada llave <code>include</code>.</p>
</div>
<div class="paragraph">
<p>Un JSON vale mas que mil palabras:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Ves la diferencia? Esta solución reduce drásticamente el tamaño del JSON y por lo tanto el ancho de banda utilizado.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aplicación_de_la_inyección_de_relaciones">Aplicación de la inyección de relaciones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Asi que incorporaremos el objeto user en el producto. Vamos a iniciar por añadir algunas pruebas.</p>
</div>
<div class="paragraph">
<p>Simplemente modificaremos la prueba <code>Products#show</code> para verificar que lo estamos recuperando:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show product'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:included</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora revisaremos tres cosas que el JSON debería retornar:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>este contiene el título del producto</p>
</li>
<li>
<p>este contiene el ID del usuario ligado al producto</p>
</li>
<li>
<p>la información del usuario esta incluida en la llave <code>include</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Deberías haber notado que decidí usar el método <a href="https://ruby-doc.org/core-2.6.3/Hash.html#method-i-dig"><code>Hash#dig</code></a>. Este es un método Ruby que permite recuperar elementos en un <em>Hash</em> anidado evitando errores si un elemento no está presente.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para pasar esta prueba iniciaremos por incluir la relación en el <em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta adición añadirá una llave <code>relationship</code> conteniendo el identificador del usuario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Durable Marble Lamp"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11.55"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
              </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto nos permite corregir nuestras primeras dos afirmaciones. Ahora queremos incluir atributos de el usuario a quien pertenezca el producto. Para hacer esto simplemente necesitamos pasar una opción <code>:include</code> al <em>serializer</em> instanciado en el controlador <em>controller</em>. Entonces hagámoslo:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí tienes. Ahora así es como debería lucir el JSON:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"staceeschultz@hahn.info"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora las pruebas deberían pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hagamos un <em>commit</em> para celebrar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add user relationship to product serializer"</span></code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="_recuperar_productos_del_usuario">Recuperar productos del usuario</h3>
<div class="paragraph">
<p>¿Entiendes el principio? tenemos incluida información del usuario en el JSON de los productos. Podemos hacer lo mismo incluyendo información del producto relacionada a un usuario para la página <code>/api/v1/users/1</code>.</p>
</div>
<div class="paragraph">
<p>Empecemos con la prueba:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:included</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:email</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y para finalizar el controlador:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:products</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahí tienes. Obtenemos un JSON como el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"staceeschultz@hahn.info"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Durable Marble Lamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11.5537474980286"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Fue realmente fácil. Hagamos un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add products relationship to user#show"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_buscando_productos">Buscando productos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta última sección continuaremos fortaleciendo la acción <code>Products#index</code> configurando un mecanismo de búsqueda muy simple permitiendo a cualquier cliente filtrar los resultados. Esta sección es opcional así que no tendrá impacto en los módulos de la aplicación. Pero si quiere practicar mas con las TDD (Test Driven Development) recomiendo que completes este último paso.</p>
</div>
<div class="paragraph">
<p>Yo uso <a href="https://github.com/activerecord-hackery/ransack">Ransack</a> ó <a href="https://github.com/casecommons/pg_search">pg_search</a> para construir formas de busqueda extremamente rápido. Pero como el objetivo es aprender y buscar vamos a hacerlo muy sencillo. Creo que podemos construir un motor de búsqueda desde cero.  Simplemente tenemos que considerar los criterios por los cuales filtraremos los atributos. Quédate en tu asiento vamos a hacer este viaje juntos.</p>
</div>
<div class="paragraph">
<p>Por lo tanto, filtraremos los productos de acuerdo a los siguientes criterios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Por título</p>
</li>
<li>
<p>Por precio</p>
</li>
<li>
<p>Acomodar por fecha de creación</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esto parece pequeño y fácil, pero créeme, esto te dará dolor de cabeza si no lo planeas.</p>
</div>
<div class="sect2">
<h3 id="_por_palabra_clave">Por palabra clave</h3>
<div class="paragraph">
<p>Crearemos un <em>scope</em> para encontrar los registros que coinciden con un patrón de caracteres en particular. Vamos a llamarlo <code>filter_by_title</code>.</p>
</div>
<div class="paragraph">
<p>Comenzaremos por añadir algunos <em>fixtures</em> con diferentes productos para probar:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">TV Plosmo Philopps</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">9999.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">one</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Azos Zeenbok</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">499.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">two</span>

<span class="na">another_tv</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Cheap TV</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">99.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">two</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora podemos construir algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should filter products by name"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'tv'</span><span class="p">).</span><span class="nf">count</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should filter products by name and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'tv'</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La siguiente prueba se asegura que el método <code>Product.filter_by_title</code> buscará correctamente los productos de acuerdo con su título. Usamos el término <code>tv</code> en minúsculas para asegurar que nuestra búsqueda no sea sensitiva a mayúsculas y minúsculas.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:filter_by_title</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">keyword</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'lower(title) LIKE ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">keyword</span><span class="p">.</span><span class="nf">downcase</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<em>scoping</em> te permite especificar las consultas comúnmente usadas que pueden ser referenciadas como llamada de método en los modelos. Con estos <em>scopes</em> puedes enlazar métodos con Active Record como <code>where</code>, <code>joins</code> y <code>includes</code> porque un <em>scope</em> siempre retorna un objeto <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a>. Te invito a que eches un vistazo en la <a href="https://guides.rubyonrails.org/active_record_querying.html#scopes_record_querying.html#scopes">documentación de Rail</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esta implementación es suficiente para que nuestras pruebas pasen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_por_precio">Por precio</h3>
<div class="paragraph">
<p>Para filtrar por precio, las cosas pueden ser un poco más delicadas. Separaremos la lógica del filtrado por precio en dos diferentes métodos: uno que buscará por productos con precio mayor al recibido y otro que busque aquellos que son menores que el precio. De esta forma, mantendremos algo de flexibilidad y podemos fácilmente probar el <em>scope</em>.</p>
</div>
<div class="paragraph">
<p>Vamos a iniciar por construir las pruebas del <em>scope</em> <code>above_or_equal_to_price</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should filter products by price and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La implementación es muy, muy sencilla:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:above_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &gt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto es suficiente para convertir nuestra prueba en verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
...........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Puedes imaginar el comportamiento del método opuesto. Aquí está la prueba:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should filter products by price lower and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>y la implementación.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:below_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &lt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para nuestros motivos, vamos a hacer la prueba y revisar que todo está hermosamente en verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
............................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver, no tuvimos muchos problemas. Vamos a añadir otro <em>scope</em> para acomodar los registros por la fecha de la última actualización. En el caso cuando el propietario de los productos decide actualizar alguna información seguramente buscará acomodar sus productos por la fecha de creación.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ordenas_por_fecha_de_creación">Ordenas por fecha de creación</h3>
<div class="paragraph">
<p>Este <em>scope</em> es muy fácil. Vamos a añadir algunas pruebas primero:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should sort product by most recent'</span> <span class="k">do</span>
    <span class="c1"># we will touch some products to update them</span>
    <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">touch</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">recent</span><span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y la implementación:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span>
    <span class="n">order</span><span class="p">(</span><span class="ss">:updated_at</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Todas nuestras pruebas deberían de pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.............................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a guardar nuestros cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search scopes on the product model"</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_motor_de_búsqueda">Motor de búsqueda</h4>
<div class="paragraph">
<p>Ahora que tenemos lo básico para el motor de búsqueda que usaremos en nuestra aplicación, es tiempo para implementar un simple pero poderoso método de búsqueda. Este gestionará toda la lógica para recuperar los registros de los productos.</p>
</div>
<div class="paragraph">
<p>El método consistirá en enlazar todos los <code>scope</code> que creamos anteriormente y retornar el resultado. Comencemos añadiendo algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'search should not find "videogame" and "100" as min price'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'videogame'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">100</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">).</span><span class="nf">empty?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'search should find cheap TV'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'tv'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">max_price: </span><span class="mi">150</span> <span class="p">}</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get all products when no parameters'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span><span class="p">,</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">({})</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'search should filter by product ids'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Añadimos un montón de código, pero te aseguro que la implementación es muy fácil. Tú puedes ir más lejos y añadir pruebas adicionales pero, en mi caso, no lo encontré necesario.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">].</span><span class="nf">present?</span> <span class="p">?</span> <span class="no">Product</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">])</span> <span class="p">:</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>

    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">])</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">recent</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:recent</span><span class="p">]</span>

    <span class="n">products</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es importante notar que retornamos los productos como un objeto <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a> así que podemos concatenar otros métodos si es necesario o paginarlos como veremos en los últimos capítulos. Simplemente actualizar la acción para recuperar los productos desde el método de búsqueda:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos correr la suit completa de pruebas para asegurar que la aplicación está en buen estado hasta aquí:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.................................
33 runs, 49 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Guardemos todos estos cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search class method to filter products"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y como estamos en el vinal de nuestro capítulo, es tiempo de aplicar todas nuestras modificaciones a la rama master haciendo un <code>merge</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter06</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_6">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora fue fácil gracias a la gema <a href="https://github.com/Netflix/fast_jsonapi_jsonapi">fast_jsonapi</a>. En el próximo capítulo vamos a iniciar con la construcción del modelo <code>Order</code> (orden) que implicará usuarios en los productos.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter07-placing-orders" class="sect0">Colocando órdenes</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>En el capítulo previo manejamos asociaciones entre productos y usuarios y como serializarlos a fin de escalar rápido y fácil. Ahora es tiempo de empezar a implementar las ordenes lo cual será una situación algo más compleja. Manejaremos asociaciones entre estos tres modelos. Debemos ser lo suficientemente inteligentes para manejar la salida JSON que estamos entregando.</p>
</div>
<div class="paragraph">
<p>En este capítulo haremos algunas cosas que están listadas a continuación:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear un modelo <code>Order</code> con sus correspondientes especificaciones</p>
</li>
<li>
<p>Manipular la salida JSON con asociación entre los modelos orden de usuario y producto</p>
</li>
<li>
<p>Enviar un mail de confirmación con el resumen de la orden</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Entonces ahora todo está claro podemos ensuciarnos las manos. Puedes clonar el proyecto hasta este punto con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter07</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creemos una rama para empezar a trabajar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modelando_la_orden">Modelando la orden</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si recuerdas asociaciones de modelos, el modelo <code>Order</code> esta asociado con usuarios y productos al mismo tiempo. Actualmente esto es muy simple de lograr en Rails. La parte difícil es cuando vamos a serializar estos objetos. Hablare más sobre esto en la siguiente sección.</p>
</div>
<div class="paragraph">
<p>Vamos a empezar creando el modelo <code>order</code> con una forma especial:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model order user:belongs_to total:decimal</code></pre>
</div>
</div>
<div class="paragraph">
<p>El comando anterior generará el modelo order pero estoy tomando ventaja del método <code>references</code> para crear la llave foránea correspondiente para que la orden pertenezca a el usuario. Esto también añade la directiva <code>belongs_to</code> dentro del modelo. Vamos a migrar la base de datos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora es tiempo para escribir algunas pruebas dentro del archivo`order_test.rb`:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s1">'Should have a positive total'</span> <span class="k">do</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">assert_not</span> <span class="n">order</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La implementación es demasiado simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No olvides añadir la relación <code>orders</code> a nuestros usuarios especificando el borrado en cascada:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Las pruebas deberían pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..................................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y hacemos <em>commit</em> de todo esto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Generate orders"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_ordenes_y_productos">Ordenes y productos</h3>
<div class="paragraph">
<p>Necesitamos configurar la asociación entre la <code>order</code> y el <code>product</code> y esto se hace con una asociación <strong>has-many-to-many</strong>. Como muchos productos pueden ser puestos en muchas ordenes y las ordenes puede tener múltiples productos. Así en este caso necesitamos un modelo intermedio el cual unirá estos otros dos objetos y mapeará las asociaciones apropiadas.</p>
</div>
<div class="paragraph">
<p>Vamos a genera este modelo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model placement order:belongs_to product:belongs_to</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a correr la migración en la base de datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>La implementación es como:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si has estado siguiendo el tutorial para la implementación , esta ya está lista debido a las <code>references</code> (referencias) que forman parte del comando generador del modelo. Podríamos añadir la opción <code>inverse_of</code> a el modelo <code>placement</code> para cada llamada <code>belongs_to</code>. Esto da un pequeño impulso cuando referenciamos al objeto padre.</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span>
  <span class="n">belongs_to</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">inverse_of: :placements</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a correr las pruebas de los <em>modelos</em> y asegurar que todo es verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..................................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora que todo está bien y en verde vamos a hacer commit de los cambios y continuar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Associates products and orders with a placements model"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exponer_el_modelo_usuario">Exponer el modelo usuario</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Es tiempo de poner en orden el controlador para exponer las ordenes correctas. Si recuerdas el capítulo previo donde <a href="https://github.com/Netflix/fast_jsonapi_jsonapi">fast_jsonapi</a> fue usada, deberías recordar que fue realmente fácil.</p>
</div>
<div class="paragraph">
<p>Vamos a definir primero que acciones tomará:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Una acción de indexación para recuperar las ordenes de usuario actuales</p>
</li>
<li>
<p>Una acción show para recuperar un comando particular desde el usuario actual</p>
</li>
<li>
<p>Una acción de creación para generar la orden</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vamos a iniciar con la acción <code>index</code>. Primero tenemos el comando para crear el controlador:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta este punto y antes de empezar a escribir algo de código tenemos que preguntarnos a nosotros mismos:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>¿Debería dejar mis enpoints de ordenes anidado dentro de <code>UserController</code> o debería aislarlas?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>La respuesta es realmente simple: esto depende de la carga o información que quieras exponer al desarrollador.</p>
</div>
<div class="paragraph">
<p>En nuestro caso, no haremos esto porque recuperaremos los comandos del usuario desde la ruta <code>/orders</code>. Vamos a iniciar con algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid orders for unlogged'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span>
      <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
      <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">].</span><span class="nf">count</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si corremos la suit de pruebas ahora ambas pruebas deberían de fallar como ya esperábamos. Esto es porque estas no tienen establecidas las rutas o acciones correctas. Iniciemos añadiendo las rutas:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">]</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora es tiempo para implementar la serialización de las ordenes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer Order</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y vamos a añadir relaciones:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora es tiempo de implementar el controlador:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index]</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora todas nuestras pruebas deberían de pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
....................................
36 runs, 53 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos gustan que nuestros commits sean muy atómicos, así que vamos a guardar estos cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds the index action for order"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_renderizar_una_sola_orden">Renderizar una sola orden</h3>
<div class="paragraph">
<p>Como ahora puedes imaginar esta ruta es muy fácil. Únicamente hacemos algunas configuraciones (rutas, acción de controlador) y esta sección estará terminada. También incluiremos productos relacionados a esta orden en la salida JSON.</p>
</div>
<div class="paragraph">
<p>Vamos a iniciar añadiendo algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show order'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_order_url</span><span class="p">(</span><span class="vi">@order</span><span class="p">),</span>
        <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
        <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">include_product_attr</span> <span class="o">=</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'included'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">]</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">include_product_attr</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver, la segunda parte de la prueba verifica que el producto está incluido en el JSON.</p>
</div>
<div class="paragraph">
<p>Vamos añadir la implementación para correr nuestras pruebas. En el archivo <code>routes.rb</code> añadimos la acción <code>show</code> a las rutas de comando:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y la implementación debería lucir como esto:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show]</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">order</span>
      <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:products</span><span class="p">]</span> <span class="p">}</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="mi">404</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nuestras pruebas deberían estar todas verdes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.....................................
37 runs, 55 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a hacer commit de los cambios y parar a crear la acción de crear orden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the show action for order"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_colocando_y_ordenando">Colocando y ordenando</h3>
<div class="paragraph">
<p>Es tiempo ahora de dar la oportunidad de colocar algunas órdenes. Esto añadirá complejidad a la aplicación, pero no te preocupes, vamos a hacer cada cosa en su tiempo.</p>
</div>
<div class="paragraph">
<p>Antes de implementar esta característica, tomare tiempo para pensar sobre la implicación de crear un comando en la aplicación. No estoy hablando sobre configurar un servicio de transacción como el de <a href="https://stripe.com/">Stripe</a> ó <a href="https://www.braintreepayments.com/">Braintree</a> pero algo como:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>gestionamiento de productos out-of-stock (fuera de stock)</p>
</li>
<li>
<p>reducir el inventario del producto</p>
</li>
<li>
<p>añadir alguna validación para el colocamiento de ordenes para asegurar que hay los suficientes productos al momento de colocar la orden</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Parece que aún hay mucho por hacer pero créeme: estar más cerca de lo que piensas y no es tan difícil como parece. Por ahora mantengámoslo simple y asumamos que aún tendremos suficientes productos para colocar cualquier número de órdenes. Solo estamos preocupados sobre la respuesta del servidor por el momento.</p>
</div>
<div class="paragraph">
<p>Si tu recuerdas el modelo de orden, necesitamos tres cosas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un total para la orden</p>
</li>
<li>
<p>usuario que coloca la orden</p>
</li>
<li>
<p>productos para la orden</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Basado en esta información podemos empezar añadiendo algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="vi">@order_params</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">order: </span><span class="p">{</span>
      <span class="ss">product_ids: </span><span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">],</span>
      <span class="ss">total: </span><span class="mi">50</span>
    <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should forbid create order for unlogged'</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should create order with two products'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span>
        <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
        <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver estamos crean una variable <code>order_params</code> con los datos de la orden. ¿Puedes ver el problema aquí? Si no, lo explicare más tarde. Justamente añadimos el código necesario para hacer pasar la prueba.</p>
</div>
<div class="paragraph">
<p>Primero necesitamos añadir la acción a los recursos en el archivo de rutas:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show create]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces la implementación es fácil:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show create]</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:total</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora nuestras pruebas deberian estar en verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.......................................
39 runs, 59 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, entonces tenemos todo correcto y en verde. Ahora deberíamos movernos al siguiente capitulo, ¿correcto? Déjame detenerte justo aquí. Tenemos algunos errores serios en la aplicación, y estos no están relacionados al código por sí mismo, pero si en la parte del negocio.</p>
</div>
<div class="paragraph">
<p>No porque los las pruebas estén verdes, esto significa que la aplicación esta cubriendo la parte del negocio. Quería traer esto aquí porque en muchos casos es super fácil solo recibir parámetros y construir objetos desde esos parámetros pensando que siempre estamos recibiendo los datos correctos. En este caso particular no podemos confiar en eso, y la forma fácil de ver esto, es que le estamos dando al cliente la oportunidad de poner el total, ¡que locura!</p>
</div>
<div class="paragraph">
<p>Tenemos que añadir algunas validaciones o un callback para calcular el total de la orden y colocarlo entre el modelo. De esta forma ya no recibiremos más el atributo del total y asi tener el control total sobre este atributo. Vamos a hacer esto:</p>
</div>
<div class="paragraph">
<p>Primer necesitamos algunas especificaciones a el modelo de la orden:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@product1</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@product2</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'Should set total'</span> <span class="k">do</span>
    <span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span> <span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">products</span> <span class="o">&lt;&lt;</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">products</span> <span class="o">&lt;&lt;</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">save</span>

    <span class="n">assert_equal</span> <span class="p">(</span><span class="vi">@product1</span><span class="p">.</span><span class="nf">price</span> <span class="o">+</span> <span class="vi">@product2</span><span class="p">.</span><span class="nf">price</span><span class="p">),</span> <span class="n">order</span><span class="p">.</span><span class="nf">total</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora podemos añadir la implementación:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora podemos incluir el método <code>set_total!</code> a un callback <code>before_validation</code> para asegurar que tiene el total correcto antes de ser validado.</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_validation</span> <span class="ss">:set_total!</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta este punto nos aseguramos que el total está siempre presente y es mayor o igual a cero. Esto significa que podemos quitar esas validaciones y quitar las especificaciones. Esperaré. Nuestras pruebas deberían pasar por ahora:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

...........F

Failure:
OrderTest#test_Should_have_a_positive_total <span class="o">[</span>/home/arousseau/github/madeindjs/market_place_api/test/models/order_test.rb:14]:
Expected <span class="nb">true </span>to be nil or <span class="nb">false


</span>rails <span class="nb">test test</span>/models/order_test.rb:11

............................

Finished <span class="k">in </span>0.542600s, 73.7191 runs/s, 110.5786 assertions/s.</code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Oops! Obtuvimos un <em>failure</em> (falla) en nuestra anterior prueba <em>Should have a positive total</em>. Es lógico desde que el total de la orden es calculado dinámicamente. Así que podemos simplemente quitar esta prueba que ha quedado obsoleta.</p>
</div>
<div class="paragraph">
<p>Nuestra prueba debería pasar. Guardemos nuestros cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the create method for the orders controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enviar_email_de_confirmación_de_la_orden">Enviar email de confirmación de la orden</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La última sección para este capítulo es para enviar el mail de confirmación al usuario que ordenó. Si quiere saltar esta parte e ir al siguiente capítulo hazlo. Esta sección es más como un calentamiento.</p>
</div>
<div class="paragraph">
<p>Tal vez estas familiarizado con la manipulación de emails con Rails así que intentaremos hacer esto fácil y rápido. Primero creamos el <code>order_mailer</code> con un email llamado <code>send_confirmation</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate mailer order_mailer send_confirmation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora agregamos algunas pruebas para los correos de la orden que acabamos de crear:</p>
</div>
<div class="listingblock">
<div class="title">test/mailers/order_mailer_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be set to be delivered to the user from the order passed in"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Order Confirmation"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s1">'no-reply@marketplace.com'</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_match</span> <span class="s2">"Order: #</span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
    <span class="n">assert_match</span> <span class="s2">"You ordered </span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2"> products"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Yo simplemente copie/pegue las pruebas desde la documentación y las adapte a nuestras necesidades. Ahora nos aseguramos que estas pruebas pasan.</p>
</div>
<div class="paragraph">
<p>Primero, añadimos el método <code>OrderMailer#send_confirmation</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/mailers/order_mailer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s1">'no-reply@marketplace.com'</span>
  <span class="k">def</span> <span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span>
    <span class="n">mail</span> <span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s1">'Order Confirmation'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Después de añadir este código añadimos las vistas correspondientes. Es una buena práctica incluir un texto de la versión como extra a la versión HTML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;%# app/views/order_mailer/send_confirmation.text.erb %&gt;</span>
Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span>
You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:
<span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;!-- app/views/order_mailer/send_confirmation.html.erb --&gt;</span>
<span class="nt">&lt;h1&gt;</span>Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora, nuestra prueba debería pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 66 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora, solo llamamos al método <code>OrderMailer#send_confirmation</code> en la acción de crear en el controlador de la orden:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para asegurar que no rompimos nada, vamos a correr todas las pruebas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 66 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hagamos commit a todo para ya que está completa esta sección:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds order confirmation mailer"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y como hemos llegado al final de nuestro capítulo, es tiempo de aplicar todas nuestras modificaciones a la rama master haciendo un `merge':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_7">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>¡Eso es! ¡Lo hiciste! Puedes aplaudirte. Se que fue un largo tiempo pero créeme estas casi terminando.</p>
</div>
<div class="paragraph">
<p>En siguientes capítulos continuaremos trabajando en la plantilla de la orden y añadir validaciones cuando se hace una orden. Algunos escenarios son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Que pasa cuando los productos no están disponibles?</p>
</li>
<li>
<p>Reducir la cantidad de los productos en progreso cuando se está ordenando</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El siguiente capítulo será corto, pero es muy importante para la salud de la aplicación. así que no te lo saltes.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter08-improve_orders" class="sect0">Mejorando las ordenes</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>En el capítulo anterior extendimos nuestra API para ordenar y enviar email de confirmación al usuario (solo para mejorar la experiencia del usuario). Este capítulo cuida algunas validaciones en el modelo de la orden, solo para asegurarse que se puede ordenar, algo como:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reducir la cantidad del producto actual cuando se genera una orden</p>
</li>
<li>
<p>¿Que pasa cuando no hay productos disponibles?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Probablemente necesitaremos actualiza un poco la salida JSON para las ordenes, pero no estropeemos las cosas.</p>
</div>
<div class="paragraph">
<p>Asi que ahora que tenemos todo claro podemos ensuciarnos las manos. Puedes clonar el proyecto hasta este punto con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="n">tags</span><span class="o">/</span><span class="n">checkpoint_chapter08</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a crear una rama para empezar a trabajar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">chapter08</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_decrementando_la_cantidad_del_producto">Decrementando la cantidad del producto</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta primera parada vamos a trabajar en la actualización de la cantidad de producto para asegurar que cada pedido entregue la orden real.
Actualmente el modelo <code>product</code> no tiene un atributo <code>quantity</code>. Así que vamos a hacer eso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_products quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Espera, no corras las migraciones ahora. Le haremos unas pequeñas modificaciones. Como una buena práctica me gusta añadir los valores por defecto a la base de datos solo para asegurarme que no me equivoco con valores <code>null</code>. ¡Este es un caso perfecto!</p>
</div>
<div class="paragraph">
<p>Tu archivo de migración debería lucir como esto:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190621105101_add_quantity_to_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora podemos migrar la base de datos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y no olvidemos actualizar los <em>fixtures</em> añadiendo el campo <strong>quantity</strong> (Yo elegí el valor <code>5</code> de manera aleatoria).</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">one</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">another_tv</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="s">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es tiempo ahora de reducir la cantidad de productos mientras una <code>Orden</code> está siendo procesada. La primera cosa probablemente que viene a la mente es hacerlo en el modelo <code>Order</code>. Esto es un misterio común.</p>
</div>
<div class="paragraph">
<p>Cuando trabajas con asociaciones <em>Many-to-Many</em> (muchos a muchos), nos olvidamos completamente del modelo de unión que en este caso es <code>Placement</code>. <code>Placement</code> es el mejor lugar para gestionar esto porque tiene accesos la orden y al producto. De esta forma, podemos fácilmente reducir el stock del producto.</p>
</div>
<div class="paragraph">
<p>Antes de empezar a implementar código, necesitamos cambiar la forma que manipulamos la creación de ordenes porque ahora tenemos que aceptar la cantidad para cada producto. Si recuerdas estamos esperando por una tabla de identificadores de producto. Intentaré mantener las cosas simples y enviar una tabla Hash con las llaves <code>product_id</code> y <code>quantity</code>.</p>
</div>
<div class="paragraph">
<p>Un ejemplo rápido podria ser algo como esto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">product_ids_and_quantities</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="ss">product_id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">4</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">product_id: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">5</span> <span class="p">}</span>
<span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto se pondrá difícil pero quédate conmigo. Vamos primero a construir algunas pruebas:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'builds 2 placements for the order'</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span> <span class="p">[</span>
      <span class="p">{</span> <span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span> <span class="p">},</span>
      <span class="p">{</span> <span class="ss">product_id: </span><span class="vi">@product2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span> <span class="p">},</span>
    <span class="p">]</span>

    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Placement.count'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@order</span><span class="p">.</span><span class="nf">save</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces en la implementación:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>

  <span class="c1"># @param product_ids_and_quantities [Array&lt;Hash&gt;] something like this `[{product_id: 1, quantity: 2}]`</span>
  <span class="c1"># @yield [Placement] placements build</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="n">placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:product_id</span><span class="p">])</span>
      <span class="k">yield</span> <span class="n">placement</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>+
Y si corremos nuestras pruebas, deberían estar bien y en verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 60 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo que es <code>build_placements_with_product_ids_and_quantities</code> hará la colocación de objetos y luego ejecutará el método <code>save</code> para la ordenar todo será insertada en la base de datos. Un último paso antes de guardar esto es actualizar la prueba <code>orders_controller_test</code> junto con esta implementación.</p>
</div>
<div class="paragraph">
<p>Primero actualizamos el archivo <code>orders_controller_test</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@order_params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">order: </span><span class="p">{</span>
        <span class="ss">product_ids_and_quantities: </span><span class="p">[</span>
          <span class="p">{</span> <span class="ss">product_id: </span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span> <span class="p">},</span>
          <span class="p">{</span> <span class="ss">product_id: </span><span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span> <span class="p">},</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should create order with two products and placements'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Placement.count'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span> <span class="ss">as: :json</span>
            <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces necesitamos actualizar <code>orders_controller</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">user: </span><span class="n">current_user</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">order_params</span><span class="p">[</span><span class="ss">:product_ids_and_quantities</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">product_ids_and_quantities: </span><span class="p">[</span><span class="ss">:product_id</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nota que también modifique el método <code>OrdersController#order_params</code>.</p>
</div>
<div class="paragraph">
<p>Por último, pero no menos importante, necesitamos actualizar el archivo que fabrica productos para asignar un valor alto de cantidad para tener algunos productos en stock.</p>
</div>
<div class="paragraph">
<p>Hagamos commit de estos cambios y continuemos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Allows the order to be placed along with product quantity"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¿Notaste que no estamos guardando la cantidad por cada producto en ningún lado? Esta no es la forma de darle seguimiento. Esto puede ser reparado fácilmente. Solo añadamos un atributo <code>quantity</code> a el modelo <code>Placement</code>. De este modo para cada producto guardaremos su cantidad correspondiente. Vamos a iniciar creando la migración:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_placements quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como con el atributo para la cantidad del producto deberíamos añadir un valor por defecto igual a 0. Recuerda que esto es opcional, pero me gusta este enfoque. El archivo de migración debería lucir así:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190621114614_add_quantity_to_placements.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToPlacements</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Entonces corre las migraciones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora agregamos el atributo <code>quantity</code> en los <em>fixtures</em>:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/placements.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">one</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="s">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora solo necesitamos actualizar la prueba <code>build_placements_with_product_ids_and_quantities</code> para añadir <code>quantity</code> para hacer los pedidos:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>

  <span class="c1"># @param product_ids_and_quantities [Array&lt;Hash&gt;] something like this `[{product_id: 1, quantity: 2}]`</span>
  <span class="c1"># @yield [Placement] placements build</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="n">placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span>
        <span class="ss">product_id: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:product_id</span><span class="p">],</span>
        <span class="ss">quantity: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:quantity</span><span class="p">],</span>
      <span class="p">)</span>
      <span class="k">yield</span> <span class="n">placement</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora nuestras pruebas deberían pasar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 61 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a guardar los cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds quantity to placements"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_entendiendo_el_modelo_placement">Entendiendo el modelo Placement</h3>
<div class="paragraph">
<p>Es tiempo de actualizar la cantidad del producto cada que la orden es guardada, o más exacto cada que el placement (colocación) es creado. A fin de lograr esto vamos a añadir un método y entonces conectarlo con el callback <code>after_create</code>.</p>
</div>
<div class="listingblock">
<div class="title">test/models/placement_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">PlacementTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'decreases the product quantity by the placement quantity'</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="vi">@placement</span><span class="p">.</span><span class="nf">product</span>

    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'product.quantity'</span><span class="p">,</span> <span class="o">-</span><span class="vi">@placement</span><span class="p">.</span><span class="nf">quantity</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@placement</span><span class="p">.</span><span class="nf">decrement_product_quantity!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La implementación es bastante fácil como se muestra a continuación:</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">after_create</span> <span class="ss">:decrement_product_quantity!</span>

  <span class="k">def</span> <span class="nf">decrement_product_quantity!</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">decrement!</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hagamos <em>commit</em> a nuestros cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Decreases the product quantity by the placement quantity"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validar_la_cantidad_de_productos">Validar la cantidad de productos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Desde el comienzo del capítulo, tenemos añadido el atributo <code>quantity</code> a el modelo del producto. Es ahora tiempo para validar si la cantidad de producto es suficiente para conciliar la orden. A fin de que hagamos las cosas más interesantes, vamos a hacer usando un validador personalizado.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
puedes consultar <a href="https://guides.rubyonrails.org/active_record_validations.html#performing-custom-validations">la documentación</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Primero necesitamos añadir un directorio <code>validators</code> en el directorio <code>app</code> (Rails lo incluirá por lo que no necesitamos preocuparnos de cargarlo).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/validators
<span class="nv">$ </span><span class="nb">touch </span>app/validators/enough_products_validator.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes que borremos cualquier línea de código, necesitamos asegurarnos de añadir especificaciones a el modelo <code>Order</code> para revisar si la orden puede ser realizada.</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"an order should command not too much product than available"</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">&lt;&lt;</span> <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="vi">@product1</span><span class="p">.</span><span class="nf">quantity</span><span class="p">))</span>

    <span class="n">assert_not</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como puedes ver en la especificación, primero nos aseguramos que <code>placement_2</code> este tratando de pedir mas productos de los que están disponibles, así que en este caso suponemos que la <code>order</code> (orden) no es válida.</p>
</div>
<div class="paragraph">
<p>La prueba por ahora debería fallar, vamos a convertirla en verde añadiendo el código del validador:</p>
</div>
<div class="listingblock">
<div class="title">app/validators/enough_products_validator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">EnoughProductsValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="n">record</span><span class="p">.</span><span class="nf">placements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span>
      <span class="n">product</span> <span class="o">=</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span>
      <span class="k">if</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">&gt;</span> <span class="n">product</span><span class="p">.</span><span class="nf">quantity</span>
        <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"Is out of stock, just </span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">quantity</span><span class="si">}</span><span class="s2"> left"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Manipulo para añadir el mensaje a cada uno de los producto que están fuera de stock, pero puede manejarlo diferente si quieres. Ahora solamente necesito añadir el validador al modelo <code>Order</code> de esta forma:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>
  <span class="c1"># ...</span>
  <span class="n">validates_with</span> <span class="no">EnoughProductsValidator</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Guardemos los cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds validator for order with not enough products on stock"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_actualizando_el_total">Actualizando el total</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Notaste que el <code>total</code> está siendo calculado incorrectamente, porque actualmente este está añadiendo el precio para los productos en la orden independientemente de la cantidad solicitada. Déjame añadir el código para aclarar el problema:</p>
</div>
<div class="paragraph">
<p>Actualmente en el modelo <code>order</code> tenemos este método para calcular el monto a pagar:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora en lugar de calcular el <code>total</code> solo añadiendo el precio del producto necesitamos multiplicarlo por la cantidad. Así que vamos a actualizar las especificaciones primero:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"Should set total"</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">=</span> <span class="p">[</span>
      <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span><span class="p">),</span>
      <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">set_total!</span>
    <span class="n">expected_total</span> <span class="o">=</span> <span class="p">(</span><span class="vi">@product1</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="vi">@product2</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">assert_equal</span> <span class="n">expected_total</span><span class="p">,</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y la implementación es muy sencilla:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">placements</span>
                     <span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span> <span class="p">}</span>
                     <span class="p">.</span><span class="nf">sum</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y las especificaciones deberían ser verdes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 63 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a guardar los cambios:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Updates the total calculation for order"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y así es como llegamos al final de nuestro capítulo, es tiempo de aplicar todas nuestras modificaciones a la rama master haciendo un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter08</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_8">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>¡Oh, ahi tienes! ¡Déjame felicitarte! Es un largo camino desde el primer capítulo. Pero estas un paso más cerca, De hecho, el próximo capítulo será el último. Así que trata de aprovecharlo al máximo.</p>
</div>
<div class="paragraph">
<p>El último capítulo se enfocará en la forma de optimizar la API usando paginado, caché y tareas en segundo plano. Así que abróchate el cinturón, va a ser un viaje agitado.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter09-optimization" class="sect0">Optimizaciones</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Bienvenido a el último capítulo de este libro. Ha sido un largo camino, pero estas solo a un paso del final. En el capítulo anterior, completamos el modelado del modelo de la orden. Podríamos decir que el proyecto está finalizado, pero quiero cubrir algunos detalles importantes sobre la optimización. Los temas que discutiremos serán:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>paginación</p>
</li>
<li>
<p>caché</p>
</li>
<li>
<p>optimización de las consultas SQL</p>
</li>
<li>
<p>la activación de CORS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Trataré de ir tan lejos como pueda intentando cubrir algunos escenarios comunes. Espero que estos escenarios sean útiles para algunos de tus proyectos.</p>
</div>
<div class="paragraph">
<p>Si tu empiezas leyendo hasta este punto, probablemente quieras el código, puedes clonarlo con esto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter09</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora vamos a crear una rama para empezar a trabajar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_paginación">Paginación</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una estrategia muy común para optimizar un arreglo de registros desde la base de datos, es cargar solo algunos paginándolos y si tu estas familiarizado con esta técnica sabes que en Rails es realimente fácil lograrlos sobre todo si estas usando <a href="https://github.com/mislav/will_paginate">will_paginate</a> ó <a href="https://github.com/amatsuda/kaminari">kaminari</a>.</p>
</div>
<div class="paragraph">
<p>Entonces solo la parte difícil aquí es como suponemos manipular la salida JSON dando la suficiente información al cliente sobre como esta paginado el arreglo. Si recuerdas el primer capítulo compartí algunos recursos y prácticas que iba a seguir aquí. Una de ellas fue <a href="http://jsonapi.org/" class="bare">http://jsonapi.org/</a> que es una página de mis favoritas.</p>
</div>
<div class="paragraph">
<p>Si leemos la sección de formato encontraremos una sub sección llamada <a href="http://jsonapi.org/format/#document-structure-top-level">Top Level</a> y en algunas palabras se mencionan algunas cosas sobre paginación:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>"meta": meta-información sobre un recurso, como la paginación.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Esto no es muy descriptivo pero al menos tenemos una pista de que buscar después sobre la implementación de la paginación, pero no te preocupes que es exactamente a donde estamos yendo ahora.</p>
</div>
<div class="paragraph">
<p>Comencemos con la lista de <code>products</code>.</p>
</div>
<div class="sect2">
<h3 id="_productos">Productos</h3>
<div class="paragraph">
<p>Estamos iniciando bien y fácil paginando la lista de producto ya que no tenemos ningún tipo de restricción de acceso que nos lleve a pruebas más fáciles.</p>
</div>
<div class="paragraph">
<p>Primero necesitamos añadir la gema <a href="https://github.com/amatsuda/kaminari">kaminari</a> a nuestro <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add kaminari</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora podemos ir a la acción <code>index</code> en el controlador <code>products_controller</code> y añadir los métodos de paginación como se señala en la documentación:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">])</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta ahora la única cosa que cambio es la consulta a la base de datos que justamente limita el resultado a 25 por página que es el valor por defecto. Pero no tenemos añadida información extra a la salida JSON.</p>
</div>
<div class="paragraph">
<p>Necesitamos proveer la información de paginación en el tag <code>meta</code> de la siguiente forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"first"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"last"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=30"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"prev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora tenemos la estructura final para el tag <code>meta</code> que necesitamos en la salida de la repuesta JSON. Vamos primer a añadir algunas especificaciones-:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show products'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_products_url</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La prueba que acabamos de añadir debería fallar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................F

Failure:
Api::V1::ProductsControllerTest#test_should_show_products <span class="o">[</span><span class="nb">test</span>/controllers/api/v1/products_controller_test.rb:13]:
Expected nil to not be nil.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vamos a añadir información de paginación. Construiremos una parte de esto en <em>concerns</em> para fragmentar mejor nuestro código:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/paginable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># app/controllers/concerns/paginable.rb</span>
<span class="k">module</span> <span class="nn">Paginable</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">current_page</span>
    <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]</span> <span class="o">||</span> <span class="mi">1</span><span class="p">).</span><span class="nf">to_i</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">per_page</span>
    <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">]</span> <span class="o">||</span> <span class="mi">20</span><span class="p">).</span><span class="nf">to_i</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora podemos usarlo en el controlador.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora, si revisamos las especificaciones, estos deberían pasar todos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 65 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora tenemos echa una super optimización para la ruta de lista de productos, depende del cliente para recuperar el parámetro de la <code>page</code> (página) para los registros.</p>
</div>
<div class="paragraph">
<p>Vamos a hacer estos cambios y continuar con la lista de comandos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds pagination for the products index action to optimize response"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lista_de_ordenes">Lista de ordenes</h3>
<div class="paragraph">
<p>Ahora es tiempo de hacer exactamente lo mismo para el enpoint de la lista de <code>orders</code> que debería ser realmente fácil de implementar. Pero primero vamos a añadir algunas especificaciones al archivo <code>orders_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">].</span><span class="nf">count</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como ya deberías saber, nuestras pruebas no estarán pasando:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................................F

Failure:
Api::V1::OrdersControllerTest#test_should_show_orders <span class="o">[</span><span class="nb">test</span>/controllers/api/v1/orders_controller_test.rb:28]:
Expected nil to not be nil.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cambiemos el rojo en verde:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
                          <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                          <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@orders</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora todas las pruebas deberían pasar bien y en verde:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 67 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hagamos un commit, por que se viene una refactorización:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds pagination for orders index action"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactorizando_la_paginación">Refactorizando la paginación</h3>
<div class="paragraph">
<p>Si tú has seguido este tutorial o si tienes experiencia previa como desarrollador Rails, probablemente te guste mantener las cosas SECAS. Es posible que hayas notado que el código que acabamos de escribir está duplicado. Pienso que es un buen hábito hacer limpieza del código un poco cuando la funcionalidad esta implementada.</p>
</div>
<div class="paragraph">
<p>Primero limpiaremos estas pruebas que duplicamos en los archivos <code>orders_controller_test.rb</code> y <code>products_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para factorizarlo, vamos a mover estas afirmaciones a el archivo <code>test_helper.rb</code> en un método que usaremos:</p>
</div>
<div class="listingblock">
<div class="title">test/test_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">assert_json_response_is_paginated</span> <span class="n">json_response</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este método puede ahora ser usado para remplazar las cuatro afirmaciones en los archivos <code>orders_controller_test.rb</code> y <code>products_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_json_response_is_paginated</span> <span class="n">json_response</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show products'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_json_response_is_paginated</span> <span class="n">json_response</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ambas especificaciones deberían pasar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 71 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora tenemos terminado esta simple refactorización para las pruebas, podemos movernos a la implementación de la paginación para los controladores y limpiar cosas. Si tu recuerdas la acción de indexación para ambos controladores producto y orden, ambos tienen el mismo formato de paginación. Así que vamos a mover esta lógica dentro de un método llamado <code>get_links_serializer_options</code> en el archivo <code>paginable.rb</code>, así podemos acceder a el desde cualquier controlador que necesite paginación.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/paginable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Paginable</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">get_links_serializer_options</span> <span class="n">links_paths</span><span class="p">,</span> <span class="n">collection</span>
    <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Y ahora podemos sustituir el hash de paginación en ambos controladores para el método. Justo así:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
                          <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                          <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_orders_path'</span><span class="p">,</span> <span class="vi">@orders</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@orders</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si corres las especificaciones para cada archivo deberían estar todas bien y verdes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 71 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Este debería ser un buen momento para hacer un <em>commit</em> a los cambios y movernos a la siguiente sección sobre el caché:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Factorize pagination"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_almacenamiento_en_cache_del_api">Almacenamiento en cache del API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Actualmente esta es una implementación para almacenar en caché la gema <code>fast_jsonapi</code> que es realmente fácil de manipular. A pesar de que en la última versión de la gema, esta implementación puede cambiar, esta hace el trabajo.</p>
</div>
<div class="paragraph">
<p>Si hacemos una petición a la lista de productos, notaremos que el tiempo de respuesta toma cerca de 174 milisegundos usando cURL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/api/v1/products
Total: 0,137088</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
La opción <code>-w</code> nos permite recuperar el tiempo de petición, <code>-o</code> redirecciona la respuesta a un archivo y <code>-s</code> esconde la pantalla de cURL
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>¡Añadiendo solo una línea a la clase <code>ProductSerializer</code>, veremos un significante incremento en el tiempo de respuesta!</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">enabled: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">cache_length: </span><span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">enabled: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">cache_length: </span><span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">enabled: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">cache_length: </span><span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Y esto es todo! Vamos a revisar la mejora:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/api/v1/products
Total: 0,054786
<span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/api/v1/products
Total: 0,032341</code></pre>
</div>
</div>
<div class="paragraph">
<p>Así que fuimos de 174 ms a 21 ms. ¡La mejora por lo tanto es enorme! Vamos a guardar nuestros cambios una última vez:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">am</span> <span class="s2">"Adds caching for the serializers"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_consultas_n1">Consultas N+1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consultas N+1* son una herida donde podemos tener un enrome impacto en el rendimiento de una aplicación. Este fenómeno a menudo ocurre cuando usamos <strong>ORM</strong> porque este genera <strong>automáticamente</strong> consultas SQL por nosotros. Esta herramienta tan practica es de doble filo porque puede genera un <strong>largo número</strong> de consultas SQL.</p>
</div>
<div class="paragraph">
<p>Algo que debemos saber sobre las consultas SQL es que es mejor limitar su número. En otras palabras, una repuesta larga es a menudo más eficiente que cientos de pequeñas.</p>
</div>
<div class="paragraph">
<p>Aquí está un ejemplo cuando queremos recuperar todos los usuarios que ya tiene un producto creado. Abre la consola de Rails con <code>rails console</code> y ejecuta el siguiente código Ruby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="n">product</span><span class="p">.</span><span class="nf">user</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La consola interactiva de rails nos muestra consultas SQL que son generadas. Mira por ti mismo:</p>
</div>
<div class="paragraph">
<p>Vemos aquí que un largo número de peticiones son generadas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Product.all</code> = 1 petición para recuperar los productos</p>
</li>
<li>
<p><code>product.user</code> = 1 petición <code>SELECT "users".* FROM "users" WHERE "users". "id" =? LIMIT 1 [[[["id", 1]]]</code> por producto recuperado</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por lo tanto el nombre "petición N+1" es ya que una solicitud se realiza a través de un enlace secundario.</p>
</div>
<div class="paragraph">
<p>Podemos arreglar esto simplemente usando <code>includes</code>. <code>Includes</code> <strong>pre-cargará</strong> los objetos secundarios en una simple petición. Es muy fácil de usar. Si repetimos el ejemplo anterior. Este es el resultado:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="n">product</span><span class="p">.</span><span class="nf">user</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La consola interactiva de Rails nos muestra las consultas SQL que son generadas. Mira por ti mismo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">Product</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"products"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"products"</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span> <span class="p">[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">29</span><span class="p">],</span> <span class="p">[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">30</span><span class="p">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails crea una segunda petición que recuperará <strong>todos</strong> los usuarios a la vez.</p>
</div>
<div class="sect2">
<h3 id="_prevencion_de_peticiones_n_1">Prevencion de peticiones N + 1</h3>
<div class="paragraph">
<p>Imagina que queremos añadir propietarios de los productos a la ruta <code>/products</code>. Ya hemos visto que con la librería <code>fast_jsonapi</code> es muy fácil de hacer esto:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="c1"># ...</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:user</span><span class="p">]</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora vamos a hacer ua petición con cURL. Te recuerdo que nosotros debimos obtener un token de autenticación antes de acceder a la pagina.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">--data</span> <span class="s2">"user[email]=ockymarvin@jacobi.co"</span> <span class="nt">--data</span> <span class="s2">"user[password]=locadex1234"</span>  http://localhost:3000/api/v1/tokens</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
"<a href="mailto:ockymarvin@jacobi.co">ockymarvin@jacobi.co</a>" corresponde a un usurio creado en mi aplicación con el <em>seed</em>. En tu caso, probablemente fue diferente del mío desde que usamos la librería Faker.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Con la ayuda de el token obtenido, ahora podemos hacer una petición para acceder a los productos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">--header</span> <span class="s2">"Authorization=ey..."</span> http://localhost:3000/api/v1/products</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lo más probable es que veas varias respuestas en la consola Rails corriendo el servidor web.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">Started</span> <span class="k">GET</span> <span class="nv">"/api/v1/products"</span> <span class="k">for</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="k">at</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">13</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">19</span> <span class="o">+</span><span class="mi">0200</span>
<span class="n">Processing</span> <span class="k">by</span> <span class="n">Api</span><span class="p">::</span><span class="n">V1</span><span class="p">::</span><span class="n">ProductsController</span><span class="o">#</span><span class="k">index</span> <span class="k">as</span> <span class="n">JSON</span>
   <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="nv">"products"</span>
  <span class="err">↳</span> <span class="n">app</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">concerns</span><span class="o">/</span><span class="n">paginable</span><span class="p">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="k">in</span> <span class="nv">`get_links_serializer_options'
  Product Load (0.2ms)  SELECT "products".* FROM "products" LIMIT ? OFFSET ?  [["LIMIT", 20], ["OFFSET", 0]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `</span><span class="k">index</span><span class="s1">'
  User Load (0.1ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `index'</span>
   <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"products"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">FROM</span> <span class="nv">"products"</span> <span class="k">WHERE</span> <span class="nv">"products"</span><span class="p">.</span><span class="nv">"user_id"</span> <span class="o">=</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"user_id"</span><span class="p">,</span> <span class="mi">36</span><span class="p">]]</span>
  <span class="err">↳</span> <span class="n">app</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">products_controller</span><span class="p">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="k">in</span> <span class="nv">`index'
  CACHE User Load (0.0ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `</span><span class="k">index</span><span class="s1">'
  CACHE User Load (0.0ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `index'</span>
  <span class="k">CACHE</span> <span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">36</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es por lo tanto desafortunadamente <strong>muy fácil</strong> para crear consultas N+1. Afortunadamentes, esta es una gema que nos permite <strong>alertar</strong> cuando este tipo de situación ocurre: <a href="https://github.com/flyerhzm/bullet">Bullet</a>. Bullet nos notificará (por correo, <a href="http://growl.info/">growl notification</a>, <a href="https://slack.com">Slack</a>, consola, etc&#8230;&#8203;) cuando encuentra una petición N+1.</p>
</div>
<div class="paragraph">
<p>Para instalarla, vamos añadir la <em>gema</em> al <em>GemFile</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add bullet <span class="nt">--group</span> development</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y eso es suficiente para actualizar la configuración de nuestra aplicación para el entorno de desarrollo. En nuestro caso solo activaremos el modo <code>rails_logger</code> el cual será mostrado:</p>
</div>
<div class="listingblock">
<div class="title">config/environments/development.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="k">do</span>
    <span class="no">Bullet</span><span class="p">.</span><span class="nf">enable</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="no">Bullet</span><span class="p">.</span><span class="nf">rails_logger</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Reinicia el servidor web y reinicia la última petición con cURL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">--header</span> <span class="s2">"Authorization=ey..."</span> http://localhost:3000/api/v1/products</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y mira en la consola de Rails. Bullet nos dice que tiene justamente una petición N+1 detectada.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>GET /api/v1/products
USE eager loading detected
  Product =&gt; [:user]
  Add to your finder: :includes =&gt; [:user]</pre>
</div>
</div>
<div class="paragraph">
<p>Incluso nos dice como corregirla:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">&gt; Add to your search engine</dt>
<dd>
<p>includes &#8658; [: user]</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Asi que corregimos nuestro error en el controlador:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:user</span><span class="p">]</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Ahí tienes! Es tiempo de hacer nuestro <em>commit</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add bullet to avoid N+1 query"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_activación_de_cors">Activación de CORS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En esta última sección, te hablaré sobre un último problema que probablemente encontraste si tú has trabajado con tu propia API.</p>
</div>
<div class="paragraph">
<p>Cuando haces una petición a un sitio externo (por ejemplo una petición vía AJAX), encontraras un error de este tipo:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Failed to load <a href="https://example.com/" class="bare">https://example.com/</a> No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin "https://anfo.pl" is therefore not allowed access. If an opaque response serves your needs, set the request&#8217;s mode to "no-cors" to fetch the resource with CORS disabled.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>"¿Pero que significa <em>Access-Control-Allow-Origin</em>?". El comportamiento que observas es el efecto de la implementación CORS del navegador. Antes de la estandarización de CORS, no había forma de llamar a una terminal de API bajo otro dominio por razones de seguridad. Esto ha sido (y todavía es hasta cierto punto) bloqueado por la política de el mismo origen.</p>
</div>
<div class="paragraph">
<p>CORS es un mecanismo que tiene como objetivo permitir peticione echas en su nombre y al mismo tiempo bloque algunas petición echa de modo deshonesto por scripts y se activa cuando haces una petición HTTP a:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un diferente campo</p>
</li>
<li>
<p>un diferente sub-dominio</p>
</li>
<li>
<p>un diferente puerto</p>
</li>
<li>
<p>un diferente protocolo</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos a habilitar manualmente esta característica para que cualquier cliente puede hacer peticiones a nuestra API.</p>
</div>
<div class="paragraph">
<p>Rails nos permite hacerlo esto fácilmente. Mira el archivo <code>cors.rb</code> localizado en el directorio <code>initializers</code>.</p>
</div>
<div class="listingblock">
<div class="title">config/initializers/cors.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>

<span class="c1"># Rails.application.config.middleware.insert_before 0, Rack::Cors do</span>
<span class="c1">#   allow do</span>
<span class="c1">#     origins 'example.com'</span>
<span class="c1">#</span>
<span class="c1">#     resource '*',</span>
<span class="c1">#       headers: :any,</span>
<span class="c1">#       methods: [:get, :post, :put, :patch, :delete, :options, :head]</span>
<span class="c1">#   end</span>
<span class="c1"># end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ves. Es suficiente con quitar los comentarios del código y modificar un poco para limitar el acceso a algunos acciones o algunos verbos HTTP. En nuestro caso, esta configuración es muy conveniente para nosotros en este momento.</p>
</div>
<div class="listingblock">
<div class="title">config/initializers/cors.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cors</span> <span class="k">do</span>
  <span class="n">allow</span> <span class="k">do</span>
    <span class="n">origins</span> <span class="s1">'example.com'</span>
    <span class="n">resource</span> <span class="s1">'*'</span><span class="p">,</span>
      <span class="ss">headers: :any</span><span class="p">,</span>
      <span class="ss">methods: </span><span class="p">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:put</span><span class="p">,</span> <span class="ss">:patch</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:options</span><span class="p">,</span> <span class="ss">:head</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Debemos instalar la gema <code>rack-cors</code> que esta comentada en el <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add rack-cors</code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Ahí tienes! Es tiempo de hacer nuestro último commit y fusionar nuestros cambios en la rama master.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Activate CORS"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusión_9">Conclusión</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si llegaste hasta este punto, eso significa que terminaste el libro. ¡Buen trabajo! Te has convertido en un gran desarrollador API en Rails, tenlo por seguro.</p>
</div>
<div class="paragraph">
<p>Así que juntos hemos construido una API sólida y completa. Esta tiene todas las cualidades para destronar a <a href="https://www.amazon.com/">Amazon</a>, esta seguro. Te agradezco por ir a través de esta gran aventura conmigo, Espero que disfrutaras el viaje tanto como yo lo hice.</p>
</div>
<div class="paragraph">
<p>Me gustaría recordarte que el código fuente para este libro esta disponible en el formato <a href="https://asciidoctor.org">Asciidoctor</a> en <a href="https://github.com/asciidoctor/asciidoctor">GitHub</a>. Así que no dudes en <a href="https://github.com/madeindjs/api_on_rails">forkear</a> el proyecto si quieres mejorarlo o corregir algún error que no vi.</p>
</div>
<div class="paragraph">
<p>Si te gusta este libro, no vaciles en hacérmelo saber por correo <a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a>. Estoy abierto cualquier crítica, buena o mala, junto a una buena cerveza :).</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 6.9<br>
Last updated 2021-01-17 13:56:45 +0100
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>