<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="description" content="Apprenez les meilleurs pratiques pour construire une API avec Node.js et Typescript">
<meta name="keywords" content="Node.js, API, Javascript, Typescript, Software">
<meta name="author" content="Alexandre Rousseau">
<meta name="copyright" content="CC-BY-SA 4.0">
<title>REST-API.ts</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="book">
<div id="header">
<h1>REST-API.ts</h1>
<div class="details">
<span id="author" class="author">Alexandre Rousseau</span><br>
<span id="email" class="email"><a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a></span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2021-01-17</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#chapter00-before">Avant-propos</a>
<ul class="sectlevel1">
<li><a href="#_a_propos_de_lauteur_original">A propos de l’auteur original</a></li>
<li><a href="#_droits_dauteur_et_licence">Droits d’auteur et licence</a></li>
<li><a href="#_merci">Merci</a></li>
</ul>
</li>
<li><a href="#chapter01-introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#_conventions_sur_ce_livre">Conventions sur ce livre</a></li>
<li><a href="#_environnements_de_développement">Environnements de développement</a>
<ul class="sectlevel2">
<li><a href="#_éditeurs_de_texte_et_terminal">Éditeurs de texte et Terminal</a></li>
<li><a href="#_navigateur_web">Navigateur web</a></li>
<li><a href="#_gestionnaire_de_paquets">Gestionnaire de paquets</a></li>
<li><a href="#_git">Git</a></li>
<li><a href="#_node_js">Node.js</a></li>
<li><a href="#_initialisation_de_lapplication">Initialisation de l&#8217;application</a></li>
<li><a href="#_contrôle_de_version">Contrôle de version</a></li>
<li><a href="#_initialisation_de_npm">Initialisation de NPM</a></li>
<li><a href="#_mise_en_place_de_typescript">Mise en place de Typescript</a></li>
</ul>
</li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter02-api">L’API</a>
<ul class="sectlevel1">
<li><a href="#_planification_de_lapplication">Planification de l’application</a></li>
<li><a href="#_mettre_en_place_lapi">Mettre en place l’API</a></li>
<li><a href="#_initialisation_de_lapplication_2">Initialisation de l&#8217;application</a>
<ul class="sectlevel2">
<li><a href="#_linjection_de_dépendance">L&#8217;injection de dépendance</a></li>
<li><a href="#_création_dun_contrôleur">Création d&#8217;un contrôleur</a></li>
</ul>
</li>
<li><a href="#_conclusion_2">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter03-presenting-users">Présentation des utilisateurs</a>
<ul class="sectlevel1">
<li><a href="#_mise_en_place_de_typeorm">Mise en place de TypeORM</a></li>
<li><a href="#_création_du_contrôleur_des_utilisateurs">Création du contrôleur des utilisateurs</a>
<ul class="sectlevel2">
<li><a href="#_lister_les_utilisateurs">Lister les utilisateurs</a></li>
<li><a href="#_create">Create</a></li>
<li><a href="#_show">Show</a></li>
<li><a href="#_update">Update</a></li>
<li><a href="#_delete">Delete</a></li>
</ul>
</li>
<li><a href="#_validation_de_nos_utilisateurs">Validation de nos utilisateurs</a></li>
<li><a href="#_factorisation">Factorisation</a></li>
<li><a href="#_hashage_du_mot_de_passe">Hashage du mot de passe</a>
<ul class="sectlevel2">
<li><a href="#_la_théorie">La théorie</a></li>
<li><a href="#_limplémentation">L&#8217;implémentation</a></li>
<li><a href="#_mise_en_place_dun_test_unitaire">Mise en place d&#8217;un test unitaire</a></li>
</ul>
</li>
<li><a href="#_ajout_des_tests_fonctionnels">Ajout des tests fonctionnels</a></li>
<li><a href="#_conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter04-authentification">Authentification des utilisateurs</a>
<ul class="sectlevel1">
<li><a href="#_sessions_sans_état">Sessions sans état</a></li>
<li><a href="#_présentation_de_json_web_token">Présentation de JSON Web Token</a></li>
<li><a href="#_mise_en_place_du_jeton_dauthentification">Mise en place du jeton d’authentification</a></li>
<li><a href="#_le_contrôleur_de_jetons">Le contrôleur de jetons</a>
<ul class="sectlevel2">
<li><a href="#_mise_en_place_du_tests_fonctionnel">Mise en place du tests fonctionnel</a></li>
<li><a href="#_implémentation">Implémentation</a></li>
</ul>
</li>
<li><a href="#_utilisateur_connecté">Utilisateur connecté</a>
<ul class="sectlevel2">
<li><a href="#_mise_en_place_du_test_fonctionnel">Mise en place du test fonctionnel</a></li>
<li><a href="#_création_du_middleware">Création du <em>middleware</em></a></li>
<li><a href="#_utilisation_du_middleware">Utilisation du middleware</a></li>
</ul>
</li>
<li><a href="#_conclusion_4">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter05-user-products">Produits des utilisateurs</a>
<ul class="sectlevel1">
<li><a href="#_le_modèle_du_produit">Le modèle du produit</a>
<ul class="sectlevel2">
<li><a href="#_les_fondements_du_produit">Les fondements du produit</a></li>
<li><a href="#_validations_des_produits">Validations des produits</a></li>
</ul>
</li>
<li><a href="#_point_dentrée_pour_nos_produits">Point d’entrée pour nos produits</a>
<ul class="sectlevel2">
<li><a href="#_action_daffichage_dun_produit">Action d’affichage d’un produit</a></li>
<li><a href="#_liste_des_produits">Liste des produits</a></li>
<li><a href="#_création_des_produits">Création des produits</a></li>
<li><a href="#_mise_à_jour_des_produits">Mise à jour des produits</a></li>
<li><a href="#_suppression_des_produits">Suppression des produits</a></li>
</ul>
</li>
<li><a href="#_essai_avec_curl">Essai avec cURL</a></li>
<li><a href="#_conclusion_5">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter06-improve-json">Modélisation du JSON</a>
<ul class="sectlevel1">
<li><a href="#_présentation_de_jsonapi">Présentation de JSON:API</a></li>
<li><a href="#_sérialiser_lutilisateur">Sérialiser l’utilisateur</a></li>
<li><a href="#_sérialiser_les_produits">Sérialiser les produits</a>
<ul class="sectlevel2">
<li><a href="#_sérialiser_les_associations">Sérialiser les associations</a></li>
</ul>
</li>
<li><a href="#_théorie_de_linjection_des_relations">Théorie de l&#8217;injection des relations</a>
<ul class="sectlevel2">
<li><a href="#_intégrer_dans_un_attribut_meta">Intégrer dans un attribut meta</a></li>
<li><a href="#_incorporer_lobjet_dans_lattribut">Incorporer l&#8217;objet dans l&#8217;attribut</a></li>
<li><a href="#_incorporer_les_relation_dans_include">Incorporer les relation dans <code>include</code></a></li>
</ul>
</li>
<li><a href="#_application_de_linjection_des_relations">Application de l&#8217;injection des relations</a>
<ul class="sectlevel2">
<li><a href="#_récupérer_lutilisateur_dun_produit">Récupérer l&#8217;utilisateur d&#8217;un produit</a></li>
</ul>
</li>
<li><a href="#_rechercher_les_produits">Rechercher les produits</a>
<ul class="sectlevel2">
<li><a href="#_les_produits_publiés">Les produits publiés</a></li>
<li><a href="#_par_titre">Par titre</a></li>
<li><a href="#_par_prix">Par prix</a></li>
<li><a href="#_intégration_dans_le_contrôleur">Intégration dans le contrôleur</a></li>
</ul>
</li>
<li><a href="#_conclusion_6">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter07-placing-orders">Création des commandes</a>
<ul class="sectlevel1">
<li><a href="#_modélisation_de_la_commande">Modélisation de la commande</a>
<ul class="sectlevel2">
<li><a href="#_les_commandes_et_les_produits">Les commandes et les produits</a></li>
</ul>
</li>
<li><a href="#_exposer_le_modèle_dutilisateur">Exposer le modèle d’utilisateur</a>
<ul class="sectlevel2">
<li><a href="#_afficher_une_seule_commande">Afficher une seule commande</a></li>
<li><a href="#_placement_et_commandes">Placement et commandes</a></li>
</ul>
</li>
<li><a href="#_envoyer_un_email_de_confirmation">Envoyer un email de confirmation</a></li>
<li><a href="#_conclusion_7">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter08-improve_orders">Améliorer les commandes</a>
<ul class="sectlevel1">
<li><a href="#_diminution_de_la_quantité_de_produit">Diminution de la quantité de produit</a>
<ul class="sectlevel2">
<li><a href="#_ajout_de_lattribut_product_total">Ajout de l&#8217;attribut <code>product.total</code></a></li>
<li><a href="#_mise_en_place_du_test_fonctionnel_2">Mise en place du test fonctionnel</a></li>
<li><a href="#_le_subscriber">Le <em>subscriber</em></a></li>
<li><a href="#_mise_à_jour_du_coup_total_de_la_commande">Mise à jour du coup total de la commande</a></li>
</ul>
</li>
<li><a href="#_conclusion_8">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter09-optimization">Optimisations</a>
<ul class="sectlevel1">
<li><a href="#_pagination">Pagination</a>
<ul class="sectlevel2">
<li><a href="#_les_produits">Les produits</a></li>
<li><a href="#_liste_des_commandes">Liste des commandes</a></li>
</ul>
</li>
<li><a href="#_mise_en_cache">Mise en cache</a></li>
<li><a href="#_activation_des_cors">Activation des CORS</a></li>
<li><a href="#_conclusion_9">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="chapter00-before" class="sect0">Avant-propos</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>"REST-API.ts" est une adaptation de mon précédent livre <a href="https://leanpub.com/apionrails6">API on Rails</a> dans lequel je construisait une API avec le framework Ruby on Rails. Ce livre est une de mes belle expérience Open-Source puisque le livre est très actif et compte <a href="https://github.com/madeindjs/api_on_rails/graphs/contributors">compte plusieurs contributeurs</a> (que je remercie encore ici). J&#8217;ai aussi eu beaucoup de retours positifs. J&#8217;ai donc décidé de retenter l&#8217;expérience avec des technologies différentes que Ruby on Rails que j&#8217;apprécie beaucoup.</p>
</div>
<div class="paragraph">
<p>Je souhaite donc que ce livre soit vivant et évolue en suivant les meilleurs pratiques du moment. Je souhaite aussi qu&#8217;il soit un point d&#8217;entrée aux débutant comme d&#8217;autres ressources l&#8217;ont été pour moi lorsque j&#8217;ai débuté dans le développement.</p>
</div>
<div class="paragraph">
<p>Ce livre est donc tout naturellement Open-Source et en accès libre <a href="https://github.com/madeindjs/rest-api.ts">sur Github</a>. Vous y trouverez les version PDF, EPUB et aussi les sources au format <a href="https://asciidoctor.org">Asciidoctor</a>. Une version payante est disponible sur <a href="https://leanpub.com/rest-api-ts">leanpub</a> si vous souhaitez contribuer au projet. Bien sûr, ce n&#8217;est pas la seule façon de le faire, vous pouvez aussi proposer des améliorations en <a href="https://github.com/madeindjs/rest-api.ts/fork">forkant</a> le projet, parler de ce livre autour de vous ou simplement me remercier par mail à <a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_propos_de_lauteur_original">A propos de l’auteur original</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Je m&#8217;appelle <a href="https://rsseau.fr">Alexandre Rousseau</a> et je suis un développeur passionné. J&#8217;aime partager mon expérience à travers <a href="https://rsseau.fr/blog/">mon blog</a>] et certains livre comme <a href="https://leanpub.com/apionrails6-fr">API on Rails</a> ou même celui-ci.</p>
</div>
<div class="paragraph">
<p>Je suis actuellement associé chez <a href="https://isignif.fr/">iSignif</a>] où je construis et maintiens un produit de type SAAS en utilisant <a href="https://rubyonrails.org">Ruby on Rails</a>. Je contribue aussi à la communauté Ruby en produisant et maintenant quelques gemmes que vous pouvez consulter sur <a href="https://rubygems.org/profiles/madeindjs">mon profil Rubygem</a>. La plupart de mes projets sont sur GitHub donc n’hésitez pas <a href="https://github.com/madeindjs">à me suivre</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_droits_dauteur_et_licence">Droits d’auteur et licence</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"REST-API.ts" de <a href="https://rsseau.fr">Alexandre Rousseau</a>] est mis à disposition selon les termes de la licence <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution - Partage dans les Mêmes Conditions 4.0 International</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_merci">Merci</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un grand merci à <a href="https://github.com/madeindjs/rest-api.ts/graphs/contributors">tous les contributeurs de API on Rails</a>, à tous ceux qui ont supporté le projet en <a href="https://leanpub.com/rest-api-ts">achetant une version payante de ce livre</a> et aux <a href="https://github.com/madeindjs/rest-api.ts/graphs/contributors">tous les contributeurs de API on Rails</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter01-introduction" class="sect0">Introduction</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Bienvenue sur API-REST.ts, un tutoriel sous stéroïdes pour apprendre la meilleure façon de construire votre prochaine application avec Typescript. Le but de ce livre est de vous fournir une méthodologie complète pour développer une API RESTful en suivant les meilleures pratiques.</p>
</div>
<div class="paragraph">
<p>Lorsque vous en aurez fini avec ce livre, vous serez en mesure de créer votre propre API et de l’intégrer à n’importe quel client comme un navigateur Web ou une application mobile. Le code généré est construit avec Typescript 4 qui est la version actuelle.</p>
</div>
<div class="paragraph">
<p>L’intention de ce livre n’est pas seulement de vous apprendre à construire une API mais plutôt de vous apprendre comment construire une API évolutive et maintenable avec Typescript. Dans ce voyage, vous allez apprendre à:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utiliser Git pour le contrôle de version</p>
</li>
<li>
<p>Construire des réponses JSON</p>
</li>
<li>
<p>Tester vos points d’entrées avec des tests unitaires et fonctionnels</p>
</li>
<li>
<p>Mettre en place une authentification avec des JSON Web Tokens (JWT)</p>
</li>
<li>
<p>Utiliser les spécifications JSON:API</p>
</li>
<li>
<p>Optimiser et mettre en cache l’API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Je vous recommande fortement de suivre toutes les étapes de ce livre. Essayez de ne pas sauter des chapitres car je vais vous proposer des conseils et des astuces pour vous améliorer tout au long du livre. Vous pouvez vous considérer comme le personnage principal d’un jeu vidéo qui obtient un niveau supérieur à chaque chapitre.</p>
</div>
<div class="paragraph">
<p>Dans ce premier chapitre je vous expliquerai comment configurer votre environnement (au cas où vous ne l’auriez pas déjà fait). Nous allons ensuite créer une application appelée =market_place=. Je veillerai à vous enseigner les meilleures pratiques que j’ai pu apprendre au cours de mon expérience. Cela signifie qu’après avoir initialisé le projet, nous commencerons à utiliser Git.</p>
</div>
<div class="paragraph">
<p>Dans les prochains chapitres, nous allons construire l’application en suivant une méthode de travail simple que j’utilise quotidiennement. Nous développerons toute l’application en utilisant le développement dirigé par les tests (TDD). Je vous expliquerai aussi l’intérêt d’utiliser une API pour votre prochain projet et de choisir un format de réponse adapté comme le JSON ou le XML. Plus loin, nous mettrons les mains dans le code et nous compléterons les bases de l’application en construisant toutes les routes nécessaires. Nous sécuriserons aussi l’accès à l’API en construisant une authentification par échange d’en-têtes HTTP. Enfin, dans le dernier chapitre, nous ajouterons quelques techniques d’optimisation pour améliorer la structure et les temps de réponse du serveur.</p>
</div>
<div class="paragraph">
<p>L’application finale sera une application de place de marché qui permettra à des vendeurs de mettre en place leur propre boutique en ligne. Les utilisateurs seront en mesure de passer des commandes, télécharger des produits et plus encore. Il existe de nombreuses options pour créer une boutique en ligne comme <a href="http://shopify.com/">Shopify</a>, <a href="http://spreecommerce.com/">Spree</a> ou <a href="http://magento.com/">Magento</a>.</p>
</div>
<div class="paragraph">
<p>Tout au long de ce voyage (cela dépend de votre expertise), vous allez vous améliorer et être en mesure de mieux comprendre le fonctionnement des frameworks modernes. J’ai aussi pris certaines des pratiques de mon expérience de développeur.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conventions_sur_ce_livre">Conventions sur ce livre</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les conventions de ce livre sont basées sur celles du <a href="https://www.railstutorial.org/book">Tutoriel Ruby on Rails</a>. Dans cette section, je vais en mentionner quelques-unes que vous ne connaissez peut-être pas.</p>
</div>
<div class="paragraph">
<p>Je vais utiliser de nombreux exemples en utilisant des ligne de commande. Je ne vais pas traiter avec Windows <code>cmd</code> (désolé les gars). Je vais baser tous les exemples en utilisant l’invite de ligne de commande de style Unix. Voici un exemple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"A command-line command"</span>
A command-line <span class="nb">command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>J&#8217;éssaierai de raccourcir au maximum les morceaux de code en ne gardant que lignes intéressantes en fonction de contexte. Je masquerai les lignes non pertinentes avec le symbole commentaire <code>// &#8230;&#8203;</code> ou <code>/* &#8230;&#8203; */</code>. Je spécifierai aussi, au début de chaque morceau de code, le chemin et le nom du fichier concerné. Voici un exemple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// user.ts</span>
<span class="c1">// ...</span>
<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">doInterestingStuff</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="nx">doInterestingStuff</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>J’utiliserai quelques principes comme:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>"Éviter"</em> signifie que vous n’êtes pas censé le faire.</p>
</li>
<li>
<p><em>"Préférer"</em> indique que parmi les deux options, la première est la plus appropriée.</p>
</li>
<li>
<p><em>"Utiliser"</em> signifie que vous êtes en mesure d’utiliser la ressource.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si vous rencontrez une erreur quelconque lors de l’exécution d’une commande, je vous recommande d’utiliser votre moteur de recherche pour trouver votre solution. Malheureusement, je ne peux pas couvrir toutes les erreurs possibles. Si vous rencontrez des problèmes avec ce tutoriel, vous pouvez toujours <a href="mailto:contact@rousseau-alexandre.fr">m’envoyer un email</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_environnements_de_développement">Environnements de développement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour presque tous les développeurs, l’une des parties les plus douloureuses est de mettre en place un environnement de développement confortable. Si vous le faites correctement, les prochaines étapes devraient être un jeu d’enfant. Je vais vous guider dans cette étape afin de vous faciliter la tâche et de vous motiver.</p>
</div>
<div class="sect2">
<h3 id="_éditeurs_de_texte_et_terminal">Éditeurs de texte et Terminal</h3>
<div class="paragraph">
<p>Il existe deux catégories d&#8217;éditeurs de code :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les <strong>éditeurs de textes</strong> comme <a href="https://atom.io/">Atom</a>, <a href="https://www.sublimetext.com/">Sublime Text</a>, <a href="https://www.vim.org/">VIM</a> et bien d&#8217;autres.</p>
</li>
<li>
<p>les <strong>environnements de développement</strong> complets comme <a href="https://www.eclipse.org/">Eclipse</a>, <a href="https://netbeans.org/">Netbeans</a>], <a href="https://www.jetbrains.com/fr-fr/webstorm/">Webstorm</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Les environnement de développement sont plus complets et offre plus de fonctionnalités mais sont souvent beaucoup plus lourds.</p>
</div>
<div class="paragraph">
<p>Il n&#8217;y a pas de mauvais choix et c&#8217;est vraiment une question de gout.</p>
</div>
<div class="paragraph">
<p>Pour ma part j&#8217;utilise <a href="https://code.visualstudio.com/">Visual Studio Code</a> de Microsoft que se situe à mis chemin entre un éditeur de texte et un environnement de développement. Son auto-complétion est vraiment très performante lorsqu&#8217;on utilise <a href="https://www.typescriptlang.org/">Typescript</a>]. Si vous ne savez pas quoi utiliser, vous ne pouvez pas vous tromper en utilisant cet éditeur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_navigateur_web">Navigateur web</h3>
<div class="paragraph">
<p>Quand au navigateur, je conseillerai directement <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a>. Mais d’autres développeurs utilisent <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> ou même <a href="https://www.apple.com/safari/">Safari</a>. N’importe lequel d’entre eux vous aidera à construire l’application que vous voulez. Ils proposent tous un bon inspecteur pour le DOM, un analyseur de réseau et de nombreuses autres fonctionnalités que vous connaissez peut-être déjà.</p>
</div>
<div class="paragraph">
<p>Je vous conseille néanmoins d&#8217;utiliser au moins deux navigateurs web. Il y a quelques nuances sur l&#8217;intérprétation du Javascript ou du CSS. En utilisant deux navigateurs vous vous assurez que vos développements fonctionnent correctement pour la majorité de vos utilisateurs.</p>
</div>
<div class="paragraph">
<p>Personnellement j&#8217;utilise Firefox dans la vie de tous les jours et je vérifie le bon fonctionnement de mes fonctionnalités sur <a href="https://www.chromium.org/">Chromium</a>, un dérivé de Google Chrome.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gestionnaire_de_paquets">Gestionnaire de paquets</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Mac OS</strong>: Il existe de nombreuses options pour gérer la façon dont vous installez les paquets sur votre Mac, comme <a href="https://www.macports.org/">Mac Ports</a> ou <a href="http://brew.sh/">Homebrew</a>. Les deux sont de bonnes options, mais je choisirais la dernière. J’ai rencontré moins de problèmes lors de l’installation de logiciels avec Homebrew. Pour installer <code>brew</code> il suffit d’exécuter la commande ci-dessous:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Linux</strong>: Vous êtes déjà prêts! Peu importe si vous utilisez <code>apt</code>, <code>pacman</code>, <code>yum</code> tant que vous vous sentez à l’aise et que vous savez comment installer des paquets.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_git">Git</h3>
<div class="paragraph">
<p>Nous utiliserons beaucoup Git et vous devriez aussi l’utiliser (non seulement pour ce tutoriel mais aussi pour tous vos projets). Pour l’installer, c’est très facile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sous Mac OS: <code>$ brew install git</code></p>
</li>
<li>
<p>sous Linux: <code>$ sudo apt-get install git</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_node_js">Node.js</h3>
<div class="paragraph">
<p>Il existe de nombreuses façons d’installer et de gérer Node.js. Vous avez peut être même déjà avoir une version installée sur votre système. Pour le savoir, tapez simplement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>node <span class="nt">-v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si vous ne l&#8217;avez pas installé, vous pouvez le faire simplement avec votre gestionnaire de paquet. Je vous recommande néanmoins d&#8217;utiliser <a href="https://github.com/nvm-sh/nvm">Node Version Manager (NVM)</a>. Le principe de cet outil est de permettre d’installer plusieurs versions de Node.js sur une même machine, dans un environnement hermétique à une éventuelle version installée sur votre système d’exploitation et de pouvoir basculer de l’une à l’autre facilement.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;installer, il suffit de <a href="https://github.com/nvm-sh/nvm#installing-and-updating">suivre la documentation officielle</a>. Il suffit donc de lancer le script suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-o-</span> https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.0/install.sh | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;URL du script peut varier en fonction de la version actuelle.</p>
</div>
<div class="paragraph">
<p>Une fois l&#8217;installation terminée, vous pouvez installer la dernière version de Node.js avec la commande suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>nvm <span class="nb">install </span>node</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_bases_de_données">Bases de données</h4>
<div class="paragraph">
<p>Je vous recommande fortement d’installer <a href="http://www.postgresql.org/">Postgresql</a> pour gérer vos bases de données. Mais ici, pour plus de simplicité, nous allons utiliser <a href="http://www.sqlite.org/">SQLite</a>. Si vous utilisez Mac OS vous n’avez pas de bibliothèques supplémentaires à installer. Si vous êtes sous Linux, ne vous inquiétez pas, je vous guide:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>libxslt-dev libxml2-dev libsqlite3-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>ou</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>libxslt-devel libxml2-devel libsqlite3-devel</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_initialisation_de_lapplication">Initialisation de l&#8217;application</h3>
<div class="paragraph">
<p>Maintenant que votre poste de travail est prêt, nous sommes maintenant en mesure de créer notre projet !</p>
</div>
<div class="paragraph">
<p>Dans cette section, nous allons poser l&#8217;architecture de notre application. Cela veut dire :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mise en place de l&#8217;ORM avec le connexion à la base de données</p>
</li>
<li>
<p>mise en place des contrôleur</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est à mons avis une des partie les plus intéressante car vous allez découvrir une manière de faire certainement différente de la vôtre.</p>
</div>
<div class="paragraph">
<p>Il existe une tonne de <em>framework</em> complets comme <a href="https://nestjs.com/">Nest.js</a> qui est vraiment très bien. Mais ici nous allons partir de zéro en utilisant des librairies très populaires afin de maîtriser complètement notre application.</p>
</div>
<div class="paragraph">
<p>Cette méthode vous permettra aussi d&#8217;adapter et de construire l&#8217;architecture qui vous convient le mieux. Gardez à l&#8217;esprit que l&#8217;architecture que je vais vous présenter est celle que j&#8217;apprécie. Elle est totalement personnelle et je ne prétends pas que c&#8217;est la meilleure. Gardez toujours un esprit critique.</p>
</div>
<div class="paragraph">
<p>Vous êtes prêt ? C&#8217;est partit !</p>
</div>
<div class="paragraph">
<p>Placez vous donc dans le dossier de votre choix et créez un nouveau dossier :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>node_market_place
<span class="nv">$ </span><span class="nb">cd </span>node_market_place</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_contrôle_de_version">Contrôle de version</h3>
<div class="paragraph">
<p>Rappelez-vous que Git vous aide à suivre et à maintenir l’historique de votre code. Versionnez tous vos projets. Même si c&#8217;est un petit projet.</p>
</div>
<div class="paragraph">
<p>Initialiser Git dans votre projet ce résume à la commande suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git init</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il faut néanmoins configurer les informations de l’auteur des commits. Si ce n’est pas déjà fait, placez vous dans le répertoire et lancez les commandes suivantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git config user.name <span class="s2">"John Doe"</span>
<span class="nv">$ </span>git config user.email <span class="s2">"john@doe.io"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Passons à la suite.</p>
</div>
</div>
<div class="sect2">
<h3 id="_initialisation_de_npm">Initialisation de NPM</h3>
<div class="paragraph">
<p>NPM est le gestionnaire de paquets officiel de Node.js. Depuis la version 0.6.3 de Node.js, npm fait partie de l&#8217;environnement et est donc automatiquement installé par défaut</p>
</div>
<div class="paragraph">
<p>Initialiser votre projet avec Node.js signifie que vous serez en mesure d&#8217;installer n&#8217;importe quelle librairie publiée sur <a href="https://www.npmjs.com/">npmjs.com</a>.</p>
</div>
<div class="paragraph">
<p>Initialisons donc NPM dans notre projet :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm init</code></pre>
</div>
</div>
<div class="paragraph">
<p>Plusieurs questions vous serons posées et à la fin vous verrez un nouveau fichier <code>package.json</code>. Ce fichier détaille les informations de votre projet et les dépendances de celui-ci.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mise_en_place_de_typescript">Mise en place de Typescript</h3>
<div class="paragraph">
<p>Maintenant que nous avons créée nos dossiers, nous somme prêts à mettre en place Typescript.</p>
</div>
<div class="paragraph">
<p>Typescript va nous apporter un typage fort et va effectuer des vérification avant de <em>transpiler</em> le Code Typescript vers du Javascript :</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
On parle de <strong>compilateur</strong> pour une compilation d&#8217;un programme vers un éxecutable et d&#8217;une <strong>transpilation</strong> pour la conversion d&#8217;un programme dans un language vers un autre language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous installons donc Typescript en tant que dépendance de développement car il va uniquement nous servir à transpiler notre code. Ce sera Node.js qui va éxecuter le Javascript plus tard :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add typescript @types/node <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons ajouté deux librairies :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>typescript</code> qui va nous offrir les outils de <strong>transpilation</strong></p>
</li>
<li>
<p><code>@types/node</code> qui va ajouter la définition des types de Node.js</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ajoutons donc notre premier fichier Typescript :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="kd">function</span> <span class="nx">say</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`I said: </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">say</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello</span><span class="dl">"</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce code est vraiment très basique et va juste nous servir a vérifier que la transpilation fonctionne.</p>
</div>
<div class="paragraph">
<p>Afin d&#8217;utiliser la transpilation de Typescript, nous avons besoin de définir un fichier de configuration <code>tsconfig.json</code>. En voici un basique:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"compilerOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"rootDir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"./"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"outDir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dist"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"module"</span><span class="p">:</span><span class="w"> </span><span class="s2">"commonjs"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"types"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"node"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"es6"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"esModuleInterop"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"lib"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"es6"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"moduleResolution"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"experimentalDecorators"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"emitDecoratorMetadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela fait beaucoup de code mais les deux directives a retenir ici sont: <code>rootDir</code> et <code>outDir</code>. Elles vont simplement spécifier ou sont les fichiers Typescript (<code>rootDir</code>) et ou placer les fichiers Javascript résultants de la transpilation (<code>outDir</code>).</p>
</div>
<div class="paragraph">
<p>Dans notre cas je place tous les fichiers Typescript dans le dossier <code>src</code> et le résultat de la transpilation dans <code>dist</code>.</p>
</div>
<div class="paragraph">
<p>A partir d&#8217;ici vous pouvez tester que tout fonctionne en executant la commande suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>./node_modules/.bin/tsc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous allez voir apparaître un fichier <code>dist/main.js</code> de cette forme</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="javascript"><span class="c1">// dist/main.js</span>
<span class="kd">function</span> <span class="nx">say</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`I said: </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">say</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello</span><span class="dl">"</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il s&#8217;agit de la version transpilé de notre fichier Typescript.</p>
</div>
<div class="paragraph">
<p>Maintenant que nous avons vu que tout fonctionne, nous pouvons automatiser un peu cela en ajoutant les commandes directement dans le fichier <code>package.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc &amp;&amp; node dist/main.js"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et vous pouvez donc maintenant executer le script avec la commande suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm run start</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que tout fonctionne il est temps de versionner nos changement. N&#8217;ajoutez pas tous les fichiers crées, il est important de ne versionner certains dossier uniquement :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le dossier <code>node_modules</code> car il contient les librairies récupérées à l&#8217;aide de NPM et il est amené a changer lors de la mise a jours de ces librairies</p>
</li>
<li>
<p>le dossier <code>dist</code> car il résulte de la transpilation de notre code</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Afin de les ignorer, il suffit juste de créer un fichier <code>.gitignore</code> avec le contenu suivant :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>node_modules
dist</pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons maintenant mettre ajouter tous nos fichiers avec Git et commiter :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Setup Typescript for backend"</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_mise_en_place_du_hot_reload_avec_nodemon">Mise en place du Hot Reload avec Nodemon</h4>
<div class="paragraph">
<p>Il est sympa d&#8217;avoir une fonctionnalité de Hot Reload lors de la phase de développement. Cela signifie que notre programme se transpilera à nouveau et s&#8217;exécutera a chaque fois que notre code change.</p>
</div>
<div class="paragraph">
<p>La librairie <code>Nodemon</code> va nous offrir cette fonctionnalité. Ajoutons la :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add nodemon <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit maintenant de définir un fichier <code>nodemon.json</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"watch"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"src"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"ext"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ts"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ignore"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"src/**/*.spec.ts"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"exec"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npm run start"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quelques explications s&#8217;imposent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>watch</code> spécifie le dossier dans lequel Nodemon surveillera les changement de fichier</p>
</li>
<li>
<p><code>ignore</code> permet d&#8217;éviter le Hot Reload pour certains types de fichiers (ici ce sont les tests que nous verrons plus tard)</p>
</li>
<li>
<p><code>exec</code>, la commande a executer a chaque changement</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vérifions que tous fonctionne en lançant Nodemon à la main :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./node_modules/.bin/nodemon
<span class="o">[</span>nodemon] 2.0.6
<span class="o">[</span>nodemon] to restart at any <span class="nb">time</span>, enter <span class="sb">`</span>rs<span class="sb">`</span>
<span class="o">[</span>nodemon] watching path<span class="o">(</span>s<span class="o">)</span>: src/<span class="k">**</span>/<span class="k">*</span>
<span class="o">[</span>nodemon] watching extensions: ts
<span class="o">[</span>nodemon] starting <span class="sb">`</span>npm run start<span class="sb">`</span>
I said: Hello
<span class="o">[</span>nodemon] clean <span class="nb">exit</span> - waiting <span class="k">for </span>changes before restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notre code a été transpilé et executé et on voit que Nodemon continue de s&#8217;éxecuter et attends un changement. Modifions donc notre fichier <code>main.ts</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/main.ts
<span class="p">function say(message: string): void {
</span><span class="gd">-   console.log(`I said: ${message}`);
</span><span class="gi">+   console.log(`Nodemon said: ${message}`);
</span><span class="err">}</span>
say("Hello");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lorsque vous allez sauvegarder ce fichier, vous allez voir le travail de Nodemon dans le terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">[</span>nodemon] restarting due to changes...
<span class="o">[</span>nodemon] starting <span class="sb">`</span>npm run start<span class="sb">`</span>
Nodemon said: Hello
<span class="o">[</span>nodemon] clean <span class="nb">exit</span> - waiting <span class="k">for </span>changes before restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que tout fonctionne, nous pouvons modifier le fichier <code>package.json</code> et ajouter la commande <code>nodemon</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc &amp;&amp; node dist/main.js"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start:watch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nodemon"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons maintenant commiter les changements :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Setup Nodemon"</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mise_en_place_du_serveur_web">Mise en place du serveur web</h4>
<div class="paragraph">
<p>Jusqu&#8217;ici nous avons mis en place un environnement qui va nous permettre d&#8217;éviter les erreurs de syntaxe et de typage automatiquement avec Typescript. Il est temps d&#8217;enfin faire une vrai fonctionnalité: le serveur web.</p>
</div>
<div class="paragraph">
<p>Il existe plusieurs bibliothèque pour faire un serveur web avec Node.js. Dans mon cas je recommande <a href="https://expressjs.com/fr/">Express.js</a> tout simplement car c&#8217;est celle qui a une plus grosse communauté et elle offre des fonctionnalités basique. Elle vous laisse aussi la liberté d&#8217;organiser votre code comme vous le souhaitez tout en offrant une tonne de plugin pour rajouter des fonctionnalités par dessus.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;ajouter c&#8217;est très facile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add express <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On va aussi ajouter les typages Typescript qui vont aider un peu votre éditeur de code :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add @types/express <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant nous pouvons instancier notre serveur dans le fichier <code>main.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="k">import</span> <span class="nx">express</span><span class="p">,</span> <span class="p">{</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello World!</span><span class="dl">"</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`listen on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez lancer le serveur avec Nodemon (si ce n&#8217;est pas déjà fait) avec <code>npm run start:watch</code> et vous allez avoir le résultat suivant :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[nodemon] restarting due to changes...
[nodemon] starting `npm run start`
Server listen on http://localhost:3000/</pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez donc ouvrir votre navigateur a l&#8217;adresse <a href="http://localhost:3000" class="bare">http://localhost:3000</a> et voir que tout fonctionne. Voici ici le résultat en utilisant <code>curl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000
Hello World!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que tout fonctionne, commitons les changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add express.js server"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cela a été un chapitre assez long. Si vous êtes arrivés ici, permettez-moi de vous féliciter. Les choses vont s’améliorer à partir de ce point. Commençons à mettre les mains dans le code!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter02-api" class="sect0">L’API</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans ce chapitre, je vais vous donner les grandes lignes de l’application. Vous devriez avoir lu le chapitre précédent. Si ce n’est pas le cas, je vous recommande de le faire.</p>
</div>
<div class="paragraph">
<p>Pour résumer, nous avons simplement généré notre application Rails et réalisé notre premier commit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_planification_de_lapplication">Planification de l’application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Notre application sera assez simple. Elle se composera de cinq modèles. Ne vous inquiétez pas si vous ne comprenez pas bien ce qui se passe, nous reverrons et développerons chacune de ces ressources au fur et à mesure que nous avancerons avec le tutoriel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+---------+     +---------+
| User    +----&gt;+Product  |
+---------+     +---------+
     |               |
     v               v
+---------+     +---------+
|Order    +----&gt;+Placement|
+---------+     +---------+</pre>
</div>
</div>
<div class="paragraph">
<p>En bref, nous avons l’utilisateur (<code>User</code>) qui sera en mesure de créer des commandes (<code>Order</code>). Il pourra aussi passer de nombreuses commandes (<code>Order</code>) qui vont contenir des éléments (<code>Placement</code>) qui désignes des produits.</p>
</div>
<div class="paragraph">
<p>Nous n’allons pas construire d’interface pour l’interaction avec l’API afin de ne pas surcharger le tutoriel. Si vous voulez construire des vues, il existe de nombreuses options comme des frameworks JavaScript (<a href="https://angularjs.org/">Angular</a>, <a href="https://vuejs.org/">Vue.JS</a>, <a href="https://reactjs.org/">React</a>) ou des librairies mobiles (<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>).</p>
</div>
<div class="paragraph">
<p>À ce stade, vous devriez vous poser cette question:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>D’accord, mais j’ai besoin d’explorer et de visualiser l’API que je vais construire, non?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>C’est juste. Si vous <em>googlez</em> quelque chose lié à l’exploration d’une API, vous allez trouver pas mal de résultats. Vous pouvez par exemple utiliser <a href="https://www.getpostman.com/">Postman</a> qui est devenu incontournable. Mais nous n&#8217;allons pas l&#8217;utiliser. Dans notre cas nous allons utiliser <strong>cURL</strong> qui est un outil en ligne de commande disponible presque partout. Cela permet d&#8217;avoir des exemples reproductibles quelque soit votre environnement de développement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mettre_en_place_lapi">Mettre en place l’API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Une API est définie par <a href="https://fr.wikipedia.org/wiki/Interface_de_programmation">wikipedia</a> comme <em>une interface de programmation d’application (API) qui est un ensemble normalisé de composants qui sert de façade par laquelle un logiciel offre des services à d’autres logiciels</em>. En d’autres termes, il s’agit d’une façon dont les systèmes interagissent les uns avec les autres via une interface (dans notre cas un service web construit avec JSON). Il existe d’autres types de protocoles de communication comme SOAP, mais nous n’en parlons pas ici.</p>
</div>
<div class="paragraph">
<p>JSON est devenu incontournable en tant que format de fichier pour Internet en raison de sa lisibilité, de son extensibilité et de sa facilité à mettre en œuvre. Beaucoup de frameworks JavaScript l’utilisent comme protocole par défaut comme <a href="https://angularjs.org/">Angular</a> ou <a href="http://emberjs.com/">EmberJS</a>. D’autres grandes bibliothèques en Objective-C l’utilisent comme <a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> ou <a href="http://restkit.org/">RESTKit</a>. Il existe probablement de bonnes solutions pour Android mais en raison de mon manque d’expérience sur cette plate-forme de développement je ne peux pas vous recommander quelque chose.</p>
</div>
<div class="paragraph">
<p>Nous allons donc utiliser le format JSON pour construire notre API. La première idée qui pourrait vous venir à l’esprit serait de commencer à créer des routes en vrac. Le problème est qu’elles ne seraient pas normalisées. Un utilisateur ne pourrait pas deviner quelle ressource est renvoyée par une route.</p>
</div>
<div class="paragraph">
<p>C’est pourquoi une norme existe: <strong>REST</strong> <em>(Representational State Transfer)</em>. REST impose une norme pour les routes qui créent, lisent, mettent à jour ou suppriment des informations sur un serveur en utilisant de simples appels HTTP. C’est une alternative aux mécanismes plus complexes comme SOAP, CORBA et RPC. Un appel REST est simplement une requête GET HTTP vers le serveur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="soap">aService.getUser("1")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et avec REST, vous pouvez appeler une URL avec une requête HTTP spécifique. Dans ce cas avec une requête GET:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>http://domain.com/resources_name/uri_pattern</pre>
</div>
</div>
<div class="paragraph">
<p>Les API <em>RESTful</em> doivent suivre au minimum trois règles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une URI de base comme <a href="http://example.com/resources/" class="bare">http://example.com/resources/</a></p>
</li>
<li>
<p>Un type de média Internet pour représenter les données, il est communément JSON et est communément défini par l’échange d’en-têtes.</p>
</li>
<li>
<p>Suivez les méthodes <a href="https://fr.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> standard telles que GET, POST, PUT, PUT, DELETE.</p>
<div class="ulist">
<ul>
<li>
<p><strong>GET</strong>: Lit la ou les ressources définies par le modèle URI</p>
</li>
<li>
<p><strong>POST</strong>: Crée une nouvelle entrée dans la collection de ressources</p>
</li>
<li>
<p><strong>PUT</strong>: Met à jour une collection ou un membre des ressources</p>
</li>
<li>
<p><strong>DELETE</strong>: Détruit une collection ou un membre des ressources</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cela peut sembler compliqué mais au fur et à mesure que nous avancerons dans le tutoriel cela deviendra beaucoup plus facile à comprendre.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initialisation_de_lapplication_2">Initialisation de l&#8217;application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maintenant que nous savons quel conventions nous allons suivre, nous pouvons commencer à construire l&#8217;architecture de notre application. Ici nous allons donc continuer la mise en place de Typescript et de certaines librairies qui vont nous aider à respecter les meilleurs pratiques en terme de développement logiciel.</p>
</div>
<div class="sect2">
<h3 id="_linjection_de_dépendance">L&#8217;injection de dépendance</h3>
<div class="paragraph">
<p>Dans cette section nous allons mettre en place le système d'<strong>injection de dépendance</strong>. Si vous n&#8217;en avez jamais entendu parler, il s&#8217;agit très certainement de la partie la plus abstraite de ce chapitre.</p>
</div>
<div class="paragraph">
<p>Je vais essayer ici de vous résumer ce qu&#8217;est l&#8217;injection de dépendance et à quoi ça sert. Imaginons une classe <code>User</code> qui a besoin d&#8217;une classe <code>Database</code> pour être sauvegardé. On serait tenter d&#8217;initialiser la connection à la base de donnée dans le constructeur de l&#8217;utilisateur :</p>
</div>
<div class="listingblock">
<div class="title">Une mauvaise implémentation n&#8217;utilisant pas l&#8217;injection de dépendance</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">time</span><span class="p">}</span><span class="s2"> -- </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do some stuff here</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">Database</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">databaseString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">databaseString</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="dl">'</span><span class="s1">john@doe.io</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./user.sqlite</span><span class="dl">'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela pose plusieurs problème:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>la classe <code>User</code> depends de la classe <code>Database</code>. Si on change l&#8217;implémentation de la classe <code>Database</code>, il faudra modifier la classe <code>User</code></p>
</li>
<li>
<p>le code est beaucoup moins testable car pour tester un utilisateur, je dois connaître le fonctionnement de la classe user</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour vous accentuer le problème, rajoutons une classe <code>Logger</code> qui permet de logger les événements dans l&#8217;appli. Imaginons que nous avons besoin de logger la connection à la base de donnée. Le code devient donc</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">time</span><span class="p">}</span><span class="s2"> -- </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">connectionString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">();</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Connected to </span><span class="p">${</span><span class="nx">connectionString</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">Database</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">databaseString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">databaseString</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="dl">'</span><span class="s1">john@doe.io</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./user.sqlite</span><span class="dl">'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On voit bien que la situation se dégrade car toutes les classes deviennent dépendantes entre elles. Pour corriger cela, nous allons injecter directement la classe <code>Database</code> dans le constructeur de <code>User</code> :</p>
</div>
<div class="listingblock">
<div class="title">La classe <code>Database</code> est maintenant injectée dans le constructeur</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>

<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">,</span> <span class="nx">connectionString</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Connected to </span><span class="p">${</span><span class="nx">connectionString</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">Database</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="dl">"</span><span class="s2">db.sqlite</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">database</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce code devient plus solide car la classe <code>User</code>, <code>Database</code> et <code>Logger</code> sont découplés.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>OK, mais ça devient plus pénible d&#8217;instancier une <code>User</code>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Effectivement. C&#8217;est pourquoi nous utilisons un <code>Container</code> qui va enregistrer les classes qui peuvent être injectées et nous proposer de créer des instances facilement :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="kd">class</span> <span class="nx">Database</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>

<span class="kd">class</span> <span class="nx">Container</span> <span class="p">{</span>
  <span class="nx">getLogger</span><span class="p">():</span> <span class="nx">Logger</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">getDatabase</span><span class="p">():</span> <span class="nx">Database</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Database</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getLogger</span><span class="p">(),</span> <span class="dl">"</span><span class="s2">db.sqlite</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">getUser</span><span class="p">():</span> <span class="nx">User</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">getUser</span><span class="p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le code est plus long mais tout devient découpé. Rassurez-vous, nous n&#8217;allons pas implémenter tout cela à la main. De très bonne librairies existent. Celle que j&#8217;ai choisi est <a href="https://github.com/inversify/InversifyJS">Inversify</a>.</p>
</div>
<div class="paragraph">
<p>Dans cette section nous allons mettre en place concrètement un système d&#8217;injection de dépendance complet.</p>
</div>
<div class="paragraph">
<p>Nous allons mettre en place un Logger qui pourra être injecté dans toutes les classes de notre application. Il nous permettra de les requêtes HTTP par exemple mais aussi bien d&#8217;autres événements.</p>
</div>
<div class="paragraph">
<p>Installons donc <code>inversify</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>inversify <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et créons une classe pour logger les événements toute simple:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
On pourrait utiliser une librairie comme <a href="https://github.com/winstonjs/winston">Winston</a> ou <a href="https://www.npmjs.com/package/morgan">Morgan</a> mais pour l&#8217;exemple je vais créer une classe assez basique :
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/logger.service.ts</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">log</span><span class="p">(</span><span class="nx">level</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DEBUG</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">INFO</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">ERROR</span><span class="dl">'</span><span class="p">,</span> <span class="nx">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">time</span><span class="p">}</span><span class="s2"> - </span><span class="p">${</span><span class="nx">level</span><span class="p">}</span><span class="s2"> - </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour la rendre injectable, il faut lui ajouter un décorateur <code>@injectable</code>. Ce décorateur va simplement <a href="https://github.com/inversify/InversifyJS/blob/master/src/annotation/injectable.ts#L12">ajouter une metadata</a> a notre classe afin qu&#8217;elle puisse être injectée dans nos futures dépendances.</p>
</div>
<div class="listingblock">
<div class="title">ajout du décorateur <code>@injectable</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Logger</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Il ne nous reste plus qu&#8217;à créer le container qui va enregistrer ce service. <a href="https://github.com/inversify/InversifyJS#installation">La documentation</a> recommande de créer un objet <code>TYPES</code> qui va simplement stocker les identifiants de nos services. Nous allons créer un dossier <code>core</code> qui contiendra tout le code transverse à toute notre application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="na">Logger</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">'</span><span class="s1">Logger</span><span class="dl">'</span><span class="p">)};</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Un <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol"><code>Symbol</code></a> est un type primitif qui permet d&#8217;avoir une référence unique.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Maintenant nous pouvons utiliser ce symbole pour enregistrer notre logger dans un nouveau fichier <code>container.core.ts</code> Il suffit d&#8217;instancier un <code>Container</code> et d&#8217;ajouter notre service avec la méthode <code>bind()</code>. On exporte ensuite cette instance pour l&#8217;utiliser dans l&#8217;application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Logger</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/logger.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./types.core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">Logger</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà.</p>
</div>
</div>
<div class="sect2">
<h3 id="_création_dun_contrôleur">Création d&#8217;un contrôleur</h3>
<div class="paragraph">
<p>Laissons de côté cette classe que nous allons utiliser plus tard dans notre premier contrôleur. Les contrôleurs font partis du <em>design patern</em> <strong>MVC: Modèle, Vue, Contrôleur</strong>. Leur but est d&#8217;intercepter la requête et d&#8217;appeler les services dédiés. Il existe une librairie officielle Inversify pour intégrer l&#8217;injection de dépendance directement dans nos contrôleurs:  <a href="https://github.com/inversify/inversify-express-utils"><code>inverisfy-express-utils</code></a>.</p>
</div>
<div class="paragraph">
<p>On commence par installer la librairie. On va aussi ajouter <code>body-parser</code> qui va nous permettre de traiter les paramètres de la requête HTTP (nous en reparlerons plus loins).</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;installer, c&#8217;est très facile. Il suffit de suivre la <a href="https://github.com/inversify/inversify-express-utils">documentation officielle</a>. On commence donc par installer quelques librairies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>inversify-express-utils reflect-metadata body-parse <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>reflet-metadata</code> permet à Inversify d&#8217;ajouter des metadata sur notre classe. Cet import doit être situé au tout débt du premier fichier.</p>
</li>
<li>
<p><code>body-parse</code> va nous donner la possibilité d&#8217;extraires les paramètres des requêtes HTTP (nous ren reparlerons plus tard)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Avant d&#8217;écrire notre premier contrôleur, il est nécessaire de faire quelques modifications à la création de notre serveur HTTP. Créons un nouveau fichier <code>core/server.core.ts</code> qui va simplement définir notre serveur HTTP avec <code>inversify-express-utils</code>:</p>
</div>
<div class="listingblock">
<div class="title">La définition de notre serveur HTTP avec <code>inversify-express-utils</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/server.ts</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">bodyParser</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">InversifyExpressServer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./container.core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InversifyExpressServer</span><span class="p">(</span><span class="nx">container</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">setConfig</span><span class="p">(</span><span class="nx">app</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="na">extended</span><span class="p">:</span> <span class="kc">true</span><span class="p">}));</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, nous utilisons maintenant une instance de <code>InversifyExpressServer</code>. La méthode <code>setConfig</code> permet d&#8217;ajouter des <em>middleware</em> (nous y reviendrons plus tard). Passons au fichier <code>main.ts</code> que nous allons modifier un peu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">reflect-metadata</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">server</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./core/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./core/types.core</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="nx">server</span>
  <span class="p">.</span><span class="nx">build</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Listen on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Nous pouvons maintenant nous attaquer à notre premier contrôleur.</p>
</div>
<div class="paragraph">
<p>Le contrôleur est une classe comme les autres. Elle va simplement le décorateur <code>@controller</code>. Ce décorateur va lui aussi déclarer ce contrôleur comme <code>@injectable</code> mais aussi nos offrir des fonctionnalités spéciales.</p>
</div>
<div class="paragraph">
<p>Passons directement à l&#8217;implémentation afin que cela soit plus parlant:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Création du premier contrôleur avec une unique route</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>// src/controllers/home.controller.ts
import {controller, httpGet} from 'inversify-express-utils';

@controller('/')
export class HomeController {

  @httpGet('')
  public index(req: Request, res: Response) {
    return res.send('Hello world');
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, l&#8217;implémentation est très claire grâce aux décorateurs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le <code>@controller("/")</code> nous indique que toutes les routes de ce contrôleur seront préfixées par <code>/</code></p>
</li>
<li>
<p>Le second décorateur <code>@httpGet("/")</code> définit que cette méthode sera accèssible sur l&#8217;URL <code>/</code> via le verbe HTTP POST.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maintenant essayons d&#8217;injecter le <code>Logger</code> afin d&#8217;afficher un message lorsque cette route est utilisée:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Logger</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/logger.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HomeController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">)</span> <span class="p">{}</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">''</span><span class="p">)</span>
  <span class="k">public</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">INFO</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Get Home.index</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello world</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà !</p>
</div>
<div class="paragraph">
<p>Le décorateur <code>@inject</code> s&#8217;occupe de tout, il suffit de spécifier le symbole. C&#8217;est magique.</p>
</div>
<div class="paragraph">
<p>La dernière étape est d&#8217;importer manuellement ce contrôleur dans le container. C&#8217;est vraiment très simple à faire :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/core/container.core.ts
<span class="p">import {Container} from 'inversify';
</span><span class="gi">+ import '../controllers/home.controller';
</span><span class="p">import '../controllers/users.controller';
</span><span class="err">//</span> ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez maintenant démarrer le serveur avec <code>npm run start</code> ou attendre que la transpilation se fasse automatiquement si vous n&#8217;avez pas arreté le précédent serveur.</p>
</div>
<div class="paragraph">
<p>Si tout fonctionne comme avant, vous pouvez commiter les changements :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add inversify"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_2">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ça a été un peu long, je sais, mais vous avez réussi! N’abandonnez pas, c’est juste notre petite fondation pour quelque chose de grand, alors continuez comme ça.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter03-presenting-users" class="sect0">Présentation des utilisateurs</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans le chapitre précédent, nous avons réussi à mettre en place les bases de la configuration de notre application. Ce chapitre va perfectionner cette base et ajouter la couche <em>Model</em> qui sera en charge de stocker les données et aussi d&#8217;ajouter les premiers tests.</p>
</div>
<div class="paragraph">
<p>Dans les prochains chapitres, nous traiterons l’authentification des utilisateurs à l’aide de jetons d’authentification ainsi que la définition de permissions pour limiter l’accès aux utilisateurs connectés. Nous relierons ensuite les produits aux utilisateurs et leur donnerons la possibilité de passer des commandes.</p>
</div>
<div class="paragraph">
<p>Comme vous pouvez déjà l’imaginer, il existe de nombreuses solutions d’authentification pour Node.js comme <a href="http://www.passportjs.org/">Passport.js</a>, <a href="https://github.com/ianstormtaylor/permit">Permit</a> et <a href="https://github.com/simov/grant">Devise</a>. Ces solutions sont des librairies clé en main, c&#8217;est à dire qu&#8217;elles permettent de gérer tout un tas de choses comme l&#8217;authentification, la fonctionnalité d&#8217;oubli de mot de passe, la validation, etc..</p>
</div>
<div class="paragraph">
<p>Nous ne les utiliserons pas afin de mieux appréhender le mécanisme d&#8217;authentification. Cela vous permettra de découvrir qu&#8217;il n&#8217;y a rien de magique derrière le chiffrement des mots de passe et la création des jetons d&#8217;authentifications.</p>
</div>
<div class="paragraph">
<p>Ce chapitre sera complet. Il sera peut-être long mais je vais essayer d’aborder autant de sujets que possible. N’hésitez pas à vous prendre un café et allons-y. A la fin de ce chapitre, vous aurez construit toute la logique des utilisateurs ainsi que la validation et la gestion des erreurs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mise_en_place_de_typeorm">Mise en place de TypeORM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ici nous allons mettre e place la couche <em>Model</em> du <em>design patern</em> MVC. Il s&#8217;agit de la couche relative à la base de données.</p>
</div>
<div class="paragraph">
<p>Afin d&#8217;accéder a la base de données, nous allons utiliser un ORM (Object Relational Mapper). Le but d&#8217;un ORM est de dialoguer avec la base de données et de vous éviter d&#8217;écrire les requêtes SQL à la main. Il nous permet aussi d&#8217;ajouter une couche d&#8217;abstraction au type de base de données et nous permet de ne pas nous soucier des différences entre PostgreSQL et SQLite par exemple.</p>
</div>
<div class="paragraph">
<p>Il existe plusieurs ORM pour Nodejs: <a href="https://sequelize.org/">Sequelize</a>, <a href="https://mongoosejs.com/">Mongoose</a> et <a href="https://typeorm.io/">TypeORM</a>. J&#8217;ai choisis le dernier car c&#8217;est celui qui s&#8217;intègre le mieux avec Typescript. Il propose aussi une approche <a href="https://typeorm.io/#/active-record-data-mapper">Active Record ET Data Mapper</a> que j&#8217;apprécie beaucoup.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;installer c&#8217;est très facile. Nous allons installer la librairie TypeORM mais aussi deux librairies supplémentaires :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sqlite3</code> qui va nous permettre de dialoguer avec notre base de données Sqlite</p>
</li>
<li>
<p><a href="https://www.npmjs.com/package/dotenv"><code>dotenv</code></a> qui va nous permettre de commencer à définir des <strong>variables d&#8217;environnement</strong> comme la connexion à notre base de données.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est parti:</p>
</div>
<div class="listingblock">
<div class="title">Ajout des librairies pour installer TypeORM</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm add typeorm sqlite3 dotenv <span class="nt">--save</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons maintenant générer notre fichier de configuration. Par défault, <code>dotenv</code> va chercher un fichier nomé <code>.env</code>. Créons le:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">touch</span> .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et commençons par définir <a href="https://github.com/typeorm/typeorm/blob/master/docs/using-ormconfig.md#using-environment-variables">les variables d&#8217;environnement de TypeORM</a> pour une connexion basique à une base de donnée SQLite:</p>
</div>
<div class="listingblock">
<div class="title">La configuration de base de TypeORM pour une connexion à SQLite</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="env">TYPEORM_CONNECTION=sqlite
TYPEORM_DATABASE=db/development.sqlite
TYPEORM_LOGGING=true
TYPEORM_SYNCHRONIZE=true
TYPEORM_ENTITIES=src/entities/*.entity.ts,dist/entities/*.entity.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir on définis que nous utiliserons Sqlite et que la base de données sera stockée dans le dossier <code>db/</code>. <code>TYPEORM_SYNCHRONIZE</code> permet d&#8217;éviter de ne pas se soucier des migrations et ainsi laisser TypeORM faire les modifications sur le schéma de notre base de données si nécessaire. Nous spécifions ensuite ou sont situé nos entités avec <code>TYPEORM_ENTITIES</code>.</p>
</div>
<div class="paragraph">
<p>Il ne nous reste plus qu&#8217;a configurer <code>dotenv</code> pour charger ce fichier. Pour faire cela, j&#8217;utilise le <em>flag</em> <code>--require</code> de Node.js qui permet de pré-charger une librairie. Il suffit donc de modifier le <code>package.json</code>:</p>
</div>
<div class="listingblock">
<div class="title">La configuration de base de TypeORM pour une connexion à SQLite</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tsc &amp;&amp; node dist/main.js -r dotenv/config"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start:watch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nodemon"</span><span class="p">,</span><span class="w">
    </span><span class="c1">// ...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="c1">// ...</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons maintenant créer un service <code>DatabaseService</code> qu va s&#8217;occuper de connecter TypeORM à notre base de données. Comme nous avons mis en place l&#8217;injection de dépendance, ce service sera lui aussi injectable. Voici l&#8217;implémentation complète. Pas de panique, je vous détaille la logique ensuite.</p>
</div>
<div class="listingblock">
<div class="title">Implémentation du service d&#8217;initialisation de TypeORM</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/database.service.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Connection</span><span class="p">,</span> <span class="nx">createConnection</span><span class="p">,</span> <span class="nx">ObjectType</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Logger</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./logger.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">DatabaseService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">static</span> <span class="nx">connection</span><span class="p">:</span> <span class="nx">Connection</span><span class="p">;</span>

  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">getConnection</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Connection</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span> <span class="k">instanceof</span> <span class="nx">Connection</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">createConnection</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">INFO</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`Connection established`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">ERROR</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Cannot establish database connection</span><span class="dl">'</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">DatabaseService</span><span class="p">.</span><span class="nx">connection</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">getRepository</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">repository</span><span class="p">:</span> <span class="nx">ObjectType</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">getCustomRepository</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">repository</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette classe possède deux méthodes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getConnection</code> : cette méthode va initialiser une nouvelle connection à la base de données. Celle-ci va appeler la méthode <code>createConnection</code> qui va chercher <a href="https://typeorm.io/#/using-ormconfig">un fichier de ormconfig</a> (dans notre cas les variables d&#8217;environnement chargée par <code>dotenv</code>) et établir une connection. Une fois la connection effectuée, elle est stoquée dans une propriété statique qui sera retournée directement la prochaine fois</p>
</li>
<li>
<p><code>getRepository</code> : cette méthode va nous permettre de manipuler nos modèles via les repository. Nous en parlerons en détails plus loin</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
C&#8217;est une bonne pratique de cacher la logique de la librairie par nos propres classe. Cela nous permettrai de moi dépendre de la librairie et de pouvoir migrer plus facilement si un jours nous souhaiterions changer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Maintenant que notre service est créé, il faut l&#8217;ajouter à notre container :</p>
</div>
<div class="listingblock">
<div class="title">Ajout du <code>Symbol</code> lié au service <code>DatabaseService</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">DatabaseService</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">'</span><span class="s1">DatabaseService</span><span class="dl">'</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Enregistrement du service <code>DatabaseService</code> dans le container Inversify</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">DatabaseService</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà.</p>
</div>
<div class="paragraph">
<p>Nous pouvons maintenant créer notre premier modèle <code>User</code>. En utilisant le <em>patern Data Mapper</em> il va falloir créer deux classe :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l'<em>entity</em> : elle va définir les attributs des champs à sauvegarder dans la base de donnée. Dans notre cas, je vais simplement créer deux attributs: <code>email</code> et <code>password</code> (le mot de passe sera chiffrée plus tards).</p>
</li>
<li>
<p>le <em>repository</em> : elle va ajouter certaines logiques pour sauvegarder nos entités.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Afin de simplifier l&#8217;exemple, je vais mettre ces deux classes dans le même fichier mais vous pouvez très bien les séparer :</p>
</div>
<div class="listingblock">
<div class="title">Première implémentation de la classe <code>User</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="k">import</span> <span class="p">{</span>
  <span class="nx">Column</span><span class="p">,</span>
  <span class="nx">Entity</span><span class="p">,</span>
  <span class="nx">EntityRepository</span><span class="p">,</span>
  <span class="nx">PrimaryGeneratedColumn</span><span class="p">,</span>
  <span class="nx">Repository</span><span class="p">,</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span><span class="na">unique</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="nx">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">User</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UserRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Le résultat est vraiment très simple gràce aux décorateurs <code>@columns</code> proposées par TypeORM. Ceux-ci peuvent aussi définir le type d&#8217;information a stocker (Tex te, date, etc..). L&#8217;implémentation de ce modèle est suffisante pour le moment.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;instant notre travail n&#8217;est pas très visible mais tenez bon car vous allez voir le résultat dans la prochaine section.</p>
</div>
<div class="paragraph">
<p>Nous pouvons commiter les changements effectuées jusqu&#8217;à maintenant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Setup TypeORM"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_création_du_contrôleur_des_utilisateurs">Création du contrôleur des utilisateurs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il est maintenant temps d&#8217;entrer dans la partie concrète et de créer le contrôleur qui va gérer les utiliseurs. Ce contrôleur va respecter les normes REST et proposer les actions CRUD classiques. C&#8217;est à dire <em><strong>C</strong>reate</em>, <em><strong>R</strong>ead</em>, <em><strong>U</strong>pdate</em> et <em><strong>D</strong>elete</em>.</p>
</div>
<div class="sect2">
<h3 id="_lister_les_utilisateurs">Lister les utilisateurs</h3>
<div class="paragraph">
<p>Nous allons commencer par la méthode <code>index</code> qui est la plus simple.</p>
</div>
<div class="paragraph">
<p>Comme nous l&#8217;avons vu plutôt, les contrôleurs peuvent injecter nos services. Nous allons donc injecter le <code>DatabaseService</code> afin de pouvoir récupérer le <code>UserRepository</code>. Il suffira ensuite d&#8217;appeler la méthode <code>userRepository.find</code> afin de récupérer la liste de tous les utilisateur (qui est vide pour le moment).</p>
</div>
<div class="paragraph">
<p>Voici l&#8217;implémentation de notre contrôleur:</p>
</div>
<div class="listingblock">
<div class="title">Création du <code>UserController</code> avec la méthode <code>index</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">httpGet</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">)</span> <span class="p">{}</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et bien sûr, il ne faut pas oublier d&#8217;ajouter l&#8217;import de ce nouveau contrôleur dans le container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/core/container.core.ts
<span class="p">import {Container} from 'inversify';
import "../controllers/home.controller";
</span><span class="gi">+ import "../controllers/users.controller";
</span><span class="p">import {DatabaseService} from '../services/database.service';
import {Logger} from '../services/logger.service';
</span><span class="err">//</span> ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Lancez la commande <code>npm run start:watch</code> pour démarrer le serveur si vous l&#8217;avez arrêté et testons la fonctionnalité avec <code>cURL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/users</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le retour de la commande nous indique un tableau vide: c&#8217;est normal car il n&#8217;y a pas encore d&#8217;utilisateur. En revanche, le terminal du serveur nous indique qu&#8217;il s&#8217;est passé beaucoup de chose:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>query: BEGIN TRANSACTION
query: SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" IN ('user')
query: SELECT * FROM "sqlite_master" WHERE "type" = 'index' AND "tbl_name" IN ('user')
query: SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" = 'typeorm_metadata'
query: CREATE TABLE "user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "email" varchar NOT NULL, "password" varchar NOT NULL)
query: COMMIT
2020-11-15T22:09:25.476Z - INFO - Connection established - {}
query: SELECT "User"."id" AS "User_id", "User"."email" AS "User_email", "User"."password" AS "User_password" FROM "user" "User"</pre>
</div>
</div>
<div class="paragraph">
<p>Il s&#8217;agit des logs de TypeORM. Ceux-ci nous indiquent que:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>TypeORM a essayé de voir s&#8217;il existait une table nommée <code>user</code></p>
</li>
<li>
<p>TypeORM a crée cette table puisqu&#8217;elle n&#8217;existait pas</p>
</li>
<li>
<p>la connexion a la base de données été établie</p>
</li>
<li>
<p>La requête SQL pour retrouver tous les utilisateurs a été exécutée</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela nous indique que tout fonctionne parfaitement ! Mais je vous sent un peu déçu car nous n&#8217;avons pas encore d&#8217;utilisateur. Passons à la suite !</p>
</div>
</div>
<div class="sect2">
<h3 id="_create">Create</h3>
<div class="paragraph">
<p>Maintenant que toute notre structure a été mise en place, la suite va aller beaucoup plus vite. Passons directement à l&#8217;implémentation et je fous explique le code ensuite:</p>
</div>
<div class="listingblock">
<div class="title">Ajout de la méthode <code>create</code> à la classe <code>UserRepository</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">httpGet</span><span class="p">,</span> <span class="nx">httpPost</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="kr">interface</span> <span class="nx">CreateUserBody</span> <span class="p">{</span>
  <span class="nl">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nx">CreateUserBody</span><span class="p">,</span> <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela fait un peut de code mais pas de panique. <code>CreateUserBody</code> est une interface qui définie les paramètres HTTP qui peuvent être reçu. Nous prenons ces paramètres et nous les envoyons directement au <code>repository</code>.</p>
</div>
<div class="paragraph">
<p>Testons que tout cela fonctionne:</p>
</div>
<div class="listingblock">
<div class="title">Création d&#8217;un utilisateur avec <code>cURL</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parfait. On voit que tout fonctionne correctement!</p>
</div>
<div class="paragraph">
<p>Passons à la suite pour récupérer les information de cet utilisateur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_show">Show</h3>
<div class="paragraph">
<p>La méthode <code>show</code> va s&#8217;occuper de retrouver les informations d&#8217;un utilisateur. Cette méthode va prendre l&#8217;identifiant de l&#8217;utilisateur. On va ensuite utiliser le <code>repository</code> pour récupérer l&#8217;utilisateur.</p>
</div>
<div class="paragraph">
<p>Voici l&#8217;implémentation :</p>
</div>
<div class="listingblock">
<div class="title">Ajout de la méthode <code>create</code> à la classe <code>UserRepository</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(@</span><span class="nd">requestParam</span><span class="p">(</span><span class="dl">'</span><span class="s1">userId</span><span class="dl">'</span><span class="p">)</span> <span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est vraiment très simple. Il faut simplement retourner un objet et <code>inversify-express-utils</code> va s&#8217;occuper de convertir l&#8217;objet JavaScript en JSON.</p>
</div>
<div class="paragraph">
<p>Essayons pour voir:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/users/1
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"password"</span>:<span class="s2">"test"</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Tous fonctionne correctement. Essayons maintenant de modifier cet utilisateur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_update">Update</h3>
<div class="paragraph">
<p>La méthode <code>update</code> va s&#8217;occuper de récupérer, modifier et enregistrer l&#8217;utilisateur. Comme pour la méthode précédente, TypeORM nous facilite beaucoup la tâche :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">UpdateUserBody</span> <span class="p">{</span>
  <span class="nl">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nx">UpdateUserBody</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">requestParam</span><span class="p">(</span><span class="dl">'</span><span class="s1">userId</span><span class="dl">'</span><span class="p">)</span> <span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">??</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span> <span class="o">??</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Comme tout à l&#8217;heure, essayons de voir si cela fonctionne :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> PUT <span class="nt">-d</span> <span class="s2">"email=foo@bar.com"</span>  http://localhost:3000/users/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parfait ! Vous pouvez même voir, notre utilisateur a été mis à jour et il nous est renvoyé sous format JSON. Vous pouvez même voir la requête SQL que TypeORM a effectué dans les logs du terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="nv">"User_id"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"email"</span> <span class="k">AS</span> <span class="nv">"User_email"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"password"</span> <span class="k">AS</span> <span class="nv">"User_password"</span> <span class="k">FROM</span> <span class="nv">"user"</span> <span class="nv">"User"</span> <span class="k">WHERE</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: [1]</span>
<span class="n">query</span><span class="p">:</span> <span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
<span class="n">query</span><span class="p">:</span> <span class="k">UPDATE</span> <span class="nv">"user"</span> <span class="k">SET</span> <span class="nv">"email"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">WHERE</span> <span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: ["foo@bar.com",1]</span>
<span class="n">query</span><span class="p">:</span> <span class="k">COMMIT</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Passons maintenant à la dernière méthode du controlleur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_delete">Delete</h3>
<div class="paragraph">
<p>La méthode <code>delete</code> est la plus facile. Il suffit de récupérer l&#8217;utilisateur et d&#8217;appeler la méthode <code>repository.delete</code>. Allez c&#8217;est parti :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpDelete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">destroy</span><span class="p">(@</span><span class="nd">requestParam</span><span class="p">(</span><span class="dl">'</span><span class="s1">userId</span><span class="dl">'</span><span class="p">)</span> <span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Nous pouvons aussi tester cette méthode :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> DELETE  http://localhost:3000/users/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ici encore, nous pouvons vérifier que l&#8217;utilisateur a bien été supprimé en regardant les logs de TypeORM :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="nv">"User_id"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"email"</span> <span class="k">AS</span> <span class="nv">"User_email"</span><span class="p">,</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"password"</span> <span class="k">AS</span> <span class="nv">"User_password"</span> <span class="k">FROM</span> <span class="nv">"user"</span> <span class="nv">"User"</span> <span class="k">WHERE</span> <span class="nv">"User"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: ["1"]</span>
<span class="n">query</span><span class="p">:</span> <span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"user"</span> <span class="k">WHERE</span> <span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span> <span class="nv">"email"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span> <span class="nv">"password"</span> <span class="o">=</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: [1,"foo@bar.com","test"]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Maintenant que nous arrivons à la fin de de notre controlleur, nous pouvons commiter tous ces changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Implement CRUD actions on user"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_de_nos_utilisateurs">Validation de nos utilisateurs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tout semble fonctionner mais il rest une problème: nous ne validons pas les données que nous insérons en base. Ainsi, il est possible de créer un utilisateur avec un email faux :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ curl -X POST -d "whatever" -d "password=test" http://localhost:3000/users</pre>
</div>
</div>
<div class="paragraph">
<p>Encore une fois, nous allons avoir recours a une librairie toute faite: <code>class-validator</code>. Cette librairie va nous offrir <a href="https://github.com/typestack/class-validator/#table-of-contents">une tonne de décorateurs</a> pour vérifier très facilement notre instance <code>User</code>.</p>
</div>
<div class="paragraph">
<p>Installons la avec NPM :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ npm install class-validator --save</pre>
</div>
</div>
<div class="paragraph">
<p>Et il suffit ensuite d&#8217;ajouter les décorateurs <code>@IsEmail</code> et <code>@IsDefined</code> comme ceci :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/entities/user.entity.ts
<span class="gi">+ import {IsDefined, IsEmail, validateOrReject} from 'class-validator';
</span><span class="gd">- import {/* ... */} from 'typeorm';
</span><span class="gi">+ import {BeforeInsert, BeforeUpdate, /* ... */} from 'typeorm';
</span>
@Entity()
<span class="p">export class User {
</span>  // ...
<span class="gi">+  @IsDefined()
+  @IsEmail()
</span>  @Column()
  email: string;

+  @IsDefined()
  @Column()
  password: string;

+  @BeforeInsert()
<span class="gi">+  @BeforeUpdate()
+  async validate() {
+    await validateOrReject(this);
+  }
</span><span class="err">}</span>
// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il n&#8217;a pas fallu beaucoup de code a ajouter. La partie la plus intéressante est la méthode <code>validate</code>. Elle possède deux décorateurs <code>BeforeInsert</code> et <code>BeforeUpdate</code> qui vont permettre d&#8217;appeler automatiquement la méthode <code>validate</code> lorsqu&#8217;on utilise la méthode <code>save</code> d&#8217;un repository. C&#8217;est très pratique et il n&#8217;y a rien a faire. Essayons maintenant de créer le même utilisateur avec l&#8217;email erroné :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"whatever"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users
...
&lt;pre&gt;An instance of User has failed the validation:&lt;br&gt; - property email has failed the following constraints: isDefined, isEmail &lt;br&gt;&lt;/pre&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>On voit que c&#8217;est beaucoup mieux. Cependant nous souhaiterions envoyer une erreur formatée en JSON avec le code d&#8217;erreur correspondant à la norme REST. Modifions donc le contrôleur :</p>
</div>
<div class="listingblock">
<div class="title">Ajout de la validation des utilisateur dans le <code>UserController</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">User</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">User</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Essayons maintenant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span>  http://localhost:3000/users
<span class="o">{</span><span class="s2">"errors"</span>:[<span class="o">{</span><span class="s2">"target"</span>:<span class="o">{</span><span class="s2">"password"</span>:<span class="s2">"test"</span><span class="o">}</span>,<span class="s2">"property"</span>:<span class="s2">"email"</span>,<span class="s2">"children"</span>:[],<span class="s2">"constraints"</span>:<span class="o">{</span><span class="s2">"isDefined"</span>:<span class="s2">"email should not be null or undefined"</span>,<span class="s2">"isEmail"</span>:<span class="s2">"email must be an email"</span><span class="o">}}]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le résultat est vraiment complet et permettra a un utilisateur de l&#8217;API d&#8217;interpréter rapidement l&#8217;erreur.</p>
</div>
<div class="paragraph">
<p>Commitons ces changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Validate user"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_factorisation">Factorisation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maintenant que nous avons un code qui fonctionne, il est temps de faire une passe pour <strong>factoriser tout ça</strong>.</p>
</div>
<div class="paragraph">
<p>Pendant la mise en place, vous avez sans doute remarqué que la méthode <code>show</code>, <code>update</code> et <code>destroy</code> possédait un logique commune: elles récupèrent toute l&#8217;utilisateur.</p>
</div>
<div class="paragraph">
<p>Pour factoriser ce code il y aurait deux solutions :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>déplacer le bout de code dans un méthode privée et l&#8217;appeler</p>
</li>
<li>
<p>créer un <strong>Middleware</strong> qui va être exécuté avant le contrôleur</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>J&#8217;ai choisi la deuxième option car elle permet de réduire le code et la responsabilité du contrôleur. De plus, avec <code>inversify-express-utils</code> c&#8217;est très facile. Laissez moi vous montrer :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="typescript"><span class="k">import</span> <span class="p">{</span><span class="nx">NextFunction</span><span class="p">,</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">BaseMiddleware</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchUserMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">userId</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">userId</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">User not found</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Voici quelques explications sur ce code :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>inversify-express-utils</code> nous donne accès a une classe abstraite <code>BaseMiddleware</code>. Nous devons aussi ajouter le décorateur <code>@injectable</code> pour l&#8217;utiliser plus tard dans notre contrôleur</p>
</li>
<li>
<p>un middleware est une simple méthode <code>handle</code> qui prend en paramètre :</p>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>req</code></dt>
<dd>
<p>la requête envoyée par l&#8217;utilisateur</p>
</dd>
<dt class="hdlist1"><code>res</code></dt>
<dd>
<p>la réponse HTTP à renvoyer.</p>
</dd>
<dt class="hdlist1"><code>next</code></dt>
<dd>
<p>un callback a appeler une fois que notre traitement est finit</p>
</dd>
</dl>
</div>
</li>
<li>
<p>la méthode <code>handle</code> s&#8217;occupe de récupérer l&#8217;utilisateur et de l&#8217;ajouter à l&#8217;objet <code>req</code> pour qu&#8217;il soit utilisé plus tard</p>
</li>
<li>
<p>si l&#8217;utilisateur n&#8217;existe pas, nous utilisons <code>res</code> pour renvoyer directement une réponse 404 sans même passer par l&#8217;utilisateur</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vu que nous avons défini un nouvel injectable, il faut l&#8217;ajouter à notre container :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/core/types.core.ts
<span class="p">export const TYPES = {
</span>  Logger: Symbol.for("Logger"),
  DatabaseService: Symbol.for("DatabaseService"),
<span class="gi">+   // Middlewares
+   FetchUserMiddleware: Symbol.for("FetchUserMiddleware"),
</span><span class="err">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/core/container.core.ts
<span class="err">//</span> ...
<span class="gi">+ import {FetchUserMiddleware} from '../middlewares/fetchUser.middleware';
</span>
export const container = new Container();
<span class="err">//</span> services
<span class="p">container.bind(TYPES.Logger).to(Logger);
container.bind(TYPES.DatabaseService).to(DatabaseService);
</span><span class="gi">+ // middlewares
+ container.bind(TYPES.FetchUserMiddleware).to(FetchUserMiddleware);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Désormais nous pouvons utiliser ce middleware dans notre contrôleur en ajoutant <code>TYPE.FetchUserMiddleware</code> au décorateur. Voici donc la modification :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">httpDelete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">destroy</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pas mal non ? Commitons les modifications avant d&#8217;aller plus loin :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Factorize user controller with middleware"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hashage_du_mot_de_passe">Hashage du mot de passe</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_la_théorie">La théorie</h3>
<div class="paragraph">
<p>Nous allons utiliser la librairie de base de Node.js : <a href="https://nodejs.org/api/crypto.html">Crypto</a>. Voici un exemple d&#8217;une méthode pour hasher le mot de pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">));</span>
<span class="c1">// =&gt; 51e649c92c8edfbbd8e1c17032...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà! Pour savoir si le mot de passe correspond il suffit de vérifier si le hash correspond au précédent :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">password</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">hash</span> <span class="o">===</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; 51e649c92c8edfbbd8e1c17032...</span>

<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; true</span>
<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">wrong password</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Impeccable. Il y a néanmoins un petit problème avec ce type de méthode.</p>
</div>
<div class="paragraph">
<p>Si vos mots de passe fuite, il sera assez facile à retrouver le mot de passe correspondant en construisant un <strong>bibliothèque de hash</strong>. Concrètement, le malveillant utiliserait les mots de passe courant, les hasherai un par avec le même algorithme et les comparerait aux notre. Pour corriger cela, il faut utiliser un sel de hashage.</p>
</div>
<div class="paragraph">
<p>Le sel de hachage consiste a rajouter un texte définis à chaque mot de passe. Voici la modification :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">my private salt</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">salt</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">password</span><span class="p">}</span><span class="s2">_</span><span class="p">${</span><span class="nx">salt</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">hash</span> <span class="o">===</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span><span class="c1">// =&gt; 3fdd2b9c934cd34c3150a72fb4c98...</span>

<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">$uper_u$er_p@ssw0rd</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; true</span>
<span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">wrong password</span><span class="dl">"</span><span class="p">);</span><span class="c1">// =&gt; false</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà ! Le fonctionnement est le même mais notre application est plus sécurisée. Si quelqu&#8217;un accedait à notre base de données, il faudrait qu&#8217;il ait en possession le <strong>sel de hachage</strong> pour retrouver les mots de passe correspondant.</p>
</div>
</div>
<div class="sect2">
<h3 id="_limplémentation">L&#8217;implémentation</h3>
<div class="paragraph">
<p>Maintenant que nous avons vu la théorie, passons à la pratique. Nous allons utiliser les mêmes méthodes dans un fichier <code>password.utils.ts</code>. C&#8217;est parti:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/password.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">createHash</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">salt</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">my private salt</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">salt</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="dl">"</span><span class="s2">sha256</span><span class="dl">"</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">password</span><span class="p">}</span><span class="s2">_</span><span class="p">${</span><span class="nx">salt</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">hash</span> <span class="o">===</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons maintenant utiliser la méthode <code>hashPassword</code> dans l&#8217;entité <code>User</code>. Avec TypeORM c&#8217;est très facile en utilisant les hooks comme nous l&#8217;avons fait avec la validation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">hashPassword</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/password.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">IsDefined</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">hashedPassword</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="kd">set</span> <span class="nx">password</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hashedPassword</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quelques explications s&#8217;imposent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nous avons crée un attribut <code>hashedPassword</code> qui contient le mot de passe de l&#8217;utilisateur hashé. Cette valeur sera sauvegardée en base car nous avons ajouté le décorateur <code>@column</code>. Nous en aurons besoin plus tard pour savoir si le mot de passe fournis par l&#8217;utilisateur correspond a celui qu&#8217;il avait définit</p>
</li>
<li>
<p>l&#8217;attribut <code>password</code> devient un <strong>setter</strong>. C&#8217;est comme un attribut virtuel qui va être appelé lors de l&#8217;assignation. Ainsi en faisant <code>user.password = 'toto'</code>, cette méthode sera appelé. C&#8217;est parfait car nous ne voulons plus le stocker le mot de passe au cas ou notre base de données fuite.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maintenant essayons de créer un utilisateur via l&#8217;API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span>  http://localhost:3000/users
<span class="o">{</span><span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"password"</span>:<span class="s2">"test"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"8574a23599216d7752ef4a2f62d02b9efb24524a33d840f10ce6ceacda69777b"</span>,<span class="s2">"id"</span>:1<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tout semble parfaitement fonctionner car on voit que l&#8217;utilisateur possède bien un mot de passe hashé. Si on change le mot de passe, le hash change correctement :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> PUT   <span class="nt">-d</span> <span class="s2">"password=helloWorld"</span>  http://localhost:3000/users/4
<span class="o">{</span><span class="s2">"id"</span>:4,<span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"bdbe865951e5cd026bb82a299e3e1effb1e95ce8c8afe6814cecf8fa1e895d1f"</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tout marche parfaitement bien. Faisons un commit avant d&#8217;aller plus loin.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Hash user password"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mise_en_place_dun_test_unitaire">Mise en place d&#8217;un test unitaire</h3>
<div class="paragraph">
<p>Nous avons un code qui fonctionne et c&#8217;est cool. Si nous pouvons nous assurer qu&#8217;il fonctionne comme cela à chaque évolution c&#8217;est encore mieux. C&#8217;est donc ici qu&#8217;interviennent les <strong>tests unitaires</strong>.</p>
</div>
<div class="paragraph">
<p>Le rôle du test unitaire est de s&#8217;assurer que notre méthode fonctionne toujours de la même façon que nous l&#8217;avons décidé. Nous allons donc ici mettre en place un test simpliste pour s&#8217;assurer que tout fonctionne bien.</p>
</div>
<div class="paragraph">
<p>Il existe plusieurs librairie de tests en JavaScript. J&#8217;ai choisi <code>Mocha</code> car c&#8217;est une des librairie les plus populaire et elle se met très facilement en place. Nous installons aussi <code>ts-mocha</code> qui va transpiler le TypeScript à la volée :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>mocha ts-mocha @types/mocha <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il faut aussi modifier un peut notre <code>tsconfig.json</code> pour ajouter les déclaration de de Mocha et spécifier à Typescript de ne pas compiler ces fichier :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">{</span>
  "compilerOptions": {
    // ..
    "types": [
      "node",
<span class="gi">+      "mocha"
</span>    ],
    // ...
  },
<span class="gi">+   "exclude": ["./**/*.spec.ts"]
</span><span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous voici prêt à créer notre premier test :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.spec.ts</span>
<span class="k">import</span> <span class="nx">assert</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">assert</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">hashPassword</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/password.utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">User</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should hash password</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">expected</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">hashedPassword</span><span class="p">,</span> <span class="nx">expected</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme je vous le disait, c&#8217;est un test vraiment très simple. Ajoutons maintenant la commande qui va nous permettre de lancer ce test dans le fichier <code>package.json</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">{</span>
  // ...
  "scripts": {
    "start": "tsc &amp;&amp; node dist/main.js",
    "start:watch": "nodemon",
<span class="gi">+     "test": "DOTENV_CONFIG_PATH=.test.env ts-mocha -r reflect-metadata -r dotenv/config src/**/*.spec.ts",
</span>    "build": "tsc"
  },
  // ...
<span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Quelques explications sur cette commande:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-r reflect-metadata</code> charge la librairie <code>reflect-metadata</code> et nous évite de l&#8217;importer manuellement</p>
</li>
<li>
<p><code>-r dotenv/config</code> charge la librairie <code>dotenv</code> pour ainsi avoir les variables d&#8217;environnement de TypeORM</p>
</li>
<li>
<p><code>DOTENV_CONFIG_PATH</code> va charger un fichier <code>.env</code> particulier que nous allons créer juste après</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lorsque nous testons notre application, nous ne voulons pas polluer notre base de données avec des données que nous créons pendant les tests. C&#8217;est donc une bonne pratique de créer une base de donnée dédiée. Dans notre cas, nous allons utiliser une base SQLite <em>in memory</em>. C&#8217;est a dire qu&#8217;elle n&#8217;est pas stockée sur le disque dur mais directement dans la mémoire vive. Voici donc le fichier <code>.test.env</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="env">TYPEORM_CONNECTION=sqlite
TYPEORM_DATABASE=:memory:
TYPEORM_LOGGING=true
TYPEORM_SYNCHRONIZE=true
TYPEORM_ENTITIES=src/entities/*.entity.ts</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
La directive <code>TYPEORM_ENTITIES</code> pointe aussi les fichier Typescript car <code>ts-mocha</code> transpile et execute directement ces fichiers.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Et voilà. Nous pouvons maintenant exécuter ce test :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test

  </span>User
    ✓ should <span class="nb">hash </span>password


  1 passing <span class="o">(</span>5ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et tant qu&#8217;à faire, nous pouvons aussi ajouter un autre test unitaire sur la méthode de comparaison du mot de passe <code>isPasswordMatch</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/password.utils.spec.ts</span>
<span class="k">import</span> <span class="nx">assert</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">assert</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">hashPassword</span><span class="p">,</span> <span class="nx">isPasswordMatch</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./password.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">isPasswordMatch</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hashPassword</span><span class="p">(</span><span class="dl">"</span><span class="s2">good</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should match</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">good</span><span class="dl">"</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not match</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="dl">"</span><span class="s2">bad</span><span class="dl">"</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Encore une fois, ce genre de test peut vous sembler simpliste mais ils sont très rapide et permettent d&#8217;avoir une sécurité supplémentaire. Lançons les tests :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  User
    ✓ should <span class="nb">hash </span>password

  isPasswordMatch
    ✓ should match
    ✓ should not match


  3 passing <span class="o">(</span>6ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que vous êtes échauffé, commitons et passons à la suite :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add unit test about password hash"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ajout_des_tests_fonctionnels">Ajout des tests fonctionnels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maintenant que nous avons mis en place des tests unitaires, il est temps de mettre en place les <strong>tests fonctionnels</strong>. Ce type de test va  tester des fonctionnalités plutôt que des méthodes.</p>
</div>
<div class="paragraph">
<p>Une bonne pratique que j&#8217;ai appris en développant avec le <em>framework</em> Ruby on Rails est de tester le comportement des contrôleurs. C&#8217;est très facile car il suffit d&#8217;appeler un <em>endpoint</em> avec des paramètres et de vérifier le résultat. Ainsi par exemple, si j&#8217;envoie une requête de Type <code>GET</code> sur la route <code>/users</code> je dois m&#8217;attendre à recevoir une liste d&#8217;utilisateur. La librairie <a href="https://www.npmjs.com/package/supertest">supertest</a> nous permet de faire cela sans même démarrer le serveur.</p>
</div>
<div class="paragraph">
<p>Installons donc cette librairie:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>supertest @types/supertest <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant créons notre agent qui sera utilisé dans tous nos tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/tests/supertest.utils.ts</span>
<span class="k">import</span> <span class="nx">supertest</span><span class="p">,</span> <span class="p">{</span> <span class="nx">SuperTest</span><span class="p">,</span> <span class="nx">Test</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">supertest</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">server</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">agent</span><span class="p">:</span> <span class="nx">SuperTest</span><span class="o">&lt;</span><span class="nx">Test</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">supertest</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant commençons pas créer notre premier test pour la méthode <code>index</code> par exemple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">agent</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/supertest.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should respond 200</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le test est vraiment très simple et la syntaxe de <code>supertest</code> rend le test très lisible. Ce test veut dire "envoie une requête HTTP de type <code>Get</code> et attends toi à recevoir une réponse de type `200`". Essayons de lancer les tests</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  UsersController
    index
      ✓ should respond 200
...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
les requêtes SQL de TypeORM sont peut être loggé chez vous car nous avons laissé la directive <code>TYPEORM_LOGGING=true</code>. Vous pouvez la passer à <code>false</code> pour ne plus les voir.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Maintenant voici le même tests pour <code>create</code>. Celui-ci est différent car il envoie des paramètres HTTP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="c1">// ..</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should create user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">@test.io`</span><span class="p">;</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">toto</span><span class="dl">"</span> <span class="p">}).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create user with missing email</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">@test.io`</span><span class="p">;</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/users</span><span class="dl">"</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">email</span> <span class="p">}).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>new Date().getTime()</code> renvoie un <code>Number</code> du nombre de millisecondes écoulées depuis le 01/01/1970. Je l&#8217;utilise afin d&#8217;avoir un nombre unique. Nous verrons plus loins comment améliorer cela.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ici nous testons deux choses:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>si l&#8217;on envoie les bonnes informations, on doit avoir un retour de type <code>200</code></p>
</li>
<li>
<p>si l&#8217;on ne spécifie pas de mot de passe, on doit avoir un retour de type <code>400</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce test est très simple et vous pouvez en rajouter d&#8217;autres comme <em>"should not create user with invalid email"</em> par exemple. Ces tests sont faciles à mettre en place et <strong>valident un comportement global</strong>.</p>
</div>
<div class="paragraph">
<p>Vous pouvez maintenant commiter les changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>git add <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Add functional tests"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_3">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh vous êtes là! Bien joué! Je sais que c’était probablement le chapitre le plus long mais n’abandonnez pas!</p>
</div>
<div class="paragraph">
<p>Si vous n&#8217;avez pas l&#8217;habitude d&#8217;utiliser des tests, nous verrons dans le chapitre comment les utiliser pour définir à l&#8217;avance le comportement que nous souhaitons avant même de coder les fonctionnalité. Nous mettrons donc en place les tests pour les méthodes <code>show</code>, <code>update</code> et <code>destroy</code> qui auront besoin d&#8217;une authentification. En d&#8217;autres termes, nous commencerons à faire du développement dirigé par les tests <em>Test Driven Development</em>. Il s&#8217;agit très certainement de la partie la plus importante du livre!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter04-authentification" class="sect0">Authentification des utilisateurs</h1>
<div class="openblock partintro">
<div class="content">
Dans ce chapitre, les choses vont devenir plus intéressantes. Nous allons mettre en place notre mécanisme d’authentification. À mon avis, ce sera l’un des chapitres les plus intéressants car nous allons introduire beaucoup de nouveaux concepts. A la fin, vous aurez un système d’authentification simple mais puissante. Ne paniquez pas, nous y arriverons.
</div>
</div>
<div class="sect1">
<h2 id="_sessions_sans_état">Sessions sans état</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Avant d’aller plus loin, quelque chose doit être clair: une API ne gère pas les sessions. Cela peut paraître un peu fou si vous n’avez pas d’expérience dans la création de ce genre d’applications. Une API doit être sans état. Ce qui signifie, par définition, qu’une API qui fournit une réponse après votre demande ne nécessite aucune autre attention. Cela a pour conséquence qu’aucun état antérieur ou futur n’est nécessaire pour que le système fonctionne.</p>
</div>
<div class="paragraph">
<p>Le processus d’authentification de l’utilisateur via une API est très simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Le client demande une ressource de sessions avec les informations d’identification correspondantes (généralement un e-mail et un mot de passe).</p>
</li>
<li>
<p>Le serveur renvoie la ressource utilisateur avec son jeton d’authentification correspondant.</p>
</li>
<li>
<p>Pour chaque page qui nécessite une authentification, le client doit envoyer ce jeton d’authentification.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dans cette section et la suivante, nous nous concentrerons sur la construction d’un contrôleur de sessions avec ses actions correspondantes. Nous compléterons ensuite le flux de demandes en ajoutant l’accès d’autorisation nécessaire.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_présentation_de_json_web_token">Présentation de JSON Web Token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lorsqu’on parle de jeton d’authentification, un standard existe: le JSON Web Token (JWT).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>JWT est un standard ouvert défini dans la RFC 75191. Il permet l’échange sécurisé de jetons (tokens) entre plusieurs parties. – <a href="https://fr.wikipedia.org/wiki/JSON_Web_Token">Wikipédia</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Globalement, un jeton JWT est composé de trois parties :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un en-tête structuré en JSON qui contiendra par exemple la date de validité du jeton.</p>
</li>
<li>
<p>un payload structuré en JSON qui peut contenir n’importe quelle donnée. Dans notre cas, il contiendra l’identifiant de l’utilisateur "connecté".</p>
</li>
<li>
<p>une signature qui nous permettra de vérifier que le jeton a bien été chiffré par notre application et donc qu’il est valide.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces trois parties sont chacune encodées en base64 puis concaténées en utilisant des points (.). Ce qui nous donne quelque chose comme ça:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</pre>
</div>
</div>
<div class="paragraph">
<p>Une fois décodé, ce jeton nous donne les informations suivantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l&#8217;en tête</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w"> </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="p">,</span><span class="w"> </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>le payload</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w"> </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234567890"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w"> </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour plus d’information à propos des jetons JWT je vous invite à consulter <em>jxt.io</em>.</p>
</div>
<div class="paragraph">
<p>Cela possède beaucoup d’avantages comme par exemple le fait d’envoyer des informations au consommateur de l’API directement dans le token. On pourra par exemple choisir d’intégrer les informations de l’utilisateur dans le payload.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mise_en_place_du_jeton_dauthentification">Mise en place du jeton d’authentification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La norme JWT possède beaucoup d’implémentation dans des langages et des librairies diverses. Bien entendu, il existe une librairie Nodejs à ce sujet: <a href="https://github.com/auth0/node-jsonwebtoken">node-jsonwebtoken</a>.</p>
</div>
<div class="paragraph">
<p>Commençons donc par l’installer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>jsonwebtoken
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">--save-dev</span> @types/jsonwebtoken</code></pre>
</div>
</div>
<div class="paragraph">
<p>La libraire s&#8217;utilise très facilement avec la méthode <code>jwt.sign</code> et <code>jwt.verify</code>. Voici un exemple :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="k">import</span> <span class="p">{</span><span class="nx">sign</span><span class="p">,</span> <span class="nx">verify</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">JWT_PRIVATE_KEY</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">123456789</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">};</span>
<span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">JWT_PRIVATE_KEY</span><span class="p">,</span> <span class="p">{</span> <span class="na">expiresIn</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1 day</span><span class="dl">"</span> <span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">JWT_PRIVATE_KEY</span><span class="p">));</span>
<span class="c1">// =&gt; { userId: 1, iat: 1605730716, exp: 1605817116 }</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lors de la première ligne nous avons encodé un <code>payload</code> avec la clé secrète <code>JWT_PRIVATE_KEY</code>. Nous obtenons donc un jeton que nous pouvons décoder, tout simplement. La deuxième ligne s&#8217;occupe de décoder le jeton et nous voyons que nous retrouvons bien notre <code>payload</code>.</p>
</div>
<div class="paragraph">
<p>Nous allons maintenant englober toute cette logique dans une classe <code>JsonWebTokenService</code>. Cela nous permettra d&#8217;éviter de dupliquer le code. Cette classe s&#8217;occupera juste d&#8217;encoder et de décoder les jetons JWT. Voici donc l&#8217;implémentation :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/jsonWebToken.service.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">sign</span><span class="p">,</span> <span class="nx">verify</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">JsonWebTokenService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">JWT_PRIVATE_KEY</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">123456789</span><span class="dl">"</span><span class="p">;</span>

  <span class="nx">encode</span><span class="p">(</span><span class="nx">payload</span><span class="p">:</span> <span class="nb">Object</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">JWT_PRIVATE_KEY</span><span class="p">,</span> <span class="p">{</span> <span class="na">expiresIn</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1 day</span><span class="dl">"</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Object</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">JWT_PRIVATE_KEY</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est très simple. Une méthode encode un payload, l&#8217;autre le décode. Comme ce service est injecatble, nous devont l&#8217;enregistrer dans le container.</p>
</div>
<div class="listingblock">
<div class="title">Ajout du <code>Symbol</code> pour le service <code>JsonWebTokenService</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">JsonWebTokenService</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">JsonWebTokenService</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ajout du service <code>JsonWebTokenService</code> dans le <em>container</em></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">JsonWebTokenService</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Nous pouvons même ajouter un petit test rapide qui va encoder et décoder un <em>payload</em> et vérifier que nous retrouvons bien le contenu:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/jsonWebToken.service.spec.ts</span>
<span class="k">import</span> <span class="nx">assert</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">assert</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">JsonWebTokenService</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should encode and decode payload</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce test est un peu plus long que les autres car nous devons <strong>récupérer une instance</strong> de <code>JsonWebTokenService</code> via la <code>container</code>. Pour ce faire, nous utiliser la méthode <code>before</code> qui va être exécutée avant notre batterie de test.</p>
</div>
<div class="paragraph">
<p>Voyons maintenant si tous nos tests passent :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  JsonWebTokenService
    ✓ should encode and decode payload
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est parfait. Commitons et passons à la suite :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Create JsonWebTokenService"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_contrôleur_de_jetons">Le contrôleur de jetons</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons donc mis en place le système de génération d&#8217;un jeton JWT. Il est maintenant temps de créer une route qui va générer ce jeton. Les actions que nous allons implémenter seront gérées en tant que services <em>RESTful</em>: la connexion sera gérée par une demande <code>POST</code> à l’action <code>create</code>.</p>
</div>
<div class="paragraph">
<p>Avant de passer à l&#8217;implémentation, nous allons essayer d&#8217;écrire un test complet.</p>
</div>
<div class="sect2">
<h3 id="_mise_en_place_du_tests_fonctionnel">Mise en place du tests fonctionnel</h3>
<div class="paragraph">
<p>Ici nous allons tester l'<em>endpoint</em> que nous alloons créer juste après. Cet <em>endpoint</em> prendra en paramètre l&#8217;email et le mot de passe de l&#8217;utilisateur. Nous pouvons donc tester trois choses:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>l&#8217;utilisateur a envoyé les bonnes informations donc on renvoie un token</p>
</li>
<li>
<p>le mot de passe est erroné donc on renvoie une erreur <code>400 - Bad request</code></p>
</li>
<li>
<p>l&#8217;utilisateur n&#8217;existe pas donc on renvoie une erreur <code>400 - Bad request</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Nous renvoyons un code <code>400</code> sans donner plus d&#8217;explications. En effet, nous ne voulons pas indiquer à l&#8217;utilisateur que cet email n&#8217;est pas présent en base. C&#8217;est une bonne pratique qui compliquerai un peu plus une attaque par force-brute sur un utilisateur.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Forcément, le test va commencer par créer un utilisateur. C&#8217;est ce qu&#8217;on va faire dans la méthode <code>before</code></p>
</div>
<div class="listingblock">
<div class="title">Création d&#8217;une partie du test fonctionnel de <code>TokensController</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">TokensController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">@test.io`</span><span class="p">;</span>
    <span class="nx">newUser</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">p@ssw0rd</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
on stock la variable <code>user</code> en dehors de la méthode <code>before</code> afin de pouvoir l&#8217;utiliser plus tard.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Maintenant nous n&#8217;avons plus qu&#8217;a écrire nos tests</p>
</div>
<div class="listingblock">
<div class="title">Création du test fonctionnel de <code>TokensController</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">agent</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/supertest.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">TokensController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should get token</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">p@ssw0rd</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not get token user with bad password</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bad password</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create token with nonexisting email</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bad password</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Comme nous travaillons en développement dirigé par les tests, a ce moment nos tests ne passent pas :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  1<span class="o">)</span> TokensController
       create
         should get token:
     Error: expected 200 <span class="s2">"OK"</span>, got 404 <span class="s2">"Not Found"</span>
...
  2<span class="o">)</span> TokensController
       create
         should not get token user with bad password:
     Error: expected 400 <span class="s2">"Bad Request"</span>, got 404 <span class="s2">"Not Found"</span>
...
  3<span class="o">)</span> TokensController
       create
         should not create token with nonexisting email:
     Error: expected 400 <span class="s2">"Bad Request"</span>, got 404 <span class="s2">"Not Found"</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notre but dans la prochaine section sera de faire passer ces tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implémentation">Implémentation</h3>
<div class="paragraph">
<p>Nous allons donc créer le contrôleur <code>TokenController</code>. Commençons par créer le contôleur avec les dépendances nécessaire:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>DatabaseService</code> pour récupérer l&#8217;utilisateur qui correspond à l&#8217;email</p>
</li>
<li>
<p><code>JsonWebTokenService</code> pour créer un jeton JWT</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Création du contrôleur <code>TokensController</code> avec les dépendances nécessaire</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">TokensController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">database</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et on ajoute maintenant ce contrôleur à container afin qu&#8217;il soit chargé:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../controllers/tokens.controller</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant il ne nous reste plus qu&#8217;à ce concentrer sur la méthode <code>create</code> de notre contrôleur</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/tokens.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">httpPost</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">isPasswordMatch</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/password.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tokens</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">TokensController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">""</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="p">{</span> <span class="nl">email</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span> <span class="nl">password</span><span class="p">:</span> <span class="kr">string</span> <span class="p">},</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isPasswordMatch</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">hashedPassword</span><span class="p">,</span> <span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span>
        <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="na">email</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">token</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oula! Ce ce code à l&#8217;air compliqué mais il est en fait très simple :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>on crée une méthode <code>create</code> dans le contrôleur qui va s&#8217;occuper de créer un token pour l&#8217;utilisateur demandé</p>
</li>
<li>
<p>cette méthode utilise le <code>userRepository</code> pour récupérer l&#8217;utilisateur à partir de l&#8217;email donné. Si nous ne trouvons pas l&#8217;utilisateur, nous renvoyons une erreur <code>400 - Bad request</code></p>
</li>
<li>
<p>nos utilisons la méthode <code>isPasswordMatch</code> pour vérifier si le mot de passe correspond au hash que nous avons stoqué. Si c&#8217;est le cas, nous créons et renvoyons un jeton avec la méthode <code>jsonWebTokenService.encode</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Toujours là ? Essayons de lancer les tests pour voir si notre code fonctionne:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  TokensController
    create
      ✓ should get token <span class="o">(</span>41ms<span class="o">)</span>
      ✓ should not get token user with bad password
      ✓ should not create token with nonexisting email</code></pre>
</div>
</div>
<div class="paragraph">
<p>Essayons la logique dans le terminal. Créons un utilisateur (si ce n&#8217;est pas déja fait) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users
<span class="o">{</span><span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"8574a23599216d7752ef4a2f62d02b9efb24524a33d840f10ce6ceacda69777b"</span>,<span class="s2">"id"</span>:1<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite demandons le jeton pour celui-ci :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/tokens
<span class="o">{</span><span class="s2">"token"</span>:<span class="s2">"eyJhbGciOiJIUzI1NiI..."</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oura! Essayons avec un mot de passe erroné :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=azerty"</span> http://localhost:3000/tokens
Bad Request</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est parfait !</p>
</div>
<div class="paragraph">
<p>Comittons et passons à la suite :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Create token controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_utilisateur_connecté">Utilisateur connecté</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons donc mis en place la logique suivante: l’API retourne un jeton d’authentification si les paramètres passés d&#8217;authentification sont corrects.</p>
</div>
<div class="paragraph">
<p>Nous allons maintenant implémenter la logique suivante: A chaque fois que ce client demandera une page protégée, nous devrons retrouver l’utilisateur à partir de ce jeton d’authentification que l’utilisateur aura passé dans l’en-tête HTTP.</p>
</div>
<div class="paragraph">
<p>Dans notre cas, nous utiliserons l’en-tête HTTP <code>Authorization</code> qui est souvent utilisé pour ça. Personnellement, je trouve que c’est la meilleure manière parce que cela donne un contexte à la requête sans polluer l’URL avec des paramètres supplémentaires.</p>
</div>
<div class="paragraph">
<p>Cette action sera centrale à notre application et sera utilisée un peu partout. Il est donc assez logique de créer un <em>middleware</em> dédié. Comme nous l&#8217;avons plus tôt. Mais avant de passer au code, nous allons définir le comportement que nous souhaitons.</p>
</div>
<div class="sect2">
<h3 id="_mise_en_place_du_test_fonctionnel">Mise en place du test fonctionnel</h3>
<div class="paragraph">
<p>Le fonctionnement que nous souhaitons mettre en place est le suivant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>il n&#8217;y a pas besoin de jeton pour créer un utilisateur car c&#8217;est l&#8217;étape d&#8217;inscription</p>
</li>
<li>
<p>il faut un jeton d&#8217;authentification pour consulter ou modifier un utilisateur</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maintenant qu nous avons définis cela, nous pouvons créer notre test fonctionnel.</p>
</div>
<div class="paragraph">
<p>Nous reprenons le test <code>users.controller.spec.ts</code> et nous allons efin implémenter les tests pour <code>show</code>, <code>update</code> et <code>destroy</code>.</p>
</div>
<div class="paragraph">
<p>Ces trois tests nécessitent qu&#8217;on ai déjà un utilisateur en base. Nous allons créer un méthode <code>utils</code> qui va générer un utilisateur aléatoire:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">randomBytes</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">randomBytes</span><span class="p">(</span><span class="nx">size</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">?:</span> <span class="nx">User</span><span class="p">):</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
  <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="nx">user</span><span class="p">?.</span><span class="nx">email</span> <span class="o">??</span> <span class="s2">`</span><span class="p">${</span><span class="nx">randomString</span><span class="p">()}</span><span class="s2">@random.io`</span><span class="p">;</span>
  <span class="nx">newUser</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">newUser</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">newUser</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette méthode est très simple et va juste s&#8217;appuyer sur <code>randomBytes</code> du <a href="https://nodejs.org/docs/latest-v14.x/api/crypto.html">module <code>crypto</code></a> pour génerer une adresse email totalement aléatoire.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
il existe des librairies comme <a href="https://github.com/marak/Faker.js/">Faker.js</a> qui permettent de faire ça mais ici je préfère m&#8217;en passer pour simplifier l&#8217;exemple.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Maintenant nous pouvons revenir à notre test et créer un utilisateur dans la méthode <code>before</code>:</p>
</div>
<div class="listingblock">
<div class="title">Création d&#8217;un user pour le test <code>show</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant il ne nous reste plus qu&#8217;à essayer d&#8217;accéder à cette utilisateur via <code>GET /users/1</code> avec et sans jeton JWT:</p>
</div>
<div class="listingblock">
<div class="title">Tests fonctionnels de la méthode <code>UsersController.show</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>
  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not show user other user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous le voyez les tests restent vraiment très simple. On vérifie simplement le code du status HTTP de la réponse.</p>
</div>
<div class="paragraph">
<p>Le principe est exactement le même pour la méthode <code>update</code> et <code>destroy</code>:</p>
</div>
<div class="listingblock">
<div class="title">Tests fonctionnels de la méthode <code>UsersController.show</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">update</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ... create user on `before`</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not update other user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should update my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">password</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">destroy</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ... create user on `before`</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not destroy other user</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should delete my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. SI vous executez les tests à ce moment précis vous allez avoir un paquet d&#8217;erreurs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
// ...
UsersController
    index
      ✓ should respond 200
    show
      1<span class="o">)</span> should not show user other user
      2<span class="o">)</span> should show my profile
    create
      ✓ should create user
      ✓ should not create user with missing email
    update
      3<span class="o">)</span> should not update other user
      4<span class="o">)</span> should update my profile
    destroy
      5<span class="o">)</span> should not destroy other user
      6<span class="o">)</span> should delete my profile
// ...
  10 passing <span class="o">(</span>226ms<span class="o">)</span>
  6 failing</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est tout à fait normal car nous n&#8217;avons pas encore implémenté la suite. Passons maintenant à l&#8217;implémentation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_création_du_middleware">Création du <em>middleware</em></h3>
<div class="paragraph">
<p>Nous allons donc créer un <em>Middleware</em> <code>FetchLoggerUserMiddleware</code> pour répondre à nos besoins. C’est-à-dire retrouver l’utilisateur grâce à son jeton d’authentification qui est envoyé sur chaque requête.</p>
</div>
<div class="paragraph">
<p>Le principe est assez identique au précédent <em>middleware</em> que nous avons crée plus tôt donc je passe directement à l&#8217;implémentation. De la même manière que le <code>TokenController</code>, on lui injecte</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le <code>jsonWebTokenService</code> pour décoder le jeton JWT</p>
</li>
<li>
<p>le <code>databaseService</code> pour récupérer l&#8217;utilisateur associé au token</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchLoggedUser.middleware.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">BaseMiddleware</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify-express-utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchLoggedUserMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant voici l&#8217;implémentation de la méthode <code>handler</code></p>
</div>
<div class="listingblock">
<div class="title">Implémentation de la méthode <code>handle</code> du <code>FetchLoggedUserMiddleware</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchLoggedUser.middleware.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">NextFunction</span><span class="p">,</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">Response</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchLoggedUserMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">?.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">bearer</span><span class="dl">"</span><span class="p">,</span> <span class="dl">""</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">You must provide an `Authorization` header</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid token</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Encore une fois le code paraît long mais il est en fait très simple :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>on extrais le jeton JWT dans le <em>header</em> <code>Authorization</code>. S&#8217;il n&#8217;est pas définis, on renvoie une erreur <code>403 - Forbidden</code> avec une brève explication</p>
</li>
<li>
<p>on décode le jeton JWT et on récupère l&#8217;utilisateur associé. Si une erreur survient (le jeton ne peut pas être décodé ou l&#8217;utilisateur n&#8217;existe pas), on renvoie une erreur <code>403</code> aussi</p>
</li>
<li>
<p>on injecte l&#8217;utilisateur dans la requête afin qu&#8217;on puisse l&#8217;utiliser dans le contrôleur</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Bien entendu, nous n&#8217;oublions pas d&#8217;ajouter ce <em>middleware</em> à notre conatiner :</p>
</div>
<div class="listingblock">
<div class="title">Ajout du symbole <code>FetchLoggedUserMiddleware</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">FetchLoggedUserMiddleware</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">FetchLoggedUserMiddleware</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ajout du middleware <code>FetchLoggedUserMiddleware</code> dans le container</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../middlewares/fetchLoggedUser.middleware</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ET voilà notre <em>middleware</em> est prêt à être utilisé.</p>
</div>
</div>
<div class="sect2">
<h3 id="_utilisation_du_middleware">Utilisation du middleware</h3>
<div class="paragraph">
<p>Et maintenant il ne nous reste plus qu&#8217;à utiliser le <em>middleware</em> dans le <code>UsersController</code> . Voici par exemple pour la méthode <code>show</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/controllers/home.controller.ts
<span class="err">//</span> ...
<span class="err">@controller('/users')</span>
export class UsersController {
  // ...
<span class="gd">-   @httpGet('/:userId', TYPES.FetchUserMiddleware)
</span><span class="gi">+   @httpGet('/:userId', TYPES.FetchLoggedUserMiddleware)
</span>  public async show(/* ... */) {
<span class="gi">+    if (Number(userId) !== req.user.id) {
+      return res.sendStatus(403);
+    }
</span>    return req.user;
  }
  // ...
<span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, les modifications reste minimes car une partie de la logique est <strong>déportée dans le <em>middleware</em></strong>. Vous pouvez aussi voir que j&#8217;ai mis une vérification très simple pour empêcher un utilisateur de consulter les informations d&#8217;un autre.</p>
</div>
<div class="paragraph">
<p><strong>Le <em>middleware</em> nous a permis de garder une logique très simple dans notre contrôleur.</strong></p>
</div>
<div class="paragraph">
<p>Le principe est exactement le même pour la méthode <code>update</code> et <code>destroy</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="err">//</span> src/controllers/home.controller.ts
<span class="err">//</span> ...
<span class="err">@controller('/users')</span>
export class UsersController {
  // ...
<span class="gd">-  @httpPut('/:userId', TYPES.FetchUserMiddleware)
</span><span class="gi">+  @httpPut('/:userId', TYPES.FetchLoggedUserMiddleware)
</span>  public async update(/* ... */)&gt; {
<span class="gi">+    if (Number(userId) !== req.user.id) {
+      return res.sendStatus(403);
+    }
</span>    // ...
    return repository.save(req.user);
  }

-  @httpDelete('/:userId', TYPES.FetchUserMiddleware)
<span class="gi">+  @httpDelete('/:userId', TYPES.FetchLoggedUserMiddleware)
</span>  public async destroy(/* ... */) {
<span class="gi">+    if (Number(userId) !== req.user.id) {
+      return res.sendStatus(403);
+    }
</span>    const repository = await this.databaseService.getRepository(UserRepository);
    await repository.delete(req.user);
  }
<span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si tout ce passe bien. Nos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test

  </span>TokensController
    create
      ✓ should get token <span class="o">(</span>41ms<span class="o">)</span>
      ✓ should not get token user with bad password
      ✓ should not create token with nonexisting email

  UsersController
    index
      ✓ should respond 200
    show
      ✓ should not show user other user
      ✓ should show my profile
    create
      ✓ should create user
      ✓ should not create user with missing email
    update
      ✓ should not update other user
      ✓ should update my profile
    destroy
      ✓ should not destroy other user
      ✓ should delete my profile

  User
    ✓ should <span class="nb">hash </span>password

  JsonWebTokenService
    ✓ should encode and decode payload

  isPasswordMatch
    ✓ should match
    ✓ should not match


  16 passing <span class="o">(</span>201ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est beau tout ce vert n&#8217;est-ce pas?</p>
</div>
<div class="paragraph">
<p>Essayons de faire la même chose avec <code>cURL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.fr"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/tokens
<span class="o">{</span><span class="s2">"token"</span>:<span class="s2">"eyJhbGciOiJIUzI1NiI..."</span><span class="o">}</span>
<span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Authorization: eyJhbGciOiJIUzI1NiI..."</span> http://localhost:3000/users/1
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"email"</span>:<span class="s2">"test@test.fr"</span>,<span class="s2">"hashedPassword"</span>:<span class="s2">"8574a23599216d7752ef4a2f62..."</span><span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parfait ! et que se passe t&#8217;il si nous essayons d&#8217;accéder à cette route sans autorisation ?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/users/1
You must provide an <span class="sb">`</span>Authorization<span class="sb">`</span> header</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. L&#8217;accès nous a été interdit comme prévu.</p>
</div>
<div class="paragraph">
<p>Il est temps de commiter tous nos changement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add JWT middleware"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_4">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vous l’avez fait! Vous êtes à mi-chemin! Ce chapitre a été long et difficile, mais c’est un grand pas en avant sur la mise en place d’un mécanisme solide pour gérer l’authentification utilisateur et nous commençons même à gratter la surface pour de simples règles d’autorisation.</p>
</div>
<div class="paragraph">
<p>Dans le prochain chapitre, nous nous concentrerons sur la personnalisation de la sortie JSON pour l’utilisateur et l’ajout d’un modèle de produit en donnant à l’utilisateur la possibilité de créer un produit et le publier pour la vente.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter05-user-products" class="sect0">Produits des utilisateurs</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans le chapitre précédent, nous avons implémenté le mécanisme d’authentification que nous allons utiliser tout au long de l’application.</p>
</div>
<div class="paragraph">
<p>Pour l’instant nous avons une implémentation très simple du modèle <code>User</code> mais le moment de vérité est venu. Nous allons personnaliser la sortie JSON et ajouter une deuxième ressource: les produits de l’utilisateur. Ce sont les éléments que l’utilisateur vendra dans l’application.</p>
</div>
<div class="paragraph">
<p>Si vous êtes familier avec un ORM, vous savez peut-être déjà de quoi je parle. Mais pour ceux qui ne le savent pas, nous allons associer le modèle <code>User</code> au modèle <code>Product</code> en utilisant les décorateurs <code>@ManyToOne</code> et <code>@OneToMany</code> de <em>TypeORM</em>.</p>
</div>
<div class="paragraph">
<p>Dans ce chapitre, nous allons construire le modèle de <code>Product</code> à partir de zéro, l’associer à l’utilisateur et créer les entrées nécessaires pour que tout client puisse accéder aux informations.</p>
</div>
<div class="paragraph">
<p>Vous pouvez cloner le projet jusqu’à ce point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter05</code></pre>
</div>
</div>
<div class="paragraph">
<p>Avant de début, et comme d’habitude quand nous commençons de nouvelles fonctionnalités, nous créons une nouvelle branche:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_modèle_du_produit">Le modèle du produit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous commencerons d’abord par créer un modèle de <code>Product</code> puis nous y ajouterons quelques validations et enfin nous l’associerons au modèle <code>User</code>. Comme le modèle <code>User</code>, le <code>Product</code> sera entièrement testé et sera automatiquement supprimé si l’utilisateur est supprimé.</p>
</div>
<div class="sect2">
<h3 id="_les_fondements_du_produit">Les fondements du produit</h3>
<div class="paragraph">
<p>Le modèle <code>Product</code> aura besoin de plusieurs champs: un attribut <code>price</code> pour le prix du produit, un booléen <code>published</code> pour savoir si le produit est prêt à être vendu ou non, un <code>title</code> pour définir un titre de produit sexy, et enfin et surtout un <code>userId</code> pour associer ce produit particulier à un utilisateur:</p>
</div>
<div class="paragraph">
<p>Passons directement à l&#8217;implémentation</p>
</div>
<div class="listingblock">
<div class="title">Création de l&#8217;entité <code>Product</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">validateOrReject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">BeforeInsert</span><span class="p">,</span> <span class="nx">BeforeUpdate</span><span class="p">,</span> <span class="nx">Column</span><span class="p">,</span> <span class="nx">CreateDateColumn</span><span class="p">,</span> <span class="nx">Entity</span><span class="p">,</span> <span class="nx">EntityRepository</span><span class="p">,</span> <span class="nx">ManyToOne</span><span class="p">,</span> <span class="nx">PrimaryGeneratedColumn</span><span class="p">,</span> <span class="nx">Repository</span><span class="p">,</span> <span class="nx">UpdateDateColumn</span><span class="p">,}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm"; import {User} from "./user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">boolean</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">published</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Index</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">,</span> <span class="p">{</span> <span class="na">onDelete</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CASCADE</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">CreateDateColumn</span><span class="p">()</span>
  <span class="nx">createdAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">UpdateDateColumn</span><span class="p">()</span>
  <span class="nx">updatedAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">BeforeUpdate</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">validate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">validateOrReject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous le voyez cela est très lisible. La seule chose nouvelle ici est l&#8217;apparition de la relation <code>ManyToOne</code>. Ceci est un décorateur qui va créer une colonne <code>userId</code> de type <code>int</code>. Il prend trois paramètres:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>une fonction qui renvoie la classe correspondant à l&#8217;association</p>
</li>
<li>
<p>une fonction qui définie comment est spécifié la liaison dans l&#8217;autre sens</p>
</li>
<li>
<p>un object contenant diverses paramètres</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
J&#8217;ai aussi rajouté un décorateur <code>@Index</code> pour que cette colonne soit indexée. C’est une bonne pratique pour les clés d’associations car cela optimise les requêtes de la base de données. Ce n’est pas obligatoire, mais je vous le recommande vivement.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Avant de passer à la suite, nous devons aussi définir l&#8217;association <code>OneToMany</code> dans l&#8217;entité <code>User</code></p>
</div>
<div class="paragraph">
<p>Le fichier de migration devrait ressembler à ceci:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Product</span><span class="p">,</span> <span class="p">(</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
  <span class="nx">products</span><span class="p">:</span> <span class="nx">Product</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Notre association est faite et si vous démarrez le serveur avec les logs des requêtes de TypeORM vous devriez voir la requête SQL qui crée la table:</p>
</div>
<div class="listingblock">
<div class="title">Logs du serveur dans le terminal</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
<span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"product"</span> <span class="p">(</span><span class="nv">"id"</span> <span class="nb">integer</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"title"</span> <span class="nb">text</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"price"</span> <span class="nb">float</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"published"</span> <span class="nb">boolean</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">"createdAt"</span> <span class="nb">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="p">(</span><span class="nb">datetime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">)),</span> <span class="nv">"updatedAt"</span> <span class="nb">datetime</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="p">(</span><span class="nb">datetime</span><span class="p">(</span><span class="s1">'now'</span><span class="p">)),</span> <span class="s1">'userId'</span> <span class="nb">integer</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">CREATE</span> <span class="k">INDEX</span> <span class="nv">"IDX_329b8ae12068b23da547d3b479"</span> <span class="k">ON</span> <span class="nv">"product"</span> <span class="p">(</span><span class="s1">'userId'</span><span class="p">)</span>
<span class="n">query</span><span class="p">:</span> <span class="k">COMMIT</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Faisons un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Generate product model"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validations_des_produits">Validations des produits</h3>
<div class="paragraph">
<p>Comme nous l’avons vu avec l’utilisateur, les validations sont une partie importante lors de la construction de tout type d’application. Cela nous permet d’empêcher toute donnée indésirable d’être enregistrée dans la base de données. Pour le produit, nous devons nous assurer, par exemple, que le prix est un nombre et qu’il n’est pas négatif.</p>
</div>
<div class="paragraph">
<p>Pour cette partie là, nous n&#8217;avons pas besoin de mettre en place des tests car tout est déjà disponible et testé par la librairie <a href="https://github.com/typestack/class-validator/"><code>class-validator</code></a>. Il nous suffit de simplement ajouter les décorateurs correspondants. Voici donc le résultat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IsDefined</span><span class="p">,</span> <span class="nx">IsPositive</span><span class="p">,</span> <span class="nx">validateOrReject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">IsDefined</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span> <span class="na">nullable</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
  <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsPositive</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">IsDefined</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span><span class="p">,</span> <span class="na">nullable</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
  <span class="nx">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">boolean</span><span class="dl">"</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
  <span class="nx">published</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Index</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">,</span> <span class="p">{</span> <span class="na">onDelete</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CASCADE</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les décorateurs documente le code et il n&#8217;y a pas grand chose à ajouter ici. Notez simplement que j&#8217;ai ajouté la propriété <code>nullable: false</code> qui va modifier le schéma de la base de donnée et ajouter une contrainte <code>NOT NULL</code>.</p>
</div>
<div class="paragraph">
<p><em>Commitons</em> ces changements et continuons d’avancer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds some validations to products"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_point_dentrée_pour_nos_produits">Point d’entrée pour nos produits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il est maintenant temps de commencer à construire les points d’entrée des produits. Pour l’instant, nous allons juste construire cinq actions REST.</p>
</div>
<div class="paragraph">
<p>Nous devons d’abord créer le <code>ProductsController</code>. En guise d’échauffement, nous allons commencer par construire l’action du <code>show</code> pour le produit.</p>
</div>
<div class="sect2">
<h3 id="_action_daffichage_dun_produit">Action d’affichage d’un produit</h3>
<div class="sect3">
<h4 id="_tests">Tests</h4>
<div class="paragraph">
<p>Comme d’habitude, nous commençons par ajouter quelques test du contrôleur des produits. Le but ici est très simple. Il suffit d&#8217;afficher un seul produit et de s’assurer que la réponse du serveur est celle que nous attendons.</p>
</div>
<div class="paragraph">
<p>Mais pour cela, nous allons tout d&#8217;abord créer un produit et un utilisateur dans la méthode <code>before</code>. Nous allons donc peaufiner notre utilitaire pour créer des modèles en ajoutant <code>generateProduct</code>:</p>
</div>
<div class="listingblock">
<div class="title">Création de la méthode <code>generateProduct</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">randomBytes</span><span class="p">(</span><span class="nx">size</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">"</span><span class="s2">hex</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateProduct</span><span class="p">(</span><span class="nx">product</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newProduct</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">price</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">price</span> <span class="o">??</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">published</span> <span class="o">??</span> <span class="nx">randomBoolean</span><span class="p">();</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">title</span> <span class="o">??</span> <span class="nx">randomString</span><span class="p">();</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">user</span> <span class="o">??</span> <span class="nx">generateUser</span><span class="p">();</span>

  <span class="k">return</span> <span class="nx">newProduct</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons donc maintenant utiliser cette méthode dans le <code>before</code> du nouveau tests ci-dessous:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">ProductRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">,</span> <span class="nx">UserRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/user.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">JsonWebTokenService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/jsonWebToken.service</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">generateProduct</span><span class="p">,</span> <span class="nx">generateUser</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/faker.utils</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">agent</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/supertest.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant nous pouvons utiliser ce produit et pour tester s&#8217;il est consultable:</p>
</div>
<div class="listingblock">
<div class="title">Test fonctionnel de la méthode <code>ProductsController.show</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implémentation_2">Implémentation</h4>
<div class="paragraph">
<p>Maintenant que notre test est en place, il est temps de faire passer le test.</p>
</div>
<div class="paragraph">
<p>Tout comme nous l&#8217;avons fait avec les utilisateurs, nous allons créer un <em>middleware</em> <code>FetchProductMiddleware</code>. Il s&#8217;occupera juste de récupérer le produit en fonction du paramètre <code>productId</code> et de l&#8217;injecter dans la requête:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchUser.middleware.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchProductMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span>
  <span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">productId</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">productId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">productId</span><span class="p">),</span> <span class="p">{</span> <span class="na">relations</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">]</span> <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">product not found</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La petite nouveauté ici est l&#8217;apparition du paramètre <code>relation</code> de la méthode <code>findOne</code>. Ce paramètre permet de récupérer aussi l&#8217;utilisateur associé au produit et de remplir la propriété <code>product.user</code> qui nous servira un peu plus loin.</p>
</div>
<div class="paragraph">
<p>Nous pouvons maintenant passer au contrôleur:</p>
</div>
<div class="listingblock">
<div class="title">Implémentaion de la méthode <code>ProductController.show</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">})</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Attendez! N’exécutez pas encore les tests. N’oubliez pas que nous devons ajouter la route au container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">FetchProductMiddleware</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">FetchProductMiddleware</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../controllers/products.controller</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FetchProductMiddleware</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, nous nous assurons que les tests passent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    show
      ✓ should show product
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parfait, nous pouvons maintenant passer à la suite.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add logic to show product"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_liste_des_produits">Liste des produits</h3>
<div class="paragraph">
<p>Il est maintenant temps de créer une entrée pour une liste de produits qui pourrait permettre d’afficher le catalogue de produits d’un marché par exemple. Pour ce point d’accès, nous n’exigeons pas que l’utilisateur soit connecté. Comme d’habitude, nous allons commencer à écrire quelques tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should respond 200</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Passons maintenant à la mise en œuvre, qui, pour l’instant, va être une petite méthode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans les chapitres suivants, nous allons améliorer ce point d’entré et donner la possibilité de recevoir des paramètres pour les filtrer. <em>Commitons</em> ces changements et continuons d’avancer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Add logic to list product"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_création_des_produits">Création des produits</h3>
<div class="paragraph">
<p>Créer des produits est un peu plus délicat parce que nous aurons besoin d’une configuration supplémentaire. La stratégie que nous suivrons est d’attribuer le produit créé à l&#8217;utilisateur propriétaire du jeton JWT fourni d&#8217;en l&#8217;en-tête HTTP <code>Authorization</code>.</p>
</div>
<div class="sect3">
<h4 id="_tests_2">Tests</h4>
<div class="paragraph">
<p>Notre premier arrêt sera donc le fichier <code>products.controller.spec.ts</code>. Nous allons tout d&#8217;abord créer un utilisateur spécifique dans le <code>before</code> et récupérer son jeton JWT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons maintenant créer trois tests:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>le cas ou on crée un produit avec un utilisateur</p>
</li>
<li>
<p>le cas ou on ne peut pas créer de produit car il est incomplet</p>
</li>
<li>
<p>le cas ou on ne fournis pas de jeton JWT et nous ne pouvons créer le produit</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>C&#8217;est partit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should create product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create product without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not create user with missing title</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wow! Nous avons ajouté beaucoup de code. Si vous vous souvenez, les tests sont en fait les mêmes que ceux de la création de l’utilisateur excepté quelques changements mineurs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implémentation_3">Implémentation</h4>
<div class="paragraph">
<p>Il est donc temps de faire passer le test. L&#8217;implémentation est encore une fois très similaire à celle précédente dans le contrôleur des utilisateur. A la différence près que ici nous allons récupérer l&#8217;utilisateur associé au jeton JWT et l&#8217;assigner au produit que nous somme en train de créer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">published</span><span class="p">;</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">price</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">price</span><span class="p">;</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Si vous faites les tests maintenant, ils devraient tous passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    index
      ✓ should respond 200
    show
      ✓ should show product
    create
      ✓ should create product
      ✓ should not create product without auth
      ✓ should not create user with missing title
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mise_à_jour_des_produits">Mise à jour des produits</h3>
<div class="paragraph">
<p>J’espère que maintenant vous comprenez la logique pour construire les actions à venir. Dans cette section, nous nous concentrerons sur l’action de mise à jour qui fonctionnera de manière similaire à celle de création. Nous avons juste besoin d’aller chercher le produit dans la base de données et de le mettre à jour.</p>
</div>
<div class="paragraph">
<p>Avant de commencer à coder certains tests je veux juste préciser que, de la même manière que pour l’action <code>create</code>, nous allons délimiter le produit à l’utilisateur courant. Nous voulons nous assurer que le produit que nous mettons à jour appartient bien à l’utilisateur. Nous allons donc chercher ce produit dans l’association <code>product.user</code>.</p>
</div>
<div class="sect3">
<h4 id="_tests_3">Tests</h4>
<div class="paragraph">
<p>Tout d’abord, nous ajoutons quelques tests. Ici nous allons tester trois choses:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>le cas ou l&#8217;utilisateur possède effectivement le produit</p>
</li>
<li>
<p>le cas ou l&#8217;utilisateur ne possède pas le produit et reçoit donc une réponse <code>403 - Forbidden</code></p>
</li>
<li>
<p>le cas sans authentification</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Afin de mettre en place ces tests, nous allons créer un <code>product</code>, un <code>user</code> qui possède le produit et un utilisateur <code>stranger</code> qui sera un utilisateur qui n&#8217;est pas associé au produit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">stranger</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">strangerJwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">stranger</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">strangerJwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">stranger</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela peut paraître abstrait mais regardez l&#8217;implémentation des tests qui vont utiliser ces variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">update</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should update product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not update product of other users</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">strangerJwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not update product without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">();</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">published</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tests peuvent paraître complexes, mais en jetant un coup d’œil, ils sont presque identiques à ceux des utilisateurs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implémentation_4">Implémentation</h4>
<div class="paragraph">
<p>Maintenant implémentons le code pour faire passer nos tests avec succès:</p>
</div>
<div class="listingblock">
<div class="title">Implémentation de la méthode <code>update</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpPut</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">update</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span> <span class="nl">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">published</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">published</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">price</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">validate</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">errors</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">,</span> <span class="nx">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le constater, l’implémentation est assez simple. Les <em>Middleware</em> vont automatiquement récupérer le produit et l&#8217;utilisateur lié au jeton JWT. Il ne nous reste plus qu&#8217;à vérifier que l&#8217;utilisateur possède bien le produit. C&#8217;est ce que nous faisons avec la méthode <code>canEditProduct</code>. Ensuite nous mettons à jour le produit et nous le sauvegardons après avoir vérifié qu&#8217;il est valide bien sûr.</p>
</div>
<div class="paragraph">
<p>Si nous lançons les tests, ils devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    index
      ✓ should respond 200
    show
      ✓ should show product
    create
      ✓ should create product
      ✓ should not create product without auth
      ✓ should not create user with missing title
    update
      ✓ should update product
      ✓ should not update product of other <span class="nb">users</span>
      ✓ should not update product without auth
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_suppression_des_produits">Suppression des produits</h3>
<div class="paragraph">
<p>Notre dernier arrêt pour les route des produits, sera l’action <code>destroy</code>. Vous pouvez maintenant imaginer à quoi cela ressemblerait. La stratégie ici sera assez similaire à l’action de <code>create</code> et <code>update</code>. Ce qui signifie que nous allons récupérer l&#8217;utilisateur connecté puis vérifier que l&#8217;utilisateur possède bien le produit et enfin le supprimer en retournant un code 204.</p>
</div>
<div class="paragraph">
<p>Commençons par ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">destroy</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should destroy product</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not destroy product without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not destroy of other users</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">strangerJwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, ajoutons simplement le code nécessaire pour faire passer les tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpDelete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">destroy</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span> <span class="nl">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">},</span>
    <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span>
      <span class="nx">ProductRepository</span>
    <span class="p">);</span>
    <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">204</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, l’implémentation fait le travail en trois lignes. Nous pouvons lancer les tests pour nous assurer que tout est bon.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
...
    destroy
      ✓ should destroy product
      ✓ should not destroy product without auth
      ✓ should not destroy of other <span class="nb">users</span>
...
  27 passing <span class="o">(</span>344ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Après cela, nous <em>commitons</em> les changements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the products create, update and destroy action"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_essai_avec_curl">Essai avec cURL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nos tests nous indiquent que tout va bien mais c&#8217;est toujours bien de s&#8217;en assurer. Nous allons donc créer un utilisateur puis un produit le mettre à jour et enfin le supprimer. C&#8217;est partit.</p>
</div>
<div class="paragraph">
<p>Démarrez votre serveur avec <code>npm start</code> si ce n&#8217;est déjà fait et commençons par créer un utilisateur:</p>
</div>
<div class="listingblock">
<div class="title">Création de l&#8217;utilisateur</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.io"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/users
<span class="o">{</span>
  <span class="s2">"email"</span>: <span class="s2">"test@test.io"</span>,
  <span class="s2">"hashedPassword"</span>: <span class="s2">"8574a23599216d7752ef4a2f62d02b9efb24524a33d840f10ce6ceacda69777b"</span>,
  <span class="s2">"id"</span>: 1,
  <span class="s2">"createdAt"</span>: <span class="s2">"2020-11-25T20:37:20.000Z"</span>,
  <span class="s2">"updatedAt"</span>: <span class="s2">"2020-11-25T20:37:20.000Z"</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant obtenons un jeton JWT valide:</p>
</div>
<div class="listingblock">
<div class="title">Obtention d&#8217;un jeton d&#8217;authentification</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">"email=test@test.io"</span> <span class="nt">-d</span> <span class="s2">"password=test"</span> http://localhost:3000/tokens
<span class="o">{</span>
  <span class="s2">"token"</span>: <span class="s2">"eyJhbGciOiJ..."</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notez ce jeton et sauvegardons le dans une variable Bash:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">JWT</span><span class="o">=</span><span class="s2">"eyJhbGciOiJ..."</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant utilisons ce jetons pour créer un produit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST  <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="nv">$JWT</span><span class="s2">"</span> <span class="nt">-d</span> <span class="s2">"title=my first product"</span> <span class="nt">-d</span> <span class="s2">"price=1"</span>  http://localhost:3000/products
<span class="o">{</span>
  <span class="s2">"id"</span>: 1,
  <span class="s2">"title"</span>: <span class="s2">"my first product"</span>,
  <span class="s2">"price"</span>: 1,
...
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons le mettre à jour facilement avec le requête <code>PUT</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> PUT  <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="nv">$BASH</span><span class="s2">"</span> <span class="nt">-d</span> <span class="s2">"title=my first product undated"</span> <span class="nt">-d</span> <span class="s2">"price=66"</span>  http://localhost:3000/products/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et enfin supprimer ce produit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> DELETE <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="nv">$JWT</span><span class="s2">"</span> http://localhost:3000/products/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est parfait.</p>
</div>
<div class="paragraph">
<p>Il est donc temps de clôturer ce chapitre et de passer à la suite.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_5">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>J&#8217;espère que vous avez apprécié ce chapitre. C&#8217;est un long travail, mais le code que nous avons créé est une excellente base pour l&#8217;application principale.</p>
</div>
<div class="paragraph">
<p>Dans le chapitre suivant, nous allons nous concentrer sur la personnalisation de la sortie des modèles utilisateur et produits à l’aide de la librairie <a href="https://github.com/SeyZ/jsonapi-serializer">jsonapi-serializer</a>. Elle nous permettra de filtrer facilement les attributs à afficher et à gérer les associations comme des objets embarqués par exemple.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter06-improve-json" class="sect0">Modélisation du JSON</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans le chapitre précédent, nous avons ajouté les produits à l’application et construit toutes les routes nécessaires. Nous avons également associé un produit à un utilisateur et restreint certaines des actions de <code>ProductsController</code>.</p>
</div>
<div class="paragraph">
<p>Maintenant, vous devriez être satisfaits de tout ce travail. Mais nous avons encore du pain sur la planche. Actuellement, nous avons une sortie JSON qui n’est pas parfaite. La sortie JSON ressemble à celle-ci:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tag Case"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mf">98.77</span><span class="p">,</span><span class="w">
    </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"userId"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="w">
  </span><span class="p">},</span><span class="w">
</span><span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or nous voulons une sortie qui ne contienne pas les champs <code>userId</code>, <code>createdAt</code> et <code>updatedAt</code>.</p>
</div>
<div class="paragraph">
<p>De plus, une partie importante et difficile lors de la création de votre API est de décider le format de sortie. Heureusement, certaines organisations ont déjà fait face à ce genre de problème et elles ont ainsi établi certaines conventions que vous allez découvrir dans ce chapitre.</p>
</div>
<div class="paragraph">
<p>Vous pouvez clôner le projet jusqu’à ce point avec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter06</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commençons une nouvelle branche pour ce chapitre:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter06</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_présentation_de_jsonapi">Présentation de <a href="https://jsonapi.org/">JSON:API</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comme je le disais plus tôt, une partie importante et difficile lors de la création de votre API est de décider le format de sortie. Heureusement, certaines conventions existent déjà.</p>
</div>
<div class="paragraph">
<p>L&#8217;une d&#8217;elles, certainement la plus utilisée est <a href="https://jsonapi.org/">JSON:API</a>. La <a href="https://jsonapi.org/format/#document-structure">documentation de JSON:API</a> nous donne quelques règles à suivre concernant le formatage du document JSON.</p>
</div>
<div class="paragraph">
<p>Ainsi, notre document <strong>doit</strong> contenir ces clefs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code> qui doit contenir les données que nous renvoyons</p>
</li>
<li>
<p><code>errors</code> qui doit contenir un tableau des erreurs qui sont survenues.</p>
</li>
<li>
<p><code>meta</code> qui contient un <a href="https://jsonapi.org/format/#document-meta">objet meta</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le contenu de la clé <code>data</code> est lui aussi assez strict:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>il doit posséder une clé `type`qui décrit le type du modèle JSON (si c’est un article, un utilisateur, etc..)</p>
</li>
<li>
<p>les propriétés de l’objet doivent être placées dans une clé <code>attributes</code> et les <em>undescore</em> (<code>_</code>) sont remplacés par des tirets (<code>-</code>)</p>
</li>
<li>
<p>les liaisons de l’objets doivent être placées dans une clé <code>relationships</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans ce chapitre, nous allons personnaliser la sortie JSON en utilisant la librairie <a href="https://github.com/SeyZ/jsonapi-serializer">jsonapi-serializer</a> qui respecte toutes les normes <a href="https://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>Installons donc cette dépendance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>jsonapi-serializer
<span class="nv">$ </span>npm <span class="nb">install</span> @types/jsonapi-serializer <span class="nt">--save-dev</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous devriez être prêts à continuer avec ce tutoriel.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sérialiser_lutilisateur">Sérialiser l’utilisateur</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>jsonapi-serializer</code> utilise des <strong>sérialiseurs</strong>. Les sérialiseurs représentent des méthodes qui seront responsables de convertir un objet en un autre objet respectant la norme JSON:API.</p>
</div>
<div class="paragraph">
<p>Nous devons d’abord ajouter un fichier <code>serializers.utils.ts</code> qui contiendra tous les sérialseurs. Et dans la foulée, je commence directement par l&#8217;implémentation de <code>userSerializer</code>:</p>
</div>
<div class="listingblock">
<div class="title">Création du sérialseur <code>userSerializer</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Serializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonapi-serializer</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">userSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">dataLinks</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">self</span><span class="p">:</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce <em>serializer</em> va nous permettre de convertir notre objet <code>User</code> en JSON qui implémente correctement la norme JSON:API. Nous avons spécifié l&#8217;attribut <code>email</code> afin qu&#8217;il soit présent dans le tableau <code>data</code>. En listant les champs que nous voulons voir apparaître, cette librairie nous corrige le problème de l&#8217;attribut <code>hashedPassword</code> qui était envoyé par notre API.</p>
</div>
<div class="paragraph">
<p>Il ne nous reste plus qu&#8217;à utiliser cette instance dans notre contrôleur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">userSerializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/serializers.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">UsersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">userSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:userId</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">userSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le constater, cela ne change pas grand chose! Nous important simplement notre sérialiseur et nous utilisons sa méthode <code>serialize</code>.</p>
</div>
<div class="paragraph">
<p>Essayons tout cela avec <code>cURL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>curl http://localhost:3000/users</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sortie JSON des utilisateurs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test@test.io"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> ces changements et continuons d’avancer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds user serializer for customizing the json output"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sérialiser_les_produits">Sérialiser les produits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maintenant que nous comprenons comment fonctionne la gemme de sérialisation, il est temps de personnaliser la sortie des produits. La première étape est identique à celle pour l’utilisateur, nous avons besoin d’un sérialiseur de produit, alors faisons-le:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">productsSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">price</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">published</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">],</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Ce n’est pas plus compliqué que cela. Modifions un petit peu notre contrôleur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">productsSerializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/serializers.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">product</span><span class="p">:</span> <span class="nx">Product</span> <span class="p">})</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez lancer les tests pour vérifier mais ils devraient encore être bons. <em>Commitons</em> ces petits changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds product serializer for custom json output"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_sérialiser_les_associations">Sérialiser les associations</h3>
<div class="paragraph">
<p>Nous avons travaillé avec des sérialiseurs et vous remarquerez peut-être que c’est très simple. Dans certains cas, la décision difficile est de savoir comment nommer vos routes ou comment structurer la sortie JSON afin que votre solution soit pérenne. Lorsque vous travaillez avec des associations entre les modèles sur une API, il existe de nombreuses approches que vous pouvez prendre.</p>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons pas à nous soucier de ce problème dans notre cas, la norme JSON:API l&#8217;a fait pour nous!</p>
</div>
<div class="paragraph">
<p>Pour résumer, nous avons une association de type <code>has_many</code> entre l’utilisateur et le modèle de produit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Product</span><span class="p">,</span> <span class="p">(</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
  <span class="nx">products</span><span class="p">:</span> <span class="nx">Product</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">,</span> <span class="p">{</span> <span class="na">onDelete</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CASCADE</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C’est une bonne idée d’intégrer les utilisateurs dans les sortie JSON des produits. Cela rendra la sortie plus lourde mais ça évitera au client de l&#8217;API d&#8217;éxecuter d&#8217;autres requêtes pour récupérer les informations des utilisateurs liées aux produits. Cette méthode peut vraiment vous éviter un énorme goulet d&#8217;étranglement.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_théorie_de_linjection_des_relations">Théorie de l&#8217;injection des relations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imaginez un scénario où vous allez chercher les produits dans l’API, mais dans ce cas, vous devez afficher une partie des informations de l’utilisateur.</p>
</div>
<div class="paragraph">
<p>Une solution possible serait d’ajouter l’attribut <code>user_id</code> au <code>product_serializer</code> pour que nous puissions récupérer l’utilisateur correspondant plus tard. Cela peut sembler être une bonne idée, mais si vous vous souciez de la performance, ou si les transactions de votre base de données ne sont pas assez rapides, vous devriez reconsidérer cette approche. Vous devez comprendre que pour chaque produit que vous récupérez, vous allez devoir récupérer son utilisateur correspondant.</p>
</div>
<div class="paragraph">
<p>Face à ce problème, il y a plusieurs alternatives possibles.</p>
</div>
<div class="sect2">
<h3 id="_intégrer_dans_un_attribut_meta">Intégrer dans un attribut meta</h3>
<div class="paragraph">
<p>Une bonne solution à mon avis est d’intégrer les identifiants des utilisateurs liés aux produits dans un attribut meta, donc nous aurions une sortie JSON comme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"user_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">

  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela peut nécessiter une configuration supplémentaire sur le terminal de l’utilisateur, afin que le client puisse récupérer ses utilisateurs à partir de ces <code>user_ids</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_incorporer_lobjet_dans_lattribut">Incorporer l&#8217;objet dans l&#8217;attribut</h3>
<div class="paragraph">
<p>Une autre solution, est d’incorporer l’objet <code>user</code> dans l’objet <code>product</code>. Ce qui peut rendre la première requête un peu plus lente, mais de cette façon le client n’a pas besoin de faire une autre requête supplémentaire. Un exemple des résultats escomptés est présenté ci-dessous:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le problème de cette approche est que nous devons dupliquer les objets <code>User</code> pour tous les produits qui appartiennent au même utilisateur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="c1">// ...</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="c1">// ...</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="c1">// ...</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="c1">// ...</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_incorporer_les_relation_dans_include">Incorporer les relation dans <code>include</code></h3>
<div class="paragraph">
<p>La troisième solution, choisie par la norme JSON:API, est un mélange des deux premières.</p>
</div>
<div class="paragraph">
<p>Nous allons inclure toutes les relations dans une clé <code>include</code> qui contiendra tous les relations des objets précédemment cités. Aussi, chaque objet inclura une clé <code>relationships</code> définissant la relation et qu&#8217;il faudra retrouver dans la clé <code>include</code>.</p>
</div>
<div class="paragraph">
<p>Un JSON vaut mille mots:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous voyez la différence? Cette solution réduit drastiquement la taille du JSON et donc la bande passante utilisée.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_de_linjection_des_relations">Application de l&#8217;injection des relations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous allons donc incorporer l’objet utilisateur dans le produit. Commençons par ajouter quelques tests.</p>
</div>
<div class="paragraph">
<p>Nous allons simplement modifier le test <code>UsersControllers.show</code> afin de vérifier que nous récupérons:</p>
</div>
<div class="listingblock">
<div class="title">Ajout d&#8217;un test pour controller l&#8217;ajout du <code>include</code> dans la sortie JSON</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/users.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">UsersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">products</span> <span class="o">=</span> <span class="p">[</span><span class="nx">product</span><span class="p">];</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>

  <span class="c1">// ...</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show my profile</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/users/</span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">included</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">products</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">title</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous vérifions maintenant deux choses sur le JSON qui est retourné:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>il contient le titre du produit</p>
</li>
<li>
<p>les données de l&#8217;utilisateur sont incluses dans la clé <code>include</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vous pouvez aussi remarquer que j&#8217;ai créer et lier un produit à l&#8217;utilisateur sauvegardé dans la méthode <code>beforeEach</code>.</p>
</div>
<div class="paragraph">
<p>Pour faire passer ce test nous allons commencer par inclure la relation dans le <em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">userSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">products</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">price</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">published</span><span class="dl">"</span><span class="p">],</span>
    <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span> <span class="k">as</span> <span class="kr">any</span><span class="p">);</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
à l&#8217;heure ou j&#8217;écris ces lignes, je n&#8217;ai pas trouvé d&#8217;autres moyens que le <code>as any</code> pour contourner l&#8217;erreur de <em>typing</em> de TypeScript. Peut être que la librairie sera mse à jour prochainement.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cet ajout aura pour effet de rajouter une clé <code>relationship</code> contenant l’identifiant de l&#8217;utilisateur mais aussi ajouter un clé <code>include</code> qui va contenir la relation. Voici un exemple:</p>
</div>
<div class="listingblock">
<div class="title">Exemple de sortie JSON avec un utilisateur possédant un produit</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="js"><span class="p">{</span>
  <span class="nl">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">16</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ddf1bbe99c3a7ee8@random.io</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">products</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">products</span><span class="dl">'</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">15</span><span class="dl">'</span> <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">included</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">products</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">15</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">adc643eaa6bc1748</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">72.45882186217555</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L’implémentation est très simple: il suffit d’ajouter une ligne au sérialiseur du produit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test

  </span>ProductsController
...
    show
      ✓ should show product
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Faisons un <em>commit</em> pour fêter ça:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add user relationship to product"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_récupérer_lutilisateur_dun_produit">Récupérer l&#8217;utilisateur d&#8217;un produit</h3>
<div class="paragraph">
<p>Vous avez compris le principe? Nous avons inclus les informations de l&#8217;utilisateur dans le JSON des produits.</p>
</div>
<div class="paragraph">
<p>Commençons par le test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show product</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products/</span><span class="p">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">included</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite le <em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">productsSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">products</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">price</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">published</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">],</span>
  <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">included</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">],</span>
  <span class="p">},</span>
<span class="p">}</span> <span class="k">as</span> <span class="kr">any</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et pour terminer le contrôleur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:productId</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchProductMiddleware</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">show</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Nous obtenons un JSON de cette forme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="js"><span class="p">{</span>
  <span class="nl">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">products</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">d358a5c96b94a562</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">price</span><span class="p">:</span> <span class="mf">56.85800753546402</span><span class="p">,</span>
      <span class="na">published</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="na">relationships</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">3</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">included</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">3</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">email</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ddaf230c3d15a057@random.io</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;était vraiment facile. Faisons un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add user relationship to ProductsController.show"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rechercher_les_produits">Rechercher les produits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans cette dernière section, nous continuerons à renforcer l’action <code>Products#index</code> en mettant en place un mécanisme de recherche très simple pour permettre à n’importe quel client de filtrer les résultats. Cette section est facultative car elle n’aura aucun impact sur les modules de l’application. Mais si vous voulez pratiquer davantage avec le TDD, je vous recommande de compléter cette dernière étape.</p>
</div>
<div class="paragraph">
<p>Il existe des librairies pour construire des formulaires de recherche avancée extrêmement rapidement. Mais ici, comme le but est d&#8217;apprendre et que la recherche que nous allons effectuer est très simple, je pense que nous pouvons construire un moteur de recherche à partir de zéro. Nous devons simplement considérer les critères par lesquels nous allons filtrer les attributs. Accrochez-vous bien à vos sièges, ça va être un voyage difficile.</p>
</div>
<div class="paragraph">
<p>Nous filtrerons donc les produits selon les critères suivants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Par titre</p>
</li>
<li>
<p>Par prix</p>
</li>
<li>
<p>Trier par date de création</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cela peut sembler court et facile, mais croyez-moi, cela vous donnera mal à la tête si vous ne le planifiez pas.</p>
</div>
<div class="paragraph">
<p>Nous allons donc ajouter une méthode <code>search</code> au <code>ProductRepository</code> qui prendra en paramètre les filtres que je viens d&#8217;énumérer plus haut:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span>
  <span class="c1">// need to be implemented</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// need to be implemented</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous voyez un peu comment nous allons nous y prendre? Commençons par le premier filtre.</p>
</div>
<div class="sect2">
<h3 id="_les_produits_publiés">Les produits publiés</h3>
<div class="paragraph">
<p>Comme depuis le début de ce livre, nous allons commencer par écrire le test qui va tester notre nouvelle méthode. Voici la structure de base de notre test qui doit vous sembler familière:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">container</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/container.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">ProductRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">DatabaseService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/database.service</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">productRepository</span><span class="p">:</span> <span class="nx">ProductRepository</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// will be implemented</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce tests aura besoin de plusieurs produits déja existants en base de données que nous allons créer à la main. Voici donc la structure de notre test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">ProductRepository</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">generateProduct</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../tests/faker.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">tvPlosmo</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">computer</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">tvCheap</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">unpublishedProduct</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">tvPlosmo</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TV Plosmo Philopp</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">9999.99</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">}));</span>
      <span class="nx">computer</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Azos Zeenbok</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">499.99</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">}));</span>
      <span class="nx">tvCheap</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Cheap TV</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">price</span><span class="p">:</span> <span class="mf">99.99</span><span class="p">,</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="p">}));</span>
      <span class="nx">unpublishedProduct</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span>
        <span class="na">published</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="p">}));</span>
    <span class="p">});</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, nous avons inséré en base 4 produits diverses. Dans notre premier test nous allons appeler notre méthode <code>ProductReposiroty.search</code> sans paramètre et nous allons vérifier que aucun produit non publié ne nous est retourné. Voici le test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should not include unpublished products</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">({}).</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">every</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">published</span><span class="p">));</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et commençons donc par définir notre méthode pour faire passer ce test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span> <span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">()</span>
                      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">"</span><span class="s2">published = TRUE</span><span class="dl">"</span><span class="p">)</span>
                      <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="dl">"</span><span class="s2">updatedAt</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DESC</span><span class="dl">"</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Le test devrait passer. Passons à notre premier filtre.j</p>
</div>
</div>
<div class="sect2">
<h3 id="_par_titre">Par titre</h3>
<div class="paragraph">
<p>Maintenant que la structure de nos tests et de l&#8217;implémentation est en place, tout va aller plus vite. Voici le test pour le filtre qui ressemble beaucoup au précédent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should filter products by title</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">({</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">tv</span><span class="dl">"</span> <span class="p">}).</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvPlosmo</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">computer</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tests suivants s&#8217;assurent que la méthode va rechercher correctement les produits en fonction de leurs titres. Nous utilisons le terme <code>tv</code> en minuscule afin de s&#8217;assurer que notre recherche ne sera pas sensible à la casse.</p>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est très simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span>
  <span class="nl">title</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">title</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">"</span><span class="s2">lower(title) LIKE :title</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="s2">`%</span><span class="p">${</span><span class="nx">filters</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="s2">%`</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L’implémentation est suffisante pour que nos tests passent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
....
  ProductRepository
    search
      ✓ should not include unpublished products
      ✓ should filter products by title
....</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_par_prix">Par prix</h3>
<div class="paragraph">
<p>Pour filtrer par prix, les choses peuvent devenir un peu plus délicates. Nous allons séparer la logique de filtrer par prix en deux méthodes différentes: l’une qui va chercher les produits plus grands que le prix reçu et l’autre qui va chercher ceux qui sont sous ce prix. De cette façon, nous garderons une certaine flexibilité et nous pouvons facilement tester les <em>scope</em>.</p>
</div>
<div class="paragraph">
<p>Commençons par construire les tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductRepository</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should filter products by priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span>
        <span class="p">.</span><span class="nx">search</span><span class="p">({</span><span class="na">priceMax</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvCheap</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvPlosmo</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should filter products by priceMin</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span>
        <span class="p">.</span><span class="nx">search</span><span class="p">({</span><span class="na">priceMin</span><span class="p">:</span> <span class="mi">500</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvPlosmo</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">tvCheap</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L’implémentation est très très simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="kr">interface</span> <span class="nx">ProductSearchFilters</span> <span class="p">{</span>
  <span class="nl">title</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">priceMin</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">priceMax</span><span class="p">?:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Product</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">search</span><span class="p">(</span><span class="na">filters</span><span class="p">:</span> <span class="nx">ProductSearchFilters</span><span class="p">):</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">priceMin</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">"</span><span class="s2">price &gt;= :priceMin</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">priceMin</span><span class="p">:</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">priceMin</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">filters</span><span class="p">.</span><span class="nx">priceMax</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">"</span><span class="s2">price &lt;= :priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">priceMax</span><span class="p">:</span> <span class="nx">filters</span><span class="p">.</span><span class="nx">priceMax</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est suffisant pour que nos tests passent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductRepository
    search
      ✓ should not include unpublished products
      ✓ should filter products by title
      ✓ should filter products by priceMax
      ✓ should filter products by priceMin
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Super. La dernière étape est de l&#8217;intégrer à notre contrôleur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_intégration_dans_le_contrôleur">Intégration dans le contrôleur</h3>
<div class="paragraph">
<p>Comme d&#8217;habitude, nous allons commencer par les tests. Cela va nous aider à définir l&#8217;implémentation de notre <em>endpoint</em>.</p>
</div>
<div class="paragraph">
<p>Comme pour les tests précedents, nous allons créer deux produits spécifiques que nous allons ensuite rechercher via les différents filtres que nous venons d&#8217;implémenter. Le test risque donc de vous sembler très familier.</p>
</div>
<div class="paragraph">
<p>Nous allons définir un nouveau <code>describe</code> qui va regrouper nos deux tests. Commençons par le <code>beforeEach</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="na">computer</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
      <span class="kd">let</span> <span class="na">tvCheap</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

      <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">computer</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
          <span class="nx">generateProduct</span><span class="p">({</span>
            <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Azos Zeenbok</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">price</span><span class="p">:</span> <span class="mf">499.99</span><span class="p">,</span>
            <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="p">})</span>
        <span class="p">);</span>
        <span class="nx">tvCheap</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
          <span class="nx">generateProduct</span><span class="p">({</span>
            <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Cheap TV</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">price</span><span class="p">:</span> <span class="mf">99.99</span><span class="p">,</span>
            <span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="p">})</span>
        <span class="p">);</span>
      <span class="p">});</span>
    <span class="c1">// ...</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant passons aux tests en eux-même:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">ProductsController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">search</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ...</span>
      <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should find cheap TV</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">();</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">tv</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">priceMin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">50</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">150</span><span class="dl">"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">agent</span>
          <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products?</span><span class="p">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nb">String</span><span class="p">(</span><span class="nx">tvCheap</span><span class="p">.</span><span class="nx">id</span><span class="p">))));</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should find computer</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">();</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">azos</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">priceMax</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">500</span><span class="dl">"</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">agent</span>
          <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/products?</span><span class="p">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">some</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">row</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nb">String</span><span class="p">(</span><span class="nx">computer</span><span class="p">.</span><span class="nx">id</span><span class="p">)),</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">body</span>
            <span class="p">);</span>
          <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
nous construisons les paramètres avec la classe <a href="https://developer.mozilla.org/fr/docs/Web/API/URLSearchParams"><code>URLSearchParams</code></a>. Il suffit ensuite d&#8217;utiliser la méthode <code>toString</code> qui va construire les paramètres <code>GET</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lorsque nous recevons la réponse, nous vérifions que le produit recherché est présent dans la réponse. Tout simplement.</p>
</div>
<div class="paragraph">
<p>L&#8217;implémentation dans la contrôleur est simplissime. Il suffit d&#8217;utiliser notre nouvelle méthode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/products</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">).</span><span class="nx">getMany</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">productsSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons exécuter l’ensemble de la suite de tests, pour nous assurer que l’application est en bonne santé jusqu’ici:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test
  </span>ProductsController
    index
      ✓ should respond 200 <span class="o">(</span>47ms<span class="o">)</span>
      search
        ✓ should find cheap TV
        ✓ should find computer
...
  33 passing <span class="o">(</span>786ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Super! <em>Commitons</em> ces changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search class method to filter products"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter06</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_6">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jusqu’à présent, et grâce à la librairie <a href="https://github.com/SeyZ/jsonapi-serializer/">jsonapi-serializer</a>, c’était facile. Sur les chapitres à venir, nous allons commencer à construire le modèle <code>Order</code> qui associera les utilisateurs aux produits.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter07-placing-orders" class="sect0">Création des commandes</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans les chapitres précédents nous avons traité les associations entre les produits et les utilisateurs. Nous avons aussi vu comment bien les sérialiser en les optimisant afin de pouvoir <em>scaler</em>, (c&#8217;est-à-dire s&#8217;adapter facilement à une forte demande sur notre application). Maintenant, il est temps de commencer à passer des commandes. Cela va être une situation plus complexe parce que nous allons gérer les associations entre les trois modèles. Nous devons être assez malins pour gérer la sortie JSON que nous fournissons.</p>
</div>
<div class="paragraph">
<p>Dans ce chapitre, nous allons faire plusieurs choses:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Créer un modèle de commande avec les spécifications correspondantes</p>
</li>
<li>
<p>Gérer l’association de sortie JSON entre l’utilisateur de la commande et les modèles de produits</p>
</li>
<li>
<p>Envoyer un courriel de confirmation avec le récapitulatif de la commande</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maintenant que tout est clair, nous pouvons commencer à travailler. Créons une nouvelle branche afin de commencer à travailler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modélisation_de_la_commande">Modélisation de la commande</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si vous vous souvenez des associations entre les modèles, vous devez vous souvenir que le modèle <code>Order</code> est associé aux modèles <code>User</code> et <code>Product</code>. C’est en fait très simple de gérer cela avec Rails. La partie délicate est lors de la sérialisation de ces objets. J’en parlerai plus en détail plus tard.</p>
</div>
<div class="paragraph">
<p>Commençons par créer le modèle de la commande. Celui possédera deux relations <code>ManyToOne</code>: <code>User</code> et <code>Product</code>. Il aura aussi une colonne <code>total</code> pour le coût total de la commande et ensuite les colonnes classiques <code>createdAt</code> et <code>updatedAt</code>. Voici l&#8217;implémentation complète.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/order.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IsDefined</span><span class="p">,</span> <span class="nx">IsPositive</span><span class="p">,</span> <span class="nx">validateOrReject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Order</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">orders</span><span class="p">)</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsNumber</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ValidateIf</span><span class="p">((</span><span class="nx">total</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">total</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span><span class="p">,</span> <span class="na">unsigned</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="nx">total</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">CreateDateColumn</span><span class="p">()</span>
  <span class="nx">createdAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">UpdateDateColumn</span><span class="p">()</span>
  <span class="nx">updatedAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">BeforeUpdate</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">validate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">validateOrReject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Order</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrderRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Order</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le constater, l&#8217;implémentation n&#8217;apporte rien de nouveau comparé à ce que nous avons déjà vu.</p>
</div>
<div class="paragraph">
<p>J&#8217;en ai profité pour ajouter la contrainte <code>ValidateIf</code> sur le champ <code>total</code> qui est un <code>number unsigned</code>. Cela signifie  qu&#8217;il ne peut pas être négatif.</p>
</div>
<div class="paragraph">
<p>Mais avant d&#8217;oublier, nous devons aussi définir la relation côté <code>User</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/user.entity.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./order.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Order</span><span class="p">,</span> <span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span>
  <span class="nx">orders</span><span class="p">:</span> <span class="nx">Order</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parfait! Nous sommes prêt à passer à la suite. <em>Commitons</em> tout cela avant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Generate orders"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_les_commandes_et_les_produits">Les commandes et les produits</h3>
<div class="paragraph">
<p>Nous devons établir la liaison entre la commande et les produits. Cela se fait avec une association <em>many-to-many</em> car les produits seront associé à plusieurs commandes et les commandes auront plusieurs produits. Dans ce cas, nous avons donc besoin d’un modèle supplémentaire qui joindra ces deux autres objets et mappera l’association appropriée. Voici l&#8217;implémentation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/placement.entity.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">IsDefined</span><span class="p">,</span> <span class="nx">validateOrReject</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./order.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./product.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">User</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./user.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Placement</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">()</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Product</span><span class="p">,</span> <span class="p">(</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">product</span><span class="p">.</span><span class="nx">placements</span><span class="p">)</span>
  <span class="nx">product</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Order</span><span class="p">,</span> <span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span><span class="p">)</span>
  <span class="nx">order</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">BeforeInsert</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">BeforeUpdate</span><span class="p">()</span>
  <span class="k">async</span> <span class="nx">validate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">validateOrReject</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">EntityRepository</span><span class="p">(</span><span class="nx">Placement</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementRepository</span> <span class="kd">extends</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ajout de la relation <code>placements</code> au modèle <code>Product</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Placement</span><span class="p">,</span> <span class="p">(</span><span class="nx">placement</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">product</span><span class="p">)</span>
  <span class="nx">placements</span><span class="p">:</span> <span class="nx">Placement</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ajout de la relation <code>placements</code> au modèle <code>Order</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/order.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Order</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Placement</span><span class="p">,</span> <span class="p">(</span><span class="nx">placement</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">order</span><span class="p">)</span>
  <span class="nx">placements</span><span class="p">:</span> <span class="nx">Placement</span><span class="p">[];</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> les changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Associates products and orders with a placements model"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exposer_le_modèle_dutilisateur">Exposer le modèle d’utilisateur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il est maintenant temps de préparer le contrôleur des commandes à exposer les bonnes commandes. Si vous vous souvenez des chapitres précédents où l’on avait utilisé <a href="https://github.com/SeyZ/jsonapi-serializer/">jsonapi-serializer</a> vous devez vous rappeler que c’était vraiment facile.</p>
</div>
<div class="paragraph">
<p>Définissons d’abord quelles actions nous allons mettre en place:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Une action d’indexation pour récupérer les commandes des utilisateurs en cours</p>
</li>
<li>
<p>Une action show pour récupérer une commande particulière de l’utilisateur courant</p>
</li>
<li>
<p>Une action de création pour passer réellement la commande</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Commençons par l’action <code>index</code>. Nous devons d’abord créer le contrôleur de commandes. Mais avant de commencer à taper du code, nous devons nous demander:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Est-ce que je dois laisser les routes de ma commande imbriqués dans le <code>UsersController</code> ou bien dois je les isoler?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>La réponse est vraiment simple: cela dépend de la quantité d’informations que vous voulez exposer au développeur.</p>
</div>
<div class="paragraph">
<p>Dans notre cas, nous n&#8217;allons pas le faire car nous allons récupérer les commandes de utilisateur sur la route <code>/orders</code>. Commençons par quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">Tests fonctionnels de la méthode <code>OrdersController.index</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrdersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">userRepository</span><span class="p">:</span> <span class="nx">UserRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">orderRepository</span><span class="p">:</span> <span class="nx">OrderRepository</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jsonWebTokenService</span><span class="p">:</span> <span class="nx">JsonWebTokenService</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">stranger</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">jwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">strangerJwt</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">order</span><span class="p">:</span> <span class="nx">Order</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jsonWebTokenService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">JsonWebTokenService</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">);</span>
    <span class="nx">userRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">UserRepository</span><span class="p">);</span>
    <span class="nx">orderRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>

    <span class="nx">stranger</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">strangerJwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">stranger</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateUser</span><span class="p">());</span>
    <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">orderRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}));</span>
    <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jsonWebTokenService</span><span class="p">.</span><span class="nx">encode</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should forbid orders without auth</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">));</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should get orders of user</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(({</span> <span class="nx">body</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">some</span><span class="p">(({</span> <span class="nx">id</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">id</span> <span class="o">===</span> <span class="nb">String</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">)))));</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="nx">min</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">max</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span> <span class="kr">number</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">)</span> <span class="o">+</span> <span class="nx">min</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateOrder</span><span class="p">(</span><span class="nx">order</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Order</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">Order</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">newOrder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Order</span><span class="p">();</span>
  <span class="nx">newOrder</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">order</span><span class="p">?.</span><span class="nx">user</span> <span class="o">??</span> <span class="nx">generateUser</span><span class="p">();</span>
  <span class="nx">newOrder</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// TODO</span>

  <span class="k">return</span> <span class="nx">newOrder</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation de ce test devrait vous rappeler celle de <code>product.controller.spec.ts</code>. Nous essayons d&#8217;accéder au nouvel <code>endpoint</code> avec un utilisateur possédant une <code>Order</code> et nous vérifions que cette commande apparaît bien dans le retour JSON.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Vous avez certainement remarqué la syntaxe <code>({body}) =&gt; &#8230;&#8203;</code>. Il s&#8217;agit de la fonctionnalité de <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Op%C3%A9rateurs/Syntaxe_d%C3%A9composition">la décomposition d&#8217;objet</a>. Elle permet tout simplement de récupérer une propriété contenue dans un object directement dans une variable du même nom. Ainsi <code>const data = {a: 1}; const a = data.a;</code> peut être simplifié en <code>const { a } = {a: 1}</code>. Cette syntaxe peu perturber donc j&#8217;ai préféré l&#8217;utiliser qu&#8217;à partir de ce chapitre.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si nous exécutons la suite de tests maintenant, comme vous pouvez vous y attendre, les deux tests échoueront. C’est normal car nous n’avons même pas défini le contrôleur ni même le sérialiseur spécifique aux commandes. Alors faisons le.</p>
</div>
<div class="paragraph">
<p>Alors commençons par le sérialiseur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/serializers.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">ordersSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Serializer</span><span class="p">(</span><span class="dl">"</span><span class="s2">orders</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">total</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">createdAt</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">updatedAt</span><span class="dl">"</span><span class="p">],</span>
<span class="p">}</span> <span class="k">as</span> <span class="kr">any</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant nous pouvons l&#8217;utiliser dans notre tout nouveau contrôleur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">ordersSerializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/serializers.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">({</span> <span class="nx">user</span> <span class="p">}:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">User</span> <span class="p">})</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">orders</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">user</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">ordersSerializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">orders</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans le premier décorateur <code>@controller</code>, nous injection globalement le <em>middleware</em> <code>FetchLoggedUserMiddleware</code>. Cela signifie qu&#8217;il faudra donner une jeton JWT pour accéder à toutes les actions de ce contrôleur. Cela nous permet donc de récupérer l&#8217;utilisateur dans la méthode <code>index</code> et de l&#8217;utiliser directement dans la méthode <code>find</code>. Nous utilisons le sérialseur pour formatter les données et les renvoyer.</p>
</div>
<div class="paragraph">
<p>N&#8217;oublions pas de charger notre contôleur puisqu&#8217;il s&#8217;agit d&#8217;un tout nouveau contrôleur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">../controllers/orders.controller</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant nos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
    index
      ✓ should forbid orders without auth <span class="o">(</span>44ms<span class="o">)</span>
      ✓ should get orders of user
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous aimons nos commits très petits. Alors <em>commitons</em> dès maintenant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds the index action for order"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_afficher_une_seule_commande">Afficher une seule commande</h3>
<div class="paragraph">
<p>Comme vous pouvez déjà l’imaginer, cette route est très facile. Nous n’avons qu’à mettre en place quelques configurations (routes, action du contrôleur) et un nouveau <em>middleware</em> qui va s&#8217;occuper de récupérer la commande et ce sera tout pour cette section. Nous inclurons plus tard les produits liés à cette commande dans le JSON de sortie.</p>
</div>
<div class="paragraph">
<p>Commençons par ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrdersController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">show</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should forbid show order for other users</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/orders/</span><span class="p">${</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">).</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">strangerJwt</span><span class="p">).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">should show order</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`/orders/</span><span class="p">${</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">Authorization</span><span class="dl">"</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(({</span> <span class="nx">body</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nb">String</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">)));</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Passons à l&#8217;implémentation. Nous allons commencer par créer un <em>middleware</em> qui se chargera de chercher la commande en fonction du paramètre. Le code est vraiment très similaire au <code>FetchProductMiddleware</code> donc je passerai un peu plus vite la dessus:</p>
</div>
<div class="listingblock">
<div class="title">Création du <code>FetchOrderMiddleware</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/middlewares/fetchUser.middleware.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FetchOrderMiddleware</span> <span class="kd">extends</span> <span class="nx">BaseMiddleware</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nx">databaseService</span><span class="p">:</span> <span class="nx">DatabaseService</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="na">order</span><span class="p">:</span> <span class="nx">Order</span> <span class="p">},</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span> <span class="o">|</span> <span class="nx">Response</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">orderId</span> <span class="o">??</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">orderId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">repository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">repository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">orderId</span><span class="p">),</span> <span class="p">{</span>
      <span class="na">relations</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">],</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">order</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">order not found</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ajout du <code>Symbol</code> pour l&#8217;injection dans le container</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">FetchOrderMiddleware</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">FetchOrderMiddleware</span><span class="dl">"</span><span class="p">),</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ajout <code>FetchOrderMiddleware</code> dans le container</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Container</span><span class="p">();</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchOrderMiddleware</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FetchOrderMiddleware</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tous nos tests passent désormais:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test
  </span>OrderController
    index
      ✓ should forbid orders without auth <span class="o">(</span>44ms<span class="o">)</span>
      ✓ should get orders of user
    show
      ✓ should forbid show order <span class="k">for </span>other <span class="nb">users</span>
      ✓ should show orders</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> les changements et passons à la suite.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the show action for order"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_placement_et_commandes">Placement et commandes</h3>
<div class="paragraph">
<p>Il est maintenant temps de donner la possibilité à l’utilisateur de passer quelques commandes. Cela ajoutera de la complexité à l’application, mais ne vous inquiétez pas, nous allons faire les choses une étape à la fois.</p>
</div>
<div class="paragraph">
<p>Avant de lancer cette fonctionnalité, prenons le temps de réfléchir aux implications de la création d’une commande dans l’application. Je ne parle pas de la mise en place d’un service de transactions comme <a href="https://stripe.com/">Stripe</a> ou <a href="https://www.braintreepayments.com/">Braintree</a> mais de choses comme:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la gestion des produits en rupture de stock</p>
</li>
<li>
<p>la diminution de l’inventaire de produits</p>
</li>
<li>
<p>ajouter une certaine validation pour le placement de la commande pour s’assurer qu’il y a suffisamment de produits au moment où la commande est passée</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On dirait qu’il reste un paquet de chose à faire mais croyez-moi: vous êtes plus près que vous ne le pensez et ce n’est pas aussi dur que ça en a l’air. Pour l’instant, gardons les choses simples et supposons que nous avons toujours assez de produits pour passer un nombre quelconque de commandes. Nous nous soucions juste de la réponse du serveur pour le moment.</p>
</div>
<div class="paragraph">
<p>Si vous vous rappelez le modèle de commande, nous avons besoin de trois choses: un total pour la commande, l’utilisateur qui passe la commande et les produits pour la commande. Compte tenu de cette information, nous pouvons commencer à ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrderController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">create</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">product1</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>
    <span class="kd">let</span> <span class="na">product2</span><span class="p">:</span> <span class="nx">Product</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">product1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>
      <span class="nx">product2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should create order</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="na">productIds</span><span class="p">:</span> <span class="p">[</span><span class="nx">product1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">product2</span><span class="p">.</span><span class="nx">id</span><span class="p">]})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">));</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not create product without auth</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="na">productIds</span><span class="p">:</span> <span class="p">[</span><span class="nx">product1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">product2</span><span class="p">.</span><span class="nx">id</span><span class="p">]})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">403</span><span class="p">));</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not create order with missing title</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">).</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="na">productIds</span><span class="p">:</span> <span class="p">[]}).</span><span class="nx">expect</span><span class="p">(</span><span class="mi">400</span><span class="p">));</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Encore une fois, nous allons créer des tests qui couvrent tous les cas possibles. Respectivement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le cas ou tout se passe bien</p>
</li>
<li>
<p>le cas ou l&#8217;utilisateur n&#8217;a pas envoyé les paramètres nécessaires</p>
</li>
<li>
<p>le cas ou l&#8217;utilisateur n&#8217;a pas spécifié sont jeton JWT</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir dans le premier cas, l&#8217;utilisateur envoie un tableau des produits qu&#8217;il souhaite ajouter à sa commande. Nous allons donc dans le contrôleur:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>récupérer la liste des produits associés via les IDs</p>
</li>
<li>
<p>calculer la somme totale que représente ces produits</p>
</li>
<li>
<p>créer l'`Order`</p>
</li>
<li>
<p>créer les <code>Placements</code> associé à cette commande</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela parait compliqué mais voyez l&#8217;implémentation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="p">{</span><span class="nl">productIds</span><span class="p">:</span> <span class="kr">number</span><span class="p">[]},</span> <span class="p">{</span><span class="nx">user</span><span class="p">}:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">},</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">ProductRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">orderRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">OrderRepository</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">placementRepository</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getRepository</span><span class="p">(</span><span class="nx">PlacementRepository</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">productIds</span><span class="p">?.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="na">errors</span><span class="p">:</span> <span class="p">{</span><span class="na">productIds</span><span class="p">:</span> <span class="dl">'</span><span class="s1">should be an array of products ids</span><span class="dl">'</span><span class="p">}});</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">findByIds</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">productIds</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">products</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">orderRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">user</span><span class="p">,</span> <span class="nx">total</span><span class="p">});</span>

    <span class="kd">const</span> <span class="nx">placements</span> <span class="o">=</span> <span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">}));</span>
    <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">placementRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">placements</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant, nos tests devraient tous passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
...
    create
      ✓ should create order
      ✓ should not create product without auth
      ✓ should not create order with missing title</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the create method for the orders controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_envoyer_un_email_de_confirmation">Envoyer un email de confirmation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La dernière section de ce chapitre sera d’envoyer un courriel de confirmation à l’utilisateur qui vient de créer une commande. Si vous le voulez, vous pouvez sauter cette étape et passer au chapitre suivant! Cette section est plus à un bonus.</p>
</div>
<div class="paragraph">
<p>Nous allons donc utiliser la librairie <a href="https://nodemailer.com/">nodemailer</a></p>
</div>
<div class="paragraph">
<p>Installons donc la librairie:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>nodemailer
<span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">--save-dev</span> @types/nodemailer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant créons un nouveau service qui fera l&#8217;interface entre la librairie et notre code. Comme je le disait précédemment, c&#8217;est toujours une bonne idée de procéder ainsi car cela va nous permettre de <em>Mocker</em> cette fonctionnalité durant nos tests. Ne vous inquiétez pas, nous en reparlerons juste après.</p>
</div>
<div class="listingblock">
<div class="title">Implémentation d&#8217;un service faisant interface à nodemailer.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/mailer.service.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">inject</span><span class="p">,</span> <span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">createTestAccount</span><span class="p">,</span> <span class="nx">createTransport</span><span class="p">,</span> <span class="nx">SendMailOptions</span><span class="p">,</span> <span class="nx">Transporter</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">nodemailer</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">TYPES</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../core/types.core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Logger</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./logger.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MailerService</span> <span class="p">{</span>
  <span class="k">private</span> <span class="k">static</span> <span class="nx">transporter</span><span class="p">:</span> <span class="nx">Transporter</span><span class="p">;</span>

  <span class="k">public</span> <span class="kd">constructor</span><span class="p">(@</span><span class="nd">inject</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">public</span> <span class="k">async</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">SendMailOptions</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">initializeTransporter</span><span class="p">();</span>

    <span class="k">await</span> <span class="nx">MailerService</span><span class="p">.</span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="k">private</span> <span class="k">async</span> <span class="nx">initializeTransporter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">MailerService</span><span class="p">.</span><span class="nx">transporter</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="p">{</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pass</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">createTestAccount</span><span class="p">();</span>

    <span class="nx">MailerService</span><span class="p">.</span><span class="nx">transporter</span> <span class="o">=</span> <span class="nx">createTransport</span><span class="p">({</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">"</span><span class="s2">smtp.ethereal.email</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="mi">587</span><span class="p">,</span>
      <span class="na">secure</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">auth</span><span class="p">:</span> <span class="p">{</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pass</span> <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous le voyez, notre service ne fais pas grand chose. Nous initialisons juste ici un <code>transporter</code> qui permet de se connecter à un compte SMTP. Vous pouvez utiliser le compte mail de votre choix et de déplacer les valeurs dans le fichier <code>.env</code> mais ici j&#8217;ai choisi d&#8217;utiliser la méthode <code>createTestAccount</code> qui permet de créer un compte test à la volée.</p>
</div>
<div class="paragraph">
<p>Et comme nous venons de créer un service, nous devons l&#8217;ajouter au container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/types.core.ts</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TYPES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">MailerService</span><span class="p">:</span> <span class="nb">Symbol</span><span class="p">.</span><span class="k">for</span><span class="p">(</span><span class="dl">"</span><span class="s2">MailerService</span><span class="dl">"</span><span class="p">),</span>
  <span class="c1">// ...</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/core/container.core.ts</span>
<span class="c1">// ...</span>
<span class="nx">container</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">MailerService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">MailerService</span><span class="p">);</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Je trouve que c&#8217;est une bonne idée d&#8217;ajouter la création du mail du produit dans le <code>MailerService</code>. En revanche, il faut faire attention à ce que ce service ne devienne pas trop gros au fur et à mesure de l&#8217;extension de notre application et ne pas hésiter à le redécouper si nécessaire. Dans notre cas cela ne pose pas de problème. Voici donc la méthode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/services/mailer.service.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MailerService</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">sendNewOrderEmail</span><span class="p">(</span><span class="nx">order</span><span class="p">:</span> <span class="nx">Order</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productText</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`- </span><span class="p">${</span><span class="nx">p</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="s2">`Details of products:\n</span><span class="p">${</span><span class="nx">productText</span><span class="p">}</span><span class="s2">\nTOTAL:</span><span class="p">${</span><span class="nx">order</span><span class="p">.</span><span class="nx">total</span><span class="p">}</span><span class="s2">€`</span><span class="p">;</span>

    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">({</span>
      <span class="na">to</span><span class="p">:</span> <span class="nx">order</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="nx">text</span><span class="p">,</span>
      <span class="na">subject</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Thanks for order</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons maintenant appeler cette méthode directement donc notre contrôleur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">/orders</span><span class="dl">"</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">mailerService</span><span class="p">.</span><span class="nx">sendNewOrderEmail</span><span class="p">(</span><span class="nx">order</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Si notre application grandie, il serait plus intéressant d&#8217;utiliser une librairie spécialisée dans la gestion de job comme <a href="https://github.com/graphile/worker">graphile-worker</a> afin de différer l&#8217;envoie d&#8217;email. Cela nous permettrait aussi de prioriser les tâches mais aussi de relancer plus tard les tâches qui n&#8217;ont pas fonctionnés. Dans notre cas, je ne l&#8217;ai pas mis en place afin de garder ce tutoriel plus simple.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lançons les tests pour êtres sûr:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
...
    create
      1<span class="o">)</span> should create order
      ✓ should not create product without auth
      ✓ should not create order with missing title
...

  1<span class="o">)</span> OrderController
       create
         should create order:
     Error: Timeout of 2000ms exceeded.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous constatons que notre test ne fonctionne plus car il dépasse le temps alloué à un test. Nous pourrions augmenter le temps alloué à ce test avec la méthode <code>timeout</code> mais ce n&#8217;est pas optimal. Mais rassurez vous, nous avons une solution très simple offerte par l&#8217;injection de dépendence que nous avons mis en place depuis le début: un <em>Mock</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;idée est donc de créer un classe qui implémente les fonctionnalités du <code>MailerService</code> mais qui se comporte de la façon que nous voulons spécifiquement dans le contexte donnée. C&#8217;est à dire que nous voulons que durant les tests, les mails ne soient pas envoyé. Cela semble compliqué mais c&#8217;est en fait très simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/tests/fakeMailer.service.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">injectable</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">inversify</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">SendMailOptions</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">nodemailer</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">MailerService</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/mailer.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">FakeMailerService</span> <span class="kd">extends</span> <span class="nx">MailerService</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">sendEmail</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">SendMailOptions</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{}</span>
  <span class="k">protected</span> <span class="k">async</span> <span class="nx">initializeTransporter</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et il suffit de <code>rebind</code> le service au début de notre test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrderController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">MailerService</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">FakeMailerService</span><span class="p">);</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
    <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà, nos tests devraient passer à nouveau.</p>
</div>
<div class="paragraph">
<p><em>Commitons</em> tout ce que nous venons de faire pour terminer cette section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds order confirmation mailer"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_7">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ça y est! Vous avez réussi! Vous pouvez vous applaudir. Je sais que ça a été long mais c’est presque fini, croyez moi.</p>
</div>
<div class="paragraph">
<p>Sur les chapitres à venir, nous continuerons à travailler sur le modèle de commande pour ajouter des validations lors de la passation d’une commande. Certains scénarios sont:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Que se passe-t-il lorsque les produits ne sont pas disponibles?</p>
</li>
<li>
<p>Diminuer la quantité du produit en cours lors de la passation d’une commande</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le prochain chapitre sera court, mais il est très important pour la santé de l&#8217;application. Alors ne le sautez pas.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter08-improve_orders" class="sect0">Améliorer les commandes</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Précédemment nous avons amélioré notre API pour passer des commandes et envoyer un e-mail de confirmation à l’utilisateur (juste pour améliorer l’expérience utilisateur). Ce chapitre va s’occuper de quelques validations sur le modèle de commande afin de s’assurer qu’il est valide. C’est-à-dire:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Diminuer la quantité du produit en cours lors de la création d’une commande</p>
</li>
<li>
<p>gérer le cas ou le produit n&#8217;est pas disponible</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous aurons aussi besoin de mettre à jour un peu la sortie JSON pour les commandes. Mais ne divulgâchons pas la suite.</p>
</div>
<div class="paragraph">
<p>Créons une nouvelle branche afin de commencer à travailler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter08</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_diminution_de_la_quantité_de_produit">Diminution de la quantité de produit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans cette partie nous travaillerons sur la mise à jour de la quantité du produit pour nous assurer que chaque commande livrera le produit réel.</p>
</div>
<div class="sect2">
<h3 id="_ajout_de_lattribut_product_total">Ajout de l&#8217;attribut <code>product.total</code></h3>
<div class="paragraph">
<p>Nous allons tout d&#8217;abord rajouter un champs <code>total</code> sur le produit qui représentera le stock du produit disponible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">integer</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  <span class="nx">quantity</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il faut aussi que ce champ soit disponible lors de la création du produit. Nous devons donc mettre à jour notre contrôleur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/products</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">quantity</span><span class="p">);</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous devons aussi mettre à jour la méthode =generateProduct= qui doit gérer ce nouvel attribut:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/faker.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">generateProduct</span><span class="p">(</span><span class="nx">product</span><span class="p">?:</span> <span class="nb">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">):</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">newProduct</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">=</span> <span class="nx">product</span><span class="p">?.</span><span class="nx">quantity</span> <span class="o">??</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous devons maintenant vérifier que le total ne peut jamais être inférieur à zero. Cela permettra de sécuriser notre application et ainsi empêcher qu&#8217;une commande soit passée s&#8217;il n&#8217;y a pas de stock sur le produit.</p>
</div>
<div class="paragraph">
<p>Commençons donc par ajouter un test qui va décrire le comportement souhaité:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">ProductRepository</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">validate</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should have a positive quantity</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="nx">generateProduct</span><span class="p">({</span><span class="na">quantity</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">});</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="dl">'</span><span class="s1">Should not validate product</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">errors</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">error</span><span class="p">.</span><span class="nx">property</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">quantity</span><span class="dl">'</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Faire passer le test est très facile gràce aux décorateurs de <code>class-validator</code>. Il suffit d&#8217;ajouter le décorateur <code>@IsInt</code> et <code>@Min</code> comme cela:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/entities/product.entity.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Product</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">IsInt</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">Min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">integer</span><span class="dl">'</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
  <span class="nx">quantity</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
<span class="c1">// ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous le voyez c&#8217;est vraiment très simple et le code est très lisible. Et voilà. Commitons les changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add quantity to products"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mise_en_place_du_test_fonctionnel_2">Mise en place du test fonctionnel</h3>
<div class="paragraph">
<p>Avant de commencer à aller plus loin, nous devons changer la façon dont nous gérons la création de la commande car nous devons maintenant prendre en compte une quantité pour chaque produit. Si vous vous souvenez, jusqu&#8217;à maintenant nous attendons un tableau d’identifiants de produits. Je vais essayer de garder les choses simples et nous allons maintenant accepter un tableau d&#8217;objets contenant les attributs <code>id</code> et <code>quantity</code>. Un exemple rapide serait quelque chose comme cela:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">const</span> <span class="nx">productOrderParams</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">5</span> <span class="p">}</span>
<span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Commençons donc par modifier notre test fonctionnel à propos du contrôleur des commandes:</p>
</div>
<div class="listingblock">
<div class="title">Modification du test fonctionnel de la création du produit</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OrderController</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">create</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">productsParams</span><span class="p">;</span>

    <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">product1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>
      <span class="kd">const</span> <span class="nx">product2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">());</span>

      <span class="nx">productsParams</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">product1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">product2</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
      <span class="p">];</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should create order</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
      <span class="nx">agent</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="na">products</span><span class="p">:</span> <span class="nx">productsParams</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">201</span><span class="p">));</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous le voyez, nous avons simplement mis à jour les paramètres que nous passons à la requêtes.</p>
</div>
<div class="paragraph">
<p>Récapitulons un peu ce que nous devons changer dans le contrôleur. Nous devons retrouver le produit associé à l'`id` dans le tableau que créer les <code>placements</code>. Voyons voir l&#8217;implémentation du contrôleur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpPost</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">create</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">requestBody</span><span class="p">()</span> <span class="nx">body</span><span class="p">:</span> <span class="p">{</span><span class="nl">products</span><span class="p">:</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span> <span class="nl">quantity</span><span class="p">:</span> <span class="kr">number</span><span class="p">}[]},</span>
    <span class="c1">// ...</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span><span class="nx">manager</span><span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">products</span><span class="p">?.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">errors</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">products</span><span class="p">:</span> <span class="dl">'</span><span class="s1">should be an array of `{id, quantity}`</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">user</span><span class="p">,</span>
      <span class="na">total</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">placements</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span> <span class="k">as</span> <span class="nx">Order</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="p">{</span><span class="nx">id</span><span class="p">,</span> <span class="nx">quantity</span><span class="p">}</span> <span class="k">of</span> <span class="nx">body</span><span class="p">.</span><span class="nx">products</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">placement</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Placement</span><span class="p">();</span>
      <span class="nx">placement</span><span class="p">.</span><span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="p">});</span>
      <span class="nx">placement</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="nx">order</span><span class="p">;</span>
      <span class="nx">placement</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">=</span> <span class="nx">quantity</span><span class="p">;</span>

      <span class="nx">order</span><span class="p">.</span><span class="nx">placements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="nx">placement</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Oula. Le code devient un peu plus long et mérite quelques explications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nous créons la commande avec un total égal à 0 (Nous verrons dans la prochaine section comment faire en sorte que ce total se mette à jour automatiquement.)</p>
</li>
<li>
<p>nous vérifiions les données de l&#8217;utilisateur en vérifiant que <code>req.body.products</code> contient des valeurs</p>
</li>
<li>
<p>nous faisons une boucle sur <code>req.body.products</code> dans lequel nous récupérons le produit, nous créons un <code>Placement</code> et nous l&#8217;ajoutons au tableau <code>order.placements</code></p>
</li>
<li>
<p>la suite reste inchangée</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_le_subscriber">Le <em>subscriber</em></h3>
<div class="paragraph">
<p>Il est maintenant temps de mettre à jour la quantité du produit une fois qu&#8217;une commande est placée.</p>
</div>
<div class="paragraph">
<p>Nous serions tenté de le faire rapidement dans l&#8217;action <code>OrderController.create</code> mais cela serait une mauvaise idée car il faudrait dupliquer cette logique sur l&#8217;action <code>OrderController.update</code> et <code>OrderController.destroy</code> qui doivent aussi mettre a jour la quantité de produits. Cela va aussi a l&#8217;encontre de la bonne pratique qui est de réduire au maximum la responsabilité des contrôleurs.</p>
</div>
<div class="paragraph">
<p>C&#8217;est pour cela que je pense que un <a href="https://github.com/typeorm/typeorm/blob/master/docs/listeners-and-subscribers.md"><code>Subscriber</code> de TypeORM</a> est un bien meilleur endroit pour la simple raison que nous sommes certains que notre <em>subscriber</em> sera appelé quoiqu&#8217;il arrive sans que nous aillons à nous en soucier.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Il serait possible de d&#8217;utiliser les <em>entity listeners</em> comme <code>@afterInsert</code> sur la méthode <code>UserRepository.validate</code> mais je recommande vraiment d&#8217;utiliser les <em>subscriber</em> lorsque nous souhaitons manipuler plusieurs types d&#8217;entité. Cela permet de mieux découper sont code et ainsi ne pas faire dépendre une classe d&#8217;une autre.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le comportement que nous allons mettre en place est le suivant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>lorsqu&#8217;un placement est créé</p>
</li>
<li>
<p>nous enlevons <code>placement.quantity</code> à l&#8217;attribut <code>product.quantity</code></p>
</li>
<li>
<p>nous recalculons le coût total de la commande</p>
</li>
<li>
<p>lorsqu&#8217;un placement est créé</p>
</li>
<li>
<p>nous ajoutons <code>placement.quantity</code> à l&#8217;attribut <code>product.quantity</code></p>
</li>
<li>
<p>nous recalculons le coût total de la commande</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le <em>subscriber</em> va se matérialiser en un classe qui étends <code>EntitySubscriberInterface</code>. Si nous regardons de plus prêt cette interface, nous voyons que nous avons accès à un paquet de méthodes:</p>
</div>
<div class="listingblock">
<div class="title">Quelques méthodes de l&#8217;interface <code>EntitySubscriberInterface</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// node_modules/typeorm/subscriber/EntitySubscriberInterface.d.ts</span>
<span class="k">export</span> <span class="kr">interface</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Entity</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">beforeInsert</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">afterInsert</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">beforeUpdate</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">UpdateEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">afterUpdate</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">UpdateEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">beforeRemove</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nx">afterRemove</span><span class="p">?(</span><span class="nx">event</span><span class="p">:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Entity</span><span class="o">&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons donc créer notre classe qui implémente <code>EntitySubscriberInterface</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Order</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/order.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Placement</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/placement.entity</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Product</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../entities/product.entity</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">EventSubscriber</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementSubscriber</span>
  <span class="k">implements</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{</span>

  <span class="nx">listenTo</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Placement</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">afterInsert</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
  <span class="k">async</span> <span class="nx">beforeRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
  <span class="k">async</span> <span class="nx">afterRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez aussi remarquer que ici j&#8217;ai implémenté la méthode <code>listenTo</code> qui va spécifier le champ d&#8217;écoute de ce <em>subscriber</em>. Mais avant de passer à la suite, nous devons indiquer à TypeORM ou ce trouve nos migration via la variable de configuration suivante que vous devez ajouter à votre fichier <code>.env</code> et <code>.test.env</code>.</p>
</div>
<div class="listingblock">
<div class="title">Ajout de la configuration des <em>subscribers</em></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="env">TYPEORM_SUBSCRIBERS=src/subscribers/*.subscriber.ts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous somme maintenant prêt à passer à l&#8217;implémentation des méthodes!</p>
</div>
<div class="paragraph">
<p>Comme d&#8217;habitude, nous allons créer un test dédié à cette nouvelle classe. Ce test va tout simplement créer un produit avec une quantité suffisante et ensuite créer un <code>Placement</code> et vérifier que le total a été mis à jour. Nous faisons ensuite le sens inverse en supprimant le produit et on vérifie que l&#8217;on retrouve bien la quantité originelle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">PlacementSubscriber</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">manager</span><span class="p">:</span> <span class="nx">EntityManager</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">databaseService</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="kd">const</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">databaseService</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
    <span class="nx">manager</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">manager</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should update product.quantity after insert</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span><span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">}));</span>
    <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">());</span>

    <span class="kd">const</span> <span class="nx">placement</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
      <span class="nx">generatePlacement</span><span class="p">({</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">2</span><span class="p">}),</span>
    <span class="p">);</span>

    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span><span class="p">,</span> <span class="mi">10</span> <span class="o">-</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">quantity</span><span class="p">);</span>

    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">placement</span><span class="p">);</span>
    <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation du subscriber est vraiment très simple. Nous allons utiliser les méthode <code>beforeInsert</code> et <code>beforeRemove</code> afin d&#8217;incrémenter ou de décrémenter le total de produit et ensuite de sauvegarder le produit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">EventSubscriber</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementSubscriber</span>
  <span class="k">implements</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">async</span> <span class="nx">afterInsert</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productId</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">productId</span><span class="p">});</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">-=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">quantity</span><span class="p">;</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">beforeRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productId</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOneOrFail</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="nx">productId</span><span class="p">});</span>
    <span class="nx">product</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">+=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">quantity</span><span class="p">;</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Nous récupérons le produit via le <code>manager</code> au lieu de simplement récupérer via la relation <code>entity.product</code> afin de s&#8217;assurer d&#8217;avoir la dernière version stocké en base
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Et voilà. C&#8217;était facile non? Lançons les tests pour être sûr.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  PlacementSubscriber
    ✓ should update product.quantity after insert <span class="o">(</span>40ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parfait passons à la suite.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mise_à_jour_du_coup_total_de_la_commande">Mise à jour du coup total de la commande</h3>
<div class="paragraph">
<p>Si vous avez bien compris la section précédente, vous devinez que la mise à jour du coup de la commande va être assez similaire.</p>
</div>
<div class="paragraph">
<p>Commençons par écrire les tests. Nous allons donc créer un <code>Produit</code>, puis une <code>Order</code> et ensuite un <code>Placement</code> pour vérifier que le total de la commande s&#8217;est mis à jour. Nous allons ensuite supprimer ce <code>Placement</code> et vérifier que le</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">PlacementSubscriber</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should update order.total after insert</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span>
      <span class="nx">generateProduct</span><span class="p">({</span><span class="na">quantity</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">price</span><span class="p">:</span> <span class="mi">5</span><span class="p">}),</span>
    <span class="p">);</span>
    <span class="kd">let</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">());</span>

    <span class="kd">const</span> <span class="nx">placement</span> <span class="o">=</span> <span class="nx">generatePlacement</span><span class="p">({</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">2</span><span class="p">});</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">placement</span><span class="p">);</span>

    <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">total</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">);</span>

    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">placement</span><span class="p">);</span>
    <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">total</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Ce test ressemble vraiment au précédente. Passons donc rapidement à l&#8217;implémentation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/subscribers/placement.subscriber.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">EventSubscriber</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">PlacementSubscriber</span>
  <span class="k">implements</span> <span class="nx">EntitySubscriberInterface</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="k">async</span> <span class="nx">afterInsert</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">InsertEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateOrderTotal</span><span class="p">(</span><span class="nx">manager</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">order</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
  <span class="k">async</span> <span class="nx">afterRemove</span><span class="p">({</span><span class="nx">entity</span><span class="p">,</span> <span class="nx">manager</span><span class="p">}:</span> <span class="nx">RemoveEvent</span><span class="o">&lt;</span><span class="nx">Placement</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateOrderTotal</span><span class="p">(</span><span class="nx">manager</span><span class="p">,</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">order</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">async</span> <span class="nx">updateOrderTotal</span><span class="p">(</span><span class="na">manager</span><span class="p">:</span> <span class="nx">EntityManager</span><span class="p">,</span> <span class="na">order</span><span class="p">:</span> <span class="nx">Order</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">placements</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">where</span><span class="p">:</span> <span class="p">{</span><span class="nx">order</span><span class="p">},</span>
      <span class="na">relations</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">product</span><span class="dl">'</span><span class="p">],</span>
    <span class="p">});</span>

    <span class="nx">order</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">placements</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">placement</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">quantity</span> <span class="o">*</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">order</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Regardons de plus près la méthode <code>updateOrderTotal</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>nous récupérons tous les <code>placements</code> de la commande passé en paramètre avec les produits associés</p>
</li>
<li>
<p>nous additionnons le total du placement</p>
</li>
</ol>
</div>
<hr>
<div class="paragraph">
<p>Il est possible de réécrire le code précédent avec le <em>Query Builder</em> de TypeORM. Le <em>Query Builder</em> permet d&#8217;avoir un plus grand contrôle sur la requête SQL générée. Le code peut être plus complexe mais aussi plus performant car nous n&#8217;avons pas besoin  de charger plusieurs objets en mémoire.</p>
</div>
<div class="paragraph">
<p>C&#8217;est le cas ici donc je tenais à faire une petite apparté. Voici donc l&#8217;équivalent avec le <em>Query Builder</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span>
  <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="dl">'</span><span class="s1">pl</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">'</span><span class="s1">SUM(pl.quantity) * p.price</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">total</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">pl.order</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">pl.product</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">p</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">o.id = :orderId</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">orderId</span><span class="p">:</span> <span class="nx">order</span><span class="p">.</span><span class="nx">id</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="dl">'</span><span class="s1">o.id</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">getRawOne</span><span class="p">();</span>
<span class="nx">order</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">result</span><span class="p">?.</span><span class="nx">total</span> <span class="o">??</span> <span class="mi">0</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette requête va directement effectuer le total en multipliant la quantité par le prix du produit lié. Ainsi,  nous obtenons directement le résultat sous forme de <code>number</code>. Cela évite de charger plusieurs objets Javascript et permet d&#8217;économiser de la mémoire.</p>
</div>
<div class="paragraph">
<p>Ce code va générer la requête SQL suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">SELECT</span> <span class="k">SUM</span><span class="p">(</span><span class="nv">"pl"</span><span class="p">.</span><span class="nv">"quantity"</span><span class="p">)</span> <span class="o">*</span> <span class="nv">"p"</span><span class="p">.</span><span class="nv">"price"</span> <span class="k">AS</span> <span class="nv">"total"</span>
<span class="k">FROM</span> <span class="nv">"placement"</span> <span class="nv">"pl"</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"order"</span> <span class="nv">"o"</span> <span class="k">ON</span> <span class="nv">"o"</span><span class="p">.</span><span class="nv">"id"</span><span class="o">=</span><span class="nv">"pl"</span><span class="p">.</span><span class="nv">"orderId"</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"product"</span> <span class="nv">"p"</span> <span class="k">ON</span> <span class="nv">"p"</span><span class="p">.</span><span class="nv">"id"</span><span class="o">=</span><span class="nv">"pl"</span><span class="p">.</span><span class="nv">"productId"</span>
<span class="k">WHERE</span> <span class="nv">"o"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="nv">"o"</span><span class="p">.</span><span class="nv">"id"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ainsi, je vous conseille vivement d&#8217;essayer de perfectionner votre connaissance avec les gestionnaires de base de données car ils peuvent s&#8217;avérer de grand alliés.
<strong>*</strong></p>
</div>
<div class="paragraph">
<p>Essayons de voir si les tests passent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  OrderController
...
    create
      ✓ should create order <span class="o">(</span>74ms<span class="o">)</span>
      ✓ should not create product without auth
      ✓ should not create order with missing products
...
  PlacementSubscriber
    ✓ should update product.quantity after insert <span class="o">(</span>42ms<span class="o">)</span>
    ✓ should update order.total after insert <span class="o">(</span>44ms<span class="o">)</span>
...
  42 passing <span class="o">(</span>1s<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changements et récapitulons tout ce que nous venons de faire:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Updates the total calculation for order"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter08</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_8">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh vous êtes ici! Permettez-moi de vous féliciter! Cela fait un long chemin depuis le premier chapitre. Mais vous êtes à un pas de plus. En fait, le chapitre suivant sera le dernier. Alors essayez d’en tirer le meilleur.</p>
</div>
<div class="paragraph">
<p>Le dernier chapitre portera sur la façon d’optimiser l’API en utilisant la pagination, la mise en cache et les tâches d’arrière-plan. Donc bouclez vos ceintures, ça va être un parcours mouvementé.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter09-optimization" class="sect0">Optimisations</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Bienvenue dans le dernier chapitre du livre. Le chemin a été long mais vous n’êtes qu’à un pas de la fin. Dans le chapitre précédent, nous avons terminé la modélisation du modèle de commandes. Nous pourrions dire que le projet est maintenant terminé mais je veux couvrir quelques détails importants sur l’optimisation. Les sujets que je vais aborder ici seront:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la pagination</p>
</li>
<li>
<p>la mise en cache</p>
</li>
<li>
<p>l&#8217;optimisation des requêtes SQL</p>
</li>
<li>
<p>l&#8217;activation de CORS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>J’essaierai d’aller aussi loin que possible en essayant de couvrir certains scénarios courants. J’espère que ces scenarii vous seront utiles pour certains de vos projets.</p>
</div>
<div class="paragraph">
<p>Créons une nouvelle branche pour ce chapitre:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pagination">Pagination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Une stratégie très commune pour optimiser la récupération d’enregistrements dans une base de données est de charger seulement une quantité limitée en les paginant. Nous allons le faire très facilement.</p>
</div>
<div class="paragraph">
<p>La seule partie délicate ici est de savoir comment gérer la sortie JSON pour donner assez d’informations au client sur la façon dont le tableau est paginé. Dans la section précédente, j’ai partagé quelques ressources sur les pratiques que j’allais suivre ici. L’une d’entre elles était <a href="http://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>La norme JSON:API impose un format stricte mais claire. Cela nous permet de ne pas se soucier de comment doit être implémentée. Une sous-section appelée <a href="https://jsonapi.org/format/#document-top-level">Top Level</a> de la documentation officielle de JSON:API mentionnent quelque chose sur la pagination:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>"meta": méta-information sur une ressource, telle que la pagination.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Ce n’est pas très descriptif mais au moins nous avons un indice sur ce qu’il faut regarder ensuite au sujet de l’implémentation de la pagination. Ne vous inquiétez pas, c’est exactement ce que nous allons faire ici.</p>
</div>
<div class="paragraph">
<p>Commençons par la liste des produits.</p>
</div>
<div class="sect2">
<h3 id="_les_produits">Les produits</h3>
<div class="paragraph">
<p>Nous devons fournir les informations de pagination sur la balise <code>meta</code> comme le document JSON suivant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="jsonc"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="c1">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"first"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"last"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=30"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"prev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que nous voyons ce que ne devons retourner, il ne nous reste plus qu’à modifier un peu notre code. Mais avant d&#8217;aller plus loin, ajoutons d’abord quelques tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/products.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">ProductsController</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should paginate results</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">productRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateProduct</span><span class="p">({</span><span class="na">published</span><span class="p">:</span> <span class="kc">true</span><span class="p">}));</span>
      <span class="p">}</span>

      <span class="k">await</span> <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/products</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">links</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous testons donc deux choses:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>nous créons 25 produits nous devons donc en retrouver uniquement 20 lors de la réponse API car les résultats doivent se limiter à une seule page</p>
</li>
<li>
<p>nous devons retrouver les attributs <code>links</code> que nous avons vu précédemment</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notre but est donc de faire passer ces tests. Nous n&#8217;allons pas définir le comportement dans le contrôleur car nous savons d&#8217;avance que nous voulons le même comportement pour tous les contrôleurs. Nous allons donc créer une méthode générique qui va prendre en paramètre:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la requête HTTP, qui nous permettra de retrouver facilement la paramètre <code>page</code> et aussi de construire les <code>links</code> en fonction de l&#8217;URL actuelle de la requête</p>
</li>
<li>
<p>la requête SQL, qui sera utile pour savoir combien il y a de résultats en base de donnée et aussi appliquer les filtres <code>OFFSET</code> et <code>LIMIT</code> pour ne récupérer qu&#8217;une partie des résultats</p>
</li>
<li>
<p>le serializer pour sérializer les données selon le schéma JSON:API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Allez c&#8217;est parti!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/paginate.utils.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Request</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Serializer</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonapi-serializer</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">SelectQueryBuilder</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">typeorm</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">PER_PAGE</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">paginate</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="nx">queryBuilder</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">serializer</span><span class="p">:</span> <span class="nx">Serializer</span><span class="p">,</span>
  <span class="p">{</span><span class="nx">query</span><span class="p">,</span> <span class="nx">baseUrl</span><span class="p">}:</span> <span class="nx">Request</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">page</span> <span class="o">??</span> <span class="mi">1</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">).</span><span class="nx">getCount</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">totalPage</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">count</span> <span class="o">/</span> <span class="nx">PER_PAGE</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">prevPage</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">nextPage</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">===</span> <span class="nx">totalPage</span> <span class="p">?</span> <span class="nx">page</span> <span class="p">:</span> <span class="nx">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">?</span> <span class="p">(</span><span class="nx">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">PER_PAGE</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span>
    <span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">PER_PAGE</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">getUrlForPage</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">=&gt;</span>
    <span class="s2">`</span><span class="p">${</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">?</span><span class="p">${</span><span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">({...</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">})}</span><span class="s2">`</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">serializer</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">first</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="na">last</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="nx">totalPage</span><span class="p">),</span>
    <span class="na">prev</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="nx">prevPage</span><span class="p">),</span>
    <span class="na">next</span><span class="p">:</span> <span class="nx">getUrlForPage</span><span class="p">(</span><span class="nx">nextPage</span><span class="p">),</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est un peu longue mais nous allons la revoir ensemble:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>queryBuilder.getCount()</code> nous permet d&#8217;executer la requête passée en paramètre mais uniquement pour connaître le nombre de résultat</p>
</li>
<li>
<p>nous utilisons cette valeur pour calculer le nombre de pages et déduire le numéro de la page précédente et suivante</p>
</li>
<li>
<p>nous exécutons la requête SQL du <code>queryBuilder</code> en ajoutant un <code>offset</code> et une <code>limit</code></p>
</li>
<li>
<p>nous générons les URL que nous ajoutons au résultat sérializé précédemment</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vous êtes toujours là? L&#8217;implémentation dans le contrôleur est beaucoup plus facile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/home.controller.ts</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">paginate</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../utils/paginate.utils</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/products</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProductController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">return</span> <span class="nx">paginate</span><span class="p">(</span><span class="nx">repository</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">),</span> <span class="nx">productsSerializer</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Lançons les tests pour être sûr:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nt">---</span>
<span class="nv">$ </span>npm <span class="nb">test</span>
...
  ProductsController
    index
      ✓ should paginate results <span class="o">(</span>94ms<span class="o">)</span>
...
<span class="nt">---</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Commitons tout cela et passons à la suite</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Paginate products"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que nous avons fait une superbe optimisation pour la route de la liste des produits, c’est au client de parcourir les pages.</p>
</div>
<div class="paragraph">
<p><em>Commitons</em> ces changements et continuons avec la liste des commandes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds pagination for products index action to optimize response"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_liste_des_commandes">Liste des commandes</h3>
<div class="paragraph">
<p>Maintenant, il est temps de faire exactement la même chose pour la route de la liste des commandes. Cela devrait être très facile à mettre en œuvre. Mais d’abord, ajoutons quelques tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.spec.ts</span>
<span class="c1">// ...</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">OrderController</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should paginate results</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">orderRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">generateOrder</span><span class="p">({</span><span class="nx">user</span><span class="p">}));</span>
      <span class="p">}</span>

      <span class="k">await</span> <span class="nx">agent</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">links</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="c1">// ...</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et, comme vous vous en doutez peut-être déjà, nos tests ne passent plus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  1 failing

  1<span class="o">)</span> OrderController
       index
         should paginate results:

      AssertionError <span class="o">[</span>ERR_ASSERTION]: Expected values to be strictly equal:

21 <span class="o">!==</span> 20

      + expected - actual

      <span class="nt">-21</span>
      +20</code></pre>
</div>
</div>
<div class="paragraph">
<p>Faire passe ce test est là encore assez facile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/controllers/orders.controller.ts</span>
<span class="c1">// ...</span>
<span class="p">@</span><span class="nd">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">/orders</span><span class="dl">'</span><span class="p">,</span> <span class="nx">TYPES</span><span class="p">.</span><span class="nx">FetchLoggedUserMiddleware</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">OrdersController</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="p">@</span><span class="nd">httpGet</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">public</span> <span class="k">async</span> <span class="nx">index</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span> <span class="o">&amp;</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">})</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span><span class="nx">manager</span><span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">databaseService</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">paginate</span><span class="p">(</span>
      <span class="nx">manager</span>
        <span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="dl">'</span><span class="s1">o.user = :user</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}),</span>
      <span class="nx">ordersSerializer</span><span class="p">,</span>
      <span class="nx">req</span><span class="p">,</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La seule différence par rapport à l&#8217;implémentation du contrôleur des produit est que ici nous avons eu besoin de transformer <code>repository.find</code> en <code>queryBuilder</code>.</p>
</div>
<div class="paragraph">
<p>Les tests devraient maintenant passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>npm <span class="nb">test</span>
...
  46 passing <span class="o">(</span>781ms<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Faisons un <em>commit</em> avant d’avancer</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds pagination for orders index action"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mise_en_cache">Mise en cache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous pouvons facilement mettre en place une mise en cache simple pour certains de nos requêtes. L&#8217;implémentation sera vraiment très facile grâce à TypeORM. TypeORM va ainsi créer une nouvelle table qui va stocker la requête exécutée et le résultat qu&#8217;elle a retourné. Lors de la prochaine execution, TypeORM retournera le même résultat que le précédent. Cela permet d&#8217;économiser de précieuses ressources à notre gestionnaire de base de données (ici Sqlite) lors de certaines requêtes SQL coûteuses. Ici le résultat ne sera pas flagrant car les requêtes SQL éxécutées restent simple mais nous allons quand même le mettre en place.</p>
</div>
<div class="paragraph">
<p>Avant de voir un peu le comportement du cache, nous allons créer un script qui va insérer des données fictives dans notre base de données. Cela sera très facile car il nous suffit d&#8217;utiliser les méthodes que nous avons créées lors de nos tests. Voici un petit script que nous allons créer dans un nouveau dossier <code>scripts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/scripts/loadFakeData.script.ts</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">reflect-metadata</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">createOrder</span><span class="p">(</span><span class="nx">manager</span><span class="p">:</span> <span class="nx">EntityManager</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">generateUser</span><span class="p">());</span>
  <span class="kd">const</span> <span class="nx">owner</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">generateUser</span><span class="p">());</span>
  <span class="kd">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">generateOrder</span><span class="p">({</span><span class="nx">user</span><span class="p">}));</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Product</span><span class="p">,</span> <span class="nx">generateProduct</span><span class="p">({</span><span class="na">user</span><span class="p">:</span> <span class="nx">owner</span><span class="p">}));</span>
    <span class="k">await</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">Placement</span><span class="p">,</span> <span class="p">{</span><span class="nx">order</span><span class="p">,</span> <span class="nx">product</span><span class="p">,</span> <span class="na">quantity</span><span class="p">:</span> <span class="mi">2</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">manager</span><span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">container</span>
    <span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">DatabaseService</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">DatabaseService</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">Logger</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">TYPES</span><span class="p">.</span><span class="nx">Logger</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">DEBUG</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`Inserting </span><span class="p">${</span><span class="nx">i</span><span class="p">}</span><span class="s2"> / 100`</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">createOrder</span><span class="p">(</span><span class="nx">manager</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">main</span> <span class="o">===</span> <span class="kr">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">main</span><span class="p">().</span><span class="nx">then</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Quelques explications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>createOrder</code> va, comme son nom l&#8217;indique, créer une commande mais en plus créer un produit et cinq <code>placements</code></p>
</li>
<li>
<p><code>main</code> va créer une boucle autour de <code>createOrder</code> afin de l&#8217;appeler plusieurs fois</p>
</li>
<li>
<p><code>require.main === module</code> peut paraître abstrait mais c&#8217;est en fait très simple: cela signifie que la fonction sera exécutée qui si nous exécutons explicitement le fichier. En d&#8217;autres termes, cela permet de s&#8217;assurer que la méthode ne sera pas exécutée si le fichier est malencontreusement importé</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maintenant nous pouvons lancer le script avec la commande suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm run build <span class="o">&amp;&amp;</span> node dist/scripts/loadfakedata.script.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons vérifier que tout s&#8217;est bien passé en envoyant une petite requête SQL directement sur la base de données:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>sqlite3 db/development.sqlite <span class="s2">"SELECT COUNT(*) FROM product"</span>
500</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant essayons d&#8217;activer le cache. C&#8217;est vraiment très facile. Tout d&#8217;abord nous devons ajouter la variable d&#8217;environement suivante afin que TypeORM crée une table dédiée au démarrage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="env"># .env
# ...
TYPEORM_CACHE=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>N&#8217;oubliez pas de désactiver ce paramètre lors des test</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="env"># .test.env
# ...
TYPEORM_CACHE=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant nous allons ajouter deux lignes à notre méthode <code>paginate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/utils/paginate.utils.ts</span>
<span class="c1">// ...</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">paginate</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">).</span><span class="nx">getCount</span><span class="p">();</span>
  <span class="c1">// ...</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">queryBuilder</span>
    <span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">PER_PAGE</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">getMany</span><span class="p">();</span>
  <span class="c1">// ...</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. La méthode <code>cache</code> s&#8217;occupe de tout. Essayons pour voir. Lancez le serveur <code>npm start</code> et envoyons une requête HTTP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> <span class="s2">"http://localhost:3000/products?title=42"</span>
Total: 0,019708</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
L’option <code>-w</code> nous permet de récupérer le temps de la requête, <code>-o</code> redirige la réponse vers un fichier et <code>-s</code> masque l’affichage de cURL
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le temps de réponse prend environ 20 millisecondes en utilisant cURL. Mais regardons plutôt la console du serveur qui nous affiche les requêtes SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="p">...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"query-result-cache"</span> <span class="nv">"cache"</span> <span class="k">WHERE</span> <span class="nv">"cache"</span><span class="p">.</span><span class="nv">"query"</span> <span class="o">=</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: ...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="nv">"cnt"</span> <span class="k">FROM</span> <span class="nv">"product"</span> <span class="nv">"Product"</span> <span class="k">WHERE</span> <span class="n">published</span> <span class="o">=</span> <span class="k">TRUE</span> <span class="k">AND</span> <span class="k">lower</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: ...</span>
<span class="n">query</span><span class="p">:</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"query-result-cache"</span><span class="p">(</span><span class="nv">"identifier"</span><span class="p">,</span> <span class="nv">"query"</span><span class="p">,</span> <span class="nv">"time"</span><span class="p">,</span> <span class="nv">"duration"</span><span class="p">,</span> <span class="nv">"result"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span> <span class="c1">-- PARAMETERS: ...</span>
<span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Voici quelques explications sur ces requêtes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>une requête est effectuée sur la table <code>"query-result-cache"</code> afin de voir si un cache est présent</p>
</li>
<li>
<p>la requête est effectuée car le cache n&#8217;existait pas</p>
</li>
<li>
<p>le résultat est insérée dans la table <code>"query-result-cache"</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Essayons d&#8217;exécuter la commande cURL à nouveau:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> <span class="s2">"http://localhost:3000/products?title=42"</span>
Total: 0,007368</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous voyons que le temps de réponse est à présent divisé par deux. Bien évidement ce chiffre est à prendre avec des pincettes mais voyons dans la console ce qui vient de ce passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"query-result-cache"</span> <span class="nv">"cache"</span> <span class="k">WHERE</span> <span class="nv">"cache"</span><span class="p">.</span><span class="nv">"query"</span> <span class="o">=</span> <span class="o">?</span> <span class="c1">-- PARAMETERS: ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Le cache a été utilisé et &#8230;&#8203; rien de plus! Maintenant c&#8217;est à vous de juger de quelles requêtes peuvent être mise en cache et pour combien de temps en fonction du besoin.</p>
</div>
<div class="paragraph">
<p>L’amélioration est donc énorme! <em>Committons</em> une dernière fois nos changements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds caching for the serializers"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_activation_des_cors">Activation des CORS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans cette dernière section, je vais vous parler d&#8217;un dernier problème que vous allez sûrement rencontrer si vous êtes amenés à travailler avec votre API.</p>
</div>
<div class="paragraph">
<p>Lors de la première requête d&#8217;un site externe (via une requête AJAX par exemple), vous aller rencontrer une erreur de ce genre:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Failed to load <a href="https://example.com/" class="bare">https://example.com/</a>: No ‘Access-Control-Allow-Origin’ header is present on the requested resource. Origin ‘https://anfo.pl' is therefore not allowed access. If an opaque response serves your needs, set the request’s mode to ‘no-cors’ to fetch the resource with CORS disabled.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>"Mais qu&#8217;est ce que signifie <em>Access-Control-Allow-Origin</em>??". Le comportement que vous observez est l&#8217;effet de l&#8217;implémentation CORS des navigateurs. Avant la standardisation de CORS, il n&#8217;y avait aucun moyen d&#8217;appeler un terminal API sous un autre domaine pour des raisons de sécurité. Ceci a été (et est encore dans une certaine mesure) bloqué par la politique de la même origine.</p>
</div>
<div class="paragraph">
<p>CORS est un mécanisme qui a pour but de permettre les requêtes faites en votre nom et en même temps de bloquer certaines requêtes faites par des scripts malhonnêtes et est déclenché lorsque vous faites une requête HTTP à:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un domaine différent</p>
</li>
<li>
<p>un sous-domaine différent</p>
</li>
<li>
<p>un port différent</p>
</li>
<li>
<p>un protocole différent</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous devons manuellement activer cette fonctionnalité afin que n&#8217;importe quel client puisse effectuer des requêtes sur notre API. Une librairie tout simple existe déjà donc nous allons les installer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">--save</span> cors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et ensuite il suffit de modifier un tout petit peu notre serveur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ts"><span class="c1">// src/main.ts</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">reflect-metadata</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">cors</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="nx">server</span>
  <span class="p">.</span><span class="nx">setConfig</span><span class="p">(</span><span class="nx">app</span> <span class="o">=&gt;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">()))</span>
  <span class="p">.</span><span class="nx">build</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Listen on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">/`</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà! Il est maintenant temps de faire notre dernier commit et de merger nos modifications sur la branche master.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Activate CORS"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_9">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si vous arrivez à ce point, cela signifie que vous en avez fini avec le livre. Bon travail! Vous venez de devenir un grand développeur Node.js, c’est sûr. Nous avons donc construit ensemble une API solide et complète. Celle-ci possède toutes les qualité pour détrôner <a href="https://www.amazon.com/">Amazon</a>, soyez en sûr.</p>
</div>
<div class="paragraph">
<p>Merci d’avoir traversé cette grande aventure avec moi. Gardez à l&#8217;esprit que vous venez de voir une de nombreuse manière d&#8217;architecturer une API avec Node.js. J&#8217;espère que celle-ci vous aura permis de découvrir des nouvelles notions et surtout que vous avez pris autant de plaisir à coder que moi.</p>
</div>
<div class="paragraph">
<p>Je tiens à vous rappeler que tout le code source de ce livre est disponible au format <a href="https://asciidoctor.org">Asciidoctor</a> sur <a href="https://github.com/madeindjs/rest-api.ts">GitHub</a>. Ainsi n’hésitez pas à <a href="https://github.com/madeindjs/rest-api.ts/fork">forker</a> le projet si vous voulez l’améliorer ou corriger une faute qui m’aurait échappée.</p>
</div>
<div class="paragraph">
<p>Si vous avez aimé ce livre, n&#8217;hésitez pas à me le faire savoir par mail <a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a>. Je suis ouvert à toutes critiques, bonne ou mauvaise, autour d&#8217;une bonne bière :) .</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2021-01-17 20:01:53 +0100
</div>
</div>
</body>
</html>