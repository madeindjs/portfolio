<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="description" content="Apprenez les meilleurs pratiques pour construire une API avec Ruby on Rails 6">
<meta name="keywords" content="Rails, API, Ruby, Software">
<meta name="author" content="Alexandre Rousseau">
<meta name="copyright" content="CC-BY-SA 4.0, MIT">
<title>API on Rails 6</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>API on Rails 6</h1>
<div class="details">
<span id="author" class="author">Alexandre Rousseau</span><br>
<span id="email" class="email"><a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a></span><br>
<span id="revnumber">version 6.9,</span>
<span id="revdate">2020-12-20</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#chapter00-before">Avant-propos</a>
<ul class="sectlevel1">
<li><a href="#_a_propos_de_lauteur_original">A propos de l&#8217;auteur original</a></li>
<li><a href="#_droits_dauteur_et_licence">Droits d&#8217;auteur et licence</a></li>
<li><a href="#_merci">Merci</a></li>
</ul>
</li>
<li><a href="#chapter01-introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#_conventions_sur_ce_livre">Conventions sur ce livre</a></li>
<li><a href="#_environnements_de_développement">Environnements de développement</a>
<ul class="sectlevel2">
<li><a href="#_éditeurs_de_texte_et_terminal">Éditeurs de texte et Terminal</a></li>
<li><a href="#_navigateur_web">Navigateur web</a></li>
<li><a href="#_gestionnaire_de_paquets">Gestionnaire de paquets</a></li>
<li><a href="#_git">Git</a></li>
<li><a href="#_ruby">Ruby</a></li>
</ul>
</li>
<li><a href="#_initialisation_du_projet">Initialisation du projet</a></li>
<li><a href="#_contrôle_de_version">Contrôle de version</a></li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter02-api">L&#8217;API</a>
<ul class="sectlevel1">
<li><a href="#_planification_de_lapplication">Planification de l&#8217;application</a></li>
<li><a href="#_mettre_en_place_lapi">Mettre en place l&#8217;API</a>
<ul class="sectlevel2">
<li><a href="#_routes_contraintes_et_namespaces">Routes, contraintes et <em>Namespaces</em></a></li>
</ul>
</li>
<li><a href="#_conclusion_2">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter03-presenting-users">Présentation des utilisateurs</a>
<ul class="sectlevel1">
<li><a href="#_modèle_dutilisateur">Modèle d&#8217;utilisateur</a>
<ul class="sectlevel2">
<li><a href="#_génération_du_modèle_user">Génération du modèle <code>User</code></a></li>
<li><a href="#_hachage_du_mot_de_passe">Hachage du mot de passe</a></li>
</ul>
</li>
<li><a href="#_construire_les_utilisateurs">Construire les utilisateurs</a>
<ul class="sectlevel2">
<li><a href="#_tester_notre_ressource_avec_curl">Tester notre ressource avec cURL</a></li>
<li><a href="#_créer_les_utilisateurs">Créer les utilisateurs</a></li>
<li><a href="#_mettre_à_jour_les_utilisateurs">Mettre à jour les utilisateurs</a></li>
<li><a href="#_supprimer_lutilisateur">Supprimer l&#8217;utilisateur</a></li>
</ul>
</li>
<li><a href="#_conclusion_3">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter04-authentication">Authentification des utilisateurs</a>
<ul class="sectlevel1">
<li><a href="#_session_sans_état">Session sans état</a>
<ul class="sectlevel2">
<li><a href="#_présentation_de_json_web_token">Présentation de JSON Web Token</a></li>
<li><a href="#_mise_en_place_du_jeton_dauthentification">Mise en place du jeton d&#8217;authentification</a></li>
<li><a href="#_le_contrôleur_de_jeton">Le contrôleur de jeton</a></li>
</ul>
</li>
<li><a href="#_utilisateur_connecté">Utilisateur connecté</a></li>
<li><a href="#_authentification_avec_le_jeton">Authentification avec le jeton</a>
<ul class="sectlevel2">
<li><a href="#_autoriser_les_actions">Autoriser les actions</a></li>
</ul>
</li>
<li><a href="#_conclusion_4">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter05-user-products">Produits des utilisateurs</a>
<ul class="sectlevel1">
<li><a href="#_le_modèle_du_produit">Le modèle du produit</a>
<ul class="sectlevel2">
<li><a href="#_les_fondements_du_produit">Les fondements du produit</a></li>
<li><a href="#_validations_des_produits">Validations des produits</a></li>
</ul>
</li>
<li><a href="#_point_dentrée_pour_nos_produits">Point d&#8217;entrée pour nos produits</a>
<ul class="sectlevel2">
<li><a href="#_action_daffichage_dun_produit">Action d&#8217;affichage d&#8217;un produit</a></li>
<li><a href="#_liste_des_produits">Liste des produits</a></li>
<li><a href="#_création_des_produits">Création des produits</a></li>
<li><a href="#_mise_à_jour_des_produits">Mise à jour des produits</a></li>
<li><a href="#_suppression_des_produits">Suppression des produits</a></li>
</ul>
</li>
<li><a href="#_remplir_la_base_de_données">Remplir la base de données</a></li>
<li><a href="#_conclusion_5">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter06-improve-json">Modélisation du JSON</a>
<ul class="sectlevel1">
<li><a href="#_présentation_de_jsonapi">Présentation de JSON:API</a></li>
<li><a href="#_sérialiser_lutilisateur">Sérialiser l&#8217;utilisateur</a></li>
<li><a href="#_sérialiser_les_produits">Sérialiser les produits</a>
<ul class="sectlevel2">
<li><a href="#_sérialiser_les_associations">Sérialiser les associations</a></li>
</ul>
</li>
<li><a href="#_théorie_de_linjection_des_relations">Théorie de l&#8217;injection des relations</a>
<ul class="sectlevel2">
<li><a href="#_intégrer_dans_un_attribut_meta">Intégrer dans un attribut meta</a></li>
<li><a href="#_incorporer_lobjet_dans_lattribut">Incorporer l&#8217;objet dans l&#8217;attribut</a></li>
<li><a href="#_incorporer_les_relation_dans_include">Incorporer les relation dans <code>include</code></a></li>
</ul>
</li>
<li><a href="#_application_de_linjection_des_relations">Application de l&#8217;injection des relations</a>
<ul class="sectlevel2">
<li><a href="#_récupérer_les_produits_pour_des_utilisateurs">Récupérer les produits pour des utilisateurs</a></li>
</ul>
</li>
<li><a href="#_rechercher_les_produits">Rechercher les produits</a>
<ul class="sectlevel2">
<li><a href="#_le_mot_clé_by">Le mot-clé by</a></li>
<li><a href="#_par_prix">Par prix</a></li>
<li><a href="#_tri_par_date_de_création">Tri par date de création</a></li>
<li><a href="#_moteur_de_recherche">Moteur de recherche</a></li>
</ul>
</li>
<li><a href="#_conclusion_6">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter07-placing-orders">Création des commandes</a>
<ul class="sectlevel1">
<li><a href="#_modélisation_de_la_commande">Modélisation de la commande</a>
<ul class="sectlevel2">
<li><a href="#_les_commandes_et_les_produits">Les commandes et les produits</a></li>
</ul>
</li>
<li><a href="#_exposer_le_modèle_dutilisateur">Exposer le modèle d&#8217;utilisateur</a>
<ul class="sectlevel2">
<li><a href="#_afficher_une_seule_commande">Afficher une seule commande</a></li>
<li><a href="#_placement_et_commandes">Placement et commandes</a></li>
</ul>
</li>
<li><a href="#_envoyer_un_email_de_confirmation">Envoyer un email de confirmation</a></li>
<li><a href="#_conclusion_7">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter08-improve_orders">Améliorer les commandes</a>
<ul class="sectlevel1">
<li><a href="#_diminution_de_la_quantité_de_produit">Diminution de la quantité de produit</a>
<ul class="sectlevel2">
<li><a href="#_étendre_le_modèle_de_placement">Étendre le modèle de placement</a></li>
</ul>
</li>
<li><a href="#_validation_du_stock_des_produits">Validation du stock des produits</a></li>
<li><a href="#_mettre_à_jour_le_prix_total">Mettre à jour le prix total</a></li>
<li><a href="#_conclusion_8">Conclusion</a></li>
</ul>
</li>
<li><a href="#chapter09-optimization">Optimisations</a>
<ul class="sectlevel1">
<li><a href="#_pagination">Pagination</a>
<ul class="sectlevel2">
<li><a href="#_les_produits">Les produits</a></li>
<li><a href="#_liste_des_commandes">Liste des commandes</a></li>
<li><a href="#_factorisation_de_la_pagination">Factorisation de la pagination</a></li>
</ul>
</li>
<li><a href="#_mise_en_cache">Mise en cache</a></li>
<li><a href="#_requêtes_n1">Requêtes N+1</a>
<ul class="sectlevel2">
<li><a href="#_prevention_des_requêtes_n1">Prevention des requêtes N+1</a></li>
</ul>
</li>
<li><a href="#_activation_des_cors">Activation des CORS</a></li>
<li><a href="#_conclusion_9">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="chapter00-before" class="sect0">Avant-propos</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>"API on Rails 6" est basé sur <a href="http://apionrails.icalialabs.com/book/">"APIs on Rails: Building REST APIs with Rails"</a>. Celui-ci fut initialement publié en 2014 par <a href="https://twitter.com/kurenn">Abraham Kuri</a> sous les licences <a href="http://opensource.org/licenses/MIT">MIT</a> et <a href="http://people.freebsd.org/~phk/">Beerware</a>.</p>
</div>
<div class="paragraph">
<p>Cette première version, non maintenue, était prévue pour la version 4 de Ruby on Rails qui ne <a href="https://guides.rubyonrails.org/maintenance_policy.html#security-issues">reçoit plus que les mises à jour de sécurité</a>. J&#8217;ai voulu mettre à jour cet excellent ouvrage et contribuer à la communauté francophone en le traduisant moi-même et en l&#8217;adaptant aux nouvelles versions de Ruby on Rails. Ce livre est donc disponible pour la version 5.2 de Ruby on Rail et la version 6.0 (celle que vous lisez actuellement).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Ce livre est aussi disponible dans la langue de Shakespeare.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dans cette version je n&#8217;ai pas seulement cherché à rendre les exemples compatibles mais j&#8217;ai aussi voulu simplifier la mise en place d&#8217;une API avec Rails en utilisant des librairies plus récentes et surtout: maintenues.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_propos_de_lauteur_original">A propos de l&#8217;auteur original</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Je m&#8217;appelle <a href="http://rousseau-alexandre.fr">Alexandre Rousseau</a> et je suis un développeur Rails passionné avec plus de 4 ans d&#8217;expérience (à l&#8217;heure où j&#8217;écris ces lignes). Je suis actuellement associé chez (<a href="https://isignif.fr">iSignif SAS</a>) où je construis et maintiens un produit de type SAAS en utilisant Rails. Je contribue aussi à la communauté Ruby en produisant et maintenant quelques gemmes que vous pouvez consulter sur <a href="https://rubygems.org/profiles/madeindjs">mon profil Rubygems.org</a>. La plupart de mes projets sont sur GitHub donc <a href="http://github.com/madeindjs/">n&#8217;hésitez pas à me suivre</a>.</p>
</div>
<div class="paragraph">
<p>Tout le code source de ce livre est disponible au format <a href="https://asciidoctor.org">Asciidoctor</a> sur <a href="https://github.com/madeindjs/api_on_rails">GitHub</a>. Ainsi n&#8217;hésitez pas à <a href="https://github.com/madeindjs/api_on_rails/fork">forker</a> le projet si vous voulez l&#8217;améliorer ou corriger une faute qui m&#8217;aurait échappée.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_droits_dauteur_et_licence">Droits d&#8217;auteur et licence</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cette traduction est disponible sous <a href="http://opensource.org/licenses/MIT">licence MIT</a>. Tout le code source de ce livre est disponible au format <a href="https://asciidoctor.org">Asciidoctor</a> sur <a href="https://github.com/madeindjs/api_on_rails">GitHub</a></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">licence MIT</div>
<div class="paragraph">
<p>La licence MIT Copyright (c) 2019 Alexandre Rousseau</p>
</div>
<div class="paragraph">
<p>La permission est accordée, à titre gratuit, à toute personne obtenant une copie de ce logiciel et la documentation associée, pour faire des modifications dans le logiciel sans restriction et sans limitation des droits d&#8217;utiliser, copier, modifier, fusionner, publier, distribuer, concéder sous licence, et / ou de vendre les copies du Logiciel, et à autoriser les personnes auxquelles le Logiciel est meublé de le faire, sous réserve des conditions suivantes:</p>
</div>
<div class="paragraph">
<p>L&#8217;avis de copyright ci-dessus et cette autorisation doivent être inclus dans toutes les copies ou parties substantielles du Logiciel.</p>
</div>
<div class="paragraph">
<p>LE LOGICIEL EST FOURNI «TEL QUEL», SANS GARANTIE D&#8217;AUCUNE SORTE, EXPLICITE OU IMPLICITE, Y COMPRIS, MAIS SANS S&#8217;Y LIMITER, LES GARANTIES DE QUALITÉ MARCHANDE, ADAPTATION À UN USAGE PARTICULIER ET D&#8217;ABSENCE DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU TITULAIRES DOIVENT ÊTRE TENUS RESPONSABLE DE TOUT DOMMAGE, RÉCLAMATION OU AUTRES RESPONSABILITÉS, SOIT DANS UNE ACTION DE CONTRAT, UN TORT OU AUTRE, PROVENANT DE, DE OU EN RELATION AVEC LE LOGICIEL OU L&#8217;UTILISATION OU DE TRANSACTIONS AUTRES LE LOGICIEL.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>"API on Rails 6" de <a href="https://github.com/madeindjs/api_on_rails">Alexandre Rousseau</a> est mis à disposition selon les termes de la licence <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution - Partage dans les Mêmes Conditions 4.0 International</a>. Fondé sur une œuvre à <a href="http://apionrails.icalialabs.com/book/" class="bare">http://apionrails.icalialabs.com/book/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_merci">Merci</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un grand merci à tous les contributeurs de Github qui rendent ce livre vivant. Par ordre alphabétique :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/airdry">airdry</a></p>
</li>
<li>
<p><a href="https://github.com/Landris18">Landris18</a></p>
</li>
<li>
<p><a href="https://github.com/lex111">lex111</a></p>
</li>
<li>
<p><a href="https://github.com/cuilei5205189">cuilei5205189</a></p>
</li>
<li>
<p><a href="https://github.com/franklinjosmell">franklinjosmell</a></p>
</li>
<li>
<p><a href="https://github.com/notapatch">notapatch</a></p>
</li>
<li>
<p><a href="https://github.com/promisepreston">promisepreston</a></p>
</li>
<li>
<p><a href="https://github.com/tacataca">tacataca</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter01-introduction" class="sect0">Introduction</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Bienvenue sur API on Rails 6, un tutoriel sous stéroïdes pour apprendre la meilleure façon de construire votre prochaine API avec Rails. Le but de ce livre est de vous fournir une méthodologie complète pour développer une API RESTful en suivant les meilleures pratiques.</p>
</div>
<div class="paragraph">
<p>Lorsque vous en aurez fini avec ce livre, vous serez en mesure de créer votre propre API et de l&#8217;intégrer à n&#8217;importe quel client comme un navigateur Web ou une application mobile. Le code généré est construit avec Ruby on Rails 6.0 qui est la version actuelle.</p>
</div>
<div class="paragraph">
<p>L&#8217;intention de ce livre n&#8217;est pas seulement de vous apprendre à construire une API avec Rails mais plutôt de vous apprendre comment construire une API <strong>évolutive</strong> et <strong>maintenable</strong> avec Rails. C&#8217;est-à-dire améliorer vos connaissances actuelles avec Rails. Dans ce voyage, vous allez apprendre à:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utiliser Git pour le contrôle de version</p>
</li>
<li>
<p>Construire des réponses JSON</p>
</li>
<li>
<p>Tester vos points d&#8217;entrées avec des tests unitaires et fonctionnels</p>
</li>
<li>
<p>Mettre en place une authentification avec des JSON Web Tokens (JWT)</p>
</li>
<li>
<p>Utiliser les spécifications JSON:API</p>
</li>
<li>
<p>Optimiser et mettre en cache l&#8217;API</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Je vous recommande fortement de suivre toutes les étapes de ce livre. Essayez de ne pas sauter des chapitres car je vais vous proposer des conseils et des astuces pour vous améliorer tout au long du livre. Vous pouvez vous considérer comme le personnage principal d&#8217;un jeu vidéo qui obtient un niveau supérieur à chaque chapitre.</p>
</div>
<div class="paragraph">
<p>Dans ce premier chapitre je vous expliquerai comment configurer votre environnement (au cas où vous ne l&#8217;auriez pas déjà fait). Nous allons ensuite créer une application appelée <code>market_place_api</code>. Je veillerai à vous enseigner les meilleures pratiques que j&#8217;ai pu apprendre au cours de mon expérience. Cela signifie qu&#8217;après avoir initialisé le projet, nous commencerons à utiliser <strong>Git</strong>.</p>
</div>
<div class="paragraph">
<p>Dans les prochains chapitres, nous allons construire l&#8217;application en suivant une méthode de travail simple que j&#8217;utilise quotidiennement. Nous développerons toute l&#8217;application en utilisant le <strong>développement piloté par les tests</strong> (TDD). Je vous expliquerai aussi l&#8217;intérêt d&#8217;utiliser une API pour votre prochain projet et de choisir un format de réponse adapté comme le JSON ou le XML. Plus loin, nous mettrons les mains dans le code et nous compléterons les bases de l&#8217;application en construisant toutes les routes nécessaires. Nous sécuriserons aussi l&#8217;accès à l&#8217;API en construisant une authentification par échange d&#8217;en-têtes HTTP. Enfin, dans le dernier chapitre, nous ajouterons quelques techniques d&#8217;optimisation pour améliorer la structure et les temps de réponse du serveur.</p>
</div>
<div class="paragraph">
<p>L&#8217;application finale sera une application de place de marché qui permettra à des vendeurs de mettre en place leur propre boutique en ligne. Les utilisateurs seront en mesure de passer des commandes, télécharger des produits et plus encore. Il existe de nombreuses options pour créer une boutique en ligne comme <a href="http://shopify.com/">Shopify</a>, <a href="http://spreecommerce.com/">Spree</a> ou <a href="http://magento.com/">Magento</a>.</p>
</div>
<div class="paragraph">
<p>Tout au long de ce voyage (cela dépend de votre expertise), vous allez vous améliorer et être en mesure de mieux comprendre certaines des meilleures ressources Rails. J&#8217;ai aussi pris certaines des pratiques que j&#8217;ai trouvées sur <a href="http://railscasts.com/">Railscasts</a>, <a href="http://codeschool.com/">CodeSchool</a> et <a href="http://jsonapi.org/format/">JSON API</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conventions_sur_ce_livre">Conventions sur ce livre</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les conventions de ce livre sont basées sur celles du <a href="https://www.railstutorial.org/book">Tutoriel Ruby on Rails</a>. Dans cette section, je vais en mentionner quelques-unes que vous ne connaissez peut-être pas.</p>
</div>
<div class="paragraph">
<p>Je vais utiliser de nombreux exemples en utilisant des ligne de commande. Je ne vais pas traiter avec Windows <code>cmd</code> (désolé les gars). Je vais baser tous les exemples en utilisant l&#8217;invite de ligne de commande de style Unix. Voici un exemple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"A command-line command"</span>
A command-line <span class="nb">command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>J&#8217;utiliserai quelques principes spécifiques à Ruby. C&#8217;est-à-dire:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>"Éviter"</em> signifie que vous n&#8217;êtes pas censé le faire.</p>
</li>
<li>
<p><em>"Préférer"</em> indique que parmi les deux options, la première est la plus appropriée.</p>
</li>
<li>
<p><em>"Utiliser"</em> signifie que vous êtes en mesure d&#8217;utiliser la ressource.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Si vous rencontrez une erreur quelconque lors de l&#8217;exécution d&#8217;une commande, je vous recommande d&#8217;utiliser votre moteur de recherche pour trouver votre solution. Malheureusement, je ne peux pas couvrir toutes les erreurs possibles. Si vous rencontrez des problèmes avec ce tutoriel, vous pouvez toujours <a href="mailto:contact@rousseau-alexandre.fr">m&#8217;envoyer un email</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_environnements_de_développement">Environnements de développement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour presque tous les développeurs, l&#8217;une des parties les plus douloureuses est de mettre en place un environnement de développement confortable. Si vous le faites correctement, les prochaines étapes devraient être un jeu d&#8217;enfant. Je vais vous guider dans cette étape afin de vous faciliter la tâche et de vous motiver.</p>
</div>
<div class="sect2">
<h3 id="_éditeurs_de_texte_et_terminal">Éditeurs de texte et Terminal</h3>
<div class="paragraph">
<p>Les environnements de développement diffèrent d&#8217;un ordinateur à l&#8217;autre. Ce n&#8217;est pas le cas avec les éditeurs de texte. Je pense que pour le développement avec Rails, un IDE est beaucoup trop lourd. Cependant certains pensent que c&#8217;est la meilleure façon de travailler. Si c&#8217;est votre cas, je vous recommande d&#8217;essayer <a href="http://www.aptana.com/products/radrails">RadRails</a> ou <a href="http://www.jetbrains.com/ruby/index.html">RubyMine</a>. Tous deux sont bien maintenus et possèdent de nombreuses intégrations par défaut. Maintenant, pour ceux qui, comme moi, préfèrent des outils simples, je peux vous dire qu&#8217;il existe beaucoup d&#8217;outils disponibles que vous pourrez personnaliser via des plugins et plus.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Éditeur de texte</strong>: J&#8217;utilise personnellement <a href="http://www.vim.org/">Vim</a> comme éditeur. Au cas où vous n&#8217;êtes pas un fan de Vim, il y a beaucoup d&#8217;autres solutions comme <a href="http://www.sublimetext.com/">Sublime Text</a> qui est facile à prendre en main et surtout multi-plateforme . Il est fortement inspiré par <a href="http://macromates.com/">TextMate</a>. Une troisième option est d&#8217;utiliser un éditeur de texte plus récent comme <a href="https://atom.io/">Atom</a> de <a href="http://gitub.com/">GitHub</a>. C&#8217;est un éditeur de texte prometteur fait en JavaScript. Il est facile à personnaliser pour répondre à vos besoins. N&#8217;importe lequel des éditeurs que je viens de vous présenter fera le travail. Choisissez donc celui où vous êtes le plus à l&#8217;aise.</p>
</li>
<li>
<p><strong>Terminal</strong>: Je ne suis pas un fan de l&#8217;application Terminal par défaut sous Mac OS. Je recommande <a href="http://www.iterm2.com/#/section/home">iTerm2</a>, qui est un remplacement de terminal pour Mac OS. Si vous êtes sous Linux, vous avez probablement déjà un bon terminal.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_navigateur_web">Navigateur web</h3>
<div class="paragraph">
<p>Quand au navigateur, je conseillerai directement <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a>. Mais d&#8217;autres développeurs utilisent <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> ou même <a href="https://www.apple.com/safari/">Safari</a>. N&#8217;importe lequel d&#8217;entre eux vous aidera à construire l&#8217;application que vous voulez. Ils proposent tous un bon inspecteur pour le DOM, un analyseur de réseau et de nombreuses autres fonctionnalités que vous connaissez peut-être déjà.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gestionnaire_de_paquets">Gestionnaire de paquets</h3>
<div class="ulist">
<ul>
<li>
<p><strong>Mac OS</strong>: Il existe de nombreuses options pour gérer la façon dont vous installez les paquets sur votre Mac, comme <a href="https://www.macports.org/">Mac Ports</a> ou <a href="http://brew.sh/">Homebrew</a>. Les deux sont de bonnes options, mais je choisirais la dernière. J&#8217;ai rencontré moins de problèmes lors de l&#8217;installation de logiciels avec Homebrew. Pour installer <code>brew</code> il suffit d&#8217;exécuter la commande ci-dessous:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Linux</strong>: Vous êtes déjà prêts! Peu importe si vous utilisez <code>apt</code>, <code>pacman</code>, <code>yum</code> tant que vous vous sentez à l&#8217;aise et que vous savez comment installer des paquets.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_git">Git</h3>
<div class="paragraph">
<p>Nous utiliserons beaucoup Git et vous devriez aussi l&#8217;utiliser (non seulement pour ce tutoriel mais aussi pour tous vos projets). Pour l&#8217;installer, c&#8217;est très facile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sous Mac OS: <code>$ brew install git</code></p>
</li>
<li>
<p>sous Linux: <code>$ sudo apt-get install git</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ruby">Ruby</h3>
<div class="paragraph">
<p>Il existe de nombreuses façons d&#8217;installer et de gérer Ruby. Vous devriez probablement déjà avoir une version installée sur votre système. Pour connaître votre version, tapez simplement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ruby <span class="nt">-v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails 6.0 nécessite l&#8217;installation de la version 2.5 ou supérieure.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;installer, je vous recommande d&#8217;utiliser <a href="http://rvm.io/">Ruby Version Manager (RVM)</a> ou <a href="http://rbenv.org/">rbenv</a>.</p>
</div>
<div class="paragraph">
<p>Le principe de ces outils est de permettre d&#8217;installer plusieurs versions de Ruby sur une même machine, dans un environnement hermétique à une éventuelle version installée sur votre système d&#8217;exploitation et de pouvoir basculer de l&#8217;une à l&#8217;autre facilement.</p>
</div>
<div class="paragraph">
<p>Dans ce tutoriel, nous allons utiliser RVM mais peu importe laquelle de ces deux options vous utiliserez.</p>
</div>
<div class="paragraph">
<p>Pour installer RVM, rendez vous sur <a href="https://rvm.io/" class="bare">https://rvm.io/</a> et installez la clé GPG <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>. Une fois cela fait:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gpg <span class="nt">--keyserver</span> hkp://keys.gnupg.net <span class="nt">--recv-keys</span> 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
<span class="nv">$ </span><span class="se">\c</span>url <span class="nt">-sSL</span> https://get.rvm.io | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite, vous pouvez installer la dernière version de Ruby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rvm <span class="nb">install </span>2.6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si tout s&#8217;est bien passé, il est temps d&#8217;installer le reste des dépendances que nous allons utiliser.</p>
</div>
<div class="sect3">
<h4 id="_gemmes_rails_et_bibliothèques_manquantes">Gemmes, Rails et bibliothèques manquantes</h4>
<div class="paragraph">
<p>Tout d&#8217;abord, nous mettons à jour les Gemmes sur l&#8217;ensemble du système:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>gem update <span class="nt">--system</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans la plupart des cas, si vous êtes sous Mac OS, vous devriez installer des bibliothèques supplémentaires:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>brew <span class="nb">install </span>libtool libxslt libksba openssl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous installons ensuite les gemmes nécessaires et ignorons la documentation pour chaque gemme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">printf</span> <span class="s1">'gem: --no-document'</span> <span class="o">&gt;&gt;</span> ~/.gemrc
<span class="nv">$ </span>gem <span class="nb">install </span>bundler
<span class="nv">$ </span>gem <span class="nb">install </span>foreman
<span class="nv">$ </span>gem <span class="nb">install </span>rails <span class="nt">-v</span> 6.0.0.rc1</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Vous pouvez vous demander ce que signifie RC1. RC1 signifie <em>Release Candidate</em>. Au moment où j&#8217;écris ces lignes, la version finale pour Rails 6.0 n&#8217;est pas terminée. J&#8217;utilise donc la version la plus récente qui est 6.0.0.0.rc1
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vérifiez que tout fonctionne bien:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nt">-v</span>
Rails 6.0.0.rc1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bases_de_données">Bases de données</h4>
<div class="paragraph">
<p>Je vous recommande fortement d&#8217;installer <a href="http://www.postgresql.org/">Postgresql</a> pour gérer vos bases de données. Mais ici, pour plus de simplicité, nous allons utiliser <a href="http://www.sqlite.org/">SQlite</a>. Si vous utilisez Mac OS vous n&#8217;avez pas de bibliothèques supplémentaires à installer. Si vous êtes sous Linux, ne vous inquiétez pas, je vous guide:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>libxslt-dev libxml2-dev libsqlite3-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>ou</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>libxslt-devel libxml2-devel libsqlite3-devel</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initialisation_du_projet">Initialisation du projet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vous devez sans doute déjà savoir comment initialiser une application Rails. Si ce n&#8217;est pas le cas, jetez un coup d&#8217;œil à cette section.</p>
</div>
<div class="paragraph">
<p>La commande est donc la suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir</span> ~/workspace
<span class="nv">$ </span><span class="nb">cd</span> ~/workspace
<span class="nv">$ </span>rails new market_place_api <span class="nt">--api</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
L&#8217;option <code>--api</code> est apparue lors de la version 5 de Rails. Elle permet de limiter les librairies et <em>Middleware</em> inclus dans l&#8217;application. Cela permet aussi d&#8217;éviter de générer les vues HTML lors de l&#8217;utilisation des générateurs de Rails.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Comme vous pouvez le deviner, les commandes ci-dessus généreront les éléments indispensables à votre application Rails. La prochaine étape est d&#8217;ajouter quelques gemmes que nous utiliserons pour construire l&#8217;API.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contrôle_de_version">Contrôle de version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rappelez-vous que Git vous aide à suivre et à maintenir l&#8217;historique de votre code. Gardez à l&#8217;esprit que le code source de l&#8217;application est publié sur GitHub. Vous pouvez suivre le projet sur <a href="https://github.com/madeindjs/market_place_api_6">GitHub</a></p>
</div>
<div class="paragraph">
<p>Lorsque vous avez utilisé la commande <code>rails new</code>, Ruby on Rails a initialisé le répertoire Git pour vous. Cela signifie que vous n&#8217;avez pas besoin d&#8217;exécuter la commande <code>git init</code>.</p>
</div>
<div class="paragraph">
<p>Il faut néanmoins configurer les informations de l&#8217;auteur des <em>commits</em>. Si ce n&#8217;est pas déjà fait, placez vous dans le répertoire et lancez les commandes suivantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>git config user.name <span class="s2">"Type in your name"</span>
<span class="gp">$</span><span class="w"> </span>git config user.email <span class="s2">"Type in your email"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails fournit également un fichier <code>.gitignore</code> pour ignorer certains fichiers que nous ne voulons pas suivre. Le fichier <code>.gitignore</code> par défaut devrait ressembler à celui illustré ci-dessous :</p>
</div>
<div class="listingblock">
<div class="title">.gitignore</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span>Ignore bundler config.
<span class="go">/.bundle

</span><span class="gp">#</span><span class="w"> </span>Ignore the default SQLite database.
<span class="go">/db/*.sqlite3
/db/*.sqlite3-journal

</span><span class="gp">#</span><span class="w"> </span>Ignore all logfiles and tempfiles.
<span class="go">/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

</span><span class="gp">#</span><span class="w"> </span>Ignore uploaded files <span class="k">in </span>development.
<span class="go">/storage/*
!/storage/.keep
.byebug_history

</span><span class="gp">#</span><span class="w"> </span>Ignore master key <span class="k">for </span>decrypting credentials and more.
<span class="go">/config/master.key</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois Git mis en place, il suffit d&#8217;ajouter les fichiers et de valider les modifications. Les commandes nécessaires sont les suivantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Initial commit"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
J&#8217;ai appris que commencer un message par un verbe au présent décrit ce que fait le commit et non ce qu&#8217;il a fait. De cette façon il est plus facile de lire et de comprendre l&#8217;historique du projet (ou du moins pour moi). Je vais suivre cette pratique jusqu&#8217;à la fin du tutoriel.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enfin, et c&#8217;est une étape optionnelle, nous déployons le projet sur <strong>GitHub</strong> (je ne vais pas l&#8217;expliquer ici) et poussons notre code vers le serveur distant. On commence donc par ajouter un serveur distant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git remote add origin git@github.com:madeindjs/market_place_api_6.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite nous poussons le code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git push <span class="nt">-u</span> origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>Au fur et à mesure que nous avançons dans le tutoriel, j&#8217;utiliserai les pratiques que j&#8217;utilise quotidiennement. Cela inclut le travail avec les branches, le rebasage, le squash et bien d&#8217;autres. Vous n&#8217;avez pas à vous inquiéter si vous ne connaissez pas tous ces termes, je les expliquerai le temps venu.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cela a été un chapitre assez long. Si vous êtes arrivés ici, permettez-moi de vous féliciter. Les choses vont s&#8217;améliorer à partir de ce point. Commençons à mettre les mains dans le code!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter02-api" class="sect0">L&#8217;API</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans ce chapitre, je vais vous donner les grandes lignes de l&#8217;application. Vous devriez avoir lu le chapitre précédent. Si ce n&#8217;est pas le cas, je vous recommande de le faire.</p>
</div>
<div class="paragraph">
<p>Vous pouvez cloner le projet jusqu&#8217;ici avec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter02</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour résumer, nous avons simplement généré notre application Rails et réalisé notre premier commit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_planification_de_lapplication">Planification de l&#8217;application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Notre application sera assez simple. Elle se composera de cinq modèles. Ne vous inquiétez pas si vous ne comprenez pas bien ce qui se passe, nous reverrons et développerons chacune de ces ressources au fur et à mesure que nous avancerons avec le tutoriel.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="img/data_model.png" alt="Schéma des liaisons entre les différents modèles"></span></p>
</div>
<div class="paragraph">
<p>En bref, nous avons l&#8217;utilisateur (<code>User</code>) qui sera en mesure de passer de nombreuses commandes (<code>Order</code>), télécharger de multiples produits (<code>product</code>) qui peuvent avoir de nombreuses images (<code>Image</code>) ou commentaires (<code>Comment</code>) d&#8217;autres utilisateurs sur l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Nous n&#8217;allons pas construire d&#8217;interface pour l&#8217;interaction avec l&#8217;API afin de ne pas surcharger le tutoriel. Si vous voulez construire des vues, il existe de nombreuses options comme des frameworks JavaScript (<a href="https://angularjs.org/">Angular</a>, <a href="https://vuejs.org/">Vue.JS</a>, <a href="https://reactjs.org/">React</a>) ou des librairies mobiles (<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>).</p>
</div>
<div class="paragraph">
<p>À ce stade, vous devriez vous poser cette question:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>D&#8217;accord, mais j&#8217;ai besoin d&#8217;explorer et de visualiser l&#8217;API que je vais construire, non?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>C&#8217;est juste. Si vous <em>googlez</em> quelque chose lié à l&#8217;exploration d&#8217;une API, vous allez trouver pas mal de résultats. Vous pouvez par exemple utiliser <a href="https://www.getpostman.com/">Postman</a> qui est devenu incontournable. Mais nous n&#8217;allons pas l&#8217;utiliser. Dans notre cas nous allons utiliser <strong>cURL</strong> qui est un outil en ligne de commande disponible presque partout.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mettre_en_place_lapi">Mettre en place l&#8217;API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Une API est définie par <a href="https://fr.wikipedia.org/wiki/Interface_de_programmation">wikipedia</a> comme <em>une interface de programmation d&#8217;application (API) qui est un ensemble normalisé de composants qui sert de façade par laquelle un logiciel offre des services à d&#8217;autres logiciels</em>. En d&#8217;autres termes, il s&#8217;agit d&#8217;une façon dont les systèmes interagissent les uns avec les autres via une interface (dans notre cas un service web construit avec JSON). Il existe d&#8217;autres types de protocoles de communication comme SOAP, mais nous n&#8217;en parlons pas ici.</p>
</div>
<div class="paragraph">
<p>JSON est devenu incontournable en tant que format de fichier pour Internet en raison de sa lisibilité, de son extensibilité et de sa facilité à mettre en œuvre. Beaucoup de frameworks JavaScript l&#8217;utilisent comme protocole par défaut comme <a href="https://angularjs.org/">Angular</a> ou <a href="http://emberjs.com/">EmberJS</a>. D&#8217;autres grandes bibliothèques en Objective-C l&#8217;utilisent comme <a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> ou <a href="http://restkit.org/">RESTKit</a>. Il existe probablement de bonnes solutions pour Android mais en raison de mon manque d&#8217;expérience sur cette plate-forme de développement je ne peux pas vous recommander quelque chose.</p>
</div>
<div class="paragraph">
<p>Nous allons donc utiliser le format JSON pour construire notre API. La première idée qui pourrait vous venir à l&#8217;esprit serait de commencer à créer des routes en vrac. Le problème est qu&#8217;elles ne seraient pas normalisées. Un utilisateur ne pourrait pas deviner quelle ressource est renvoyée par une route.</p>
</div>
<div class="paragraph">
<p>C&#8217;est pourquoi une norme existe: <strong>REST</strong> <em>(Representational State Transfer)</em>. REST impose une norme pour les routes qui créent, lisent, mettent à jour ou suppriment des informations sur un serveur en utilisant de simples appels HTTP. C&#8217;est une alternative aux mécanismes plus complexes comme SOAP, CORBA et RPC. Un appel REST est simplement une requête GET HTTP vers le serveur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="soap">aService.getUser("1")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et avec REST, vous pouvez appeler une URL avec une requête HTTP spécifique. Dans ce cas avec une requête GET:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>http://domain.com/resources_name/uri_pattern</pre>
</div>
</div>
<div class="paragraph">
<p>Les API <em>RESTful</em> doivent suivre au minimum trois règles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Une URI de base comme <a href="http://example.com/resources/" class="bare">http://example.com/resources/</a></p>
</li>
<li>
<p>Un type de média Internet pour représenter les données, il est communément JSON et est communément défini par l&#8217;échange d&#8217;en-têtes.</p>
</li>
<li>
<p>Suivez les méthodes <a href="https://fr.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> standard telles que GET, POST, PUT, PUT, DELETE.</p>
<div class="ulist">
<ul>
<li>
<p><strong>GET</strong>: Lit la ou les ressources définies par le modèle URI</p>
</li>
<li>
<p><strong>POST</strong>: Crée une nouvelle entrée dans la collection de ressources</p>
</li>
<li>
<p><strong>PUT</strong>: Met à jour une collection ou un membre des ressources</p>
</li>
<li>
<p><strong>DELETE</strong>: Détruit une collection ou un membre des ressources</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cela peut sembler compliqué mais au fur et à mesure que nous avancerons dans le tutoriel cela deviendra beaucoup plus facile à comprendre.</p>
</div>
<div class="sect2">
<h3 id="_routes_contraintes_et_namespaces">Routes, contraintes et <em>Namespaces</em></h3>
<div class="paragraph">
<p>Avant de commencer à taper du code, nous allons préparer le répertoire Git. Le <em>workflow</em> que nous allons suivre est le suivant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nous allons créer une branche par chapitre</p>
</li>
<li>
<p>Une fois terminé, nous pousserons la branche sur GitHub</p>
</li>
<li>
<p>Nous la fusionnerons avec master</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Commençons donc par ouvrir le terminal dans le répertoire <code>market_place_api</code> et tapez la commande suivante pour créer la branche:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter02
Switched to a new branch <span class="s1">'chapter02'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons seulement travailler sur le fichier <code>config/routes.rb</code> car nous allons simplement définir les contraintes et le format de réponse par défaut pour chaque requête.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Effacez tout le code commenté qui se trouve dans le fichier. Nous n&#8217;en aurons pas besoin. Ensuite, faites un <em>commit</em>, juste pour vous échauffer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Removes comments from the routes file"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons isoler les contrôleurs API dans des <em>Namespace</em>. Avec Rails, c&#8217;est assez simple. Il suffit de créer un dossier sous <code>app/controllers</code> nommé <code>api</code>. Le nom est important car c&#8217;est le <em>Namespace</em> que nous allons utiliser pour gérer les contrôleurs pour les points d&#8217;entrée de l&#8217;API</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous ajoutons ensuite ce <em>Namespace</em> dans notre fichier <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span> <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>En définissant un <em>Namespace</em> dans le fichier <code>routes.rb</code>, Rails mappera automatiquement ce <em>Namespace</em> à un répertoire correspondant au nom sous le dossier contrôleur (dans notre cas le répertoire <code>api/</code>).</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Les types de medias supportés par Rails</div>
<div class="paragraph">
<p>Rails supporte jusqu&#8217;à 35 types de médias différents! Vous pouvez les lister en accédant à la classe <code>SET</code> sous le module de <code>Mime</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails c
2.6.3 :001 <span class="o">&gt;</span> Mime::SET.collect<span class="o">(</span>&amp;:to_s<span class="o">)</span>
 <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"text/html"</span>, <span class="s2">"text/plain"</span>, <span class="s2">"text/javascript"</span>, <span class="s2">"text/css"</span>, <span class="s2">"text/calendar"</span>, <span class="s2">"text/csv"</span>, <span class="s2">"text/vcard"</span>, <span class="s2">"text/vtt"</span>, <span class="s2">"image/png"</span>, <span class="s2">"image/jpeg"</span>, <span class="s2">"image/gif"</span>, <span class="s2">"image/bmp"</span>, <span class="s2">"image/tiff"</span>, <span class="s2">"image/svg+xml"</span>, <span class="s2">"video/mpeg"</span>, <span class="s2">"audio/mpeg"</span>, <span class="s2">"audio/ogg"</span>, <span class="s2">"audio/aac"</span>, <span class="s2">"video/webm"</span>, <span class="s2">"video/mp4"</span>, <span class="s2">"font/otf"</span>, <span class="s2">"font/ttf"</span>, <span class="s2">"font/woff"</span>, <span class="s2">"font/woff2"</span>, <span class="s2">"application/xml"</span>, <span class="s2">"application/rss+xml"</span>, <span class="s2">"application/atom+xml"</span>, <span class="s2">"application/x-yaml"</span>, <span class="s2">"multipart/form-data"</span>, <span class="s2">"application/x-www-form-urlencoded"</span>, <span class="s2">"application/json"</span>, <span class="s2">"application/pdf"</span>, <span class="s2">"application/zip"</span>, <span class="s2">"application/gzip"</span><span class="o">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est important parce que nous allons travailler avec JSON, l&#8217;un des types MIME intégrés par Rails. Ainsi nous avons juste besoin de spécifier ce format comme format par défaut:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># Api definition</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span>  <span class="k">do</span>
    <span class="c1"># We are going to list our resources here</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Jusqu&#8217;à présent, nous n&#8217;avons rien fait de fou. Nous voulons maintenant générer un <em>base_uri</em> qui inclut la version de l&#8217;API comme ceci: <a href="http://localhost:3000/api/v1" class="bare">http://localhost:3000/api/v1</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Régler l&#8217;API sous un sous-domaine est une bonne pratique car cela permet d&#8217;adapter l&#8217;application à un niveau DNS. Mais dans notre cas, nous allons simplifier les choses pour l&#8217;instant.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vous devriez vous soucier de versionner votre application dès le début car cela donnera une <strong>meilleure structure</strong> à votre API. Lorsque des changements interviendront sur votre API, vous pouvez ainsi proposer aux développeurs de s&#8217;adapter aux nouvelles fonctionnalités pendant que les anciennes sont dépréciées.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># We are going to list our resources here</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Les conventions des API</div>
<div class="paragraph">
<p>Vous pouvez trouver de nombreuses approches pour configurer la <code>base_uri</code> d&#8217;une API. En supposant que nous versionnons notre api:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>api.example.com/</code>: Je suis d&#8217;avis que c&#8217;est la voie à suivre, elle vous donne une meilleure interface et l&#8217;isolement, et à long terme peut vous aider à <a href="http://www.makeuseof.com/tag/optimize-your-dns-for-faster-internet/">mettre rapidement à l&#8217;échelle</a></p>
</li>
<li>
<p><code>example.com/api/</code>: Ce modèle est très commun. C&#8217;est un bon moyen de commencer quand vous ne voulez pas de <em>Namespace</em> de votre API avec sous un sous-domaine</p>
</li>
<li>
<p><code>example.com/api/v1</code>: Cela semble être une bonne idée. Définir la version de l&#8217;API par l&#8217;URL semble être un modèle plus descriptif. Cependant, vous forcez à inclure la version à l&#8217;URL sur chaque demande. Cela devient un problème si vous décidez de changer ce modèle</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Il est temps de faire un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add config/routes.rb
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Set the routes constraints for the api"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Afin de définir la version de l&#8217;API, nous devons d&#8217;abord ajouter un autre répertoire sous le dossier <code>api/</code> que nous avons créé:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/controllers/api/v1</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;API est désormais <em>scopée</em> via l&#8217;URL. Par exemple, avec la configuration actuelle, la récupération d&#8217;un produit via l&#8217;API se ferait avec cette url: <a href="http://localhost:3000/v1/products/1" class="bare">http://localhost:3000/v1/products/1</a>.</p>
</div>
<div class="paragraph">
<p>Ne vous inquiétez pas, nous rentrerons plus en détails à propos du versionnement plus tard. Il est temps de <em>commiter</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Set the routes namespaces for the api"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Il existe certaines pratiques dans la construction d&#8217;API qui recommandent de ne pas versionner l&#8217;API via l&#8217;URL. C&#8217;est vrai. Le développeur ne devrait pas être au courant de la version qu&#8217;il utilise. Dans un souci de simplicité, j&#8217;ai choisi de mettre de côté cette convention que nous pourrons appliquer dans un second temps.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous arrivons à la fin de notre chapitre. Il est donc temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>. Pour cela, on se place sur la branche <code>master</code> et on <em>merge</em> <code>chapter02</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter02</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_2">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ça a été un peu long, je sais, mais vous avez réussi! N&#8217;abandonnez pas, c&#8217;est juste notre petite fondation pour quelque chose de grand, alors continuez comme ça. Sachez qu&#8217;il y a des gemmes qui gèrent ce genre de configuration pour nous:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Sutto/rocket_pants">RocketPants</a></p>
</li>
<li>
<p><a href="https://github.com/bploetz/versionist">Versionist</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Je n&#8217;en parle pas ici puisque nous essayons d&#8217;apprendre comment mettre en œuvre ce genre de fonctionnalité.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter03-presenting-users" class="sect0">Présentation des utilisateurs</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans le chapitre précédent, nous avons réussi à mettre en place les bases de la configuration de notre application.</p>
</div>
<div class="paragraph">
<p>Dans les prochains chapitres, nous traiterons l&#8217;authentification des utilisateurs à l&#8217;aide de jetons d&#8217;authentification ainsi que la définition de permissions pour limiter l&#8217;accès aux utilisateurs connectés. Nous relierons ensuite les produits aux utilisateurs et leur donnerons la possibilité de passer des commandes.</p>
</div>
<div class="paragraph">
<p>Vous pouvez cloner le projet jusqu&#8217;à ce point avec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter03</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez déjà l&#8217;imaginer, il existe de nombreuses solutions d&#8217;authentification pour Rails comme <a href="https://github.com/binarylogic/authlogic">AuthLogic</a>, <a href="https://github.com/thoughtbot/clearance">Clearance</a> et <a href="https://github.com/plataformatec/devise">Devise</a>. Ces solutions sont des librairies clé en main, c&#8217;est à dire qu&#8217;elles permettent de gérer tout un tas de choses comme l&#8217;authentification, la fonctionnalité d&#8217;oubli de mot de passe, la validation, etc..</p>
</div>
<div class="paragraph">
<p>Nous ne les utiliserons pas afin de mieux appréhender le mécanisme d&#8217;authentification. Néanmoins nous allons utiliser la gemme <a href="https://github.com/codahale/bcrypt-ruby">bcrypt</a> afin de hasher le mots de passe de l&#8217;utilisateur.</p>
</div>
<div class="paragraph">
<p>Ce chapitre sera complet. Il sera peut-être long mais je vais essayer d&#8217;aborder autant de sujets que possible. N&#8217;hésitez pas à vous prendre un café et allons-y. A la fin de ce chapitre, vous aurez construit toute la logique des utilisateurs ainsi que la validation et la gestion des erreurs.</p>
</div>
<div class="paragraph">
<p>Nous voulons suivre ce chapitre, c&#8217;est donc un bon moment pour créer une nouvelle branche:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter03</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Assurez-vous simplement d&#8217;être sur la branche <code>master</code> avant.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modèle_dutilisateur">Modèle d&#8217;utilisateur</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_génération_du_modèle_user">Génération du modèle <code>User</code></h3>
<div class="paragraph">
<p>Nous allons commencer par générer notre modèle <code>User</code>. Ce modèle sera vraiment basique et contiendra seulement deux champs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>email</code> qui sera unique et lui permettra de se connecter à l&#8217;application</p>
</li>
<li>
<p><code>password_digest</code> qui contiendra la version <strong>haché</strong> du mot de passe (nous en reparlerons plus tard dans ce chapitre)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Afin de générer notre modèle <code>User</code>, nous utiliserons la méthode <em>generate model</em> fournie par Ruby on Rails. Elle s&#8217;utilise très facilement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model User email:string password_digest:string
invoke  active_record
      create    db/migrate/20190603195146_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      <span class="nb">test</span>/models/user_test.rb
      create      <span class="nb">test</span>/fixtures/users.yml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Dans le <em>design patern</em> MVC, le modèle est l&#8217;élément qui contient les données ainsi que de la logique en rapport avec les données: validation, lecture et enregistrement. Nous allons donc dans un premier temps créer cette partie.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cette commande génère beaucoup de fichiers! Ne vous inquiétez pas, nous allons les passer en revue les un après les autres.</p>
</div>
<div class="paragraph">
<p>Le fichier de migration contenu dans le dossier <em>db/migrate</em> contient la <strong>migration</strong> qui décrit les modifications qui seront effectuées sur la base de données. Ce fichier devrait ressembler à ceci</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:password_digest</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
la date insérée au début du nom du fichier de la migration devrait être différente chez vous puisque elle correspond à la date de création de la migration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons modifier un petit peu cette migration afin d&#8217;ajouter quelques validations côté base de données. Avec Rails il est d&#8217;usage de faire ces verifications directement dans le modèle Ruby mais c&#8217;est une bonne pratique de le faire aussi dans le schéma de la base de données.</p>
</div>
<div class="paragraph">
<p>Nous allons donc rajouter deux contraintes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l&#8217;email est présent: on utilise la propriété <code>null: false</code></p>
</li>
<li>
<p>l&#8217;email est unique: on utilise la propriété <code>unique: true</code></p>
</li>
<li>
<p>le mot de passe est obligatoire: on utilise la propriété <code>null: false</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La migration devient donc:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois la migration terminée, nous pouvons effectuer les modifications avec la commande suivante:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190603195146_create_users.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span>
<span class="o">==</span> <span class="mi">20190603195146</span> <span class="no">CreateUsers</span><span class="p">:</span> <span class="n">migrating</span> <span class="o">======================================</span>
<span class="o">--</span> <span class="n">create_table</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span>
   <span class="o">-&gt;</span> <span class="mf">0.0027</span><span class="n">s</span>
<span class="o">==</span> <span class="mi">20190603195146</span> <span class="no">CreateUsers</span><span class="p">:</span> <span class="n">migrated</span> <span class="p">(</span><span class="mf">0.0028</span><span class="n">s</span><span class="p">)</span> <span class="o">=============================</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
La commande va convertir notre migration en requête SQL qui va mettre à jour la base de données SQlite3 contenue dans le dossier <em>db</em>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_le_modèle">Le modèle</h4>
<div class="paragraph">
<p>Nous avons donc défini notre schéma de la base de données. La prochaine étape est de mettre à jour notre modèle afin de définir les <strong>règles de validation</strong>. Ces règles se définissent dans le modèle situé dans le dossier <em>app/models</em>.</p>
</div>
<div class="paragraph">
<p>Ruby on Rails propose un mécanisme complet de validation que vous pouvez consulter sur <a href="https://guides.rubyonrails.org/active_record_validations.html">leur documentation officielle</a>. Dans notre cas, nous voulons valider deux choses:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le courriel doit avoir un format valide</p>
</li>
<li>
<p>le courriel doit être unique</p>
</li>
<li>
<p>le mot de passe doit être rempli</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces trois règles se définissent par le code suivant:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">with: </span><span class="sr">/@/</span>
  <span class="n">validates</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Rails utilise une syntaxe très simple et le code est très lisible.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Validation du courriel</div>
<div class="paragraph">
<p>Vous remarquerez peut être que la validation du courriel utilise une validation simpliste en ne vérifiant que la présence d&#8217;un <code>@</code>.</p>
</div>
<div class="paragraph">
<p>C&#8217;est normal.</p>
</div>
<div class="paragraph">
<p>Une infinité d&#8217;exceptions existent en la matière d&#8217;adresse mail si bien <a href="https://davidcel.is/posts/stop-validating-email-addresses-with-regex/">que même <code>"Look at all these spaces!"@example.com</code> est une adresse valide</a>. Il vaut mieux donc privilégier une approche simple et confirmer le mail par un mail de validation.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_les_tests_unitaires">Les tests unitaires</h4>
<div class="paragraph">
<p>Nous terminons par les tests unitaires. Nous utilisons ici le framework de test Minitest qui est fourni par défaut avec Rails.</p>
</div>
<div class="paragraph">
<p>Minitest s&#8217;appuie sur des <em>Fixtures</em> qui permettent de remplir votre base de données avec des données <strong>prédéfinies</strong>. Les <em>Fixtures</em> sont définies dans des fichiers YAML dans le dossier <code>tests/fixtures</code>. Il y a un fichier par modèle.</p>
</div>
<div class="paragraph">
<p>Nous devons donc commencer par mettre à jour nos <code>tests/fixtures</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Les <em>fixtures</em> ne sont pas conçues pour créer tous les données dont vos tests ont besoin. Elle permettent juste de définir les données basiques dont votre application a besoin.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons donc commencer par créer une <em>fixture</em> définissant un utilisateur:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/users.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">one@one.org</span>
  <span class="na">password_digest</span><span class="pi">:</span> <span class="s">hashed_password</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons donc maintenant créer les tests. Il y en aura trois:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nous vérifions qu&#8217;un utilisateur avec des données valides est valide:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with a valid email should be valid'</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'test@test.org'</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>nous vérifions qu&#8217;un utilisateur avec un courriel invalide n&#8217;est pas valide:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with unvalid email should be unvalid'</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="s1">'test'</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>nous vérifions qu&#8217;un utilisateur avec un courriel déjà utilisé n&#8217;est pas valide. Nous utilisons donc le même courriel que la <em>fixture</em> que nous venons de créer.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="nb">test</span> <span class="s1">'user with taken email should be unvalid'</span> <span class="k">do</span>
  <span class="n">other_user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">email: </span><span class="n">other_user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password_digest: </span><span class="s1">'test'</span><span class="p">)</span>
  <span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">valid?</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Nous pouvons vérifier que notre implémentation est correcte juste en lançant simplement les tests unitaires que nous venons de créer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
...
3 runs, 3 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Je pense qu&#8217;il est temps de faire un petit <em>commit</em> afin de valider notre avancement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Create user model"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hachage_du_mot_de_passe">Hachage du mot de passe</h3>
<div class="paragraph">
<p>Nous avons précédemment mis en place le stockage des données de l&#8217;utilisateur. Il nous reste un problème à régler: <strong>le stockage des mot de passe est en clair</strong>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Si vous stockez les mots de passe des utilisateurs en clair, alors un attaquant qui vole une copie de votre base de données a une liste géante d&#8217;emails et de mots de passe. Certains de vos utilisateurs n&#8217;auront qu&#8217;un seul mot de passe&#8201;&#8212;&#8201;pour leur compte de courriel, pour leur compte bancaire, pour votre application. Un simple piratage pourrait dégénérer en un vol d&#8217;identité massif. - <a href="https://github.com/codahale/bcrypt-ruby#why-you-should-use-bcrypt">source - Why you should use bcrypt</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Nous allons donc utiliser la gemme bcrypt afin de hacher le mot de passe.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Le hachage consiste à transformer une chaîne de caractère en <em>Hash</em>. Ce <em>Hash</em> ne permet pas de retrouver la chaîne de caractère d&#8217;origine. Cependant nous pouvons facilement l&#8217;utiliser afin de savoir si une chaîne de caractère donnée correspond au <em>hash</em> que nous avons stocké.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous devons d&#8217;abord ajouter la gemme Bcrypt au <em>Gemfile</em>. Nous pouvons utiliser la commande <code>bundle add</code>. Celle-ci va s&#8217;occuper:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>d&#8217;ajouter la gemme au Gemfile en récupérant la version actuelle</p>
</li>
<li>
<p>lancer la commande <code>bundle install</code> qui va installer la gemme et mettre à jour le fichier <em>Gemfile.lock</em> qui "verrouille" la version actuelle de la gemme</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Lancez donc la commande suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add bcrypt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois la commande exécutée, la ligne suivante est ajoutée à la fin du <em>Gemfile</em>:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">gem</span> <span class="s2">"bcrypt"</span><span class="p">,</span> <span class="s2">"~&gt; 3.1"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
La version 3.1 de bcrypt est celle actuelle à l&#8217;heure où j&#8217;écris ces lignes. Elle peut donc varier pour votre cas.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Active Record nous propose une méthode <a href="https://github.com/rails/rails/blob/6-0-stable/activemodel/lib/active_model/secure_password.rb#L61"><code>ActiveModel::SecurePassword::has_secure_password</code></a> qui va s&#8217;interfacer avec Bcrypt et hacher le mot de passe pour nous très facilement.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_secure_password</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>has_secure_password</code> ajoute les validations suivantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Le mot de passe doit être présent lors de la création.</p>
</li>
<li>
<p>La longueur du mot de passe doit être inférieure ou égale à 72 octets.</p>
</li>
<li>
<p>la confirmation du mot de passe à l&#8217;aide de l&#8217;attribut <code>password_confirmation</code> (s&#8217;il est envoyé)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>De plus, cette méthode va ajouter un attribut <code>User#password</code> qui sera automatiquement haché et sauvegardé dans l&#8217;attribut <code>User#password_digest</code>.</p>
</div>
<div class="paragraph">
<p>Essayons cela tout de suite dans la console de Rails. Ouvrez une console avec <code>rails console</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'toto@toto.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span>
 <span class="o">=&gt;</span><span class="c1">#&lt;User id: 1, email: "toto@toto.org", password_digest: [FILTERED], created_at: "2019-06-04 10:51:44", updated_at: "2019-06-04 10:51:44"&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez ainsi constater que lorsqu&#8217;on appelle la méthode <code>User#create!</code>, l&#8217;attribut <code>password</code> est haché et stocké dans <code>password_digest</code>. Nous pouvons aussi envoyer un attribut <code>password_confirmation</code> que ActiveRecord va comparer à <code>password</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'tata@tata.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span><span class="p">,</span> <span class="ss">password_confirmation: </span><span class="s1">'azerty'</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span> <span class="p">(</span><span class="no">Validation</span> <span class="ss">failed: </span><span class="no">Password</span> <span class="n">confirmation</span> <span class="n">doesn</span> <span class="n">t</span> <span class="n">match</span> <span class="no">Password</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tout fonctionne comme prévus! Faisons maintenant un <em>commit</em> afin de garder un historique concis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Setup Bcrypt"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_construire_les_utilisateurs">Construire les utilisateurs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il est temps de faire notre premier point d&#8217;entrée. Nous allons juste commencer à construire l&#8217;action <code>show</code> pour l&#8217;utilisateur qui va afficher un utilisateur en JSON. Nous allons d&#8217;abord</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>générer le <code>users_controller</code></p>
</li>
<li>
<p>ajouter les tests correspondants</p>
</li>
<li>
<p>construire le code réel.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Occupons nous tout d&#8217;abord de générer le contrôleur et les test fonctionnels.</p>
</div>
<div class="paragraph">
<p>Afin de respecter le visionnement de notre API, nous allons découper notre application en utilisant des <strong>modules</strong>. La syntaxe est donc la suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::users</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande va créer le fichier <code>users_controller_test.rb</code>. Avant d&#8217;entrer dans le vif du sujet, il y a deux choses que nous voulons tester pour une API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La structure du JSON renvoyée par le serveur</p>
</li>
<li>
<p>Le code de réponse HTTP renvoyé par le serveur</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Les codes HTTP courants</div>
<div class="paragraph">
<p>Le premier chiffre du code d&#8217;état spécifie l&#8217;une des cinq classes de réponse. Le strict minimum pour un client HTTP est qu&#8217;il utilise une ces cinq classes. Voici une liste des codes HTTP couramment utilisés:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>200</code>: Réponse standard pour les requêtes HTTP réussies. C&#8217;est généralement sur les requêtes <code>GET</code></p>
</li>
<li>
<p><code>201</code>: La demande a été satisfaite et a donné lieu à la création d&#8217;une nouvelle ressource. Après les demandes de <code>POST</code></p>
</li>
<li>
<p><code>204</code>: Le serveur a traité la requête avec succès, mais ne renvoie aucun contenu. Il s&#8217;agit généralement d&#8217;une requête <code>DELETE</code> réussie.</p>
</li>
<li>
<p><code>400</code>: La requête ne peut pas être exécutée en raison d&#8217;une mauvaise syntaxe. Peut arriver pour tout type de requête.</p>
</li>
<li>
<p><code>401</code>: Similaire au 403, mais spécifiquement pour une utilisation lorsque l&#8217;authentification est requise et qu&#8217;elle a échoué ou n&#8217;a pas encore été fournie. Peut arriver pour tout type de requête.</p>
</li>
<li>
<p><code>404</code>: La ressource demandée n&#8217;a pas pu être trouvée mais peut être à nouveau disponible à l&#8217;avenir. Habituellement, concerne les requêtes <code>GET</code></p>
</li>
<li>
<p><code>500</code>: Un message d&#8217;erreur générique, donné lorsqu&#8217;une condition inattendue a été rencontrée et qu&#8217;aucun autre message spécifique ne convient.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour une liste complète des codes de réponse HTTP, consultez l' <a href="https://fr.wikipedia.org/wiki/Liste_des_codes_HTTP">article sur Wikipedia</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Nous allons donc implémenter le test fonctionnel qui vérifie l&#8217;accès à la méthode <code>Users#show</code>. pour cela,</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
    <span class="c1"># on teste que la réponse contient le courriel</span>
    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit ensuite d&#8217;ajouter l&#8217;action à notre contrôleur. C&#8217;est extrêmement simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users\_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span>  <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si vous exécutez les tests avec <code>rails test</code> vous obtenez l&#8217;erreur suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>

...E

Error:
UsersControllerTest#test_should_show_user:
DRb::DRbRemoteError: undefined method <span class="sb">`</span>api_v1_user_url<span class="s1">' for #&lt;UsersControllerTest:0x000055ce32f00bd0&gt; (NoMethodError)
    test/controllers/users_controller_test.rb:9:in `block in &lt;class:UsersControllerTest&gt;'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce type d&#8217;erreur est très courant lorsque vous générez vos ressources à la main! En effet, nous avons totalement oublié <strong>les routes</strong>. Alors ajoutons-les:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vos tests devraient désormais passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rails test
....
4 runs, 5 assertions, 0 failures, 0 errors, 0 skips</pre>
</div>
</div>
<div class="paragraph">
<p>Comme d&#8217;habitude, après avoir ajouté une des fonctionnalités dont nous sommes satisfaits, nous faisons un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds show action the users controller"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_tester_notre_ressource_avec_curl">Tester notre ressource avec cURL</h3>
<div class="paragraph">
<p>Nous avons donc enfin une ressource à tester. Nous avons plusieurs solutions pour la tester. La première qui me vient à l&#8217;esprit est l&#8217;utilisation de cURL qui est intégré dans presque toutes les distributions Linux. Alors, essayons:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl http://localhost:3000/api/v1/users/1
<span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"email"</span>:<span class="s2">"toto@toto.org"</span>, ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous retrouvons bien l&#8217;utilisateur que nous avons crée avec la console Rails dans la section précédente. Vous avez maintenant une entrée d&#8217;API d&#8217;enregistrement d&#8217;utilisateur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_créer_les_utilisateurs">Créer les utilisateurs</h3>
<div class="paragraph">
<p>Maintenant que nous avons une meilleure compréhension de la façon de construire des points d&#8217;entrée, il est temps d&#8217;étendre notre API. Une des fonctionnalités les plus importante est de laisser les utilisateurs créer un profil sur notre application. Comme d&#8217;habitude, nous allons écrire des tests avant d&#8217;implémenter notre code pour étendre notre suite de tests.</p>
</div>
<div class="paragraph">
<p>Assurez-vous que votre répertoire Git est propre et que vous n&#8217;avez pas de fichier en <em>staging</em>. Si c&#8217;est le cas, <em>committez</em>-les pour que nous puissions recommencer à zéro.</p>
</div>
<div class="paragraph">
<p>Commençons donc par écrire notre test en ajoutant une entrée pour créer un utilisateur sur le fichier <code>users_controller_test.rb</code> :</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should create user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_users_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'test@test.org'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should not create user with taken email"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_users_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela fait beaucoup de code. Ne vous inquiétez pas, je vous explique tout:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>dans le premier test nous vérifions la création d&#8217;un utilisateur en envoyant une requête POST valide. Ensuite, nous vérifiions qu&#8217;un utilisateur supplémentaire existe en base et que le code HTTP de la réponse est <code>created</code></p>
</li>
<li>
<p>dans le premier test nous vérifions que l&#8217;utilisateur n&#8217;est pas créé en utilisant un courriel déjà utilisé. Ensuite, nous vérifions que le code HTTP de la réponse est <code>created</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A ce moment là, les tests doivent échouer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
...E</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est donc temps d&#8217;implémenter le code pour que nos tests réussissent:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="c1"># POST /users</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># Only allow a trusted parameter "white list" through.</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rappelez-vous qu&#8217;à chaque fois que nous ajoutons une entrée dans notre API il faut aussi ajouter cette action dans notre fichier <code>routes.rb</code>.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le constater, l&#8217;implémentation est assez simple. Nous avons également ajouté la méthode privée <code>user_params</code> pour protéger les assignations d&#8217;attributs en masse. Maintenant, nos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
......
6 runs, 9 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Oura! <em>Committons</em> les changements et continuons à construire notre application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the user create endpoint"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mettre_à_jour_les_utilisateurs">Mettre à jour les utilisateurs</h3>
<div class="paragraph">
<p>Le schéma de mise à jour des utilisateurs est très similaire à celui de la création. Si vous êtes un développeur de Rails expérimenté, vous connaissez peut-être déjà les différences entre ces deux actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L&#8217;action de mise à jour répond à une requête PUT/PATCH .</p>
</li>
<li>
<p>Seul un utilisateur connecté devrait être en mesure de mettre à jour ses informations. Ce qui signifie que nous devrons forcer un utilisateur à s&#8217;authentifier. Nous en parlerons au chapitre 5.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Comme d&#8217;habitude, nous commençons par écrire nos tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should not update other user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="s1">'bad_email'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'123456'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour que les tests réussissent, nous devons construire l&#8217;action de mise à jour sur le fichier <code>users_controller.rb</code> et ajouter la route au fichier <code>routes.rb</code>. Comme vous pouvez le voir, nous avons trop de code dupliqué, nous remanierons nos tests au chapitre 4. Tout d&#8217;abord nous ajoutons l&#8217;action le fichier <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite nous implémentons l&#8217;action de mise à jour sur le contrôleur utilisateur et faisons passer nos tests:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update]</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">set_user</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tous nos tests devraient maintenant passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
........
8 runs, 11 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vue que tout fonctionne, on effectue un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds update action the users controller"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_supprimer_lutilisateur">Supprimer l&#8217;utilisateur</h3>
<div class="paragraph">
<p>Jusqu&#8217;à présent, nous avons construit pas mal d&#8217;actions sur le contrôleur des utilisateurs avec leurs tests mais ce n&#8217;est terminé. Il nous en manque juste une dernière qui est l&#8217;action de destruction. Créons donc le test:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"should destroy user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, le test est très simple. Nous ne répondons qu&#8217;avec un statut de <strong>204</strong> qui signifie <code>No Content</code>. Nous pourrions aussi retourner un code d&#8217;état de <strong>200</strong>, mais je trouve plus naturel de répondre <code>No Content</code> dans ce cas car nous supprimons une ressource et une réponse réussie peut suffire.</p>
</div>
<div class="paragraph">
<p>La mise en œuvre de l&#8217;action de destruction est également assez simple:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>N&#8217;oubliez pas d&#8217;ajouter l&#8217;action <code>destroy</code> dans le fichier <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si tout est correct, vos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test</span>
.........
9 runs, 13 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rappelez-vous qu&#8217;après avoir apporté quelques modifications à notre code, il est de bonne pratique de les <em>commiter</em> afin que nous gardions un historique bien découpé.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds destroy action to the users controller"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter03</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_3">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh vous êtes là! Bien joué! Je sais que c&#8217;était probablement long mais n&#8217;abandonnez pas! Assurez-vous que vous comprenez chaque morceau de code, les choses vont s&#8217;améliorer, dans le prochain chapitre, nous remanierons nos tests pour rendre le code plus lisible et plus maintenable. Alors restez avec moi!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter04-authentication" class="sect0">Authentification des utilisateurs</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Cela fait longtemps que vous avez commencé. J&#8217;espère que vous appréciez ce voyage autant que moi.</p>
</div>
<div class="paragraph">
<p>Dans le chapitre précédent nous avons mis en place des entrée de ressources utilisateur. Si vous avez sauté ce chapitre ou si vous n&#8217;avez pas tout compris, je vous recommande vivement de le regarder. Il couvre les premières bases des tests et c&#8217;est une introduction aux réponses JSON.</p>
</div>
<div class="paragraph">
<p>Vous pouvez cloner le projet jusqu&#8217;ici:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter04</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans ce chapitre, les choses vont devenir plus intéressantes. Nous allons mettre en place notre mécanisme d&#8217;authentification. À mon avis, ce sera l&#8217;un des chapitres les plus intéressants car nous allons introduire beaucoup de nouveaux concepts. A la fin, vous aurez un système d&#8217;authentification simple mais puissante. Ne paniquez pas, nous y arriverons.</p>
</div>
<div class="paragraph">
<p>Commençons par le commencement. Comme d&#8217;habitude lorsque nous démarrons un nouveau chapitre, nous allons créer une nouvelle branche:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter04</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_session_sans_état">Session sans état</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Avant d&#8217;aller plus loin, quelque chose doit être clair: <strong>une API ne gère pas les sessions</strong>. Cela peut paraître un peu fou si vous n&#8217;avez pas d&#8217;expérience dans la création de ce genre d&#8217;applications. Une API doit être sans état. Ce qui signifie, par définition, qu&#8217;une API qui fournit une réponse après votre demande ne nécessite aucune autre attention. Cela a pour conséquence qu&#8217;aucun état antérieur ou futur n&#8217;est nécessaire pour que le système fonctionne.</p>
</div>
<div class="paragraph">
<p>Le processus d&#8217;authentification de l&#8217;utilisateur via une API est très simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Le client <strong>demande</strong> une ressource de sessions avec les informations d&#8217;identification correspondantes (généralement un e-mail et un mot de passe).</p>
</li>
<li>
<p>Le serveur <strong>renvoie</strong> la ressource utilisateur avec son jeton d&#8217;authentification correspondant.</p>
</li>
<li>
<p>Pour chaque page qui nécessite une authentification, le client doit envoyer ce jeton d&#8217;authentification.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dans cette section et la suivante, nous nous concentrerons sur la construction d&#8217;un contrôleur de sessions avec ses actions correspondantes. Nous compléterons ensuite le flux de demandes en ajoutant l&#8217;accès d&#8217;autorisation nécessaire.</p>
</div>
<div class="sect2">
<h3 id="_présentation_de_json_web_token">Présentation de JSON Web Token</h3>
<div class="paragraph">
<p>Lorsqu&#8217;on parle de jeton d&#8217;authentification, un standard existe: le JSON Web Token (JWT).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>JWT est un standard ouvert défini dans la RFC 75191. Il permet l&#8217;échange sécurisé de jetons (tokens) entre plusieurs parties. - <a href="https://fr.wikipedia.org/wiki/JSON_Web_Token">Wikipedia</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Globalement, un jeton JWT est composé de trois parties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un <strong>en-tête</strong> structuré en JSON qui contiendra par exemple la date de validité du jeton.</p>
</li>
<li>
<p>un <em>payload</em> structuré en JSON qui peut contenir <strong>n&#8217;importe quelle donnée</strong>. Dans notre cas, il contiendra l&#8217;identifiant de l&#8217;utilisateur "connecté".</p>
</li>
<li>
<p>une <strong>signature</strong> qui nous permettra de vérifier que le jeton a bien été chiffré par notre application et donc qu&#8217;il est valide.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces trois parties sont chacune encodées en base64 puis concaténées en utilisant des points (<code>.</code>). Ce qui nous donne quelque chose comme ça:</p>
</div>
<div class="listingblock">
<div class="title">Un jeton JWT valide</div>
<div class="content">
<pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</pre>
</div>
</div>
<div class="paragraph">
<p>Une fois décodé, ce jeton nous donne les informations suivantes:</p>
</div>
<div class="listingblock">
<div class="title">L&#8217;en-tête du jeton JWT</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w"> </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="p">,</span><span class="w"> </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Le payload du jeton JWT</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w"> </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234567890"</span><span class="p">,</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w"> </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span><span class="w"> </span><span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Pour plus d&#8217;information à propos des jetons JWT je vous invite à consulter <a href="https://jwt.io">jwt.io</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cela possède beaucoup d&#8217;avantages comme par exemple le fait d&#8217;envoyer des informations au consommateur de l&#8217;API directement dans le token. On pourra par exemple choisir d&#8217;intégrer les informations de l&#8217;utilisateur dans le <em>payload</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mise_en_place_du_jeton_dauthentification">Mise en place du jeton d&#8217;authentification</h3>
<div class="paragraph">
<p>La norme JWT possède beaucoup d&#8217;implémentation dans des langages et des librairies diverses. Bien entendu, il existe une gemme Ruby à ce sujet: <a href="https://github.com/jwt/ruby-jwt">ruby-jwt</a>.</p>
</div>
<div class="paragraph">
<p>Commençons donc par l&#8217;installer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add jwt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois effectué, la ligne suivante est ajoutée dans votre <em>Gemfile</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">gem</span> <span class="s2">"jwt"</span><span class="p">,</span> <span class="s2">"~&gt; 2.2"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La libraire s&#8217;utilise très facilement avec les méthodes <code>JWT.encode</code> et <code>JWT.decode</code>. Ouvrons un terminal avec <code>rails console</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="n">token</span> <span class="o">=</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">encode</span><span class="p">({</span><span class="ss">message: </span><span class="s1">'Hello World'</span><span class="p">},</span> <span class="s1">'my_secret_key'</span><span class="p">)</span>
<span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s1">'my_secret_key'</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="p">[{</span><span class="s2">"message"</span><span class="o">=&gt;</span><span class="s2">"Hello World"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"alg"</span><span class="o">=&gt;</span><span class="s2">"HS256"</span><span class="p">}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lors de la première ligne nous avons encodé un <em>payload</em> avec la clé secrète <em>my_secret_key</em>. Nous obtenons donc un jeton que nous pouvons décoder, tout simplement. La deuxième ligne s&#8217;occupe de décoder le jeton et nous voyons que nous retrouvons bien notre <em>payload</em>.</p>
</div>
<div class="paragraph">
<p>Nous allons maintenant englober toute cette logique dans une classe <code>JsonWebToken</code> dans un nouveau fichier situé dans <code>lib/</code>. Cela nous permettra d&#8217;éviter de dupliquer le code.  Cette classe s&#8217;occupera juste d&#8217;encoder et de décoder les jetons JWT. Voici donc l&#8217;implémentation.</p>
</div>
<div class="listingblock">
<div class="title">lib/json_web_token.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">JsonWebToken</span>
  <span class="no">SECRET_KEY</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">secret_key_base</span><span class="p">.</span><span class="nf">to_s</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">.</span><span class="nf">hours</span><span class="p">.</span><span class="nf">from_now</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">[</span><span class="ss">:exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span><span class="p">.</span><span class="nf">to_i</span>
    <span class="no">JWT</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="no">SECRET_KEY</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">decoded</span> <span class="o">=</span> <span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="no">SECRET_KEY</span><span class="p">).</span><span class="nf">first</span>
    <span class="no">HashWithIndifferentAccess</span><span class="p">.</span><span class="nf">new</span> <span class="n">decoded</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela fait beaucoup de code, je sais, mais nous allons le revoir ensemble.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la méthode <code>JsonWebToken.encode</code> va s&#8217;occuper d&#8217;encoder le <em>payload</em> en rajoutant une expiration à 24 heures par défaut. Nous utilisons aussi la même clé de chiffrement que celle configurée avec Rails</p>
</li>
<li>
<p>la méthode <code>JsonWebToken.decode</code> va décoder le jeton JWT et récupérer le <em>payload</em>. Nous utilisons ensuite la classe <a href="https://api.rubyonrails.org/classes/ActiveSupport/HashWithIndifferentAccess.html"><code>HashWithIndifferentAccess</code></a> fournie par Rails qui permet de récupérer une valeur d&#8217;un <code>Hash</code> avec un <code>Symbol</code> ou un <code>String</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Et voilà. Afin de charger le fichier dans notre application, il faut spécifier le dossier <code>lib</code> dans la liste des <em>autoload</em> de Ruby on Rails. Pour cela, rajoutez la configuration suivante dans le fichier <code>application.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">lib/json_web_token.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">module</span> <span class="nn">MarketPlaceApi</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ...</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'lib'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Il est temps de faire un <em>commit</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Setup JWT gem"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_le_contrôleur_de_jeton">Le contrôleur de jeton</h3>
<div class="paragraph">
<p>Nous avons donc mis en place le système de génération d&#8217;un jeton JWT. Il est maintenant temps de créer une route qui va générer ce jeton. Les actions que nous allons implémenter seront gérées en tant que services <em>RESTful</em>: la connexion sera gérée par une demande POST à l&#8217;action <code>create</code>.</p>
</div>
<div class="paragraph">
<p>Pour débuter, nous allons commencer par créer le contrôleur du jeton d&#8217;authentification et la méthode <code>create</code> dans le <em>namespace</em> <code>/api/v1</code>. Avec Rails, une commande suffit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::tokens create</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons modifier un peu la route afin de respecter les conventions <em>REST</em>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Avant d&#8217;aller plus loin, nous allons mettre les tests fonctionnels. Les tests sont:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>si j&#8217;envoie un couple courriel / mot de passe valide, je reçois un jeton</p>
</li>
<li>
<p>dans le cas contraire, j&#8217;ai une réponse de type <code>forbidden</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Les tests se matérialisent donc comme ceci:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/tokens_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">Api::V1::TokensControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get JWT token'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">api_v1_tokens_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'g00d_pa$$'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'token'</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get JWT token'</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">api_v1_tokens_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'b@d_pa$$'</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:unauthorized</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous vous demandez sûrement: "mais comment peux tu connaître le mot de passe de l&#8217;utilisateur?". Il suffit tout simplement d&#8217;utiliser la méthode <code>BCrypt::Password.create</code> dans les <em>fixtures</em> des utilisateurs:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/users.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">one@one.org</span>
  <span class="na">password_digest</span><span class="pi">:</span> <span class="s">&lt;%= BCrypt::Password.create('g00d_pa$$') %&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A ce moment précis, si vous lancez les tests vous obtenez deux erreurs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

........E

Error:
Api::V1::TokensControllerTest#test_should_get_JWT_token:
JSON::ParserError: 767: unexpected token at <span class="s1">''</span>


Failure:
Expected response to be a &lt;401: unauthorized&gt;, but was a &lt;204: No Content&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est normal. Il est maintenant temps d&#8217;implémenter la logique pour créer le jeton JWT. Elle est très simple.</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::TokensController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="ss">:password</span><span class="p">])</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span>
        <span class="ss">token: </span><span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">),</span>
        <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span>
      <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="ss">:unauthorized</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># Only allow a trusted parameter "white list" through.</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela fait beaucoup de code mais c&#8217;est très simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On filtre toujours les paramètres avec la méthode <code>user_params</code></p>
</li>
<li>
<p>On récupère l&#8217;utilisateur avec la méthode <code>User.find_by_email</code> (qui est une méthode "magique" de <em>Active Record</em> puisque le champ <code>email</code> est présent en base) et on récupère l&#8217;utilisateur</p>
</li>
<li>
<p>On utilise la méthode <code>User#authenticate</code> (qui existe grâce à la gemme <code>bcrypt</code>) avec le mot de passe en paramètre. Bcrypt va <em>hasher</em> le mot de passe et vérifier s&#8217;il correspond à l&#8217;attribut <code>password_digest</code>. La fonction renvoie <code>true</code> si tout s&#8217;est bien passé, <code>false</code> dans le cas contraire.</p>
</li>
<li>
<p>Dans le cas où le mot de passe correspond au <em>hash</em>, nous renvoyons un JSON contenant le <em>token</em> généré avec la classe <code>JsonWebToken</code>. Dans le cas contraire, nous renvoyons une réponse vide avec un en-tête <code>unauthorized</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Toujours là? Ne vous inquiétez pas, c&#8217;est fini! Maintenant vos tests doivent passer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

...........

Finished <span class="k">in </span>0.226196s, 48.6304 runs/s, 70.7351 assertions/s.
11 runs, 16 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est temps de faire un commit qui va contenir toutes nos modifications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Setup tokens controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_utilisateur_connecté">Utilisateur connecté</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons donc mis en place la logique suivante: l&#8217;API retourne un jeton d&#8217;authentification si les paramètres passés d&#8217;authentification sont corrects.</p>
</div>
<div class="paragraph">
<p>Nous allons maintenant implémenter la logique suivante: A chaque fois que ce client demandera une page protégée, nous devrons retrouver l&#8217;utilisateur à partir de ce jeton d&#8217;authentification que l&#8217;utilisateur aura passé dans l&#8217;en-tête HTTP.</p>
</div>
<div class="paragraph">
<p>Dans notre cas, nous utiliserons l&#8217;en-tête HTTP <code>Authorization</code> qui est souvent utilisé pour ça. Personnellement, je trouve que c&#8217;est la meilleure manière parce que cela donne un contexte à la requête sans polluer l&#8217;URL avec des paramètres supplémentaires.</p>
</div>
<div class="paragraph">
<p>Nous allons donc créer une méthode <code>current_user</code> pour répondre à nos besoins. C&#8217;est-à-dire retrouver l&#8217;utilisateur grâce à son jeton d&#8217;authentification qui est envoyé sur chaque requête.</p>
</div>
<div class="paragraph">
<p>Quand il s&#8217;agit de l&#8217;authentification, j&#8217;aime ajouter toutes les méthodes associées dans un fichier séparé. Il suffit ensuite d&#8217;inclure le fichier dans le <code>ApplicationController</code>. De cette façon, il est très facile à tester de manière isolée. Créons-donc le fichier dans le répertoire <code>controllers/concerns</code> avec une méthode <code>current_user</code> que nous implémenterons juste après:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="c1"># TODO</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite, créons un répertoire <code>concerns</code> sous <code>tests/controllers/</code> et un fichier <code>authenticable_test.rb</code> pour nos tests d&#8217;authentification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir test</span>/controllers/concerns
<span class="nv">$ </span><span class="nb">touch test</span>/controllers/concerns/authenticable_test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme d&#8217;habitude, nous commençons par écrire nos tests. Dans ce cas, notre méthode <code>current_user</code> va chercher un utilisateur par le jeton d&#8217;authentification dans l&#8217;en-tête HTTP <code>Authorization</code>. Le test est assez basique:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">AuthenticableTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@authentication</span> <span class="o">=</span> <span class="no">MockController</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get user from Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get user from empty Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous vous demandez sûrement "mais d&#8217;ou provient <code>MockController</code>??". En fait il s&#8217;agit d&#8217;un <em>Mock</em>, c&#8217;est à dire une classe qui imite le comportement d&#8217;une autre dans le but de tester un comportement.</p>
</div>
<div class="paragraph">
<p>Nous pouvons définir la classe <code>MockController</code> juste au dessus de notre test:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">MockController</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
  <span class="nb">attr_accessor</span> <span class="ss">:request</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="n">mock_request</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:headers</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">request</span> <span class="o">=</span> <span class="n">mock_request</span><span class="p">.</span><span class="nf">new</span><span class="p">({})</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La classe <code>MockController</code> inclue simplement notre module <code>Authenticable</code> que nous allons tester. Elle contient un attribut <code>request</code> qui contient une simple <a href="https://ruby-doc.org/core-2.6.3/Struct.html"><code>Struct</code></a> qui imite le comportement d&#8217;une requête Rails en contenant un attribut <code>headers</code> de type <code>Hash</code>.</p>
</div>
<div class="paragraph">
<p>Ensuite nous pouvons implémenter nos deux tests juste après</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/concerns/authenticable_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">AuthenticableTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@authentication</span> <span class="o">=</span> <span class="no">Authentication</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get user from Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should not get user from empty Authorization token'</span> <span class="k">do</span>
    <span class="vi">@authentication</span><span class="p">.</span><span class="nf">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">assert_nil</span> <span class="vi">@authentication</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos tests doivent échouer. Implémentons donc le code pour qu&#8217;ils passent:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="k">return</span> <span class="vi">@current_user</span> <span class="k">if</span> <span class="vi">@current_user</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span>
    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">header</span><span class="p">.</span><span class="nf">nil?</span>

    <span class="n">decoded</span> <span class="o">=</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="vi">@current_user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">decoded</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà! Nous récupérons le jeton dans l&#8217;en-tête <code>Authorization</code> et nous cherchons l&#8217;utilisateur correspondant. Rien de bien sorcier.</p>
</div>
<div class="paragraph">
<p>Maintenant nos test doivent passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.............
13 runs, 19 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons plus qu&#8217;à inclure le module <code>Authenticable</code> dans la classe <code>ApplicationController</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/application_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">API</span>
  <span class="c1"># ...</span>
  <span class="kp">include</span> <span class="no">Authenticable</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant il est temps de <em>commiter</em> nos changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds authenticable module for managing authentication methods"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentification_avec_le_jeton">Authentification avec le jeton</h2>
<div class="sectionbody">
<div class="paragraph">
<p>L&#8217;autorisation joue un rôle important dans la construction des applications car, contrairement à l&#8217;authentification qui permet d&#8217;identifier l&#8217;utilisateur, l&#8217;autorisation nous aide à définir ce qu&#8217;il a le droit de faire.</p>
</div>
<div class="paragraph">
<p>Nous avons une route pour mettre à jour l&#8217;utilisateur mais il y a un problème: n&#8217;importe qui peut mettre à jour n&#8217;importe quel utilisateur. Dans cette section, nous allons mettre en œuvre une méthode qui exigera que l&#8217;utilisateur soit connecté afin d&#8217;empêcher tout accès non autorisé.</p>
</div>
<div class="sect2">
<h3 id="_autoriser_les_actions">Autoriser les actions</h3>
<div class="paragraph">
<p>Il est maintenant temps de mettre à jour notre fichier <code>users_controller.rb</code> pour refuser l&#8217;accès à certaines actions. Nous allons aussi implémenter la méthode <code>current_user</code> sur l&#8217;action <code>update</code> et <code>destroy</code> afin de s&#8217;assurer que l&#8217;utilisateur qui est connecté ne sera capable de mettre à jour que ses données et qu&#8217;il ne pourra supprimer que (et uniquement) son compte.</p>
</div>
<div class="paragraph">
<p>Nous allons donc découper notre test <em>should update user</em> et <em>should destroy user</em> en deux tests</p>
</div>
<div class="paragraph">
<p>Commençons par la mise à jour du test <em>should update user</em>.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
      <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">},</span>
      <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span>
      <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid update user"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span> <span class="ss">email: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous voyez que maintenant nous devons ajouter une en-tête <em>Authorization</em> pour que le modification de l&#8217;utilisateur soit acceptée. Si nous ne le faisons pas, nous voulons recevoir une réponse de type <em>forbidden</em>.</p>
</div>
<div class="paragraph">
<p>Nous pouvons imaginer à peu près la même chose pour le test <em>should forbid destroy user</em>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should destroy user"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid destroy user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'User.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme vous pouvez vous y attendre, si nous exécutons les tests de notre <em>controller</em> utilisateurs, ils devraient échouer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails <span class="nb">test test</span>/controllers/api/v1/users_controller_test.rb
..F

Failure:
Expected response to be a &lt;2XX: success&gt;, but was a &lt;403: Forbidden&gt;

..F

Failure:
<span class="s2">"User.count"</span> didn t change by <span class="nt">-1</span><span class="nb">.</span>
Expected: 0
  Actual: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>La solution est assez simple. Nous allons ajouter un <code>before_action</code> qui appellera la méthode <code>check_owner</code> pour les actions <code>update</code> et <code>destroy</code>. Ainsi nous vérifierons que l&#8217;utilisateur correspondant au jeton JWT est le même que l&#8217;utilisateur qui doit être mis à jour.</p>
</div>
<div class="paragraph">
<p>Voici l&#8217;implémentation:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update destroy]</span>
  <span class="c1"># ...</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">check_owner</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà! L&#8217;implémentation est vraiment simple. Il est donc temps de <em>commiter</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds authorization for the users controller"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter04</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_4">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vous l&#8217;avez fait! Vous êtes à mi-chemin! Ce chapitre a été long et difficile, mais c&#8217;est un grand pas en avant sur la mise en place d&#8217;un mécanisme solide pour gérer l&#8217;authentification utilisateur et nous commençons même à gratter la surface pour de simples règles d&#8217;autorisation.</p>
</div>
<div class="paragraph">
<p>Dans le prochain chapitre, nous nous concentrerons sur la personnalisation de la sortie JSON pour l&#8217;utilisateur avec <a href="https://github.com/Netflix/fast_jsonapi"><code>fast_jsonapi</code></a> et l&#8217;ajout d&#8217;un modèle de produit en donnant à l&#8217;utilisateur la possibilité de créer un produit et le publier pour la vente.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter05-user-products" class="sect0">Produits des utilisateurs</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans le chapitre précédent, nous avons implémenté le mécanisme d&#8217;authentification que nous allons utiliser tout au long de l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;instant nous avons une implémentation très simple du modèle <code>User</code> mais le moment de vérité est venu. Nous allons personnaliser la sortie JSON et ajouter une deuxième ressource: les produits de l&#8217;utilisateur. Ce sont les éléments que l&#8217;utilisateur vendra dans l&#8217;application.</p>
</div>
<div class="paragraph">
<p>Si vous êtes familier avec Rails, vous savez peut-être déjà de quoi je parle. Mais pour ceux qui ne le savent pas, nous allons associer le modèle <code>User</code> au modèle <code>Product</code> en utilisant les méthodes <code>has_many</code> et <code>belongs_to</code> de <em>Active Record</em>.</p>
</div>
<div class="paragraph">
<p>Dans ce chapitre, nous allons construire le modèle de <code>Product</code> à partir de zéro, l&#8217;associer à l&#8217;utilisateur et créer les entrées nécessaires pour que tout client puisse accéder aux informations.</p>
</div>
<div class="paragraph">
<p>Vous pouvez cloner le projet jusqu&#8217;à ce point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter05</code></pre>
</div>
</div>
<div class="paragraph">
<p>Avant de début, et comme d&#8217;habitude quand nous commençons de nouvelles fonctionnalités, nous créons une nouvelle branche:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_le_modèle_du_produit">Le modèle du produit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous commencerons d&#8217;abord par créer un modèle de <code>Product</code> puis nous y ajouterons quelques validations et enfin nous l&#8217;associerons au modèle <code>User</code>. Comme le modèle <code>User</code>, le <code>Product</code> sera entièrement testé et sera automatiquement supprimé si l&#8217;utilisateur est supprimé.</p>
</div>
<div class="sect2">
<h3 id="_les_fondements_du_produit">Les fondements du produit</h3>
<div class="paragraph">
<p>Le modèle <code>Product</code> aura besoin de plusieurs champs: un attribut <code>price</code> pour le prix du produit, un booléen <code>published</code> pour savoir si le produit est prêt à être vendu ou non, un <code>title</code> pour définir un titre de produit sexy, et enfin et surtout un <code>user_id</code> pour associer ce produit particulier à un utilisateur. Comme vous le savez peut-être déjà, nous le générons avec la commande <code>rails generate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model Product title:string price:decimal published:boolean user:belongs_to
Running via Spring preloader <span class="k">in </span>process 1476
      invoke  active_record
      create    db/migrate/20190608205942_create_products.rb
      create    app/models/product.rb
      invoke    test_unit
      create      <span class="nb">test</span>/models/product_test.rb
      create      <span class="nb">test</span>/fixtures/products.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le remarquer, nous avons utilisé le type <code>belongs_to</code> pour l&#8217;attribut. Ceci est un raccourci qui va créer une colonne <code>user_id</code> de type <code>int</code> et aussi ajouter une clé étrangère sur le champ <code>users.id</code>.</p>
</div>
<div class="paragraph">
<p>De plus, <code>user_id</code> sera aussi défini comme un <code>index</code>. C&#8217;est une bonne pratique pour les clés d&#8217;associations car cela optimise les requêtes de la base de données. Ce n&#8217;est pas obligatoire, mais je vous le recommande vivement.</p>
</div>
<div class="paragraph">
<p>Le fichier de migration devrait ressembler à ceci:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190608205942_create_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:title</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:price</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">boolean</span> <span class="ss">:published</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit ensuite de lancer les migrations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>A ce moment si vous lancez les tests, un test doit échouer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
....E

Error:
Api::V1::UsersControllerTest#test_should_destroy_user:
ActiveRecord::InvalidForeignKey: SQLite3::ConstraintException: FOREIGN KEY constraint failed

rails <span class="nb">test test</span>/controllers/api/v1/users_controller_test.rb:43</code></pre>
</div>
</div>
<div class="paragraph">
<p>"Quoi?! Mais je n&#8217;ai pas touché aux utilisateurs!" dites-vous très certainement. Ce que j&#8217;ai vu dans le code d&#8217;autres développeurs, lorsqu&#8217;ils travaillent avec des associations, c&#8217;est qu&#8217;ils oublient la destruction des dépendances entre les modèles. Ce que je veux dire par là, c&#8217;est que si un utilisateur est supprimé, les produits de l&#8217;utilisateur devraient l&#8217;être aussi.</p>
</div>
<div class="paragraph">
<p>Donc pour tester cette interaction entre les modèles, nous avons besoin d&#8217;un utilisateur avec un des produits. Puis, nous supprimerons cet utilisateur en espérant que les produits disparaissent avec lui. Rails à déjà généré cela pour nous. Jetez un coup d&#8217;œil à la <em>fixture</em> des produits:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">MyString</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">9.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">one</span>
<span class="c1"># ...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez voir que cette <em>fixture</em> n&#8217;utilise pas l&#8217;attribut <code>user_id</code> mais <code>user</code>. Cela signifie que le produit <code>one</code> aura un attribut <code>user_id</code> correspondant à l&#8217;identifiant de l&#8217;utilisateur <code>one</code>.</p>
</div>
<div class="paragraph">
<p>Il faut donc spécifier une suppression en cascade afin de supprimer le produit <code>one</code> lorsque l&#8217;utilisateur <code>one</code> est supprimé. Commençons par le test unitaire:</p>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'destroy user should destroy linked product'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">users</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">destroy</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit de modifier le modèle <code>User</code> et lui spécifier la relation <code>has_many</code> avec l&#8217;option <code>dependent: :destroy</code>. Nous verrons plus tard ce que cette méthode fait plus en détails.</p>
</div>
<div class="listingblock">
<div class="title">test/models/user_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Faisons un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Generate product model"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validations_des_produits">Validations des produits</h3>
<div class="paragraph">
<p>Comme nous l&#8217;avons vu avec l&#8217;utilisateur, les validations sont une partie importante lors de la construction de tout type d&#8217;application. Cela nous permet d&#8217;empêcher toute donnée indésirable d&#8217;être enregistrée dans la base de données. Pour le produit, nous devons nous assurer, par exemple, que le prix est un nombre et qu&#8217;il n&#8217;est pas négatif.</p>
</div>
<div class="paragraph">
<p>Voici donc notre premier test pour le modèle des produits:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"Should have a positive price"</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">assert_not</span> <span class="n">product</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il nous faut maintenant ajouter l&#8217;implémentation pour faire passer le test:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">},</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tests passent désormais:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
................</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> ces changements et continuons d&#8217;avancer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds some validations to products"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_point_dentrée_pour_nos_produits">Point d&#8217;entrée pour nos produits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il est maintenant temps de commencer à construire les points d&#8217;entrée des produits. Pour l&#8217;instant, nous allons juste construire cinq actions REST. Dans le prochain chapitre, nous allons personnaliser la sortie JSON en implémentant la gemme <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>.</p>
</div>
<div class="paragraph">
<p>Nous devons d&#8217;abord créer le <code>products_controller</code>, et nous pouvons facilement y parvenir avec la commande ci-dessous:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::products
      create  app/controllers/api/v1/products_controller.rb
      invoke  test_unit
      create    <span class="nb">test</span>/controllers/api/v1/products_controller_test.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>La commande ci-dessus va générer pas mal de fichiers qui vont nous permettre de commencer à travailler rapidement. Ce que je veux dire par là, c&#8217;est qu&#8217;il va générer le contrôleur et les fichiers de test déjà <em>scopés</em> à la version 1 de l&#8217;API.</p>
</div>
<div class="paragraph">
<p>En guise d&#8217;échauffement, nous allons commencer par construire l&#8217;action du <code>show</code> pour le produit.</p>
</div>
<div class="sect2">
<h3 id="_action_daffichage_dun_produit">Action d&#8217;affichage d&#8217;un produit</h3>
<div class="paragraph">
<p>Comme d&#8217;habitude, nous commençons par ajouter quelques test du contrôleur des produits. La stratégie ici est très simple, il suffit de créer un seul produit et de s&#8217;assurer que la réponse du serveur est celle que nous attendons.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show product"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous ajoutons ensuite le code pour faire passer le test:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Attendez! N&#8217;exécutez pas encore les tests. N&#8217;oubliez pas que nous devons ajouter la route au fichier <code>routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, nous nous assurons que les tests passent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez déjà le constater, les tests et l&#8217;implémentation sont très simples. En fait, cela ressemble beaucoup à ce que nous avons fait pour les utilisateurs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_liste_des_produits">Liste des produits</h3>
<div class="paragraph">
<p>Il est maintenant temps de créer une entrée pour une liste de produits qui pourrait permettre d&#8217;afficher le catalogue de produits d&#8217;un marché par exemple. Pour ce point d&#8217;accès, nous n&#8217;exigeons pas que l&#8217;utilisateur soit connecté. Comme d&#8217;habitude, nous allons commencer à écrire quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show products"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_products_url</span><span class="p">(),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show product"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Passons maintenant à la mise en œuvre, qui, pour l&#8217;instant, va être une petite méthode:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
  <span class="c1">#...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et n&#8217;oubliez pas, vous devez ajouter la route correspondante dans le fichier <code>config/routes.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ....</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans les chapitres suivants, nous allons améliorer ce point d&#8217;entré et donner la possibilité de recevoir des paramètres pour les filtrer. <em>Commitons</em> ces changements et continuons d&#8217;avancer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Finishes modeling the product model along with user associations"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_création_des_produits">Création des produits</h3>
<div class="paragraph">
<p>Créer des produits est un peu plus délicat parce que nous aurons besoin d&#8217;une configuration supplémentaire. La stratégie que nous suivrons est d&#8217;attribuer le produit créé à l&#8217;utilisateur propriétaire du jeton JWT fourni d&#8217;en l&#8217;en-tête HTTP <code>Authorization</code>.</p>
</div>
<div class="paragraph">
<p>Notre premier arrêt sera donc le fichier <code>products_controller_test.rb</code>.</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should create product'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_products_url</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="ss">price: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">price</span><span class="p">,</span> <span class="ss">published: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">published</span> <span class="p">}</span> <span class="p">},</span>
           <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
           <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid create product'</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_products_url</span><span class="p">,</span>
           <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="ss">price: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">price</span><span class="p">,</span> <span class="ss">published: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">published</span> <span class="p">}</span> <span class="p">},</span>
           <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wow! Nous avons ajouté beaucoup de code. Si vous vous souvenez, les tests sont en fait les mêmes que ceux de la création de l&#8217;utilisateur excepté quelques changements mineurs.</p>
</div>
<div class="paragraph">
<p>De cette façon, nous pouvons voir l&#8217;utilisateur et lui créer un produit qui lui est associé. Mais attendez il y a mieux. Si nous adoptons cette approche, nous pouvons augmenter la portée de notre mécanisme d&#8217;autorisation. Dans ce cas, si vous vous souvenez, nous avons construit la logique pour obtenir l&#8217;utilisateur à partir de l&#8217;en-tête <code>Authorization</code> et lui avons assigné une méthode <code>current_user</code>. C&#8217;est donc assez facile à mettre en place en ajoutant simplement l&#8217;en-tête d&#8217;autorisation dans la requête et en récupérant l&#8217;utilisateur à partir de celui-ci. Alors faisons-le:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">product_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, nous protégeons l&#8217;action de création avec la méthode <code>check_login</code>, et sur l&#8217;action <code>create</code> nous construisons le produit en associant l&#8217;utilisateur courant. J&#8217;ai ajouté cette méthode très simpliste au <em>concern</em> <code>authenticable.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/authenticable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Authenticable</span>
  <span class="c1"># ...</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">check_login</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="nb">self</span><span class="p">.</span><span class="nf">current_user</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Une dernière chose avant de faire vos tests: la route nécessaire:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index create]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si vous faites les tests maintenant, ils devraient tous passer:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rake test
....................</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mise_à_jour_des_produits">Mise à jour des produits</h3>
<div class="paragraph">
<p>J&#8217;espère que maintenant vous comprenez la logique pour construire les actions à venir. Dans cette section, nous nous concentrerons sur l&#8217;action de mise à jour qui fonctionnera de manière similaire à celle de création. Nous avons juste besoin d&#8217;aller chercher le produit dans la base de données et de le mettre à jour.</p>
</div>
<div class="paragraph">
<p>Nous ajoutons d&#8217;abord l&#8217;action aux routes pour ne pas oublier plus tard:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="n">resources</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show index create update]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Avant de commencer à coder certains tests je veux juste préciser que, de la même manière que pour l&#8217;action <code>create</code>, nous allons délimiter le produit à l&#8217;utilisateur courant. Nous voulons nous assurer que le produit que nous mettons à jour appartient bien à l&#8217;utilisateur. Nous allons donc chercher ce produit dans l&#8217;association <code>user.products</code> fournie par <em>Active Record</em>.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord, nous ajoutons quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="nb">require</span> <span class="s1">'test_helper'</span>

<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should update product'</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span> <span class="p">}</span> <span class="p">},</span>
          <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid update product'</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span>
          <span class="ss">params: </span><span class="p">{</span> <span class="ss">product: </span><span class="p">{</span> <span class="ss">title: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">title</span> <span class="p">}</span> <span class="p">},</span>
          <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span>
          <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
J&#8217;ai ajouté une <em>fixture</em> correspondant à un deuxième utilisateur dans le but de vérifier que celui-ci ne peut pas modifier le produit du premier utilisateur.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Les tests peuvent paraître complexes, mais en jetant un coup d&#8217;œil, ils sont presque identiques à ceux des utilisateurs.</p>
</div>
<div class="paragraph">
<p>Maintenant implémentons le code pour faire passer nos tests avec succès:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_product</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update]</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update]</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">product</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">product</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@product</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">errors</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">check_owner</span>
    <span class="n">head</span> <span class="ss">:forbidden</span> <span class="k">unless</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span> <span class="o">==</span> <span class="n">current_user</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">set_product</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le constater, l&#8217;implémentation est assez simple. Nous allons simplement récupérer le produit auprès de l&#8217;utilisateur connecté et nous le mettons simplement à jour. Nous avons également ajouté cette action au <code>before_action</code>, pour empêcher tout utilisateur non autorisé de mettre à jour un produit.</p>
</div>
<div class="paragraph">
<p>Si nous lançons les tests, ils devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_suppression_des_produits">Suppression des produits</h3>
<div class="paragraph">
<p>Notre dernier arrêt pour les route des produits, sera l&#8217;action <code>destroy</code>. Vous pouvez maintenant imaginer à quoi cela ressemblerait. La stratégie ici sera assez similaire à l&#8217;action de <code>create</code> et <code>update</code>. Ce qui signifie que nous allons récupérer l&#8217;utilisateur connecté puis récupérer le produit auprès de l&#8217;association <code>user.products</code> et enfin le supprimer en retournant un code 204.</p>
</div>
<div class="paragraph">
<p>Recommençons par ajouter la route:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show create update destroy]</span>
      <span class="n">resources</span> <span class="ss">:tokens</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
      <span class="n">resources</span> <span class="ss">:products</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Après cela, nous devons ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"should destroy product"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@product</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:no_content</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should forbid destroy user"</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Product.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">users</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, ajoutons simplement le code nécessaire pour faire passer les tests:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:set_product</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[show update destroy]</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[create]</span>
  <span class="n">before_action</span> <span class="ss">:check_owner</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[update destroy]</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@product</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">head</span> <span class="mi">204</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, l&#8217;implémentation fait le travail en trois lignes. Nous pouvons lancer les tests pour nous assurer que tout est bon.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Après cela, nous <em>commitons</em> les changements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the products create, update and destroy action"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_remplir_la_base_de_données">Remplir la base de données</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Avant de continuer avec plus de code, remplissons la base de données avec de fausses données. Pour faire cela, nous allons utiliser des <em>seeds</em>.</p>
</div>
<div class="paragraph">
<p>Avec le fichier <code>db/seeds.rb</code>, Rails nous donne un moyen de fournir facilement et rapidement des valeurs par défaut à une nouvelle installation. C&#8217;est un simple fichier Ruby qui donne un accès complet à toutes les classes et méthodes de l&#8217;application. Vous n&#8217;avez donc pas besoin de tout saisir manuellement avec la console Rails mais vous pouvez simplement utiliser le fichier <code>db/seeds.rb</code> avec la commande <code>rake db:seed</code>.</p>
</div>
<div class="paragraph">
<p>Commençons donc par créer un utilisateur:</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="s1">'toto@toto.fr'</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'toto123'</span>
<span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant vous pouvez créer l&#8217;utilisateur en éxecutant simplement la commande suivante:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: toto@toto.fr</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ca fonctionne. Je ne sais pas vous, mais moi j&#8217;aime bien avoir des données factices qui remplissent correctement ma base de données de test. Seulement je n&#8217;ai pas toujours l&#8217;inspiration pour donner du sens à mes <em>seed</em> alors j&#8217;utilise la gemme <a href="https://github.com/stympy/faker"><code>faker</code></a>. Installons là:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add faker</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant nous pouvons l&#8217;utiliser pour créer cinq utilisateurs d&#8217;un coup avec des email différent.</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'locadex1234'</span>
  <span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voyons le résultat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: barbar@greenholt.io
Created a new user: westonpaucek@ortizbotsford.net
Created a new user: ricardo@schneider.com
Created a new user: scott@moenerdman.biz
Created a new user: chelsie@wiza.net</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Mais nous pouvons aller plus loin en créant des produit associés à ces utilisateurs:</p>
</div>
<div class="listingblock">
<div class="title">db/seeds.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">delete_all</span>
<span class="no">User</span><span class="p">.</span><span class="nf">delete_all</span>

<span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">email: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="s1">'locadex1234'</span>
  <span class="nb">puts</span> <span class="s2">"Created a new user: </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="si">}</span><span class="s2">"</span>

  <span class="mi">2</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
      <span class="ss">title: </span><span class="no">Faker</span><span class="o">::</span><span class="no">Commerce</span><span class="p">.</span><span class="nf">product_name</span><span class="p">,</span>
      <span class="ss">price: </span><span class="nb">rand</span><span class="p">(</span><span class="mf">1.0</span><span class="o">..</span><span class="mf">100.0</span><span class="p">),</span>
      <span class="ss">published: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">user_id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span>
    <span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Created a brand new product: </span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Le résultat est bluffant. En une commande nous pouvons créer trois utilisateurs et six produits:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:seed
Created a new user: tova@beatty.org
Created a brand new product: Lightweight Steel Hat
Created a brand new product: Ergonomic Aluminum Lamp
Created a new user: tommyrunolfon@tremblay.biz
Created a brand new product: Durable Plastic Car
Created a brand new product: Ergonomic Leather Shirt
Created a new user: jordon@torp.io
Created a brand new product: Incredible Paper Hat
Created a brand new product: Sleek Concrete Pants</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>commitons</em> les changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Create a seed to populate database"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter05</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_5">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>J&#8217;espère que vous avez apprécié ce chapitre. C&#8217;est un long travail, mais le code que nous avons créé est une excellente base pour l&#8217;application principale.</p>
</div>
<div class="paragraph">
<p>Dans le chapitre suivant, nous allons nous concentrer sur la personnalisation de la sortie des modèles utilisateur et produits à l&#8217;aide de la gemme <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>. Elle nous permettra de filtrer facilement les attributs à afficher et à gérer les associations comme des objets embarqués par exemple.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter06-improve-json" class="sect0">Modélisation du JSON</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans le chapitre précédent, nous avons ajouté les produits à l&#8217;application et construit toutes les routes nécessaires. Nous avons également associé un produit à un utilisateur et restreint certaines des actions de <code>products_controller</code>.</p>
</div>
<div class="paragraph">
<p>Maintenant, vous devriez être satisfaits de tout ce travail. Mais nous avons encore du pain sur la planche. Actuellement, nous avons une sortie JSON qui n&#8217;est pas parfaite. La sortie JSON ressemble à celle-ci:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tag Case"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"98.7761933800815"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-20T12:47:26.686Z"</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or nous voulons une sortie qui ne contienne pas les champs <code>user_id</code>, <code>created_at</code> et <code>updated_at</code>.</p>
</div>
<div class="paragraph">
<p>De plus, une partie importante et difficile lors de la création de votre API est de décider le format de sortie. Heureusement, certaines organisations ont déjà fait face à ce genre de problème et elles ont ainsi établi certaines conventions que vous allez découvrir dans ce chapitre.</p>
</div>
<div class="paragraph">
<p>Vous pouvez clôner le projet jusqu&#8217;à ce point avec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter06</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commençons une nouvelle branche pour ce chapitre:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter06</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_présentation_de_jsonapi">Présentation de <a href="https://jsonapi.org/">JSON:API</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Une partie importante et difficile lors de la création de votre API est de décider le format de sortie. Heureusement, certaines conventions existent déjà.</p>
</div>
<div class="paragraph">
<p>L&#8217;une d&#8217;elles, certainement la plus utilisée est <a href="https://jsonapi.org/">JSON:API</a>. La <a href="https://jsonapi.org/format/#document-structure">documentation de JSON:API</a> nous donne quelques règles à suivre concernant le formatage du document JSON.</p>
</div>
<div class="paragraph">
<p>Ainsi, notre document <strong>doit</strong> contenir ces clefs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: qui doit contenir les données que nous renvoyons</p>
</li>
<li>
<p><code>errors</code> qui doit contenir un tableau des erreurs qui sont survenues.</p>
</li>
<li>
<p><code>meta</code> qui contient un <a href="https://jsonapi.org/format/#document-meta">objet meta</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le contenu de la clé <code>data</code> est lui aussi assez strict:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>il doit posséder une clé `type`qui décrit le type du modèle JSON (si c&#8217;est un article, un utilisateur, etc..)</p>
</li>
<li>
<p>les propriétés de l&#8217;objet doivent être placées dans une clé <code>attributes</code> et les <em>undescore</em> (<code>_</code>) sont remplacés par des tirets (<code>-</code>)</p>
</li>
<li>
<p>les liaisons de l&#8217;objets doivent être placées dans une clé <code>relationships</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans ce chapitre, nous allons personnaliser la sortie JSON en utilisant la gemme <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a> de Netflix qui respecte toutes les normes <a href="https://jsonapi.org/">JSON:API</a>.</p>
</div>
<div class="paragraph">
<p>Installons donc la gemme <code>fast_jsonapi</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add fast_jsonapi</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous devriez être prêts à continuer avec ce tutoriel.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sérialiser_lutilisateur">Sérialiser l&#8217;utilisateur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FastJSON API utilise des <strong>sérialiseurs</strong>. Les sérialiseurs représentent des classes Ruby qui seront responsables de convertir un modèle en un <code>Hash</code> ou un JSON.</p>
</div>
<div class="paragraph">
<p>Nous devons d&#8217;abord ajouter un fichier <code>user_serializer.rb</code>. Nous pouvons le faire manuellement, mais la gemme fournit une interface en ligne de commande pour le faire:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer User email
      create  app/serializers/user_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ceci a créé un fichier appelé <code>user_serializer.rb</code> sous le répertoire <code>app/serializers</code>, qui devrait ressembler au fichier suivant:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:email</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce <em>serializer</em> va nous permettre de convertir notre objet <code>User</code> en JSON qui implémente correctement la norme JSON:API. Nous avons spécifié l&#8217;attribut <code>email</code> afin qu&#8217;il soit présent dans le tableau <code>data</code>.</p>
</div>
<div class="paragraph">
<p>Essayons tout cela dans la console Rails avec <code>rails console</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="mf">2.6</span><span class="o">.</span><span class="mi">3</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span> <span class="p">).</span><span class="nf">serializable_hash</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:data</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:id</span><span class="o">=&gt;</span><span class="s2">"25"</span><span class="p">,</span> <span class="ss">:type</span><span class="o">=&gt;</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:attributes</span><span class="o">=&gt;</span><span class="p">{</span><span class="ss">:email</span><span class="o">=&gt;</span><span class="s2">"tova@beatty.org"</span><span class="p">}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Comme vous le voyez, tout se fait très facilement. Nous pouvons donc utiliser notre nouveau <em>serializer</em> dans notre <em>controller</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="c1"># ...</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Assez facile, non? Cependant nous devrions avoir un test qui échoue. Essayez par vous même:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test

</span>Failure:
Expected: <span class="s2">"one@one.org"</span>
  Actual: nil</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez voir que pour une raison quelconque, la réponse n&#8217;est pas tout à fait ce que nous attendions. C&#8217;est parce que la gemme modifie la réponse que nous avions précédemment définie. Donc pour faire passer les tests, il suffit de mettre à jour notre test:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/users_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">][</span><span class="s1">'email'</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si vous faites les tests maintenant, ils devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

<span class="c"># Running:</span>

........................</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> ces changements et continuons d&#8217;avancer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds user serializer for customizing the json output"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sérialiser_les_produits">Sérialiser les produits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Maintenant que nous comprenons comment fonctionne la gemme de sérialisation, il est temps de personnaliser la sortie des produits. La première étape est identique à celle pour l&#8217;utilisateur, nous avons besoin d&#8217;un sérialiseur de produit, alors faisons-le:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer Product title price published
      create  app/serializers/product_serializer.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ajoutons maintenant les attributs à sérialiser pour le produit, comme nous l&#8217;avons fait avec l&#8217;utilisateur dans la section précédente:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Ce n&#8217;est pas plus compliqué que cela. Modifions un petit peu notre contrôleur.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">product</span><span class="p">).</span><span class="nf">serializable_hash</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">product_params</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">).</span><span class="nf">serializable_hash</span>
    <span class="k">else</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et nous mettons à jour notre test fonctionnel:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show product'</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">][</span><span class="s1">'attributes'</span><span class="p">][</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez lancer les tests pour vérifier mais ils devraient encore être bons. <em>Commitons</em> ces petits changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds product serializer for custom json output"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_sérialiser_les_associations">Sérialiser les associations</h3>
<div class="paragraph">
<p>Nous avons travaillé avec des sérialiseurs et vous remarquerez peut-être que c&#8217;est très simple. Dans certains cas, la décision difficile est de savoir comment nommer vos routes ou comment structurer la sortie JSON afin que votre solution soit pérenne. Lorsque vous travaillez avec des associations entre les modèles sur une API, il existe de nombreuses approches que vous pouvez prendre.</p>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons pas à nous soucier de ce problème dans notre cas, la norme JSON:API l&#8217;a fait pour nous!</p>
</div>
<div class="paragraph">
<p>Pour résumer, nous avons une association de type <code>has_many</code> entre l&#8217;utilisateur et le modèle de produit.</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;est une bonne idée d&#8217;intégrer les utilisateurs dans les sortie JSON des produits. Cela rendra la sortie plus lourde mais ça évitera au client de l&#8217;API d&#8217;éxecuter d&#8217;autres requêtes pour récupérer les informations des utilisateurs liées aux produits. Cette méthode peut vraiment vous éviter un énorme goulet d&#8217;étranglement.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_théorie_de_linjection_des_relations">Théorie de l&#8217;injection des relations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Imaginez un scénario où vous allez chercher les produits dans l&#8217;API, mais dans ce cas, vous devez afficher une partie des informations de l&#8217;utilisateur.</p>
</div>
<div class="paragraph">
<p>Une solution possible serait d&#8217;ajouter l&#8217;attribut <code>user_id</code> au <code>product_serializer</code> pour que nous puissions récupérer l&#8217;utilisateur correspondant plus tard. Cela peut sembler être une bonne idée, mais si vous vous souciez de la performance, ou si les transactions de votre base de données ne sont pas assez rapides, vous devriez reconsidérer cette approche. Vous devez comprendre que pour chaque produit que vous récupérez, vous allez devoir récupérer son utilisateur correspondant.</p>
</div>
<div class="paragraph">
<p>Face à ce problème, il y a plusieurs alternatives possibles.</p>
</div>
<div class="sect2">
<h3 id="_intégrer_dans_un_attribut_meta">Intégrer dans un attribut meta</h3>
<div class="paragraph">
<p>Une bonne solution à mon avis est d&#8217;intégrer les identifiants des utilisateurs liés aux produits dans un attribut meta, donc nous avons une sortie JSON comme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"user_ids"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">

  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela peut nécessiter une configuration supplémentaire sur le terminal de l&#8217;utilisateur, afin que le client puisse récupérer ses utilisateurs à partir de ces <code>user_ids</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_incorporer_lobjet_dans_lattribut">Incorporer l&#8217;objet dans l&#8217;attribut</h3>
<div class="paragraph">
<p>Une autre solution, est d&#8217;incorporer l&#8217;objet <code>user</code> dans l&#8217;objet <code>product</code>. Ce qui peut rendre la première requête un peu plus lente, mais de cette façon le client n&#8217;a pas besoin de faire une autre requête supplémentaire. Un exemple des résultats escomptés est présenté ci-dessous:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le problème de cette approche est que nous devons dupliquer les objets <code>User</code> pour tous les produits qui appartiennent au même utilisateur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_incorporer_les_relation_dans_include">Incorporer les relation dans <code>include</code></h3>
<div class="paragraph">
<p>La troisième solution, choisie par la norme JSON:API, est un mélange des deux premières.</p>
</div>
<div class="paragraph">
<p>Nous allons inclure toutes les relations dans une clé <code>include</code> qui contiendra tous les relations des objets précédemment cités. Aussi, chaque objet inclura une clé <code>relationships</code> définissant la relation et qu&#8217;il faudra retrouver dans la clé <code>include</code>.</p>
</div>
<div class="paragraph">
<p>Un JSON vaut mille mots:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"First product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Second product"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"25.02"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stephany@lind.co.uk"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2014-07-29T03:52:07.432Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"auth_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Xbnzbf3YkquUrF_1bNkZ"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous voyez la différence? Cette solution réduit drastiquement la taille du JSON et donc la bande passante utilisée.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_de_linjection_des_relations">Application de l&#8217;injection des relations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous allons donc incorporer l&#8217;objet utilisateur dans le produit. Commençons par ajouter quelques tests.</p>
</div>
<div class="paragraph">
<p>Nous allons simplement modifier le test <code>Products#show</code> afin de vérifier que nous récupérons:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show product'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:included</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous vérifions maintenant trois choses sur le JSON qui est retourné:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>il contient le titre du produit</p>
</li>
<li>
<p>il contient l&#8217;identifiant de l&#8217;utilisateur lié au produit</p>
</li>
<li>
<p>les données de l&#8217;utilisateur sont incluses dans la clé <code>include</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Vous avez sûrement remarqué que j&#8217;ai choisi d&#8217;utiliser la méthode <a href="https://ruby-doc.org/core-2.6.3/Hash.html#method-i-dig"><code>Hash#dig</code></a>. C&#8217;est une méthode Ruby qui permet de récupérer des éléments dans un <em>Hash</em> imbriqué en évitant les erreurs si un élément n&#8217;est pas présent.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Pour faire passer ce test nous allons commencer par inclure la relation dans le <em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cet ajout aura pour effet de rajouter une clé <code>relatioship</code> contenant l&#8217;identifiant de l&#8217;utilisateur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Durable Marble Lamp"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11.55"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
              </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cela nous permet donc de corriger nos deux premières assertions. Nous voulons maintenant inclure les attributs de l&#8217;utilisateur qui possède le produit. Pour faire cela, nous devons simplement passer une option <code>:include</code> au <em>serializer</em> instancié dans le <em>controller</em>. Alors faisons le:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:user</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@product</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Maintenant voilà à quoi le JSON devrait ressembler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"staceeschultz@hahn.info"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est très simple: il suffit d&#8217;ajouter une ligne au sérialiseur du produit:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:published</span>
  <span class="n">has_one</span> <span class="ss">:user</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, tous les tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

<span class="c"># Running:</span>

........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Faisons un <em>commit</em> pour fêter ça:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add user relationship to product"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_récupérer_les_produits_pour_des_utilisateurs">Récupérer les produits pour des utilisateurs</h3>
<div class="paragraph">
<p>Vous avez compris le principe? Nous avons inclus les informations de l&#8217;utilisateur dans le JSON des produits. Nous pouvons faire la même choses en incluant les informations des produits liés à un utilisateur pour la page <code>/api/v1/users/1</code>.</p>
</div>
<div class="paragraph">
<p>Commençons par le test:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should show user"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:data</span><span class="p">,</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:included</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite le <em>serializer</em>:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">attributes</span> <span class="ss">:email</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et pour terminer le contrôleur:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/users_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:products</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">UserSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@user</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà. Nous obtenons un JSON de cette forme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"staceeschultz@hahn.info"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="w"> </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"included"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"product"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Durable Marble Lamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="s2">"11.5537474980286"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"relationships"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>C&#8217;était vraiment facile. Faisons un <em>commit</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add products relationship to user#show"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rechercher_les_produits">Rechercher les produits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans cette dernière section, nous continuerons à renforcer l&#8217;action <code>Products#index</code> en mettant en place un mécanisme de recherche très simple pour permettre à n&#8217;importe quel client de filtrer les résultats. Cette section est facultative car elle n&#8217;aura aucun impact sur les modules de l&#8217;application. Mais si vous voulez pratiquer davantage avec le TDD, je vous recommande de compléter cette dernière étape.</p>
</div>
<div class="paragraph">
<p>J&#8217;utilise <a href="https://github.com/activerecord-hackery/ransack">Ransack</a> ou <a href="https://github.com/casecommons/pg_search">pg_search</a> pour construire des formulaires de recherche avancée extrêmement rapidement. Mais ici, comme le but est d&#8217;apprendre et que la recherche que nous allons effectuer est très simple, je pense que nous pouvons construire un moteur de recherche à partir de zéro. Nous devons simplement considérer les critères par lesquels nous allons filtrer les attributs. Accrochez-vous bien à vos sièges, ça va être un voyage difficile.</p>
</div>
<div class="paragraph">
<p>Nous filtrerons donc les produits selon les critères suivants:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Par titre</p>
</li>
<li>
<p>Par prix</p>
</li>
<li>
<p>Trier par date de création</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cela peut sembler court et facile, mais croyez-moi, cela vous donnera mal à la tête si vous ne le planifiez pas.</p>
</div>
<div class="sect2">
<h3 id="_le_mot_clé_by">Le mot-clé by</h3>
<div class="paragraph">
<p>Nous allons créer un <em>scope</em> pour trouver les enregistrements qui correspondent à un motif particulier de caractère. Appelons-le <code>filter_by_title</code>.</p>
</div>
<div class="paragraph">
<p>Nous allons commencer par ajouter quelques <em>fixtures</em> avec différents produits afin de tester:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">one</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">TV Plosmo Philopps</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">9999.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">one</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Azos Zeenbok</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">499.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">two</span>

<span class="na">another_tv</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Cheap TV</span>
  <span class="na">price</span><span class="pi">:</span> <span class="m">99.99</span>
  <span class="na">published</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">two</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant nous pouvons construire les tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s2">"should filter products by name"</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'tv'</span><span class="p">).</span><span class="nf">count</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should filter products by name and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="s1">'tv'</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tests suivants s&#8217;assurent que la méthode <code>Product.filter_by_title</code> va rechercher correctement les produits en fonction de leurs titres. Nous utilisons le terme <code>tv</code> en minuscule afin de s&#8217;assurer que notre recherche ne sera pas sensible à la casse.</p>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est très simple en utilisant un <strong>scope</strong>.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:filter_by_title</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">keyword</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'lower(title) LIKE ?'</span><span class="p">,</span> <span class="s2">"%</span><span class="si">#{</span><span class="n">keyword</span><span class="p">.</span><span class="nf">downcase</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Le <em>scoping</em> vous permet de spécifier des requêtes couramment utilisées qui peuvent être référencées comme des appels de méthode sur les modèles. Avec ces <em>scopes</em> vous pouvez aussi chaîner avec les méthodes d&#8217;Active Record comme <code>where</code>, <code>joins</code> et <code>includes</code> car un <em>scope</em> retourne toujours un  objet <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a>. Je vous invite à jeter un œil à la <a href="https://guides.rubyonrails.org/active_record_querying.html#scopes">documentation de Rails</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est suffisante pour que nos tests passent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_par_prix">Par prix</h3>
<div class="paragraph">
<p>Pour filtrer par prix, les choses peuvent devenir un peu plus délicates. Nous allons briser la logique de filtrer par prix en deux méthodes différentes: l&#8217;une qui va chercher les produits plus grands que le prix reçu et l&#8217;autre qui va chercher ceux qui sont sous ce prix. De cette façon, nous garderons une certaine flexibilité et nous pouvons facilement tester les <em>scope</em>.</p>
</div>
<div class="paragraph">
<p>Commençons par construire les tests du <em>scope</em> <code>above_or_equal_to_price</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should filter products by price and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est très très simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:above_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &gt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est suffisante pour que nos tests passent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
...........................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous pouvez maintenant imaginer le comportement de la méthode opposée. Voici les tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should filter products by price lower and sort them'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">sort</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et l&#8217;implémentation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:below_or_equal_to_price</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">price</span><span class="o">|</span>
    <span class="n">where</span><span class="p">(</span><span class="s1">'price &lt;= ?'</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour notre bien, faisons les tests et vérifions que tout est beau et vert:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
............................</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, nous n&#8217;avons pas eu beaucoup de problèmes. Ajoutons simplement une autre <em>scope</em> pour trier les enregistrements par date de dernière mise à jour. Dans le cas où le propriétaire des produits décide de mettre à jour certaines données il voudra sûrement trier ses produits par date de création.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tri_par_date_de_création">Tri par date de création</h3>
<div class="paragraph">
<p>Ce <em>scope</em> est très facile. Ajoutons d&#8217;abord quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should sort product by most recent'</span> <span class="k">do</span>
    <span class="c1"># we will touch some products to update them</span>
    <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">touch</span>
    <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>

    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">),</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">recent</span><span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et l&#8217;implémentation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span>
    <span class="n">order</span><span class="p">(</span><span class="ss">:updated_at</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tous nos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.............................</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search scopes on the product model"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_moteur_de_recherche">Moteur de recherche</h3>
<div class="paragraph">
<p>Maintenant que nous avons la base pour le moteur de recherche que nous utiliserons dans l&#8217;application, il est temps de mettre en œuvre une méthode de recherche simple mais puissante. Elle s&#8217;occupera de gérer toute la logique pour récupérer les enregistrements des produits.</p>
</div>
<div class="paragraph">
<p>La méthode consistera à enchaîner tous les <code>scope</code> que nous avons construits précédemment et à retourner le résultat. Commençons par ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/product_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'search should not find "videogame" and "100" as min price'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'videogame'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">100</span> <span class="p">}</span>
    <span class="n">assert</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">).</span><span class="nf">empty?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'search should fin cheap TV'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">keyword: </span><span class="s1">'tv'</span><span class="p">,</span> <span class="ss">min_price: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">max_price: </span><span class="mi">150</span> <span class="p">}</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:another_tv</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should get all product when no parameters'</span> <span class="k">do</span>
    <span class="n">assert_equal</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span><span class="p">,</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">({})</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'search should filter by product ids'</span> <span class="k">do</span>
    <span class="n">search_hash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">product_ids: </span><span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)],</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_hash</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous avons ajouté un tas de code mais je vous assure que l&#8217;implémentation est très facile. Vous pouvez aller plus loin et ajouter quelques tests supplémentaires mais, dans mon cas, je n&#8217;ai pas trouvé cela nécessaire.</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">].</span><span class="nf">present?</span> <span class="p">?</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:product_ids</span><span class="p">])</span> <span class="p">:</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>

    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">filter_by_title</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">])</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:keyword</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">above_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:min_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">below_or_equal_to_price</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">].</span><span class="nf">to_f</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:max_price</span><span class="p">]</span>
    <span class="n">products</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">recent</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:recent</span><span class="p">])</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:recent</span><span class="p">].</span><span class="nf">present?</span>

    <span class="n">products</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est important de noter que nous retournons les produits en tant qu&#8217;objet <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a> afin de pouvoir enchaîner d&#8217;autres méthodes en cas de besoin ou les paginer comme nous allons le voir dans les derniers chapitres. Il suffit de mettre à jour l&#8217;action <code>Product#index</code> pour récupérer les produits à partir de la méthode de recherche:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons exécuter l&#8217;ensemble de la suite de tests, pour nous assurer que l&#8217;application est en bonne santé jusqu&#8217;ici:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

.................................
33 runs, 49 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> ces changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds search class method to filter products"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter06</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_6">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jusqu&#8217;à présent, et grâce à la gemme <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a>, c&#8217;était facile. Sur les chapitres à venir, nous allons commencer à construire le modèle <code>Order</code> qui associera les utilisateurs aux produits.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter07-placing-orders" class="sect0">Création des commandes</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Dans les chapitres précédents nous avons traité les associations entre les produits et les modèles utilisateurs. Nous avons aussi vu comment bien les sérialiser en les optimisant afin de pouvoir <em>scaler</em>, (c&#8217;est-à-dire s&#8217;adapter facilement à une forte demande sur notre application). Maintenant, il est temps de commencer à passer des commandes. Cela va être une situation plus complexe parce que nous allons gérer les associations entre les trois modèles. Nous devons être assez malins pour gérer la sortie JSON que nous fournissons.</p>
</div>
<div class="paragraph">
<p>Dans ce chapitre, nous allons faire plusieurs choses:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Créer un modèle de commande avec les spécifications correspondantes</p>
</li>
<li>
<p>Gérer l&#8217;association de sortie JSON entre l&#8217;utilisateur de la commande et les modèles de produits</p>
</li>
<li>
<p>Envoyer un courriel de confirmation avec le récapitulatif de la commande</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Maintenant que tout est clair, nous pouvons commencer à travailler. Vous pouvez cloner le projet jusqu&#8217;à ce point avec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter07</code></pre>
</div>
</div>
<div class="paragraph">
<p>Créons une nouvelle branche afin de commencer à travailler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modélisation_de_la_commande">Modélisation de la commande</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si vous vous souvenez des associations entre les modèles, vous devez vous souvenir que le modèle <code>Order</code> est associé aux modèles <code>User</code> et <code>Product</code>. C&#8217;est en fait très simple de gérer cela avec Rails. La partie délicate est lors de la sérialisation de ces objets. J&#8217;en parlerai plus en détail plus tard.</p>
</div>
<div class="paragraph">
<p>Commençons par créer le modèle de la commande:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model order user:belongs_to total:decimal</code></pre>
</div>
</div>
<div class="paragraph">
<p>La commande ci-dessus va générer le modèle <code>Order</code>. Je profite de la méthode des <code>belongs_to</code> pour créer la clé étrangère correspondante pour que la commande appartienne à un utilisateur. Elle ajoute aussi la directive <code>belongs_to</code> dans le modèle des commandes. Migrons la base de données:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est maintenant temps de créer quelques tests dans le fichier <code>order_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s1">'Should have a positive total'</span> <span class="k">do</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">assert_not</span> <span class="n">order</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est assez simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">numericality: </span><span class="p">{</span> <span class="ss">greater_than_or_equal_to: </span><span class="mi">0</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:total</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>N&#8217;oubliez pas d&#8217;ajouter la relation <code>orders</code> à nos utilisateur en spécifiant la suppression en cascade:</p>
</div>
<div class="listingblock">
<div class="title">app/models/user.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..................................
34 runs, 50 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et <em>commitons</em> tout cela:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Generate orders"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_les_commandes_et_les_produits">Les commandes et les produits</h3>
<div class="paragraph">
<p>Nous devons établir la liaison entre la commande et le produit. Cela se fait avec une association <em>many-to-many</em> car de nombreux produits seront placés sur plusieurs commandes et les commandes auront plusieurs produits. Dans ce cas, nous avons donc besoin d&#8217;un modèle supplémentaire qui joindra ces deux autres objets et mappera l&#8217;association appropriée. Générons ce modèle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate model placement order:belongs_to product:belongs_to</code></pre>
</div>
</div>
<div class="paragraph">
<p>Migrons la base de données:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est la suivante:</p>
</div>
<div class="listingblock">
<div class="title">app/models/product.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
  <span class="n">has_many</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">through: :placements</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si vous avez suivi le tutoriel jusqu&#8217;à présent, l&#8217;implémentation est déjà là, grâce au type de <code>belongs_to</code> que nous passons au générateur de commandes du modèle. Nous devrions ajouter l&#8217;option <code>inverse_of</code> au modèle de placement pour chaque appel aux <code>belongs_to</code>. Cela donne un petit coup de pouce lors du référencement de l&#8217;objet parent.</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:order</span>
  <span class="n">belongs_to</span> <span class="ss">:product</span><span class="p">,</span> <span class="ss">inverse_of: :placements</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant, lançons tous les tests des modèles afin de nous assurer que tout est bon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..................................
34 runs, 50 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que tout est beau et vert, <em>commitons</em> les changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Associates products and orders with a placements model"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exposer_le_modèle_dutilisateur">Exposer le modèle d&#8217;utilisateur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il est maintenant temps de préparer le contrôleur des commandes à exposer les bonnes commandes. Si vous vous souvenez des chapitres précédents où l&#8217;on avait utilisé <a href="https://github.com/Netflix/fast_jsonapi">fast_jsonapi</a> vous devez vous rappeler que c&#8217;était vraiment facile.</p>
</div>
<div class="paragraph">
<p>Définissons d&#8217;abord quelles actions nous allons mettre en place:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Une action d&#8217;indexation pour récupérer les commandes des utilisateurs en cours</p>
</li>
<li>
<p>Une action show pour récupérer une commande particulière de l&#8217;utilisateur courant</p>
</li>
<li>
<p>Une action de création pour passer réellement la commande</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Commençons par l&#8217;action <code>index</code>. Nous devons d&#8217;abord créer le contrôleur de commandes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate controller api::v1::orders</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jusqu&#8217;ici, et avant de commencer à taper du code, nous devons nous demander:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Est-ce que je dois laisser les routes de ma commande imbriqués dans le <code>UsersController</code> ou bien dois je les isoler?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>La réponse est vraiment simple: cela dépend de la quantité d&#8217;informations que vous voulez exposer au développeur.</p>
</div>
<div class="paragraph">
<p>Dans notre cas, nous n&#8217;allons pas le faire car nous allons récupérer les commandes de utilisateur sur la route <code>/orders</code>. Commençons par quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should forbid orders for unlogged'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span>
      <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
      <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">].</span><span class="nf">count</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Si nous exécutons la suite de tests maintenant, comme vous pouvez vous y attendre, les deux tests échoueront. C&#8217;est normal car nous n&#8217;avons même pas défini ni les bonnes routes ni l&#8217;action. Commençons donc par ajouter les routes:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults: </span><span class="p">{</span> <span class="ss">format: :json</span> <span class="p">}</span> <span class="k">do</span>
    <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span>
      <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:index</span><span class="p">]</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons donc générer un nouveau <em>serializer</em> pour les commandes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate serializer order</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et ajoutons les relations:</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span>
  <span class="kp">include</span> <span class="no">FastJsonapi</span><span class="o">::</span><span class="no">ObjectSerializer</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="n">has_many</span> <span class="ss">:products</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est maintenant temps d&#8217;implémenter le contrôleur des commandes:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index]</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant nos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
....................................
36 runs, 53 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous aimons nos commits très petits. Alors <em>commitons</em> dès maintenant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds the index action for order"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_afficher_une_seule_commande">Afficher une seule commande</h3>
<div class="paragraph">
<p>Comme vous pouvez déjà l&#8217;imaginer, cette route est très facile. Nous n&#8217;avons qu&#8217;à mettre en place quelques configurations (routes, action du contrôleur) et ce sera tout pour cette section. Nous allons aussi inclure les produits liés à cette commande dans le JSON de sortie.</p>
</div>
<div class="paragraph">
<p>Commençons par ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">spec/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>  <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">].</span><span class="nf">count</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, la deuxième partie du test vérifie que le produit est inclus dans le JSON.</p>
</div>
<div class="paragraph">
<p>Ajoutons l&#8217;implémentation pour faire passer nos tests. Sur le fichier <code>routes.rb</code> ajoutez l&#8217;action <code>show</code> aux routes des commandes:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et l&#8217;implémentation devrait ressembler à ceci:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show]</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">order</span>
      <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">include: </span><span class="p">[</span><span class="ss">:products</span><span class="p">]</span> <span class="p">}</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
    <span class="k">else</span>
      <span class="n">head</span> <span class="mi">404</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tous nos tests passent désormais:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.....................................
37 runs, 55 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> les changements et passons à l&#8217;action <code>Product#create</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the show action for order"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_placement_et_commandes">Placement et commandes</h3>
<div class="paragraph">
<p>Il est maintenant temps de donner la possibilité à l&#8217;utilisateur de passer quelques commandes. Cela ajoutera de la complexité à l&#8217;application, mais ne vous inquiétez pas, nous allons faire les choses une étape à la fois.</p>
</div>
<div class="paragraph">
<p>Avant de lancer cette fonctionnalité, prenons le temps de réfléchir aux implications de la création d&#8217;une commande dans l&#8217;application. Je ne parle pas de la mise en place d&#8217;un service de transactions comme <a href="https://stripe.com/">Stripe</a> ou <a href="https://www.braintreepayments.com/">Braintree</a> mais de choses comme:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la gestion des produits en rupture de stock</p>
</li>
<li>
<p>la diminution de l&#8217;inventaire de produits</p>
</li>
<li>
<p>ajouter une certaine validation pour le placement de la commande pour s&#8217;assurer qu&#8217;il y a suffisamment de produits au moment où la commande est passée</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On dirait qu&#8217;il reste un paquet de chose à faire mais croyez-moi: vous êtes plus près que vous ne le pensez et ce n&#8217;est pas aussi dur que ça en a l&#8217;air. Pour l&#8217;instant, gardons les choses simples et supposons que nous avons toujours assez de produits pour passer un nombre quelconque de commandes. Nous nous soucions juste de la réponse du serveur pour le moment.</p>
</div>
<div class="paragraph">
<p>Si vous vous rappelez le modèle de commande, nous avons besoin de trois choses: un total pour la commande, l&#8217;utilisateur qui passe la commande et les produits pour la commande. Compte tenu de cette information, nous pouvons commencer à ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="vi">@order_params</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">order: </span><span class="p">{</span>
      <span class="ss">product_id: </span><span class="p">[</span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">],</span>
      <span class="ss">total: </span><span class="mi">50</span>
    <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should forbid create order for unlogged'</span> <span class="k">do</span>
    <span class="n">assert_no_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:forbidden</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'should create order with two products'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span>
        <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span>
        <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
        <span class="ss">as: :json</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, nous sommes en train de créer une variable <code>order_params</code> avec les données de la commande. Vous voyez le problème ici? Je l&#8217;expliquerai plus tard. Ajoutons simplement le code nécessaire pour faire passer ce test.</p>
</div>
<div class="paragraph">
<p>Nous devons d&#8217;abord ajouter l&#8217;action aux routes:</p>
</div>
<div class="listingblock">
<div class="title">config/routes.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">resources</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show create]</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite, la mise en œuvre qui est facile:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:check_login</span><span class="p">,</span> <span class="ss">only: </span><span class="sx">%i[index show create]</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:total</span><span class="p">,</span> <span class="ss">product_ids: </span><span class="p">[])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant, nos tests devraient tous passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
.......................................
39 runs, 59 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok donc tout va bien. Nous devrions maintenant passer au chapitre suivant, non? Laissez-moi faire une pause avant. Nous avons de graves erreurs sur l&#8217;application et elles ne sont pas liées au code lui-même mais sur la partie métier.</p>
</div>
<div class="paragraph">
<p>Ce n&#8217;est pas parce que les tests passent que l&#8217;application remplit la partie métier de l&#8217;application. Je voulais en parler parce que dans de nombreux cas, c&#8217;est super facile de simplement recevoir des paramètres et de construire des objets à partir de ces paramètres. Dans notre cas, nous ne pouvons pas nous fier aux données que nous recevons. En effet, nous laissons ici le client fixer le total de la commande! Ouais, c&#8217;est fou!</p>
</div>
<div class="paragraph">
<p>Nous devons donc ajouter quelques validations et calculer le total de la commande dans le modèle. De cette façon, nous ne recevons plus cet attribut total et nous avons un contrôle complet sur cet attribut. Alors faisons-le.</p>
</div>
<div class="paragraph">
<p>Nous devons d&#8217;abord ajouter quelques tests pour le modèle de commande:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'Should set total'</span> <span class="k">do</span>
    <span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">new</span> <span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">products</span> <span class="o">&lt;&lt;</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">products</span> <span class="o">&lt;&lt;</span> <span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">)</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">save</span>

    <span class="n">assert_equal</span> <span class="p">(</span><span class="vi">@product1</span><span class="p">.</span><span class="nf">price</span> <span class="o">+</span> <span class="vi">@product2</span><span class="p">.</span><span class="nf">price</span><span class="p">),</span> <span class="n">order</span><span class="p">.</span><span class="nf">total</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous pouvons maintenant ajouter l&#8217;implémentation:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Juste avant que vous ne lanciez vos tests, nous avons besoin de mettre à jour l&#8217;usine de commande:</p>
</div>
<div class="paragraph">
<p>Nous pouvons maintenant <em>hooker</em> la méthode <code>set_total!</code> à un rappel <code>before_validation</code> pour s&#8217;assurer qu&#8217;il a le bon total avant la validation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Le <em>hook</em> est une méthode qui se déclenchera automatiquement lors de l&#8217;exécution
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_validation</span> <span class="ss">:set_total!</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A ce stade, nous nous assurons que le total est toujours présent et supérieur ou égal à zéro, ce qui signifie que nous pouvons supprimer ces validations et supprimer les spécifications. Nos tests devraient passer maintenant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>

...........F

Failure:
OrderTest#test_Should_have_a_positive_total <span class="o">[</span>/home/arousseau/github/madeindjs/market_place_api/test/models/order_test.rb:14]:
Expected <span class="nb">true </span>to be nil or <span class="nb">false


</span>rails <span class="nb">test test</span>/models/order_test.rb:11

............................

Finished <span class="k">in </span>0.542600s, 73.7191 runs/s, 110.5786 assertions/s.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Oups! Nous obtenons une <em>failure</em> sur notre précédent test <em>Should have a positive total</em>. C&#8217;est logique puisque le total de la commande se calcule dynamiquement. Nous pouvons donc tout simplement supprimer ce test qui est devenu obsolète.</p>
</div>
<div class="paragraph">
<p>Nos tests doivent continuer à passer. <em>Commitons</em> nos changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds the create method for the orders controller"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_envoyer_un_email_de_confirmation">Envoyer un email de confirmation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La dernière section de ce chapitre sera d&#8217;envoyer un courriel de confirmation à l&#8217;utilisateur qui vient de créer une commande. Si vous le voulez, vous pouvez sauter cette étape et passer au chapitre suivant! Cette section est plus à un bonus.</p>
</div>
<div class="paragraph">
<p>Vous êtes peut-être familier avec la manipulation des courriels avec Rails, je vais essayer de rendre cela simple et rapide:</p>
</div>
<div class="paragraph">
<p>Nous commençons par créer le <code>order_mailer</code> avec un mail nommé <code>send_confirmation</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate mailer order_mailer send_confirmation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, nous pouvons ajouter quelques tests pour les mails de commandes que nous venons de créer:</p>
</div>
<div class="listingblock">
<div class="title">test/mailers/order_mailer_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should be set to be delivered to the user from the order passed in"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="vi">@order</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="s2">"Order Confirmation"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">email</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s1">'no-reply@marketplace.com'</span><span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_match</span> <span class="s2">"Order: #</span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
    <span class="n">assert_match</span> <span class="s2">"You ordered </span><span class="si">#{</span><span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2"> products"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>J&#8217;ai simplement copié/collé les tests de la documentation et je les ai adaptés à nos besoins. Nous devons maintenant nous assurer que ces tests passent.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord, nous ajoutons la méthode <code>OrderMailer#send_confirmation</code>:</p>
</div>
<div class="listingblock">
<div class="title">app/mailers/order_mailer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="n">default</span> <span class="ss">from: </span><span class="s1">'no-reply@marketplace.com'</span>
  <span class="k">def</span> <span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">order</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span>
    <span class="n">mail</span> <span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">subject: </span><span class="s1">'Order Confirmation'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Après avoir ajouté ce code, nous devons maintenant ajouter les vues correspondantes. C&#8217;est une bonne pratique d&#8217;inclure une version texte en plus de la version HTML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;%# app/views/order_mailer/send_confirmation.txt.erb %&gt;</span>
Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span>
You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:
<span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="erb"><span class="c">&lt;!-- app/views/order_mailer/send_confirmation.html.erb --&gt;</span>
<span class="nt">&lt;h1&gt;</span>Order: #<span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>You ordered <span class="cp">&lt;%=</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">count</span> <span class="cp">%&gt;</span> products:<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span> - <span class="cp">&lt;%=</span> <span class="n">number_to_currency</span> <span class="n">product</span><span class="p">.</span><span class="nf">price</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, nos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 66 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant, il suffit d&#8217;appeler la méthode <code>OrderMailer#send_confirmation</code> dans l&#8217;action de création sur le contrôleur des ordres:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">order_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="no">OrderMailer</span><span class="p">.</span><span class="nf">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">).</span><span class="nf">deliver</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: </span><span class="mi">201</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: </span><span class="mi">422</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour être sûr que nous n&#8217;avons rien cassé, lançons tous les tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 66 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> tout ce que nous venons de faire pour terminer cette section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span> <span class="o">&amp;&amp;</span> git commit <span class="nt">-m</span> <span class="s2">"Adds order confirmation mailer"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter07</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_7">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ça y est! Vous avez réussi! Vous pouvez vous applaudir. Je sais que ça a été long mais c&#8217;est presque fini, croyez moi.</p>
</div>
<div class="paragraph">
<p>Sur les chapitres à venir, nous continuerons à travailler sur le modèle de commande pour ajouter des validations lors de la passation d&#8217;une commande. Certains scénarios sont:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Que se passe-t-il lorsque les produits ne sont pas disponibles?</p>
</li>
<li>
<p>Diminuer la quantité du produit en cours lors de la passation d&#8217;une commande</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le prochain chapitre sera court, mais il est très important pour la santé de l&#8217;application. Alors ne le sautez pas.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter08-improve_orders" class="sect0">Améliorer les commandes</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Précédemment nous avons amélioré notre API pour passer des commandes et envoyer un e-mail de confirmation à l&#8217;utilisateur (juste pour améliorer l&#8217;expérience utilisateur). Ce chapitre va s&#8217;occuper de quelques validations sur le modèle de commande afin de s&#8217;assurer qu&#8217;elle est valide. C&#8217;est-à-dire:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Diminuer la quantité du produit en cours lors de la passation d&#8217;une commande</p>
</li>
<li>
<p>Que se passe-t-il lorsque les produits ne sont pas disponibles?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous aurons aussi besoin de mettre à jour un peu la sortie JSON pour les commandes. Mais ne divulgâchons pas la suite.</p>
</div>
<div class="paragraph">
<p>Maintenant que tout est clair, nous pouvons mettre les mains dans le cambouis. Vous pouvez cloner le projet jusqu&#8217;à ce point avec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter08</code></pre>
</div>
</div>
<div class="paragraph">
<p>Créons une nouvelle branche afin de commencer à travailler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter08</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_diminution_de_la_quantité_de_produit">Diminution de la quantité de produit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans cette partie nous travaillerons sur la mise à jour de la quantité du produit pour nous assurer que chaque commande livrera le produit réel. Actuellement, le modèle de produit n&#8217;a pas d&#8217;attribut de quantité. Alors faisons-le:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_products quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Attendez! N&#8217;exécutez pas encore cette migration! Nous allons y apporter une petite modification. Comme bonne pratique, j&#8217;aime ajouter des valeurs par défaut pour la base de données juste pour être sûr de ne pas tout gâcher avec des valeurs nulles. C&#8217;est un cas parfait!</p>
</div>
<div class="paragraph">
<p>Votre fichier de migration devrait ressembler à ceci:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190621105101_add_quantity_to_products.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant nous pouvons lancer la migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et n&#8217;oublions pas de mettre à jour les <em>fixtures</em> en ajoutant le champs <strong>quantity</strong> (j&#8217;ai choisi la valeur <code>5</code> totalement par hasard).</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/products.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">one</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">another_tv</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="s">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est maintenant temps de diminuer la quantité du <code>Product</code> une fois l'`Order` passée. La première chose qui vous vient probablement à l&#8217;esprit est de le faire dans le modèle <code>Order</code> et c&#8217;est une erreur fréquente. Lorsque vous travaillez avec des associations <em>Many-to-Many</em>, nous oublions totalement le modèle de jointure qui dans ce cas est <code>Placement</code>. Le <code>Placement</code> est un meilleur endroit pour gérer cela car nous avons accès à la commande et au produit. Ainsi, nous pouvons facilement diminuer le stock du produit.</p>
</div>
<div class="paragraph">
<p>Avant de commencer à implémenter le code, nous devons changer la façon dont nous gérons la création de la commande car nous devons maintenant accepter une quantité pour chaque produit. Si vous vous souvenez, nous attendons un tableau d&#8217;identifiants de produits. Je vais essayer de garder les choses simples et je vais envoyer un tableau de Hash avec les clefs <code>product_id</code> et <code>quantity</code>.</p>
</div>
<div class="paragraph">
<p>Un exemple rapide serait quelque chose comme cela:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">product_ids_and_quantities</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="ss">product_id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">4</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">product_id: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">5</span> <span class="p">}</span>
<span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ça va être difficile, alors restez avec moi. Construisons d&#8217;abord des tests unitaires:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'builds 2 placements for the order'</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span> <span class="p">[</span>
      <span class="p">{</span> <span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span> <span class="p">},</span>
      <span class="p">{</span> <span class="ss">product_id: </span><span class="vi">@product2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span> <span class="p">},</span>
    <span class="p">]</span>

    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Placement.count'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@order</span><span class="p">.</span><span class="nf">save</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant l&#8217;implémentation</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>

  <span class="c1"># @param product_ids_and_quantities [Array&lt;Hash&gt;] something like this `[{product_id: 1, quantity: 2}]`</span>
  <span class="c1"># @yield [Placement] placements build</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="n">placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">product_id: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:product_id</span><span class="p">])</span>
      <span class="k">yield</span> <span class="n">placement</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant, si nous lançons les tests, ils devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 60 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Les <code>build_placements_with_product_ids_and_quantities</code> construiront les objets <code>Placement</code> et une fois que nous déclencherons la méthode de sauvegarde de l&#8217;ordre, tout sera inséré dans la base de données. Une dernière étape avant de valider ceci est de mettre à jour <code>orders_controller_test</code> avec son implémentation.</p>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord, nous mettons à jour le fichier <code>orders_controller_test</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@order</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
    <span class="vi">@order_params</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">order: </span><span class="p">{</span>
        <span class="ss">product_ids_and_quantities: </span><span class="p">[</span>
          <span class="p">{</span> <span class="ss">product_id: </span><span class="n">products</span><span class="p">(</span><span class="ss">:one</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span> <span class="p">},</span>
          <span class="p">{</span> <span class="ss">product_id: </span><span class="n">products</span><span class="p">(</span><span class="ss">:two</span><span class="p">).</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">3</span> <span class="p">},</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s1">'should create order with two products and placements'</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Order.count'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'Placement.count'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">post</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">params: </span><span class="vi">@order_params</span><span class="p">,</span> <span class="ss">as: :json</span>
            <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">assert_response</span> <span class="ss">:created</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous devons ensuite mettre un peu à jour notre contrôleur des commandes:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">user: </span><span class="n">current_user</span>
    <span class="n">order</span><span class="p">.</span><span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">order_params</span><span class="p">[</span><span class="ss">:product_ids_and_quantities</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="n">order</span><span class="p">,</span> <span class="ss">status: :created</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">errors: </span><span class="n">order</span><span class="p">.</span><span class="nf">errors</span> <span class="p">},</span> <span class="ss">status: :forbidden</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">order_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:order</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">product_ids_and_quantities: </span><span class="p">[</span><span class="ss">:product_id</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notez que j&#8217;ai aussi modifié la méthode <code>OrdersController#order_params</code>.</p>
</div>
<div class="paragraph">
<p>Enfin et surtout, nous devons mettre à jour le fichier d&#8217;usine des produits afin d&#8217;attribuer une valeur de quantité élevée pour avoir au moins quelques produits en stock.</p>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changements avant d&#8217;aller plus loin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Allows the order to be placed along with product quantity"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Avez-vous remarqué que nous ne mettons pas à jour la quantité des produits? Actuellement, il n&#8217;y a aucun moyen d&#8217;en faire le suivi. Cela peut être corrigé très facilement, en ajoutant simplement un attribut de quantité au modèle <code>Placement</code> de sorte que pour chaque produit, nous sauvegardons la quantité correspondante. Commençons par créer la migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rails generate migration add_quantity_to_placements quantity:integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme pour la migration des attributs de quantité de produit, nous devrions ajouter une valeur par défaut égale à 0. N&#8217;oubliez pas que c&#8217;est facultatif mais c&#8217;est mieux. Le fichier de migration devrait ressembler à cela:</p>
</div>
<div class="listingblock">
<div class="title">db/migrate/20190621114614_add_quantity_to_placements.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">AddQuantityToPlacements</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.2</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:placements</span><span class="p">,</span> <span class="ss">:quantity</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lancez ensuite la migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake db:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ajoutons l&#8217;attribut <code>quantity</code> dans les <em>fixtures</em>:</p>
</div>
<div class="listingblock">
<div class="title">test/fixtures/placements.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">one</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="m">5</span>

<span class="na">two</span><span class="pi">:</span>
  <span class="c1"># ...</span>
  <span class="na">quantity</span><span class="pi">:</span> <span class="s">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il ne nous reste plus qu&#8217;à mettre à jour la méthode <code>build_placements_with_product_ids_and_quantities</code> pour ajouter la quantité pour les placements:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>

  <span class="c1"># @param product_ids_and_quantities [Array&lt;Hash&gt;] something like this `[{product_id: 1, quantity: 2}]`</span>
  <span class="c1"># @yield [Placement] placements build</span>
  <span class="k">def</span> <span class="nf">build_placements_with_product_ids_and_quantities</span><span class="p">(</span><span class="n">product_ids_and_quantities</span><span class="p">)</span>
    <span class="n">product_ids_and_quantities</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product_id_and_quantity</span><span class="o">|</span>
      <span class="n">placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span>
        <span class="ss">product_id: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:product_id</span><span class="p">],</span>
        <span class="ss">quantity: </span><span class="n">product_id_and_quantity</span><span class="p">[</span><span class="ss">:quantity</span><span class="p">],</span>
      <span class="p">)</span>
      <span class="k">yield</span> <span class="n">placement</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, nos tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
........................................
40 runs, 61 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds quantity to placements"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_étendre_le_modèle_de_placement">Étendre le modèle de placement</h3>
<div class="paragraph">
<p>Il est temps de mettre à jour la quantité du produit une fois la commande enregistrée ou plus précisément: une fois le placement créé. Pour se faire, nous allons ajouter une méthode et la connecter au <em>callback</em> <code>after_create</code>.</p>
</div>
<div class="paragraph">
<p>Commençons simplement par ajouter quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/placement_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">PlacementTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@placement</span> <span class="o">=</span> <span class="n">placements</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s1">'decreases the product quantity by the placement quantity'</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="vi">@placement</span><span class="p">.</span><span class="nf">product</span>

    <span class="n">assert_difference</span><span class="p">(</span><span class="s1">'product.quantity'</span><span class="p">,</span> <span class="o">-</span><span class="vi">@placement</span><span class="p">.</span><span class="nf">quantity</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@placement</span><span class="p">.</span><span class="nf">decrement_product_quantity!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La mise en œuvre est assez simple comme le montre le code suivant.</p>
</div>
<div class="listingblock">
<div class="title">app/models/placement.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Placement</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="n">after_create</span> <span class="ss">:decrement_product_quantity!</span>

  <span class="k">def</span> <span class="nf">decrement_product_quantity!</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">decrement!</span><span class="p">(</span><span class="ss">:quantity</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Decreases the product quantity by the placement quantity"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_du_stock_des_produits">Validation du stock des produits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Depuis le début du chapitre, nous avons ajouté l&#8217;attribut <code>quantity</code> au modèle de produit. il est maintenant temps de valider que la quantité de produit est suffisante pour que la commande soit passée. Afin de rendre les choses plus intéressantes, nous allons le faire à l&#8217;aide d&#8217;un validateur personnalisé.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
vous pouvez consulter la <a href="https://guides.rubyonrails.org/active_record_validations.html#performing-custom-validations">documentation</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tout d&#8217;abord, nous devons créer un répertoire de <code>validators</code> dans le répertoire <code>app</code> (Rails le charge par défaut) et ensuite créons un fichier dedans:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>app/validators
<span class="nv">$ </span><span class="nb">touch </span>app/validators/enough_products_validator.rb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Avant de commencer à implémenter la classe, nous devons nous assurer d&#8217;ajouter un test au modèle de commande pour vérifier si la commande peut être passée.</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"an order should command not too much product than available"</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">&lt;&lt;</span> <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="vi">@product1</span><span class="p">.</span><span class="nf">quantity</span><span class="p">))</span>

    <span class="n">assert_not</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">valid?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir sur les tests suivants, nous nous assurons d&#8217;abord que <code>placement_2</code> essaie de demander plus de produits que ce qui est disponible. Donc dans ce cas la commande n&#8217;est pas supposée être valide.</p>
</div>
<div class="paragraph">
<p>Le test est en train d&#8217;échouer. Faisons le passer en implémentant le code pour le validateur:</p>
</div>
<div class="listingblock">
<div class="title">app/validators/enough_products_validator.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">EnoughProductsValidator</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="n">record</span><span class="p">.</span><span class="nf">placements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span>
      <span class="n">product</span> <span class="o">=</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span>
      <span class="k">if</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span> <span class="o">&gt;</span> <span class="n">product</span><span class="p">.</span><span class="nf">quantity</span>
        <span class="n">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="n">product</span><span class="p">.</span><span class="nf">title</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"Is out of stock, just </span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">quantity</span><span class="si">}</span><span class="s2"> left"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>J&#8217;ajoute simplement un message pour chacun des produits en rupture de stock, mais vous pouvez le gérer différemment si vous le souhaitez. Il ne nous reste plus qu&#8217;à ajouter ce validateur au modèle <code>Order</code> comme cela:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>
  <span class="c1"># ...</span>
  <span class="n">validates_with</span> <span class="no">EnoughProductsValidator</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant, si vous lancez vos tests, tout devrait être beau et vert:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 63 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds validator for order with not enough products on stock"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mettre_à_jour_le_prix_total">Mettre à jour le prix total</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Réalisez vous que le prix total est mal calculé? Actuellement, nous ajoutons le prix des produits sur la commande, quelle que soit la quantité demandée. Permettez-moi d&#8217;ajouter le code pour clarifier le problème:</p>
</div>
<div class="paragraph">
<p>Actuellement, dans le modèle de commande, nous avons cette méthode pour calculer le montant à payer:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="n">products</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:price</span><span class="p">).</span><span class="nf">sum</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, au lieu de calculer le total en additionnant simplement les prix des produits, nous devons le multiplier par la quantité. Alors mettons d&#8217;abord à jour les tests:</p>
</div>
<div class="listingblock">
<div class="title">test/models/order_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">OrderTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>

  <span class="nb">test</span> <span class="s2">"Should set total"</span> <span class="k">do</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">placements</span> <span class="o">=</span> <span class="p">[</span>
      <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span><span class="p">),</span>
      <span class="no">Placement</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">product_id: </span><span class="vi">@product2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">quantity: </span><span class="mi">2</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="vi">@order</span><span class="p">.</span><span class="nf">set_total!</span>
    <span class="n">expected_total</span> <span class="o">=</span> <span class="p">(</span><span class="vi">@product1</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="vi">@product2</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">assert_equal</span> <span class="n">expected_total</span><span class="p">,</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">total</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;implémentation est assez simple:</p>
</div>
<div class="listingblock">
<div class="title">app/models/order.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">set_total!</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">total</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">placements</span>
                     <span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">placement</span><span class="o">|</span> <span class="n">placement</span><span class="p">.</span><span class="nf">product</span><span class="p">.</span><span class="nf">price</span> <span class="o">*</span> <span class="n">placement</span><span class="p">.</span><span class="nf">quantity</span> <span class="p">}</span>
                     <span class="p">.</span><span class="nf">sum</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant, les tests devraient passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 63 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Commitons</em> nos changements et récapitulons tout ce que nous venons de faire:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Updates the total calculation for order"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et comme nous arrivons à la fin de notre chapitre, il est temps d&#8217;appliquer toutes nos modifications sur la branche master en faisant un <em>merge</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter08</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_8">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oh vous êtes ici! Permettez-moi de vous féliciter! Cela fait un long chemin depuis le premier chapitre. Mais vous êtes à un pas de plus. En fait, le chapitre suivant sera le dernier. Alors essayez d&#8217;en tirer le meilleur.</p>
</div>
<div class="paragraph">
<p>Le dernier chapitre portera sur la façon d&#8217;optimiser l&#8217;API en utilisant la pagination, la mise en cache et les tâches d&#8217;arrière-plan. Donc bouclez vos ceintures, ça va être un parcours mouvementé.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<h1 id="chapter09-optimization" class="sect0">Optimisations</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Bienvenue dans le dernier chapitre du livre. Le chemin a été long mais vous n&#8217;êtes qu&#8217;à un pas de la fin. Dans le chapitre précédent, nous avons terminé la modélisation du modèle de commandes. Nous pourrions dire que le projet est maintenant terminé mais je veux couvrir quelques détails importants sur l&#8217;optimisation. Les sujets que je vais aborder ici seront:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la pagination</p>
</li>
<li>
<p>la mise en cache</p>
</li>
<li>
<p>l&#8217;optimisation des requêtes SQL</p>
</li>
<li>
<p>l&#8217;activation de CORS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>J&#8217;essaierai d&#8217;aller aussi loin que possible en essayant de couvrir certains scénarios courants. J&#8217;espère que ces scenarii vous seront utiles pour certains de vos projets.</p>
</div>
<div class="paragraph">
<p>Si vous commencez à lire à ce stade, vous voudrez probablement que le code fonctionne, vous pouvez le cloner comme ça:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout tags/checkpoint_chapter09</code></pre>
</div>
</div>
<div class="paragraph">
<p>Créons une nouvelle branche pour ce chapitre:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pagination">Pagination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Une stratégie très commune pour optimiser la récupération d&#8217;enregistrements dans une base de données est de charger seulement une quantité limitée en les paginant. Si vous êtes familier avec cette technique, vous savez qu&#8217;avec Rails c&#8217;est vraiment très facile à mettre en place avec des gemmes telles que <a href="https://github.com/mislav/will_paginate">will_paginate</a> ou <a href="https://github.com/kaminari/kaminari">kaminari</a>.</p>
</div>
<div class="paragraph">
<p>La seule partie délicate ici est de savoir comment gérer la sortie JSON pour donner assez d&#8217;informations au client sur la façon dont le tableau est paginé. Dans la section précédente, j&#8217;ai partagé quelques ressources sur les pratiques que j&#8217;allais suivre ici. L&#8217;une d&#8217;entre elles était <a href="http://jsonapi.org/" class="bare">http://jsonapi.org/</a> qui est une page incontournable des signets.</p>
</div>
<div class="paragraph">
<p>Si nous lisons la section sur le format, nous arriverons à une sous-section appelée <a href="https://jsonapi.org/format/#document-top-level">Top Level</a>. Pour vous expliquer rapidement, ils mentionnent quelque chose sur la pagination:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>"meta": méta-information sur une ressource, telle que la pagination.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Ce n&#8217;est pas très descriptif mais au moins nous avons un indice sur ce qu&#8217;il faut regarder ensuite au sujet de l&#8217;implémentation de la pagination. Ne vous inquiétez pas, c&#8217;est exactement ce que nous allons faire ici.</p>
</div>
<div class="paragraph">
<p>Commençons par la liste des produits.</p>
</div>
<div class="sect2">
<h3 id="_les_produits">Les produits</h3>
<div class="paragraph">
<p>Nous allons commencer par paginer la liste des produits car nous n&#8217;avons aucune restriction d&#8217;accès. Cela nous facilitera les tests. Nous devons d&#8217;abord ajouter la gemme de kaminari à notre <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add kaminari</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant nous pouvons aller à l&#8217;action <code>Products#index</code> et ajouter les méthodes de pagination comme indiqué dans la documentation:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">])</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">])</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Jusqu&#8217;à présent, la seule chose qui a changé est la requête sur la base de données pour limiter le résultat à 25 par page (ce qui est la valeur par défaut). Mais nous n&#8217;avons toujours pas ajouté d&#8217;informations supplémentaires à la sortie JSON.</p>
</div>
<div class="paragraph">
<p>Nous devons fournir les informations de pagination sur la balise meta dans le formulaire suivant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"first"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"last"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=30"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"prev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/products?page=2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que nous avons la structure finale de la balise meta, il ne nous reste plus qu&#8217;à la sortir sur la réponse JSON. Ajoutons d&#8217;abord quelques tests:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show products'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_products_url</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le test que nous venons d&#8217;ajouter devrait échouer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................F

Failure:
Api::V1::ProductsControllerTest#test_should_show_products <span class="o">[</span><span class="nb">test</span>/controllers/api/v1/products_controller_test.rb:13]:
Expected nil to not be nil.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ajoutons les informations de pagination. Nous allons en faire une partie dans un <em>concern</em> séparé afin de mieux découpler notre code:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/paginable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># app/controllers/concerns/paginable.rb</span>
<span class="k">module</span> <span class="nn">Paginable</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">current_page</span>
    <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]</span> <span class="o">||</span> <span class="mi">1</span><span class="p">).</span><span class="nf">to_i</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">per_page</span>
    <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:per_page</span><span class="p">]</span> <span class="o">||</span> <span class="mi">20</span><span class="p">).</span><span class="nf">to_i</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et maintenant nous pouvons l&#8217;utiliser dans le contrôleur.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="n">api_v1_products_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@products</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant, si nous vérifions les spécifications, elles devraient toutes passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 65 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que nous avons fait une superbe optimisation pour la route de la liste des produits, c&#8217;est au client de récupérer la <code>page</code> avec le bon paramètre <code>per_page</code> pour les enregistrements.</p>
</div>
<div class="paragraph">
<p><em>Commitons</em> ces changements et continuons avec la liste des commandes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git add <span class="nb">.</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Adds pagination for the products index action to optimize response"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_liste_des_commandes">Liste des commandes</h3>
<div class="paragraph">
<p>Maintenant, il est temps de faire exactement la même chose pour la route de la liste des commandes. Cela devrait être très facile à mettre en œuvre. Mais d&#8217;abord, ajoutons quelques tests au fichier <code>orders_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">'data'</span><span class="p">].</span><span class="nf">count</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et, comme vous vous en doutez peut-être déjà, nos tests ne passent plus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
......................................F

Failure:
Api::V1::OrdersControllerTest#test_should_show_orders <span class="o">[</span><span class="nb">test</span>/controllers/api/v1/orders_controller_test.rb:28]:
Expected nil to not be nil.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Transformons le rouge en vert:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
                          <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                          <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="n">api_v1_orders_path</span><span class="p">(</span><span class="ss">page: </span><span class="vi">@orders</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@orders</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tests devraient maintenant passer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 67 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Faisons un <em>commit</em> avant d&#8217;avancer</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Adds pagination for orders index action"</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_factorisation_de_la_pagination">Factorisation de la pagination</h3>
<div class="paragraph">
<p>Si vous avez suivi ce tutoriel ou si vous êtes un développeur Rails expérimenté, vous aimez probablement garder les choses DRY. Vous avez sûrement remarqué que le code que nous venons d&#8217;écrire est dupliqué. Je pense que c&#8217;est une bonne habitude de nettoyer un peu le code une fois la fonctionnalité implémentée.</p>
</div>
<div class="paragraph">
<p>Nous allons d&#8217;abord commencer par nettoyer ces tests que nous avons dupliqués dans le fichier <code>orders_controller_test.rb</code> et <code>products_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
<span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Afin de le factoriser, nous allons déplacer ces assertions dans le fichier <code>test_helper.rb</code> dans une méthode que nous utiliserons:</p>
</div>
<div class="listingblock">
<div class="title">test/test_helper.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">assert_json_response_is_paginated</span> <span class="n">json_response</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cet exemple partagé peut maintenant être utilisé pour remplacer les cinq tests des fichiers <code>orders_controller_test.rb</code> et <code>products_controller_test.rb</code>:</p>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/orders_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::OrdersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show orders'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_orders_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">JsonWebToken</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="ss">user_id: </span><span class="vi">@order</span><span class="p">.</span><span class="nf">user_id</span><span class="p">)</span> <span class="p">},</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_equal</span> <span class="vi">@order</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="n">json_response</span><span class="p">[</span><span class="ss">:data</span><span class="p">].</span><span class="nf">count</span>
    <span class="n">assert_json_response_is_paginated</span> <span class="n">json_response</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">test/controllers/api/v1/products_controller_test.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">Api::V1::ProductsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># ...</span>
  <span class="nb">test</span> <span class="s1">'should show products'</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">api_v1_products_url</span><span class="p">,</span> <span class="ss">as: :json</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>

    <span class="n">json_response</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:first</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:last</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
    <span class="n">assert_not_nil</span> <span class="n">json_response</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:links</span><span class="p">,</span> <span class="ss">:prev</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et les deux tests devraient passer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 71 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que nous avons fait cette simple factorisation pour les tests, nous pouvons passer à l&#8217;implémentation de la pagination pour les contrôleurs et nettoyer les choses. Si vous vous souvenez de l&#8217;action d&#8217;indexation pour les deux contrôleurs de produits et de commandes, ils ont tous les deux le même format de pagination. Alors déplaçons cette logique dans une méthode appelée <code>get_links_serializer_options</code> sous le fichier <code>paginable.rb</code>, de cette façon nous pouvons y accéder sur tout contrôleur qui aurait besoin de pagination.</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/concerns/paginable.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">module</span> <span class="nn">Paginable</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">get_links_serializer_options</span> <span class="n">links_paths</span><span class="p">,</span> <span class="n">collection</span>
    <span class="p">{</span>
      <span class="ss">links: </span><span class="p">{</span>
        <span class="ss">first: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="mi">1</span><span class="p">),</span>
        <span class="ss">last: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">total_pages</span><span class="p">),</span>
        <span class="ss">prev: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">prev_page</span><span class="p">),</span>
        <span class="ss">next: </span><span class="nb">send</span><span class="p">(</span><span class="n">links_paths</span><span class="p">,</span> <span class="ss">page: </span><span class="n">collection</span><span class="p">.</span><span class="nf">next_page</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit ensuite d&#8217;utiliser cette méthode dans nos deux contrôleurs:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/orders_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::OrdersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@orders</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">orders</span>
                          <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                          <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_orders_path'</span><span class="p">,</span> <span class="vi">@orders</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">OrderSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@orders</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Paginable</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lançons les tests pour nous assurer que tout fonctionne:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>rake <span class="nb">test</span>
..........................................
42 runs, 71 assertions, 0 failures, 0 errors, 0 skips</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce serait un bon moment pour <em>commiter</em> les changements et passer à la prochaine section sur la mise en cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Factorize pagination"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mise_en_cache">Mise en cache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il y a actuellement une implémentation pour faire de la mise en cache avec la gemme <code>fast_jsonapi</code> qui est vraiment facile à manipuler. Bien que dans les anciennes versions de la gemme, cette implémentation peut changer, elle fait le travail.</p>
</div>
<div class="paragraph">
<p>Si nous effectuons une demande à la liste des produits, nous remarquerons que le temps de réponse prend environ 174 millisecondes en utilisant cURL</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000
Total: 0,137088</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
L&#8217;option <code>-w</code> nous permet de récupérer le temps de la requête, <code>-o</code> redirige la réponse vers un fichier et <code>-s</code> masque l&#8217;affichage de cURL
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En ajoutant seulement une ligne à la classe <code>ProductSerializer</code>, nous verrons une nette amélioration du temps de réponse!</p>
</div>
<div class="listingblock">
<div class="title">app/serializers/order_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">OrderSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">enabled: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">cache_length: </span><span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/product_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">ProductSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">enabled: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">cache_length: </span><span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">app/serializers/user_serializer.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">UserSerializer</span>
  <span class="c1"># ...</span>
  <span class="n">cache_options</span> <span class="ss">enabled: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">cache_length: </span><span class="mi">12</span><span class="p">.</span><span class="nf">hours</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et c&#8217;est tout! Vérifions l&#8217;amélioration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/products
Total: 0,054786
<span class="nv">$ </span>curl <span class="nt">-w</span> <span class="s1">'Total: %{time_total}\n'</span> <span class="nt">-o</span> /dev/null <span class="nt">-s</span> http://localhost:3000/products/
Total: 0,032341</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous sommes donc passés de 137 ms à 40 ms. L&#8217;amélioration est donc énorme! <em>Committons</em> une dernière fois nos changements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="err">$</span> <span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">am</span> <span class="s2">"Adds caching for the serializers"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_requêtes_n1">Requêtes N+1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les <strong>requêtes N+1</strong> sont une plaie qui peuvent avoir un impact énorme sur les performances d&#8217;une application. Ce phénomène se produit souvent lorsqu&#8217;on utilise un <strong>ORM</strong> car il génère <strong>automatiquement</strong> les requêtes SQL pour nous. Cet outil bien pratique est à double tranchant car il peut générer un <strong>grand nombre</strong> de requêtes SQL.</p>
</div>
<div class="paragraph">
<p>Quelque chose à savoir avec les requêtes SQL est qu&#8217;il vaut mieux faire en sorte de limiter leur nombre. En d&#8217;autres termes, une grosse requête est souvent plus performante que cent petites.</p>
</div>
<div class="paragraph">
<p>Voici un exemple où l&#8217;on veut récupérer tous les utilisateurs qui ont déjà créé un produit. Ouvrez la console Rails avec <code>rails console</code> et exécutez le code Ruby suivant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="n">product</span><span class="p">.</span><span class="nf">user</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La console interactive de Rails nous montre les requêtes SQL qui sont générées. Voyez par vous même:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">Product</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"products"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"products"</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">29</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">29</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>On voit ici que nous générons une grande quantité de requêtes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Product.all</code> = 1 requête pour récupérer les recettes</p>
</li>
<li>
<p><code>product.user</code> = 1 requête <code>SELECT  "users".* FROM "users" WHERE "users"."id" = ? LIMIT 1  [["id", 1]]</code> par produit récupéré</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>D&#8217;où le nom de "requête N+1" puisque nous effectuons une requête par liaison enfant.</p>
</div>
<div class="paragraph">
<p>Nous pouvons corriger cela simplement en utilisant <code>includes</code>. <code>includes</code> va <strong>pré-charger</strong> les objets enfants dans une seule requête. Son utilisation est très facile. Si nous reprenons l&#8217;exemple précédent, voici le résultat:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Product</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="n">product</span><span class="p">.</span><span class="nf">user</span> <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La console interactive de Rails nous montre les requêtes SQL qui sont générées. Voyez par vous même:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">Product</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"products"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"products"</span>
<span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span> <span class="p">[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">29</span><span class="p">],</span> <span class="p">[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">30</span><span class="p">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rails effectue une deuxième requête qui va récupérer <strong>tous</strong> les utilisateurs d&#8217;un coup.</p>
</div>
<div class="sect2">
<h3 id="_prevention_des_requêtes_n1">Prevention des requêtes N+1</h3>
<div class="paragraph">
<p>Imaginons que nous voulons ajouter les propriétaires des produits pour la route <code>/products</code>. Nous avons déjà vu que avec la librairie <code>fast_jsonapi</code> il est très facile de le faire:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="c1"># ...</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:user</span><span class="p">]</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant effectuons une requête avec cURL. Je vous rappelle que nous devons obtenir un jeton d&#8217;authentification avant d&#8217;accéder à la page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">-X</span> POST <span class="nt">--data</span> <span class="s2">"user[email]=ockymarvin@jacobi.co"</span> <span class="nt">--data</span> <span class="s2">"user[password]=locadex1234"</span>  http://localhost:3000/api/v1/tokens</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
"<a href="mailto:ockymarvin@jacobi.co">ockymarvin@jacobi.co</a>" correspond à un utilisateur créé dans mon application avec le <em>seed</em>. Dans votre cas, il sera sûrement différent du mien puisque nous avons utilisé la librairie Faker.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A l&#8217;aide du token obtenu, nous pouvons maintenant effectuer une requête pour accéder aux produits</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">--header</span> <span class="s2">"Authorization=ey..."</span> http://localhost:3000/api/v1/products</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous voyez très certainement passer plusieurs requêtes dans la console Rails exécutant le serveur web.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="n">Started</span> <span class="k">GET</span> <span class="nv">"/api/v1/products"</span> <span class="k">for</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="k">at</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">13</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">19</span> <span class="o">+</span><span class="mi">0200</span>
<span class="n">Processing</span> <span class="k">by</span> <span class="n">Api</span><span class="p">::</span><span class="n">V1</span><span class="p">::</span><span class="n">ProductsController</span><span class="o">#</span><span class="k">index</span> <span class="k">as</span> <span class="n">JSON</span>
   <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="nv">"products"</span>
  <span class="err">↳</span> <span class="n">app</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">concerns</span><span class="o">/</span><span class="n">paginable</span><span class="p">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="k">in</span> <span class="nv">`get_links_serializer_options'
  Product Load (0.2ms)  SELECT "products".* FROM "products" LIMIT ? OFFSET ?  [["LIMIT", 20], ["OFFSET", 0]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `</span><span class="k">index</span><span class="s1">'
  User Load (0.1ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `index'</span>
   <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"products"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">FROM</span> <span class="nv">"products"</span> <span class="k">WHERE</span> <span class="nv">"products"</span><span class="p">.</span><span class="nv">"user_id"</span> <span class="o">=</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"user_id"</span><span class="p">,</span> <span class="mi">36</span><span class="p">]]</span>
  <span class="err">↳</span> <span class="n">app</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">products_controller</span><span class="p">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="k">in</span> <span class="nv">`index'
  CACHE User Load (0.0ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `</span><span class="k">index</span><span class="s1">'
  CACHE User Load (0.0ms)  SELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?  [["id", 36], ["LIMIT", 1]]
  ↳ app/controllers/api/v1/products_controller.rb:16:in `index'</span>
  <span class="k">CACHE</span> <span class="k">User</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>  <span class="k">SELECT</span> <span class="nv">"users"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"users"</span> <span class="k">WHERE</span> <span class="nv">"users"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="o">?</span> <span class="k">LIMIT</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"id"</span><span class="p">,</span> <span class="mi">36</span><span class="p">],</span> <span class="p">[</span><span class="nv">"LIMIT"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Il est donc malheureusement <strong>très facile</strong> de créer une requête N+1. Heureusement, il existe une gemme qui permet de nous <strong>alerter</strong> lorsque ce genre de situation arrive: <a href="https://github.com/flyerhzm/bullet">Bullet</a>. Bullet va nous prévenir (par mail, <a href="http://growl.info/">notification growl</a>, <a href="https://slack.com">Slack</a>, console, etc..) lorsqu&#8217;il trouve une requête N+1.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;installer, nous ajoutons la <em>gem</em> au <em>GemFile</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add bullet <span class="nt">--group</span> development</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et il suffit de mettre à jour la configuration de notre application pour l&#8217;environnement de développement. Dans notre cas nous allons uniquement activer le mode <code>rails_logger</code> qui va s&#8217;afficher</p>
</div>
<div class="listingblock">
<div class="title">config/environments/development.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="k">do</span>
    <span class="no">Bullet</span><span class="p">.</span><span class="nf">enable</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="no">Bullet</span><span class="p">.</span><span class="nf">rails_logger</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Redémarrez le serveur web et relancez la dernière requête avec cURL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>curl <span class="nt">--header</span> <span class="s2">"Authorization=ey..."</span> http://localhost:3000/api/v1/products</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et regardez la console Rails. Bullet nous indique qu&#8217;il vient de détecter une requête N+1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>GET /api/v1/products
USE eager loading detected
  Product =&gt; [:user]
  Add to your finder: :includes =&gt; [:user]</pre>
</div>
</div>
<div class="paragraph">
<p>Il nous indique même comment la corriger:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Add to your finder: :includes &#8658; [:user]</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Corrigeons donc notre erreur donc le contrôleur:</p>
</div>
<div class="listingblock">
<div class="title">app/controllers/api/v1/products_controller.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="k">class</span> <span class="nc">Api::V1::ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="n">get_links_serializer_options</span><span class="p">(</span><span class="s1">'api_v1_products_path'</span><span class="p">,</span> <span class="vi">@products</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:user</span><span class="p">]</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="no">ProductSerializer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@products</span><span class="p">,</span> <span class="n">options</span><span class="p">).</span><span class="nf">serializable_hash</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà! Il est maintenant temps de faire notre <em>commit</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Add bullet to avoid N+1 query"</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_activation_des_cors">Activation des CORS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans cette dernière section, je vais vous parler d&#8217;un dernier problème que vous allez sûrement rencontrer si vous êtes amenés à travailler avec votre API.</p>
</div>
<div class="paragraph">
<p>Lors de la première requête d&#8217;un site externe (via une requête AJAX par exemple), vous aller rencontrer une erreur de ce genre:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Failed to load <a href="https://example.com/" class="bare">https://example.com/</a>: No ‘Access-Control-Allow-Origin' header is present on the requested resource. Origin ‘https://anfo.pl' is therefore not allowed access. If an opaque response serves your needs, set the request&#8217;s mode to ‘no-cors' to fetch the resource with CORS disabled.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>"Mais qu&#8217;est ce que signifie <em>Access-Control-Allow-Origin</em>??". Le comportement que vous observez est l&#8217;effet de l&#8217;implémentation CORS des navigateurs. Avant la standardisation de CORS, il n&#8217;y avait aucun moyen d&#8217;appeler un terminal API sous un autre domaine pour des raisons de sécurité. Ceci a été (et est encore dans une certaine mesure) bloqué par la politique de la même origine.</p>
</div>
<div class="paragraph">
<p>CORS est un mécanisme qui a pour but de permettre les requêtes faites en votre nom et en même temps de bloquer certaines requêtes faites par des scripts malhonnêtes et est déclenché lorsque vous faites une requête HTTP à:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un domaine différent</p>
</li>
<li>
<p>un sous-domaine différent</p>
</li>
<li>
<p>un port différent</p>
</li>
<li>
<p>un protocole différent</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous devons manuellement activer cette fonctionnalité afin que n&#8217;importe quel client puisse effectuer des requêtes sur notre API.</p>
</div>
<div class="paragraph">
<p>Rails nous permet de faire ça très facilement. Jetez un coup d&#8217;œil au fichier <code>cors.rb</code> situé dans le dossier <code>initializers</code>.</p>
</div>
<div class="listingblock">
<div class="title">config/initializers/cors.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>

<span class="c1"># Rails.application.config.middleware.insert_before 0, Rack::Cors do</span>
<span class="c1">#   allow do</span>
<span class="c1">#     origins 'example.com'</span>
<span class="c1">#</span>
<span class="c1">#     resource '*',</span>
<span class="c1">#       headers: :any,</span>
<span class="c1">#       methods: [:get, :post, :put, :patch, :delete, :options, :head]</span>
<span class="c1">#   end</span>
<span class="c1"># end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Vous voyez. Il suffit de dé-commenter le code et de le modifier un peut pour limiter l&#8217;accès à certaines actions ou bien certains verbes HTTP. Dans notre cas, cette configuration nous convient très bien pour le moment.</p>
</div>
<div class="listingblock">
<div class="title">config/initializers/cors.rb</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ruby"><span class="c1"># ...</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cors</span> <span class="k">do</span>
  <span class="n">allow</span> <span class="k">do</span>
    <span class="n">origins</span> <span class="s1">'example.com'</span>
    <span class="n">resource</span> <span class="s1">'*'</span><span class="p">,</span>
      <span class="ss">headers: :any</span><span class="p">,</span>
      <span class="ss">methods: </span><span class="p">[</span><span class="ss">:get</span><span class="p">,</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:put</span><span class="p">,</span> <span class="ss">:patch</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:options</span><span class="p">,</span> <span class="ss">:head</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous devons aussi installer la gemme <code>rack-cors</code> qui est commentée dans le <code>Gemfile</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>bundle add rack-cors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et voilà! Il est maintenant temps de faire notre dernier commit et de merger nos modifications sur la branche master.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>git commit <span class="nt">-am</span> <span class="s2">"Activate CORS"</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git merge chapter09</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_9">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si vous arrivez à ce point, cela signifie que vous en avez fini avec le livre. Bon travail! Vous venez de devenir un grand développeur API Rails, c&#8217;est sûr.</p>
</div>
<div class="paragraph">
<p>Nous avons donc construit ensemble une API solide et complète. Celle-ci possède toutes les qualité pour détrôner <a href="https://www.amazon.com/">Amazon</a>, soyez en sûr. Merci d&#8217;avoir traversé cette grande aventure avec moi, j&#8217;espère que vous avez apprécié le voyage autant que moi.</p>
</div>
<div class="paragraph">
<p>Je tiens à vous rappeler que tout le code source de ce livre est disponible au format <a href="https://asciidoctor.org">Asciidoctor</a> sur <a href="https://github.com/madeindjs/api_on_rails">GitHub</a>. Ainsi n&#8217;hésitez pas à <a href="https://github.com/madeindjs/api_on_rails/fork">forker</a> le projet si vous voulez l&#8217;améliorer ou corriger une faute qui m&#8217;aurait échappée.</p>
</div>
<div class="paragraph">
<p>Si vous avez aimé ce livre, n&#8217;hésitez pas à me le faire savoir par mail <a href="mailto:contact@rousseau-alexandre.fr">contact@rousseau-alexandre.fr</a>. Je suis ouvert à toutes critiques, bonne ou mauvaise, autour d&#8217;un bonne bière :) .</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. La clé GPG vous permet de vérifier l&#8217;identité de l&#8217;auteur des sources que vous téléchargez.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 6.9<br>
Last updated 2021-01-17 13:56:45 +0100
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>